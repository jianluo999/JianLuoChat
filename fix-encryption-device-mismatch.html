<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤MatrixåŠ å¯†è®¾å¤‡IDä¸åŒ¹é…é—®é¢˜</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .error-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .fix-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .diagnostic-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ MatrixåŠ å¯†è®¾å¤‡IDä¸åŒ¹é…ä¿®å¤å·¥å…·</h1>
            <p>è§£å†³ "the account in the store doesn't match the account in the constructor" é”™è¯¯</p>
        </div>

        <div class="error-info">
            <h3>ğŸš¨ é—®é¢˜æè¿°</h3>
            <p>æ‚¨é‡åˆ°çš„é”™è¯¯è¡¨æ˜MatrixåŠ å¯†å­˜å‚¨ä¸­çš„è®¾å¤‡IDä¸å½“å‰ä½¿ç”¨çš„è®¾å¤‡IDä¸åŒ¹é…ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ï¼š</p>
            <ul>
                <li>å¤šæ¬¡ç™»å½•å¯¼è‡´è®¾å¤‡IDå†²çª</li>
                <li>æµè§ˆå™¨ç¼“å­˜é—®é¢˜</li>
                <li>åŠ å¯†æ•°æ®åº“æŸå</li>
                <li>è®¾å¤‡IDç”Ÿæˆé€»è¾‘å˜æ›´</li>
            </ul>
        </div>

        <div class="fix-section">
            <h3>ğŸ” æ­¥éª¤1: è¯Šæ–­é—®é¢˜</h3>
            <p>é¦–å…ˆæ£€æŸ¥å½“å‰çš„è®¾å¤‡IDå’ŒåŠ å¯†å­˜å‚¨çŠ¶æ€</p>
            <button class="button" onclick="diagnoseIssues()">å¼€å§‹è¯Šæ–­</button>
            <div id="diagnostic-result"></div>
        </div>

        <div class="fix-section">
            <h3>ğŸ§¹ æ­¥éª¤2: æ¸…ç†å†²çªæ•°æ®</h3>
            <p>æ¸…ç†æ‰€æœ‰å†²çªçš„è®¾å¤‡IDå’ŒåŠ å¯†æ•°æ®</p>
            <button class="button danger" onclick="clearConflictData()">æ¸…ç†å†²çªæ•°æ®</button>
            <div id="clear-result"></div>
        </div>

        <div class="fix-section">
            <h3>âœ… æ­¥éª¤3: éªŒè¯ä¿®å¤</h3>
            <p>éªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ</p>
            <button class="button success" onclick="verifyFix()">éªŒè¯ä¿®å¤</button>
            <button class="button" onclick="refreshPage()">åˆ·æ–°é¡µé¢</button>
            <div id="verify-result"></div>
        </div>

        <div class="fix-section">
            <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(message);
        }

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function diagnoseIssues() {
            log('ğŸ” å¼€å§‹è¯Šæ–­è®¾å¤‡IDå’ŒåŠ å¯†é—®é¢˜...');
            showStatus('diagnostic-result', 'æ­£åœ¨è¯Šæ–­...', 'warning');
            
            try {
                // æ£€æŸ¥localStorageä¸­çš„è®¾å¤‡ID
                const deviceIds = {};
                const cryptoKeys = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        if (key.startsWith('jianluochat-device-id-')) {
                            deviceIds[key] = localStorage.getItem(key);
                        } else if (key.includes('crypto') || key.includes('matrix') || key.includes('device')) {
                            cryptoKeys.push(key);
                        }
                    }
                }
                
                log(`ğŸ“± å‘ç°è®¾å¤‡ID: ${Object.keys(deviceIds).length} ä¸ª`);
                Object.entries(deviceIds).forEach(([key, value]) => {
                    log(`  ${key}: ${value}`);
                });
                
                log(`ğŸ” å‘ç°åŠ å¯†ç›¸å…³é”®: ${cryptoKeys.length} ä¸ª`);
                cryptoKeys.forEach(key => {
                    log(`  ${key}`);
                });
                
                // æ£€æŸ¥IndexedDB
                let databases = [];
                if (window.indexedDB) {
                    try {
                        databases = await indexedDB.databases();
                        const cryptoDbs = databases.filter(db => 
                            db.name && (
                                db.name.includes('matrix') ||
                                db.name.includes('crypto') ||
                                db.name.includes('jianluochat')
                            )
                        );
                        
                        log(`ğŸ—„ï¸ å‘ç°åŠ å¯†æ•°æ®åº“: ${cryptoDbs.length} ä¸ª`);
                        cryptoDbs.forEach(db => {
                            log(`  ${db.name}`);
                        });
                    } catch (error) {
                        log(`âš ï¸ æ£€æŸ¥IndexedDBå¤±è´¥: ${error.message}`);
                    }
                }
                
                // ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
                let diagnosticHtml = '<h4>è¯Šæ–­ç»“æœ:</h4>';
                
                if (Object.keys(deviceIds).length === 0) {
                    diagnosticHtml += '<div class="diagnostic-item">âŒ æ²¡æœ‰æ‰¾åˆ°è®¾å¤‡ID</div>';
                } else if (Object.keys(deviceIds).length > 1) {
                    diagnosticHtml += '<div class="diagnostic-item">âš ï¸ å‘ç°å¤šä¸ªè®¾å¤‡IDï¼Œå¯èƒ½å­˜åœ¨å†²çª</div>';
                } else {
                    diagnosticHtml += '<div class="diagnostic-item">âœ… è®¾å¤‡IDæ•°é‡æ­£å¸¸</div>';
                }
                
                if (cryptoKeys.length > 0) {
                    diagnosticHtml += '<div class="diagnostic-item">âš ï¸ å‘ç°åŠ å¯†ç›¸å…³æ•°æ®ï¼Œå¯èƒ½éœ€è¦æ¸…ç†</div>';
                }
                
                if (databases.length > 0) {
                    diagnosticHtml += '<div class="diagnostic-item">âš ï¸ å‘ç°åŠ å¯†æ•°æ®åº“ï¼Œå¯èƒ½éœ€è¦æ¸…ç†</div>';
                }
                
                showStatus('diagnostic-result', diagnosticHtml, 'warning');
                log('âœ… è¯Šæ–­å®Œæˆ');
                
            } catch (error) {
                log(`âŒ è¯Šæ–­å¤±è´¥: ${error.message}`);
                showStatus('diagnostic-result', `è¯Šæ–­å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function clearConflictData() {
            log('ğŸ§¹ å¼€å§‹æ¸…ç†å†²çªæ•°æ®...');
            showStatus('clear-result', 'æ­£åœ¨æ¸…ç†...', 'warning');
            
            try {
                let clearedCount = 0;
                
                // æ¸…ç†localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.includes('device-id') ||
                        key.includes('crypto') ||
                        key.includes('matrix-sdk-crypto') ||
                        key.includes('jianluochat-crypto') ||
                        key.includes('matrix-login-info') ||
                        key.includes('matrix_login_info') ||
                        key.includes('matrix_access_token') ||
                        key.includes('olm')
                    )) {
                        keysToRemove.push(key);
                    }
                }
                
                log(`ğŸ—‘ï¸ æ¸…ç†localStorageé”®: ${keysToRemove.length} ä¸ª`);
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    log(`  å·²æ¸…ç†: ${key}`);
                    clearedCount++;
                });
                
                // æ¸…ç†IndexedDB
                if (window.indexedDB) {
                    try {
                        const databases = await indexedDB.databases();
                        const cryptoDbs = databases.filter(db => 
                            db.name && (
                                db.name.includes('matrix') ||
                                db.name.includes('crypto') ||
                                db.name.includes('jianluochat') ||
                                db.name.includes('olm')
                            )
                        );
                        
                        log(`ğŸ—‘ï¸ æ¸…ç†IndexedDBæ•°æ®åº“: ${cryptoDbs.length} ä¸ª`);
                        
                        for (const db of cryptoDbs) {
                            if (db.name) {
                                try {
                                    await new Promise((resolve, reject) => {
                                        const deleteReq = indexedDB.deleteDatabase(db.name);
                                        deleteReq.onsuccess = () => {
                                            log(`  å·²åˆ é™¤æ•°æ®åº“: ${db.name}`);
                                            clearedCount++;
                                            resolve(true);
                                        };
                                        deleteReq.onerror = () => {
                                            log(`  åˆ é™¤æ•°æ®åº“å¤±è´¥: ${db.name}`);
                                            reject(deleteReq.error);
                                        };
                                        deleteReq.onblocked = () => {
                                            log(`  æ•°æ®åº“åˆ é™¤è¢«é˜»å¡: ${db.name}`);
                                            setTimeout(() => resolve(true), 2000);
                                        };
                                    });
                                } catch (error) {
                                    log(`âš ï¸ åˆ é™¤æ•°æ®åº“ ${db.name} æ—¶å‡ºé”™: ${error.message}`);
                                }
                            }
                        }
                    } catch (error) {
                        log(`âš ï¸ æ¸…ç†IndexedDBå¤±è´¥: ${error.message}`);
                    }
                }
                
                // è®¾ç½®æ¸…ç†æ ‡è®°
                localStorage.setItem('matrix-encryption-conflict-cleared', Date.now().toString());
                
                log(`âœ… æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç† ${clearedCount} é¡¹æ•°æ®`);
                showStatus('clear-result', `æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç† ${clearedCount} é¡¹æ•°æ®`, 'success');
                
            } catch (error) {
                log(`âŒ æ¸…ç†å¤±è´¥: ${error.message}`);
                showStatus('clear-result', `æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function verifyFix() {
            log('ğŸ” å¼€å§‹éªŒè¯ä¿®å¤æ•ˆæœ...');
            showStatus('verify-result', 'æ­£åœ¨éªŒè¯...', 'warning');
            
            try {
                let issues = [];
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å†²çªæ•°æ®
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (
                        key.includes('crypto') ||
                        key.includes('matrix-sdk-crypto') ||
                        key.includes('olm')
                    )) {
                        issues.push(`ä»æœ‰åŠ å¯†æ•°æ®: ${key}`);
                    }
                }
                
                // æ£€æŸ¥è®¾å¤‡ID
                const deviceIdKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('jianluochat-device-id-')) {
                        deviceIdKeys.push(key);
                    }
                }
                
                if (deviceIdKeys.length > 1) {
                    issues.push(`ä»æœ‰å¤šä¸ªè®¾å¤‡ID: ${deviceIdKeys.join(', ')}`);
                }
                
                // æ£€æŸ¥IndexedDB
                if (window.indexedDB) {
                    try {
                        const databases = await indexedDB.databases();
                        const cryptoDbs = databases.filter(db => 
                            db.name && (
                                db.name.includes('matrix-sdk-crypto') ||
                                db.name.includes('jianluochat-crypto')
                            )
                        );
                        
                        if (cryptoDbs.length > 0) {
                            issues.push(`ä»æœ‰åŠ å¯†æ•°æ®åº“: ${cryptoDbs.map(db => db.name).join(', ')}`);
                        }
                    } catch (error) {
                        log(`âš ï¸ æ£€æŸ¥IndexedDBæ—¶å‡ºé”™: ${error.message}`);
                    }
                }
                
                // æ£€æŸ¥æ¸…ç†æ ‡è®°
                const clearMark = localStorage.getItem('matrix-encryption-conflict-cleared');
                
                if (issues.length === 0 && clearMark) {
                    log('âœ… éªŒè¯é€šè¿‡ï¼ä¿®å¤æˆåŠŸå®Œæˆ');
                    showStatus('verify-result', 
                        'âœ… éªŒè¯é€šè¿‡ï¼ä¿®å¤æˆåŠŸå®Œæˆ<br>' +
                        'ğŸ’¡ å»ºè®®æ“ä½œï¼š<br>' +
                        '1. åˆ·æ–°é¡µé¢<br>' +
                        '2. é‡æ–°ç™»å½•Matrixè´¦æˆ·<br>' +
                        '3. åŠ å¯†åŠŸèƒ½å°†ä½¿ç”¨æ–°çš„è®¾å¤‡IDé‡æ–°åˆå§‹åŒ–', 
                        'success'
                    );
                } else {
                    log('âš ï¸ éªŒè¯å‘ç°é—®é¢˜:');
                    issues.forEach(issue => log(`  ${issue}`));
                    
                    showStatus('verify-result', 
                        `âš ï¸ éªŒè¯å‘ç°é—®é¢˜ï¼š<br>${issues.join('<br>')}<br>` +
                        'å»ºè®®åˆ·æ–°é¡µé¢åé‡è¯•ä¿®å¤æµç¨‹', 
                        'warning'
                    );
                }
                
            } catch (error) {
                log(`âŒ éªŒè¯å¤±è´¥: ${error.message}`);
                showStatus('verify-result', `éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function refreshPage() {
            log('ğŸ”„ åˆ·æ–°é¡µé¢...');
            window.location.reload();
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹ä¿¡æ¯
        window.onload = function() {
            log('ğŸš€ MatrixåŠ å¯†è®¾å¤‡IDä¸åŒ¹é…ä¿®å¤å·¥å…·å·²å¯åŠ¨');
            log('ğŸ’¡ è¯·æŒ‰ç…§æ­¥éª¤ä¾æ¬¡æ‰§è¡Œï¼šè¯Šæ–­ -> æ¸…ç† -> éªŒè¯ -> åˆ·æ–°');
        };
    </script>
</body>
</html>