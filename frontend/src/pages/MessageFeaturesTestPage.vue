<template>
  <div class="message-features-test">
    <div class="test-header">
      <h1>ğŸ’¬ Matrixæ¶ˆæ¯åŠŸèƒ½æµ‹è¯•</h1>
      <button @click="goBack" class="back-btn">â† è¿”å›</button>
    </div>

    <div class="test-content">
      <!-- åŠŸèƒ½çŠ¶æ€é¢æ¿ -->
      <div class="status-panel">
        <h3>åŠŸèƒ½å®ç°çŠ¶æ€</h3>
        <div class="feature-list">
          <div class="feature-item" :class="{ 'implemented': true }">
            <span class="feature-icon">âœ…</span>
            <span class="feature-name">æ¶ˆæ¯å›å¤</span>
            <span class="feature-desc">æ”¯æŒå›å¤å¼•ç”¨æ¶ˆæ¯</span>
          </div>
          
          <div class="feature-item" :class="{ 'implemented': true }">
            <span class="feature-icon">âœ…</span>
            <span class="feature-name">æ¶ˆæ¯ç¼–è¾‘</span>
            <span class="feature-desc">ç¼–è¾‘å·²å‘é€çš„æ¶ˆæ¯</span>
          </div>
          
          <div class="feature-item" :class="{ 'implemented': true }">
            <span class="feature-icon">âœ…</span>
            <span class="feature-name">æ¶ˆæ¯åˆ é™¤</span>
            <span class="feature-desc">åˆ é™¤/æ’¤å›æ¶ˆæ¯</span>
          </div>
          
          <div class="feature-item" :class="{ 'implemented': true }">
            <span class="feature-icon">âœ…</span>
            <span class="feature-name">æ¶ˆæ¯ååº”</span>
            <span class="feature-desc">æ·»åŠ emojiååº”</span>
          </div>
          
          <div class="feature-item" :class="{ 'implemented': true }">
            <span class="feature-icon">âœ…</span>
            <span class="feature-name">æ¶ˆæ¯æœç´¢</span>
            <span class="feature-desc">æœç´¢å†å²æ¶ˆæ¯</span>
          </div>
          
          <div class="feature-item" :class="{ 'implemented': true }">
            <span class="feature-icon">âœ…</span>
            <span class="feature-name">æ¶ˆæ¯åˆ†é¡µ</span>
            <span class="feature-desc">å†å²æ¶ˆæ¯åˆ†é¡µåŠ è½½</span>
          </div>
          
          <div class="feature-item" :class="{ 'implemented': true }">
            <span class="feature-icon">âœ…</span>
            <span class="feature-name">è¾“å…¥çŠ¶æ€</span>
            <span class="feature-desc">æ˜¾ç¤ºæ­£åœ¨è¾“å…¥çŠ¶æ€</span>
          </div>
        </div>
      </div>

      <!-- Matrixåè®®å…¼å®¹æ€§ -->
      <div class="compatibility-panel">
        <h3>Matrixåè®®å…¼å®¹æ€§</h3>
        <div class="protocol-list">
          <div class="protocol-item">
            <span class="protocol-name">m.room.message</span>
            <span class="protocol-status supported">âœ… æ”¯æŒ</span>
            <span class="protocol-desc">åŸºç¡€æ¶ˆæ¯å‘é€</span>
          </div>
          
          <div class="protocol-item">
            <span class="protocol-name">m.replace</span>
            <span class="protocol-status supported">âœ… æ”¯æŒ</span>
            <span class="protocol-desc">æ¶ˆæ¯ç¼–è¾‘äº‹ä»¶</span>
          </div>
          
          <div class="protocol-item">
            <span class="protocol-name">m.room.redaction</span>
            <span class="protocol-status supported">âœ… æ”¯æŒ</span>
            <span class="protocol-desc">æ¶ˆæ¯åˆ é™¤äº‹ä»¶</span>
          </div>
          
          <div class="protocol-item">
            <span class="protocol-name">m.reaction</span>
            <span class="protocol-status supported">âœ… æ”¯æŒ</span>
            <span class="protocol-desc">æ¶ˆæ¯ååº”äº‹ä»¶</span>
          </div>
          
          <div class="protocol-item">
            <span class="protocol-name">m.in_reply_to</span>
            <span class="protocol-status supported">âœ… æ”¯æŒ</span>
            <span class="protocol-desc">æ¶ˆæ¯å›å¤å…³ç³»</span>
          </div>
          
          <div class="protocol-item">
            <span class="protocol-name">m.typing</span>
            <span class="protocol-status supported">âœ… æ”¯æŒ</span>
            <span class="protocol-desc">è¾“å…¥çŠ¶æ€é€šçŸ¥</span>
          </div>
        </div>
      </div>

      <!-- æµ‹è¯•æ“ä½œé¢æ¿ -->
      <div class="test-panel">
        <h3>åŠŸèƒ½æµ‹è¯•</h3>
        
        <div class="test-section">
          <h4>æ¶ˆæ¯æ“ä½œæµ‹è¯•</h4>
          <div class="test-buttons">
            <button @click="testSendMessage" class="test-btn">
              ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯
            </button>
            <button @click="testEditMessage" class="test-btn" :disabled="!lastMessageId">
              âœï¸ ç¼–è¾‘æœ€åæ¶ˆæ¯
            </button>
            <button @click="testDeleteMessage" class="test-btn" :disabled="!lastMessageId">
              ğŸ—‘ï¸ åˆ é™¤æœ€åæ¶ˆæ¯
            </button>
            <button @click="testAddReaction" class="test-btn" :disabled="!lastMessageId">
              ğŸ˜Š æ·»åŠ ååº”
            </button>
          </div>
        </div>

        <div class="test-section">
          <h4>æœç´¢åŠŸèƒ½æµ‹è¯•</h4>
          <div class="search-test">
            <input 
              v-model="searchQuery" 
              placeholder="è¾“å…¥æœç´¢å…³é”®è¯..."
              class="search-input"
            />
            <button @click="testSearch" class="test-btn">
              ğŸ” æœç´¢æ¶ˆæ¯
            </button>
          </div>
          <div v-if="searchResults.length > 0" class="search-results">
            <h5>æœç´¢ç»“æœ ({{ searchResults.length }} æ¡):</h5>
            <div 
              v-for="result in searchResults" 
              :key="result.result.event_id"
              class="search-result-item"
            >
              <div class="result-content">{{ result.result.content.body }}</div>
              <div class="result-meta">
                {{ formatTime(result.result.origin_server_ts) }}
              </div>
            </div>
          </div>
        </div>

        <div class="test-section">
          <h4>æ€§èƒ½æµ‹è¯•</h4>
          <div class="performance-test">
            <button @click="testMessageLoad" class="test-btn">
              ğŸ“Š æµ‹è¯•æ¶ˆæ¯åŠ è½½æ€§èƒ½
            </button>
            <button @click="testSearchPerformance" class="test-btn">
              âš¡ æµ‹è¯•æœç´¢æ€§èƒ½
            </button>
          </div>
          <div v-if="performanceResults" class="performance-results">
            <h5>æ€§èƒ½æµ‹è¯•ç»“æœ:</h5>
            <pre>{{ performanceResults }}</pre>
          </div>
        </div>
      </div>

      <!-- å®æ—¶æ¶ˆæ¯åŒºåŸŸ -->
      <div class="message-demo">
        <h3>å®æ—¶æ¶ˆæ¯æ¼”ç¤º</h3>
        <div class="demo-room">
          <MatrixMessageAreaEnhanced
            v-if="demoRoomId"
            :room-id="demoRoomId"
          />
          <div v-else class="no-room">
            <p>è¯·å…ˆç™»å½•Matrixè´¦æˆ·å¹¶åŠ å…¥æˆ¿é—´</p>
            <button @click="initDemoRoom" class="init-btn">
              ğŸ  åˆå§‹åŒ–æ¼”ç¤ºæˆ¿é—´
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useMatrixStore } from '@/stores/matrix'
import MatrixMessageAreaEnhanced from '@/components/MatrixMessageAreaEnhanced.vue'

const router = useRouter()
const matrixStore = useMatrixStore()

// çŠ¶æ€
const lastMessageId = ref<string>('')
const searchQuery = ref('')
const searchResults = ref<any[]>([])
const performanceResults = ref<string>('')
const demoRoomId = ref<string>('')

// æ–¹æ³•
const goBack = () => {
  router.back()
}

const testSendMessage = async () => {
  if (!demoRoomId.value) {
    alert('è¯·å…ˆåˆå§‹åŒ–æ¼”ç¤ºæˆ¿é—´')
    return
  }

  try {
    const testMessage = `æµ‹è¯•æ¶ˆæ¯ - ${new Date().toLocaleTimeString()}`
    await matrixStore.sendMessage(demoRoomId.value, testMessage)
    
    // è·å–æœ€åå‘é€çš„æ¶ˆæ¯ID
    const messages = matrixStore.messages.get(demoRoomId.value) || []
    if (messages.length > 0) {
      lastMessageId.value = messages[messages.length - 1].eventId || ''
    }
    
    console.log('âœ… æµ‹è¯•æ¶ˆæ¯å‘é€æˆåŠŸ')
  } catch (error) {
    console.error('âŒ æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥:', error)
    alert('å‘é€æ¶ˆæ¯å¤±è´¥: ' + error)
  }
}

const testEditMessage = async () => {
  if (!lastMessageId.value || !demoRoomId.value) return

  try {
    const editedContent = `ç¼–è¾‘åçš„æ¶ˆæ¯ - ${new Date().toLocaleTimeString()}`
    await matrixStore.editMessage(demoRoomId.value, lastMessageId.value, editedContent)
    console.log('âœ… æ¶ˆæ¯ç¼–è¾‘æµ‹è¯•æˆåŠŸ')
  } catch (error) {
    console.error('âŒ æ¶ˆæ¯ç¼–è¾‘æµ‹è¯•å¤±è´¥:', error)
    alert('ç¼–è¾‘æ¶ˆæ¯å¤±è´¥: ' + error)
  }
}

const testDeleteMessage = async () => {
  if (!lastMessageId.value || !demoRoomId.value) return

  try {
    await matrixStore.deleteMessage(demoRoomId.value, lastMessageId.value, 'æµ‹è¯•åˆ é™¤')
    console.log('âœ… æ¶ˆæ¯åˆ é™¤æµ‹è¯•æˆåŠŸ')
    lastMessageId.value = ''
  } catch (error) {
    console.error('âŒ æ¶ˆæ¯åˆ é™¤æµ‹è¯•å¤±è´¥:', error)
    alert('åˆ é™¤æ¶ˆæ¯å¤±è´¥: ' + error)
  }
}

const testAddReaction = async () => {
  if (!lastMessageId.value || !demoRoomId.value) return

  try {
    const emojis = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ‰', 'ğŸ”¥']
    const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)]
    await matrixStore.addReaction(demoRoomId.value, lastMessageId.value, randomEmoji)
    console.log('âœ… ååº”æ·»åŠ æµ‹è¯•æˆåŠŸ')
  } catch (error) {
    console.error('âŒ ååº”æ·»åŠ æµ‹è¯•å¤±è´¥:', error)
    alert('æ·»åŠ ååº”å¤±è´¥: ' + error)
  }
}

const testSearch = async () => {
  if (!searchQuery.value.trim() || !demoRoomId.value) return

  try {
    const startTime = performance.now()
    const results = await matrixStore.searchMessages(demoRoomId.value, searchQuery.value)
    const endTime = performance.now()
    
    searchResults.value = results
    console.log(`âœ… æœç´¢æµ‹è¯•å®Œæˆï¼Œè€—æ—¶ ${(endTime - startTime).toFixed(2)}ms`)
  } catch (error) {
    console.error('âŒ æœç´¢æµ‹è¯•å¤±è´¥:', error)
    alert('æœç´¢å¤±è´¥: ' + error)
  }
}

const testMessageLoad = async () => {
  if (!demoRoomId.value) return

  try {
    const startTime = performance.now()
    await matrixStore.loadMoreHistoryMessages(demoRoomId.value)
    const endTime = performance.now()
    
    const messages = matrixStore.messages.get(demoRoomId.value) || []
    performanceResults.value = `æ¶ˆæ¯åŠ è½½æ€§èƒ½æµ‹è¯•:
- åŠ è½½æ—¶é—´: ${(endTime - startTime).toFixed(2)}ms
- æ¶ˆæ¯æ•°é‡: ${messages.length}
- å¹³å‡åŠ è½½é€Ÿåº¦: ${(messages.length / (endTime - startTime) * 1000).toFixed(2)} æ¡/ç§’`
    
    console.log('âœ… æ¶ˆæ¯åŠ è½½æ€§èƒ½æµ‹è¯•å®Œæˆ')
  } catch (error) {
    console.error('âŒ æ¶ˆæ¯åŠ è½½æ€§èƒ½æµ‹è¯•å¤±è´¥:', error)
  }
}

const testSearchPerformance = async () => {
  if (!demoRoomId.value) return

  try {
    const testQueries = ['æµ‹è¯•', 'hello', 'matrix', 'æ¶ˆæ¯', 'test']
    const results = []
    
    for (const query of testQueries) {
      const startTime = performance.now()
      const searchResults = await matrixStore.searchMessages(demoRoomId.value, query)
      const endTime = performance.now()
      
      results.push({
        query,
        time: endTime - startTime,
        count: searchResults.length
      })
    }
    
    const avgTime = results.reduce((sum, r) => sum + r.time, 0) / results.length
    const totalResults = results.reduce((sum, r) => sum + r.count, 0)
    
    performanceResults.value = `æœç´¢æ€§èƒ½æµ‹è¯•:
- æµ‹è¯•æŸ¥è¯¢æ•°: ${testQueries.length}
- å¹³å‡æœç´¢æ—¶é—´: ${avgTime.toFixed(2)}ms
- æ€»ç»“æœæ•°: ${totalResults}
- æœç´¢æ•ˆç‡: ${(totalResults / avgTime * 1000).toFixed(2)} ç»“æœ/ç§’

è¯¦ç»†ç»“æœ:
${results.map(r => `  "${r.query}": ${r.time.toFixed(2)}ms (${r.count}æ¡)`).join('\n')}`
    
    console.log('âœ… æœç´¢æ€§èƒ½æµ‹è¯•å®Œæˆ')
  } catch (error) {
    console.error('âŒ æœç´¢æ€§èƒ½æµ‹è¯•å¤±è´¥:', error)
  }
}

const initDemoRoom = async () => {
  try {
    // ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„æˆ¿é—´ä½œä¸ºæ¼”ç¤ºæˆ¿é—´
    const rooms = matrixStore.rooms
    if (rooms.length > 0) {
      demoRoomId.value = rooms[0].id
      console.log('âœ… æ¼”ç¤ºæˆ¿é—´åˆå§‹åŒ–æˆåŠŸ:', demoRoomId.value)
    } else {
      alert('æ²¡æœ‰å¯ç”¨çš„æˆ¿é—´ï¼Œè¯·å…ˆåŠ å…¥ä¸€ä¸ªæˆ¿é—´')
    }
  } catch (error) {
    console.error('âŒ æ¼”ç¤ºæˆ¿é—´åˆå§‹åŒ–å¤±è´¥:', error)
    alert('åˆå§‹åŒ–å¤±è´¥: ' + error)
  }
}

const formatTime = (timestamp: number) => {
  return new Date(timestamp).toLocaleString('zh-CN')
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  // è‡ªåŠ¨åˆå§‹åŒ–æ¼”ç¤ºæˆ¿é—´
  if (matrixStore.rooms.length > 0) {
    demoRoomId.value = matrixStore.rooms[0].id
  }
})
</script>

<style scoped>
.message-features-test {
  min-height: 100vh;
  background: #f8f9fa;
}

.test-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: white;
  border-bottom: 1px solid #e1e8ed;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.test-header h1 {
  margin: 0;
  color: #2c3e50;
}

.back-btn {
  padding: 8px 16px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.back-btn:hover {
  background: #2980b9;
}

.test-content {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.status-panel, .compatibility-panel, .test-panel, .message-demo {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-demo {
  grid-column: 1 / -1;
  height: 600px;
}

.status-panel h3, .compatibility-panel h3, .test-panel h3, .message-demo h3 {
  margin: 0 0 16px 0;
  color: #2c3e50;
  border-bottom: 2px solid #3498db;
  padding-bottom: 8px;
}

.feature-list, .protocol-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.feature-item, .protocol-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.feature-item.implemented {
  background: #e8f5e8;
  border-left: 4px solid #27ae60;
}

.feature-icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}

.feature-name, .protocol-name {
  font-weight: 600;
  color: #2c3e50;
  min-width: 100px;
}

.feature-desc, .protocol-desc {
  color: #7f8c8d;
  font-size: 14px;
}

.protocol-status.supported {
  color: #27ae60;
  font-weight: 600;
  min-width: 60px;
}

.test-section {
  margin-bottom: 24px;
}

.test-section h4 {
  margin: 0 0 12px 0;
  color: #34495e;
  font-size: 16px;
}

.test-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.test-btn {
  padding: 8px 16px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.test-btn:hover:not(:disabled) {
  background: #2980b9;
  transform: translateY(-1px);
}

.test-btn:disabled {
  background: #bdc3c7;
  cursor: not-allowed;
  transform: none;
}

.search-test {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.search-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.search-results {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
}

.search-results h5 {
  margin: 0 0 12px 0;
  color: #2c3e50;
}

.search-result-item {
  background: white;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 8px;
  border-left: 3px solid #3498db;
}

.result-content {
  font-weight: 500;
  margin-bottom: 4px;
}

.result-meta {
  font-size: 12px;
  color: #7f8c8d;
}

.performance-test {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.performance-results {
  background: #2c3e50;
  color: #ecf0f1;
  padding: 16px;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
}

.performance-results pre {
  margin: 0;
  white-space: pre-wrap;
  font-size: 12px;
  line-height: 1.4;
}

.demo-room {
  height: 500px;
  border: 1px solid #e1e8ed;
  border-radius: 8px;
  overflow: hidden;
}

.no-room {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #7f8c8d;
}

.init-btn {
  margin-top: 16px;
  padding: 12px 24px;
  background: #27ae60;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.2s ease;
}

.init-btn:hover {
  background: #219a52;
}

@media (max-width: 768px) {
  .test-content {
    grid-template-columns: 1fr;
    padding: 16px;
  }
  
  .test-buttons {
    flex-direction: column;
  }
  
  .search-test {
    flex-direction: column;
  }
}
</style>