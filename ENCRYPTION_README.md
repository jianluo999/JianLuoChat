# 🔐 JianLuoChat 端到端加密功能

## 概述

JianLuoChat 现已支持端到端加密功能，基于 Matrix 协议的 Rust 加密引擎实现，为您的聊天提供军用级别的安全保护。

## ✨ 主要特性

### 🛡️ 端到端加密
- **Rust 加密引擎**: 使用 Matrix 官方的 Rust 加密 SDK，性能优异，安全可靠
- **Megolm 算法**: 采用 Megolm 群组加密算法，支持大型群聊的高效加密
- **前向安全**: 定期轮换密钥，即使密钥泄露也无法解密历史消息
- **完美前向保密**: 每条消息使用独立的加密密钥

### 🔑 设备验证
- **QR码验证**: 扫描二维码快速验证设备身份
- **SAS验证**: 短认证字符串验证，通过表情符号确认设备
- **自动验证**: 支持自动接受已知设备的验证请求
- **设备管理**: 查看和管理所有已登录的设备

### 💾 密钥管理
- **密钥备份**: 自动备份加密密钥到服务器
- **密钥恢复**: 通过恢复短语或恢复密钥恢复访问权限
- **跨设备同步**: 在多个设备间安全同步加密密钥
- **密钥导出/导入**: 手动导出和导入房间密钥

### 🏠 房间加密
- **自动加密**: 新房间可选择默认启用加密
- **加密状态显示**: 清晰显示房间和消息的加密状态
- **成员设备检查**: 自动检查房间成员的设备验证状态
- **历史消息保护**: 控制新成员对历史消息的访问权限

## 🚀 快速开始

### 1. 启用加密

1. 登录 JianLuoChat
2. 点击聊天界面右上角的 🔐 按钮
3. 在加密设置页面点击"启用加密"
4. 等待加密引擎初始化完成

### 2. 设备验证

1. 在另一台设备上登录同一账户
2. 在加密设置页面的"设备验证"部分
3. 选择要验证的设备，点击"验证设备"
4. 选择验证方式（QR码或表情符号）
5. 按照提示完成验证过程

### 3. 密钥备份

1. 在加密设置页面找到"密钥管理"部分
2. 点击"设置备份"按钮
3. 保存生成的恢复密钥（非常重要！）
4. 启用自动备份功能

### 4. 创建加密房间

1. 创建新房间时选择"启用加密"
2. 或在房间设置中启用加密
3. 邀请成员并验证他们的设备
4. 开始安全聊天！

## 🔧 技术实现

### 架构概览

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 Vue.js   │    │  Matrix JS SDK  │    │ Rust Crypto SDK │
│                 │◄──►│                 │◄──►│                 │
│ - UI 组件       │    │ - 客户端 API    │    │ - 加密引擎      │
│ - 状态管理      │    │ - 事件处理      │    │ - 密钥管理      │
│ - 用户交互      │    │ - 网络通信      │    │ - 设备验证      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 核心组件

#### 1. 加密初始化 (`matrix.ts`)
```typescript
// 初始化 Rust 加密引擎
await client.initRustCrypto({
  useIndexedDB: true,
  cryptoDatabasePrefix: 'jianluochat-crypto'
})
```

#### 2. 设备验证 (`DeviceVerification.vue`)
- 支持 QR 码和 SAS 验证
- 自动处理验证流程
- 实时显示验证状态

#### 3. 密钥管理 (`KeyManagement.vue`)
- 密钥备份和恢复
- 跨设备同步
- 安全设置管理

#### 4. 加密状态指示器 (`EncryptionIndicator.vue`)
- 房间加密状态
- 消息加密状态
- 设备验证状态
- 全局加密状态

### 安全特性

#### 🔒 加密算法
- **Olm**: 用于设备间的端到端加密通信
- **Megolm**: 用于群组消息的高效加密
- **Ed25519**: 用于数字签名和身份验证
- **Curve25519**: 用于密钥交换

#### 🛡️ 安全措施
- **密钥轮换**: 定期更换房间加密密钥
- **设备验证**: 确保只有可信设备能解密消息
- **前向安全**: 历史消息无法被未来泄露的密钥解密
- **本地存储加密**: 本地密钥数据库使用密码保护

## 🧪 测试功能

### 加密测试套件

访问 `/encryption-test` 页面运行完整的加密功能测试：

1. **基础功能测试**
   - 加密引擎初始化
   - API 可用性检查
   - 设备密钥验证

2. **消息加密测试**
   - 消息加密/解密
   - 跨设备消息同步

3. **设备验证测试**
   - 设备列表获取
   - 验证请求处理

4. **密钥管理测试**
   - 密钥导出/导入
   - 备份状态检查

5. **互操作性测试**
   - 与 Element 客户端兼容性
   - 跨平台消息交换

### 性能测试

- 加密初始化时间
- 消息加密/解密延迟
- 密钥操作性能
- 内存使用情况

## 🔍 故障排除

### 常见问题

#### Q: 加密初始化失败
**A**: 检查浏览器是否支持 WebAssembly 和 IndexedDB

#### Q: 设备验证失败
**A**: 确保两台设备都已启用加密并连接到网络

#### Q: 无法解密消息
**A**: 检查设备是否已验证，或尝试重新同步密钥

#### Q: 密钥备份失败
**A**: 检查网络连接和服务器状态

### 调试工具

1. **浏览器开发者工具**: 查看控制台日志
2. **加密测试页面**: 运行诊断测试
3. **Matrix 客户端调试**: 使用内置调试功能

## 🔐 安全建议

### 最佳实践

1. **定期验证设备**: 验证所有登录的设备
2. **启用密钥备份**: 防止设备丢失时无法访问消息
3. **保护恢复密钥**: 将恢复密钥存储在安全的地方
4. **定期更新**: 保持客户端和依赖库的最新版本
5. **谨慎分享**: 不要在不安全的渠道分享敏感信息

### 安全设置

- **严格验证模式**: 只允许与已验证设备通信
- **自动密钥轮换**: 定期更换房间加密密钥
- **历史消息保护**: 限制新成员对历史消息的访问
- **调试模式**: 仅在故障排除时启用

## 📚 技术文档

### API 参考

- [Matrix Client-Server API](https://spec.matrix.org/latest/client-server-api/)
- [Matrix JS SDK 文档](https://matrix-org.github.io/matrix-js-sdk/)
- [Rust Crypto SDK](https://github.com/matrix-org/matrix-rust-sdk)

### 相关规范

- [Matrix 端到端加密规范](https://spec.matrix.org/latest/client-server-api/#end-to-end-encryption)
- [Olm 加密库](https://gitlab.matrix.org/matrix-org/olm)
- [Megolm 群组加密](https://gitlab.matrix.org/matrix-org/olm/-/blob/master/docs/megolm.md)

## 🤝 贡献

欢迎为 JianLuoChat 的加密功能贡献代码！

### 开发环境设置

1. 克隆仓库
2. 安装依赖: `npm install`
3. 启动开发服务器: `npm run dev`
4. 运行测试: `npm run test`

### 贡献指南

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 创建 Pull Request

## 📄 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 🆘 支持

如果您遇到问题或需要帮助：

1. 查看本文档的故障排除部分
2. 运行加密测试套件进行诊断
3. 在 GitHub 上提交 Issue
4. 联系开发团队

---

**⚠️ 重要提醒**: 端到端加密是一项复杂的技术，请确保您理解其工作原理和限制。虽然我们努力提供最高级别的安全保护，但没有任何系统是100%安全的。请根据您的威胁模型和安全需求做出明智的决定。
