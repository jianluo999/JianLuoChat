class c{static instance;CLIENT_NAME="jianluochat";static getInstance(){return c.instance||(c.instance=new c),c.instance}detectConflicts(){const e={hasConflicts:!1,conflictingSources:[],recommendations:[],riskLevel:"low"},t=Object.keys(localStorage);return this.findConflictingKeys(t).length>0&&(e.hasConflicts=!0,e.conflictingSources.push("localStorage"),e.recommendations.push("æ£€æµ‹åˆ°å…¶ä»–Matrixå®¢æˆ·ç«¯çš„å­˜å‚¨æ•°æ®")),this.checkIndexedDBConflicts().then(n=>{n.length>0&&(e.hasConflicts=!0,e.conflictingSources.push("IndexedDB"),e.recommendations.push("æ£€æµ‹åˆ°å…¶ä»–Matrixå®¢æˆ·ç«¯çš„åŠ å¯†æ•°æ®åº“"))}),this.detectElementClient()&&(e.hasConflicts=!0,e.conflictingSources.push("Element"),e.recommendations.push("æ£€æµ‹åˆ°Elementå®¢æˆ·ç«¯ï¼Œå»ºè®®ä½¿ç”¨ä¸åŒçš„è®¾å¤‡ID"),e.riskLevel="high"),this.detectOtherWebClients()&&(e.hasConflicts=!0,e.conflictingSources.push("å…¶ä»–Webå®¢æˆ·ç«¯"),e.recommendations.push("æ£€æµ‹åˆ°å…¶ä»–Web Matrixå®¢æˆ·ç«¯"),e.riskLevel=e.riskLevel==="high"?"high":"medium"),e}generateIsolatedConfig(e,t){const s=this.detectConflicts(),n=e.split(":")[0].substring(1),i=Date.now(),o=Math.random().toString(36).substring(2,6);return{deviceIdPrefix:`${this.CLIENT_NAME}_${n}_${i}_${o}`,storagePrefix:`${this.CLIENT_NAME}-crypto-${n}-${o}`,useIsolatedStorage:s.hasConflicts,forceMemoryStorage:s.riskLevel==="high"}}async cleanupConflicts(e){console.log("ğŸ§¹ å¼€å§‹æ¸…ç†åŠ å¯†å†²çª..."),Object.keys(localStorage).filter(s=>s.startsWith(this.CLIENT_NAME)).forEach(s=>{(s.includes("crypto")||s.includes("device"))&&(localStorage.removeItem(s),console.log(`ğŸ—‘ï¸ æ¸…ç†localStorageé”®: ${s}`))});try{const n=(await indexedDB.databases()).filter(i=>i.name?.includes(this.CLIENT_NAME)&&(i.name.includes("crypto")||i.name.includes("matrix")));for(const i of n)i.name&&(indexedDB.deleteDatabase(i.name),console.log(`ğŸ—‘ï¸ æ¸…ç†IndexedDBæ•°æ®åº“: ${i.name}`))}catch(s){console.warn("æ¸…ç†IndexedDBæ—¶å‡ºé”™:",s)}}createSafeDeviceId(e){return this.generateIsolatedConfig(e).deviceIdPrefix}createSafeCryptoConfig(e,t){const s=this.generateIsolatedConfig(e,t);return{useIndexedDB:!s.forceMemoryStorage,cryptoDatabasePrefix:s.storagePrefix,storagePassword:void 0,storageKey:void 0}}findConflictingKeys(e){const t=[/^mx_/,/^matrix_(?!jianluochat)/,/^riot_/,/^vector_/,/^crypto_/,/^olm_/];return e.filter(s=>t.some(n=>n.test(s))&&!s.includes(this.CLIENT_NAME))}async checkIndexedDBConflicts(){try{return(await indexedDB.databases()).filter(s=>{const n=s.name?.toLowerCase()||"";return(n.includes("matrix")||n.includes("crypto")||n.includes("olm"))&&!n.includes(this.CLIENT_NAME.toLowerCase())}).map(s=>s.name||"unknown")}catch(e){return console.warn("æ— æ³•æ£€æŸ¥IndexedDBå†²çª:",e),[]}}detectElementClient(){return Object.keys(localStorage).filter(t=>t.startsWith("mx_")||t.includes("element")).length>0}detectOtherWebClients(){return Object.keys(localStorage).filter(t=>(t.includes("matrix")||t.includes("riot")||t.includes("vector"))&&!t.includes(this.CLIENT_NAME)).length>0}getConflictResolutionAdvice(e){const t=[];return e.conflictingSources.includes("Element")&&(t.push("å»ºè®®åœ¨ä¸åŒçš„æµè§ˆå™¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨Elementå’Œç®€æ´›èŠå¤©"),t.push("æˆ–è€…åœ¨Elementä¸­é€€å‡ºç™»å½•åå†ä½¿ç”¨ç®€æ´›èŠå¤©")),e.riskLevel==="high"&&(t.push("æ£€æµ‹åˆ°é«˜é£é™©å†²çªï¼Œå°†è‡ªåŠ¨ä½¿ç”¨å†…å­˜å­˜å‚¨æ¨¡å¼"),t.push("è¿™å¯èƒ½ä¼šå½±å“åŠ å¯†å¯†é’¥çš„æŒä¹…åŒ–")),e.hasConflicts&&(t.push("å»ºè®®å®šæœŸæ¸…ç†æµè§ˆå™¨å­˜å‚¨ä»¥é¿å…å†²çª"),t.push("å¦‚æœé‡åˆ°åŠ å¯†é—®é¢˜ï¼Œè¯·å°è¯•é‡ç½®åŠ å¯†è®¾ç½®")),t}}const r=c.getInstance();export{c as CryptoConflictManager,r as cryptoConflictManager};
