import{j as P,f as G,g as p,y as H,c as u,m as r,b as C,D,M as Y,E as a,e as v,a as t,B as O,N as Z,F as T,r as z,t as _,O as ee,P as te,n as se,l as F,K as S,p as ie,o,_ as J,h as w,L as ne}from"./index-Cl5nGqgc.js";import{cryptoConflictManager as K}from"./cryptoConflictManager-Dn8jFaYI.js";const oe={class:"device-verification"},le={key:0},ae={class:"verification-waiting"},re={key:1},ce={class:"sas-verification"},ue={class:"sas-emojis"},de={class:"emoji"},ve={class:"emoji-name"},fe={class:"verification-actions"},_e={key:2},me={class:"qr-verification"},pe={class:"qr-code-container"},ge={class:"verification-actions"},ye={key:3},we={class:"verification-success"},Ce={key:4},ke={class:"verification-failed"},De={key:0,class:"device-list"},he={class:"devices"},xe={class:"device-info"},Se={class:"device-name"},Ie={class:"device-id"},$e={class:"device-status"},Ve={class:"device-actions"},Me=P({__name:"DeviceVerification",props:{showDeviceList:{type:Boolean,default:!0}},setup(N,{expose:j}){const U=N,I=G(),k=p(!1),c=p("waiting"),g=p(""),y=p(null),h=p([]),d=p([]),M=p(),$=async()=>{try{const s=I.matrixClient;if(!s)return;const e=s.getCrypto();if(!e)return;const f=s.getUserId();if(!f)return;const i=await e.getUserDevices(f),n=s.getDeviceId();d.value=Array.from(i.values()).map(m=>({deviceId:m.deviceId,displayName:m.displayName,verified:m.verified,isCurrentDevice:m.deviceId===n,lastSeen:m.lastSeen}))}catch(s){console.error("加载设备列表失败:",s),S.error("加载设备列表失败")}},b=async s=>{try{const e=I.matrixClient;if(!e)throw new Error("Matrix客户端未初始化");const f=e.getCrypto();if(!f)throw new Error("加密功能不可用");const i=e.getUserId();if(!i)throw new Error("用户ID不可用");const n=await f.requestDeviceVerification(i,s.deviceId);y.value=n,n.on("change",W),k.value=!0,c.value="waiting",S.info("验证请求已发送，请在目标设备上确认")}catch(e){console.error("启动设备验证失败:",e),S.error(`启动设备验证失败: ${e.message}`)}},W=()=>{const s=y.value;if(s)if(s.phase==="started"){const e=s.verifier;if(e)if(e.getShowSasCallbacks){c.value="sas";const f=e.getShowSasCallbacks();f&&(h.value=f.sas.emoji||[])}else e.getShowQrCodeCallbacks&&(c.value="qr",ie(()=>{L()}))}else s.phase==="done"?(c.value="success",$()):s.phase==="cancelled"&&(c.value="failed",g.value="验证被取消")},Q=async()=>{try{const s=y.value;s&&s.verifier&&await s.verifier.verify()}catch(s){console.error("确认SAS匹配失败:",s),c.value="failed",g.value=s.message}},q=async()=>{try{const s=y.value;s&&await s.cancel(),E()}catch(s){console.error("取消验证失败:",s)}},B=()=>{c.value="sas"},L=()=>{console.log("生成QR码")},A=()=>{c.value="waiting",g.value=""},E=()=>{k.value=!1,y.value=null,c.value="waiting",g.value="",h.value=[]},R=s=>{S.info(`设备详情: ${s.displayName||s.deviceId}`)};return H(()=>{U.showDeviceList&&$()}),j({loadUserDevices:$,startDeviceVerification:b}),(s,e)=>{const f=D("el-icon"),i=D("el-button"),n=D("el-dialog"),m=D("el-tag");return o(),u("div",oe,[r(n,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=l=>k.value=l),title:"设备验证",width:"500px","close-on-click-modal":!1,"close-on-press-escape":!1},Y({default:a(()=>[c.value==="waiting"?(o(),u("div",le,[t("div",ae,[r(f,{class:"loading-icon"},{default:a(()=>[r(O(Z))]),_:1}),e[1]||(e[1]=t("p",null,"等待对方接受验证请求...",-1)),e[2]||(e[2]=t("p",{class:"text-sm text-gray-500"},"请在另一台设备上确认验证请求",-1))])])):c.value==="sas"?(o(),u("div",re,[t("div",ce,[e[5]||(e[5]=t("h3",null,"短认证字符串 (SAS) 验证",-1)),e[6]||(e[6]=t("p",{class:"mb-4"},"请确认以下表情符号在两台设备上是否相同：",-1)),t("div",ue,[(o(!0),u(T,null,z(h.value,(l,V)=>(o(),u("div",{key:V,class:"emoji-item"},[t("span",de,_(l.emoji),1),t("span",ve,_(l.name),1)]))),128))]),t("div",fe,[r(i,{onClick:Q,type:"primary"},{default:a(()=>e[3]||(e[3]=[v(" ✅ 表情符号匹配 ")])),_:1,__:[3]}),r(i,{onClick:q,type:"danger"},{default:a(()=>e[4]||(e[4]=[v(" ❌ 表情符号不匹配 ")])),_:1,__:[4]})])])])):c.value==="qr"?(o(),u("div",_e,[t("div",me,[e[9]||(e[9]=t("h3",null,"QR码验证",-1)),t("div",pe,[t("canvas",{ref_key:"qrCanvas",ref:M,class:"qr-code"},null,512)]),e[10]||(e[10]=t("p",{class:"text-sm text-gray-500 mt-2"}," 请使用另一台设备扫描此QR码 ",-1)),t("div",ge,[r(i,{onClick:B,type:"default"},{default:a(()=>e[7]||(e[7]=[v(" 切换到表情符号验证 ")])),_:1,__:[7]}),r(i,{onClick:q,type:"danger"},{default:a(()=>e[8]||(e[8]=[v(" 取消验证 ")])),_:1,__:[8]})])])])):c.value==="success"?(o(),u("div",ye,[t("div",we,[r(f,{class:"success-icon"},{default:a(()=>[r(O(ee))]),_:1}),e[11]||(e[11]=t("h3",null,"验证成功！",-1)),e[12]||(e[12]=t("p",null,"设备已成功验证，现在可以安全地进行端到端加密通信。",-1))])])):c.value==="failed"?(o(),u("div",Ce,[t("div",ke,[r(f,{class:"error-icon"},{default:a(()=>[r(O(te))]),_:1}),e[14]||(e[14]=t("h3",null,"验证失败",-1)),t("p",null,_(g.value),1),r(i,{onClick:A,type:"primary"},{default:a(()=>e[13]||(e[13]=[v(" 重试验证 ")])),_:1,__:[13]})])])):C("",!0)]),_:2},[c.value==="success"||c.value==="failed"?{name:"footer",fn:a(()=>[r(i,{onClick:E},{default:a(()=>e[15]||(e[15]=[v("关闭")])),_:1,__:[15]})]),key:"0"}:void 0]),1032,["modelValue"]),s.showDeviceList?(o(),u("div",De,[e[19]||(e[19]=t("h3",null,"我的设备",-1)),t("div",he,[(o(!0),u(T,null,z(d.value,l=>(o(),u("div",{key:l.deviceId,class:se(["device-item",{"current-device":l.isCurrentDevice}])},[t("div",xe,[t("div",Se,_(l.displayName||l.deviceId),1),t("div",Ie,_(l.deviceId),1),t("div",$e,[r(m,{type:l.verified?"success":"warning",size:"small"},{default:a(()=>[v(_(l.verified?"已验证":"未验证"),1)]),_:2},1032,["type"]),l.isCurrentDevice?(o(),F(m,{key:0,type:"info",size:"small"},{default:a(()=>e[16]||(e[16]=[v(" 当前设备 ")])),_:1,__:[16]})):C("",!0)])]),t("div",Ve,[!l.verified&&!l.isCurrentDevice?(o(),F(i,{key:0,onClick:V=>b(l),size:"small",type:"primary"},{default:a(()=>e[17]||(e[17]=[v(" 验证设备 ")])),_:2,__:[17]},1032,["onClick"])):C("",!0),l.verified?(o(),F(i,{key:1,onClick:V=>R(l),size:"small",type:"default"},{default:a(()=>e[18]||(e[18]=[v(" 查看详情 ")])),_:2,__:[18]},1032,["onClick"])):C("",!0)])],2))),128))])])):C("",!0)])}}}),Oe=J(Me,[["__scopeId","data-v-5d16f650"]]),be={key:0,class:"crypto-conflict-warning"},qe={class:"warning-content"},Be={class:"warning-description"},Le={key:0,class:"conflict-sources"},Ee={key:1,class:"recommendations"},Re={class:"warning-actions"},Te={key:2,class:"conflict-details"},ze={class:"detail-item"},Ne={class:"detail-item"},je={class:"detail-item"},Ue={class:"detail-item"},We=P({__name:"CryptoConflictWarning",props:{autoDetect:{type:Boolean,default:!0},showOnMount:{type:Boolean,default:!0}},emits:["conflictDetected","conflictResolved","warningDismissed"],setup(N,{expose:j,emit:U}){const I=N,k=U,c=G(),g=p(!1),y=p(!1),h=p(!1),d=p(null),M=p(""),$=w(()=>{if(!d.value)return"";switch(d.value.riskLevel){case"high":return"⚠️ 检测到高风险加密冲突";case"medium":return"⚠️ 检测到加密冲突";case"low":return"ℹ️ 检测到潜在加密冲突";default:return"检测到加密冲突"}}),b=w(()=>d.value?`检测到 ${d.value.conflictingSources.length} 个潜在的Matrix客户端冲突源。这可能会影响端到端加密的正常工作。`:""),W=w(()=>{if(!d.value)return"info";switch(d.value.riskLevel){case"high":return"error";case"medium":return"warning";case"low":return"info";default:return"info"}}),Q=w(()=>{if(!d.value)return"info";switch(d.value.riskLevel){case"high":return"danger";case"medium":return"warning";case"low":return"info";default:return"info"}}),q=w(()=>{if(!d.value)return"未知";switch(d.value.riskLevel){case"high":return"高风险";case"medium":return"中等风险";case"low":return"低风险";default:return"未知"}}),B=w(()=>d.value?.conflictingSources||[]),L=w(()=>d.value?K.getConflictResolutionAdvice(d.value):[]),A=w(()=>c.matrixClient?.getDeviceId()||"未知"),E=w(()=>"自动选择"),R=()=>{console.log("🔍 检测加密冲突...");const i=K.detectConflicts();i.hasConflicts?(d.value=i,g.value=!0,M.value=new Date().toLocaleString(),k("conflictDetected",i),console.warn("⚠️ 检测到加密冲突:",i)):console.log("✅ 未检测到加密冲突")},s=async()=>{if(d.value)try{await ne.confirm("这将清理冲突的存储数据并重新初始化加密设置。此操作可能需要重新验证设备。是否继续？","解决加密冲突",{confirmButtonText:"继续",cancelButtonText:"取消",type:"warning"}),h.value=!0;const i=c.matrixClient?.getUserId();i&&await K.cleanupConflicts(i),S.success("冲突已解决，建议刷新页面以重新初始化"),g.value=!1,k("conflictResolved")}catch(i){i!=="cancel"&&(console.error("解决冲突失败:",i),S.error("解决冲突失败"))}finally{h.value=!1}},e=()=>{g.value=!1,k("warningDismissed")},f=i=>({localStorage:"浏览器本地存储中的其他Matrix客户端数据",IndexedDB:"浏览器数据库中的其他Matrix客户端数据",Element:"Element客户端",其他Web客户端:"其他Web Matrix客户端"})[i]||i;return H(()=>{I.autoDetect&&I.showOnMount&&setTimeout(R,1e3)}),j({detectConflicts:R,dismissWarning:e}),(i,n)=>{const m=D("el-button"),l=D("el-divider"),V=D("el-tag"),X=D("el-alert");return g.value?(o(),u("div",be,[r(X,{title:$.value,type:W.value,closable:!1,"show-icon":""},{default:a(()=>[t("div",qe,[t("p",Be,_(b.value),1),B.value.length>0?(o(),u("div",Le,[n[1]||(n[1]=t("p",null,[t("strong",null,"检测到的冲突源:")],-1)),t("ul",null,[(o(!0),u(T,null,z(B.value,x=>(o(),u("li",{key:x},_(f(x)),1))),128))])])):C("",!0),L.value.length>0?(o(),u("div",Ee,[n[2]||(n[2]=t("p",null,[t("strong",null,"建议:")],-1)),t("ul",null,[(o(!0),u(T,null,z(L.value,x=>(o(),u("li",{key:x},_(x),1))),128))])])):C("",!0),t("div",Re,[r(m,{type:"primary",size:"small",onClick:s,loading:h.value},{default:a(()=>n[3]||(n[3]=[v(" 自动解决冲突 ")])),_:1,__:[3]},8,["loading"]),r(m,{type:"default",size:"small",onClick:n[0]||(n[0]=x=>y.value=!y.value)},{default:a(()=>[v(_(y.value?"隐藏详情":"查看详情"),1)]),_:1}),r(m,{type:"text",size:"small",onClick:e},{default:a(()=>n[4]||(n[4]=[v(" 暂时忽略 ")])),_:1,__:[4]})]),y.value?(o(),u("div",Te,[r(l),n[9]||(n[9]=t("h4",null,"技术详情",-1)),t("div",ze,[n[5]||(n[5]=t("strong",null,"风险级别:",-1)),r(V,{type:Q.value,size:"small"},{default:a(()=>[v(_(q.value),1)]),_:1},8,["type"])]),t("div",Ne,[n[6]||(n[6]=t("strong",null,"当前设备ID:",-1)),t("code",null,_(A.value),1)]),t("div",je,[n[7]||(n[7]=t("strong",null,"存储模式:",-1)),v(" "+_(E.value),1)]),t("div",Ue,[n[8]||(n[8]=t("strong",null,"检测时间:",-1)),v(" "+_(M.value),1)])])):C("",!0)])]),_:1},8,["title","type"])])):C("",!0)}}}),Fe=J(We,[["__scopeId","data-v-3e9f93d8"]]);export{Fe as C,Oe as D};
