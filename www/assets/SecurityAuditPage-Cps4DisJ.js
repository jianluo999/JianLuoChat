import{j as K,f as L,g as A,h as B,y as V,c as h,a as s,b as _,m,l as N,E as g,D as b,e as S,B as C,S as O,t as u,H as F,F as E,r as x,n as q,R as J,o as d,K as k,_ as G}from"./index-Cl5nGqgc.js";class Q{client=null;constructor(t){this.client=t}async performSecurityAudit(){const t=[];console.log("🔍 开始E2EE安全检查..."),t.push(...await this.checkBasicEnvironment()),t.push(...await this.checkMatrixClient()),t.push(...await this.checkCryptoInitialization()),t.push(...await this.checkKeyManagement()),t.push(...await this.checkDeviceVerification()),t.push(...await this.checkMessageEncryption()),t.push(...await this.checkSecurityConfiguration());const a=t.filter(l=>l.severity==="critical"&&l.status==="fail").length,e=t.filter(l=>l.severity==="high"&&l.status==="fail").length,n=t.filter(l=>l.severity==="medium"&&l.status==="fail").length,o=t.filter(l=>l.severity==="low"&&l.status==="fail").length;let y="secure";a>0?y="critical":e>0&&(y="vulnerable");const c={timestamp:Date.now(),overallStatus:y,criticalIssues:a,highIssues:e,mediumIssues:n,lowIssues:o,results:t};return console.log("📊 安全检查完成:",{总体状态:y,严重问题:a,高风险问题:e,中风险问题:n,低风险问题:o}),c}async checkBasicEnvironment(){const t=[];t.push({category:"基础环境",check:"HTTPS连接",status:location.protocol==="https:"?"pass":"fail",message:location.protocol==="https:"?"使用HTTPS连接":"未使用HTTPS连接",severity:location.protocol==="https:"?"low":"critical",recommendation:location.protocol!=="https:"?"必须使用HTTPS以确保传输安全":void 0});const a="crypto"in window&&"subtle"in window.crypto;t.push({category:"基础环境",check:"Web Crypto API",status:a?"pass":"fail",message:a?"Web Crypto API可用":"Web Crypto API不可用",severity:a?"low":"critical",recommendation:a?void 0:"需要支持Web Crypto API的现代浏览器"});const e="indexedDB"in window&&indexedDB!==null;t.push({category:"基础环境",check:"IndexedDB支持",status:e?"pass":"fail",message:e?"IndexedDB可用":"IndexedDB不可用",severity:e?"low":"high",recommendation:e?void 0:"需要支持IndexedDB的浏览器以安全存储密钥"});const n="WebAssembly"in window;return t.push({category:"基础环境",check:"WebAssembly支持",status:n?"pass":"fail",message:n?"WebAssembly可用":"WebAssembly不可用",severity:n?"low":"high",recommendation:n?void 0:"需要支持WebAssembly的浏览器以运行Rust加密引擎"}),t}async checkMatrixClient(){const t=[];if(t.push({category:"Matrix客户端",check:"客户端初始化",status:this.client?"pass":"fail",message:this.client?"Matrix客户端已初始化":"Matrix客户端未初始化",severity:this.client?"low":"critical",recommendation:this.client?void 0:"必须先初始化Matrix客户端"}),!this.client)return t;const a=this.client.getUserId(),e=this.client.getDeviceId();return t.push({category:"Matrix客户端",check:"用户身份",status:a?"pass":"fail",message:a?`用户ID: ${a}`:"用户ID不可用",severity:a?"low":"high"}),t.push({category:"Matrix客户端",check:"设备身份",status:e?"pass":"fail",message:e?`设备ID: ${e}`:"设备ID不可用",severity:e?"low":"high"}),t}async checkCryptoInitialization(){const t=[];if(!this.client)return t.push({category:"加密初始化",check:"加密引擎",status:"fail",message:"Matrix客户端未初始化",severity:"critical"}),t;const a=this.client.getCrypto();if(t.push({category:"加密初始化",check:"加密API可用性",status:a?"pass":"fail",message:a?"加密API可用":"加密API不可用",severity:a?"low":"critical",recommendation:a?void 0:"需要初始化Rust加密引擎"}),!a)return t;const e=["exportRoomKeys","importRoomKeys","getUserDevices","requestDeviceVerification"];for(const n of e){const o=typeof a[n]=="function";t.push({category:"加密初始化",check:`加密方法: ${n}`,status:o?"pass":"fail",message:o?`${n} 方法可用`:`${n} 方法不可用`,severity:o?"low":"high"})}return t}async checkKeyManagement(){const t=[];if(!this.client)return t;const a=this.client.getCrypto();if(!a)return t;try{const e=await a.getBackupInfo();if(t.push({category:"密钥管理",check:"密钥备份",status:e?"pass":"warning",message:e?"密钥备份已配置":"密钥备份未配置",severity:e?"low":"medium",recommendation:e?void 0:"建议配置密钥备份以防设备丢失"}),this.client.getUserId()){const o=await a.getCrossSigningKeyId();t.push({category:"密钥管理",check:"交叉签名",status:o?"pass":"warning",message:o?"交叉签名已配置":"交叉签名未配置",severity:o?"low":"medium",recommendation:o?void 0:"建议配置交叉签名以简化设备验证"})}}catch(e){t.push({category:"密钥管理",check:"密钥管理检查",status:"fail",message:`密钥管理检查失败: ${e.message}`,severity:"high"})}return t}async checkDeviceVerification(){const t=[];if(!this.client)return t;const a=this.client.getCrypto();if(!a)return t;try{const e=this.client.getUserId(),n=this.client.getDeviceId();if(e&&n){const o=await a.getDevice(e,n);t.push({category:"设备验证",check:"当前设备验证",status:o?.verified?"pass":"warning",message:o?.verified?"当前设备已验证":"当前设备未验证",severity:o?.verified?"low":"medium",recommendation:o?.verified?void 0:"建议验证当前设备以启用完整的E2EE功能"});const y=await a.getUserDevices(e),c=Array.from(y.values()).filter(l=>!l.verified&&l.deviceId!==n);t.push({category:"设备验证",check:"其他设备验证",status:c.length===0?"pass":"warning",message:c.length===0?"所有设备已验证":`${c.length}个设备未验证`,severity:c.length===0?"low":"medium",recommendation:c.length>0?"建议验证所有设备以确保安全通信":void 0})}}catch(e){t.push({category:"设备验证",check:"设备验证检查",status:"fail",message:`设备验证检查失败: ${e.message}`,severity:"high"})}return t}async checkMessageEncryption(){const t=[];return t.push({category:"消息加密",check:"加密测试",status:"warning",message:"缺乏真实的端到端加密测试",severity:"critical",recommendation:"需要实现完整的端到端加密测试以验证消息确实被加密且服务器无法解密"}),t}async checkSecurityConfiguration(){const t=[];try{const e=(await indexedDB.databases()).filter(n=>n.name&&(n.name.includes("crypto")||n.name.includes("matrix")));t.push({category:"安全配置",check:"加密数据库",status:e.length>0?"pass":"warning",message:e.length>0?`发现${e.length}个加密数据库`:"未发现加密数据库",severity:"medium"}),e.length>2&&t.push({category:"安全配置",check:"数据库冲突",status:"warning",message:`发现${e.length}个加密数据库，可能存在冲突`,severity:"medium",recommendation:"建议清理多余的加密数据库以避免冲突"})}catch(a){t.push({category:"安全配置",check:"存储配置检查",status:"fail",message:`存储配置检查失败: ${a.message}`,severity:"medium"})}return t}generateReportSummary(t){const{overallStatus:a,criticalIssues:e,highIssues:n,mediumIssues:o,lowIssues:y}=t;let c=`🔍 E2EE安全检查报告
`;c+=`📅 检查时间: ${new Date(t.timestamp).toLocaleString()}
`,c+=`📊 总体状态: ${this.getStatusEmoji(a)} ${a.toUpperCase()}

`,c+=`📈 问题统计:
`,c+=`🔴 严重问题: ${e}
`,c+=`🟠 高风险问题: ${n}
`,c+=`🟡 中风险问题: ${o}
`,c+=`🟢 低风险问题: ${y}

`,e>0&&(c+=`⚠️ 发现严重安全问题，建议立即修复！

`);const l=t.results.filter(p=>p.severity==="critical"&&p.status==="fail");return l.length>0&&(c+=`🚨 严重问题详情:
`,l.forEach(p=>{c+=`• ${p.category} - ${p.check}: ${p.message}
`,p.recommendation&&(c+=`  建议: ${p.recommendation}
`)})),c}getStatusEmoji(t){switch(t){case"secure":return"✅";case"vulnerable":return"⚠️";case"critical":return"🚨";default:return"❓"}}}const X={class:"security-audit-page"},Y={class:"audit-controls"},Z={key:0,class:"overall-status"},ee={class:"card-header"},te={class:"status-stats"},se={class:"stat-item critical"},ae={class:"stat-number"},ie={class:"stat-item high"},re={class:"stat-number"},ne={class:"stat-item medium"},ce={class:"stat-number"},oe={class:"stat-item low"},le={class:"stat-number"},ue={key:0,class:"critical-warning"},de={key:1,class:"audit-results"},he={class:"card-header"},me={class:"timestamp"},ge={class:"results-by-category"},ve={class:"category-title"},ye={class:"category-results"},pe={class:"result-header"},fe={class:"result-info"},_e={class:"result-icon"},we={class:"result-check"},ke={class:"result-message"},Ie={key:0,class:"result-recommendation"},be={key:2,class:"fix-recommendations"},Se={class:"recommendations-content"},Ee={key:0,class:"critical-fixes"},xe={key:1,class:"high-fixes"},De={key:3,class:"empty-state"},Ce=K({__name:"SecurityAuditPage",setup(M){const t=L(),a=A(!1),e=A(null),n=B(()=>e.value?[...new Set(e.value.results.map(i=>i.category))].sort():[]),o=B(()=>e.value?e.value.criticalIssues>0||e.value.highIssues>0||e.value.mediumIssues>0:!1),y=async()=>{a.value=!0;try{k.info("开始E2EE安全检查...");const i=await new Q(t.matrixClient).performSecurityAudit();e.value=i,i.overallStatus==="critical"?k.error(`发现${i.criticalIssues}个严重安全问题！`):i.overallStatus==="vulnerable"?k.warning(`发现${i.highIssues}个高风险问题`):k.success("安全检查完成，未发现严重问题")}catch(r){console.error("安全检查失败:",r),k.error(`安全检查失败: ${r.message}`)}finally{a.value=!1}},c=r=>e.value?e.value.results.filter(i=>i.category===r):[],l=()=>e.value?e.value.results.filter(r=>r.severity==="critical"&&r.status==="fail"):[],p=()=>e.value?e.value.results.filter(r=>r.severity==="high"&&r.status==="fail"):[],T=async()=>{if(e.value)try{const r={...e.value,exportTime:new Date().toISOString(),userAgent:navigator.userAgent,url:window.location.href},i=new Blob([JSON.stringify(r,null,2)],{type:"application/json"}),I=URL.createObjectURL(i),w=document.createElement("a");w.href=I,w.download=`e2ee-security-report-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(I),k.success("报告已导出")}catch{k.error("导出报告失败")}},R=r=>new Date(r).toLocaleString("zh-CN"),P=r=>{switch(r){case"secure":return"✅";case"vulnerable":return"⚠️";case"critical":return"🚨";default:return"❓"}},U=r=>{switch(r){case"secure":return"success";case"vulnerable":return"warning";case"critical":return"danger";default:return"info"}},W=r=>{switch(r){case"pass":return"✅";case"fail":return"❌";case"warning":return"⚠️";case"unknown":return"❓";default:return"❓"}},z=r=>{switch(r){case"critical":return"danger";case"high":return"danger";case"medium":return"warning";case"low":return"success";default:return"info"}};return V(()=>{}),(r,i)=>{const I=b("el-icon"),w=b("el-button"),$=b("el-tag"),j=b("el-alert"),D=b("el-card"),H=b("el-empty");return d(),h("div",X,[i[11]||(i[11]=s("div",{class:"page-header"},[s("h1",null,"🔐 E2EE 安全审计"),s("p",{class:"subtitle"},"检查端到端加密实现的安全性")],-1)),s("div",Y,[m(w,{type:"primary",onClick:y,loading:a.value,size:"large"},{default:g(()=>[m(I,null,{default:g(()=>[m(C(O))]),_:1}),S(" "+u(a.value?"检查中...":"开始安全检查"),1)]),_:1},8,["loading"]),e.value?(d(),N(w,{key:0,onClick:T,size:"large"},{default:g(()=>[m(I,null,{default:g(()=>[m(C(F))]),_:1}),i[0]||(i[0]=S(" 导出报告 "))]),_:1,__:[0]})):_("",!0)]),e.value?(d(),h("div",Z,[m(D,null,{header:g(()=>[s("div",ee,[i[1]||(i[1]=s("span",null,"总体安全状态",-1)),m($,{type:U(e.value.overallStatus),size:"large"},{default:g(()=>[S(u(P(e.value.overallStatus))+" "+u(e.value.overallStatus.toUpperCase()),1)]),_:1},8,["type"])])]),default:g(()=>[s("div",te,[s("div",se,[s("div",ae,u(e.value.criticalIssues),1),i[2]||(i[2]=s("div",{class:"stat-label"},"严重问题",-1))]),s("div",ie,[s("div",re,u(e.value.highIssues),1),i[3]||(i[3]=s("div",{class:"stat-label"},"高风险",-1))]),s("div",ne,[s("div",ce,u(e.value.mediumIssues),1),i[4]||(i[4]=s("div",{class:"stat-label"},"中风险",-1))]),s("div",oe,[s("div",le,u(e.value.lowIssues),1),i[5]||(i[5]=s("div",{class:"stat-label"},"低风险",-1))])]),e.value.criticalIssues>0?(d(),h("div",ue,[m(j,{title:"发现严重安全问题！",type:"error",description:"建议立即停止使用E2EE功能，直到修复这些问题。","show-icon":"",closable:!1})])):_("",!0)]),_:1})])):_("",!0),e.value?(d(),h("div",de,[m(D,null,{header:g(()=>[s("div",he,[i[6]||(i[6]=s("span",null,"检查结果详情",-1)),s("span",me," 检查时间: "+u(R(e.value.timestamp)),1)])]),default:g(()=>[s("div",ge,[(d(!0),h(E,null,x(n.value,v=>(d(),h("div",{key:v,class:"category-section"},[s("h3",ve,u(v),1),s("div",ye,[(d(!0),h(E,null,x(c(v),f=>(d(),h("div",{key:f.check,class:q(["result-item",[f.status,f.severity]])},[s("div",pe,[s("div",fe,[s("span",_e,u(W(f.status)),1),s("span",we,u(f.check),1),m($,{type:z(f.severity),size:"small"},{default:g(()=>[S(u(f.severity),1)]),_:2},1032,["type"])])]),s("div",ke,u(f.message),1),f.recommendation?(d(),h("div",Ie,[m(I,null,{default:g(()=>[m(C(J))]),_:1}),s("span",null,"建议: "+u(f.recommendation),1)])):_("",!0)],2))),128))])]))),128))])]),_:1})])):_("",!0),e.value&&o.value?(d(),h("div",be,[m(D,null,{header:g(()=>i[7]||(i[7]=[s("div",{class:"card-header"},[s("span",null,"🔧 修复建议")],-1)])),default:g(()=>[s("div",Se,[e.value.criticalIssues>0?(d(),h("div",Ee,[i[8]||(i[8]=s("h4",null,"🚨 紧急修复（严重问题）",-1)),s("ul",null,[(d(!0),h(E,null,x(l(),v=>(d(),h("li",{key:v.check},[s("strong",null,u(v.check),1),S(": "+u(v.recommendation||"需要立即修复"),1)]))),128))])])):_("",!0),e.value.highIssues>0?(d(),h("div",xe,[i[9]||(i[9]=s("h4",null,"⚠️ 高优先级修复",-1)),s("ul",null,[(d(!0),h(E,null,x(p(),v=>(d(),h("li",{key:v.check},[s("strong",null,u(v.check),1),S(": "+u(v.recommendation||"建议尽快修复"),1)]))),128))])])):_("",!0),i[10]||(i[10]=s("div",{class:"general-recommendations"},[s("h4",null,"📋 通用建议"),s("ul",null,[s("li",null,"定期运行安全检查以监控E2EE状态"),s("li",null,"确保所有设备都经过验证"),s("li",null,"启用密钥备份以防设备丢失"),s("li",null,"使用HTTPS连接以确保传输安全"),s("li",null,"保持Matrix SDK和依赖库的最新版本")])],-1))])]),_:1})])):_("",!0),!e.value&&!a.value?(d(),h("div",De,[m(H,{description:"点击上方按钮开始安全检查"})])):_("",!0)])}}}),Ae=G(Ce,[["__scopeId","data-v-2ab8a369"]]);export{Ae as default};
