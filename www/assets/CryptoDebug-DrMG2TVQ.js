import{j as K,f as V,g as C,y as $,c as u,a as e,m as n,l as p,b,E as o,D as S,K as E,n as _,G as m,t as r,e as x,F as D,r as I,B as j,R as H,o as a,_ as z}from"./index-Cl5nGqgc.js";const G={class:"crypto-debug"},J={class:"check-list"},O={class:"check-item"},U={class:"check-item"},q={class:"check-item"},Q={class:"check-item"},X={class:"check-item"},Y={class:"check-item"},Z={class:"actions"},ee={class:"test-actions"},se={key:0,class:"test-results"},te={class:"result-content"},le={class:"result-title"},ae={class:"result-message"},oe={key:0,class:"result-details"},ie={class:"error-logs"},ne={class:"log-time"},re={class:"log-message"},ce={key:0,class:"log-stack"},ue={class:"actions"},de={class:"suggestions"},ve={class:"suggestion-content"},pe={key:0,class:"suggestion-steps"},ye=K({__name:"CryptoDebug",setup(_e){const f=V(),F=C(!1),d=C({init:!1,keys:!1,export:!1}),t=C({webAssembly:!1,indexedDB:!1,webCrypto:!1,secureContext:!1,matrixClient:!1,cryptoAPI:!1}),v=C([]),k=C([]),g=C([]),B=async()=>{F.value=!0;try{if(t.value.webAssembly=typeof WebAssembly=="object"&&typeof WebAssembly.instantiate=="function",t.value.indexedDB="indexedDB"in window&&indexedDB!==null,t.value.webCrypto="crypto"in window&&"subtle"in window.crypto,t.value.secureContext=window.isSecureContext,t.value.matrixClient=!!f.matrixClient,f.matrixClient){const s=f.matrixClient.getCrypto();t.value.cryptoAPI=!!s}N(),E.success("环境检查完成")}catch(s){console.error("环境检查失败:",s),w("环境检查失败",s),E.error("环境检查失败")}finally{F.value=!1}},R=async()=>{d.value.init=!0;try{const s=f.matrixClient;if(!s)throw new Error("Matrix客户端未初始化");if(typeof s.initRustCrypto=="function")await s.initRustCrypto({useIndexedDB:!1}),v.value.push({title:"加密初始化测试",message:"成功初始化Rust加密引擎",success:!0,details:{method:"initRustCrypto",storage:"memory"}});else throw new Error("客户端不支持Rust加密初始化")}catch(s){console.error("加密初始化测试失败:",s),w("加密初始化测试失败",s),v.value.push({title:"加密初始化测试",message:`失败: ${s.message}`,success:!1})}finally{d.value.init=!1}},M=async()=>{d.value.keys=!0;try{const s=f.matrixClient;if(!s)throw new Error("Matrix客户端未初始化");if(!s.getCrypto())throw new Error("加密API不可用");const c=s.getDeviceId(),y=s.getUserId();v.value.push({title:"设备密钥测试",message:"成功获取设备信息",success:!0,details:{deviceId:c,userId:y,cryptoAvailable:!0}})}catch(s){console.error("设备密钥测试失败:",s),w("设备密钥测试失败",s),v.value.push({title:"设备密钥测试",message:`失败: ${s.message}`,success:!1})}finally{d.value.keys=!1}},T=async()=>{d.value.export=!0;try{const s=f.matrixClient;if(!s)throw new Error("Matrix客户端未初始化");const l=s.getCrypto();if(!l)throw new Error("加密API不可用");const c=await l.exportRoomKeys();v.value.push({title:"密钥导出测试",message:`成功导出 ${c.length} 个房间密钥`,success:!0,details:{keyCount:c.length}})}catch(s){console.error("密钥导出测试失败:",s),w("密钥导出测试失败",s),v.value.push({title:"密钥导出测试",message:`失败: ${s.message}`,success:!1})}finally{d.value.export=!1}},w=(s,l)=>{k.value.push({time:Date.now(),message:s,stack:l.stack})},W=()=>{k.value=[],v.value=[]},L=s=>new Date(s).toLocaleTimeString(),N=()=>{g.value=[],t.value.webAssembly||g.value.push({title:"WebAssembly不支持",description:"您的浏览器不支持WebAssembly，这是加密功能的必要条件",steps:["更新浏览器到最新版本","使用Chrome、Firefox或Safari浏览器","检查浏览器设置中是否禁用了WebAssembly"]}),t.value.secureContext||g.value.push({title:"非安全上下文",description:"加密功能需要在HTTPS或localhost环境下运行",steps:["使用HTTPS访问网站","或在localhost环境下测试","检查浏览器地址栏是否显示安全锁图标"]}),t.value.indexedDB||g.value.push({title:"IndexedDB不可用",description:"浏览器存储功能不可用，可能影响密钥持久化",steps:["检查浏览器是否处于隐私模式","清除浏览器数据并重试","检查浏览器存储设置"]})};return $(()=>{B()}),(s,l)=>{const c=S("el-icon"),y=S("el-button"),A=S("el-card");return a(),u("div",G,[l[10]||(l[10]=e("div",{class:"debug-header"},[e("h1",null,"🔐 加密功能调试"),e("p",null,"检查和调试端到端加密功能")],-1)),n(A,{class:"debug-card"},{header:o(()=>l[0]||(l[0]=[e("span",null,"环境检查",-1)])),default:o(()=>[e("div",J,[e("div",O,[n(c,{class:_(t.value.webAssembly?"success":"error")},{default:o(()=>[(a(),p(m(t.value.webAssembly?"SuccessFilled":"CircleCloseFilled")))]),_:1},8,["class"]),e("span",null,"WebAssembly支持: "+r(t.value.webAssembly?"✅":"❌"),1)]),e("div",U,[n(c,{class:_(t.value.indexedDB?"success":"error")},{default:o(()=>[(a(),p(m(t.value.indexedDB?"SuccessFilled":"CircleCloseFilled")))]),_:1},8,["class"]),e("span",null,"IndexedDB支持: "+r(t.value.indexedDB?"✅":"❌"),1)]),e("div",q,[n(c,{class:_(t.value.webCrypto?"success":"error")},{default:o(()=>[(a(),p(m(t.value.webCrypto?"SuccessFilled":"CircleCloseFilled")))]),_:1},8,["class"]),e("span",null,"Web Crypto API: "+r(t.value.webCrypto?"✅":"❌"),1)]),e("div",Q,[n(c,{class:_(t.value.secureContext?"success":"error")},{default:o(()=>[(a(),p(m(t.value.secureContext?"SuccessFilled":"CircleCloseFilled")))]),_:1},8,["class"]),e("span",null,"安全上下文: "+r(t.value.secureContext?"✅":"❌"),1)]),e("div",X,[n(c,{class:_(t.value.matrixClient?"success":"error")},{default:o(()=>[(a(),p(m(t.value.matrixClient?"SuccessFilled":"CircleCloseFilled")))]),_:1},8,["class"]),e("span",null,"Matrix客户端: "+r(t.value.matrixClient?"✅":"❌"),1)]),e("div",Y,[n(c,{class:_(t.value.cryptoAPI?"success":"error")},{default:o(()=>[(a(),p(m(t.value.cryptoAPI?"SuccessFilled":"CircleCloseFilled")))]),_:1},8,["class"]),e("span",null,"加密API: "+r(t.value.cryptoAPI?"✅":"❌"),1)])]),e("div",Z,[n(y,{onClick:B,loading:F.value},{default:o(()=>l[1]||(l[1]=[x(" 重新检查环境 ")])),_:1,__:[1]},8,["loading"])])]),_:1}),n(A,{class:"debug-card"},{header:o(()=>l[2]||(l[2]=[e("span",null,"加密功能测试",-1)])),default:o(()=>[e("div",ee,[n(y,{onClick:R,loading:d.value.init,disabled:!t.value.matrixClient},{default:o(()=>l[3]||(l[3]=[x(" 测试加密初始化 ")])),_:1,__:[3]},8,["loading","disabled"]),n(y,{onClick:M,loading:d.value.keys,disabled:!t.value.cryptoAPI},{default:o(()=>l[4]||(l[4]=[x(" 测试设备密钥 ")])),_:1,__:[4]},8,["loading","disabled"]),n(y,{onClick:T,loading:d.value.export,disabled:!t.value.cryptoAPI},{default:o(()=>l[5]||(l[5]=[x(" 测试密钥导出 ")])),_:1,__:[5]},8,["loading","disabled"])]),v.value.length>0?(a(),u("div",se,[l[6]||(l[6]=e("h4",null,"测试结果:",-1)),(a(!0),u(D,null,I(v.value,(i,h)=>(a(),u("div",{key:h,class:_(["test-result",{success:i.success,error:!i.success}])},[n(c,null,{default:o(()=>[(a(),p(m(i.success?"SuccessFilled":"CircleCloseFilled")))]),_:2},1024),e("div",te,[e("div",le,r(i.title),1),e("div",ae,r(i.message),1),i.details?(a(),u("div",oe,[e("pre",null,r(JSON.stringify(i.details,null,2)),1)])):b("",!0)])],2))),128))])):b("",!0)]),_:1}),k.value.length>0?(a(),p(A,{key:0,class:"debug-card"},{header:o(()=>l[7]||(l[7]=[e("span",null,"错误日志",-1)])),default:o(()=>[e("div",ie,[(a(!0),u(D,null,I(k.value,(i,h)=>(a(),u("div",{key:h,class:"error-log"},[e("div",ne,r(L(i.time)),1),e("div",re,r(i.message),1),i.stack?(a(),u("div",ce,[e("pre",null,r(i.stack),1)])):b("",!0)]))),128))]),e("div",ue,[n(y,{onClick:W},{default:o(()=>l[8]||(l[8]=[x("清除日志")])),_:1,__:[8]})])]),_:1})):b("",!0),g.value.length>0?(a(),p(A,{key:1,class:"debug-card"},{header:o(()=>l[9]||(l[9]=[e("span",null,"解决方案建议",-1)])),default:o(()=>[e("div",de,[(a(!0),u(D,null,I(g.value,(i,h)=>(a(),u("div",{key:h,class:"suggestion"},[n(c,{class:"suggestion-icon"},{default:o(()=>[n(j(H))]),_:1}),e("div",ve,[e("h4",null,r(i.title),1),e("p",null,r(i.description),1),i.steps?(a(),u("div",pe,[e("ol",null,[(a(!0),u(D,null,I(i.steps,P=>(a(),u("li",{key:P},r(P),1))),128))])])):b("",!0)])]))),128))])]),_:1})):b("",!0)])}}}),fe=z(ye,[["__scopeId","data-v-0bed1ecc"]]);export{fe as default};
