import{j as J,g,h as C,k as oe,y as Q,A as Y,c as f,a as e,b as x,U,F as N,r as V,t as c,q as ne,n as k,e as ae,o as v,_ as G,w as I,V as W,W as ie,s as re,l as le}from"./index-Cl5nGqgc.js";const ce=["onClick","onContextmenu"],me={class:"room-avatar"},de=["src","alt"],ue={key:1,class:"avatar-placeholder"},pe={key:2,class:"encryption-badge"},ve={class:"room-info"},fe={class:"room-header"},he={class:"room-name"},ge={key:0,class:"room-timestamp"},_e={key:0,class:"room-alias"},Me={key:1,class:"room-preview"},ye={class:"message-sender"},Ce={class:"message-content"},xe={key:2,class:"room-topic"},we={class:"room-badges"},$e={class:"room-meta"},Te=["title"],be={key:0,class:"public-badge",title:"公开房间"},Se={class:"notification-badges"},Pe={key:0,class:"mention-badge"},Re={key:1,class:"unread-badge"},ke={key:0,class:"performance-metrics"},Ae={class:"metric"},Fe={class:"metric"},Ee={class:"metric"},He={class:"metric"},Z=5,Ue=J({__name:"VirtualRoomList",props:{rooms:{},selectedRoom:{default:""},itemHeight:{default:72},containerHeight:{default:400},showPerformanceMetrics:{type:Boolean,default:!1}},emits:["room-selected","room-context-menu"],setup(b,{expose:a,emit:s}){const t=b,m=s,i=g(),d=g(),u=g(0),_=g(!1);let w=null;const $=g(60),y=g(0);let M=0,T=performance.now();const S=C(()=>t.rooms.length),B=C(()=>S.value*t.itemHeight),F=C(()=>Math.floor(u.value/t.itemHeight)),D=C(()=>{const l=Math.ceil((u.value+t.containerHeight)/t.itemHeight);return Math.min(l,S.value)}),P=C(()=>Math.max(0,F.value-Z)),E=C(()=>Math.min(S.value,D.value+Z)),R=C(()=>{const l=performance.now(),h=t.rooms.slice(P.value,E.value);return y.value=Math.round(performance.now()-l),h}),p=C(()=>P.value*t.itemHeight),o=C(()=>(E.value-P.value)*t.itemHeight),r=l=>{const h=l.target;u.value=h.scrollTop,_.value=!0,w&&clearTimeout(w),w=window.setTimeout(()=>{_.value=!1},150)},z=l=>{m("room-selected",l)},X=(l,h)=>{m("room-context-menu",l,h)},ee=l=>l.split(" ").map(h=>h[0]).join("").toUpperCase().substring(0,2),te=l=>{const n=Date.now()-l;return n<6e4?"now":n<36e5?`${Math.floor(n/6e4)}m`:n<864e5?`${Math.floor(n/36e5)}h`:n<6048e5?`${Math.floor(n/864e5)}d`:new Date(l).toLocaleDateString()},j=(l,h=50)=>l.length<=h?l:l.substring(0,h)+"...",q=()=>{M++;const l=performance.now();l-T>=1e3&&($.value=Math.round(M*1e3/(l-T)),M=0,T=l),requestAnimationFrame(q)},O=l=>{const h=t.rooms.findIndex(n=>n.id===l);if(h!==-1&&d.value){const n=h*t.itemHeight;d.value.scrollTop=n}};return oe(()=>t.selectedRoom,l=>{if(l){const h=t.rooms.findIndex(n=>n.id===l);if(h!==-1){const n=h*t.itemHeight,H=n+t.itemHeight,L=d.value?.scrollTop||0,se=L+t.containerHeight;(n<L||H>se)&&O(l)}}}),Q(()=>{t.showPerformanceMetrics&&q()}),Y(()=>{w&&clearTimeout(w)}),a({scrollToRoom:O}),(l,h)=>(v(),f("div",{class:"virtual-room-list",ref_key:"containerRef",ref:i},[e("div",{class:"virtual-scroll-container",style:U({height:l.containerHeight+"px"}),onScroll:r,ref_key:"scrollRef",ref:d},[e("div",{style:U({height:p.value+"px"})},null,4),(v(!0),f(N,null,V(R.value,n=>(v(),f("div",{key:n.id,class:k(["room-item",{active:n.id===l.selectedRoom,encrypted:n.encrypted,public:n.joinRule==="public",unread:n.unreadCount>0,mention:n.mentionCount>0}]),style:U({height:l.itemHeight+"px"}),onClick:H=>z(n.id),onContextmenu:ne(H=>X(n,H),["prevent"])},[e("div",me,[n.avatarUrl?(v(),f("img",{key:0,src:n.avatarUrl,alt:n.name},null,8,de)):(v(),f("div",ue,c(ee(n.name)),1)),n.encrypted?(v(),f("div",pe,h[0]||(h[0]=[e("svg",{viewBox:"0 0 24 24"},[e("path",{d:"M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"})],-1)]))):x("",!0)]),e("div",ve,[e("div",fe,[e("div",he,c(n.name),1),n.lastActivity?(v(),f("div",ge,c(te(n.lastActivity)),1)):x("",!0)]),n.alias?(v(),f("div",_e,c(n.alias),1)):x("",!0),n.lastMessage?(v(),f("div",Me,[e("span",ye,c(n.lastMessage.senderName)+":",1),e("span",Ce,c(j(n.lastMessage.content)),1)])):n.topic?(v(),f("div",xe,c(j(n.topic)),1)):x("",!0)]),e("div",we,[e("div",$e,[e("span",{class:"member-count",title:l.成员数量},[h[1]||(h[1]=e("svg",{class:"meta-icon",viewBox:"0 0 24 24"},[e("path",{d:"M16,4C18.11,4 20,5.89 20,8C20,10.11 18.11,12 16,12C13.89,12 12,10.11 12,8C12,5.89 13.89,4 16,4M16,14C20.42,14 24,15.79 24,18V20H8V18C8,15.79 11.58,14 16,14Z"})],-1)),ae(" "+c(n.memberCount||0),1)],8,Te),n.joinRule==="public"?(v(),f("div",be,h[2]||(h[2]=[e("svg",{viewBox:"0 0 24 24"},[e("path",{d:"M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"})],-1)]))):x("",!0)]),e("div",Se,[n.mentionCount>0?(v(),f("div",Pe,c(n.mentionCount),1)):n.unreadCount>0?(v(),f("div",Re,c(n.unreadCount),1)):x("",!0)])])],46,ce))),128)),e("div",{style:U({height:B.value-p.value-o.value+"px"})},null,4)],36),l.showPerformanceMetrics?(v(),f("div",ke,[e("div",Ae,"总房间: "+c(S.value),1),e("div",Fe,"可见: "+c(R.value.length),1),e("div",Ee,"FPS: "+c($.value),1),e("div",He,"渲染时间: "+c(y.value)+"ms",1)])):x("",!0)],512))}}),Ne=G(Ue,[["__scopeId","data-v-ff44a9d5"]]);class K{results=[];frameCount=0;lastTime=performance.now();currentFPS=0;generateTestRooms(a){const s=[];for(let t=0;t<a;t++)s.push({id:`!room${t}:matrix.org`,name:`测试房间 ${t+1}`,alias:`#test-room-${t}:matrix.org`,topic:`这是第 ${t+1} 个测试房间的主题描述`,type:Math.random()>.8?"public":"private",isPublic:Math.random()>.8,memberCount:Math.floor(Math.random()*100)+1,unreadCount:Math.floor(Math.random()*10),mentionCount:Math.random()>.9?Math.floor(Math.random()*3):0,encrypted:Math.random()>.5,joinRule:Math.random()>.8?"public":"invite",lastActivity:Date.now()-Math.floor(Math.random()*864e5),lastMessage:Math.random()>.3?{sender:`@user${Math.floor(Math.random()*10)}:matrix.org`,senderName:`用户${Math.floor(Math.random()*10)}`,content:`这是一条测试消息内容 ${Math.random().toString(36).substring(7)}`}:void 0,avatarUrl:Math.random()>.7?`https://api.dicebear.com/7.x/avataaars/svg?seed=${t}`:void 0});return s}startFPSMonitoring(){const a=()=>{this.frameCount++;const s=performance.now();s-this.lastTime>=1e3&&(this.currentFPS=Math.round(this.frameCount*1e3/(s-this.lastTime)),this.frameCount=0,this.lastTime=s),requestAnimationFrame(a)};a()}async testRenderPerformance(a,s=!1){const t=this.generateTestRooms(a),m=performance.now();performance.mark("render-start");const i=document.createElement("div");if(i.style.height="400px",i.style.overflow="auto",document.body.appendChild(i),s){const y=Math.min(10,a);for(let M=0;M<y;M++){const T=this.createRoomElement(t[M]);i.appendChild(T)}}else t.forEach(y=>{const M=this.createRoomElement(y);i.appendChild(M)});performance.mark("render-end"),performance.measure("room-list-render","render-start","render-end");const d=performance.now()-m,u=performance.now();await this.testScrollPerformance(i);const _=performance.now()-u,w=this.getMemoryUsage(),$=i.querySelectorAll("*").length;return document.body.removeChild(i),{fps:this.currentFPS,renderTime:Math.round(d),memoryUsage:w,domElements:$,scrollPerformance:Math.round(_)}}createRoomElement(a){const s=document.createElement("div");s.className="room-item",s.style.cssText=`
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #3a4a5c;
      min-height: 72px;
      background: rgba(0, 0, 0, 0.1);
    `;const t=document.createElement("div");t.className="room-avatar",t.style.cssText=`
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    `,t.textContent=a.name.substring(0,2).toUpperCase();const m=document.createElement("div");m.className="room-info",m.style.cssText="flex: 1; min-width: 0;";const i=document.createElement("div");i.className="room-name",i.style.cssText="font-weight: 600; font-size: 14px; color: #e0e6ed;",i.textContent=a.name;const d=document.createElement("div");d.className="room-preview",d.style.cssText="font-size: 12px; color: #b0bec5; margin-top: 4px;",d.textContent=a.lastMessage?.content||a.topic||"",m.appendChild(i),m.appendChild(d);const u=document.createElement("div");if(u.className="room-badges",u.style.cssText="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;",a.unreadCount>0){const _=document.createElement("div");_.className="unread-badge",_.style.cssText=`
        background: #4caf50;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 600;
        min-width: 16px;
        text-align: center;
      `,_.textContent=a.unreadCount.toString(),u.appendChild(_)}return s.appendChild(t),s.appendChild(m),s.appendChild(u),s}async testScrollPerformance(a){return new Promise(s=>{let t=0;const m=10,i=()=>{t<m?(a.scrollTop=t/m*a.scrollHeight,t++,requestAnimationFrame(i)):s()};i()})}getMemoryUsage(){if("memory"in performance){const a=performance.memory;return Math.round(a.usedJSHeapSize/1024/1024)}return 0}async runPerformanceTestSuite(){console.log("🚀 开始 Matrix 房间列表性能测试..."),this.startFPSMonitoring();const a=[{name:"小规模-传统渲染",roomCount:10,useVirtualScroll:!1},{name:"小规模-虚拟滚动",roomCount:10,useVirtualScroll:!0},{name:"中规模-传统渲染",roomCount:31,useVirtualScroll:!1},{name:"中规模-虚拟滚动",roomCount:31,useVirtualScroll:!0},{name:"大规模-传统渲染",roomCount:100,useVirtualScroll:!1},{name:"大规模-虚拟滚动",roomCount:100,useVirtualScroll:!0}];for(const s of a){console.log(`📊 测试: ${s.name} (${s.roomCount} 个房间)`),await new Promise(i=>setTimeout(i,1e3));const t=await this.testRenderPerformance(s.roomCount,s.useVirtualScroll),m={testName:s.name,roomCount:s.roomCount,metrics:t,timestamp:Date.now()};this.results.push(m),console.log(`✅ ${s.name} 完成:`,{FPS:t.fps,渲染时间:`${t.renderTime}ms`,内存使用:`${t.memoryUsage}MB`,DOM元素:t.domElements,滚动性能:`${t.scrollPerformance}ms`})}return this.generateReport(),this.results}generateReport(){console.log(`
📈 性能测试报告`),console.log("=".repeat(80));const a=this.results.filter(i=>i.testName.includes("传统渲染")),s=this.results.filter(i=>i.testName.includes("虚拟滚动"));console.log(`
🔍 传统渲染 vs 虚拟滚动对比:`);for(let i=0;i<a.length;i++){const d=a[i],u=s[i];if(d&&u&&d.roomCount===u.roomCount){const _=d.roomCount;console.log(`
📊 ${_} 个房间:`),console.log(`  FPS: ${d.metrics.fps} → ${u.metrics.fps} (${this.calculateImprovement(d.metrics.fps,u.metrics.fps)}%)`),console.log(`  渲染时间: ${d.metrics.renderTime}ms → ${u.metrics.renderTime}ms (${this.calculateImprovement(d.metrics.renderTime,u.metrics.renderTime,!0)}%)`),console.log(`  DOM元素: ${d.metrics.domElements} → ${u.metrics.domElements} (${this.calculateImprovement(d.metrics.domElements,u.metrics.domElements,!0)}%)`),console.log(`  内存使用: ${d.metrics.memoryUsage}MB → ${u.metrics.memoryUsage}MB (${this.calculateImprovement(d.metrics.memoryUsage,u.metrics.memoryUsage,!0)}%)`)}}console.log(`
💡 优化建议:`);const t=a.find(i=>i.roomCount>=50);t&&t.metrics.fps<45&&console.log("  ⚠️  大规模房间列表 FPS 过低，强烈建议启用虚拟滚动"),this.results.find(i=>i.metrics.memoryUsage>20)&&console.log("  ⚠️  内存使用过高，建议实现数据懒加载"),console.log(`
✅ 测试完成!`)}calculateImprovement(a,s,t=!1){if(a===0)return"0";const m=t?(a-s)/a*100:(s-a)/a*100;return m>0?`+${m.toFixed(1)}`:m.toFixed(1)}exportResults(){return JSON.stringify(this.results,null,2)}}const A=new K,Ve=async(b=31)=>{console.log(`🔬 快速性能测试 (${b} 个房间)`);const a=new K;a.startFPSMonitoring(),await new Promise(u=>setTimeout(u,1e3));const s=await a.testRenderPerformance(b,!1),t=await a.testRenderPerformance(b,!0);console.log(`
📊 测试结果:`),console.log("传统渲染:",s),console.log("虚拟滚动:",t);const m=((t.fps-s.fps)/s.fps*100).toFixed(1),i=((s.renderTime-t.renderTime)/s.renderTime*100).toFixed(1),d=((s.domElements-t.domElements)/s.domElements*100).toFixed(1);return console.log(`
🎯 性能提升:`),console.log(`  FPS 提升: ${m}%`),console.log(`  渲染时间减少: ${i}%`),console.log(`  DOM 元素减少: ${d}%`),{traditionalMetrics:s,virtualMetrics:t}};typeof window<"u"&&(window.runMatrixPerformanceTest=()=>A.runPerformanceTestSuite()(window).runQuickMatrixTest=Ve);const Be={class:"performance-test-page"},De={class:"test-controls"},Ie={class:"control-group"},ze={class:"control-group"},je={class:"control-group"},qe=["disabled"],Oe={key:0,class:"test-results"},Le={class:"results-grid"},We={class:"metrics"},Ze={class:"metric"},Je={class:"metric"},Qe={class:"metric-value"},Ye={class:"metric"},Ge={class:"metric-value"},Ke={class:"metric"},Xe={class:"metric-value"},et={class:"live-demo"},tt={class:"demo-controls"},st={class:"demo-toggle"},ot={class:"performance-metrics"},nt={class:"fps-display"},at={class:"render-time"},it={class:"demo-container"},rt={key:1,class:"traditional-room-list demo-room-list",style:{height:"400px",overflowY:"auto"}},lt=["onClick"],ct={class:"room-avatar"},mt={class:"avatar-placeholder"},dt={class:"room-info"},ut={class:"room-name"},pt={key:0,class:"room-preview"},vt={key:1,class:"room-topic"},ft={class:"room-badges"},ht={key:0,class:"unread-badge"},gt={class:"optimization-tips"},_t={class:"tips-grid"},Mt={class:"tip-icon"},yt=J({__name:"PerformanceTestPage",setup(b){const a=g(31),s=g("auto"),t=g(!1),m=g([]),i=g(""),d=g(!0),u=g([]),_=g(60),w=g(0);let $=0,y=performance.now();const M=[{icon:"🚀",title:"虚拟滚动",description:"只渲染可见区域的房间项，大幅减少 DOM 元素数量",impact:"high"},{icon:"💾",title:"数据懒加载",description:"按需加载房间详细信息，减少初始内存占用",impact:"medium"},{icon:"🔍",title:"搜索防抖",description:"延迟搜索执行，避免频繁的过滤操作",impact:"medium"},{icon:"🖼️",title:"图片懒加载",description:"延迟加载房间头像，提升初始渲染速度",impact:"low"},{icon:"⚡",title:"Web Workers",description:"在后台线程处理数据，避免阻塞主线程",impact:"high"},{icon:"📦",title:"数据缓存",description:"缓存房间数据，减少重复的网络请求",impact:"medium"}],T=C(()=>m.value.length===0?null:m.value.reduce((p,o)=>o.metrics.fps>p.metrics.fps?o:p)),S=()=>{u.value=A.generateTestRooms(parseInt(a.value))},B=async()=>{t.value=!0,m.value=[];try{const p=parseInt(a.value);if(s.value==="traditional"||s.value==="auto"){const o=await A.testRenderPerformance(p,!1);m.value.push({testName:`传统渲染 (${p} 个房间)`,roomCount:p,metrics:o,timestamp:Date.now(),isBest:!1})}if(s.value==="virtual"||s.value==="auto"){const o=await A.testRenderPerformance(p,!0);m.value.push({testName:`虚拟滚动 (${p} 个房间)`,roomCount:p,metrics:o,timestamp:Date.now(),isBest:!1})}if(T.value){const o=m.value.find(r=>r.metrics.fps===T.value.metrics.fps);o&&(o.isBest=!0)}}catch(p){console.error("性能测试失败:",p)}finally{t.value=!1}},F=p=>{i.value=p},D=()=>{console.log(`演示模式切换到: ${d.value?"虚拟滚动":"传统渲染"}`)},P=p=>p.split(" ").map(o=>o[0]).join("").toUpperCase().substring(0,2),E=p=>p>=55?"fps-excellent":p>=45?"fps-good":p>=30?"fps-fair":"fps-poor",R=()=>{$++;const p=performance.now();p-y>=1e3&&(_.value=Math.round($*1e3/(p-y)),$=0,y=p),requestAnimationFrame(R)};return Q(()=>{S(),R(),A.startFPSMonitoring()}),Y(()=>{}),(p,o)=>(v(),f("div",Be,[o[15]||(o[15]=e("div",{class:"test-header"},[e("h1",null,"Matrix 房间列表性能测试"),e("p",null,"测试虚拟滚动优化效果")],-1)),e("div",De,[e("div",Ie,[o[4]||(o[4]=e("label",null,"房间数量:",-1)),I(e("select",{"onUpdate:modelValue":o[0]||(o[0]=r=>a.value=r),onChange:S},o[3]||(o[3]=[ie('<option value="10" data-v-1ef7d918>10 个房间</option><option value="31" data-v-1ef7d918>31 个房间 (当前)</option><option value="50" data-v-1ef7d918>50 个房间</option><option value="100" data-v-1ef7d918>100 个房间</option><option value="200" data-v-1ef7d918>200 个房间</option>',5)]),544),[[W,a.value]])]),e("div",ze,[o[6]||(o[6]=e("label",null,"渲染模式:",-1)),I(e("select",{"onUpdate:modelValue":o[1]||(o[1]=r=>s.value=r)},o[5]||(o[5]=[e("option",{value:"traditional"},"传统渲染",-1),e("option",{value:"virtual"},"虚拟滚动",-1),e("option",{value:"auto"},"自动选择",-1)]),512),[[W,s.value]])]),e("div",je,[e("button",{onClick:B,disabled:t.value,class:"test-button"},c(t.value?"测试中...":"运行性能测试"),9,qe)])]),m.value.length>0?(v(),f("div",Oe,[o[11]||(o[11]=e("h2",null,"测试结果",-1)),e("div",Le,[(v(!0),f(N,null,V(m.value,r=>(v(),f("div",{key:r.testName,class:k(["result-card",{"best-performance":r.isBest}])},[e("h3",null,c(r.testName),1),e("div",We,[e("div",Ze,[o[7]||(o[7]=e("span",{class:"metric-label"},"FPS:",-1)),e("span",{class:k(["metric-value",E(r.metrics.fps)])},c(r.metrics.fps),3)]),e("div",Je,[o[8]||(o[8]=e("span",{class:"metric-label"},"渲染时间:",-1)),e("span",Qe,c(r.metrics.renderTime)+"ms",1)]),e("div",Ye,[o[9]||(o[9]=e("span",{class:"metric-label"},"DOM 元素:",-1)),e("span",Ge,c(r.metrics.domElements),1)]),e("div",Ke,[o[10]||(o[10]=e("span",{class:"metric-label"},"内存使用:",-1)),e("span",Xe,c(r.metrics.memoryUsage)+"MB",1)])])],2))),128))])])):x("",!0),e("div",et,[o[13]||(o[13]=e("h2",null,"实时演示",-1)),e("div",tt,[e("label",st,[I(e("input",{type:"checkbox","onUpdate:modelValue":o[2]||(o[2]=r=>d.value=r),onChange:D},null,544),[[re,d.value]]),o[12]||(o[12]=e("span",null,"启用虚拟滚动",-1))]),e("div",ot,[e("span",nt,"FPS: "+c(_.value),1),e("span",at,"渲染: "+c(w.value)+"ms",1)])]),e("div",it,[d.value?(v(),le(Ne,{key:0,rooms:u.value,"selected-room":i.value,"container-height":400,"item-height":72,"show-performance-metrics":!0,onRoomSelected:F,class:"demo-room-list"},null,8,["rooms","selected-room"])):(v(),f("div",rt,[(v(!0),f(N,null,V(u.value,r=>(v(),f("div",{key:r.id,class:k(["room-item",{active:r.id===i.value}]),onClick:z=>F(r.id)},[e("div",ct,[e("div",mt,c(P(r.name)),1)]),e("div",dt,[e("div",ut,c(r.name),1),r.lastMessage?(v(),f("div",pt,c(r.lastMessage.senderName)+": "+c(r.lastMessage.content),1)):r.topic?(v(),f("div",vt,c(r.topic),1)):x("",!0)]),e("div",ft,[r.unreadCount>0?(v(),f("div",ht,c(r.unreadCount),1)):x("",!0)])],10,lt))),128))]))])]),e("div",gt,[o[14]||(o[14]=e("h2",null,"优化建议",-1)),e("div",_t,[(v(),f(N,null,V(M,r=>e("div",{class:"tip-card",key:r.title},[e("div",Mt,c(r.icon),1),e("h3",null,c(r.title),1),e("p",null,c(r.description),1),e("div",{class:k(["tip-impact",r.impact])}," 影响: "+c(r.impact),3)])),64))])])]))}}),xt=G(yt,[["__scopeId","data-v-1ef7d918"]]);export{xt as default};
