const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CbSAnjSN.js","assets/index-Cl5nGqgc.js","assets/index-Dfi89B19.css"])))=>i.map(i=>d[i]);
import{Y as mo,C as Jh}from"./index-Cl5nGqgc.js";function Tl(i,e,t,r,n,a,s){try{var o=i[a](s),l=o.value}catch(d){return void t(d)}o.done?e(l):Promise.resolve(l).then(r,n)}function T(i){return function(){var e=this,t=arguments;return new Promise(function(r,n){var a=i.apply(e,t);function s(l){Tl(a,r,n,s,o,"next",l)}function o(l){Tl(a,r,n,s,o,"throw",l)}s(void 0)})}}function Ti(i){"@babel/helpers - typeof";return Ti=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ti(i)}function zh(i,e){if(Ti(i)!="object"||!i)return i;var t=i[Symbol.toPrimitive];if(t!==void 0){var r=t.call(i,e);if(Ti(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}function Yh(i){var e=zh(i,"string");return Ti(e)=="symbol"?e:e+""}function c(i,e,t){return(e=Yh(e))in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}const Xh="l",Qh="rn",Zh={0:"O",1:"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","𑒿":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","𑌀":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","𑇊":"̣","𑓃":"̣","𐨺":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ",ﱞ:"ﹲّ","ࣲ":"ٍ",ﱟ:"ﹴّ",ﳲ:"ﹷّ",ﱠ:"ﹶّ",ﳳ:"ﹹّ",ﱡ:"ﹸّ","ؚ":"ِ","̗":"ِ",ﳴ:"ﹻّ",ﱢ:"ﹺّ",ﱣ:"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","𑓁":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\u2028":" ","\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","¸":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":",ː:":","ꓽ":":","⩴":"::=","⧴":":→","！":"!",ǃ:"!","ⵑ":"!","‼":"!!","⁉":"!?",ʔ:"?","Ɂ":"?","ॽ":"?",Ꭾ:"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","𝅭":".","․":".","܁":".","܂":".","꘎":".","𐩐":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"·","･":"·","᛫":"·","·":"·","⸱":"·","𐄁":"·","•":"·","‧":"·","∙":"·","⋅":"·","ꞏ":"·",ᐧ:"·","⋯":"···","ⵈ":"···",ᑄ:"·<","⋗":"·>",ᐷ:"·>",ᑀ:"·>",ᔯ:"·4",ᑾ:"·b",ᒀ:"·ḃ",ᑺ:"·d",ᒘ:"·J",ᒶ:"·L",ᑶ:"·P",ᑗ:"·U",ᐺ:"·V",ᐼ:"·Ʌ",ᒮ:"·Γ",ᐎ:"·Δ",ᑙ:"·Ո",ᐌ:"·ᐁ",ᐐ:"·ᐄ",ᐒ:"·ᐅ",ᐔ:"·ᐆ",ᐗ:"·ᐊ",ᐙ:"·ᐋ",ᐾ:"·ᐲ",ᑂ:"·ᐴ",ᑆ:"·ᐹ",ᑛ:"·ᑏ",ᑔ:"·ᑐ",ᑝ:"·ᑐ",ᑟ:"·ᑑ",ᑡ:"·ᑕ",ᑣ:"·ᑖ",ᑴ:"·ᑫ",ᑸ:"·ᑮ",ᑼ:"·ᑰ",ᒒ:"·ᒉ",ᒔ:"·ᒋ",ᒖ:"·ᒌ",ᒚ:"·ᒎ",ᒜ:"·ᒐ",ᒞ:"·ᒑ",ᒬ:"·ᒣ",ᒰ:"·ᒦ",ᒲ:"·ᒧ",ᒴ:"·ᒨ",ᒸ:"·ᒫ",ᓉ:"·ᓀ","ᣆ":"·ᓂ","ᣈ":"·ᓃ","ᣊ":"·ᓄ","ᣌ":"·ᓅ",ᓋ:"·ᓇ",ᓍ:"·ᓈ",ᓜ:"·ᓓ",ᓞ:"·ᓕ",ᓠ:"·ᓖ",ᓢ:"·ᓗ",ᓤ:"·ᓘ",ᓦ:"·ᓚ",ᓨ:"·ᓛ",ᓶ:"·ᓭ",ᓸ:"·ᓯ",ᓺ:"·ᓰ",ᓼ:"·ᓱ",ᓾ:"·ᓲ",ᔀ:"·ᓴ",ᔂ:"·ᓵ",ᔗ:"·ᔐ",ᔙ:"·ᔑ",ᔛ:"·ᔒ",ᔝ:"·ᔓ",ᔟ:"·ᔔ",ᔡ:"·ᔕ",ᔣ:"·ᔖ",ᔱ:"·ᔨ",ᔳ:"·ᔩ",ᔵ:"·ᔪ",ᔷ:"·ᔫ",ᔹ:"·ᔭ",ᔻ:"·ᔮ","ᣎ":"·ᕃ","ᣏ":"·ᕆ","ᣐ":"·ᕇ","ᣑ":"·ᕈ","ᣒ":"·ᕉ","ᣓ":"·ᕋ",ᕎ:"·ᕌ",ᕛ:"·ᕚ",ᕨ:"·ᕧ","ᢳ":"·ᢱ","ᢶ":"·ᢴ","ᢹ":"·ᢸ","ᣂ":"·ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","𐩗":"𐩖𐩖","𑑌":"𑑋𑑋","𑙂":"𑙁𑙁","𑱂":"𑱁𑱁","᱿":"᱾᱾","՝":"'","＇":"'","‘":"'","’":"'","‛":"'","′":"'","‵":"'","՚":"'","׳":"'","`":"'","`":"'","｀":"'","´":"'","΄":"'","´":"'","᾽":"'","᾿":"'","῾":"'","ʹ":"'","ʹ":"'","ˈ":"'","ˊ":"'","ˋ":"'","˴":"'",ʻ:"'",ʽ:"'",ʼ:"'",ʾ:"'","ꞌ":"'",י:"'","ߴ":"'","ߵ":"'",ᑊ:"'",ᛌ:"'","𖽑":"'","𖽒":"'","᳓":"''",'"':"''","＂":"''","“":"''","”":"''","‟":"''","″":"''","‶":"''","〃":"''","״":"''","˝":"''","ʺ":"''","˶":"''",ˮ:"''",ײ:"''","‴":"'''","‷":"'''","⁗":"''''",Ɓ:"'B",Ɗ:"'D",ŉ:"'n",Ƥ:"'P",Ƭ:"'T",Ƴ:"'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","🄐":"(A)","⒝":"(b)","🄑":"(B)","⒞":"(c)","🄒":"(C)","⒟":"(d)","🄓":"(D)","⒠":"(e)","🄔":"(E)","⒡":"(f)","🄕":"(F)","⒢":"(g)","🄖":"(G)","⒣":"(h)","🄗":"(H)","⒤":"(i)","⒥":"(j)","🄙":"(J)","⒦":"(k)","🄚":"(K)","⑴":"(l)","🄘":"(l)","⒧":"(l)","🄛":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","🄜":"(M)","⒩":"(n)","🄝":"(N)","⒪":"(o)","🄞":"(O)","⒫":"(p)","🄟":"(P)","⒬":"(q)","🄠":"(Q)","⒭":"(r)","🄡":"(R)","⒨":"(rn)","⒮":"(s)","🄢":"(S)","🄪":"(S)","⒯":"(t)","🄣":"(T)","⒰":"(u)","🄤":"(U)","⒱":"(v)","🄥":"(V)","⒲":"(w)","🄦":"(W)","⒳":"(x)","🄧":"(X)","⒴":"(y)","🄨":"(Y)","⒵":"(z)","🄩":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","🉁":"(三)","㈨":"(九)","㈡":"(二)","🉂":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","🉇":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","🉃":"(安)","🉅":"(打)","🉈":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","🉀":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","🉄":"(点)","㈵":"(特)","🉆":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","𝄔":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬",く:"❬","𡿨":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"¶","⁎":"*","٭":"*","∗":"*","𐌟":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","𝈺":"/","㇓":"/",〳:"/","Ⳇ":"/",ノ:"/",丿:"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\","﹨":"\\","∖":"\\","⟍":"\\","⧵":"\\","⧹":"\\","𝈏":"\\","𝈻":"\\","㇔":"\\",丶:"\\","⼂":"\\","⳹":"\\\\","⑊":"\\\\","⟈":"\\ᑕ","ꝸ":"&","૰":"॰","𑂻":"॰","𑇇":"॰","⚬":"॰","𑇛":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","¯":"ˉ","￣":"ˉ","▔":"ˉ",ъ:"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"°","˚":"°","∘":"°","○":"°","◦":"°","⍜":"°̲","⍤":"°̈","℃":"°C","℉":"°F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"©","Ⓡ":"®","Ⓟ":"℗","𝈛":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","𝛛":"∂","𝜕":"∂","𝝏":"∂","𝞉":"∂","𝟃":"∂","𞣌":"∂","𞣍":"∂̵",ð:"∂̵","⌀":"∅","𝛁":"∇","𝛻":"∇","𝜵":"∇","𝝯":"∇","𝞩":"∇","𑢨":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","𐊛":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"÷","‹":"<","❮":"<","˂":"<","𝈶":"<",ᐸ:"<",ᚲ:"<","⋖":"<·","Ⲵ":"<·",ᑅ:"<·","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","𝈷":">",ᐳ:">","𖼿":">",ᑁ:">·","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","𞣈":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","𑇞":"≈","♎":"≏","🝞":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","𝈸":"⊏","𝈹":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","🝱":"⊠","🝕":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","🜊":"☩","🌒":"☽","🌙":"☽","⏾":"☾","🌘":"☾","⧙":"⦚","🜺":"⧟","⨾":"⨟","𐆠":"⳨","♩":"𝅘𝅥","♪":"𝅘𝅥𝅮","⓪":"🄍","↺":"🄎","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー",ᅳ:"ー",ㅡ:"ー",一:"ー","⼀":"ー",ᆖ:"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ",ᆕ:"ーᅮ",ᅴ:"ー丨",ㅢ:"ー丨",ᆗ:"ー丨ᅮ","🄏":"$⃠","₤":"£","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","𑓑":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","𝟐":"2","𝟚":"2","𝟤":"2","𝟮":"2","𝟸":"2","🯲":"2","Ꝛ":"2",Ƨ:"2",Ϩ:"2","Ꙅ":"2",ᒿ:"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","𑓒":"২","೨":"౨","②":"➁",ƻ:"2̵","🄃":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","𝈆":"3","𝟑":"3","𝟛":"3","𝟥":"3","𝟯":"3","𝟹":"3","🯳":"3","Ɜ":"3",Ȝ:"3",Ʒ:"3","Ꝫ":"3","Ⳍ":"3",З:"3",Ӡ:"3","𖼻":"3","𑣊":"3","۳":"٣","𞣉":"٣","૩":"३","③":"➂",Ҙ:"3̦","🄄":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","𝟒":"4","𝟜":"4","𝟦":"4","𝟰":"4","𝟺":"4","🯴":"4",Ꮞ:"4","𑢯":"4","۴":"٤","૪":"४","④":"➃","🄅":"4,","⒋":"4.",ᔰ:"4·","㏣":"4日","㋃":"4月","㍜":"4点","𝟓":"5","𝟝":"5","𝟧":"5","𝟱":"5","𝟻":"5","🯵":"5",Ƽ:"5","𑢻":"5","⑤":"➄","🄆":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","𝟔":"6","𝟞":"6","𝟨":"6","𝟲":"6","𝟼":"6","🯶":"6","Ⳓ":"6",б:"6",Ꮾ:"6","𑣕":"6","۶":"٦","𑓖":"৬","⑥":"➅","🄇":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","𝈒":"7","𝟕":"7","𝟟":"7","𝟩":"7","𝟳":"7","𝟽":"7","🯷":"7","𐓒":"7","𑣆":"7","⑦":"➆","🄈":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","𞣋":"8","𝟖":"8","𝟠":"8","𝟪":"8","𝟴":"8","𝟾":"8","🯸":"8",ȣ:"8",Ȣ:"8","𐌚":"8","૮":"८","⑧":"➇","🄉":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","𝟗":"9","𝟡":"9","𝟫":"9","𝟵":"9","𝟿":"9","🯹":"9","Ꝯ":"9","Ⳋ":"9","𑣌":"9","𑢬":"9","𑣖":"9","१":"٩","𑣤":"٩","۹":"٩","೯":"౯","⑨":"➈","🄊":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a",ａ:"a","𝐚":"a","𝑎":"a","𝒂":"a","𝒶":"a","𝓪":"a","𝔞":"a","𝕒":"a","𝖆":"a","𝖺":"a","𝗮":"a","𝘢":"a","𝙖":"a","𝚊":"a",ɑ:"a",α:"a","𝛂":"a","𝛼":"a","𝜶":"a","𝝰":"a","𝞪":"a",а:"a","ⷶ":"ͣ",Ａ:"A","𝐀":"A","𝐴":"A","𝑨":"A","𝒜":"A","𝓐":"A","𝔄":"A","𝔸":"A","𝕬":"A","𝖠":"A","𝗔":"A","𝘈":"A","𝘼":"A","𝙰":"A",Α:"A","𝚨":"A","𝛢":"A","𝜜":"A","𝝖":"A","𝞐":"A",А:"A",Ꭺ:"A",ᗅ:"A","ꓮ":"A","𖽀":"A","𐊠":"A","⍶":"a̲",ǎ:"ă",Ǎ:"Ă",ȧ:"å",Ȧ:"Å",ẚ:"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA",æ:"ae",ӕ:"ae",Æ:"AE",Ӕ:"AE","ꜵ":"ao","Ꜵ":"AO","🜇":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","𝈗":"Ɐ",ᗄ:"Ɐ","ꓯ":"Ɐ","𐐟":"Ɒ","𝐛":"b","𝑏":"b","𝒃":"b","𝒷":"b","𝓫":"b","𝔟":"b","𝕓":"b","𝖇":"b","𝖻":"b","𝗯":"b","𝘣":"b","𝙗":"b","𝚋":"b",Ƅ:"b",Ь:"b",Ꮟ:"b",ᑲ:"b",ᖯ:"b",Ｂ:"B",ℬ:"B","𝐁":"B","𝐵":"B","𝑩":"B","𝓑":"B","𝔅":"B","𝔹":"B","𝕭":"B","𝖡":"B","𝗕":"B","𝘉":"B","𝘽":"B","𝙱":"B","Ꞵ":"B",Β:"B","𝚩":"B","𝛣":"B","𝜝":"B","𝝗":"B","𝞑":"B",В:"B",Ᏼ:"B",ᗷ:"B","ꓐ":"B","𐊂":"B","𐊡":"B","𐌁":"B",ɓ:"b̔",ᑳ:"ḃ",ƃ:"b̄",Ƃ:"b̄",Б:"b̄",ƀ:"b̵",ҍ:"b̵",Ҍ:"b̵",ѣ:"b̵",Ѣ:"b̵",ᑿ:"b·",ᒁ:"ḃ·",ᒈ:"b'",Ы:"bl",в:"ʙ","ᏼ":"ʙ",ｃ:"c","ⅽ":"c","𝐜":"c","𝑐":"c","𝒄":"c","𝒸":"c","𝓬":"c","𝔠":"c","𝕔":"c","𝖈":"c","𝖼":"c","𝗰":"c","𝘤":"c","𝙘":"c","𝚌":"c","ᴄ":"c",ϲ:"c","ⲥ":"c",с:"c","ꮯ":"c","𐐽":"c","ⷭ":"ͨ","🝌":"C","𑣲":"C","𑣩":"C",Ｃ:"C","Ⅽ":"C",ℂ:"C",ℭ:"C","𝐂":"C","𝐶":"C","𝑪":"C","𝒞":"C","𝓒":"C","𝕮":"C","𝖢":"C","𝗖":"C","𝘊":"C","𝘾":"C","𝙲":"C","Ϲ":"C","Ⲥ":"C",С:"C",Ꮯ:"C","ꓚ":"C","𐊢":"C","𐌂":"C","𐐕":"C","𐔜":"C","¢":"c̸","ȼ":"c̸","₡":"C⃫","🅮":"C⃠",ç:"c̦",ҫ:"c̦",Ç:"C̦",Ҫ:"C̦",Ƈ:"C'","℅":"c/o","℆":"c/u","🅭":"㏄	⃝","⋴":"ꞓ",ɛ:"ꞓ",ε:"ꞓ","ϵ":"ꞓ","𝛆":"ꞓ","𝛜":"ꞓ","𝜀":"ꞓ","𝜖":"ꞓ","𝜺":"ꞓ","𝝐":"ꞓ","𝝴":"ꞓ","𝞊":"ꞓ","𝞮":"ꞓ","𝟄":"ꞓ","ⲉ":"ꞓ",є:"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","𑣎":"ꞓ","𐐩":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ",Є:"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","𝐝":"d","𝑑":"d","𝒅":"d","𝒹":"d","𝓭":"d","𝔡":"d","𝕕":"d","𝖉":"d","𝖽":"d","𝗱":"d","𝘥":"d","𝙙":"d","𝚍":"d","ԁ":"d",Ꮷ:"d",ᑯ:"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","𝐃":"D","𝐷":"D","𝑫":"D","𝒟":"D","𝓓":"D","𝔇":"D","𝔻":"D","𝕯":"D","𝖣":"D","𝗗":"D","𝘋":"D","𝘿":"D","𝙳":"D",Ꭰ:"D",ᗞ:"D",ᗪ:"D","ꓓ":"D",ɗ:"d̔",ɖ:"d̨",ƌ:"d̄",đ:"d̵",Đ:"D̵",Ð:"D̵",Ɖ:"D̵","₫":"ḏ̵","ꝺ":"Ꝺ",ᑻ:"d·",ᒇ:"d'",ʤ:"dȝ",ǳ:"dz",ʣ:"dz",ǲ:"Dz",Ǳ:"DZ",ǆ:"dž",ǅ:"Dž",Ǆ:"DŽ",ʥ:"dʑ","ꭰ":"ᴅ","⸹":"ẟ",δ:"ẟ","𝛅":"ẟ","𝛿":"ẟ","𝜹":"ẟ","𝝳":"ẟ","𝞭":"ẟ",ծ:"ẟ",ᕷ:"ẟ","℮":"e",ｅ:"e",ℯ:"e","ⅇ":"e","𝐞":"e","𝑒":"e","𝒆":"e","𝓮":"e","𝔢":"e","𝕖":"e","𝖊":"e","𝖾":"e","𝗲":"e","𝘦":"e","𝙚":"e","𝚎":"e","ꬲ":"e",е:"e",ҽ:"e","ⷷ":"ͤ","⋿":"E",Ｅ:"E",ℰ:"E","𝐄":"E","𝐸":"E","𝑬":"E","𝓔":"E","𝔈":"E","𝔼":"E","𝕰":"E","𝖤":"E","𝗘":"E","𝘌":"E","𝙀":"E","𝙴":"E",Ε:"E","𝚬":"E","𝛦":"E","𝜠":"E","𝝚":"E","𝞔":"E",Е:"E","ⴹ":"E",Ꭼ:"E","ꓰ":"E","𑢦":"E","𑢮":"E","𐊆":"E",ě:"ĕ",Ě:"Ĕ","ɇ":"e̸","Ɇ":"E̸",ҿ:"ę","ꭼ":"ᴇ",ə:"ǝ",ә:"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ",ɚ:"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵",Ә:"Ə","𝈡":"Ɛ",ℇ:"Ɛ","Ԑ":"Ɛ",Ꮛ:"Ɛ","𖼭":"Ɛ","𐐁":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ",з:"ɜ",ҙ:"ɜ̦","𐑂":"ɞ","ꞝ":"ʚ","𐐪":"ʚ","𝐟":"f","𝑓":"f","𝒇":"f","𝒻":"f","𝓯":"f","𝔣":"f","𝕗":"f","𝖋":"f","𝖿":"f","𝗳":"f","𝘧":"f","𝙛":"f","𝚏":"f","ꬵ":"f","ꞙ":"f",ſ:"f","ẝ":"f",ք:"f","𝈓":"F",ℱ:"F","𝐅":"F","𝐹":"F","𝑭":"F","𝓕":"F","𝔉":"F","𝔽":"F","𝕱":"F","𝖥":"F","𝗙":"F","𝘍":"F","𝙁":"F","𝙵":"F","Ꞙ":"F",Ϝ:"F","𝟊":"F",ᖴ:"F","ꓝ":"F","𑣂":"F","𑢢":"F","𐊇":"F","𐊥":"F","𐔥":"F",ƒ:"f̦",Ƒ:"F̦","ᵮ":"f̴","℻":"FAX",ﬀ:"ff",ﬃ:"ffi",ﬄ:"ffl",ﬁ:"fi",ﬂ:"fl",ʩ:"fŋ",ᖵ:"Ⅎ","ꓞ":"Ⅎ","𝈰":"ꟻ",ᖷ:"ꟻ",ｇ:"g",ℊ:"g","𝐠":"g","𝑔":"g","𝒈":"g","𝓰":"g","𝔤":"g","𝕘":"g","𝖌":"g","𝗀":"g","𝗴":"g","𝘨":"g","𝙜":"g","𝚐":"g",ɡ:"g","ᶃ":"g",ƍ:"g",ց:"g","𝐆":"G","𝐺":"G","𝑮":"G","𝒢":"G","𝓖":"G","𝔊":"G","𝔾":"G","𝕲":"G","𝖦":"G","𝗚":"G","𝘎":"G","𝙂":"G","𝙶":"G","Ԍ":"G",Ꮐ:"G",Ᏻ:"G","ꓖ":"G","ᶢ":"ᵍ",ɠ:"g̔",ǧ:"ğ",Ǧ:"Ğ",ǵ:"ģ",ǥ:"g̵",Ǥ:"G̵",Ɠ:"G'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ",ｈ:"h",ℎ:"h","𝐡":"h","𝒉":"h","𝒽":"h","𝓱":"h","𝔥":"h","𝕙":"h","𝖍":"h","𝗁":"h","𝗵":"h","𝘩":"h","𝙝":"h","𝚑":"h",һ:"h",հ:"h",Ꮒ:"h",Ｈ:"H",ℋ:"H",ℌ:"H",ℍ:"H","𝐇":"H","𝐻":"H","𝑯":"H","𝓗":"H","𝕳":"H","𝖧":"H","𝗛":"H","𝘏":"H","𝙃":"H","𝙷":"H",Η:"H","𝚮":"H","𝛨":"H","𝜢":"H","𝝜":"H","𝞖":"H","Ⲏ":"H",Н:"H",Ꮋ:"H",ᕼ:"H","ꓧ":"H","𐋏":"H","ᵸ":"ᴴ",ɦ:"h̔","ꚕ":"h̔",Ᏺ:"h̔","Ⱨ":"H̩",Ң:"H̩",ħ:"h̵",ℏ:"h̵",ћ:"h̵",Ħ:"H̵","Ӊ":"H̦",Ӈ:"H̦",н:"ʜ","ꮋ":"ʜ",ң:"ʜ̩","ӊ":"ʜ̦",ӈ:"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ",Ꭸ:"Ⱶ",Ꮀ:"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i",ｉ:"i","ⅰ":"i",ℹ:"i","ⅈ":"i","𝐢":"i","𝑖":"i","𝒊":"i","𝒾":"i","𝓲":"i","𝔦":"i","𝕚":"i","𝖎":"i","𝗂":"i","𝗶":"i","𝘪":"i","𝙞":"i","𝚒":"i",ı:"i","𝚤":"i",ɪ:"i",ɩ:"i",ι:"i",ι:"i",ͺ:"i","𝛊":"i","𝜄":"i","𝜾":"i","𝝸":"i","𝞲":"i",і:"i","ꙇ":"i","ӏ":"i","ꭵ":"i",Ꭵ:"i","𑣃":"i","ⓛ":"Ⓘ","⍸":"i̲",ǐ:"ĭ",Ǐ:"Ĭ",ɨ:"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii",ĳ:"ij","ⅳ":"iv","ⅸ":"ix",ｊ:"j","ⅉ":"j","𝐣":"j","𝑗":"j","𝒋":"j","𝒿":"j","𝓳":"j","𝔧":"j","𝕛":"j","𝖏":"j","𝗃":"j","𝗷":"j","𝘫":"j","𝙟":"j","𝚓":"j",ϳ:"j",ј:"j",Ｊ:"J","𝐉":"J","𝐽":"J","𝑱":"J","𝒥":"J","𝓙":"J","𝔍":"J","𝕁":"J","𝕵":"J","𝖩":"J","𝗝":"J","𝘑":"J","𝙅":"J","𝙹":"J","Ʝ":"J","Ϳ":"J",Ј:"J",Ꭻ:"J",ᒍ:"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵",ᒙ:"J·","𝚥":"ȷ",յ:"ȷ","ꭻ":"ᴊ","𝐤":"k","𝑘":"k","𝒌":"k","𝓀":"k","𝓴":"k","𝔨":"k","𝕜":"k","𝖐":"k","𝗄":"k","𝗸":"k","𝘬":"k","𝙠":"k","𝚔":"k",K:"K",Ｋ:"K","𝐊":"K","𝐾":"K","𝑲":"K","𝒦":"K","𝓚":"K","𝔎":"K","𝕂":"K","𝕶":"K","𝖪":"K","𝗞":"K","𝘒":"K","𝙆":"K","𝙺":"K",Κ:"K","𝚱":"K","𝛫":"K","𝜥":"K","𝝟":"K","𝞙":"K","Ⲕ":"K",К:"K",Ꮶ:"K",ᛕ:"K","ꓗ":"K","𐔘":"K",ƙ:"k̔","Ⱪ":"K̩",Қ:"K̩","₭":"K̵","Ꝁ":"K̵",Ҟ:"K̵",Ƙ:"K'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","𐌠":"l","𞣇":"l","𝟏":"l","𝟙":"l","𝟣":"l","𝟭":"l","𝟷":"l","🯱":"l",I:Xh,Ｉ:"l","Ⅰ":"l",ℐ:"l",ℑ:"l","𝐈":"l","𝐼":"l","𝑰":"l","𝓘":"l","𝕀":"l","𝕴":"l","𝖨":"l","𝗜":"l","𝘐":"l","𝙄":"l","𝙸":"l",Ɩ:"l",ｌ:"l","ⅼ":"l",ℓ:"l","𝐥":"l","𝑙":"l","𝒍":"l","𝓁":"l","𝓵":"l","𝔩":"l","𝕝":"l","𝖑":"l","𝗅":"l","𝗹":"l","𝘭":"l","𝙡":"l","𝚕":"l",ǀ:"l",Ι:"l","𝚰":"l","𝛪":"l","𝜤":"l","𝝞":"l","𝞘":"l","Ⲓ":"l",І:"l",Ӏ:"l",ו:"l",ן:"l",ا:"l","𞸀":"l","𞺀":"l",ﺎ:"l",ﺍ:"l","ߊ":"l","ⵏ":"l",ᛁ:"l","ꓲ":"l","𖼨":"l","𐊊":"l","𐌉":"l","𝈪":"L","Ⅼ":"L",ℒ:"L","𝐋":"L","𝐿":"L","𝑳":"L","𝓛":"L","𝔏":"L","𝕃":"L","𝕷":"L","𝖫":"L","𝗟":"L","𝘓":"L","𝙇":"L","𝙻":"L","Ⳑ":"L",Ꮮ:"L",ᒪ:"L","ꓡ":"L","𖼖":"L","𑢣":"L","𑢲":"L","𐐛":"L","𐔦":"L",ﴼ:"l̋",ﴽ:"l̋",ł:"l̸",Ł:"L̸",ɭ:"l̨",Ɨ:"l̵",ƚ:"l̵",ɫ:"l̴",إ:"lٕ",ﺈ:"lٕ",ﺇ:"lٕ",ٳ:"lٕ",ŀ:"l·",Ŀ:"l·",ᒷ:"l·","🄂":"l,","⒈":"l.",ױ:"l'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点",ǉ:"lj",Ĳ:"lJ",ǈ:"Lj",Ǉ:"LJ","‖":"ll","∥":"ll","Ⅱ":"ll",ǁ:"ll",װ:"ll","𐆙":"l̵l̵","⒒":"ll.","Ⅲ":"lll","𐆘":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点",Ю:"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点",ʪ:"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX",ɮ:"lȝ",ʫ:"lz",أ:"lٴ",ﺄ:"lٴ",ﺃ:"lٴ",ٲ:"lٴ",ٵ:"lٴ",ﷳ:"lكبر",ﷲ:"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","𐑃":"ʟ",Ｍ:"M","Ⅿ":"M",ℳ:"M","𝐌":"M","𝑀":"M","𝑴":"M","𝓜":"M","𝔐":"M","𝕄":"M","𝕸":"M","𝖬":"M","𝗠":"M","𝘔":"M","𝙈":"M","𝙼":"M",Μ:"M","𝚳":"M","𝛭":"M","𝜧":"M","𝝡":"M","𝞛":"M","Ϻ":"M","Ⲙ":"M",М:"M",Ꮇ:"M",ᗰ:"M",ᛖ:"M","ꓟ":"M","𐊰":"M","𐌑":"M","Ӎ":"M̦","🝫":"MB","ⷨ":"ᷟ","𝐧":"n","𝑛":"n","𝒏":"n","𝓃":"n","𝓷":"n","𝔫":"n","𝕟":"n","𝖓":"n","𝗇":"n","𝗻":"n","𝘯":"n","𝙣":"n","𝚗":"n",ո:"n",ռ:"n",Ｎ:"N",ℕ:"N","𝐍":"N","𝑁":"N","𝑵":"N","𝒩":"N","𝓝":"N","𝔑":"N","𝕹":"N","𝖭":"N","𝗡":"N","𝘕":"N","𝙉":"N","𝙽":"N",Ν:"N","𝚴":"N","𝛮":"N","𝜨":"N","𝝢":"N","𝞜":"N","Ⲛ":"N","ꓠ":"N","𐔓":"N","𐆎":"N̊",ɳ:"n̨",ƞ:"n̩",η:"n̩","𝛈":"n̩","𝜂":"n̩","𝜼":"n̩","𝝶":"n̩","𝞰":"n̩",Ɲ:"N̦","ᵰ":"n̴",ǌ:"nj",ǋ:"Nj",Ǌ:"NJ","№":"No","ͷ":"ᴎ",и:"ᴎ","𐑍":"ᴎ",ņ:"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o",ｏ:"o",ℴ:"o","𝐨":"o","𝑜":"o","𝒐":"o","𝓸":"o","𝔬":"o","𝕠":"o","𝖔":"o","𝗈":"o","𝗼":"o","𝘰":"o","𝙤":"o","𝚘":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o",ο:"o","𝛐":"o","𝜊":"o","𝝄":"o","𝝾":"o","𝞸":"o",σ:"o","𝛔":"o","𝜎":"o","𝝈":"o","𝞂":"o","𝞼":"o","ⲟ":"o",о:"o","ჿ":"o",օ:"o",ס:"o",ه:"o","𞸤":"o","𞹤":"o","𞺄":"o",ﻫ:"o",ﻬ:"o",ﻪ:"o",ﻩ:"o",ھ:"o",ﮬ:"o",ﮭ:"o",ﮫ:"o",ﮪ:"o",ہ:"o",ﮨ:"o",ﮩ:"o",ﮧ:"o",ﮦ:"o",ە:"o",ഠ:"o",ဝ:"o","𐓪":"o","𑣈":"o","𑣗":"o","𐐬":"o","߀":"O","০":"O","୦":"O","〇":"O","𑓐":"O","𑣠":"O","𝟎":"O","𝟘":"O","𝟢":"O","𝟬":"O","𝟶":"O","🯰":"O",Ｏ:"O","𝐎":"O","𝑂":"O","𝑶":"O","𝒪":"O","𝓞":"O","𝔒":"O","𝕆":"O","𝕺":"O","𝖮":"O","𝗢":"O","𝘖":"O","𝙊":"O","𝙾":"O",Ο:"O","𝚶":"O","𝛰":"O","𝜪":"O","𝝤":"O","𝞞":"O","Ⲟ":"O",О:"O",Օ:"O","ⵔ":"O",ዐ:"O",ଠ:"O","𐓂":"O","ꓳ":"O","𑢵":"O","𐊒":"O","𐊫":"O","𐐄":"O","𐔖":"O","⁰":"º","ᵒ":"º",ǒ:"ŏ",Ǒ:"Ŏ","ۿ":"ô",Ő:"Ö",ø:"o̸","ꬾ":"o̸",Ø:"O̸","ⵁ":"O̸",Ǿ:"Ó̸",ɵ:"o̵","ꝋ":"o̵",ө:"o̵",ѳ:"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","𝈚":"O̵","🜔":"O̵",Ɵ:"O̵","Ꝋ":"O̵",θ:"O̵",ϑ:"O̵","𝛉":"O̵","𝛝":"O̵","𝜃":"O̵","𝜗":"O̵","𝜽":"O̵","𝝑":"O̵","𝝷":"O̵","𝞋":"O̵","𝞱":"O̵","𝟅":"O̵",Θ:"O̵","ϴ":"O̵","𝚯":"O̵","𝚹":"O̵","𝛩":"O̵","𝛳":"O̵","𝜣":"O̵","𝜭":"O̵","𝝝":"O̵","𝝧":"O̵","𝞗":"O̵","𝞡":"O̵",Ө:"O̵",Ѳ:"O̵","ⴱ":"O̵",Ꮎ:"O̵",Ꮻ:"O̵","ꭴ":"ơ",ﳙ:"oٰ","🄁":"O,","🄀":"O.",ơ:"o'",Ơ:"O'",Ꭴ:"O'","%":"º/₀","٪":"º/₀","⁒":"º/₀","‰":"º/₀₀","؉":"º/₀₀","‱":"º/₀₀₀","؊":"º/₀₀₀",œ:"oe",Œ:"OE",ɶ:"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO",ﳗ:"oج",ﱑ:"oج",ﳘ:"oم",ﱒ:"oم",ﶓ:"oمج",ﶔ:"oمم",ﱓ:"oى",ﱔ:"oى","ൟ":"oരo",တ:"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","𐑋":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","𐐣":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","𐐿":"ɷ","⍴":"p",ｐ:"p","𝐩":"p","𝑝":"p","𝒑":"p","𝓅":"p","𝓹":"p","𝔭":"p","𝕡":"p","𝖕":"p","𝗉":"p","𝗽":"p","𝘱":"p","𝙥":"p","𝚙":"p",ρ:"p",ϱ:"p","𝛒":"p","𝛠":"p","𝜌":"p","𝜚":"p","𝝆":"p","𝝔":"p","𝞀":"p","𝞎":"p","𝞺":"p","𝟈":"p","ⲣ":"p",р:"p",Ｐ:"P",ℙ:"P","𝐏":"P","𝑃":"P","𝑷":"P","𝒫":"P","𝓟":"P","𝔓":"P","𝕻":"P","𝖯":"P","𝗣":"P","𝘗":"P","𝙋":"P","𝙿":"P",Ρ:"P","𝚸":"P","𝛲":"P","𝜬":"P","𝝦":"P","𝞠":"P","Ⲣ":"P",Р:"P",Ꮲ:"P",ᑭ:"P","ꓑ":"P","𐊕":"P",ƥ:"p̔","ᵽ":"p̵",ᑷ:"p·",ᒆ:"P'","ᴩ":"ᴘ","ꮲ":"ᴘ",φ:"ɸ",ϕ:"ɸ","𝛗":"ɸ","𝛟":"ɸ","𝜑":"ɸ","𝜙":"ɸ","𝝋":"ɸ","𝝓":"ɸ","𝞅":"ɸ","𝞍":"ɸ","𝞿":"ɸ","𝟇":"ɸ","ⲫ":"ɸ",ф:"ɸ","𝐪":"q","𝑞":"q","𝒒":"q","𝓆":"q","𝓺":"q","𝔮":"q","𝕢":"q","𝖖":"q","𝗊":"q","𝗾":"q","𝘲":"q","𝙦":"q","𝚚":"q","ԛ":"q",գ:"q",զ:"q",ℚ:"Q","𝐐":"Q","𝑄":"Q","𝑸":"Q","𝒬":"Q","𝓠":"Q","𝔔":"Q","𝕼":"Q","𝖰":"Q","𝗤":"Q","𝘘":"Q","𝙌":"Q","𝚀":"Q","ⵕ":"Q",ʠ:"q̔","🜀":"QE","ᶐ":"ɋ","ᴋ":"ĸ",κ:"ĸ",ϰ:"ĸ","𝛋":"ĸ","𝛞":"ĸ","𝜅":"ĸ","𝜘":"ĸ","𝜿":"ĸ","𝝒":"ĸ","𝝹":"ĸ","𝞌":"ĸ","𝞳":"ĸ","𝟆":"ĸ","ⲕ":"ĸ",к:"ĸ","ꮶ":"ĸ",қ:"ĸ̩",ҟ:"ĸ̵","𝐫":"r","𝑟":"r","𝒓":"r","𝓇":"r","𝓻":"r","𝔯":"r","𝕣":"r","𝖗":"r","𝗋":"r","𝗿":"r","𝘳":"r","𝙧":"r","𝚛":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r",г:"r","ꮁ":"r","𝈖":"R",ℛ:"R",ℜ:"R",ℝ:"R","𝐑":"R","𝑅":"R","𝑹":"R","𝓡":"R","𝕽":"R","𝖱":"R","𝗥":"R","𝘙":"R","𝙍":"R","𝚁":"R",Ʀ:"R",Ꭱ:"R",Ꮢ:"R","𐒴":"R",ᖇ:"R","ꓣ":"R","𖼵":"R",ɽ:"r̨",ɼ:"r̩","ɍ":"r̵",ғ:"r̵","ᵲ":"r̴",ґ:"r'","𑣣":"rn",m:Qh,"ⅿ":"rn","𝐦":"rn","𝑚":"rn","𝒎":"rn","𝓂":"rn","𝓶":"rn","𝔪":"rn","𝕞":"rn","𝖒":"rn","𝗆":"rn","𝗺":"rn","𝘮":"rn","𝙢":"rn","𝚖":"rn","𑜀":"rn","₥":"rn̸",ɱ:"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ",я:"ᴙ","ᵳ":"ɾ̴","℩":"ɿ",ｓ:"s","𝐬":"s","𝑠":"s","𝒔":"s","𝓈":"s","𝓼":"s","𝔰":"s","𝕤":"s","𝖘":"s","𝗌":"s","𝘀":"s","𝘴":"s","𝙨":"s","𝚜":"s","ꜱ":"s",ƽ:"s",ѕ:"s","ꮪ":"s","𑣁":"s","𐑈":"s",Ｓ:"S","𝐒":"S","𝑆":"S","𝑺":"S","𝒮":"S","𝓢":"S","𝔖":"S","𝕊":"S","𝕾":"S","𝖲":"S","𝗦":"S","𝘚":"S","𝙎":"S","𝚂":"S",Ѕ:"S",Տ:"S",Ꮥ:"S",Ꮪ:"S","ꓢ":"S","𖼺":"S","𐊖":"S","𐐠":"S",ʂ:"s̨","ᵴ":"s̴","ꞵ":"ß",β:"ß",ϐ:"ß","𝛃":"ß","𝛽":"ß","𝜷":"ß","𝝱":"ß","𝞫":"ß",Ᏸ:"ß","🝜":"sss",ﬆ:"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ",Σ:"Ʃ","𝚺":"Ʃ","𝛴":"Ʃ","𝜮":"Ʃ","𝝨":"Ʃ","𝞢":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","𝐭":"t","𝑡":"t","𝒕":"t","𝓉":"t","𝓽":"t","𝔱":"t","𝕥":"t","𝖙":"t","𝗍":"t","𝘁":"t","𝘵":"t","𝙩":"t","𝚝":"t","⊤":"T","⟙":"T","🝨":"T",Ｔ:"T","𝐓":"T","𝑇":"T","𝑻":"T","𝒯":"T","𝓣":"T","𝔗":"T","𝕋":"T","𝕿":"T","𝖳":"T","𝗧":"T","𝘛":"T","𝙏":"T","𝚃":"T",Τ:"T","𝚻":"T","𝛵":"T","𝜯":"T","𝝩":"T","𝞣":"T","Ⲧ":"T",Т:"T",Ꭲ:"T","ꓔ":"T","𖼊":"T","𑢼":"T","𐊗":"T","𐊱":"T","𐌕":"T",ƭ:"t̔","⍡":"T̈","Ⱦ":"T̸",Ț:"Ţ",Ʈ:"T̨",Ҭ:"T̩","₮":"T⃫",ŧ:"t̵",Ŧ:"T̵","ᵵ":"t̴",Ⴀ:"Ꞇ","Ꜩ":"T3",ʨ:"tɕ","℡":"TEL","ꝷ":"tf",ʦ:"ts",ʧ:"tʃ","ꜩ":"tȝ",τ:"ᴛ","𝛕":"ᴛ","𝜏":"ᴛ","𝝉":"ᴛ","𝞃":"ᴛ","𝞽":"ᴛ",т:"ᴛ","ꭲ":"ᴛ",ҭ:"ᴛ̩",ţ:"ƫ",ț:"ƫ",Ꮏ:"ƫ","𝐮":"u","𝑢":"u","𝒖":"u","𝓊":"u","𝓾":"u","𝔲":"u","𝕦":"u","𝖚":"u","𝗎":"u","𝘂":"u","𝘶":"u","𝙪":"u","𝚞":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u",ʋ:"u",υ:"u","𝛖":"u","𝜐":"u","𝝊":"u","𝞄":"u","𝞾":"u",ս:"u","𐓶":"u","𑣘":"u","∪":"U","⋃":"U","𝐔":"U","𝑈":"U","𝑼":"U","𝒰":"U","𝓤":"U","𝔘":"U","𝕌":"U","𝖀":"U","𝖴":"U","𝗨":"U","𝘜":"U","𝙐":"U","𝚄":"U",Ս:"U",ሀ:"U","𐓎":"U",ᑌ:"U","ꓴ":"U","𖽂":"U","𑢸":"U",ǔ:"ŭ",Ǔ:"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵",Ꮜ:"U̵",ᑘ:"U·",ᑧ:"U'","ᵫ":"ue","ꭣ":"uo",ṃ:"ꭑ",պ:"ɰ",ሣ:"ɰ","℧":"Ʊ",ᘮ:"Ʊ",ᘴ:"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v",ｖ:"v","ⅴ":"v","𝐯":"v","𝑣":"v","𝒗":"v","𝓋":"v","𝓿":"v","𝔳":"v","𝕧":"v","𝖛":"v","𝗏":"v","𝘃":"v","𝘷":"v","𝙫":"v","𝚟":"v","ᴠ":"v",ν:"v","𝛎":"v","𝜈":"v","𝝂":"v","𝝼":"v","𝞶":"v",ѵ:"v",ט:"v","𑜆":"v","ꮩ":"v","𑣀":"v","𝈍":"V","٧":"V","۷":"V","Ⅴ":"V","𝐕":"V","𝑉":"V","𝑽":"V","𝒱":"V","𝓥":"V","𝔙":"V","𝕍":"V","𝖁":"V","𝖵":"V","𝗩":"V","𝘝":"V","𝙑":"V","𝚅":"V",Ѵ:"V","ⴸ":"V",Ꮩ:"V",ᐯ:"V","ꛟ":"V","ꓦ":"V","𖼈":"V","𑢠":"V","𐔝":"V","𐆗":"V̵",ᐻ:"V·","🝬":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","🜈":"Vᷤ","ᴧ":"ʌ","𐓘":"ʌ","٨":"Ʌ","۸":"Ʌ",Λ:"Ʌ","𝚲":"Ʌ","𝛬":"Ʌ","𝜦":"Ʌ","𝝠":"Ʌ","𝞚":"Ʌ",Л:"Ʌ","ⴷ":"Ʌ","𐒰":"Ʌ",ᐱ:"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","𖼽":"Ʌ","𐊍":"Ʌ","Ӆ":"Ʌ̦",ᐽ:"Ʌ·",ɯ:"w","𝐰":"w","𝑤":"w","𝒘":"w","𝓌":"w","𝔀":"w","𝔴":"w","𝕨":"w","𝖜":"w","𝗐":"w","𝘄":"w","𝘸":"w","𝙬":"w","𝚠":"w","ᴡ":"w",ѡ:"w","ԝ":"w",ա:"w","𑜊":"w","𑜎":"w","𑜏":"w","ꮃ":"w","𑣯":"W","𑣦":"W","𝐖":"W","𝑊":"W","𝑾":"W","𝒲":"W","𝓦":"W","𝔚":"W","𝕎":"W","𝖂":"W","𝖶":"W","𝗪":"W","𝘞":"W","𝙒":"W","𝚆":"W","Ԝ":"W",Ꮃ:"W",Ꮤ:"W","ꓪ":"W",ѽ:"w҆҇","𑓅":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ",м:"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","×":"x","⤫":"x","⤬":"x","⨯":"x",ｘ:"x","ⅹ":"x","𝐱":"x","𝑥":"x","𝒙":"x","𝓍":"x","𝔁":"x","𝔵":"x","𝕩":"x","𝖝":"x","𝗑":"x","𝘅":"x","𝘹":"x","𝙭":"x","𝚡":"x",х:"x",ᕁ:"x",ᕽ:"x","ⷯ":"ͯ","᙭":"X","╳":"X","𐌢":"X","𑣬":"X",Ｘ:"X","Ⅹ":"X","𝐗":"X","𝑋":"X","𝑿":"X","𝒳":"X","𝓧":"X","𝔛":"X","𝕏":"X","𝖃":"X","𝖷":"X","𝗫":"X","𝘟":"X","𝙓":"X","𝚇":"X","Ꭓ":"X",Χ:"X","𝚾":"X","𝛸":"X","𝜲":"X","𝝬":"X","𝞦":"X","Ⲭ":"X",Х:"X","ⵝ":"X",ᚷ:"X","ꓫ":"X","𐊐":"X","𐊴":"X","𐌗":"X","𐔧":"X","⨰":"ẋ",Ҳ:"X̩","𐆖":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll",ɣ:"y","ᶌ":"y",ｙ:"y","𝐲":"y","𝑦":"y","𝒚":"y","𝓎":"y","𝔂":"y","𝔶":"y","𝕪":"y","𝖞":"y","𝗒":"y","𝘆":"y","𝘺":"y","𝙮":"y","𝚢":"y",ʏ:"y","ỿ":"y","ꭚ":"y",γ:"y","ℽ":"y","𝛄":"y","𝛾":"y","𝜸":"y","𝝲":"y","𝞬":"y",у:"y",ү:"y",ყ:"y","𑣜":"y",Ｙ:"Y","𝐘":"Y","𝑌":"Y","𝒀":"Y","𝒴":"Y","𝓨":"Y","𝔜":"Y","𝕐":"Y","𝖄":"Y","𝖸":"Y","𝗬":"Y","𝘠":"Y","𝙔":"Y","𝚈":"Y",Υ:"Y",ϒ:"Y","𝚼":"Y","𝛶":"Y","𝜰":"Y","𝝪":"Y","𝞤":"Y","Ⲩ":"Y",У:"Y",Ү:"Y",Ꭹ:"Y",Ꮍ:"Y","ꓬ":"Y","𖽃":"Y","𑢤":"Y","𐊲":"Y",ƴ:"y̔","ɏ":"y̵",ұ:"y̵","¥":"Y̵","Ɏ":"Y̵",Ұ:"Y̵",ʒ:"ȝ","ꝫ":"ȝ","ⳍ":"ȝ",ӡ:"ȝ",ჳ:"ȝ","𝐳":"z","𝑧":"z","𝒛":"z","𝓏":"z","𝔃":"z","𝔷":"z","𝕫":"z","𝖟":"z","𝗓":"z","𝘇":"z","𝘻":"z","𝙯":"z","𝚣":"z","ᴢ":"z","ꮓ":"z","𑣄":"z","𐋵":"Z","𑣥":"Z",Ｚ:"Z",ℤ:"Z",ℨ:"Z","𝐙":"Z","𝑍":"Z","𝒁":"Z","𝒵":"Z","𝓩":"Z","𝖅":"Z","𝖹":"Z","𝗭":"Z","𝘡":"Z","𝙕":"Z","𝚉":"Z",Ζ:"Z","𝚭":"Z","𝛧":"Z","𝜡":"Z","𝝛":"Z","𝞕":"Z",Ꮓ:"Z","ꓜ":"Z","𑢩":"Z",ʐ:"z̨",ƶ:"z̵",Ƶ:"Z̵",ȥ:"z̦",Ȥ:"Z̦","ᵶ":"z̴",ƿ:"þ","ϸ":"þ","Ϸ":"Þ","𐓄":"Þ","⁹":"ꝰ","ᴤ":"ƨ",ϩ:"ƨ","ꙅ":"ƨ",ь:"ƅ","ꮟ":"ƅ",ы:"ƅi","ꭾ":"ɂ",ˤ:"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","𐓃":"ʘ","ℾ":"Γ","𝚪":"Γ","𝛤":"Γ","𝜞":"Γ","𝝘":"Γ","𝞒":"Γ","Ⲅ":"Γ",Г:"Γ",Ꮁ:"Γ",ᒥ:"Γ","𖼇":"Γ",Ғ:"Γ̵",ᒯ:"Γ·",Ґ:"Γ'","∆":"Δ","△":"Δ","🜂":"Δ","𝚫":"Δ","𝛥":"Δ","𝜟":"Δ","𝝙":"Δ","𝞓":"Δ","Ⲇ":"Δ","ⵠ":"Δ",ᐃ:"Δ","𖼚":"Δ","𐊅":"Δ","𐊣":"Δ","⍙":"Δ̲",ᐏ:"Δ·",ᐬ:"Δᐠ","𝟋":"ϝ","𝛇":"ζ","𝜁":"ζ","𝜻":"ζ","𝝵":"ζ","𝞯":"ζ","ⳤ":"ϗ","𝛌":"λ","𝜆":"λ","𝝀":"λ","𝝺":"λ","𝞴":"λ","Ⲗ":"λ","𐓛":"λ",µ:"μ","𝛍":"μ","𝜇":"μ","𝝁":"μ","𝝻":"μ","𝞵":"μ","𝛏":"ξ","𝜉":"ξ","𝝃":"ξ","𝝽":"ξ","𝞷":"ξ","𝚵":"Ξ","𝛯":"Ξ","𝜩":"Ξ","𝝣":"Ξ","𝞝":"Ξ",ϖ:"π","ℼ":"π","𝛑":"π","𝛡":"π","𝜋":"π","𝜛":"π","𝝅":"π","𝝕":"π","𝝿":"π","𝞏":"π","𝞹":"π","𝟉":"π","ᴨ":"π",п:"π","∏":"Π","ℿ":"Π","𝚷":"Π","𝛱":"Π","𝜫":"Π","𝝥":"Π","𝞟":"Π","Ⲡ":"Π",П:"Π","ꛛ":"Π","𐊭":"Ϙ","𐌒":"Ϙ",ϛ:"ς","𝛓":"ς","𝜍":"ς","𝝇":"ς","𝞁":"ς","𝞻":"ς","𝚽":"Φ","𝛷":"Φ","𝜱":"Φ","𝝫":"Φ","𝞥":"Φ","Ⲫ":"Φ",Ф:"Φ",Փ:"Φ",ቀ:"Φ","ᛰ":"Φ","𐊳":"Φ","ꭓ":"χ","ꭕ":"χ","𝛘":"χ","𝜒":"χ","𝝌":"χ","𝞆":"χ","𝟀":"χ","ⲭ":"χ","𝛙":"ψ","𝜓":"ψ","𝝍":"ψ","𝞇":"ψ","𝟁":"ψ",ѱ:"ψ","𐓹":"ψ","𝚿":"Ψ","𝛹":"Ψ","𝜳":"Ψ","𝝭":"Ψ","𝞧":"Ψ","Ⲯ":"Ψ",Ѱ:"Ψ","𐓑":"Ψ",ᛘ:"Ψ","𐊵":"Ψ","⍵":"ω","ꞷ":"ω","𝛚":"ω","𝜔":"ω","𝝎":"ω","𝞈":"ω","𝟂":"ω","ⲱ":"ω","ꙍ":"ω",Ω:"Ω","𝛀":"Ω","𝛺":"Ω","𝜴":"Ω","𝝮":"Ω","𝞨":"Ω",ᘯ:"Ω",ᘵ:"Ω","𐊶":"Ω","⍹":"ω̲",ώ:"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ",җ:"ж̩",Җ:"Ж̩","𝈋":"И","Ͷ":"И","ꚡ":"И","𐐥":"И",Й:"Ѝ","Ҋ":"Ѝ̦",ѝ:"й","ҋ":"й̦","𐒼":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","𐓫":"ꙩ","ᷮ":"ⷬ","𐓍":"Ћ","𝈂":"Ӿ","𝈢":"Ѡ",Ꮗ:"Ѡ",ᗯ:"Ѡ",Ѽ:"Ѡ҆҇","ᣭ":"Ѡ·","Ꞷ":"Ꙍ",ӌ:"ҷ",Ӌ:"Ҷ",Ҿ:"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","🜁":"Ꙙ","𖼜":"Ꙙ","ꦒ":"ⰿ",և:"եւ",ኔ:"ձ",ﬔ:"մե",ﬕ:"մի",ﬗ:"մխ",ﬓ:"մն","∩":"Ո","⋂":"Ո","𝉅":"Ո",በ:"Ո",ᑎ:"Ո","ꓵ":"Ո",ᑚ:"Ո·",ᑨ:"Ո'",ﬖ:"վն","₽":"Ք","˓":"ՙ",ʿ:"ՙ",ℵ:"א",ﬡ:"א",אָ:"אַ",אּ:"אַ",ﭏ:"אל",ℶ:"ב",ℷ:"ג",ℸ:"ד",ﬢ:"ד",ﬣ:"ה",יּ:"יִ",ﬤ:"כ",ﬥ:"ל",ﬦ:"ם",ﬠ:"ע",ﬧ:"ר",שׂ:"שׁ",שּ:"שׁ",שּׂ:"שּׁ",ﬨ:"ת",ﺀ:"ء","۽":"ء͈",ﺂ:"آ",ﺁ:"آ",ﭑ:"ٱ",ﭐ:"ٱ","𞸁":"ب","𞸡":"ب","𞹡":"ب","𞺁":"ب","𞺡":"ب",ﺑ:"ب",ﺒ:"ب",ﺐ:"ب",ﺏ:"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ",ﲠ:"بo",ﳢ:"بo",ﲜ:"بج",ﰅ:"بج",ﲝ:"بح",ﰆ:"بح",ﷂ:"بحى",ﲞ:"بخ",ﰇ:"بخ",ﳒ:"بخ",ﱋ:"بخ",ﶞ:"بخى",ﱪ:"بر",ﱫ:"بز",ﲟ:"بم",ﳡ:"بم",ﱬ:"بم",ﰈ:"بم",ﱭ:"بن",ﱮ:"بى",ﰉ:"بى",ﱯ:"بى",ﰊ:"بى",ﭔ:"ٻ",ﭕ:"ٻ",ﭓ:"ٻ",ﭒ:"ٻ",ې:"ٻ",ﯦ:"ٻ",ﯧ:"ٻ",ﯥ:"ٻ",ﯤ:"ٻ",ﭜ:"ڀ",ﭝ:"ڀ",ﭛ:"ڀ",ﭚ:"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة",ö:"ة",ﺔ:"ة",ﺓ:"ة",ۃ:"ة","𞸕":"ت","𞸵":"ت","𞹵":"ت","𞺕":"ت","𞺵":"ت",ﺗ:"ت",ﺘ:"ت",ﺖ:"ت",ﺕ:"ت",ﲥ:"تo",ﳤ:"تo",ﲡ:"تج",ﰋ:"تج",ﵐ:"تجم",ﶠ:"تجى",ﶟ:"تجى",ﲢ:"تح",ﰌ:"تح",ﵒ:"تحج",ﵑ:"تحج",ﵓ:"تحم",ﲣ:"تخ",ﰍ:"تخ",ﵔ:"تخم",ﶢ:"تخى",ﶡ:"تخى",ﱰ:"تر",ﱱ:"تز",ﲤ:"تم",ﳣ:"تم",ﱲ:"تم",ﰎ:"تم",ﵕ:"تمج",ﵖ:"تمح",ﵗ:"تمخ",ﶤ:"تمى",ﶣ:"تمى",ﱳ:"تن",ﱴ:"تى",ﰏ:"تى",ﱵ:"تى",ﰐ:"تى",ﭠ:"ٺ",ﭡ:"ٺ",ﭟ:"ٺ",ﭞ:"ٺ",ﭤ:"ٿ",ﭥ:"ٿ",ﭣ:"ٿ",ﭢ:"ٿ","𞸂":"ج","𞸢":"ج","𞹂":"ج","𞹢":"ج","𞺂":"ج","𞺢":"ج",ﺟ:"ج",ﺠ:"ج",ﺞ:"ج",ﺝ:"ج",ﲧ:"جح",ﰕ:"جح",ﶦ:"جحى",ﶾ:"جحى",ﷻ:"جل جلlلo",ﲨ:"جم",ﰖ:"جم",ﵙ:"جمح",ﵘ:"جمح",ﶧ:"جمى",ﶥ:"جمى",ﴝ:"جى",ﴁ:"جى",ﴞ:"جى",ﴂ:"جى",ﭸ:"ڃ",ﭹ:"ڃ",ﭷ:"ڃ",ﭶ:"ڃ",ﭴ:"ڄ",ﭵ:"ڄ",ﭳ:"ڄ",ﭲ:"ڄ",ﭼ:"چ",ﭽ:"چ",ﭻ:"چ",ﭺ:"چ",ﮀ:"ڇ",ﮁ:"ڇ",ﭿ:"ڇ",ﭾ:"ڇ","𞸇":"ح","𞸧":"ح","𞹇":"ح","𞹧":"ح","𞺇":"ح","𞺧":"ح",ﺣ:"ح",ﺤ:"ح",ﺢ:"ح",ﺡ:"ح",څ:"حۛ",ځ:"حٔ","ݲ":"حٔ",ﲩ:"حج",ﰗ:"حج",ﶿ:"حجى",ﲪ:"حم",ﰘ:"حم",ﵛ:"حمى",ﵚ:"حمى",ﴛ:"حى",ﳿ:"حى",ﴜ:"حى",ﴀ:"حى","𞸗":"خ","𞸷":"خ","𞹗":"خ","𞹷":"خ","𞺗":"خ","𞺷":"خ",ﺧ:"خ",ﺨ:"خ",ﺦ:"خ",ﺥ:"خ",ﲫ:"خج",ﰙ:"خج",ﰚ:"خح",ﲬ:"خم",ﰛ:"خم",ﴟ:"خى",ﴃ:"خى",ﴠ:"خى",ﴄ:"خى","𐋡":"د","𞸃":"د","𞺃":"د","𞺣":"د",ﺪ:"د",ﺩ:"د",ڈ:"دؕ",ﮉ:"دؕ",ﮈ:"دؕ",ڎ:"دۛ",ﮇ:"دۛ",ﮆ:"دۛ","ۮ":"د̂","ࢮ":"د̤̣","𞸘":"ذ","𞺘":"ذ","𞺸":"ذ",ﺬ:"ذ",ﺫ:"ذ",ﱛ:"ذٰ",ڋ:"ڊؕ",ﮅ:"ڌ",ﮄ:"ڌ",ﮃ:"ڍ",ﮂ:"ڍ","𞸓":"ر","𞺓":"ر","𞺳":"ر",ﺮ:"ر",ﺭ:"ر",ڑ:"رؕ",ﮍ:"رؕ",ﮌ:"رؕ",ژ:"رۛ",ﮋ:"رۛ",ﮊ:"رۛ",ڒ:"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ",ﱜ:"رٰ",ﷶ:"رسول","﷼":"رىlل","𞸆":"ز","𞺆":"ز","𞺦":"ز",ﺰ:"ز",ﺯ:"ز","ࢲ":"ز̂","ݱ":"ڗؕ","𞸎":"س","𞸮":"س","𞹎":"س","𞹮":"س","𞺎":"س","𞺮":"س",ﺳ:"س",ﺴ:"س",ﺲ:"س",ﺱ:"س",ش:"سۛ","𞸔":"سۛ","𞸴":"سۛ","𞹔":"سۛ","𞹴":"سۛ","𞺔":"سۛ","𞺴":"سۛ",ﺷ:"سۛ",ﺸ:"سۛ",ﺶ:"سۛ",ﺵ:"سۛ","ݾ":"س̂",ﴱ:"سo",ﳨ:"سo",ﴲ:"سۛo",ﳪ:"سۛo",ﲭ:"سج",ﴴ:"سج",ﰜ:"سج",ﴭ:"سۛج",ﴷ:"سۛج",ﴥ:"سۛج",ﴉ:"سۛج",ﵝ:"سجح",ﵞ:"سجى",ﵩ:"سۛجى",ﲮ:"سح",ﴵ:"سح",ﰝ:"سح",ﴮ:"سۛح",ﴸ:"سۛح",ﴦ:"سۛح",ﴊ:"سۛح",ﵜ:"سحج",ﵨ:"سۛحم",ﵧ:"سۛحم",ﶪ:"سۛحى",ﲯ:"سخ",ﴶ:"سخ",ﰞ:"سخ",ﴯ:"سۛخ",ﴹ:"سۛخ",ﴧ:"سۛخ",ﴋ:"سۛخ",ﶨ:"سخى",ﷆ:"سخى",ﴪ:"سر",ﴎ:"سر",ﴩ:"سۛر",ﴍ:"سۛر",ﲰ:"سم",ﳧ:"سم",ﰟ:"سم",ﴰ:"سۛم",ﳩ:"سۛم",ﴨ:"سۛم",ﴌ:"سۛم",ﵡ:"سمج",ﵠ:"سمح",ﵟ:"سمح",ﵫ:"سۛمخ",ﵪ:"سۛمخ",ﵣ:"سمم",ﵢ:"سمم",ﵭ:"سۛمم",ﵬ:"سۛمم",ﴗ:"سى",ﳻ:"سى",ﴘ:"سى",ﳼ:"سى",ﴙ:"سۛى",ﳽ:"سۛى",ﴚ:"سۛى",ﳾ:"سۛى","𐋲":"ص","𞸑":"ص","𞸱":"ص","𞹑":"ص","𞹱":"ص","𞺑":"ص","𞺱":"ص",ﺻ:"ص",ﺼ:"ص",ﺺ:"ص",ﺹ:"ص",ڞ:"صۛ","ࢯ":"ص̤̣",ﲱ:"صح",ﰠ:"صح",ﵥ:"صحح",ﵤ:"صحح",ﶩ:"صحى",ﲲ:"صخ",ﴫ:"صر",ﴏ:"صر",ﷵ:"صلعم",ﷹ:"صلى",ﷰ:"صلى",ﷺ:"صلى lللo علىo وسلم",ﲳ:"صم",ﰡ:"صم",ﷅ:"صمم",ﵦ:"صمم",ﴡ:"صى",ﴅ:"صى",ﴢ:"صى",ﴆ:"صى","𞸙":"ض","𞸹":"ض","𞹙":"ض","𞹹":"ض","𞺙":"ض","𞺹":"ض",ﺿ:"ض",ﻀ:"ض",ﺾ:"ض",ﺽ:"ض",ﲴ:"ضج",ﰢ:"ضج",ﲵ:"ضح",ﰣ:"ضح",ﵮ:"ضحى",ﶫ:"ضحى",ﲶ:"ضخ",ﰤ:"ضخ",ﵰ:"ضخم",ﵯ:"ضخم",ﴬ:"ضر",ﴐ:"ضر",ﲷ:"ضم",ﰥ:"ضم",ﴣ:"ضى",ﴇ:"ضى",ﴤ:"ضى",ﴈ:"ضى","𐋨":"ط","𞸈":"ط","𞹨":"ط","𞺈":"ط","𞺨":"ط",ﻃ:"ط",ﻄ:"ط",ﻂ:"ط",ﻁ:"ط",ڟ:"طۛ",ﲸ:"طح",ﰦ:"طح",ﴳ:"طم",ﴺ:"طم",ﰧ:"طم",ﵲ:"طمح",ﵱ:"طمح",ﵳ:"طمم",ﵴ:"طمى",ﴑ:"طى",ﳵ:"طى",ﴒ:"طى",ﳶ:"طى","𞸚":"ظ","𞹺":"ظ","𞺚":"ظ","𞺺":"ظ",ﻇ:"ظ",ﻈ:"ظ",ﻆ:"ظ",ﻅ:"ظ",ﲹ:"ظم",ﴻ:"ظم",ﰨ:"ظم","؏":"ع","𞸏":"ع","𞸯":"ع","𞹏":"ع","𞹯":"ع","𞺏":"ع","𞺯":"ع",ﻋ:"ع",ﻌ:"ع",ﻊ:"ع",ﻉ:"ع",ﲺ:"عج",ﰩ:"عج",ﷄ:"عجم",ﵵ:"عجم",ﷷ:"علىo",ﲻ:"عم",ﰪ:"عم",ﵷ:"عمم",ﵶ:"عمم",ﵸ:"عمى",ﶶ:"عمى",ﴓ:"عى",ﳷ:"عى",ﴔ:"عى",ﳸ:"عى","𞸛":"غ","𞸻":"غ","𞹛":"غ","𞹻":"غ","𞺛":"غ","𞺻":"غ",ﻏ:"غ",ﻐ:"غ",ﻎ:"غ",ﻍ:"غ",ﲼ:"غج",ﰫ:"غج",ﲽ:"غم",ﰬ:"غم",ﵹ:"غمم",ﵻ:"غمى",ﵺ:"غمى",ﴕ:"غى",ﳹ:"غى",ﴖ:"غى",ﳺ:"غى","𞸐":"ف","𞸰":"ف","𞹰":"ف","𞺐":"ف","𞺰":"ف",ﻓ:"ف",ﻔ:"ف",ﻒ:"ف",ﻑ:"ف",ڧ:"ف",ﲾ:"فج",ﰭ:"فج",ﲿ:"فح",ﰮ:"فح",ﳀ:"فخ",ﰯ:"فخ",ﵽ:"فخم",ﵼ:"فخم",ﳁ:"فم",ﰰ:"فم",ﷁ:"فمى",ﱼ:"فى",ﰱ:"فى",ﱽ:"فى",ﰲ:"فى","𞸞":"ڡ","𞹾":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","𞸟":"ڡ","𞹟":"ڡ","ࢼ":"ڡ",ڤ:"ڡۛ",ﭬ:"ڡۛ",ﭭ:"ڡۛ",ﭫ:"ڡۛ",ﭪ:"ڡۛ",ڨ:"ڡۛ","ࢤ":"ڢۛ",ﭰ:"ڦ",ﭱ:"ڦ",ﭯ:"ڦ",ﭮ:"ڦ","𞸒":"ق","𞸲":"ق","𞹒":"ق","𞹲":"ق","𞺒":"ق","𞺲":"ق",ﻗ:"ق",ﻘ:"ق",ﻖ:"ق",ﻕ:"ق",ﳂ:"قح",ﰳ:"قح",ﷱ:"قلى",ﳃ:"قم",ﰴ:"قم",ﶴ:"قمح",ﵾ:"قمح",ﵿ:"قمم",ﶲ:"قمى",ﱾ:"قى",ﰵ:"قى",ﱿ:"قى",ﰶ:"قى","𞸊":"ك","𞸪":"ك","𞹪":"ك",ﻛ:"ك",ﻜ:"ك",ﻚ:"ك",ﻙ:"ك",ک:"ك",ﮐ:"ك",ﮑ:"ك",ﮏ:"ك",ﮎ:"ك",ڪ:"ك",ڭ:"كۛ",ﯕ:"كۛ",ﯖ:"كۛ",ﯔ:"كۛ",ﯓ:"كۛ","ݣ":"كۛ",ﲀ:"كl",ﰷ:"كl",ﳄ:"كج",ﰸ:"كج",ﳅ:"كح",ﰹ:"كح",ﳆ:"كخ",ﰺ:"كخ",ﳇ:"كل",ﳫ:"كل",ﲁ:"كل",ﰻ:"كل",ﳈ:"كم",ﳬ:"كم",ﲂ:"كم",ﰼ:"كم",ﷃ:"كمم",ﶻ:"كمم",ﶷ:"كمى",ﲃ:"كى",ﰽ:"كى",ﲄ:"كى",ﰾ:"كى","ݢ":"ڬ",ﮔ:"گ",ﮕ:"گ",ﮓ:"گ",ﮒ:"گ","ࢰ":"گ",ڴ:"گۛ",ﮜ:"ڱ",ﮝ:"ڱ",ﮛ:"ڱ",ﮚ:"ڱ",ﮘ:"ڳ",ﮙ:"ڳ",ﮗ:"ڳ",ﮖ:"ڳ","𞸋":"ل","𞸫":"ل","𞹋":"ل","𞺋":"ل","𞺫":"ل",ﻟ:"ل",ﻠ:"ل",ﻞ:"ل",ﻝ:"ل",ڷ:"لۛ",ڵ:"ل̆",ﻼ:"لl",ﻻ:"لl",ﻺ:"لlٕ",ﻹ:"لlٕ",ﻸ:"لlٴ",ﻷ:"لlٴ",ﳍ:"لo",ﻶ:"لآ",ﻵ:"لآ",ﳉ:"لج",ﰿ:"لج",ﶃ:"لجج",ﶄ:"لجج",ﶺ:"لجم",ﶼ:"لجم",ﶬ:"لجى",ﳊ:"لح",ﱀ:"لح",ﶵ:"لحم",ﶀ:"لحم",ﶂ:"لحى",ﶁ:"لحى",ﳋ:"لخ",ﱁ:"لخ",ﶆ:"لخم",ﶅ:"لخم",ﳌ:"لم",ﳭ:"لم",ﲅ:"لم",ﱂ:"لم",ﶈ:"لمح",ﶇ:"لمح",ﶭ:"لمى",ﲆ:"لى",ﱃ:"لى",ﲇ:"لى",ﱄ:"لى","𞸌":"م","𞸬":"م","𞹬":"م","𞺌":"م","𞺬":"م",ﻣ:"م",ﻤ:"م",ﻢ:"م",ﻡ:"م","ࢧ":"مۛ","۾":"م͈",ﲈ:"مl",ﳎ:"مج",ﱅ:"مج",ﶌ:"مجح",ﶒ:"مجخ",ﶍ:"مجم",ﷀ:"مجى",ﳏ:"مح",ﱆ:"مح",ﶉ:"محج",ﶊ:"محم",ﷴ:"محمد",ﶋ:"محى",ﳐ:"مخ",ﱇ:"مخ",ﶎ:"مخج",ﶏ:"مخم",ﶹ:"مخى",ﳑ:"مم",ﲉ:"مم",ﱈ:"مم",ﶱ:"ممى",ﱉ:"مى",ﱊ:"مى","𞸍":"ن","𞸭":"ن","𞹍":"ن","𞹭":"ن","𞺍":"ن","𞺭":"ن",ﻧ:"ن",ﻨ:"ن",ﻦ:"ن",ﻥ:"ن","ݨ":"نؕ","ݩ":"ن̆",ﳖ:"نo",ﳯ:"نo",ﶸ:"نجح",ﶽ:"نجح",ﶘ:"نجم",ﶗ:"نجم",ﶙ:"نجى",ﷇ:"نجى",ﳓ:"نح",ﱌ:"نح",ﶕ:"نحم",ﶖ:"نحى",ﶳ:"نحى",ﳔ:"نخ",ﱍ:"نخ",ﲊ:"نر",ﲋ:"نز",ﳕ:"نم",ﳮ:"نم",ﲌ:"نم",ﱎ:"نم",ﶛ:"نمى",ﶚ:"نمى",ﲍ:"نن",ﲎ:"نى",ﱏ:"نى",ﲏ:"نى",ﱐ:"نى",ۂ:"ۀ",ﮥ:"ۀ",ﮤ:"ۀ","𐋤":"و","𞸅":"و","𞺅":"و","𞺥":"و",ﻮ:"و",ﻭ:"و","ࢱ":"و",ۋ:"وۛ",ﯟ:"وۛ",ﯞ:"وۛ",ۇ:"و̓",ﯘ:"و̓",ﯗ:"و̓",ۆ:"و̆",ﯚ:"و̆",ﯙ:"و̆",ۉ:"و̂",ﯣ:"و̂",ﯢ:"و̂",ۈ:"وٰ",ﯜ:"وٰ",ﯛ:"وٰ",ؤ:"وٴ",ﺆ:"وٴ",ﺅ:"وٴ",ٶ:"وٴ",ٷ:"و̓ٴ",ﯝ:"و̓ٴ",ﷸ:"وسلم",ﯡ:"ۅ",ﯠ:"ۅ","ٮ":"ى","𞸜":"ى","𞹼":"ى",ں:"ى","𞸝":"ى","𞹝":"ى",ﮟ:"ى",ﮞ:"ى","ࢽ":"ى",ﯨ:"ى",ﯩ:"ى",ﻰ:"ى",ﻯ:"ى",ي:"ى","𞸉":"ى","𞸩":"ى","𞹉":"ى","𞹩":"ى","𞺉":"ى","𞺩":"ى",ﻳ:"ى",ﻴ:"ى",ﻲ:"ى",ﻱ:"ى",ی:"ى",ﯾ:"ى",ﯿ:"ى",ﯽ:"ى",ﯼ:"ى",ے:"ى",ﮯ:"ى",ﮮ:"ى",ٹ:"ىؕ",ﭨ:"ىؕ",ﭩ:"ىؕ",ﭧ:"ىؕ",ﭦ:"ىؕ",ڻ:"ىؕ",ﮢ:"ىؕ",ﮣ:"ىؕ",ﮡ:"ىؕ",ﮠ:"ىؕ",پ:"ىۛ",ﭘ:"ىۛ",ﭙ:"ىۛ",ﭗ:"ىۛ",ﭖ:"ىۛ",ث:"ىۛ","𞸖":"ىۛ","𞸶":"ىۛ","𞹶":"ىۛ","𞺖":"ىۛ","𞺶":"ىۛ",ﺛ:"ىۛ",ﺜ:"ىۛ",ﺚ:"ىۛ",ﺙ:"ىۛ",ڽ:"ىۛ",ۑ:"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆",ێ:"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ",ﲐ:"ىٰ",ﱝ:"ىٰ",ﳞ:"ىo",ﳱ:"ىo",ﳦ:"ىۛo",ئ:"ىٴ",ﺋ:"ىٴ",ﺌ:"ىٴ",ﺊ:"ىٴ",ﺉ:"ىٴ",ٸ:"ىٴ",ﯫ:"ىٴl",ﯪ:"ىٴl",ﲛ:"ىٴo",ﳠ:"ىٴo",ﯭ:"ىٴo",ﯬ:"ىٴo",ﯸ:"ىٴٻ",ﯷ:"ىٴٻ",ﯶ:"ىٴٻ",ﲗ:"ىٴج",ﰀ:"ىٴج",ﲘ:"ىٴح",ﰁ:"ىٴح",ﲙ:"ىٴخ",ﱤ:"ىٴر",ﱥ:"ىٴز",ﲚ:"ىٴم",ﳟ:"ىٴم",ﱦ:"ىٴم",ﰂ:"ىٴم",ﱧ:"ىٴن",ﯯ:"ىٴو",ﯮ:"ىٴو",ﯱ:"ىٴو̓",ﯰ:"ىٴو̓",ﯳ:"ىٴو̆",ﯲ:"ىٴو̆",ﯵ:"ىٴوٰ",ﯴ:"ىٴوٰ",ﯻ:"ىٴى",ﯺ:"ىٴى",ﱨ:"ىٴى",ﯹ:"ىٴى",ﰃ:"ىٴى",ﱩ:"ىٴى",ﰄ:"ىٴى",ﳚ:"ىج",ﱕ:"ىج",ﰑ:"ىۛج",ﶯ:"ىجى",ﳛ:"ىح",ﱖ:"ىح",ﶮ:"ىحى",ﳜ:"ىخ",ﱗ:"ىخ",ﲑ:"ىر",ﱶ:"ىۛر",ﲒ:"ىز",ﱷ:"ىۛز",ﳝ:"ىم",ﳰ:"ىم",ﲓ:"ىم",ﱘ:"ىم",ﲦ:"ىۛم",ﳥ:"ىۛم",ﱸ:"ىۛم",ﰒ:"ىۛم",ﶝ:"ىمم",ﶜ:"ىمم",ﶰ:"ىمى",ﲔ:"ىن",ﱹ:"ىۛن",ﲕ:"ىى",ﱙ:"ىى",ﲖ:"ىى",ﱚ:"ىى",ﱺ:"ىۛى",ﰓ:"ىۛى",ﱻ:"ىۛى",ﰔ:"ىۛى",ﮱ:"ۓ",ﮰ:"ۓ","𐊸":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ",Մ:"ሆ",Ռ:"ቡ",Ի:"ኮ",Պ:"ጣ",आ:"अा",ऒ:"अाॆ",ओ:"अाे",औ:"अाै","ऄ":"अॆ",ऑ:"अॉ",ऍ:"एॅ",ऎ:"एॆ",ऐ:"एे",ई:"र्इ",ઽ:"ऽ","𑇜":"ꣻ","𑇋":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्",আ:"অা",ৠ:"ঋৃ",ৡ:"ঋৃ","𑒒":"ঘ","𑒔":"চ","𑒖":"জ","𑒘":"ঞ","𑒙":"ট","𑒛":"ড","𑒪":"ণ","𑒞":"ত","𑒟":"থ","𑒠":"দ","𑒡":"ধ","𑒢":"ন","𑒣":"প","𑒩":"ব","𑒧":"ম","𑒨":"য","𑒫":"র","𑒝":"ল","𑒭":"ষ","𑒮":"স","𑓄":"ঽ","𑒰":"া","𑒱":"ি","𑒹":"ে","𑒼":"ো","𑒾":"ৌ","𑓂":"্","𑒽":"ৗ",ਉ:"ੳੁ",ਊ:"ੳੂ",ਆ:"ਅਾ",ਐ:"ਅੈ",ਔ:"ਅੌ",ਇ:"ੲਿ",ਈ:"ੲੀ",ਏ:"ੲੇ",આ:"અા",ઑ:"અાૅ",ઓ:"અાે",ઔ:"અાૈ",ઍ:"અૅ",એ:"અે",ઐ:"અૈ",ଆ:"ଅା","௮":"அ",ர:"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ",ഉ:"உ",ஊ:"உள",ഊ:"உൗ","௭":"எ","௷":"எவ",ஜ:"ஐ",ജ:"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி",ണ:"ண","௺":"நீ","௴":"மீ","௰":"ய",ഴ:"ழ","ௗ":"ள","ை":"ன",ശ:"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ",ಅ:"అ",ಆ:"ఆ",ಇ:"ఇ",ౠ:"ఋా",ౡ:"ఌా",ಒ:"ఒ",ఔ:"ఒౌ",ಔ:"ఒౌ",ఓ:"ఒౕ",ಓ:"ఒౕ",ಜ:"జ",ಞ:"ఞ",ఢ:"డ̣",ಣ:"ణ",థ:"ధּ",భ:"బ̣",ಯ:"య",ఠ:"రּ",ಱ:"ఱ",ಲ:"ల",ష:"వ̣",హ:"వా",మ:"వు","ూ":"ుా","ౄ":"ృా",ೡ:"ಌಾ",ഈ:"ഇൗ",ഐ:"എെ",ഓ:"ഒാ",ഔ:"ഒൗ",ൡ:"ഞ","൫":"ദ്ര","൹":"നു",ഌ:"നു",ങ:"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ",റ:"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","𑐓":"𑐴𑑂𑐒","𑐙":"𑐴𑑂𑐘","𑐤":"𑐴𑑂𑐣","𑐪":"𑐴𑑂𑐩","𑐭":"𑐴𑑂𑐬","𑐯":"𑐴𑑂𑐮","𑗘":"𑖂","𑗙":"𑖂","𑗚":"𑖃","𑗛":"𑖄","𑗜":"𑖲","𑗝":"𑖳",ฃ:"ข",ด:"ค",ต:"ค",ม:"ฆ",ຈ:"จ",ซ:"ช",ฏ:"ฎ",ท:"ฑ",ບ:"บ",ປ:"ป",ຝ:"ฝ",ພ:"พ",ຟ:"ฟ",ฦ:"ภ",ຍ:"ย","។":"ฯ",ๅ:"า",ำ:"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู",แ:"เเ",ໜ:"ຫນ",ໝ:"ຫມ",ຳ:"̊າ","༂":"འུྂཿ","༃":"འུྂ༔",ཪ:"ར",ༀ:"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","𑲲":"𑲪","ႁ":"ဂှ",က:"ဂာ","ၰ":"ဃှ","ၦ":"ပှ",ဟ:"ပာ","ၯ":"ပာှ","ၾ":"ၽှ",ဩ:"သြ",ဪ:"သြော်","႞":"ႃ̊",ឣ:"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ",ᢖ:"ᡜ",ᡕ:"ᠵ",ῶ:"Ꮿ",ᐍ:"ᐁ·",ᐫ:"ᐁᐠ",ᐑ:"ᐄ·",ᐓ:"ᐅ·",ᐭ:"ᐅᐠ",ᐕ:"ᐆ·",ᐘ:"ᐊ·",ᐮ:"ᐊᐠ",ᐚ:"ᐋ·","ᣝ":"ᐞᣟ",ᓑ:"ᐡ",ᕀ:"ᐩ",ᐿ:"ᐲ·",ᑃ:"ᐴ·","⍩":"ᐵ",ᑇ:"ᐹ·",ᑜ:"ᑏ·","⸧":"ᑐ","⊃":"ᑐ",ᑞ:"ᑐ·",ᑩ:"ᑐ'","⟉":"ᑐ/","⫗":"ᑐᑕ",ᑠ:"ᑑ·","⸦":"ᑕ","⊂":"ᑕ",ᑢ:"ᑕ·",ᑪ:"ᑕ'",ᑤ:"ᑖ·",ᑵ:"ᑫ·",ᒅ:"ᑫ'",ᑹ:"ᑮ·",ᑽ:"ᑰ·",ᘃ:"ᒉ",ᒓ:"ᒉ·",ᒕ:"ᒋ·",ᒗ:"ᒌ·",ᒛ:"ᒎ·",ᘂ:"ᒐ",ᒝ:"ᒐ·",ᒟ:"ᒑ·",ᒭ:"ᒣ·",ᒱ:"ᒦ·",ᒳ:"ᒧ·",ᒵ:"ᒨ·",ᒹ:"ᒫ·",ᓊ:"ᓀ·","ᣇ":"ᓂ·","ᣉ":"ᓃ·","ᣋ":"ᓄ·","ᣍ":"ᓅ·",ᓌ:"ᓇ·",ᓎ:"ᓈ·",ᘄ:"ᓓ",ᓝ:"ᓓ·",ᓟ:"ᓕ·",ᓡ:"ᓖ·",ᓣ:"ᓗ·",ᓥ:"ᓘ·",ᘇ:"ᓚ",ᓧ:"ᓚ·",ᓩ:"ᓛ·",ᓷ:"ᓭ·",ᓹ:"ᓯ·",ᓻ:"ᓰ·",ᓽ:"ᓱ·",ᓿ:"ᓲ·",ᔁ:"ᓴ·",ᔃ:"ᓵ·",ᔌ:"ᔋ<",ᔎ:"ᔋb",ᔍ:"ᔋᑕ",ᔏ:"ᔋᒐ",ᔘ:"ᔐ·",ᔚ:"ᔑ·",ᔜ:"ᔒ·",ᔞ:"ᔓ·",ᔠ:"ᔔ·",ᔢ:"ᔕ·",ᔤ:"ᔖ·",ᔲ:"ᔨ·",ᔴ:"ᔩ·",ᔶ:"ᔪ·",ᔸ:"ᔫ·",ᔺ:"ᔭ·",ᔼ:"ᔮ·",ᘢ:"ᕃ","ᣠ":"ᕃ·",ᘣ:"ᕆ",ᘤ:"ᕊ",ᕏ:"ᕌ·",ᖃ:"ᕐb",ᖄ:"ᕐḃ",ᖁ:"ᕐd",ᕿ:"ᕐP",ᙯ:"ᕐᑫ",ᕾ:"ᕐᑬ",ᖀ:"ᕐᑮ",ᖂ:"ᕐᑰ",ᖅ:"ᕐᒃ",ᕜ:"ᕚ·","ᣣ":"ᕞ·","ᣤ":"ᕦ·",ᕩ:"ᕧ·","ᣥ":"ᕫ·","ᣨ":"ᖆ·",ᖑ:"ᖕJ",ᙰ:"ᖕᒉ",ᖎ:"ᖕᒊ",ᖏ:"ᖕᒋ",ᖐ:"ᖕᒌ",ᖒ:"ᖕᒎ",ᖓ:"ᖕᒐ",ᖔ:"ᖕᒑ",ᙳ:"ᖖJ",ᙱ:"ᖖᒋ",ᙲ:"ᖖᒌ",ᙴ:"ᖖᒎ",ᙵ:"ᖖᒐ",ᙶ:"ᖖᒑ","ᣪ":"ᖗ·","ᙷ":"ᖧ·","ᙸ":"ᖨ·","ᙹ":"ᖩ·","ᙺ":"ᖪ·","ᙻ":"ᖫ·","ᙼ":"ᖬ·","ᙽ":"ᖭ·","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ·","ᣲ":"ᘛ·","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ",ˡ:"ᣳ",ʳ:"ᣴ",ˢ:"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ",ᛡ:"ᚼ","⍿":"ᚽ",ᛂ:"ᚽ","𝈿":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","🝔":"ᛜ","𑢷":"ᛜ","𐊔":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","𐓐":"ᛦ","↕":"ᛨ","𐳼":"𐲂","𐳺":"𐲥",ㄱ:"ᄀ",ᆨ:"ᄀ",ᄁ:"ᄀᄀ",ㄲ:"ᄀᄀ",ᆩ:"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ",ᇃ:"ᄀᄅ","ᇻ":"ᄀᄇ",ᆪ:"ᄀᄉ",ㄳ:"ᄀᄉ",ᇄ:"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ",ㄴ:"ᄂ",ᆫ:"ᄂ",ᄓ:"ᄂᄀ",ᇅ:"ᄂᄀ",ᄔ:"ᄂᄂ",ㅥ:"ᄂᄂ","ᇿ":"ᄂᄂ",ᄕ:"ᄂᄃ",ㅦ:"ᄂᄃ",ᇆ:"ᄂᄃ","ퟋ":"ᄂᄅ",ᄖ:"ᄂᄇ","ᅛ":"ᄂᄉ",ᇇ:"ᄂᄉ",ㅧ:"ᄂᄉ","ᅜ":"ᄂᄌ",ᆬ:"ᄂᄌ",ㄵ:"ᄂᄌ","ퟌ":"ᄂᄎ",ᇉ:"ᄂᄐ","ᅝ":"ᄂᄒ",ᆭ:"ᄂᄒ",ㄶ:"ᄂᄒ",ᇈ:"ᄂᅀ",ㅨ:"ᄂᅀ",ㄷ:"ᄃ",ᆮ:"ᄃ",ᄗ:"ᄃᄀ",ᇊ:"ᄃᄀ",ᄄ:"ᄃᄃ",ㄸ:"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ",ᇋ:"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ",ㄹ:"ᄅ",ᆯ:"ᄅ","ꥤ":"ᄅᄀ",ᆰ:"ᄅᄀ",ㄺ:"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ",ᇌ:"ᄅᄀᄉ",ㅩ:"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ",ᄘ:"ᄅᄂ",ᇍ:"ᄅᄂ","ꥦ":"ᄅᄃ",ᇎ:"ᄅᄃ",ㅪ:"ᄅᄃ","ꥧ":"ᄅᄃᄃ",ᇏ:"ᄅᄃᄒ",ᄙ:"ᄅᄅ",ᇐ:"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ",ᆱ:"ᄅᄆ",ㄻ:"ᄅᄆ",ᇑ:"ᄅᄆᄀ",ᇒ:"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ",ᆲ:"ᄅᄇ",ㄼ:"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ",ᇓ:"ᄅᄇᄉ",ㅫ:"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ",ᇕ:"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ",ᇔ:"ᄅᄇᄒ","ꥬ":"ᄅᄉ",ᆳ:"ᄅᄉ",ㄽ:"ᄅᄉ",ᇖ:"ᄅᄉᄉ",ᄛ:"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ",ᇘ:"ᄅᄏ",ᆴ:"ᄅᄐ",ㄾ:"ᄅᄐ",ᆵ:"ᄅᄑ",ㄿ:"ᄅᄑ",ᄚ:"ᄅᄒ",ㅀ:"ᄅᄒ",ᄻ:"ᄅᄒ",ᆶ:"ᄅᄒ","ퟲ":"ᄅᄒ",ᇗ:"ᄅᅀ",ㅬ:"ᄅᅀ","ퟛ":"ᄅᅌ",ᇙ:"ᄅᅙ",ㅭ:"ᄅᅙ","ퟜ":"ᄅᅙᄒ",ㅁ:"ᄆ",ᆷ:"ᄆ","ꥯ":"ᄆᄀ",ᇚ:"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ",ᇛ:"ᄆᄅ","ퟠ":"ᄆᄆ",ᄜ:"ᄆᄇ",ㅮ:"ᄆᄇ",ᇜ:"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ",ᇝ:"ᄆᄉ",ㅯ:"ᄆᄉ",ᇞ:"ᄆᄉᄉ",ᄝ:"ᄆᄋ",ㅱ:"ᄆᄋ",ᇢ:"ᄆᄋ","ퟢ":"ᄆᄌ",ᇠ:"ᄆᄎ",ᇡ:"ᄆᄒ",ᇟ:"ᄆᅀ",ㅰ:"ᄆᅀ",ㅂ:"ᄇ",ᆸ:"ᄇ",ᄞ:"ᄇᄀ",ㅲ:"ᄇᄀ",ᄟ:"ᄇᄂ",ᄠ:"ᄇᄃ",ㅳ:"ᄇᄃ","ퟣ":"ᄇᄃ",ᇣ:"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ",ᄈ:"ᄇᄇ",ㅃ:"ᄇᄇ","ퟦ":"ᄇᄇ",ᄬ:"ᄇᄇᄋ",ㅹ:"ᄇᄇᄋ",ᄡ:"ᄇᄉ",ㅄ:"ᄇᄉ",ᆹ:"ᄇᄉ",ᄢ:"ᄇᄉᄀ",ㅴ:"ᄇᄉᄀ",ᄣ:"ᄇᄉᄃ",ㅵ:"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ",ᄤ:"ᄇᄉᄇ",ᄥ:"ᄇᄉᄉ",ᄦ:"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ",ᄫ:"ᄇᄋ",ㅸ:"ᄇᄋ",ᇦ:"ᄇᄋ",ᄧ:"ᄇᄌ",ㅶ:"ᄇᄌ","ퟨ":"ᄇᄌ",ᄨ:"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ",ᄩ:"ᄇᄐ",ㅷ:"ᄇᄐ",ᄪ:"ᄇᄑ",ᇤ:"ᄇᄑ","ꥴ":"ᄇᄒ",ᇥ:"ᄇᄒ",ㅅ:"ᄉ",ᆺ:"ᄉ",ᄭ:"ᄉᄀ",ㅺ:"ᄉᄀ",ᇧ:"ᄉᄀ",ᄮ:"ᄉᄂ",ㅻ:"ᄉᄂ",ᄯ:"ᄉᄃ",ㅼ:"ᄉᄃ",ᇨ:"ᄉᄃ",ᄰ:"ᄉᄅ",ᇩ:"ᄉᄅ",ᄱ:"ᄉᄆ","ퟪ":"ᄉᄆ",ᄲ:"ᄉᄇ",ㅽ:"ᄉᄇ",ᇪ:"ᄉᄇ",ᄳ:"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ",ᄊ:"ᄉᄉ",ㅆ:"ᄉᄉ",ᆻ:"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ",ᄴ:"ᄉᄉᄉ",ᄵ:"ᄉᄋ",ᄶ:"ᄉᄌ",ㅾ:"ᄉᄌ","ퟯ":"ᄉᄌ",ᄷ:"ᄉᄎ","ퟰ":"ᄉᄎ",ᄸ:"ᄉᄏ",ᄹ:"ᄉᄐ","ퟱ":"ᄉᄐ",ᄺ:"ᄉᄑ","ퟮ":"ᄉᅀ",ㅇ:"ᄋ",ᆼ:"ᄋ",ᅁ:"ᄋᄀ",ᇬ:"ᄋᄀ",ᇭ:"ᄋᄀᄀ",ᅂ:"ᄋᄃ","ꥶ":"ᄋᄅ",ᅃ:"ᄋᄆ",ᅄ:"ᄋᄇ",ᅅ:"ᄋᄉ",ᇱ:"ᄋᄉ",ㆂ:"ᄋᄉ",ᅇ:"ᄋᄋ",ㆀ:"ᄋᄋ",ᇮ:"ᄋᄋ",ᅈ:"ᄋᄌ",ᅉ:"ᄋᄎ",ᇯ:"ᄋᄏ",ᅊ:"ᄋᄐ",ᅋ:"ᄋᄑ","ꥷ":"ᄋᄒ",ᅆ:"ᄋᅀ",ᇲ:"ᄋᅀ",ㆃ:"ᄋᅀ",ㅈ:"ᄌ",ᆽ:"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ",ᅍ:"ᄌᄋ",ᄍ:"ᄌᄌ",ㅉ:"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ",ㅊ:"ᄎ",ᆾ:"ᄎ",ᅒ:"ᄎᄏ",ᅓ:"ᄎᄒ",ㅋ:"ᄏ",ᆿ:"ᄏ",ㅌ:"ᄐ",ᇀ:"ᄐ","ꥹ":"ᄐᄐ",ㅍ:"ᄑ",ᇁ:"ᄑ",ᅖ:"ᄑᄇ",ᇳ:"ᄑᄇ","ퟺ":"ᄑᄉ",ᅗ:"ᄑᄋ",ㆄ:"ᄑᄋ",ᇴ:"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ",ㅎ:"ᄒ",ᇂ:"ᄒ",ᇵ:"ᄒᄂ",ᇶ:"ᄒᄅ",ᇷ:"ᄒᄆ",ᇸ:"ᄒᄇ","ꥻ":"ᄒᄉ",ᅘ:"ᄒᄒ",ㆅ:"ᄒᄒ",ᄽ:"ᄼᄼ",ᄿ:"ᄾᄾ",ㅿ:"ᅀ",ᇫ:"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ",ㆁ:"ᅌ",ᇰ:"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ",ᅏ:"ᅎᅎ",ᅑ:"ᅐᅐ",ㆆ:"ᅙ",ᇹ:"ᅙ","ꥼ":"ᅙᅙ",ㅤ:"ᅠ",ㅏ:"ᅡ","ᆣ":"ᅡー",ᅶ:"ᅡᅩ",ᅷ:"ᅡᅮ",ᅢ:"ᅡ丨",ㅐ:"ᅡ丨",ㅑ:"ᅣ",ᅸ:"ᅣᅩ",ᅹ:"ᅣᅭ","ᆤ":"ᅣᅮ",ᅤ:"ᅣ丨",ㅒ:"ᅣ丨",ㅓ:"ᅥ",ᅼ:"ᅥー",ᅺ:"ᅥᅩ",ᅻ:"ᅥᅮ",ᅦ:"ᅥ丨",ㅔ:"ᅥ丨",ㅕ:"ᅧ","ᆥ":"ᅧᅣ",ᅽ:"ᅧᅩ",ᅾ:"ᅧᅮ",ᅨ:"ᅧ丨",ㅖ:"ᅧ丨",ㅗ:"ᅩ",ᅪ:"ᅩᅡ",ㅘ:"ᅩᅡ",ᅫ:"ᅩᅡ丨",ㅙ:"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨",ᅿ:"ᅩᅥ",ᆀ:"ᅩᅥ丨","ힰ":"ᅩᅧ",ᆁ:"ᅩᅧ丨",ᆂ:"ᅩᅩ","ힱ":"ᅩᅩ丨",ᆃ:"ᅩᅮ",ᅬ:"ᅩ丨",ㅚ:"ᅩ丨",ㅛ:"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨",ᆄ:"ᅭᅣ",ㆇ:"ᅭᅣ",ᆆ:"ᅭᅣ",ᆅ:"ᅭᅣ丨",ㆈ:"ᅭᅣ丨","ힴ":"ᅭᅥ",ᆇ:"ᅭᅩ",ᆈ:"ᅭ丨",ㆉ:"ᅭ丨",ㅜ:"ᅮ",ᆉ:"ᅮᅡ",ᆊ:"ᅮᅡ丨",ᅯ:"ᅮᅥ",ㅝ:"ᅮᅥ",ᆋ:"ᅮᅥー",ᅰ:"ᅮᅥ丨",ㅞ:"ᅮᅥ丨","ힵ":"ᅮᅧ",ᆌ:"ᅮᅧ丨",ᆍ:"ᅮᅮ",ᅱ:"ᅮ丨",ㅟ:"ᅮ丨","ힶ":"ᅮ丨丨",ㅠ:"ᅲ",ᆎ:"ᅲᅡ","ힷ":"ᅲᅡ丨",ᆏ:"ᅲᅥ",ᆐ:"ᅲᅥ丨",ᆑ:"ᅲᅧ",ㆊ:"ᅲᅧ",ᆒ:"ᅲᅧ丨",ㆋ:"ᅲᅧ丨","ힸ":"ᅲᅩ",ᆓ:"ᅲᅮ",ᆔ:"ᅲ丨",ㆌ:"ᅲ丨",ㆍ:"ᆞ","ퟅ":"ᆞᅡ",ᆟ:"ᆞᅥ","ퟆ":"ᆞᅥ丨",ᆠ:"ᆞᅮ",ᆢ:"ᆞᆞ",ᆡ:"ᆞ丨",ㆎ:"ᆞ丨",ヘ:"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","𝈜":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","𝈕":"ꓶ","𝈫":"ꓶ","𖼦":"ꓶ","𐐑":"ꓶ","⅃":"𖼀","𑫦":"𑫥𑫯","𑫨":"𑫥𑫥","𑫩":"𑫥𑫥𑫯","𑫪":"𑫥𑫥𑫰","𑫧":"𑫥𑫰","𑫴":"𑫳𑫯","𑫶":"𑫳𑫳","𑫷":"𑫳𑫳𑫯","𑫸":"𑫳𑫳𑫰","𑫵":"𑫳𑫰","𑫬":"𑫫𑫯","𑫭":"𑫫𑫫","𑫮":"𑫫𑫫𑫯","⊕":"𐊨","⨁":"𐊨","🜨":"𐊨","Ꚛ":"𐊨","▽":"𐊼","𝈔":"𐊼","🜄":"𐊼","⧖":"𐋀","ꞛ":"𐐺","Ꞛ":"𐐒","𐒠":"𐒆","𐏑":"𐎂","𐏓":"𐎓","𒀸":"𐎚","☥":"𐦞","𓋹":"𐦞","〹":"卄",不:"不","丽":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨",ᅵ:"丨",ㅣ:"丨","⼁":"丨",ᆜ:"丨ー",ᆘ:"丨ᅡ",ᆙ:"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨",ᆚ:"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ",ᆛ:"丨ᅮ","ퟃ":"丨ᅲ",ᆝ:"丨ᆞ","ퟄ":"丨丨",串:"串","丸":"丸",丹:"丹","乁":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀",亂:"亂","㇚":"亅","⼅":"亅",了:"了",ニ:"二","⼆":"二","𠄢":"𠄢","⼇":"亠",亮:"亮","⼈":"人",イ:"亻","⺅":"亻",什:"什","仌":"仌",令:"令","你":"你",倂:"併","倂":"併","侀":"侀",來:"來",例:"例","侮":"侮","侮":"侮","侻":"侻",便:"便",值:"値",倫:"倫","偺":"偺","備":"備","像":"像",僚:"僚","僧":"僧","僧":"僧","㒞":"㒞","⼉":"儿",兀:"兀","⺎":"兀","充":"充","免":"免","免":"免","兔":"兔","兤":"兤","⼊":"入","內":"內","全":"全",兩:"兩",ハ:"八","⼋":"八",六:"六","具":"具","𠔜":"𠔜","𠔥":"𠔥","冀":"冀","㒹":"㒹","⼌":"冂","再":"再","𠕋":"𠕋","冒":"冒","冕":"冕","㒻":"㒻","最":"最","⼍":"冖","冗":"冗","冤":"冤","⼎":"冫","冬":"冬","况":"况","况":"况",冷:"冷",凉:"凉",凌:"凌",凜:"凜",凞:"凞","⼏":"几","𠘺":"𠘺","凵":"凵","⼐":"凵","⼑":"刀","⺉":"刂","刃":"刃",切:"切","切":"切",列:"列",利:"利","㓟":"㓟",刺:"刺","刻":"刻","剆":"剆","割":"割","剷":"剷",劉:"劉","𠠄":"𠠄",カ:"力",力:"力","⼒":"力",劣:"劣","㔕":"㔕","劳":"劳","勇":"勇","勇":"勇","勉":"勉","勉":"勉",勒:"勒",勞:"勞","勤":"勤","勤":"勤",勵:"勵","⼓":"勹","勺":"勺","勺":"勺","包":"包","匆":"匆","𠣞":"𠣞","⼔":"匕",北:"北","北":"北","⼕":"匚","⼖":"匸",匿:"匿","⼗":"十","〸":"十","〺":"卅","卉":"卉","࿖":"卍","࿕":"卐","卑":"卑","卑":"卑","博":"博",ト:"卜","⼘":"卜","⼙":"卩","⺋":"㔾","即":"即",卵:"卵","卽":"卽","卿":"卿","卿":"卿","卿":"卿","⼚":"厂","𠨬":"𠨬","⼛":"厶",參:"參","⼜":"又","及":"及","叟":"叟","𠭣":"𠭣",ロ:"口","⼝":"口",囗:"口","⼞":"口",句:"句","叫":"叫","叱":"叱","吆":"吆",吏:"吏",吝:"吝","吸":"吸",呂:"呂","呈":"呈","周":"周","咞":"咞","咢":"咢",咽:"咽",䎛:"㖈","哶":"哶","唐":"唐","啓":"啓",啟:"啓","啕":"啕","啣":"啣","善":"善","善":"善",喇:"喇","喙":"喙","喙":"喙","喝":"喝","喝":"喝","喫":"喫","喳":"喳",嗀:"嗀","嗂":"嗂","嗢":"嗢","嘆":"嘆","嘆":"嘆","噑":"噑","噴":"噴","器":"器",囹:"囹","圖":"圖","圗":"圗","⼟":"土",士:"土","⼠":"土","型":"型","城":"城",㦳:"㘽","埴":"埴","堍":"堍","報":"報","堲":"堲","塀":"塀",塚:"塚","塚":"塚",塞:"塞",填:"塡",壿:"墫","墬":"墬","墳":"墳",壘:"壘",壟:"壟","𡓤":"𡓤","壮":"壮","売":"売","壷":"壷","⼡":"夂","夆":"夆","⼢":"夊",タ:"夕","⼣":"夕","多":"多","夢":"夢","⼤":"大","奄":"奄",奈:"奈",契:"契","奔":"奔","奢":"奢",女:"女","⼥":"女","𡚨":"𡚨","𡛪":"𡛪","姘":"姘","姬":"姬","娛":"娛","娧":"娧","婢":"婢","婦":"婦",嬀:"媯","㛮":"㛮","㛼":"㛼","媵":"媵","嬈":"嬈","嬨":"嬨","嬾":"嬾","嬾":"嬾","⼦":"子","⼧":"宀",宅:"宅","𡧈":"𡧈","寃":"寃","寘":"寘",寧:"寧",寧:"寧","寧":"寧",寮:"寮","寳":"寳","𡬘":"𡬘","⼨":"寸","寿":"寿","将":"将","⼩":"小","尢":"尢","⺐":"尢","⼪":"尢","⺏":"尣","㞁":"㞁","⼫":"尸",尿:"尿","屠":"屠",屢:"屢","層":"層",履:"履","屮":"屮","屮":"屮","⼬":"屮","𡴋":"𡴋","⼭":"山","峀":"峀","岍":"岍","𡷤":"𡷤","𡷦":"𡷦",崙:"崙","嵃":"嵃",嵐:"嵐","嵫":"嵫","嵮":"嵮","嵼":"嵼","嶲":"嶲",嶺:"嶺","⼮":"巛","巢":"巢",エ:"工","⼯":"工","⼰":"己","⺒":"巳","㠯":"㠯","巽":"巽","⼱":"巾",帲:"帡","帨":"帨","帽":"帽","幩":"幩","㡢":"㡢","𢆃":"𢆃","⼲":"干",年:"年","𢆟":"𢆟","⺓":"幺","⼳":"幺","⼴":"广",度:"度","㡼":"㡼","庰":"庰","庳":"庳","庶":"庶",廊:"廊","廊":"廊",廉:"廉","廒":"廒",廓:"廓","廙":"廙",廬:"廬","⼵":"廴","廾":"廾","⼶":"廾","𢌱":"𢌱","𢌱":"𢌱",弄:"弄","⼷":"弋","⼸":"弓","弢":"弢","弢":"弢","⼹":"彐","⺔":"彑","当":"当","㣇":"㣇","⼺":"彡","形":"形","彩":"彩","彫":"彫","⼻":"彳",律:"律","㣣":"㣣","徚":"徚",復:"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","忍":"忍","志":"志",念:"念","忹":"忹",怒:"怒",怜:"怜","恵":"恵","㤜":"㤜","㤺":"㤺","悁":"悁","悔":"悔","悔":"悔","惇":"惇","惘":"惘",惡:"惡","𢛔":"𢛔","愈":"愈","慨":"慨",慄:"慄","慈":"慈","慌":"慌","慌":"慌","慎":"慎","慎":"慎","慠":"慠","慺":"慺","憎":"憎","憎":"憎","憎":"憎",憐:"憐","憤":"憤","憯":"憯","憲":"憲","𢡄":"𢡄","𢡊":"𢡊","懞":"懞","懲":"懲","懲":"懲","懲":"懲",懶:"懶","懶":"懶",戀:"戀","⼽":"戈","成":"成","戛":"戛",戮:"戮","戴":"戴","⼾":"戶",戸:"戶","⼿":"手","⺘":"扌","扝":"扝","抱":"抱",拉:"拉",拏:"拏",拓:"拓","拔":"拔","拼":"拼",拾:"拾","𢬌":"𢬌","挽":"挽","捐":"捐","捨":"捨",捻:"捻","掃":"掃",掠:"掠","掩":"掩","揄":"揄","揤":"揤","摒":"摒","𢯱":"𢯱","搜":"搜","搢":"搢","揅":"揅","摩":"摩","摷":"摷","摾":"摾","㨮":"㨮",搉:"㩁",撚:"撚","撝":"撝",擄:"擄","㩬":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","敏":"敏","敖":"敖","敬":"敬",數:"數","𣀊":"𣀊","⽂":"文","⻫":"斉","⽃":"斗",料:"料","⽄":"斤","⽅":"方",旅:"旅","⽆":"无","⺛":"旡","既":"既","旣":"旣","⽇":"日",易:"易",曶:"㫚","㫤":"㫤","晉":"晉",晩:"晚",晴:"晴","晴":"晴","暑":"暑","暑":"暑",暈:"暈","㬈":"㬈","暜":"暜",暴:"暴",曆:"曆","㬙":"㬙","𣊸":"𣊸","⽈":"曰",更:"更","書":"書","⽉":"月","𣍟":"𣍟",肦:"朌",胐:"朏",胊:"朐",脁:"朓",胶:"㬵",朗:"朗","朗":"朗","朗":"朗",脧:"朘","望":"望","望":"望",幐:"㬺",䐠:"㬻","𣎓":"𣎓",膧:"朣","𣎜":"𣎜","⽊":"木",李:"李","杓":"杓","杖":"杖","杞":"杞","𣏃":"𣏃",柿:"杮",杻:"杻","枅":"枅",林:"林","㭉":"㭉","𣏕":"𣏕",柳:"柳","柺":"柺",栗:"栗","栟":"栟","桒":"桒","𣑭":"𣑭",梁:"梁","梅":"梅","梅":"梅","梎":"梎",梨:"梨","椔":"椔","楂":"楂","㮝":"㮝","㮝":"㮝",槩:"㮣",樧:"榝","榣":"榣","槪":"槪",樂:"樂",樂:"樂",樂:"樂",樓:"樓","𣚣":"𣚣","檨":"檨",櫓:"櫓","櫛":"櫛",欄:"欄","㰘":"㰘","⽋":"欠","次":"次","𣢧":"𣢧","歔":"歔","㱎":"㱎","⽌":"止","⻭":"歯","歲":"歲",歷:"歷","歹":"歹","⽍":"歹","⺞":"歺","殟":"殟",殮:"殮","⽎":"殳",殺:"殺","殺":"殺","殺":"殺","殻":"殻","𣪍":"𣪍","⽏":"毋","⺟":"母","𣫺":"𣫺","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","汎":"汎","汧":"汧",沈:"沈","沿":"沿",泌:"泌","泍":"泍",泥:"泥","𣲼":"𣲼",洛:"洛",洞:"洞","洴":"洴","派":"派",流:"流","流":"流","流":"流","洖":"洖","浩":"浩",浪:"浪","海":"海","海":"海","浸":"浸","涅":"涅","𣴞":"𣴞",淋:"淋",淚:"淚",淪:"淪","淹":"淹","渚":"渚","港":"港","湮":"湮",潙:"溈","滋":"滋","滋":"滋",溜:"溜",溺:"溺","滇":"滇",滑:"滑","滛":"滛","㴳":"㴳",漏:"漏","漢":"漢","漢":"漢",漣:"漣","𣻑":"𣻑","潮":"潮","𣽞":"𣽞","𣾎":"𣾎","濆":"濆",濫:"濫",濾:"濾","瀛":"瀛","瀞":"瀞","瀞":"瀞","瀹":"瀹","灊":"灊","㶖":"㶖","⽕":"火","⺣":"灬","灰":"灰","灷":"灷","災":"災",炙:"炙","炭":"炭",烈:"烈",烙:"烙","煮":"煮","煮":"煮","𤉣":"𤉣","煅":"煅",煉:"煉","𤋮":"𤋮","熜":"熜",燎:"燎",燐:"燐","𤎫":"𤎫",爐:"爐",爛:"爛","爨":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","爵":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","牐":"牐","⽛":"牙","𤘈":"𤘈","⽜":"牛",牢:"牢","犀":"犀","犕":"犕","⽝":"犬","⺨":"犭","犯":"犯",狀:"狀","𤜵":"𤜵",狼:"狼",猪:"猪","猪":"猪","𤠔":"𤠔",獵:"獵","獺":"獺","⽞":"玄",率:"率",率:"率","⽟":"玉","王":"王","㺬":"㺬","玥":"玥",玲:"玲","㺸":"㺸","㺸":"㺸",珞:"珞",琉:"琉",理:"理","琢":"琢","瑇":"瑇","瑜":"瑜",瑩:"瑩","瑱":"瑱","瑱":"瑱","璅":"璅",璉:"璉",璘:"璘","瓊":"瓊","⽠":"瓜","⽡":"瓦","㼛":"㼛","甆":"甆","⽢":"甘","⽣":"生","甤":"甤","⽤":"用","⽥":"田","画":"画","甾":"甾","𤰶":"𤰶",留:"留",略:"略",異:"異","異":"異","𤲒":"𤲒","⽦":"疋","⽧":"疒",痢:"痢","瘐":"瘐","瘟":"瘟","瘝":"瘝",療:"療",癩:"癩","⽨":"癶","⽩":"白","𤾡":"𤾡","𤾸":"𤾸","⽪":"皮","⽫":"皿","𥁄":"𥁄","㿼":"㿼",益:"益","益":"益","盛":"盛",盧:"盧","䀈":"䀈","⽬":"目","直":"直","直":"直","𥃲":"𥃲","𥃳":"𥃳",省:"省","䀘":"䀘","𥄙":"𥄙","眞":"眞","真":"真","真":"真","𥄳":"𥄳","着":"着","睊":"睊","睊":"睊","鿃":"䀹","䀹":"䀹","䀹":"䀹",晣:"䀿","䁆":"䁆","瞋":"瞋","𥉉":"𥉉","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","䂖":"䂖","𥐝":"𥐝",硏:"研","硎":"硎",硫:"硫",碌:"碌","碌":"碌","碑":"碑",磊:"磊","磌":"磌","磌":"磌",磻:"磻","䃣":"䃣",礪:"礪","⽰":"示","⺭":"礻",礼:"礼","社":"社","祈":"祈","祉":"祉","𥘦":"𥘦","祐":"祐","祖":"祖","祖":"祖","祝":"祝",神:"神",祥:"祥","視":"視","視":"視",祿:"祿","𥚚":"𥚚","禍":"禍","禎":"禎",福:"福","福":"福","𥛅":"𥛅",禮:"禮","⽱":"禸","⽲":"禾",秊:"秊","䄯":"䄯","秫":"秫",稜:"稜","穊":"穊","穀":"穀","穀":"穀","穏":"穏","⽳":"穴","突":"突","𥥼":"𥥼","窱":"窱",立:"立","⽴":"立","⻯":"竜","𥪧":"𥪧","𥪧":"𥪧","竮":"竮","⽵":"竹",笠:"笠","節":"節","節":"節","䈂":"䈂","𥮫":"𥮫","篆":"篆","䈧":"䈧","築":"築","𥲀":"𥲀","𥳐":"𥳐",簾:"簾",籠:"籠","⽶":"米","类":"类",粒:"粒",精:"精","糒":"糒",糖:"糖","糨":"糨","䊠":"䊠","糣":"糣",糧:"糧","⽷":"糸","⺯":"糹","𥾆":"𥾆","紀":"紀",紐:"紐",索:"索",累:"累",絶:"絕","絣":"絣","絛":"絛",綠:"綠",綾:"綾","緇":"緇",練:"練","練":"練","練":"練","縂":"縂","䌁":"䌁","縉":"縉",縷:"縷","繁":"繁","繅":"繅","𦇚":"𦇚","䌴":"䌴","⽸":"缶","𦈨":"𦈨","缾":"缾","𦉇":"𦉇","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","䍙":"䍙","署":"署","𦋙":"𦋙",罹:"罹","罺":"罺",羅:"羅","𦌾":"𦌾","⽺":"羊","羕":"羕",羚:"羚",羽:"羽","⽻":"羽","翺":"翺",老:"老","⽼":"老","⺹":"耂","者":"者","者":"者","者":"者","⽽":"而","𦓚":"𦓚","⽾":"耒","𦔣":"𦔣","⽿":"耳",聆:"聆","聠":"聠","𦖨":"𦖨",聯:"聯","聰":"聰",聾:"聾","⾀":"聿","⺺":"肀","⾁":"肉",肋:"肋","肭":"肭","育":"育","䏕":"䏕","䏙":"䏙",腁:"胼","脃":"脃","脾":"脾","䐋":"䐋","朡":"朡","𦞧":"𦞧","𦞵":"𦞵",朦:"䑃",臘:"臘","⾂":"臣",臨:"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","舁":"舁","舁":"舁","舄":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","䑫":"䑫","⾉":"艮",良:"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","芋":"芋","芑":"芑","芝":"芝","花":"花","芳":"芳","芽":"芽",若:"若","若":"若","苦":"苦","𦬼":"𦬼",茶:"茶","荒":"荒","荣":"荣","茝":"茝","茣":"茣","莽":"莽","荓":"荓",菉:"菉","菊":"菊","菌":"菌","菜":"菜","菧":"菧","華":"華",菱:"菱","著":"著","著":"著","𦰶":"𦰶","莭":"莭",落:"落",葉:"葉",蔿:"蒍","𦳕":"𦳕","𦵫":"𦵫",蓮:"蓮","蓱":"蓱","蓳":"蓳",蓼:"蓼","蔖":"蔖","䔫":"䔫","蕤":"蕤","𦼬":"𦼬",藍:"藍","䕝":"䕝","𦾱":"𦾱","䕡":"䕡",藺:"藺",蘆:"蘆","䕫":"䕫",蘒:"蘒",蘭:"蘭","𧃒":"𧃒",虁:"蘷",蘿:"蘿","⾌":"虍","⻁":"虎","虐":"虐",虜:"虜","虜":"虜","虧":"虧","虩":"虩","⾍":"虫","蚩":"蚩","蚈":"蚈","蛢":"蛢","蜎":"蜎","蜨":"蜨","蝫":"蝫","蟡":"蟡","蝹":"蝹","蝹":"蝹","螆":"螆","䗗":"䗗","𧏊":"𧏊",螺:"螺","蠁":"蠁","䗹":"䗹",蠟:"蠟","⾎":"血",行:"行","⾏":"行","衠":"衠","衣":"衣","⾐":"衣","⻂":"衤",裂:"裂","𧙧":"𧙧",裏:"裏","裗":"裗","裞":"裞",裡:"裡",裸:"裸","裺":"裺","䘵":"䘵","褐":"褐","襁":"襁",襤:"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆",見:"見","⾒":"見","𧢮":"𧢮","⻅":"见","⾓":"角","⾔":"言","𧥦":"𧥦",詽:"訮",訞:"䚶","䚾":"䚾","䛇":"䛇","誠":"誠",說:"說",說:"說","調":"調","請":"請",諒:"諒",論:"論","諭":"諭","諭":"諭",諸:"諸","諸":"諸",諾:"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹",識:"識",讀:"讀",讏:"讆","變":"變","變":"變","⻈":"讠","⾕":"谷","⾖":"豆",豈:"豈","豕":"豕","⾗":"豕",豣:"豜","⾘":"豸","𧲨":"𧲨","⾙":"貝","貫":"貫","賁":"賁",賂:"賂",賈:"賈","賓":"賓","贈":"贈","贈":"贈","贛":"贛","⻉":"贝","⾚":"赤","⾛":"走","起":"起",趆:"赿","𧻓":"𧻓","𧼯":"𧼯","⾜":"足","跋":"跋","趼":"趼",跺:"跥",路:"路","跰":"跰",躛:"躗","⾝":"身",車:"車","⾞":"車","軔":"軔",輧:"軿",輦:"輦",輪:"輪","輸":"輸","輸":"輸",輻:"輻",轢:"轢","⻋":"车","⾟":"辛","辞":"辞",辰:"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","巡":"巡",連:"連",逸:"逸","逸":"逸","遲":"遲",遼:"遼","𨗒":"𨗒","𨗭":"𨗭",邏:"邏","⾢":"邑","邔":"邔",郎:"郎",郞:"郎","郞":"郎","郱":"郱",都:"都","𨜮":"𨜮","鄑":"鄑","鄛":"鄛","⾣":"酉",酪:"酪","醙":"醙",醴:"醴","⾤":"釆",里:"里","⾥":"里",量:"量",金:"金","⾦":"金",鈴:"鈴","鈸":"鈸","鉶":"鉶","鋗":"鋗","鋘":"鋘","鉼":"鉼",錄:"錄",鍊:"鍊",鎮:"鎭","鏹":"鏹","鐕":"鐕","𨯺":"𨯺","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","開":"開","䦕":"䦕",閭:"閭","閷":"閷","𨵷":"𨵷","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝",阮:"阮",陋:"陋",降:"降",陵:"陵",陸:"陸","陼":"陼",隆:"隆",隣:"隣","䧦":"䧦","⾪":"隶","隷":"隷",隸:"隷",隸:"隷","⾫":"隹","雃":"雃",離:"離","難":"難","難":"難","⾬":"雨",零:"零",雷:"雷","霣":"霣","𩅅":"𩅅",露:"露",靈:"靈","⾭":"靑","⻘":"青",靖:"靖","靖":"靖","𩇟":"𩇟","⾮":"非","⾯":"面","𩈚":"𩈚","⾰":"革","䩮":"䩮","䩶":"䩶","⾱":"韋","韛":"韛","韠":"韠","⻙":"韦","⾲":"韭","𩐊":"𩐊","⾳":"音","響":"響","響":"響","⾴":"頁","䪲":"䪲","頋":"頋","頋":"頋","頋":"頋",領:"領","頩":"頩","𩒖":"𩒖","頻":"頻","頻":"頻",類:"類","⻚":"页","⾵":"風","𩖶":"𩖶","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","飢":"飢",飯:"飯",飼:"飼","䬳":"䬳",館:"館","餩":"餩","⻠":"饣","⾸":"首","⾹":"香","馧":"馧","⾺":"馬","駂":"駂",駱:"駱","駾":"駾",驪:"驪","⻢":"马","⾻":"骨","䯎":"䯎","⾼":"高","⾽":"髟","𩬰":"𩬰","鬒":"鬒","鬒":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚",魯:"魯","鱀":"鱀",鱗:"鱗","⻥":"鱼","⿃":"鳥","鳽":"鳽","䳎":"䳎","鵧":"鵧","䳭":"䳭","𪃎":"𪃎",鶴:"鶴","𪄅":"𪄅","䳸":"䳸",鷺:"鷺","𪈎":"𪈎",鸞:"鸞",鹃:"鹂","⿄":"鹵",鹿:"鹿","⿅":"鹿","𪊑":"𪊑",麗:"麗",麟:"麟","⿆":"麥","⻨":"麦","麻":"麻","⿇":"麻","𪎒":"𪎒","⿈":"黃","⻩":"黄","⿉":"黍",黎:"黎","䵖":"䵖","⿊":"黑",黒:"黑","墨":"墨","黹":"黹","⿋":"黹","⿌":"黽","鼅":"鼅","黾":"黾","⿍":"鼎","鼏":"鼏","⿎":"鼓","鼖":"鼖","⿏":"鼠","鼻":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","𪘀":"𪘀","⻮":"齿",龍:"龍","⿓":"龍","龎":"龎","⻰":"龙",龜:"龜",龜:"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"};var ds,Il;function ev(){if(Il)return ds;Il=1;var i=Zh;function e(a){return a.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var t=RegExp(Object.keys(i).map(e).join("|"),"g");function r(a){return i[a]}function n(a){return a.replace(t,r)}return ds=n,ds}var tv=ev();const rv=mo(tv);var Bn={exports:{}},us={},cs,Cl;function nv(){if(Cl)return cs;Cl=1;function i(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return cs=i,i.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},i.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},i.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},r),this._options.unref&&this._timer.unref(),!0},i.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},i.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},i.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},i.prototype.start=i.prototype.try,i.prototype.errors=function(){return this._errors},i.prototype.attempts=function(){return this._attempts},i.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var a=this._errors[n],s=a.message,o=(e[s]||0)+1;e[s]=o,o>=r&&(t=a,r=o)}return t},cs}var Ol;function iv(){return Ol||(Ol=1,function(i){var e=nv();i.operation=function(t){var r=i.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},i.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var n in t)r[n]=t[n];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],s=0;s<r.retries;s++)a.push(this.createTimeout(s,r));return t&&t.forever&&!a.length&&a.push(this.createTimeout(s,r)),a.sort(function(o,l){return o-l}),a},i.createTimeout=function(t,r){var n=r.randomize?Math.random()+1:1,a=Math.round(n*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return a=Math.min(a,r.maxTimeout),a},i.wrap=function(t,r,n){if(r instanceof Array&&(n=r,r=null),!n){n=[];for(var a in t)typeof t[a]=="function"&&n.push(a)}for(var s=0;s<n.length;s++){var o=n[s],l=t[o];t[o]=function(u){var h=i.operation(r),v=Array.prototype.slice.call(arguments,1),m=v.pop();v.push(function(f){h.retry(f)||(f&&(arguments[0]=h.mainError()),m.apply(this,arguments))}),h.attempt(function(){u.apply(t,v)})}.bind(t,l),t[o].options=r}}}(us)),us}var hs,Ml;function av(){return Ml||(Ml=1,hs=iv()),hs}var Pl;function sv(){if(Pl)return Bn.exports;Pl=1;const i=av(),e=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class t extends Error{constructor(o){super(),o instanceof Error?(this.originalError=o,{message:o}=o):(this.originalError=new Error(o),this.originalError.stack=this.stack),this.name="AbortError",this.message=o}}const r=(s,o,l)=>{const d=l.retries-(o-1);return s.attemptNumber=o,s.retriesLeft=d,s},n=s=>e.includes(s),a=(s,o)=>new Promise((l,d)=>{o={onFailedAttempt:()=>{},retries:10,...o};const u=i.operation(o);u.attempt(async h=>{try{l(await s(h))}catch(v){if(!(v instanceof Error)){d(new TypeError(`Non-error was thrown: "${v}". You should only throw errors.`));return}if(v instanceof t)u.stop(),d(v.originalError);else if(v instanceof TypeError&&!n(v.message))u.stop(),d(v);else{r(v,h,o);try{await o.onFailedAttempt(v)}catch(m){d(m);return}u.retry(v)||d(u.mainError())}}})});return Bn.exports=a,Bn.exports.default=a,Bn.exports.AbortError=t,Bn.exports}var ov=sv();const Ju=mo(ov);let Li=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e?.[this.name]),!t&&this.altName&&(t=e?.[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class Ka extends Li{constructor(){super(...arguments),c(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class Ye extends Li{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var Jr=function(i){return i.Self="m.self",i.Pin="m.pin",i}({}),kn=new Ye("m.asset","org.matrix.msc3488.asset"),ur=new Ye("m.ts","org.matrix.msc3488.ts"),An=new Ye("m.location","org.matrix.msc3488.location"),ht=function(i){return i.Read="m.read",i.FullyRead="m.fully_read",i.ReadPrivate="m.read.private",i}({}),Dn="main";function kl(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Al(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?kl(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):kl(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var vs=new Map;function fs(i){return i instanceof String&&(i=i.toString()),vs.has(i)||vs.set(i,i),vs.get(i)}function xs(i,e){var t=e??new URLSearchParams,r=function(o){a!=null&&(Array.isArray(a)?a.forEach(l=>{t.append(o,String(l))}):t.append(o,String(a)))};for(var[n,a]of Object.entries(i))r(n);return t}function Dl(i,e,t){var r=Al(Al({},t),{},{[e]:t[i]});return delete r[i],r}function Q(i,e){for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];r!=null&&(i=i.replace(t,encodeURIComponent(r)))}return i}function Ea(i,e,t){var r;if(t){for(r=i.length-1;r>=0;r--)if(e(i[r],r,i))return i.splice(r,1),!0}else for(r=0;r<i.length;r++)if(e(i[r],r,i))return i.splice(r,1),!0;return!1}function zu(i,e){for(var t of e)if(!i.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function Ui(i){return JSON.parse(JSON.stringify(i))}function En(i,e){if(i===e)return!0;if(typeof i!=typeof e)return!1;if(typeof i=="number"&&isNaN(i)&&isNaN(e))return!0;if(i===null||e===null)return i===e;if(!(i instanceof Object)||i.constructor!==e.constructor||i.prototype!==e.prototype)return!1;if(i instanceof RegExp||i instanceof Date)return i.toString()===e.toString();if(Array.isArray(i)){if(i.length!==e.length)return!1;for(var t=0;t<i.length;t++)if(!En(i[t],e[t]))return!1}else{for(var r in e)if(e.hasOwnProperty(r)!==i.hasOwnProperty(r))return!1;for(var n in i)if(e.hasOwnProperty(n)!==i.hasOwnProperty(n)||!En(i[n],e[n]))return!1}return!0}function js(i){if(typeof i!="object"||i==null||Array.isArray(i))return i;var e=[];for(var[t,r]of Object.entries(i))e.push([t,js(r)]);return e.sort((n,a)=>ha(n[0],a[0])),e}function Ll(i){return typeof i=="number"&&isFinite(i)}function qr(i){return typeof i=="string"?rv(i.normalize("NFD").replace(dv,"")):""}function Bs(i){return typeof i=="string"?i.replace(/[\u202d-\u202e]/g,""):""}function lv(i){return qr(i.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var dv=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function Yu(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Xu(i){return Yu(i).replace(/\\\*/g,".*").replace(/\?/g,".")}function ps(i){return i!=null&&i.endsWith("/")?i.slice(0,-1):i}function zr(i,e){return new Promise(t=>{setTimeout(t,i,e)})}function qm(i,e,t){return Ws.apply(this,arguments)}function Ws(){return Ws=T(function*(i,e,t){var r=Date.now();try{return yield t()}finally{var n=Date.now();i.debug("[Perf]: ".concat(e," took ").concat(n-r,"ms"))}}),Ws.apply(this,arguments)}function uv(i,e,t){var r=Date.now();try{return t()}finally{var n=Date.now();i.debug("[Perf]: ".concat(e," took ").concat(n-r,"ms"))}}function Qu(i){return i==null}function fn(i,e){return qs.apply(this,arguments)}function qs(){return qs=T(function*(i,e){for(var t of i)yield e(yield t)}),qs.apply(this,arguments)}function nn(i){return Promise.resolve(i())}function cv(i){return Ju(e=>i(e),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var Rr=(()=>{for(var i="",e=32;e<=126;e++)i+=String.fromCharCode(e);return i})();function Ul(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Rr;return i.padEnd(e,t[0])}function Ii(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Rr,t=BigInt(e.length);if(i<=t){var r;return(r=e[Number(i)-1])!==null&&r!==void 0?r:""}var n=i/t,a=Number(i%t)-1;return a<0&&(n-=BigInt(Math.abs(a)),a=Number(t)-1),Ii(n,e)+e[a]}function ba(i){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Rr,t=BigInt(e.length),r=BigInt(0),n=i.length-1,a=BigInt(0);n>=0;n--,a++){var s=i.charCodeAt(n)-e.charCodeAt(0);r+=BigInt(1+s)*t**a}return r}function hv(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Rr,r=Math.max(i.length,e.length),n=ba(Ul(i,r,t),t),a=ba(Ul(e,r,t),t),s=(n+a)/BigInt(2);return s===n||s==a?Ii(s,t)+t[0]:Ii(s,t)}function Wn(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Rr;return Ii(ba(i,e)+BigInt(1),e)}function Nl(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Rr;return Ii(ba(i,e)-BigInt(1),e)}function ha(i,e){return i<e?-1:i>e?1:0}function Zu(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[r,n]of Object.entries(e)){if(i[r]instanceof Object&&n){Zu(i[r],n);continue}if(n!=null||!t){_a(i,r,n);continue}}return i}function Fl(i){var e;return(e=ur.findIn(i.getContent()))!==null&&e!==void 0?e:-1}function vv(i,e){return Fl(e)-Fl(i)}function go(i){return[ht.Read,ht.ReadPrivate].includes(i)}function xl(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(s,o)=>s===o;if(i.size!==e.size)return!1;for(var[r,n]of i){var a=e.get(r);if(a===void 0||!t(n,a))return!1}return!0}function ec(i){return i instanceof Map?Br(i):Array.isArray(i)?i.map(e=>ec(e)):i}function Br(i){var e=new Map;for(var[t,r]of i)e.set(t,ec(r));return Object.fromEntries(e.entries())}function mi(i){return i==="__proto__"||i==="prototype"||i==="constructor"}function _a(i,e,t){if(mi(e))throw new Error("Trying to modify prototype or constructor");i[e]=t}function Nt(i){return!(mi(i.room_id)||mi(i.sender)||mi(i.event_id))}class or extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var Ks="migrationState",bn=function(i){return i[i.NOT_STARTED=0]="NOT_STARTED",i[i.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",i[i.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",i[i.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",i[i.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",i[i.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",i}({}),_n=50;function jl(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Bl(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jl(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):jl(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function zi(i,e){return encodeURIComponent(i)+"/"+encodeURIComponent(e)}function fv(i){var e=i.split("/"),t=decodeURIComponent(e[0]),r=decodeURIComponent(e[1]);return{senderKey:t,sessionId:r}}class Ni{constructor(){c(this,"migrationState",bn.NOT_STARTED),c(this,"account",null),c(this,"crossSigningKeys",null),c(this,"privateKeys",{}),c(this,"sessions",{}),c(this,"inboundGroupSessions",{}),c(this,"inboundGroupSessionsWithheld",{}),c(this,"rooms",{}),c(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return T(function*(){return e.account!==null})()}startup(){var e=this;return T(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return T(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return T(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){var n=this.privateKeys[r];t(n||null)}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){var r=0;for(var n of Object.values(this.sessions))r+=Object.keys(n).length;t(r)}getEndToEndSession(e,t,r,n){var a=this.sessions[e]||{};n(a[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}storeEndToEndSession(e,t,r,n){var a=this.sessions[e];a===void 0&&(a={},this.sessions[e]=a),_a(a,t,r)}getEndToEndSessionsBatch(){var e=this;return T(function*(){var t=[];for(var r of Object.values(e.sessions))for(var n of Object.values(r))if(t.push(n),t.length>=_n)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return T(function*(){for(var{deviceKey:r,sessionId:n}of e){var a=t.sessions[r]||{};delete a[n],Object.keys(a).length===0&&delete t.sessions[r]}})()}getEndToEndInboundGroupSession(e,t,r,n){var a=zi(e,t);n(this.inboundGroupSessions[a]||null,this.inboundGroupSessionsWithheld[a]||null)}storeEndToEndInboundGroupSession(e,t,r,n){var a=zi(e,t);this.inboundGroupSessions[a]=r}countEndToEndInboundGroupSessions(){var e=this;return T(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return T(function*(){var t=[];for(var[r,n]of Object.entries(e.inboundGroupSessions))if(t.push(Bl(Bl({},fv(r)),{},{sessionData:n,needsBackup:r in e.sessionsNeedingBackup})),t.length>=_n)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return T(function*(){for(var{senderKey:r,sessionId:n}of e){var a=zi(r,n);delete t.inboundGroupSessions[a]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var r=zi(t.senderKey,t.sessionId);this.sessionsNeedingBackup[r]=!0}return Promise.resolve()}doTxn(e,t,r){return Promise.resolve(r(null))}}var pv=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function mv(i){var e=pv.exec(i);return e?.[0]===i}var gv=/^[\w-]+$/;function yv(i){var e=gv.exec(i);return e?.[0]===i}function Fi(i,e,t,r,n){var a=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,s=arguments.length>6?arguments[6]:void 0,o=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return a?e:"";var[l,d,...u]=e.slice(6).split("/");if(u.length>0||!mv(l)||!yv(d))return"";o&&(s=!0);var h,v=!!t||!!r||!!n,m=v?"thumbnail":"download";o?h="/_matrix/client/v1/media/".concat(m):h="/_matrix/media/v3/".concat(m);var f=new URL("".concat(h,"/").concat(l,"/").concat(d),i);return t&&f.searchParams.set("width",Math.round(t).toString()),r&&f.searchParams.set("height",Math.round(r).toString()),n&&f.searchParams.set("method",n),typeof s=="boolean"&&f.searchParams.set("allow_redirect",JSON.stringify(s)),f.href}var va={exports:{}},Sv=va.exports,Wl;function Ev(){return Wl||(Wl=1,function(i){(function(e,t){i.exports?i.exports=t():e.log=t()})(Sv,function(){var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],a={},s=null;function o(g,w){var S=g[w];if(typeof S.bind=="function")return S.bind(g);try{return Function.prototype.bind.call(S,g)}catch{return function(){return Function.prototype.apply.apply(S,[g,arguments])}}}function l(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function d(g){return g==="debug"&&(g="log"),typeof console===t?!1:g==="trace"&&r?l:console[g]!==void 0?o(console,g):console.log!==void 0?o(console,"log"):e}function u(){for(var g=this.getLevel(),w=0;w<n.length;w++){var S=n[w];this[S]=w<g?e:this.methodFactory(S,g,this.name)}if(this.log=this.debug,typeof console===t&&g<this.levels.SILENT)return"No console available for logging"}function h(g){return function(){typeof console!==t&&(u.call(this),this[g].apply(this,arguments))}}function v(g,w,S){return d(g)||h.apply(this,arguments)}function m(g,w){var S=this,R,C,b,_="loglevel";typeof g=="string"?_+=":"+g:typeof g=="symbol"&&(_=void 0);function p(V){var te=(n[V]||"silent").toUpperCase();if(!(typeof window===t||!_)){try{window.localStorage[_]=te;return}catch{}try{window.document.cookie=encodeURIComponent(_)+"="+te+";"}catch{}}}function I(){var V;if(!(typeof window===t||!_)){try{V=window.localStorage[_]}catch{}if(typeof V===t)try{var te=window.document.cookie,ve=encodeURIComponent(_),Oe=te.indexOf(ve+"=");Oe!==-1&&(V=/^([^;]+)/.exec(te.slice(Oe+ve.length+1))[1])}catch{}return S.levels[V]===void 0&&(V=void 0),V}}function y(){if(!(typeof window===t||!_)){try{window.localStorage.removeItem(_)}catch{}try{window.document.cookie=encodeURIComponent(_)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function P(V){var te=V;if(typeof te=="string"&&S.levels[te.toUpperCase()]!==void 0&&(te=S.levels[te.toUpperCase()]),typeof te=="number"&&te>=0&&te<=S.levels.SILENT)return te;throw new TypeError("log.setLevel() called with invalid level: "+V)}S.name=g,S.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},S.methodFactory=w||v,S.getLevel=function(){return b??C??R},S.setLevel=function(V,te){return b=P(V),te!==!1&&p(b),u.call(S)},S.setDefaultLevel=function(V){C=P(V),I()||S.setLevel(V,!1)},S.resetLevel=function(){b=null,y(),u.call(S)},S.enableAll=function(V){S.setLevel(S.levels.TRACE,V)},S.disableAll=function(V){S.setLevel(S.levels.SILENT,V)},S.rebuild=function(){if(s!==S&&(R=P(s.getLevel())),u.call(S),s===S)for(var V in a)a[V].rebuild()},R=P(s?s.getLevel():"WARN");var L=I();L!=null&&(b=P(L)),u.call(S)}s=new m,s.getLogger=function(w){if(typeof w!="symbol"&&typeof w!="string"||w==="")throw new TypeError("You must supply a name when creating a logger.");var S=a[w];return S||(S=a[w]=new m(w,s.methodFactory)),S};var f=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=f),s},s.getLoggers=function(){return a},s.default=s,s})}(va)),va.exports}var bv=Ev();const Vs=mo(bv);var _v="matrix";Vs.methodFactory=function(i,e,t){return function(){for(var r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];this.prefix&&n.unshift(this.prefix);var s=i==="error"||i==="warn"||i==="trace"||i==="info"||i==="debug";return s?console[i](...n):console.log(...n)}};function tc(i){var e=_v+(i===void 0?"":"-".concat(i)),t=Vs.getLogger(e);return t.getChild===void 0&&(t.prefix=i,t.getChild=r=>{var n=tc((i??"")+r);return n.methodFactory=t.methodFactory,n.rebuild(),n},t.setLevel(Vs.levels.DEBUG,!1)),t}var E=tc();class Km{constructor(e,t){this.parent=e,c(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}}var Yi={exports:{}},ql;function Va(){if(ql)return Yi.exports;ql=1;var i=typeof Reflect=="object"?Reflect:null,e=i&&typeof i.apply=="function"?i.apply:function(_,p,I){return Function.prototype.apply.call(_,p,I)},t;i&&typeof i.ownKeys=="function"?t=i.ownKeys:Object.getOwnPropertySymbols?t=function(_){return Object.getOwnPropertyNames(_).concat(Object.getOwnPropertySymbols(_))}:t=function(_){return Object.getOwnPropertyNames(_)};function r(b){console&&console.warn&&console.warn(b)}var n=Number.isNaN||function(_){return _!==_};function a(){a.init.call(this)}Yi.exports=a,Yi.exports.once=S,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var s=10;function o(b){if(typeof b!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof b)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(b){if(typeof b!="number"||b<0||n(b))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+b+".");s=b}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(_){if(typeof _!="number"||_<0||n(_))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+_+".");return this._maxListeners=_,this};function l(b){return b._maxListeners===void 0?a.defaultMaxListeners:b._maxListeners}a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(_){for(var p=[],I=1;I<arguments.length;I++)p.push(arguments[I]);var y=_==="error",P=this._events;if(P!==void 0)y=y&&P.error===void 0;else if(!y)return!1;if(y){var L;if(p.length>0&&(L=p[0]),L instanceof Error)throw L;var V=new Error("Unhandled error."+(L?" ("+L.message+")":""));throw V.context=L,V}var te=P[_];if(te===void 0)return!1;if(typeof te=="function")e(te,this,p);else for(var ve=te.length,Oe=f(te,ve),I=0;I<ve;++I)e(Oe[I],this,p);return!0};function d(b,_,p,I){var y,P,L;if(o(p),P=b._events,P===void 0?(P=b._events=Object.create(null),b._eventsCount=0):(P.newListener!==void 0&&(b.emit("newListener",_,p.listener?p.listener:p),P=b._events),L=P[_]),L===void 0)L=P[_]=p,++b._eventsCount;else if(typeof L=="function"?L=P[_]=I?[p,L]:[L,p]:I?L.unshift(p):L.push(p),y=l(b),y>0&&L.length>y&&!L.warned){L.warned=!0;var V=new Error("Possible EventEmitter memory leak detected. "+L.length+" "+String(_)+" listeners added. Use emitter.setMaxListeners() to increase limit");V.name="MaxListenersExceededWarning",V.emitter=b,V.type=_,V.count=L.length,r(V)}return b}a.prototype.addListener=function(_,p){return d(this,_,p,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(_,p){return d(this,_,p,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(b,_,p){var I={fired:!1,wrapFn:void 0,target:b,type:_,listener:p},y=u.bind(I);return y.listener=p,I.wrapFn=y,y}a.prototype.once=function(_,p){return o(p),this.on(_,h(this,_,p)),this},a.prototype.prependOnceListener=function(_,p){return o(p),this.prependListener(_,h(this,_,p)),this},a.prototype.removeListener=function(_,p){var I,y,P,L,V;if(o(p),y=this._events,y===void 0)return this;if(I=y[_],I===void 0)return this;if(I===p||I.listener===p)--this._eventsCount===0?this._events=Object.create(null):(delete y[_],y.removeListener&&this.emit("removeListener",_,I.listener||p));else if(typeof I!="function"){for(P=-1,L=I.length-1;L>=0;L--)if(I[L]===p||I[L].listener===p){V=I[L].listener,P=L;break}if(P<0)return this;P===0?I.shift():g(I,P),I.length===1&&(y[_]=I[0]),y.removeListener!==void 0&&this.emit("removeListener",_,V||p)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(_){var p,I,y;if(I=this._events,I===void 0)return this;if(I.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):I[_]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete I[_]),this;if(arguments.length===0){var P=Object.keys(I),L;for(y=0;y<P.length;++y)L=P[y],L!=="removeListener"&&this.removeAllListeners(L);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(p=I[_],typeof p=="function")this.removeListener(_,p);else if(p!==void 0)for(y=p.length-1;y>=0;y--)this.removeListener(_,p[y]);return this};function v(b,_,p){var I=b._events;if(I===void 0)return[];var y=I[_];return y===void 0?[]:typeof y=="function"?p?[y.listener||y]:[y]:p?w(y):f(y,y.length)}a.prototype.listeners=function(_){return v(this,_,!0)},a.prototype.rawListeners=function(_){return v(this,_,!1)},a.listenerCount=function(b,_){return typeof b.listenerCount=="function"?b.listenerCount(_):m.call(b,_)},a.prototype.listenerCount=m;function m(b){var _=this._events;if(_!==void 0){var p=_[b];if(typeof p=="function")return 1;if(p!==void 0)return p.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function f(b,_){for(var p=new Array(_),I=0;I<_;++I)p[I]=b[I];return p}function g(b,_){for(;_+1<b.length;_++)b[_]=b[_+1];b.pop()}function w(b){for(var _=new Array(b.length),p=0;p<_.length;++p)_[p]=b[p].listener||b[p];return _}function S(b,_){return new Promise(function(p,I){function y(L){b.removeListener(_,P),I(L)}function P(){typeof b.removeListener=="function"&&b.removeListener("error",y),p([].slice.call(arguments))}C(b,_,P,{once:!0}),_!=="error"&&R(b,y,{once:!0})})}function R(b,_,p){typeof b.on=="function"&&C(b,"error",_,p)}function C(b,_,p,I){if(typeof b.on=="function")I.once?b.once(_,p):b.on(_,p);else if(typeof b.addEventListener=="function")b.addEventListener(_,function y(P){I.once&&b.removeEventListener(_,y),p(P)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof b)}return Yi.exports}var wv=Va(),yo=function(i){return i.NewListener="newListener",i.RemoveListener="removeListener",i.Error="error",i}({});class xe extends wv.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}emitPromised(e){var t=arguments,r=this;return T(function*(){for(var n=t.length,a=new Array(n>1?n-1:0),s=1;s<n;s++)a[s-1]=t[s];var o=r.listeners(e);return Promise.allSettled(o.map(l=>l(...a))).then(()=>o.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var x=function(i){return i.RoomCanonicalAlias="m.room.canonical_alias",i.RoomCreate="m.room.create",i.RoomJoinRules="m.room.join_rules",i.RoomMember="m.room.member",i.RoomThirdPartyInvite="m.room.third_party_invite",i.RoomPowerLevels="m.room.power_levels",i.RoomName="m.room.name",i.RoomTopic="m.room.topic",i.RoomAvatar="m.room.avatar",i.RoomPinnedEvents="m.room.pinned_events",i.RoomEncryption="m.room.encryption",i.RoomHistoryVisibility="m.room.history_visibility",i.RoomGuestAccess="m.room.guest_access",i.RoomServerAcl="m.room.server_acl",i.RoomTombstone="m.room.tombstone",i.RoomPredecessor="org.matrix.msc3946.room_predecessor",i.PolicyRuleUser="m.policy.rule.user",i.PolicyRuleRoom="m.policy.rule.room",i.PolicyRuleServer="m.policy.rule.server",i.SpaceChild="m.space.child",i.SpaceParent="m.space.parent",i.RoomRedaction="m.room.redaction",i.RoomMessage="m.room.message",i.RoomMessageEncrypted="m.room.encrypted",i.Sticker="m.sticker",i.CallInvite="m.call.invite",i.CallCandidates="m.call.candidates",i.CallAnswer="m.call.answer",i.CallHangup="m.call.hangup",i.CallReject="m.call.reject",i.CallSelectAnswer="m.call.select_answer",i.CallNegotiate="m.call.negotiate",i.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",i.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",i.CallReplaces="m.call.replaces",i.CallAssertedIdentity="m.call.asserted_identity",i.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",i.CallEncryptionKeysPrefix="io.element.call.encryption_keys",i.KeyVerificationRequest="m.key.verification.request",i.KeyVerificationStart="m.key.verification.start",i.KeyVerificationCancel="m.key.verification.cancel",i.KeyVerificationMac="m.key.verification.mac",i.KeyVerificationDone="m.key.verification.done",i.KeyVerificationKey="m.key.verification.key",i.KeyVerificationAccept="m.key.verification.accept",i.KeyVerificationReady="m.key.verification.ready",i.RoomMessageFeedback="m.room.message.feedback",i.Reaction="m.reaction",i.PollStart="org.matrix.msc3381.poll.start",i.Typing="m.typing",i.Receipt="m.receipt",i.Presence="m.presence",i.FullyRead="m.fully_read",i.Tag="m.tag",i.SpaceOrder="org.matrix.msc3230.space_order",i.PushRules="m.push_rules",i.Direct="m.direct",i.IgnoredUserList="m.ignored_user_list",i.RoomKey="m.room_key",i.RoomKeyRequest="m.room_key_request",i.ForwardedRoomKey="m.forwarded_room_key",i.Dummy="m.dummy",i.SecretRequest="m.secret.request",i.SecretSend="m.secret.send",i.GroupCallPrefix="org.matrix.msc3401.call",i.GroupCallMemberPrefix="org.matrix.msc3401.call.member",i.CallNotify="org.matrix.msc4075.call.notify",i}({}),Ke=function(i){return i.Annotation="m.annotation",i.Replace="m.replace",i.Reference="m.reference",i.Thread="m.thread",i}({}),Bt=function(i){return i.Text="m.text",i.Emote="m.emote",i.Notice="m.notice",i.Image="m.image",i.File="m.file",i.Audio="m.audio",i.Location="m.location",i.Video="m.video",i.KeyVerificationRequest="m.key.verification.request",i}({}),Ci="type",Kr=function(i){return i.Space="m.space",i.UnstableCall="org.matrix.msc3417.call",i.ElementVideo="io.element.video",i}({}),xi="org.matrix.msgid",wa=new Ye("m.room.purpose","org.matrix.msc3088.purpose"),Ra=new Ye("m.enabled","org.matrix.msc3088.enabled"),Ta=new Ye("m.data_tree","org.matrix.msc3089.data_tree"),So=new Ye("m.leaf","org.matrix.msc3089.leaf"),zt=new Ye("m.branch","org.matrix.msc3089.branch"),Eo=new Ye("m.room.marker","org.matrix.msc2716.marker"),Ia=new Ye("with_rel_types","org.matrix.msc3912.with_relations"),bo=new Ye("io.element.functional_members","io.element.functional_members"),yr=new Ye("m.visibility","org.matrix.msc3531.visibility"),Ca=new Ye("enabled","org.matrix.msc3881.enabled"),rc=new Ye("device_id","org.matrix.msc3881.device_id"),_o=new Ye("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),Oi=new Ye("thread_id","org.matrix.msc4023.thread_id"),wo=new Li("membership","io.element.msc4115.membership"),Ee=function(i){return i.Ban="ban",i.Invite="invite",i.Join="join",i.Knock="knock",i.Leave="leave",i}({}),mt=function(i){return i.Membership="RoomMember.membership",i.Name="RoomMember.name",i.PowerLevel="RoomMember.powerLevel",i.Typing="RoomMember.typing",i}({});class wn extends xe{constructor(e,t){super(),this.roomId=e,this.userId=t,c(this,"_isOutOfBand",!1),c(this,"modified",-1),c(this,"requestedProfileInfo",!1),c(this,"typing",!1),c(this,"name",void 0),c(this,"rawDisplayName",void 0),c(this,"powerLevel",0),c(this,"powerLevelNorm",0),c(this,"user",void 0),c(this,"membership",void 0),c(this,"disambiguate",!1),c(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n,a=(r=e.getDirectionalContent().displayname)!==null&&r!==void 0?r:"";if(e.getType()===x.RoomMember){this._isOutOfBand=!1,this.events.member=e;var s=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&E.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=Iv(this.userId,a,t);var o=this.name;this.name=Cv(this.userId,a,this.disambiguate),this.rawDisplayName=Bs((n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:""),(!this.rawDisplayName||!qr(this.rawDisplayName))&&(this.rawDisplayName=this.userId),s!==this.membership&&(this.updateModifiedTime(),this.emit(mt.Membership,e,this,s)),o!==this.name&&(this.updateModifiedTime(),this.emit(mt.Name,e,this,o))}}setPowerLevelEvent(e){if(!(e.getType()!==x.RoomPowerLevels||e.getStateKey()!=="")){var t=e.getDirectionalContent(),r=t.users_default||0,n=t.users||{};Object.values(n).forEach(o=>{r=Math.max(r,o)});var a=this.powerLevel,s=this.powerLevelNorm;n[this.userId]!==void 0&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:t.users_default!==void 0?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=this.powerLevel*100/r),(a!==this.powerLevel||s!==this.powerLevelNorm)&&(this.updateModifiedTime(),this.emit(mt.PowerLevel,e,this))}}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(r.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(mt.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===Ee.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if(t.membership===Ee.Join&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),t.membership===Ee.Invite&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5?arguments[5]:void 0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:!1,l=this.getMxcAvatarUrl();if(!l&&!a)return null;var d=Fi(e,l,t,r,n,s,void 0,o);return d||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}var Rv=/@.+:.+/,Tv=/[\u200E\u200F\u202A-\u202F]/;function Iv(i,e,t){if(!e||e===i||!t)return!1;var r=qr(e);if(!r)return!1;if(Rv.test(r)||Tv.test(e))return!0;var n=t.getUserIdsWithDisplayName(e);return!!n.some(a=>a!==i)}function Cv(i,e,t){return!e||e===i?i:t?Bs(e)+" ("+i+")":qr(e)?Bs(e):i}var ms={},qn={},Kn={},Kl;function nc(){if(Kl)return Kn;Kl=1,Object.defineProperty(Kn,"__esModule",{value:!0}),Kn.NamespacedMap=void 0;function i(l,d){var u=typeof Symbol<"u"&&l[Symbol.iterator]||l["@@iterator"];if(!u){if(Array.isArray(l)||(u=e(l))||d){u&&(l=u);var h=0,v=function(){};return{s:v,n:function(){return h>=l.length?{done:!0}:{done:!1,value:l[h++]}},e:function(S){throw S},f:v}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var m=!0,f=!1,g;return{s:function(){u=u.call(l)},n:function(){var S=u.next();return m=S.done,S},e:function(S){f=!0,g=S},f:function(){try{!m&&u.return!=null&&u.return()}finally{if(f)throw g}}}}function e(l,d){if(l){if(typeof l=="string")return t(l,d);var u=Object.prototype.toString.call(l).slice(8,-1);if(u==="Object"&&l.constructor&&(u=l.constructor.name),u==="Map"||u==="Set")return Array.from(l);if(u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u))return t(l,d)}}function t(l,d){(d==null||d>l.length)&&(d=l.length);for(var u=0,h=new Array(d);u<d;u++)h[u]=l[u];return h}function r(l,d){if(!(l instanceof d))throw new TypeError("Cannot call a class as a function")}function n(l,d){for(var u=0;u<d.length;u++){var h=d[u];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(l,h.key,h)}}function a(l,d,u){return d&&n(l.prototype,d),Object.defineProperty(l,"prototype",{writable:!1}),l}function s(l,d,u){return d in l?Object.defineProperty(l,d,{value:u,enumerable:!0,configurable:!0,writable:!0}):l[d]=u,l}var o=function(){function l(d){if(r(this,l),s(this,"internalMap",new Map),d){var u=i(d),h;try{for(u.s();!(h=u.n()).done;){var v=h.value;this.set(v[0],v[1])}}catch(m){u.e(m)}finally{u.f()}}}return a(l,[{key:"get",value:function(u){return u.name&&this.internalMap.has(u.name)?this.internalMap.get(u.name):u.altName&&this.internalMap.has(u.altName)?this.internalMap.get(u.altName):null}},{key:"set",value:function(u,h){u.name&&this.internalMap.set(u.name,h),u.altName&&this.internalMap.set(u.altName,h)}},{key:"has",value:function(u){return!!this.get(u)}},{key:"delete",value:function(u){u.name&&this.internalMap.delete(u.name),u.altName&&this.internalMap.delete(u.altName)}},{key:"hasNamespaced",value:function(u){return this.internalMap.has(u)}},{key:"getNamespaced",value:function(u){return this.internalMap.get(u)}}]),l}();return Kn.NamespacedMap=o,Kn}var Vn={},Vl;function Ln(){if(Vl)return Vn;Vl=1;function i(f){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},i(f)}Object.defineProperty(Vn,"__esModule",{value:!0}),Vn.InvalidEventError=void 0;function e(f,g,w){return Object.defineProperty(f,"prototype",{writable:!1}),f}function t(f,g){if(!(f instanceof g))throw new TypeError("Cannot call a class as a function")}function r(f,g){if(typeof g!="function"&&g!==null)throw new TypeError("Super expression must either be null or a function");f.prototype=Object.create(g&&g.prototype,{constructor:{value:f,writable:!0,configurable:!0}}),Object.defineProperty(f,"prototype",{writable:!1}),g&&h(f,g)}function n(f){var g=d();return function(){var S=v(f),R;if(g){var C=v(this).constructor;R=Reflect.construct(S,arguments,C)}else R=S.apply(this,arguments);return a(this,R)}}function a(f,g){if(g&&(i(g)==="object"||typeof g=="function"))return g;if(g!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return s(f)}function s(f){if(f===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return f}function o(f){var g=typeof Map=="function"?new Map:void 0;return o=function(S){if(S===null||!u(S))return S;if(typeof S!="function")throw new TypeError("Super expression must either be null or a function");if(typeof g<"u"){if(g.has(S))return g.get(S);g.set(S,R)}function R(){return l(S,arguments,v(this).constructor)}return R.prototype=Object.create(S.prototype,{constructor:{value:R,enumerable:!1,writable:!0,configurable:!0}}),h(R,S)},o(f)}function l(f,g,w){return d()?l=Reflect.construct:l=function(R,C,b){var _=[null];_.push.apply(_,C);var p=Function.bind.apply(R,_),I=new p;return b&&h(I,b.prototype),I},l.apply(null,arguments)}function d(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function u(f){return Function.toString.call(f).indexOf("[native code]")!==-1}function h(f,g){return h=Object.setPrototypeOf||function(S,R){return S.__proto__=R,S},h(f,g)}function v(f){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(w){return w.__proto__||Object.getPrototypeOf(w)},v(f)}var m=function(f){r(w,f);var g=n(w);function w(S){return t(this,w),g.call(this,S)}return e(w)}(o(Error));return Vn.InvalidEventError=m,Vn}var an={},Gn={},$n={},Gl;function ji(){if(Gl)return $n;Gl=1,Object.defineProperty($n,"__esModule",{value:!0}),$n.ExtensibleEvent=void 0;function i(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}function e(n,a){for(var s=0;s<a.length;s++){var o=a[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}function t(n,a,s){return a&&e(n.prototype,a),Object.defineProperty(n,"prototype",{writable:!1}),n}var r=function(){function n(a){i(this,n),this.wireFormat=a}return t(n,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),n}();return $n.ExtensibleEvent=r,$n}var Hn={},$l;function ic(){if($l)return Hn;$l=1,Object.defineProperty(Hn,"__esModule",{value:!0}),Hn.isOptionalAString=i,Hn.isProvided=e;function i(t){return e(t)&&typeof t=="string"}function e(t){return t!=null}return Hn}var bt={},Or={},Hl;function Un(){if(Hl)return Or;Hl=1;function i(m){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(f){return typeof f}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},i(m)}Object.defineProperty(Or,"__esModule",{value:!0}),Or.UnstableValue=Or.NamespacedValue=void 0;function e(m,f){if(typeof f!="function"&&f!==null)throw new TypeError("Super expression must either be null or a function");m.prototype=Object.create(f&&f.prototype,{constructor:{value:m,writable:!0,configurable:!0}}),Object.defineProperty(m,"prototype",{writable:!1}),f&&t(m,f)}function t(m,f){return t=Object.setPrototypeOf||function(w,S){return w.__proto__=S,w},t(m,f)}function r(m){var f=s();return function(){var w=o(m),S;if(f){var R=o(this).constructor;S=Reflect.construct(w,arguments,R)}else S=w.apply(this,arguments);return n(this,S)}}function n(m,f){if(f&&(i(f)==="object"||typeof f=="function"))return f;if(f!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return a(m)}function a(m){if(m===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return m}function s(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function o(m){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(g){return g.__proto__||Object.getPrototypeOf(g)},o(m)}function l(m,f){if(!(m instanceof f))throw new TypeError("Cannot call a class as a function")}function d(m,f){for(var g=0;g<f.length;g++){var w=f[g];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(m,w.key,w)}}function u(m,f,g){return f&&d(m.prototype,f),Object.defineProperty(m,"prototype",{writable:!1}),m}var h=function(){function m(f,g){if(l(this,m),this.stable=f,this.unstable=g,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return u(m,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(g){return!!this.name&&this.name===g||!!this.altName&&this.altName===g}},{key:"findIn",value:function(g){var w;return this.name&&(w=g?.[this.name]),!w&&this.altName&&(w=g?.[this.altName]),w}},{key:"includedIn",value:function(g){var w=!1;return this.name&&(w=g.includes(this.name)),!w&&this.altName&&(w=g.includes(this.altName)),w}}]),m}();Or.NamespacedValue=h;var v=function(m){e(g,m);var f=r(g);function g(w,S){var R;if(l(this,g),R=f.call(this,w,S),!R.unstable)throw new Error("Unstable value must be supplied");return R}return u(g,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),g}(h);return Or.UnstableValue=v,Or}var Jl;function Qt(){if(Jl)return bt;Jl=1,Object.defineProperty(bt,"__esModule",{value:!0}),bt.M_TEXT=bt.M_NOTICE=bt.M_MESSAGE=bt.M_HTML=bt.M_EMOTE=void 0;var i=Un(),e=new i.UnstableValue("m.message","org.matrix.msc1767.message");bt.M_MESSAGE=e;var t=new i.UnstableValue("m.text","org.matrix.msc1767.text");bt.M_TEXT=t;var r=new i.UnstableValue("m.html","org.matrix.msc1767.html");bt.M_HTML=r;var n=new i.UnstableValue("m.emote","org.matrix.msc1767.emote");bt.M_EMOTE=n;var a=new i.UnstableValue("m.notice","org.matrix.msc1767.notice");return bt.M_NOTICE=a,bt}var Xi={},zl;function Zr(){if(zl)return Xi;zl=1,Object.defineProperty(Xi,"__esModule",{value:!0}),Xi.isEventTypeSame=i;function i(e,t){if(typeof e=="string")return typeof t=="string"?t===e:t.matches(e);if(typeof t=="string")return e.matches(t);var r=t,n=e;return r.matches(n.name)||r.matches(n.altName)}return Xi}var Yl;function en(){if(Yl)return Gn;Yl=1;function i(b){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(_){return typeof _}:function(_){return _&&typeof Symbol=="function"&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},i(b)}Object.defineProperty(Gn,"__esModule",{value:!0}),Gn.MessageEvent=void 0;var e=ji(),t=ic(),r=Ln(),n=Qt(),a=Zr();function s(b,_){var p=Object.keys(b);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(b);_&&(I=I.filter(function(y){return Object.getOwnPropertyDescriptor(b,y).enumerable})),p.push.apply(p,I)}return p}function o(b){for(var _=1;_<arguments.length;_++){var p=arguments[_]!=null?arguments[_]:{};_%2?s(Object(p),!0).forEach(function(I){R(b,I,p[I])}):Object.getOwnPropertyDescriptors?Object.defineProperties(b,Object.getOwnPropertyDescriptors(p)):s(Object(p)).forEach(function(I){Object.defineProperty(b,I,Object.getOwnPropertyDescriptor(p,I))})}return b}function l(b,_){if(!(b instanceof _))throw new TypeError("Cannot call a class as a function")}function d(b,_){for(var p=0;p<_.length;p++){var I=_[p];I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(b,I.key,I)}}function u(b,_,p){return _&&d(b.prototype,_),p&&d(b,p),Object.defineProperty(b,"prototype",{writable:!1}),b}function h(b,_){if(typeof _!="function"&&_!==null)throw new TypeError("Super expression must either be null or a function");b.prototype=Object.create(_&&_.prototype,{constructor:{value:b,writable:!0,configurable:!0}}),Object.defineProperty(b,"prototype",{writable:!1}),_&&v(b,_)}function v(b,_){return v=Object.setPrototypeOf||function(I,y){return I.__proto__=y,I},v(b,_)}function m(b){var _=w();return function(){var I=S(b),y;if(_){var P=S(this).constructor;y=Reflect.construct(I,arguments,P)}else y=I.apply(this,arguments);return f(this,y)}}function f(b,_){if(_&&(i(_)==="object"||typeof _=="function"))return _;if(_!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return g(b)}function g(b){if(b===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b}function w(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function S(b){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(p){return p.__proto__||Object.getPrototypeOf(p)},S(b)}function R(b,_,p){return _ in b?Object.defineProperty(b,_,{value:p,enumerable:!0,configurable:!0,writable:!0}):b[_]=p,b}var C=function(b){h(p,b);var _=m(p);function p(I){var y;l(this,p),y=_.call(this,I),R(g(y),"text",void 0),R(g(y),"html",void 0),R(g(y),"renderings",void 0);var P=n.M_MESSAGE.findIn(y.wireContent),L=n.M_TEXT.findIn(y.wireContent),V=n.M_HTML.findIn(y.wireContent);if((0,t.isProvided)(P)){if(!Array.isArray(P))throw new r.InvalidEventError("m.message contents must be an array");var te=P.find(function(Oe){return!(0,t.isProvided)(Oe.mimetype)||Oe.mimetype==="text/plain"}),ve=P.find(function(Oe){return Oe.mimetype==="text/html"});if(!te)throw new r.InvalidEventError("m.message is missing a plain text representation");y.text=te.body,y.html=ve?.body,y.renderings=P}else if((0,t.isOptionalAString)(L))y.text=L,y.html=V,y.renderings=[{body:L,mimetype:"text/plain"}],y.html&&y.renderings.push({body:y.html,mimetype:"text/html"});else throw new r.InvalidEventError("Missing textual representation for event");return y}return u(p,[{key:"isEmote",get:function(){return n.M_EMOTE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return n.M_NOTICE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(y){return(0,a.isEventTypeSame)(y,n.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var y=R({},n.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var P=this.renderings[0].mimetype;(P===void 0||P==="text/plain")&&(y=R({},n.M_TEXT.name,this.renderings[0].body))}return y}},{key:"serialize",value:function(){var y;return{type:"m.room.message",content:o(o({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(y=this.html)!==null&&y!==void 0?y:void 0})}}}],[{key:"from",value:function(y,P){var L;return new p({type:n.M_MESSAGE.name,content:(L={},R(L,n.M_TEXT.name,y),R(L,n.M_HTML.name,P),L)})}}]),p}(e.ExtensibleEvent);return Gn.MessageEvent=C,Gn}var Jn={},Xl;function Ro(){if(Xl)return Jn;Xl=1;function i(R){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},i(R)}Object.defineProperty(Jn,"__esModule",{value:!0}),Jn.NoticeEvent=void 0;var e=en(),t=Qt(),r=Zr();function n(R,C,b){return C in R?Object.defineProperty(R,C,{value:b,enumerable:!0,configurable:!0,writable:!0}):R[C]=b,R}function a(R,C){if(!(R instanceof C))throw new TypeError("Cannot call a class as a function")}function s(R,C){for(var b=0;b<C.length;b++){var _=C[b];_.enumerable=_.enumerable||!1,_.configurable=!0,"value"in _&&(_.writable=!0),Object.defineProperty(R,_.key,_)}}function o(R,C,b){return C&&s(R.prototype,C),b&&s(R,b),Object.defineProperty(R,"prototype",{writable:!1}),R}function l(){return typeof Reflect<"u"&&Reflect.get?l=Reflect.get:l=function(C,b,_){var p=d(C,b);if(p){var I=Object.getOwnPropertyDescriptor(p,b);return I.get?I.get.call(arguments.length<3?C:_):I.value}},l.apply(this,arguments)}function d(R,C){for(;!Object.prototype.hasOwnProperty.call(R,C)&&(R=w(R),R!==null););return R}function u(R,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");R.prototype=Object.create(C&&C.prototype,{constructor:{value:R,writable:!0,configurable:!0}}),Object.defineProperty(R,"prototype",{writable:!1}),C&&h(R,C)}function h(R,C){return h=Object.setPrototypeOf||function(_,p){return _.__proto__=p,_},h(R,C)}function v(R){var C=g();return function(){var _=w(R),p;if(C){var I=w(this).constructor;p=Reflect.construct(_,arguments,I)}else p=_.apply(this,arguments);return m(this,p)}}function m(R,C){if(C&&(i(C)==="object"||typeof C=="function"))return C;if(C!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return f(R)}function f(R){if(R===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return R}function g(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function w(R){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},w(R)}var S=function(R){u(b,R);var C=v(b);function b(_){return a(this,b),C.call(this,_)}return o(b,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(p){return(0,r.isEventTypeSame)(p,t.M_NOTICE)||l(w(b.prototype),"isEquivalentTo",this).call(this,p)}},{key:"serialize",value:function(){var p=l(w(b.prototype),"serialize",this).call(this);return p.content.msgtype="m.notice",p}}],[{key:"from",value:function(p,I){var y;return new b({type:t.M_NOTICE.name,content:(y={},n(y,t.M_TEXT.name,p),n(y,t.M_HTML.name,I),y)})}}]),b}(e.MessageEvent);return Jn.NoticeEvent=S,Jn}var zn={},Ql;function To(){if(Ql)return zn;Ql=1;function i(R){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},i(R)}Object.defineProperty(zn,"__esModule",{value:!0}),zn.EmoteEvent=void 0;var e=en(),t=Qt(),r=Zr();function n(R,C,b){return C in R?Object.defineProperty(R,C,{value:b,enumerable:!0,configurable:!0,writable:!0}):R[C]=b,R}function a(R,C){if(!(R instanceof C))throw new TypeError("Cannot call a class as a function")}function s(R,C){for(var b=0;b<C.length;b++){var _=C[b];_.enumerable=_.enumerable||!1,_.configurable=!0,"value"in _&&(_.writable=!0),Object.defineProperty(R,_.key,_)}}function o(R,C,b){return C&&s(R.prototype,C),b&&s(R,b),Object.defineProperty(R,"prototype",{writable:!1}),R}function l(){return typeof Reflect<"u"&&Reflect.get?l=Reflect.get:l=function(C,b,_){var p=d(C,b);if(p){var I=Object.getOwnPropertyDescriptor(p,b);return I.get?I.get.call(arguments.length<3?C:_):I.value}},l.apply(this,arguments)}function d(R,C){for(;!Object.prototype.hasOwnProperty.call(R,C)&&(R=w(R),R!==null););return R}function u(R,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");R.prototype=Object.create(C&&C.prototype,{constructor:{value:R,writable:!0,configurable:!0}}),Object.defineProperty(R,"prototype",{writable:!1}),C&&h(R,C)}function h(R,C){return h=Object.setPrototypeOf||function(_,p){return _.__proto__=p,_},h(R,C)}function v(R){var C=g();return function(){var _=w(R),p;if(C){var I=w(this).constructor;p=Reflect.construct(_,arguments,I)}else p=_.apply(this,arguments);return m(this,p)}}function m(R,C){if(C&&(i(C)==="object"||typeof C=="function"))return C;if(C!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return f(R)}function f(R){if(R===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return R}function g(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function w(R){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},w(R)}var S=function(R){u(b,R);var C=v(b);function b(_){return a(this,b),C.call(this,_)}return o(b,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(p){return(0,r.isEventTypeSame)(p,t.M_EMOTE)||l(w(b.prototype),"isEquivalentTo",this).call(this,p)}},{key:"serialize",value:function(){var p=l(w(b.prototype),"serialize",this).call(this);return p.content.msgtype="m.emote",p}}],[{key:"from",value:function(p,I){var y;return new b({type:t.M_EMOTE.name,content:(y={},n(y,t.M_TEXT.name,p),n(y,t.M_HTML.name,I),y)})}}]),b}(e.MessageEvent);return zn.EmoteEvent=S,zn}var Zl;function ac(){if(Zl)return an;Zl=1,Object.defineProperty(an,"__esModule",{value:!0}),an.LEGACY_M_ROOM_MESSAGE=void 0,an.parseMRoomMessage=d;var i=en(),e=Ro(),t=To(),r=Un(),n=Qt();function a(u,h){var v=Object.keys(u);if(Object.getOwnPropertySymbols){var m=Object.getOwnPropertySymbols(u);h&&(m=m.filter(function(f){return Object.getOwnPropertyDescriptor(u,f).enumerable})),v.push.apply(v,m)}return v}function s(u){for(var h=1;h<arguments.length;h++){var v=arguments[h]!=null?arguments[h]:{};h%2?a(Object(v),!0).forEach(function(m){o(u,m,v[m])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(v)):a(Object(v)).forEach(function(m){Object.defineProperty(u,m,Object.getOwnPropertyDescriptor(v,m))})}return u}function o(u,h,v){return h in u?Object.defineProperty(u,h,{value:v,enumerable:!0,configurable:!0,writable:!0}):u[h]=v,u}var l=new r.NamespacedValue("m.room.message");an.LEGACY_M_ROOM_MESSAGE=l;function d(u){var h,v,m;if(n.M_MESSAGE.findIn(u.content)||n.M_TEXT.findIn(u.content))return new i.MessageEvent(u);var f=(h=u.content)===null||h===void 0?void 0:h.msgtype,g=(v=u.content)===null||v===void 0?void 0:v.body,w=((m=u.content)===null||m===void 0?void 0:m.format)==="org.matrix.custom.html"?u.content.formatted_body:null;if(f==="m.text"){var S;return new i.MessageEvent(s(s({},u),{},{content:s(s({},u.content),{},(S={},o(S,n.M_TEXT.name,g),o(S,n.M_HTML.name,w),S))}))}else if(f==="m.notice"){var R;return new e.NoticeEvent(s(s({},u),{},{content:s(s({},u.content),{},(R={},o(R,n.M_TEXT.name,g),o(R,n.M_HTML.name,w),R))}))}else if(f==="m.emote"){var C;return new t.EmoteEvent(s(s({},u),{},{content:s(s({},u.content),{},(C={},o(C,n.M_TEXT.name,g),o(C,n.M_HTML.name,w),C))}))}else return null}return an}var Qi={},ed;function sc(){if(ed)return Qi;ed=1,Object.defineProperty(Qi,"__esModule",{value:!0}),Qi.parseMMessage=n;var i=en(),e=Qt(),t=To(),r=Ro();function n(a){return e.M_EMOTE.matches(a.type)?new t.EmoteEvent(a):e.M_NOTICE.matches(a.type)?new r.NoticeEvent(a):new i.MessageEvent(a)}return Qi}var _t={},td;function Nn(){if(td)return _t;td=1,Object.defineProperty(_t,"__esModule",{value:!0}),_t.M_POLL_START=_t.M_POLL_RESPONSE=_t.M_POLL_KIND_UNDISCLOSED=_t.M_POLL_KIND_DISCLOSED=_t.M_POLL_END=void 0;var i=Un(),e=new i.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");_t.M_POLL_KIND_DISCLOSED=e;var t=new i.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");_t.M_POLL_KIND_UNDISCLOSED=t;var r=new i.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");_t.M_POLL_START=r;var n=new i.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");_t.M_POLL_RESPONSE=n;var a=new i.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");return _t.M_POLL_END=a,_t}var Zi={},Mr={},rd;function oc(){if(rd)return Mr;rd=1;function i(H){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(ee){return typeof ee}:function(ee){return ee&&typeof Symbol=="function"&&ee.constructor===Symbol&&ee!==Symbol.prototype?"symbol":typeof ee},i(H)}Object.defineProperty(Mr,"__esModule",{value:!0}),Mr.PollStartEvent=Mr.PollAnswerSubevent=void 0;var e=Nn(),t=en(),r=Qt(),n=Ln(),a=Un(),s=Zr(),o=ji();function l(H){return v(H)||h(H)||u(H)||d()}function d(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function u(H,ee){if(H){if(typeof H=="string")return m(H,ee);var se=Object.prototype.toString.call(H).slice(8,-1);if(se==="Object"&&H.constructor&&(se=H.constructor.name),se==="Map"||se==="Set")return Array.from(H);if(se==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(se))return m(H,ee)}}function h(H){if(typeof Symbol<"u"&&H[Symbol.iterator]!=null||H["@@iterator"]!=null)return Array.from(H)}function v(H){if(Array.isArray(H))return m(H)}function m(H,ee){(ee==null||ee>H.length)&&(ee=H.length);for(var se=0,de=new Array(ee);se<ee;se++)de[se]=H[se];return de}function f(H,ee){var se=Object.keys(H);if(Object.getOwnPropertySymbols){var de=Object.getOwnPropertySymbols(H);ee&&(de=de.filter(function(fe){return Object.getOwnPropertyDescriptor(H,fe).enumerable})),se.push.apply(se,de)}return se}function g(H){for(var ee=1;ee<arguments.length;ee++){var se=arguments[ee]!=null?arguments[ee]:{};ee%2?f(Object(se),!0).forEach(function(de){L(H,de,se[de])}):Object.getOwnPropertyDescriptors?Object.defineProperties(H,Object.getOwnPropertyDescriptors(se)):f(Object(se)).forEach(function(de){Object.defineProperty(H,de,Object.getOwnPropertyDescriptor(se,de))})}return H}function w(H,ee){if(!(H instanceof ee))throw new TypeError("Cannot call a class as a function")}function S(H,ee){for(var se=0;se<ee.length;se++){var de=ee[se];de.enumerable=de.enumerable||!1,de.configurable=!0,"value"in de&&(de.writable=!0),Object.defineProperty(H,de.key,de)}}function R(H,ee,se){return ee&&S(H.prototype,ee),se&&S(H,se),Object.defineProperty(H,"prototype",{writable:!1}),H}function C(H,ee){if(typeof ee!="function"&&ee!==null)throw new TypeError("Super expression must either be null or a function");H.prototype=Object.create(ee&&ee.prototype,{constructor:{value:H,writable:!0,configurable:!0}}),Object.defineProperty(H,"prototype",{writable:!1}),ee&&b(H,ee)}function b(H,ee){return b=Object.setPrototypeOf||function(de,fe){return de.__proto__=fe,de},b(H,ee)}function _(H){var ee=y();return function(){var de=P(H),fe;if(ee){var Te=P(this).constructor;fe=Reflect.construct(de,arguments,Te)}else fe=de.apply(this,arguments);return p(this,fe)}}function p(H,ee){if(ee&&(i(ee)==="object"||typeof ee=="function"))return ee;if(ee!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return I(H)}function I(H){if(H===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return H}function y(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function P(H){return P=Object.setPrototypeOf?Object.getPrototypeOf:function(se){return se.__proto__||Object.getPrototypeOf(se)},P(H)}function L(H,ee,se){return ee in H?Object.defineProperty(H,ee,{value:se,enumerable:!0,configurable:!0,writable:!0}):H[ee]=se,H}var V=function(H){C(se,H);var ee=_(se);function se(de){var fe;w(this,se),fe=ee.call(this,de),L(I(fe),"id",void 0);var Te=de.content.id;if(!Te||typeof Te!="string")throw new n.InvalidEventError("Answer ID must be a non-empty string");return fe.id=Te,fe}return R(se,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:g({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(fe,Te){return new se({type:"org.matrix.sdk.poll.answer",content:L({id:fe},r.M_TEXT.name,Te)})}}]),se}(t.MessageEvent);Mr.PollAnswerSubevent=V;var te=function(H){C(se,H);var ee=_(se);function se(de){var fe;w(this,se),fe=ee.call(this,de),L(I(fe),"question",void 0),L(I(fe),"kind",void 0),L(I(fe),"rawKind",void 0),L(I(fe),"maxSelections",void 0),L(I(fe),"answers",void 0);var Te=e.M_POLL_START.findIn(fe.wireContent);if(!Te.question)throw new n.InvalidEventError("A question is required");if(fe.question=new t.MessageEvent({type:"org.matrix.sdk.poll.question",content:Te.question}),fe.rawKind=Te.kind,e.M_POLL_KIND_DISCLOSED.matches(fe.rawKind)?fe.kind=e.M_POLL_KIND_DISCLOSED:fe.kind=e.M_POLL_KIND_UNDISCLOSED,fe.maxSelections=Number.isFinite(Te.max_selections)&&Te.max_selections>0?Te.max_selections:1,!Array.isArray(Te.answers))throw new n.InvalidEventError("Poll answers must be an array");var Ze=Te.answers.slice(0,20).map(function($){return new V({type:"org.matrix.sdk.poll.answer",content:$})});if(Ze.length<=0)throw new n.InvalidEventError("No answers available");return fe.answers=Ze,fe}return R(se,[{key:"isEquivalentTo",value:function(fe){return(0,s.isEventTypeSame)(fe,e.M_POLL_START)}},{key:"serialize",value:function(){var fe;return{type:e.M_POLL_START.name,content:(fe={},L(fe,e.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(Te){return Te.serialize().content})}),L(fe,r.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(Te,Ze){return"".concat(Ze+1,". ").concat(Te.text)}).join(`
`))),fe)}}}],[{key:"from",value:function(fe,Te,Ze){var $,X=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new se({type:e.M_POLL_START.name,content:($={},L($,r.M_TEXT.name,fe),L($,e.M_POLL_START.name,{question:L({},r.M_TEXT.name,fe),kind:Ze instanceof a.NamespacedValue?Ze.name:Ze,max_selections:X,answers:Te.map(function(F){return L({id:Oe()},r.M_TEXT.name,F)})}),$)})}}]),se}(o.ExtensibleEvent);Mr.PollStartEvent=te;var ve="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Oe(){return l(Array(16)).map(function(){return ve.charAt(Math.floor(Math.random()*ve.length))}).join("")}return Mr}var Yn={},Xn={},nd;function Io(){if(nd)return Xn;nd=1,Object.defineProperty(Xn,"__esModule",{value:!0}),Xn.REFERENCE_RELATION=void 0;var i=Un(),e=new i.NamespacedValue("m.reference");return Xn.REFERENCE_RELATION=e,Xn}var id;function lc(){if(id)return Yn;id=1;function i(R){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(C){return typeof C}:function(C){return C&&typeof Symbol=="function"&&C.constructor===Symbol&&C!==Symbol.prototype?"symbol":typeof C},i(R)}Object.defineProperty(Yn,"__esModule",{value:!0}),Yn.PollResponseEvent=void 0;var e=ji(),t=Nn(),r=Ln(),n=Io(),a=Zr();function s(R,C){if(!(R instanceof C))throw new TypeError("Cannot call a class as a function")}function o(R,C){for(var b=0;b<C.length;b++){var _=C[b];_.enumerable=_.enumerable||!1,_.configurable=!0,"value"in _&&(_.writable=!0),Object.defineProperty(R,_.key,_)}}function l(R,C,b){return C&&o(R.prototype,C),b&&o(R,b),Object.defineProperty(R,"prototype",{writable:!1}),R}function d(R,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");R.prototype=Object.create(C&&C.prototype,{constructor:{value:R,writable:!0,configurable:!0}}),Object.defineProperty(R,"prototype",{writable:!1}),C&&u(R,C)}function u(R,C){return u=Object.setPrototypeOf||function(_,p){return _.__proto__=p,_},u(R,C)}function h(R){var C=f();return function(){var _=g(R),p;if(C){var I=g(this).constructor;p=Reflect.construct(_,arguments,I)}else p=_.apply(this,arguments);return v(this,p)}}function v(R,C){if(C&&(i(C)==="object"||typeof C=="function"))return C;if(C!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return m(R)}function m(R){if(R===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return R}function f(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function g(R){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},g(R)}function w(R,C,b){return C in R?Object.defineProperty(R,C,{value:b,enumerable:!0,configurable:!0,writable:!0}):R[C]=b,R}var S=function(R){d(b,R);var C=h(b);function b(_){var p;s(this,b),p=C.call(this,_),w(m(p),"internalAnswerIds",void 0),w(m(p),"internalSpoiled",void 0),w(m(p),"pollEventId",void 0);var I=p.wireContent["m.relates_to"];if(!n.REFERENCE_RELATION.matches(I?.rel_type)||typeof I?.event_id!="string")throw new r.InvalidEventError("Relationship must be a reference to an event");return p.pollEventId=I.event_id,p.validateAgainst(null),p}return l(b,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(p){var I=t.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(I?.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var y=I.answers;if(y.some(function(P){return typeof P!="string"})||y.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(p){if(y.some(function(P){return!p.answers.some(function(L){return L.id===P})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}y=y.slice(0,p.maxSelections)}this.internalAnswerIds=y,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(p){return(0,a.isEventTypeSame)(p,t.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:t.M_POLL_RESPONSE.name,content:w({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:this.pollEventId}},t.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(p,I){return new b({type:t.M_POLL_RESPONSE.name,content:w({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:I}},t.M_POLL_RESPONSE.name,{answers:p})})}}]),b}(e.ExtensibleEvent);return Yn.PollResponseEvent=S,Yn}var Qn={},ad;function dc(){if(ad)return Qn;ad=1;function i(p){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},i(p)}Object.defineProperty(Qn,"__esModule",{value:!0}),Qn.PollEndEvent=void 0;var e=Nn(),t=Ln(),r=Io(),n=en(),a=Qt(),s=Zr(),o=ji();function l(p,I){var y=Object.keys(p);if(Object.getOwnPropertySymbols){var P=Object.getOwnPropertySymbols(p);I&&(P=P.filter(function(L){return Object.getOwnPropertyDescriptor(p,L).enumerable})),y.push.apply(y,P)}return y}function d(p){for(var I=1;I<arguments.length;I++){var y=arguments[I]!=null?arguments[I]:{};I%2?l(Object(y),!0).forEach(function(P){b(p,P,y[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(y)):l(Object(y)).forEach(function(P){Object.defineProperty(p,P,Object.getOwnPropertyDescriptor(y,P))})}return p}function u(p,I){if(!(p instanceof I))throw new TypeError("Cannot call a class as a function")}function h(p,I){for(var y=0;y<I.length;y++){var P=I[y];P.enumerable=P.enumerable||!1,P.configurable=!0,"value"in P&&(P.writable=!0),Object.defineProperty(p,P.key,P)}}function v(p,I,y){return I&&h(p.prototype,I),y&&h(p,y),Object.defineProperty(p,"prototype",{writable:!1}),p}function m(p,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(I&&I.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),I&&f(p,I)}function f(p,I){return f=Object.setPrototypeOf||function(P,L){return P.__proto__=L,P},f(p,I)}function g(p){var I=R();return function(){var P=C(p),L;if(I){var V=C(this).constructor;L=Reflect.construct(P,arguments,V)}else L=P.apply(this,arguments);return w(this,L)}}function w(p,I){if(I&&(i(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return S(p)}function S(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function R(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function C(p){return C=Object.setPrototypeOf?Object.getPrototypeOf:function(y){return y.__proto__||Object.getPrototypeOf(y)},C(p)}function b(p,I,y){return I in p?Object.defineProperty(p,I,{value:y,enumerable:!0,configurable:!0,writable:!0}):p[I]=y,p}var _=function(p){m(y,p);var I=g(y);function y(P){var L;u(this,y),L=I.call(this,P),b(S(L),"pollEventId",void 0),b(S(L),"closingMessage",void 0);var V=L.wireContent["m.relates_to"];if(!r.REFERENCE_RELATION.matches(V?.rel_type)||typeof V?.event_id!="string")throw new t.InvalidEventError("Relationship must be a reference to an event");return L.pollEventId=V.event_id,L.closingMessage=new n.MessageEvent(L.wireFormat),L}return v(y,[{key:"isEquivalentTo",value:function(L){return(0,s.isEventTypeSame)(L,e.M_POLL_END)}},{key:"serialize",value:function(){return{type:e.M_POLL_END.name,content:d(b({"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:this.pollEventId}},e.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(L,V){var te;return new y({type:e.M_POLL_END.name,content:(te={"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:L}},b(te,e.M_POLL_END.name,{}),b(te,a.M_TEXT.name,V),te)})}}]),y}(o.ExtensibleEvent);return Qn.PollEndEvent=_,Qn}var sd;function uc(){if(sd)return Zi;sd=1,Object.defineProperty(Zi,"__esModule",{value:!0}),Zi.parseMPoll=n;var i=Nn(),e=oc(),t=lc(),r=dc();function n(a){return i.M_POLL_START.matches(a.type)?new e.PollStartEvent(a):i.M_POLL_RESPONSE.matches(a.type)?new t.PollResponseEvent(a):i.M_POLL_END.matches(a.type)?new r.PollEndEvent(a):null}return Zi}var od;function Ov(){if(od)return qn;od=1,Object.defineProperty(qn,"__esModule",{value:!0}),qn.ExtensibleEvents=void 0;var i=nc(),e=Ln(),t=ac(),r=sc(),n=Qt(),a=Nn(),s=uc();function o(g,w){var S=typeof Symbol<"u"&&g[Symbol.iterator]||g["@@iterator"];if(!S){if(Array.isArray(g)||(S=l(g))||w){S&&(g=S);var R=0,C=function(){};return{s:C,n:function(){return R>=g.length?{done:!0}:{done:!1,value:g[R++]}},e:function(y){throw y},f:C}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var b=!0,_=!1,p;return{s:function(){S=S.call(g)},n:function(){var y=S.next();return b=y.done,y},e:function(y){_=!0,p=y},f:function(){try{!b&&S.return!=null&&S.return()}finally{if(_)throw p}}}}function l(g,w){if(g){if(typeof g=="string")return d(g,w);var S=Object.prototype.toString.call(g).slice(8,-1);if(S==="Object"&&g.constructor&&(S=g.constructor.name),S==="Map"||S==="Set")return Array.from(g);if(S==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(S))return d(g,w)}}function d(g,w){(w==null||w>g.length)&&(w=g.length);for(var S=0,R=new Array(w);S<w;S++)R[S]=g[S];return R}function u(g,w){if(!(g instanceof w))throw new TypeError("Cannot call a class as a function")}function h(g,w){for(var S=0;S<w.length;S++){var R=w[S];R.enumerable=R.enumerable||!1,R.configurable=!0,"value"in R&&(R.writable=!0),Object.defineProperty(g,R.key,R)}}function v(g,w,S){return w&&h(g.prototype,w),S&&h(g,S),Object.defineProperty(g,"prototype",{writable:!1}),g}function m(g,w,S){return w in g?Object.defineProperty(g,w,{value:S,enumerable:!0,configurable:!0,writable:!0}):g[w]=S,g}var f=function(){function g(){u(this,g),m(this,"interpreters",new i.NamespacedMap([[t.LEGACY_M_ROOM_MESSAGE,t.parseMRoomMessage],[n.M_MESSAGE,r.parseMMessage],[n.M_EMOTE,r.parseMMessage],[n.M_NOTICE,r.parseMMessage],[a.M_POLL_START,s.parseMPoll],[a.M_POLL_RESPONSE,s.parseMPoll],[a.M_POLL_END,s.parseMPoll]])),m(this,"_unknownInterpretOrder",[n.M_MESSAGE])}return v(g,[{key:"unknownInterpretOrder",get:function(){var S;return(S=this._unknownInterpretOrder)!==null&&S!==void 0?S:[]},set:function(S){this._unknownInterpretOrder=S}},{key:"registerInterpreter",value:function(S,R){this.interpreters.set(S,R)}},{key:"parse",value:function(S){try{if(this.interpreters.hasNamespaced(S.type))return this.interpreters.getNamespaced(S.type)(S);var R=o(this.unknownInterpretOrder),C;try{for(R.s();!(C=R.n()).done;){var b=C.value;if(this.interpreters.has(b)){var _=this.interpreters.get(b)(S);if(_)return _}}}catch(p){R.e(p)}finally{R.f()}return null}catch(p){if(p instanceof e.InvalidEventError)return null;throw p}}}],[{key:"defaultInstance",get:function(){return g._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return g.defaultInstance.unknownInterpretOrder},set:function(S){g.defaultInstance.unknownInterpretOrder=S}},{key:"registerInterpreter",value:function(S,R){g.defaultInstance.registerInterpreter(S,R)}},{key:"parse",value:function(S){return g.defaultInstance.parse(S)}}]),g}();return qn.ExtensibleEvents=f,m(f,"_defaultInstance",new f),qn}var gs={},ld;function Mv(){return ld||(ld=1,Object.defineProperty(gs,"__esModule",{value:!0})),gs}var Pr={},dd;function Pv(){if(dd)return Pr;dd=1,Object.defineProperty(Pr,"__esModule",{value:!0}),Pr.LegacyMsgType=void 0,Pr.isEventLike=t;var i=Qt(),e;Pr.LegacyMsgType=e,function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"}(e||(Pr.LegacyMsgType=e={}));function t(r,n){var a=r.content;return n===e.Text?i.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&a?.msgtype==="m.text":n===e.Emote?i.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&a?.msgtype==="m.emote":n===e.Notice?i.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&a?.msgtype==="m.notice":!1}return Pr}var ud;function kv(){return ud||(ud=1,function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=Ov();Object.keys(e).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===e[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return e[p]}})});var t=Mv();Object.keys(t).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===t[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return t[p]}})});var r=Ln();Object.keys(r).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===r[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return r[p]}})});var n=Un();Object.keys(n).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===n[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return n[p]}})});var a=nc();Object.keys(a).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===a[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return a[p]}})});var s=ic();Object.keys(s).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===s[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return s[p]}})});var o=Pv();Object.keys(o).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===o[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return o[p]}})});var l=Zr();Object.keys(l).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===l[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return l[p]}})});var d=ac();Object.keys(d).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===d[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return d[p]}})});var u=sc();Object.keys(u).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===u[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return u[p]}})});var h=uc();Object.keys(h).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===h[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return h[p]}})});var v=Io();Object.keys(v).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===v[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return v[p]}})});var m=ji();Object.keys(m).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===m[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return m[p]}})});var f=Qt();Object.keys(f).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===f[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return f[p]}})});var g=en();Object.keys(g).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===g[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return g[p]}})});var w=To();Object.keys(w).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===w[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return w[p]}})});var S=Ro();Object.keys(S).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===S[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return S[p]}})});var R=Nn();Object.keys(R).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===R[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return R[p]}})});var C=oc();Object.keys(C).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===C[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return C[p]}})});var b=lc();Object.keys(b).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===b[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return b[p]}})});var _=dc();Object.keys(_).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===_[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return _[p]}})})}(ms)),ms}var Et=kv();function Av(i,e){if(i==null)return{};var t={};for(var r in i)if({}.hasOwnProperty.call(i,r)){if(e.indexOf(r)!==-1)continue;t[r]=i[r]}return t}function Dv(i,e){if(i==null)return{};var t,r,n=Av(i,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(i);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(i,t)&&(n[t]=i[t])}return n}var yt=function(i){return i.DisplayName="User.displayName",i.AvatarUrl="User.avatarUrl",i.Presence="User.presence",i.CurrentlyActive="User.currentlyActive",i.LastPresenceTs="User.lastPresenceTs",i}({});class Xt extends xe{constructor(e){super(),this.userId=e,c(this,"modified",-1),c(this,"displayName",void 0),c(this,"rawDisplayName",void 0),c(this,"avatarUrl",void 0),c(this,"presenceStatusMsg",void 0),c(this,"presence","offline"),c(this,"lastActiveAgo",0),c(this,"lastPresenceTs",0),c(this,"currentlyActive",!1),c(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var r=new Xt(e);return t.reEmitter.reEmit(r,[yt.AvatarUrl,yt.DisplayName,yt.Presence,yt.CurrentlyActive,yt.LastPresenceTs]),r}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var r=[];(e.getContent().presence!==this.presence||t)&&r.push(yt.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(yt.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(yt.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&r.push(yt.CurrentlyActive),this.presence=e.getContent().presence,r.push(yt.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var n of r)this.emit(n,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var be=function(i){return i.Backward="b",i.Forward="f",i}({});class Z{static setEventMetadata(e,t,r){e.setMetadata(t,r)}constructor(e){var t,r;this.eventTimelineSet=e,c(this,"roomId",void 0),c(this,"name",void 0),c(this,"events",[]),c(this,"baseIndex",0),c(this,"startState",void 0),c(this,"endState",void 0),c(this,"startToken",null),c(this,"endToken",null),c(this,"prevTimeline",null),c(this,"nextTimeline",null),c(this,"paginationRequests",{[be.Backward]:null,[be.Forward]:null}),this.roomId=(t=(r=e.room)===null||r===void 0?void 0:r.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new Pn(this.roomId),this.endState=new Pn(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,r,{timelineWasEmpty:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:n}),(r=this.endState)===null||r===void 0||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){var t=this.getState(e),r=new Z(this.eventTimelineSet);return r.startState=t?.clone(),r.endState=t,this.endState=t?.clone(),r}fork(e){var t=this.getState(e),r=new Z(this.eventTimelineSet);return r.startState=t?.clone(),r.endState=t?.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==Z.BACKWARDS)return this.startState;if(e==Z.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===be.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===be.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==Z.BACKWARDS)return this.prevTimeline;if(e==Z.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==Z.BACKWARDS)this.prevTimeline=e;else if(t==Z.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:r,roomState:n,timelineWasEmpty:a,addToState:s}=t;n||(n=r?this.startState:this.endState);var o=this.getTimelineSet();if(o.room&&(Z.setEventMetadata(e,n,r),s&&e.isState()&&o.room.getUnfilteredTimelineSet()===o)){var l;(l=n)===null||l===void 0||l.setStateEvents([e],{timelineWasEmpty:a}),(!e.sender||e.getType()===x.RoomMember&&!r)&&Z.setEventMetadata(e,n,r)}var d;r?d=0:d=this.events.length,this.events.splice(d,0,e),r&&this.baseIndex++}insertEvent(e,t,r,n){var a=this.getTimelineSet();a.room&&(Z.setEventMetadata(e,r,!1),n&&e.isState()&&a.room.getUnfilteredTimelineSet()===a&&(r.setStateEvents([e],{}),(!e.sender||e.getType()===x.RoomMember)&&Z.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}}c(Z,"BACKWARDS",be.Backward);c(Z,"FORWARDS",be.Forward);var gi=function(i){return i.Add="Relations.add",i.Remove="Relations.remove",i.Redaction="Relations.redaction",i}({}),Lv=function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...r].includes(e)};class Ga extends xe{constructor(e,t,r,n){var a;super(),a=this,this.relationType=e,this.eventType=t,this.altEventTypes=n,c(this,"relationEventIds",new Set),c(this,"relations",new Set),c(this,"annotationsByKey",{}),c(this,"annotationsBySender",{}),c(this,"sortedAnnotationsByKey",[]),c(this,"targetEvent",null),c(this,"creationEmitted",!1),c(this,"client",void 0),c(this,"onEventStatus",(s,o)=>{if(!s.isSending()){s.removeListener(Pe.Status,this.onEventStatus);return}o===pe.CANCELLED&&(s.removeListener(Pe.Status,this.onEventStatus),this.removeEvent(s))}),c(this,"onBeforeRedaction",function(){var s=T(function*(o){if(a.relations.has(o)){if(a.relations.delete(o),a.relationType===Ke.Annotation)a.removeAnnotationFromAggregation(o);else if(a.relationType===Ke.Replace&&a.targetEvent&&!a.targetEvent.isState()){var l=yield a.getLastReplacement();a.targetEvent.makeReplaced(l)}o.removeListener(Pe.BeforeRedaction,a.onBeforeRedaction),a.emit(gi.Redaction,o)}});return function(o){return s.apply(this,arguments)}}()),this.client=r instanceof Wi?r.client:r}addEvent(e){var t=this;return T(function*(){if(!t.relationEventIds.has(e.getId())){var r=e.getRelation();if(!r){E.error("Event must have relation info");return}var n=r.rel_type,a=e.getType();if(t.relationType!==n||!Lv(a,t.eventType,t.altEventTypes)){E.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(Pe.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===Ke.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===Ke.Replace&&t.targetEvent&&!t.targetEvent.isState()){var s=yield t.getLastReplacement();t.targetEvent.makeReplaced(s)}e.on(Pe.BeforeRedaction,t.onBeforeRedaction),t.emit(gi.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return T(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===Ke.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===Ke.Replace&&t.targetEvent&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();t.targetEvent.makeReplaced(r)}t.emit(gi.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort((o,l)=>{var d=o[1],u=l[1];return u.size-d.size});var a=e.getSender(),s=this.annotationsBySender[a];s||(s=this.annotationsBySender[a]=new Set),s.add(e)}}removeAnnotationFromAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((o,l)=>{var d=o[1],u=l[1];return u.size-d.size}));var a=e.getSender(),s=this.annotationsBySender[a];s&&s.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==Ke.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==Ke.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return T(function*(){if(e.relationType!==Ke.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(Ke.Replace),r=t?.origin_server_ts,n=e.getRelations().reduce((a,s)=>s.getSender()!==e.targetEvent.getSender()||r&&r>s.getTs()||a&&a.getTs()>s.getTs()?a:s,null);return n!=null&&n.shouldAttemptDecryption()&&e.client.getCrypto()?yield n.attemptDecryption(e.client.getCrypto()):n!=null&&n.isBeingDecrypted()&&(yield n.getDecryptionPromise()),n})()}setTargetEvent(e){var t=this;return T(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===Ke.Replace&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();r&&t.targetEvent.makeReplaced(r)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(Pe.RelationsCreated,this.relationType,this.eventType))}}class cc{constructor(e,t){this.client=e,this.room=t,c(this,"relations",new Map)}getChildEventsForEvent(e,t,r){var n;return(n=this.relations.get(e))===null||n===void 0||(n=n.get(t))===null||n===void 0?void 0:n.get(r)}getAllChildEventsForEvent(e){var t,r=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,n=[];for(var a of r.values())for(var s of a.values())n.push(...s.getRelations());return n}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var r of t.values())for(var n of r.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===pe.CANCELLED)){var r=e.getRelation();if(r){var n=()=>{if(e.isDecryptionFailure()){e.once(Pe.Decrypted,n);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(Pe.Decrypted,n);return}var{event_id:a,rel_type:s}=r,o=e.getType(),l=this.relations.get(a);l||(l=new Map,this.relations.set(a,l));var d=l.get(s);d||(d=new Map,l.set(s,d));var u=d.get(o);if(!u){var h,v,m;u=new Ga(s,o,this.client),d.set(o,u);var f=(h=this.room)!==null&&h!==void 0?h:t?.room,g=(v=(m=t?.findEventById(a))!==null&&m!==void 0?m:f?.findEventById(a))!==null&&v!==void 0?v:f?.getPendingEvent(a);g&&u.setTargetEvent(g)}u.addEvent(e)}}}}var vn;vn=E.log.bind(E);var mn=function(i){return i.Ignore="ignore",i.Replace="replace",i}({});class Wr extends xe{constructor(e){var t,r,n,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,l=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=o,this.threadListType=l,c(this,"relations",void 0),c(this,"timelineSupport",void 0),c(this,"displayPendingEvents",void 0),c(this,"liveTimeline",void 0),c(this,"timelines",void 0),c(this,"_eventIdToTimeline",new Map),c(this,"filter",void 0),this.timelineSupport=!!a.timelineSupport,this.liveTimeline=new Z(this),this.displayPendingEvents=a.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=a.filter,this.relations=(t=(r=this.room)===null||r===void 0?void 0:r.relations)!==null&&t!==void 0?t:new cc((n=e?.client)!==null&&n!==void 0?n:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){var r=!this.timelineSupport||!t,n=this.liveTimeline,a=r?n.forkLive(Z.FORWARDS):n.fork(Z.FORWARDS);r?(this.timelines=[a],this._eventIdToTimeline=new Map):this.timelines.push(a),t&&n.setPaginationToken(t,Z.FORWARDS),a.setPaginationToken(e??null,Z.BACKWARDS),this.liveTimeline=a,this.emit(ie.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(r){return r.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new Z(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,n,a){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var s=t?Z.BACKWARDS:Z.FORWARDS,o=t?Z.FORWARDS:Z.BACKWARDS,l=!1,d=!1;for(var u of e){var h=u.getId(),v=this._eventIdToTimeline.get(h);if(!v){this.addEventToTimeline(u,n,{toStartOfTimeline:t,addToState:r}),d=!0,l=!0;continue}if(d=!1,v==n){vn("Event "+h+" already in timeline "+n);continue}var m=n.getNeighbouringTimeline(s);if(m){v==m?vn("Event "+h+" in neighbouring timeline - switching to "+v):vn("Event "+h+" already in a different timeline "+v),n=v;continue}E.info("Already have timeline for "+h+" - joining timeline "+n+" to "+v);var f=v===this.liveTimeline,g=n===this.liveTimeline,w=s===Z.BACKWARDS&&f,S=s===Z.FORWARDS&&g;if(w||S){w&&E.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+v+")"),S&&E.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")");continue}n.setNeighbouringTimeline(v,s),v.setNeighbouringTimeline(n,o),n=v,l=!0}if(d||!l){if(s===Z.FORWARDS&&n===this.liveTimeline){E.warn({lastEventWasNew:d,didUpdate:l}),E.warn("Refusing to set forwards pagination token of live timeline "+"".concat(n," to ").concat(a));return}n.setPaginationToken(a??null,s)}}}addLiveEvent(e,t){var{duplicateStrategy:r,fromCache:n,roomState:a,timelineWasEmpty:s,addToState:o}=t;if(this.filter){var l=this.filter.filterRoomTimeline([e]);if(!l.length)return}var d=this._eventIdToTimeline.get(e.getId());if(d){if(r===mn.Replace){vn("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var u=d.getEvents(),h=0;h<u.length;h++)if(u[h].getId()===e.getId()){a||(a=d.getState(Z.FORWARDS)),Z.setEventMetadata(e,a,!1),u[h]=e;break}}else vn("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:n,roomState:a,timelineWasEmpty:s,addToState:o})}addEventToTimeline(e,t,r){var{toStartOfTimeline:n,fromCache:a=!1,roomState:s,timelineWasEmpty:o,addToState:l}=r;if(t.getTimelineSet()!==this){var d;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((d=this.thread)===null||d===void 0?void 0:d.id,")"))}var u=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var h,v="event=".concat(u);e.threadRootId&&(v+="(belongs to thread=".concat(e.threadRootId,")")),E.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(v," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((h=this.thread)===null||h===void 0?void 0:h.id,")"));return}t.addEvent(e,{toStartOfTimeline:n,roomState:s,timelineWasEmpty:o,addToState:l}),this._eventIdToTimeline.set(u,t);var m={timeline:t,liveEvent:!n&&t==this.liveTimeline&&!a};this.emit(ie.Timeline,e,this.room,!!n,!1,m)}insertEventIntoTimeline(e,t,r,n){if(t.getTimelineSet()!==this){var a;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((a=this.thread)===null||a===void 0?void 0:a.id,")"))}var s=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var o,l="event=".concat(s);e.threadRootId&&(l+="(belongs to thread=".concat(e.threadRootId,")")),E.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(l," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((o=this.thread)===null||o===void 0?void 0:o.id,")"));return}var d=e.relationEventId;if(!d){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r,addToState:n});return}for(var u=this.findEventById(d),h=t.getEvents(),v=u!==void 0?h.indexOf(u):0,m=v;m<h.length;m++){var f=h[m];if(f.getTs()>e.getTs())break}t.insertEvent(e,m,r,n),this._eventIdToTimeline.set(s,t);var g={timeline:t,liveEvent:!1};this.emit(ie.Timeline,e,this.room,!1,!1,g)}handleRemoteEcho(e,t,r){var n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var r=t.removeEvent(e);if(r){this._eventIdToTimeline.delete(e);var n={timeline:t};this.emit(ie.Timeline,r,this.room,void 0,!0,n)}return r}compareEventOrdering(e,t){if(e==t)return 0;var r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(r===void 0||n===void 0)return null;if(r===n){for(var a=void 0,s=void 0,o=r.getEvents(),l=0;l<o.length&&(a===void 0||s===void 0);l++){var d=o[l].getId();d==e&&(a=l),d==t&&(s=l)}var u=a-s;return u<0?-1:u>0?1:0}for(var h=r;h;){if(h===n)return-1;h=h.getNeighbouringTimeline(Z.FORWARDS)}for(h=r;h;){if(h===n)return 1;h=h.getNeighbouringTimeline(Z.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:r,shouldLiveInThread:n}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!r&&!n){var a;E.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((a=this.room)===null||a===void 0?void 0:a.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return r}}var pe=function(i){return i.NOT_SENT="not_sent",i.ENCRYPTING="encrypting",i.SENDING="sending",i.QUEUED="queued",i.SENT="sent",i.CANCELLED="cancelled",i}({});class Co{constructor(e,t){this.roomId=e}}class hc{constructor(e){this.target=e,c(this,"reEmitters",new WeakMap)}reEmit(e,t){var r=this,n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));var a=function(l){if(n.has(l))return 1;var d=function(){if(!(l==="error"&&r.target.listenerCount("error")===0)){for(var h=arguments.length,v=new Array(h),m=0;m<h;m++)v[m]=arguments[m];r.target.emit(l,...v,e)}};e.on(l,d),n.set(l,d)};for(var s of t)a(s)}stopReEmitting(e,t){var r=this.reEmitters.get(e);if(r){for(var n of t)e.off(n,r.get(n)),r.delete(n);r.size===0&&this.reEmitters.delete(e)}}}class Fn extends hc{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var Mi=new Ka("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function Uv(i,e){if(e.endsWith("*")){var t=e.slice(0,-1);return i.slice(0,t.length)===t}else return i===e}class cd{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,r,n=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},a=Object.keys(n),s=[];return this.userId&&n!==null&&n!==void 0&&(r=n[De.name])!==null&&r!==void 0&&r.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,a,s)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[$r.name]:this.filterJson[$r.name],[Hr.name]:this.filterJson[Hr.name]}).filter(e=>{var[t,r]=e;return r}))}checkFields(e,t,r,n,a,s){var o={rooms:function(S){return e===S},senders:function(S){return t===S},types:function(S){return Uv(r,S)}};for(var l in o){var d=o[l],u="not_"+l,h=this.filterJson[u];if(h!=null&&h.some(d))return!1;var v=this.filterJson[l];if(v&&!v.some(d))return!1}var m=this.filterJson.contains_url;if(m!==void 0&&m!==n)return!1;var f=this.filterJson[Hr.name];if(f!==void 0&&!this.arrayMatchesFilter(f,a))return!1;var g=this.filterJson[$r.name];return!(g!==void 0&&!this.arrayMatchesFilter(g,s))}arrayMatchesFilter(e,t){return t.length>0&&e.every(r=>t.includes(r))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function hd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function sn(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):hd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function ys(i,e,t){for(var r=e.split("."),n=i,a=0;a<r.length-1;a++)n[r[a]]||(n[r[a]]={}),n=n[r[a]];n[r[r.length-1]]=t}class pt{static fromJson(e,t,r){var n=new pt(e,t);return n.setDefinition(r),n}constructor(e,t){this.userId=e,this.filterId=t,c(this,"definition",{}),c(this,"roomFilter",void 0),c(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new cd(r,this.userId),this.roomTimelineFilter=new cd(t?.timeline||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){ys(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=sn(sn({},this.definition),{},{room:sn(sn({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:sn(sn({},(r=this.definition)===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.timeline),{},{[Mi.name]:e})})})}setLazyLoadMembers(e){ys(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){ys(this.definition,"room.include_leave",e)}}c(pt,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});function Oa(i){return i!=null}var vc=new Et.UnstableValue("m.message","org.matrix.msc1767.message"),$a=new Et.UnstableValue("m.text","org.matrix.msc1767.text"),fc=new Et.UnstableValue("m.html","org.matrix.msc1767.html"),Oo=new Et.NamespacedValue("m.reference");function pc(i,e){if(typeof i=="string")return typeof e=="string"?e===i:e.matches(i);if(typeof e=="string")return i.matches(e);var t=e,r=i;return t.matches(r.name)||Oa(r.altName)&&t.matches(r.altName)}var Ha=new Li("m.topic");function vd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Nv(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?vd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):vd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function mc(i,e){return{msgtype:Bt.Text,format:"org.matrix.custom.html",body:i,formatted_body:e}}function gc(i,e){return{msgtype:Bt.Notice,format:"org.matrix.custom.html",body:i,formatted_body:e}}function yc(i,e){return{msgtype:Bt.Emote,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Sc(i){return{msgtype:Bt.Text,body:i}}function Ec(i){return{msgtype:Bt.Notice,body:i}}function bc(i){return{msgtype:Bt.Emote,body:i}}var _c=(i,e,t,r)=>{var n="at ".concat(new Date(t).toISOString()),a=e===Jr.Self?"User":void 0,s=r?'"'.concat(r,'"'):void 0;return[a,"Location",s,i,n].filter(Boolean).join(" ")},wc=(i,e,t,r,n)=>{var a=i??_c(e,n||Jr.Self,t,r),s=t?{[ur.name]:t}:{};return Nv({msgtype:Bt.Location,body:a,geo_uri:e,[An.name]:{description:r,uri:e},[kn.name]:{type:n||Jr.Self},[$a.name]:a},s)},Fv=i=>{var e,t,r=An.findIn(i),n=kn.findIn(i),a=ur.findIn(i),s=$a.findIn(i),o=(e=r?.uri)!==null&&e!==void 0?e:i?.geo_uri,l=r?.description,d=(t=n?.type)!==null&&t!==void 0?t:Jr.Self,u=s??i.body;return wc(u,o,a??void 0,l,d)},Rc=(i,e)=>{var t=[];return Oa(e)&&t.push({body:e,mimetype:"text/html"}),Oa(i)&&t.push({body:i,mimetype:"text/plain"}),{topic:i,[Ha.name]:t}},xv=i=>{var e,t,r,n,a=Ha.findIn(i);if(!Array.isArray(a)){var s;return{text:(s=i.topic)!==null&&s!==void 0?s:void 0}}var o=(e=(t=a==null||(r=a.find(d=>!Oa(d.mimetype)||d.mimetype==="text/plain"))===null||r===void 0?void 0:r.body)!==null&&t!==void 0?t:i.topic)!==null&&e!==void 0?e:void 0,l=a==null||(n=a.find(d=>d.mimetype==="text/html"))===null||n===void 0?void 0:n.body;return{text:o,html:l}},jv=(i,e,t,r,n)=>({description:t,timeout:i,live:e,[ur.name]:n||Date.now(),[kn.name]:{type:r??Jr.Self}}),Tc=i=>{var e,{description:t,timeout:r,live:n}=i,a=(e=ur.findIn(i))!==null&&e!==void 0?e:void 0,s=kn.findIn(i);return{description:t,timeout:r,live:n,assetType:s?.type,timestamp:a}},Bv=(i,e,t,r)=>({[An.name]:{description:r,uri:i},[ur.name]:e,"m.relates_to":{rel_type:Oo.name,event_id:t}}),Gs=i=>{var e,t=An.findIn(i),r=(e=ur.findIn(i))!==null&&e!==void 0?e:void 0;return{description:t?.description,uri:t?.uri,timestamp:r}};const Ic=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:_c,makeBeaconContent:Bv,makeBeaconInfoContent:jv,makeEmoteMessage:bc,makeHtmlEmote:yc,makeHtmlMessage:mc,makeHtmlNotice:gc,makeLocationContent:wc,makeNotice:Ec,makeTextMessage:Sc,makeTopicContent:Rc,parseBeaconContent:Gs,parseBeaconInfoContent:Tc,parseLocationEvent:Fv,parseTopicContent:xv},Symbol.toStringTag,{value:"Module"}));var Fe=function(i){return i.New="Beacon.new",i.Update="Beacon.update",i.LivenessChange="Beacon.LivenessChange",i.Destroy="Beacon.Destroy",i.LocationUpdate="Beacon.LocationUpdate",i}({}),Ma=(i,e,t)=>t>=i&&i+e>=t,Pi=i=>"".concat(i.getRoomId(),"_").concat(i.getStateKey());class Mo extends xe{constructor(e){super(),this.rootEvent=e,c(this,"roomId",void 0),c(this,"_beaconInfo",void 0),c(this,"_isLive",void 0),c(this,"livenessWatchTimeout",void 0),c(this,"_latestLocationEvent",void 0),c(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(Fe.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return Pi(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&Gs(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(Pi(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(Fe.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(Fe.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var r=e.filter(a=>{var s=a.getContent(),o=Gs(s);if(!o.uri||!o.timestamp)return!1;var{timestamp:l}=o;return this._beaconInfo.timestamp&&Ma(this._beaconInfo.timestamp,this._beaconInfo.timeout,l)&&(!this.latestLocationState||l>this.latestLocationState.timestamp)}),n=(t=r.sort(vv))===null||t===void 0?void 0:t[0];n&&(this._latestLocationEvent=n,this.emit(Fe.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=Tc(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&Ma(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(Fe.LivenessChange,this.isLive,this)}}}function fd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Wv(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?fd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):fd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Cc(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new ct({content:{[e.getId()]:{[t]:{[i]:Wv({ts:e.getTs()},!r&&{thread_id:Qr(e)})}}},type:x.Receipt,room_id:e.getRoomId()})}var on=0,ln=1;class Oc extends xe{constructor(){super(...arguments),c(this,"receipts",new or(()=>new Map)),c(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ht.Read,[s,o]=(t=(r=this.receipts.get(a))===null||r===void 0?void 0:r.get(e))!==null&&t!==void 0?t:[null,null];return n?s:o??s}compareReceipts(e,t){var r;return(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&r!==void 0?r:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t,r=this.findEventById(e.eventId);if(!r)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===Dn){var n=Mn(r);if(n)return!0}else if(r.threadRootId===e.data.thread_id)return!0;return E.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n,a=this.getReadReceiptForUserId(e,t,ht.Read),s=this.getReadReceiptForUserId(e,t,ht.ReadPrivate),o;return a!=null&&a.eventId&&s!==null&&s!==void 0&&s.eventId&&(o=this.compareReceipts(a,s)),o?(n=o<0?s:a)!==null&&n!==void 0?n:null:(r=s??a)!==null&&r!==void 0?r:null}addReceiptToStructure(e,t,r,n,a){var s,o,l=this.receipts.getOrCreate(t),d=l.get(r);d||(d=[null,null],l.set(r,d));var u=d[on];if(a){var h;u=(h=d[ln])!==null&&h!==void 0?h:d[on]}var v={eventId:e,data:n};if(u){var m=this.compareReceipts(u,v);if(m>=0)return}var f=a?d[on]:v,g=a?v:d[ln],w=null;f&&g&&(w=this.getUnfilteredTimelineSet().compareEventOrdering(f.eventId,g.eventId));var S=w===null||w<0,R=(s=d[ln])!==null&&s!==void 0?s:d[on];a&&S?d[ln]=v:a||(d[on]=v,S||(d[ln]=null));var C=(o=d[ln])!==null&&o!==void 0?o:d[on];if(R!==C){if(R&&this.receiptCacheByEventId.get(R.eventId)){var b=R.eventId;this.receiptCacheByEventId.set(b,this.receiptCacheByEventId.get(b).filter(_=>_.type!==t||_.userId!==r)),this.receiptCacheByEventId.get(b).length<1&&this.receiptCacheByEventId.delete(b)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&t?.eventId===r.getId()&&e===r.getSender()&&(this.setUnread(Me.Total,0),this.setUnread(Me.Highlight,0))}addLocalEchoReceipt(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(Cc(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return go(t.type)}).map(function(t){return t.userId})}}var Mc=new Et.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),Pc=new Et.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),kc=new Et.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),Rn=new Et.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),ki=new Et.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),rr=function(i){return i.New="Poll.new",i.End="Poll.end",i.Update="Poll.update",i.Responses="Poll.Responses",i.Destroy="Poll.Destroy",i.UndecryptableRelations="Poll.UndecryptableRelations",i}({}),pd=(i,e)=>{var t=i.filter(r=>{if(!r.isDecryptionFailure())return Rn.matches(r.getType())&&r.getTs()<=e});return{responseEvents:t}};class Po extends xe{constructor(e,t,r){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=r,c(this,"roomId",void 0),c(this,"pollEvent",void 0),c(this,"_isFetchingResponses",!1),c(this,"relationsNextBatch",void 0),c(this,"responses",null),c(this,"endEvent",void 0),c(this,"undecryptableRelationEventIds",new Set),c(this,"countUndecryptableEvents",n=>{var a=n.filter(o=>o.isDecryptionFailure()).map(o=>o.getId()),s=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...a]),this.undecryptableRelationsCount!==s&&this.emit(rr.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return T(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(ki.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(rr.End)),!!this.responses){var r=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:n}=pd([e],r);this.countUndecryptableEvents([e]),n.length&&(n.forEach(a=>{this.responses.addEvent(a)}),this.emit(rr.Responses,this.responses))}}fetchResponses(){var e=this;return T(function*(){var t,r;e._isFetchingResponses=!0;var n=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(n.events.map(d=>e.matrixClient.decryptEventIfNeeded(d)));var a=e.responses||new Ga("m.reference",Rn.name,e.matrixClient,[Rn.altName]),s=n.events.find(d=>ki.matches(d.getType()));e.validateEndEvent(s)&&(e.endEvent=s,e.refilterResponsesOnEnd(),e.emit(rr.End));var o=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:l}=pd(n.events,o);l.forEach(d=>{a.addEvent(d)}),e.relationsNextBatch=(r=n.nextBatch)!==null&&r!==void 0?r:void 0,e.responses=a,e.countUndecryptableEvents(n.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(rr.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(r=>{if(r.getTs()>t){var n;(n=this.responses)===null||n===void 0||n.removeEvent(r)}}),this.emit(rr.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}}var ko=i=>{var e=i.getType();return Et.M_POLL_START.matches(e)||Rn.matches(e)||ki.matches(e)};class qv{constructor(e){c(this,"room",void 0),c(this,"threadedReceipts",void 0),c(this,"unthreadedReceipts",void 0),c(this,"danglingReceipts",void 0),c(this,"onTimelineEvent",t=>{var r=t.getId();if(r){var n=this.danglingReceipts.remove(r);n?.forEach(a=>{a.receipt.thread_id?this.threadedReceipts.set(a.receipt.thread_id,a.eventId,a.receiptType,a.userId,a.receipt.ts,a.synthetic):this.unthreadedReceipts.set(r,a.receiptType,a.userId,a.receipt.ts,a.synthetic)})}}),this.room=e,this.threadedReceipts=new $v(e),this.unthreadedReceipts=new Ac(e),this.danglingReceipts=new Hv,e.on(ie.Timeline,this.onTimelineEvent)}add(e,t){for(var[r,n]of Object.entries(e))for(var[a,s]of Object.entries(n))for(var[o,l]of Object.entries(s)){var d=this.room.findEventById(r);d?l.thread_id?this.threadedReceipts.set(l.thread_id,r,a,o,l.ts,t):this.unthreadedReceipts.set(r,a,o,l.ts,t):this.danglingReceipts.add(new Vv(r,a,o,l,t))}}hasUserReadEvent(e,t){var r=this.unthreadedReceipts.get(e);if(r&&$s(r.eventId,t,this.room))return!0;var n=this.room.findEventById(t);if(!n)return E.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var a=Qr(n),s=this.threadedReceipts.get(a,e);return!!(s&&$s(s.eventId,t,this.room)||this.userSentLatestEventInThread(a,e))}userSentLatestEventInThread(e,t){var r,n=e===Dn?this.room.getLiveTimeline().getEvents():(r=this.room.getThread(e))===null||r===void 0?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class Kv{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class Vv{constructor(e,t,r,n,a){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=a}}class Gv{constructor(e){c(this,"room",void 0),c(this,"real",void 0),c(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&$s(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}}class Ac{constructor(e){c(this,"room",void 0),c(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,a){var s=Ao(this.data,r,()=>new Gv(this.room)),o=s.getByType(a);o&&Jv(o.eventId,e,this.room)||s.set(a,new Kv(e,t,n))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}}class $v{constructor(e){c(this,"room",void 0),c(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,a,s){var o=Ao(this.data,e,()=>new Ac(this.room));o.set(t,r,n,a,s)}get(e,t){var r;return(r=this.data.get(e))===null||r===void 0?void 0:r.get(t)}}class Hv{constructor(){c(this,"data",new Map)}add(e){var t=Ao(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function Ao(i,e,t){var r=i.get(e);if(r)return r;var n=t();return i.set(e,n),n}function $s(i,e,t){var r=t.compareEventOrdering(i,e);return r!==null&&r>=0}function Jv(i,e,t){var r=t.compareEventOrdering(i,e);return r!==null&&r>0}function zv(i,e,t){var r=i.findEventById(e),n=i.findEventById(t);if(!r||!n)return null;var a=Mn(r),s=Mn(n);return a&&s?Yv(i,e,t,r,n):Xv(e,t,r,n)}function Yv(i,e,t,r,n){var a=i.getUnfilteredTimelineSet(),s=a.compareEventOrdering(e,t);if(s!==null)return s;var o=a.getTimelineForEvent(e);if(o===a.getLiveTimeline())return 1;var l=a.getTimelineForEvent(t);return l===a.getLiveTimeline()?-1:Dc(r,n)}function Xv(i,e,t,r){var n=Qr(t),a=Qr(r),s=t.getThread();return s&&n===a?s.timelineSet.compareEventOrdering(i,e):Dc(t,r)}function Dc(i,e){var t=i.getTs(),r=e.getTs();return t<r?-1:t>r?1:0}var q=function(i){return i.Get="GET",i.Put="PUT",i.Post="POST",i.Delete="DELETE",i.Options="OPTIONS",i.Head="HEAD",i.Patch="PATCH",i}({});function md(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Qv(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?md(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):md(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class dr extends Error{constructor(e,t,r){super(e),this.httpStatus=t,this.httpHeaders=r}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var r=Number.parseInt(t)*1e3;if(!Number.isFinite(r))throw new Error("Retry-After header integer value is too large");return r}var n=new Date(t);if(n.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return n.getTime()-Date.now()}return null}}class je extends dr{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),r&&(s="".concat(s," (").concat(r,")")),super("MatrixError: ".concat(s),t,a),this.url=r,this.event=n,c(this,"errcode",void 0),c(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,r,n,a={};if(this.httpHeaders)for(var[s,o]of this.httpHeaders)a[s]=o;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:a,url:(t=this.url)!==null&&t!==void 0?t:"",response:Qv({errcode:(r=this.errcode)!==null&&r!==void 0?r:"M_UNKNOWN",error:(n=this.data.error)!==null&&n!==void 0?n:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new je(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function Ja(i,e){if(!(i instanceof dr)||!i.isRateLimitError())return e;try{var t;return(t=i.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}class Tr extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}class Do extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshError"}}class za extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshLogoutError"}}var Pa=function(i){return i.SessionLoggedOut="Session.logged_out",i.NoConsent="no_consent",i}({}),ea={};/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */var gd;function Zv(){if(gd)return ea;gd=1;var i=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,e=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,t=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,r=/\\([\u000b\u0020-\u00ff])/g,n=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;ea.format=s,ea.parse=o;function s(h){if(!h||typeof h!="object")throw new TypeError("argument obj is required");var v=h.parameters,m=h.type;if(!m||!a.test(m))throw new TypeError("invalid type");var f=m;if(v&&typeof v=="object")for(var g,w=Object.keys(v).sort(),S=0;S<w.length;S++){if(g=w[S],!t.test(g))throw new TypeError("invalid parameter name");f+="; "+g+"="+d(v[g])}return f}function o(h){if(!h)throw new TypeError("argument string is required");var v=typeof h=="object"?l(h):h;if(typeof v!="string")throw new TypeError("argument string is required to be a string");var m=v.indexOf(";"),f=m!==-1?v.slice(0,m).trim():v.trim();if(!a.test(f))throw new TypeError("invalid media type");var g=new u(f.toLowerCase());if(m!==-1){var w,S,R;for(i.lastIndex=m;S=i.exec(v);){if(S.index!==m)throw new TypeError("invalid parameter format");m+=S[0].length,w=S[1].toLowerCase(),R=S[2],R.charCodeAt(0)===34&&(R=R.slice(1,-1),R.indexOf("\\")!==-1&&(R=R.replace(r,"$1"))),g.parameters[w]=R}if(m!==v.length)throw new TypeError("invalid parameter format")}return g}function l(h){var v;if(typeof h.getHeader=="function"?v=h.getHeader("content-type"):typeof h.headers=="object"&&(v=h.headers&&h.headers["content-type"]),typeof v!="string")throw new TypeError("content-type header is missing from object");return v}function d(h){var v=String(h);if(t.test(v))return v;if(v.length>0&&!e.test(v))throw new TypeError("invalid parameter value");return'"'+v.replace(n,"\\$1")+'"'}function u(h){this.parameters=Object.create(null),this.type=h}return ea}var ef=Zv();function Bi(i){var e=new AbortController;return setTimeout(()=>{e.abort()},i),e.signal}function Lo(i){var e=new AbortController;function t(){for(var a of i)a.removeEventListener("abort",r)}function r(){e.abort(),t()}for(var n of i){if(n.aborted){r();break}n.addEventListener("abort",r)}return{signal:e.signal,cleanup:t}}function Ya(i,e){var t,r,n=yd(i)?new Headers(i.getAllResponseHeaders().trim().split(/[\r\n]+/).map(s=>{var o=s.indexOf(":");return[s.substring(0,o),s.substring(o+1)]})):i.headers,a;try{a=tf(n)}catch(s){return s}return((t=a)===null||t===void 0?void 0:t.type)==="application/json"&&e?new je(JSON.parse(e),i.status,yd(i)?i.responseURL:i.url,void 0,n):((r=a)===null||r===void 0?void 0:r.type)==="text/plain"?new dr("Server returned ".concat(i.status," error: ").concat(e),i.status,n):new dr("Server returned ".concat(i.status," error"),i.status,n)}function yd(i){return"getResponseHeader"in i}function tf(i){var e=i.get("Content-Type");if(e===null)return null;try{return ef.parse(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}function ka(i,e){return Hs.apply(this,arguments)}function Hs(){return Hs=T(function*(i,e){for(var t=0,r=null;t<i;)try{if(t>0){var n=1e3*Math.pow(2,t);E.log("network operation failed ".concat(t," times, retrying in ").concat(n,"ms...")),yield zr(n)}return yield e()}catch(a){if(a instanceof Tr)t+=1,r=a;else throw a}throw r}),Hs.apply(this,arguments)}function Uo(i,e,t){return e>4||i instanceof Tr&&!t||i.httpStatus&&Math.floor(i.httpStatus/100)===4&&i.httpStatus!==429||i.name==="AbortError"||i.name==="M_TOO_LARGE"?-1:Ja(i,1e3*Math.pow(2,e))}var mr=function(i){return i.Success="success",i.Failure="failure",i.Logout="logout",i}({}),rf=500,nf=60*1e3;class af{constructor(e){this.opts=e,c(this,"tokenRefreshPromise",void 0),c(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return T(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return T(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;if(e.latestTokenRefreshExpiry){var t=e.latestTokenRefreshExpiry.getTime()-Date.now();t<=rf&&(yield e._handleUnknownToken())}})()}handleUnknownToken(e,t){var r=this;return T(function*(){return r._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var r=this;return T(function*(){if(e!=null&&e.expiry){var n=e.expiry.getTime()-Date.now();if(n>=nf)return mr.Logout}if(!e||e?.accessToken===r.opts.accessToken){var a;(a=r.tokenRefreshPromise)!==null&&a!==void 0||(r.tokenRefreshPromise=r.doTokenRefresh(t));try{return yield r.tokenRefreshPromise}finally{r.tokenRefreshPromise=void 0}}return mr.Success})()}doTokenRefresh(e){var t=this;return T(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction){var r;return(r=t.opts.logger)===null||r===void 0||r.error("Unable to refresh token - no refresh token or refresh function"),mr.Logout}e&&e>1&&(yield zr(1e3*Math.min(32,2**e)));try{var n,a;(n=t.opts.logger)===null||n===void 0||n.debug("Attempting to refresh token");var{accessToken:s,refreshToken:o,expiry:l}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=s,t.opts.refreshToken=o,t.latestTokenRefreshExpiry=l,(a=t.opts.logger)===null||a===void 0||a.debug("... token refresh complete, new token expiry:",l),mr.Success}catch(h){var d;if(h instanceof za||h instanceof je){var u;return(u=t.opts.logger)===null||u===void 0||u.error("Failed to refresh token",h),mr.Logout}return(d=t.opts.logger)===null||d===void 0||d.warn("Failed to refresh token",h),mr.Failure}})()}}function Sd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ed(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Sd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Sd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class sf{constructor(e,t){var r;this.eventEmitter=e,this.opts=t,c(this,"abortController",new AbortController),c(this,"tokenRefresher",void 0),zu(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=(r=t.useAuthorizationHeader)!==null&&r!==void 0?r:!0,this.tokenRefresher=new af(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,a){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var s=void 0,o=void 0;e===q.Get?s=r:o=r;var l=this.getUrl(t,s,n,this.opts.idBaseUrl),d={json:!0,headers:{}};return a&&(d.headers.Authorization="Bearer ".concat(a)),this.requestOtherUrl(e,l,o,d)}authedRequest(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};return this.doAuthedRequest(1,e,t,r,n,a)}doAuthedRequest(e,t,r,n,a){var s=arguments,o=this;return T(function*(){var l=s.length>5&&s[5]!==void 0?s[5]:{},d=Ui(l);d.abortSignal=l.abortSignal;var u=yield o.tokenRefresher.prepareForRequest();u.accessToken&&(o.opts.useAuthorizationHeader?(d.headers||(d.headers={}),d.headers.Authorization||(d.headers.Authorization="Bearer ".concat(u.accessToken)),n.access_token&&delete n.access_token):n.access_token||(n.access_token=u.accessToken));try{var h=yield o.request(t,r,n,a,d);return h}catch(m){if(!(m instanceof je))throw m;if(m.errcode==="M_UNKNOWN_TOKEN"){var v=yield o.tokenRefresher.handleUnknownToken(u,e);if(v===mr.Success)return o.doAuthedRequest(e+1,t,r,n,a,l);if(v===mr.Failure)throw new Do(m);d!=null&&d.inhibitLogoutEmit||o.eventEmitter.emit(Pa.SessionLoggedOut,m)}else m.errcode=="M_CONSENT_NOT_GIVEN"&&o.eventEmitter.emit(Pa.NoConsent,m.message,m.data.consent_uri);throw m}})()}request(e,t,r,n,a){var s=this.getUrl(t,r,a?.prefix,a?.baseUrl);return this.requestOtherUrl(e,s,n,a)}requestOtherUrl(e,t,r){var n=arguments,a=this;return T(function*(){var s,o,l,d,u,h=n.length>3&&n[3]!==void 0?n[3]:{},v=a.sanitizeUrlForLogs(t);(s=a.opts.logger)===null||s===void 0||s.debug("FetchHttpApi: --> ".concat(e," ").concat(v));var m=Object.assign({},h.headers||{}),f=(o=h.json)!==null&&o!==void 0?o:!0,g=f&&(r==null||(l=r.constructor)===null||l===void 0?void 0:l.name)===Object.name;f&&(g&&!m["Content-Type"]&&(m["Content-Type"]="application/json"),m.Accept||(m.Accept="application/json"));var w=(d=h.localTimeoutMs)!==null&&d!==void 0?d:a.opts.localTimeoutMs,S=(u=h.keepAlive)!==null&&u!==void 0?u:!1,R=[a.abortController.signal];w!==void 0&&R.push(Bi(w)),h.abortSignal&&R.push(h.abortSignal);var C;g?C=JSON.stringify(r):C=r;var{signal:b,cleanup:_}=Lo(R),p,I=Date.now();try{var y;p=yield a.fetch(t,{signal:b,method:e,body:C,headers:m,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:S,priority:h.priority}),(y=a.opts.logger)===null||y===void 0||y.debug("FetchHttpApi: <-- ".concat(e," ").concat(v," [").concat(Date.now()-I,"ms ").concat(p.status,"]"))}catch(L){var P;throw(P=a.opts.logger)===null||P===void 0||P.debug("FetchHttpApi: <-- ".concat(e," ").concat(v," [").concat(Date.now()-I,"ms ").concat(L,"]")),L.name==="AbortError"?L:new Tr("fetch failed",L)}finally{_()}if(!p.ok)throw Ya(p,yield p.text());return a.opts.onlyData?f?p.json():p.text():p})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var r=new URLSearchParams;for(var n of t.searchParams.keys())r.append(n,"xxx");var a=r.toString(),s=a?"?".concat(a):"";return t.origin+t.pathname+s}catch{return"??"}}getUrl(e,t,r,n){var a=n??this.opts.baseUrl,s=a.endsWith("/")?a.slice(0,-1):a,o=new URL(s+(r??this.opts.prefix)+e);if(this.opts.extraParams||t){var l=Ed(Ed({},this.opts.extraParams),t);xs(l,o.searchParams)}return o}}var Xe=function(i){return i.V1="/_matrix/client/v1",i.V3="/_matrix/client/v3",i.Unstable="/_matrix/client/unstable",i}({}),Gt=function(i){return i.V2="/_matrix/identity/v2",i}({}),Vr=function(i){return i.V1="/_matrix/media/v1",i.V3="/_matrix/media/v3",i}({}),of=1e3,lf=0,Ss,ir=[],df=function(){};function bd(i,e){for(var t=arguments.length,r=new Array(t>2?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];e=e||0,e<0&&(e=0);var a=Date.now()+e,s=lf++,o={runAt:a,func:i,params:r,key:s},l=cf(ir,function(d){return d.runAt-a});return ir.splice(l,0,o),No(),s}function _d(i){if(ir.length!==0){var e;for(e=0;e<ir.length;e++){var t=ir[e];if(t.key==i){ir.splice(e,1);break}}e===0&&No()}}function No(){Ss&&globalThis.clearTimeout(Ss);var i=ir[0];if(i){var e=Date.now(),t=Math.min(i.runAt-e,of);Ss=globalThis.setTimeout(uf,t)}}function uf(){for(var i=Date.now(),e=[];;){var t=ir[0];if(!t||t.runAt>i)break;var r=ir.shift();df("runCallbacks: popping",r.key),e.push(r)}No();for(var n of e)try{n.func.apply(globalThis,n.params)}catch(a){E.error("Uncaught exception in callback function",a)}}function cf(i,e){for(var t=0,r=i.length;t<r;){var n=t+r>>1,a=e(i[n]);a>0?r=n:t=n+1}return t}class Fo extends sf{constructor(){super(...arguments),c(this,"uploads",[])}uploadContent(e){var t,r,n,a,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=(t=s.includeFilename)!==null&&t!==void 0?t:!0,l=(r=s.abortController)!==null&&r!==void 0?r:new AbortController,d=((n=s.type)!==null&&n!==void 0?n:e.type)||"application/octet-stream",u=(a=s.name)!==null&&a!==void 0?a:e.name,h={loaded:0,total:0,abortController:l},v=Promise.withResolvers();if(globalThis.XMLHttpRequest){var m=new globalThis.XMLHttpRequest,f=function(){m.abort(),v.reject(new Error("Timeout"))},g=bd(f,3e4);m.onreadystatechange=function(){switch(m.readyState){case globalThis.XMLHttpRequest.DONE:_d(g);try{if(m.status===0)throw new DOMException(m.statusText,"AbortError");if(!m.responseText)throw new Error("No response body.");m.status>=400?v.reject(Ya(m,m.responseText)):v.resolve(JSON.parse(m.responseText))}catch(C){if(C.name==="AbortError"){v.reject(C);return}v.reject(new Tr("request failed",C))}break}},m.upload.onprogress=C=>{var b;_d(g),h.loaded=C.loaded,h.total=C.total,g=bd(f,3e4),(b=s.progressHandler)===null||b===void 0||b.call(s,{loaded:C.loaded,total:C.total})};var w=this.getUrl("/upload",void 0,Vr.V3);o&&u&&w.searchParams.set("filename",encodeURIComponent(u)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&w.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),m.open(q.Post,w.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&m.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),m.setRequestHeader("Content-Type",d),m.send(e),l.signal.addEventListener("abort",()=>{m.abort()})}else{var S={};o&&u&&(S.filename=u);var R={"Content-Type":d};this.authedRequest(q.Post,"/upload",S,e,{prefix:Vr.V3,headers:R,abortSignal:l.signal}).then(C=>this.opts.onlyData?C:C.json()).then(v.resolve,v.reject)}return h.promise=v.promise.finally(()=>{Ea(this.uploads,C=>C===h)}),l.signal.addEventListener("abort",()=>{Ea(this.uploads,C=>C===h),v.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(h),h.promise}cancelUpload(e){var t=this.uploads.find(r=>r.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:Vr.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var hf=6*60*60*1e3,vf=30*1e3,xo=function(i){return i.Stable="stable",i.Unstable="unstable",i}({});class jo{constructor(e){var t=this;this.http=e,c(this,"capabilities",void 0),c(this,"retryTimeout",void 0),c(this,"refreshTimeout",void 0),c(this,"fetchCapabilities",T(function*(){var r=yield t.http.authedRequest(q.Get,"/capabilities");return t.capabilities=r.capabilities,t.capabilities})),c(this,"poll",T(function*(){try{yield t.fetchCapabilities(),t.clearTimeouts(),t.refreshTimeout=setTimeout(t.poll,hf),E.debug("Fetched new server capabilities")}catch(n){t.clearTimeouts();var r=Math.floor(vf+Math.random()*5e3);t.retryTimeout=setTimeout(t.poll,r),E.warn("Failed to refresh capabilities: retrying in ".concat(r,"ms"),n)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}function wd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Zn(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):wd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Bo="10",ff=["1","2","3","4","5","6","7","8","9","10"],pf=30,Me=function(i){return i.Highlight="highlight",i.Total="total",i}({}),ie=function(i){return i.MyMembership="Room.myMembership",i.Tags="Room.tags",i.AccountData="Room.accountData",i.Receipt="Room.receipt",i.Name="Room.name",i.Redaction="Room.redaction",i.RedactionCancelled="Room.redactionCancelled",i.LocalEchoUpdated="Room.localEchoUpdated",i.Timeline="Room.timeline",i.TimelineReset="Room.timelineReset",i.TimelineRefresh="Room.TimelineRefresh",i.OldStateUpdated="Room.OldStateUpdated",i.CurrentStateUpdated="Room.CurrentStateUpdated",i.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",i.UnreadNotifications="Room.UnreadNotifications",i.Summary="Room.Summary",i}({});class Wi extends Oc{constructor(e,t,r){var n,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),n=this,this.roomId=e,this.client=t,this.myUserId=r,this.opts=a,c(this,"reEmitter",void 0),c(this,"txnToEvent",new Map),c(this,"notificationCounts",{}),c(this,"bumpStamp",void 0),c(this,"threadNotifications",new Map),c(this,"cachedThreadReadReceipts",new Map),c(this,"oldestThreadedReceiptTs",1/0),c(this,"unthreadedReceipts",new Map),c(this,"timelineSets",void 0),c(this,"polls",new Map),c(this,"threadsTimelineSets",[]),c(this,"filteredTimelineSets",{}),c(this,"timelineNeedsRefresh",!1),c(this,"pendingEventList",void 0),c(this,"blacklistUnverifiedDevices",void 0),c(this,"selfMembership",void 0),c(this,"heroes",null),c(this,"getTypeWarning",!1),c(this,"getVersionWarning",!1),c(this,"membersPromise",void 0),c(this,"name",void 0),c(this,"normalizedName",void 0),c(this,"tags",{}),c(this,"accountData",new Map),c(this,"summary",null),c(this,"oldState",void 0),c(this,"currentState",void 0),c(this,"relations",void 0),c(this,"threads",new Map),c(this,"visibilityEvents",new Map),c(this,"roomReceipts",new qv(this)),c(this,"threadTimelineSetsPromise",null),c(this,"threadsReady",!1),c(this,"updateThreadRootEvents",(s,o,l)=>{if(s.length){var d;if(this.updateThreadRootEvent((d=this.threadsTimelineSets)===null||d===void 0?void 0:d[0],s,o,l),s.hasCurrentUserParticipated){var u;this.updateThreadRootEvent((u=this.threadsTimelineSets)===null||u===void 0?void 0:u[1],s,o,l)}}}),c(this,"updateThreadRootEvent",(s,o,l,d)=>{s&&o.rootEvent&&(d&&s.removeEvent(o.id),Ne.hasServerSideSupport?s.addLiveEvent(o.rootEvent,{duplicateStrategy:mn.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):s.addEventToTimeline(o.rootEvent,s.getLiveTimeline(),{toStartOfTimeline:l,addToState:!1}))}),c(this,"tryApplyRedaction",s=>{if(s.isRedaction()){var o=s.event.redacts,l=o?this.findEventById(o):void 0;l&&this.applyEventAsRedaction(s,l)}else if(s.getType()===x.RoomMember){var d=s.getContent().membership;if(d!==Ee.Ban&&!(d===Ee.Leave&&s.getStateKey()!==s.getSender()))return;var u=s.getContent()["org.matrix.msc4293.redact_events"];if(u!==!0)return;var h=this.getLiveTimeline().getState(be.Forward);if(!h.maySendRedactionForEvent(s,s.getSender()))return;var v=this.getTimelineSets().map(f=>f.getTimelines()).reduce((f,g)=>(f.push(...g),f),[]).map(f=>f.getEvents().filter(g=>g.getSender()===s.getStateKey())).reduce((f,g)=>(f.push(...g),g),[]);for(var m of v)this.applyEventAsRedaction(s,m)}}),this.setMaxListeners(100),this.reEmitter=new Fn(this),a.pendingEventOrdering=a.pendingEventOrdering||Xr.Chronological,this.name=e,this.normalizedName=e,this.relations=new cc(this.client,this),this.on(ie.Receipt,this.onReceipt),this.timelineSets=[new Wr(this,a)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[ie.Timeline,ie.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===Xr.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(s=>{var o=this.client.getEventMapper({toDevice:!1,decrypt:!1});s.forEach(function(){var l=T(function*(d){var u=o(d);yield t.decryptEventIfNeeded(u),u.setStatus(pe.NOT_SENT),n.addPendingEvent(u,u.getTxnId())});return function(d){return l.apply(this,arguments)}}())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return T(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(Pt.My)]);var r=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=r[0],e.threadsTimelineSets[1]=r[1],r}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return T(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),r=e.getLiveTimeline().getEvents(),n=r.findIndex(s=>s.event.event_id===t),a=r.slice(n).reverse().map(s=>e.client.decryptEventIfNeeded(s));yield Promise.allSettled(a)}})()}decryptAllEvents(){var e=this;return T(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(r=>e.client.decryptEventIfNeeded(r));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(x.RoomCreate,"");return(e=t?.getSender())!==null&&e!==void 0?e:null}getVersion(){var e,t=this.currentState.getStateEvents(x.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(E.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getRecommendedVersion(){var e=this;return T(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var r=t["m.room_versions"];if(!r){r={default:Bo,available:{}};for(var n of ff)r.available[n]=xo.Stable}var a=e.checkVersionAgainstCapability(r);if(a.urgent&&a.needsUpgrade){E.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(s){E.warn("Failed to refresh room version capabilities",s)}if(r=t["m.room_versions"],r)a=e.checkVersionAgainstCapability(r);else return E.warn("No room version capability - assuming upgrade required."),a}return a})()}checkVersionAgainstCapability(e){var t=this.getVersion();E.log("[".concat(this.roomId,"] Current version: ").concat(t)),E.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return r;var n=Object.keys(e.available).filter(a=>e.available[a]==="stable");return n.includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?E.warn("URGENT upgrade required on ".concat(this.roomId)):E.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(x.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=Ea(this.pendingEventList,function(r){return r.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.some(n=>n.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.find(n=>n.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var r=t[t.length-1];return r.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,r=this.getLiveTimeline().getEvents(),n=r[r.length-1],a=this.getLastThread();if(!a)return n;var s=a.events[a.events.length-1];return((e=n?.getTs())!==null&&e!==void 0?e:0)>((t=s?.getTs())!==null&&t!==void 0?t:0)?n:s}getLastThread(){return this.getThreads().reduce((e,t)=>{var r,n;if(!e)return t;var a=t.events[t.events.length-1],s=e.events[e.events.length-1];return((r=a?.getTs())!==null&&r!==void 0?r:0)>=((n=s?.getTs())!==null&&n!==void 0?n:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:Ee.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===Ee.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var r;return(r=this.heroes)===null||r===void 0||(r=r[0])===null||r===void 0?void 0:r.userId}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var r=this.currentState.getMembers(),n=r.find(a=>a.userId!==this.myUserId);return n?n.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(bo.name,"");return Array.isArray(e?.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),r=0;if(this.getMembers().forEach(g=>{g.membership!=="join"&&g.membership!=="invite"||t.includes(g.userId)||r++}),!(r>2)){var n=(e=this.heroes)===null||e===void 0?void 0:e.filter(g=>!t.includes(g.userId)),a=Array.isArray(n)&&n.length;if(a){for(var s of n)if(s.fromMSC4186){var l=new wn(this.roomId,s.userId);return l.setMembershipEvent(new ct({event_id:"$"+this.roomId+s.userId+new Date().getTime(),type:x.RoomMember,state_key:s.userId,content:{displayname:s.displayName,avatar_url:s.avatarUrl}})),l}else{var o=this.getMember(s.userId);if(o)return o}var d=n.map(g=>this.getMember(g.userId)).find(g=>!!g);if(d)return d}var u=this.getMembers(),h=u?.filter(g=>!t.includes(g.userId));if(h.length<=2){var v=h.find(g=>g.userId!==this.myUserId);if(v)return v}if(a){var m=n.map(g=>this.client.getUser(g.userId)).find(g=>!!g);if(m){var f=new wn(this.roomId,m.userId);return f.user=m,f}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===Ee.Leave&&this.cleanupAfterLeaving(),this.emit(ie.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return T(function*(){var t=e.client.store.getSyncToken(),r=yield e.client.members(e.roomId,void 0,Ee.Leave,t??void 0);return r.chunk})()}loadMembers(){var e=this;return T(function*(){var t=!1,r=yield e.client.store.getOutOfBandMembers(e.roomId);(r===null||e.hasEncryptionStateEvent())&&(t=!0,r=yield e.loadMembersFromServer(),E.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(e.roomId)));var n=r.filter(Nt).map(e.client.getEventMapper());return{memberEvents:n,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var r=this.currentState.getMembers().filter(a=>a.isOutOfBand()).map(a=>{var s;return(s=a.events.member)===null||s===void 0?void 0:s.event});E.log("LL: telling store to write ".concat(r.length)+" members for room ".concat(this.roomId));var n=this.client.store;return n.setOutOfBandMembers(this.roomId,r).catch(a=>{E.log("LL: storing OOB room members failed, oh well",a)})}}).catch(t=>{E.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return T(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{E.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),E.log(e)})}refreshLiveTimeline(){var e=this;return T(function*(){var t=e.getLiveTimeline(),r=t.getPaginationToken(Z.FORWARDS),n=t.getPaginationToken(Z.BACKWARDS),a=t.getEvents(),s=a[a.length-1];E.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(s&&s.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));var o=e.getUnfilteredTimelineSet(),l;s?(e.resetLiveTimeline(null,null),e.emit(ie.TimelineRefresh,e,o),l=yield e.client.getEventTimeline(o,s.getId())):l=yield e.client.getLatestTimeline(o);var d=o.getLiveTimeline();!d||d.getPaginationToken(be.Forward)===null&&d.getPaginationToken(be.Backward)===null&&d.getEvents().length===0?(E.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),l.setPaginationToken(r,Z.FORWARDS),o.setLiveTimeline(l),e.fixUpLegacyTimelineFields()):E.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(ie.TimelineRefresh,e,o)})()}resetLiveTimeline(e,t){for(var r of this.timelineSets)r.resetLiveTimeline(e??void 0,t??void 0);for(var n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(Z.BACKWARDS),this.currentState=this.getLiveTimeline().getState(Z.FORWARDS),e!==this.oldState&&this.emit(ie.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(ie.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[Re.Events,Re.Members,Re.NewMember,Re.Update,Re.Marker,Fe.New,Fe.Update,Fe.Destroy,Fe.LivenessChange]),this.reEmitter.reEmit(this.currentState,[Re.Events,Re.Members,Re.NewMember,Re.Update,Re.Marker,Fe.New,Fe.Update,Fe.Destroy,Fe.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],r=!1,n=e.getContent();for(var a of Object.values(n))for(var[s,o]of Object.entries(a))if(go(s)&&o){for(var[l,d]of Object.entries(o))if(!(!d||typeof d!="object")){var u=d;l===this.client.getUserId()&&(u.thread_id===void 0?r=!0:typeof u.thread_id=="string"&&t.push(u.thread_id))}}r&&(t=this.getThreads().filter(_=>this.getThreadUnreadNotificationCount(_.id,Me.Total)>0||this.getThreadUnreadNotificationCount(_.id,Me.Highlight)>0).map(_=>_.id),t.push("main"));for(var h of t){var v,m=20,f=h==="main"?this.getLiveTimeline():(v=this.getThread(h))===null||v===void 0?void 0:v.liveTimeline;if(!f){E.warn("Couldn't find timeline for thread ID ".concat(h," in room ").concat(this.roomId));continue}for(var g=f.getEvents(),w=0,S=g.length-1;S>=0;S--){var R;if(S===g.length-m)return;var C=g[S];if(this.hasUserReadEvent(this.client.getUserId(),C.getId()))break;var b=this.client.getPushActionsForEvent(C);w+=b!=null&&(R=b.tweaks)!==null&&R!==void 0&&R.highlight?1:0}h==="main"?this.setUnreadNotificationCount(Me.Highlight,w):this.setThreadUnreadNotificationCount(h,Me.Highlight,w)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var r=this.getThreads(),n=0;n<r.length;n++){var a=r[n];if(t=a.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Me.Total,t=this.getRoomUnreadNotificationCount(e);for(var r of this.threadNotifications.values()){var n;t+=(n=r[e])!==null&&n!==void 0?n:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Me.Total,r=arguments.length>1?arguments[1]:void 0,n=!!r.threadRootId&&!r.isThreadRoot;return(e=n?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Me.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Me.Total;return(t=(r=this.threadNotifications.get(e))===null||r===void 0?void 0:r[n])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,r;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((r=e.total)!==null&&r!==void 0?r:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,a,s=Zn({highlight:(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n.highlight,total:(a=this.threadNotifications.get(e))===null||a===void 0?void 0:a.total},{[t]:r});this.threadNotifications.set(e,s),this.emit(ie.UnreadNotifications,s,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var r,n;if(((r=t.highlight)!==null&&r!==void 0?r:0)>0)return Me.Highlight;((n=t.total)!==null&&n!==void 0?n:0)>0&&!e&&(e=Me.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[r,n]of this.threadNotifications)e.includes(r)||(n.total=0,t||(n.highlight=0));this.emit(ie.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(ie.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,r=(t=e["m.heroes"])===null||t===void 0?void 0:t.map(s=>({userId:s,fromMSC4186:!1})),n=e["m.joined_member_count"],a=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(a)&&this.currentState.setInvitedMemberCount(a),Array.isArray(r)&&(this.heroes=r.filter(s=>s.userId!=this.myUserId)),this.emit(ie.Summary,e)}setMSC4186SummaryData(e,t,r){e&&(this.heroes=e.filter(n=>n.user_id!==this.myUserId).map(n=>({userId:n.user_id,displayName:n.displayname,avatarUrl:n.avatar_url,fromMSC4186:!0}))),t!==void 0&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),r!==void 0&&Number.isInteger(r)&&this.currentState.setInvitedMemberCount(r),this.emit(ie.Summary,{"m.heroes":this.heroes?this.heroes.map(n=>n.userId):[],"m.joined_member_count":t,"m.invited_member_count":r})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,o=this.currentState.getStateEvents(x.RoomAvatar,"");if(!o&&!a)return null;var l=o?o.getContent().url:null;return l?Fi(e,l,t,r,n,void 0,void 0,s):null}getMxcAvatarUrl(){var e;return((e=this.currentState.getStateEvents(x.RoomAvatar,""))===null||e===void 0||(e=e.getContent())===null||e===void 0?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents(x.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents(x.RoomCanonicalAlias,"");return e?e.getContent().alt_aliases||[]:[]}addEventsToTimeline(e,t,r,n,a){n.getTimelineSet().addEventsToTimeline(e,t,r,n,a)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(Ee.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return T(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(Ee.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(Ee.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(x.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var r=this.getMember(e);return r?r.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var a=Object.assign({filter:e,pendingEvents:n},this.opts),s=new Wr(this,a);this.reEmitter.reEmit(s,[ie.Timeline,ie.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=s,this.timelineSets.push(s));var o=this.getLiveTimeline();if(t){o.getEvents().forEach(function(u){s.addLiveEvent(u,{addToState:!1})});for(var l=o;l.getNeighbouringTimeline(Z.BACKWARDS);)l=l.getNeighbouringTimeline(Z.BACKWARDS);s.getLiveTimeline().setPaginationToken(l.getPaginationToken(Z.BACKWARDS),Z.BACKWARDS)}else if(r){var d=o.getPaginationToken(be.Forward);s.getLiveTimeline().setPaginationToken(d,be.Backward)}return s}getThreadListFilter(){var e=arguments,t=this;return T(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:Pt.All,n=t.client.getUserId(),a=new pt(n),s={room:{timeline:{[Hr.name]:[De.name]}}};r===Pt.My&&(s.room.timeline[$r.name]=[n]),a.setDefinition(s);var o=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(r),a);return a.filterId=o,a})()}createThreadTimelineSet(e){var t=this;return T(function*(){var r;if(Ne.hasServerSideListSupport)r=new Wr(t,Zn(Zn({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??Pt.All),t.reEmitter.reEmit(r,[ie.Timeline,ie.TimelineReset]);else if(Ne.hasServerSideSupport){var n=yield t.getThreadListFilter(e);r=t.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else r=new Wr(t,{pendingEvents:!1}),Array.from(t.threads).forEach(a=>{var[,s]=a;if(s.length!==0){var o=s.timeline.some(l=>l.getSender()===t.client.getUserId());(e!==Pt.My||o)&&r.getLiveTimeline().addEvent(s.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return r})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var r of e)Z.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}fetchRoomThreads(){var e=this;return T(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(Ne.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(Pt.All),e.fetchRoomThreadList(Pt.My)]);else{var t=yield e.getThreadListFilter(),{chunk:r}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,be.Backward,t);if(!r.length)return;var n=r.map(e.client.getEventMapper()).sort((v,m)=>{var f=v.getServerAggregatedRelation(De.name),g=m.getServerAggregatedRelation(De.name);return f.latest_event.origin_server_ts-g.latest_event.origin_server_ts}),a,s=e.getLiveTimeline().getState(Z.FORWARDS);for(var o of n){var l,d={duplicateStrategy:mn.Ignore,fromCache:!1,addToState:!1,roomState:s};(l=e.threadsTimelineSets[0])===null||l===void 0||l.addLiveEvent(o,d);var u=o.getServerAggregatedRelation(De.name);if(u!=null&&u.current_user_participated){var h;(h=e.threadsTimelineSets[1])===null||h===void 0||h.addLiveEvent(o,d),a=o}}e.processThreadRoots(n,!0),e.client.decryptEventIfNeeded(n[n.length-1]),a&&e.client.decryptEventIfNeeded(a)}e.on(vt.NewReply,e.onThreadReply),e.on(vt.Update,e.onThreadUpdate),e.on(vt.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return T(function*(){for(var r of e)try{if(!r.isEncrypted()&&!ko(r))continue;yield t.client.decryptEventIfNeeded(r),t.processPollEvent(r)}catch(n){E.warn("Error processing poll event",r.getId(),n)}})()}processPollEvent(e){var t=this;return T(function*(){if(e.isDecryptionFailure()){e.once(Pe.Decrypted,s=>{t.processPollEvent(s)});return}if(Et.M_POLL_START.matches(e.getType())){try{var r=new Po(e,t.client,t);t.polls.set(e.getId(),r),t.emit(rr.New,r),e.once(Pe.BeforeRedaction,s=>{t.polls.delete(s.getId())})}catch{}return}var n=e.relationEventId;if(n&&t.polls.has(n)){var a=t.polls.get(n);a?.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return T(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var r=e===Pt.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:n,end:a}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,be.Backward,r.threadListType,r.getFilter());if(r.getLiveTimeline().setPaginationToken(a??null,be.Backward),!!n.length){var s=n.map(t.client.getEventMapper());t.processThreadRoots(s,!0);var o=t.getLiveTimeline().getState(Z.FORWARDS);for(var l of s)r.addLiveEvent(l,{duplicateStrategy:mn.Replace,fromCache:!1,roomState:o,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var r=this.getTimelineForEvent(e.id),n=r==null||(t=r.getEvents())===null||t===void 0?void 0:t.find(s=>s.getId()===e.id);n?e.clearEventMetadata(n):E.debug("onThreadDelete: Could not find root event in room timeline");for(var a of this.threadsTimelineSets)a.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){var n;if(!((n=this.client)!==null&&n!==void 0&&n.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||r!=null&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var a=e.isRelation(De.name),s=e.getAssociatedId(),o=e.threadRootId;if(s&&!a&&(o===s||r!=null&&r.has(s)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var l;if(s){var d;l=(d=this.findEventById(s))!==null&&d!==void 0?d:t?.find(u=>u.getId()===s)}return l&&!a?this.eventShouldLiveIn(l,t,r):o!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:o}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getThread(e);if(n)n.addEvents(t,r);else{var a,s=(a=this.findEventById(e))!==null&&a!==void 0?a:t.find(o=>o.getId()===e);this.createThread(e,s,t,r)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var r={};for(var n of e){var a,{threadId:s,shouldLiveInThread:o}=this.eventShouldLiveIn(n);o&&!r[s]&&(r[s]=[]),(a=r[s])===null||a===void 0||a.push(n)}Object.entries(r).map(l=>{var[d,u]=l;return this.addThreadedEvents(d,u,t)})}createThread(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var s=this.relations.getAllChildEventsForEvent(t.getId());s!=null&&s.length&&(n=n.concat(s.filter(l=>!l.isRelation(Ke.Replace))))}var o=new Ne(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(r=this.cachedThreadReadReceipts.get(e))!==null&&r!==void 0?r:[]});return this.reEmitter.reEmit(o,[vt.Delete,vt.Update,vt.NewReply,ie.Timeline,ie.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(o.id,o),o.addEvents(n,!1),this.threadsReady&&o.initialEventsFetched&&this.updateThreadRootEvents(o,a,!1),this.emit(vt.New,o,a),o}applyEventAsRedaction(e,t){var r=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var n=this.currentState.getStateEvents(t.getType(),t.getStateKey());n?.getId()===t.getId()&&this.currentState.setStateEvents([t])}this.emit(ie.Redaction,e,this,r),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[r,n]of this.txnToEvent)if(n.getId()===e.getId()){E.debug("processLiveEvent: found sent event without txn ID: ",r,e.getId());var a=e.getUnsigned();a.transaction_id=r,e.setUnsigned(a);break}}}addLiveEvent(e,t){var{duplicateStrategy:r,timelineWasEmpty:n,fromCache:a,addToState:s}=t;for(var o of this.timelineSets)o.addLiveEvent(e,{duplicateStrategy:r,fromCache:a,timelineWasEmpty:n,addToState:s});e.sender&&e.getType()!==x.RoomRedaction&&this.addReceipt(Cc(e.sender.userId,e,ht.Read),!0)}addPendingEvent(e,t){if(e.status!==pe.SENDING&&e.status!==pe.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(Z.setEventMetadata(e,this.getLiveTimeline().getState(Z.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(s=>s.status===pe.NOT_SENT)&&(E.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(pe.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this.pendingEventList.find(s=>s.getId()===r);!n&&r&&(n=this.findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit(ie.Redaction,e,this,n.threadRootId))}}else for(var a of this.timelineSets)a.getFilter()?a.getFilter().filterRoomTimeline([e]).length&&a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(ie.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>Zn(Zn({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var r=t.type===x.RoomMessageEncrypted,n=this.hasEncryptionStateEvent();return r||!n});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var r=t.getId(),n=e.getId(),a=t.status;E.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(a)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:s,threadId:o}=this.eventShouldLiveIn(e),l=o?this.getThread(o):null;if(l?.setEventMetadata(t),l?.timelineSet.handleRemoteEcho(t,r,n),s)for(var d of this.timelineSets)d.handleRemoteEcho(t,r,n);this.emit(ie.LocalEchoUpdated,t,this,r,a)}updatePendingEvent(e,t,r){if(E.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==pe.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==pe.SENT){var n=this.getTimelineForEvent(r);if(n){var a=this.findEventById(r),s=a?.getUnsigned().transaction_id;if(!s&&a){var o=a.getUnsigned();o.transaction_id=e.getTxnId(),a.setUnsigned(o),this.removeEvent(a.getId()),this.handleRemoteEcho(a,e)}return}}var l=e.status,d=e.getId();if(!l)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var u=mf[l];if(!(u!=null&&u.includes(t)))throw new Error("Invalid EventStatus transition ".concat(l,"->").concat(t));if(e.setStatus(t),t==pe.SENT){e.replaceLocalEventId(r);var{shouldLiveInRoom:h,threadId:v}=this.eventShouldLiveIn(e),m=v?this.getThread(v):void 0;if(m?.setEventMetadata(e),m?.timelineSet.replaceEventId(d,r),h)for(var f of this.timelineSets)f.replaceEventId(d,r)}else if(t==pe.CANCELLED){if(this.pendingEventList){var g=this.getPendingEvent(d);this.removePendingEvent(d),g!=null&&g.isRedaction()&&this.revertRedactionLocalEcho(g)}this.removeEvent(d)}this.savePendingEvents(),this.emit(ie.LocalEchoUpdated,e,this,d,l)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(ie.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(Z.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(Z.FORWARDS)+")");if(t.getNeighbouringTimeline(Z.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var r=this;return T(function*(){var{duplicateStrategy:n,fromCache:a,timelineWasEmpty:s=!1,addToState:o}=t;if(n&&["replace","ignore"].indexOf(n)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");r.assertTimelineSetsAreLive();var l=r.findThreadRoots(e),d={},u={duplicateStrategy:n,fromCache:a,timelineWasEmpty:s,addToState:o},h=[...e];for(var v of e){var m;if(r.processLiveEvent(v),v.getUnsigned().transaction_id){var f=r.txnToEvent.get(v.getUnsigned().transaction_id);if(f){r.handleRemoteEcho(v,f);continue}}var{shouldLiveInRoom:g,shouldLiveInThread:w,threadId:S=""}=r.eventShouldLiveIn(v,h,l);if(!w&&!g&&v.isRelation())try{var R=new ct(yield r.client.fetchRoomEvent(r.roomId,v.relationEventId));if(h.push(R),R.threadRootId){l.add(R.threadRootId);var C=v.getUnsigned();C[Oi.name]=R.threadRootId,v.setUnsigned(C)}({shouldLiveInRoom:g,shouldLiveInThread:w,threadId:S=""}=r.eventShouldLiveIn(v,h,l))}catch(b){E.error("Failed to load parent event of unhandled relation",b)}w&&!d[S]&&(d[S]=[]),(m=d[S])===null||m===void 0||m.push(v),g?r.addLiveEvent(v,u):!w&&v.isRelation()&&r.relations.aggregateChildEvent(v)}Object.entries(d).forEach(b=>{var[_,p]=b;r.addThreadedEvents(_,p,!1)})})()}partitionThreadedEvents(e){var t=0,r=1,n=2;if(this.client.supportsThreads()){var a=this.findThreadRoots(e);return e.reduce((s,o)=>{var{shouldLiveInRoom:l,shouldLiveInThread:d,threadId:u}=this.eventShouldLiveIn(o,e,a);return l&&s[t].push(o),d&&(o.setThreadId(u??""),s[r].push(o)),!d&&!l&&s[n].push(o),s},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var r of e){var n=r.threadRootId;n!=null&&t.add(n)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach(n=>{Object.keys(r[n]).forEach(a=>{Object.keys(r[n][a]).forEach(s=>{var o,l,d,u=r[n][a][s],h=!u.thread_id||u.thread_id===Dn,v=h?this:this.threads.get((o=u.thread_id)!==null&&o!==void 0?o:"");if(v){if(v.addReceiptToStructure(n,a,s,u,t),!t&&this.client.isInitialSyncComplete()&&s===this.client.getUserId()){var m=v.timeline[v.timeline.length-1];m&&n===m.getId()&&s===m.getSender()&&(v.setUnread(Me.Total,0),v.setUnread(Me.Highlight,0))}}else{var f;this.cachedThreadReadReceipts.set(u.thread_id,[...(f=this.cachedThreadReadReceipts.get(u.thread_id))!==null&&f!==void 0?f:[],{eventId:n,receiptType:a,userId:s,receipt:u,synthetic:t}])}var g=this.client.getUserId();s===g&&!h&&u.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=u.ts),!u.thread_id&&u.ts>((l=(d=this.unthreadedReceipts.get(s))===null||d===void 0?void 0:d.ts)!==null&&l!==void 0?l:0)&&this.unthreadedReceipts.set(s,u)})})}),this.emit(ie.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===x.Typing?this.currentState.setTypingEvent(t):t.getType()===x.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var r of this.timelineSets){var n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(x.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===Ee.Invite){var r=e.getUnsigned().invite_room_state||[];r.forEach(a=>{var s=this.currentState.getStateEvents(a.type,a.state_key);s||this.currentState.setStateEvents([new ct({type:a.type,state_key:a.state_key,content:a.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var n=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=lv(this.name),this.summary=new Co(this.roomId,{title:this.name}),n!==this.name&&this.emit(ie.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(ie.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var r=t.getType(),n=this.accountData.get(r);this.accountData.set(r,t),this.emit(ie.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===Ee.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(x.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(x.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===Ee.Join,r=this.currentState.getStateEvents(x.RoomPowerLevels,""),n=r&&r.getContent(),a=this.getMember(e);return n&&a&&n.invite>a.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(x.RoomCreate,"");if(!e){this.getTypeWarning||(E.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[Ci]}isSpaceRoom(){return this.getType()===Kr.Space}isCallRoom(){return this.getType()===Kr.UnstableCall}isElementVideoRoom(){return this.getType()===Kr.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(Z.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case Dt.Actual:return e.name;case Dt.Generated:switch(e.subtype){case"Inviting":return"Inviting ".concat(Rd(e.names,e.count));default:return Rd(e.names,e.count)}case Dt.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var r=this.currentState.getStateEvents(x.RoomName,"");if(r!=null&&r.getContent().name)return this.roomNameGenerator({type:Dt.Actual,name:r.getContent().name})}var n=this.getCanonicalAlias();if(n)return this.roomNameGenerator({type:Dt.Actual,name:n});var a=this.currentState.getJoinedMemberCount(),s=this.currentState.getInvitedMemberCount(),o=a+s-1,l=this.getFunctionalMembers(),d=[];if(this.heroes)this.heroes.forEach(S=>{if(l.includes(S.userId)){o--;return}if(S.displayName)d.push(S.displayName);else{var R=this.getMember(S.userId);d.push(R?R.name:S.userId)}});else{var u=this.currentState.getMembers().filter(S=>S.userId!==e&&(S.membership===Ee.Invite||S.membership===Ee.Join));u=u.filter(S=>{var{userId:R}=S;return l.includes(R)?(o--,!1):!0});var h=new Intl.Collator;u.sort((S,R)=>h.compare(S.userId,R.userId)),u=u.slice(0,5),d=u.map(S=>S.name)}if(o)return this.roomNameGenerator({type:Dt.Generated,names:d,count:o});var v=this.getMyMembership();if(v==Ee.Join){var m=this.currentState.getStateEvents(x.RoomThirdPartyInvite);if(m!=null&&m.length){var f=m.map(S=>S.getContent().display_name);return this.roomNameGenerator({type:Dt.Generated,subtype:"Inviting",names:f,count:f.length+1})}}var g=d;g.length||(g=this.currentState.getMembers().filter(S=>S.userId!==e&&S.membership!==Ee.Invite&&S.membership!==Ee.Join).map(S=>S.name));var w;return g.length&&(w=this.roomNameGenerator({type:Dt.Generated,names:g,count:g.length+1})),this.roomNameGenerator({type:Dt.EmptyRoom,oldName:w})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var r=e.getSender();if(r){var n=yr.name&&this.currentState.maySendStateEvent(yr.name,r)||yr.altName&&this.currentState.maySendStateEvent(yr.altName,r);if(n){var a=this.visibilityEvents.get(t.eventId);if(a){for(var s=a.length-1,o=Math.max(0,a.length-pf);s>=o;--s){var l=a[s];if(l.getTs()<e.getTs())break}s===-1?a.unshift(e):a.splice(s+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var d=this.findEventById(t.eventId);d&&d.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),r=t?.event_id,n=this.visibilityEvents.get(r);if(n){var a=n.findIndex(d=>d.getId()===e.getId());if(a!==-1&&(n.splice(a,1),a===n.length)){var s=this.findEventById(r);if(!s)return;if(a===0)this.visibilityEvents.delete(r),s.applyVisibilityEvent();else{var o=n[n.length-1],l=o.asVisibilityChange();if(!l)throw new Error("at this stage, visibility changes should be well-formed");s.applyVisibilityEvent(l)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,!(r.getTs()<e.getTs())&&e.applyVisibilityEvent(n))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(n=>this.getThreadUnreadNotificationCount(n.id,Me.Total)>0);for(var r of t)r.fixupNotifications(e)}compareEventOrdering(e,t){return zv(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(Z.FORWARDS))===null||e===void 0)&&e.getStateEvents(x.RoomEncryption,""))}}var mf={[pe.ENCRYPTING]:[pe.SENDING,pe.NOT_SENT,pe.CANCELLED],[pe.SENDING]:[pe.ENCRYPTING,pe.QUEUED,pe.NOT_SENT,pe.SENT],[pe.QUEUED]:[pe.SENDING,pe.NOT_SENT,pe.CANCELLED],[pe.SENT]:[],[pe.NOT_SENT]:[pe.SENDING,pe.QUEUED,pe.CANCELLED],[pe.CANCELLED]:[]},Dt=function(i){return i[i.EmptyRoom=0]="EmptyRoom",i[i.Generated=1]="Generated",i[i.Actual=2]="Actual",i}({});function Rd(i,e){var t=e-1;if(i.length){if(i.length===1&&t<=1)return i[0];if(i.length===2&&t<=2)return"".concat(i[0]," and ").concat(i[1]);var r=t>1;return r?"".concat(i[0]," and ").concat(t," others"):"".concat(i[0]," and 1 other")}else return"Empty room"}var tt=function(i){return i[i.Stable=0]="Stable",i[i.Unstable=1]="Unstable",i[i.Unsupported=2]="Unsupported",i}({}),nt=function(i){return i.Thread="Thread",i.ThreadUnreadNotifications="ThreadUnreadNotifications",i.LoginTokenRequest="LoginTokenRequest",i.RelationBasedRedactions="RelationBasedRedactions",i.AccountDataDeletion="AccountDataDeletion",i.RelationsRecursion="RelationsRecursion",i.IntentionalMentions="IntentionalMentions",i}({}),gf={[nt.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[nt.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[nt.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[nt.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[nt.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[nt.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[nt.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function yf(i){return Js.apply(this,arguments)}function Js(){return Js=T(function*(i){var e=new Map;for(var[t,r]of Object.entries(gf)){var n,a,s,o,l=(n=(a=i.versions)===null||a===void 0?void 0:a.includes(r.matrixVersion||""))!==null&&n!==void 0?n:!1,d=(s=(o=r.unstablePrefixes)===null||o===void 0?void 0:o.every(u=>{var h;return((h=i.unstable_features)===null||h===void 0?void 0:h[u])===!0}))!==null&&s!==void 0?s:!1;l?e.set(t,tt.Stable):d?e.set(t,tt.Unstable):e.set(t,tt.Unsupported)}return e}),Js.apply(this,arguments)}function Td(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Aa(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Td(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Td(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Id=80*1e3,Sf=3,ke=function(i){return i.Error="ERROR",i.Prepared="PREPARED",i.Stopped="STOPPED",i.Syncing="SYNCING",i.Catchup="CATCHUP",i.Reconnecting="RECONNECTING",i}({}),Ef=["org.matrix.msc2716v3"];function Cd(i,e){return"FILTER_SYNC_".concat(i)+(e?"_"+e:"")}function We(){E.log(...arguments)}var Wo=function(i){return i.Offline="offline",i.Online="online",i.Unavailable="unavailable",i}({});function Lc(i){return Aa({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:Xr.Chronological,threadSupport:!1},i)}function Uc(i){return Aa({canResetEntireTimeline:e=>!1},i)}class Sr{constructor(e,t,r){var n=this;this.client=e,c(this,"opts",void 0),c(this,"syncOpts",void 0),c(this,"_peekRoom",null),c(this,"currentSyncRequest",void 0),c(this,"abortController",void 0),c(this,"syncState",null),c(this,"syncStateData",void 0),c(this,"catchingUp",!1),c(this,"running",!1),c(this,"keepAliveTimer",void 0),c(this,"connectionReturnedResolvers",void 0),c(this,"notifEvents",[]),c(this,"failedSyncCount",0),c(this,"storeIsInvalid",!1),c(this,"presence",void 0),c(this,"getPushRules",T(function*(){try{We("Getting push rules...");var a=yield n.client.getPushRules();We("Got push rules"),n.client.pushRules=a}catch(s){return E.error("Getting push rules failed",s),n.shouldAbortSync(s)?void 0:(We("Waiting for saved sync before retrying push rules..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,s),n.getPushRules())}})),c(this,"buildDefaultFilter",()=>{var a=new pt(this.client.credentials.userId);return this.client.canSupport.get(nt.ThreadUnreadNotifications)!==tt.Unsupported&&a.setUnreadThreadNotifications(!0),a}),c(this,"prepareLazyLoadingForSync",T(function*(){We("Prepare lazy loading for sync..."),n.client.isGuest()&&(n.opts.lazyLoadMembers=!1),n.opts.lazyLoadMembers&&(We("Enabling lazy load on sync filter..."),n.opts.filter||(n.opts.filter=n.buildDefaultFilter()),n.opts.filter.setLazyLoadMembers(!0))})),c(this,"storeClientOptions",T(function*(){try{We("Storing client options..."),yield n.client.storeClientOptions(),We("Stored client options")}catch(a){throw E.error("Storing client options failed",a),a}})),c(this,"getFilter",T(function*(){We("Getting filter...");var a;n.opts.filter?a=n.opts.filter:a=n.buildDefaultFilter();var s;try{s=yield n.client.getOrCreateFilter(Cd(n.client.credentials.userId),a)}catch(o){return E.error("Getting filter failed",o),n.shouldAbortSync(o)?{}:(We("Waiting for saved sync before retrying filter..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,o),n.getFilter())}return{filter:a,filterId:s}})),c(this,"savedSyncPromise",void 0),c(this,"onOnline",()=>{We("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=Lc(t),this.syncOpts=Uc(r),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[ie.Timeline,ie.TimelineReset])}createRoom(e){var t=Nc(this.client,e,this.opts);return t.on(Re.Marker,(r,n)=>{this.onMarkerStateEvent(t,r,n)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:r}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(r){E.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var n=Ef.includes(e.getVersion())||t.getSender()===e.getCreator();n?(E.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(ie.HistoryImportedWithinTimeline,t,e)):E.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return T(function*(){var t,r=e.client,n=new pt(e.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);var a=e.opts.pollTimeout+Id,s=yield r.getOrCreateFilter(Cd(r.credentials.userId,"LEFT_ROOMS"),n),o={timeout:0,filter:s,"org.matrix.msc4222.use_state_after":!0},l=yield r.http.authedRequest(q.Get,"/sync",o,void 0,{localTimeoutMs:a}),d=[];(t=l.rooms)!==null&&t!==void 0&&t.leave&&(d=e.mapSyncResponseToRoomArray(l.rooms.leave));var u=yield Promise.all(d.map(function(){var h=T(function*(v){var m=v.room;if(v.isBrandNewRoom){v.timeline=v.timeline||{prev_batch:null,events:[]},m.getLiveTimeline().setPaginationToken(v.timeline.prev_batch,Z.BACKWARDS);var{timelineEvents:f}=yield e.mapAndInjectRoomEvents(v);return m.recalculate(),r.store.storeRoom(m),r.emit(ae.Room,m),e.processEventsForNotifs(m,f),m}});return function(v){return h.apply(this,arguments)}}()));return u.filter(Boolean)})()}peek(e){var t,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var n=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,r).then(a=>{var s;if(((s=this._peekRoom)===null||s===void 0?void 0:s.roomId)!==e)throw new Error("Peeking aborted");a.messages=a.messages||{chunk:[]},a.messages.chunk=a.messages.chunk||[],a.state=a.state||[];var o=Ui(a.state).map(n.getEventMapper()),l=a.state.map(n.getEventMapper()),d=a.messages.chunk.map(n.getEventMapper());return Array.isArray(a.presence)&&a.presence.map(n.getEventMapper()).forEach(function(u){var h=n.store.getUser(u.getContent().user_id);h?h.setPresenceEvent(u):(h=Xt.createUser(u.getContent().user_id,n),h.setPresenceEvent(u),n.store.storeUser(h)),n.emit(ae.Event,u)}),a.messages.start&&(this._peekRoom.oldState.paginationToken=a.messages.start),this._peekRoom.oldState.setStateEvents(o),this._peekRoom.currentState.setStateEvents(l),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(d.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),a.messages.start),n.store.storeRoom(this._peekRoom),n.emit(ae.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var r,n=this;if(this._peekRoom!==e){We("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(q.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal}).then(function(){var a=T(function*(s){if(n._peekRoom!==e){We("Stopped peeking in room %s",e.roomId);return}s.chunk.filter(function(l){return l.type==="m.presence"}).map(n.client.getEventMapper()).forEach(l=>{var d=n.client.store.getUser(l.getContent().user_id);d?d.setPresenceEvent(l):(d=Xt.createUser(l.getContent().user_id,n.client),d.setPresenceEvent(l),n.client.store.storeUser(d)),n.client.emit(ae.Event,l)});var o=s.chunk.filter(function(l){return l.room_id===e.roomId&&l.event_id}).map(n.client.getEventMapper());yield e.addLiveEvents(o,{addToState:!0}),n.peekPoll(e,s.end)});return function(s){return a.apply(this,arguments)}}(),a=>{E.error("[%s] Peek poll failed: %s",e.roomId,a),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var r=this;return T(function*(){yield e;var n=r.startKeepAlives();r.updateSyncState(ke.Error,{error:t}),yield n})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(E.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(ke.Error,{error:e}),!0):!1}sync(){var e=this;return T(function*(){var t,r;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(r=t.addEventListener)===null||r===void 0||r.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});We("Getting saved sync token...");var n=e.client.store.getSavedSyncToken().then(u=>(We("Got saved sync token"),u));e.savedSyncPromise=e.client.store.getSavedSync().then(u=>{if(We("Got reply from saved sync, exists? ".concat(!!u)),u)return e.syncFromCache(u)}).catch(u=>{E.error("Getting saved sync failed",u)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:a,filter:s}=yield e.getFilter();if(s){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var o=a,l=yield n;if(l)We("Sending first sync request...");else{We("Sending initial sync request...");var d=e.buildDefaultFilter();d.setDefinition(s.getDefinition()),d.setTimelineLimit(e.opts.initialSyncLimit),o=JSON.stringify(d.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:o},l)}return We("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:a})}})()}stop(){var e,t,r;We("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(r=this.abortController)===null||r===void 0||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedResolvers?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return T(function*(){We("sync(): not doing HTTP hit, instead returning stored /sync data");var r=e.nextBatch;t.client.store.setSyncToken(r);var n={nextSyncToken:r,catchingUp:!1,fromCache:!0},a={next_batch:r,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(n,a)}catch(s){E.error("Error processing cached sync",s)}t.storeIsInvalid||t.updateSyncState(ke.Prepared,n)})()}doSync(e){var t=this;return T(function*(){for(;t.running;){var r=t.client.store.getSyncToken(),n=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,r)),n=yield t.currentSyncRequest}catch(o){var a=yield t.onSyncError(o);if(a)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(n.next_batch),t.failedSyncCount=0;var s={oldSyncToken:r??void 0,nextSyncToken:n.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(s,n)}catch(o){E.error("Caught /sync error",o),t.client.emit(ae.SyncUnexpectedError,o)}yield t.client.store.setSyncData(n),s.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(ke.Prepared,s),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(s)),t.updateSyncState(ke.Syncing,s),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(We("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(ke.Stopped))})()}doSyncRequest(e,t){var r,n=this.getSyncParams(e,t);return this.client.http.authedRequest(q.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+Id,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal})}getSyncParams(e,t){var r=this.opts.pollTimeout;(this.getSyncState()!==ke.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);var n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());var a={filter:n,timeout:r,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?a.set_presence=Wo.Offline:this.presence!==void 0&&(a.set_presence=this.presence),t?a.since=t:a._cacheBuster=Date.now(),[ke.Reconnecting,ke.Error].includes(this.getSyncState())&&(a.timeout=0),a}setPresence(e){this.presence=e}onSyncError(e){var t=this;return T(function*(){if(!t.running)return We("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(ke.Stopped),!0;if(E.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,E.log("Number of consecutive failed sync requests:",t.failedSyncCount),We("Starting keep-alive");var r=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=Sf?ke.Error:ke.Reconnecting,{error:e});var n=yield r;return n&&t.getSyncState()===ke.Error&&t.updateSyncState(ke.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var r=this;return T(function*(){var n,a,s,o,l=r.client;if(Array.isArray((n=t.presence)===null||n===void 0?void 0:n.events)&&t.presence.events.filter(Nt).map(l.getEventMapper()).forEach(function(w){var S=l.store.getUser(w.getSender());S?S.setPresenceEvent(w):(S=Xt.createUser(w.getSender(),l),S.setPresenceEvent(w),l.store.storeUser(S)),l.emit(ae.Event,w)}),Array.isArray((a=t.account_data)===null||a===void 0?void 0:a.events)){var d=t.account_data.events.filter(Nt).map(l.getEventMapper()),u=d.reduce((w,S)=>(w[S.getType()]=l.store.getAccountData(S.getType()),w),{});l.store.storeAccountDataEvents(d),d.forEach(function(w){if(w.getType()===x.PushRules){var S=w.getContent();l.setPushRules(S)}var R=u[w.getType()];return l.emit(ae.AccountData,w,R),w})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var h=t.to_device.events.filter(Nt);r.syncOpts.cryptoCallbacks&&(h=yield r.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(h)),Fc(h,l)}else r.catchingUp=!1;var v=[],m=[],f=[],g=[];t.rooms&&(t.rooms.invite&&(v=r.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(m=r.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(f=r.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(g=r.mapSyncResponseToRoomArray(t.rooms.knock))),r.notifEvents=[],yield fn(v,function(){var w=T(function*(S){var R=S.room,C=r.mapSyncEventsFormat(S.invite_state,R);yield r.injectRoomEvents(R,C,void 0),S.isBrandNewRoom?(R.recalculate(),l.store.storeRoom(R),l.emit(ae.Room,R)):R.recalculate(),C.forEach(function(b){l.emit(ae.Event,b)})});return function(S){return w.apply(this,arguments)}}()),yield fn(m,function(){var w=T(function*(S){var R,C=S.room,b=r.mapSyncEventsFormat(S.state,C),_=r.mapSyncEventsFormat(S["org.matrix.msc4222.state_after"],C),p=r.mapSyncEventsFormat(S.timeline,C,!1),I=r.mapSyncEventsFormat(S.ephemeral),y=r.mapSyncEventsFormat(S.account_data),P=S["org.matrix.msc4222.state_after"]?_:b.concat(p),L=r.isRoomEncrypted(C,P);if(S.unread_notifications){if(!L||S.unread_notifications.notification_count===0){var V;C.setUnreadNotificationCount(Me.Total,(V=S.unread_notifications.notification_count)!==null&&V!==void 0?V:0)}if(!L||C.getUnreadNotificationCount(Me.Highlight)<=0){var te;C.setUnreadNotificationCount(Me.Highlight,(te=S.unread_notifications.highlight_count)!==null&&te!==void 0?te:0)}}var ve=(R=S[Mi.name])!==null&&R!==void 0?R:S[Mi.altName];if(ve){C.resetThreadUnreadNotificationCountFromSync(Object.keys(ve));for(var[Oe,H]of Object.entries(ve)){if(!L||H.notification_count===0){var ee;C.setThreadUnreadNotificationCount(Oe,Me.Total,(ee=H.notification_count)!==null&&ee!==void 0?ee:0)}var se=C.getThreadUnreadNotificationCount(Oe,Me.Highlight)<=0;if(!L||L&&se){var de;C.setThreadUnreadNotificationCount(Oe,Me.Highlight,(de=H.highlight_count)!==null&&de!==void 0?de:0)}}}else C.resetThreadUnreadNotificationCountFromSync();if(S.timeline=S.timeline||{},S.isBrandNewRoom)S.timeline.prev_batch!==null&&C.getLiveTimeline().setPaginationToken(S.timeline.prev_batch,Z.BACKWARDS);else if(S.timeline.limited){for(var fe=!0,Te=p.length-1;Te>=0;Te--){var Ze=p[Te].getId();if(C.getTimelineForEvent(Ze)){We("Already have event ".concat(Ze," in limited sync - not resetting")),fe=!1,p.splice(0,Te);break}}if(fe){var $;C.resetLiveTimeline(S.timeline.prev_batch,r.syncOpts.canResetEntireTimeline(C.roomId)?null:($=e.oldSyncToken)!==null&&$!==void 0?$:null),l.resetNotifTimelineSet()}}if(r.syncOpts.cryptoCallbacks)for(var X of P)X.isState()&&X.getType()===x.RoomEncryption&&X.getStateKey()===""&&(yield r.syncOpts.cryptoCallbacks.onCryptoEvent(C,X));try{"org.matrix.msc4222.state_after"in S?yield r.injectRoomEvents(C,void 0,_,p,e.fromCache):yield r.injectRoomEvents(C,b,void 0,p,e.fromCache)}catch(D){E.error("Failed to process events on room ".concat(C.roomId,":"),D)}S.summary&&C.setSummary(S.summary),C.addEphemeralEvents(I),C.addAccountData(y),C.recalculate(),S.isBrandNewRoom&&(l.store.storeRoom(C),l.emit(ae.Room,C)),r.processEventsForNotifs(C,p);var F=D=>l.emit(ae.Event,D);b.forEach(F),p.forEach(F),I.forEach(F),y.forEach(F),C.decryptCriticalEvents()});return function(S){return w.apply(this,arguments)}}()),yield fn(f,function(){var w=T(function*(S){var R=S.room,{timelineEvents:C,stateEvents:b,stateAfterEvents:_}=yield r.mapAndInjectRoomEvents(S),p=r.mapSyncEventsFormat(S.account_data);R.addAccountData(p),R.recalculate(),S.isBrandNewRoom&&(l.store.storeRoom(R),l.emit(ae.Room,R)),r.processEventsForNotifs(R,C),b?.forEach(function(I){l.emit(ae.Event,I)}),_?.forEach(function(I){l.emit(ae.Event,I)}),C.forEach(function(I){l.emit(ae.Event,I)}),p.forEach(function(I){l.emit(ae.Event,I)})});return function(S){return w.apply(this,arguments)}}()),yield fn(g,function(){var w=T(function*(S){var R=S.room,C=r.mapSyncEventsFormat(S.knock_state,R);yield r.injectRoomEvents(R,C,void 0),S.isBrandNewRoom?(R.recalculate(),l.store.storeRoom(R),l.emit(ae.Room,R)):R.recalculate(),C.forEach(function(b){l.emit(ae.Event,b)})});return function(S){return w.apply(this,arguments)}}()),e.oldSyncToken&&r.notifEvents.length&&(r.notifEvents.sort(function(w,S){return w.getTs()-S.getTs()}),r.notifEvents.forEach(function(w){var S;(S=l.getNotifTimelineSet())===null||S===void 0||S.addLiveEvent(w,{addToState:!0})})),t.device_lists&&r.syncOpts.cryptoCallbacks&&(yield r.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(s=r.syncOpts.cryptoCallbacks)===null||s===void 0?void 0:s.processKeyCounts(t.device_one_time_keys_count,(o=t.device_unused_fallback_key_types)!==null&&o!==void 0?o:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)};this.client.http.request(q.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{r()},n=>{n.httpStatus==400||n.httpStatus==404?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(ke.Error,{error:n}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(r=>!mi(r)).map(r=>{var n=t.store.getRoom(r),a=!1;return n||(n=this.createRoom(r),a=!0),Aa(Aa({},e[r]),{},{room:n,isBrandNewRoom:a})})}mapSyncEventsFormat(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.filter(Nt).map(function(a){return t&&(a.room_id=t.roomId),n(a)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ee.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),a;n?a=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):a=t.getProfileInfo(r.userId),a.then(function(s){var o=r.events.member;o?.getContent().membership===Ee.Invite&&(o.getContent().avatar_url=s.avatar_url,o.getContent().displayname=s.displayname,r.setMembershipEvent(o,e.currentState))},function(s){})}})}}findEncryptionEvent(e){return e?.find(t=>t.getType()===x.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return T(function*(){var r=t.mapSyncEventsFormat(e.state,e.room),n=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),a=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,n,a):yield t.injectRoomEvents(e.room,r,void 0,a),{timelineEvents:a,stateEvents:r,stateAfterEvents:n}})()}injectRoomEvents(e,t,r,n){var a=arguments,s=this;return T(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:!1,l=r??t,d=e.getLiveTimeline(),u=d.getEvents().length==0;if(u){for(var h of l)s.client.getPushActionsForEvent(h);d.initialiseState(l,{timelineWasEmpty:u})}s.resolveInvites(e),e.recalculate(),u||(e.oldState.setStateEvents(l),e.currentState.setStateEvents(l)),yield e.addLiveEvents(n||[],{fromCache:o,timelineWasEmpty:u,addToState:r===void 0}),s.client.processBeaconEvents(e,n)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var r of t){var n,a=this.client.getPushActionsForEvent(r);a!=null&&a.notify&&(n=a.tweaks)!==null&&n!==void 0&&n.highlight&&this.notifEvents.push(r)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ae.Sync,this.syncState,r,t)}}function Nc(i,e,t){var{timelineSupport:r}=i,n=new Wi(e,i,i.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:r});return i.reEmitter.reEmit(n,[ie.Name,ie.Redaction,ie.RedactionCancelled,ie.Receipt,ie.Tags,ie.LocalEchoUpdated,ie.AccountData,ie.MyMembership,ie.Timeline,ie.TimelineReset,Re.Events,Re.Members,Re.NewMember,Re.Update,Fe.New,Fe.Update,Fe.Destroy,Fe.LivenessChange]),n.on(Re.NewMember,(a,s,o)=>{var l;o.user=(l=i.getUser(o.userId))!==null&&l!==void 0?l:void 0,i.reEmitter.reEmit(o,[mt.Name,mt.Typing,mt.PowerLevel,mt.Membership])}),n}function Fc(i,e){var t=[];i.map(bf).map(r=>{if(r.getType()==="m.key.verification.cancel"){var n=r.getContent().transaction_id;n&&t.push(n)}return r}).forEach(function(r){var n=r.getContent();if(r.getType()=="m.room.message"&&n.msgtype=="m.bad.encrypted"){E.log("Ignoring undecryptable to-device event from "+r.getSender());return}if(r.getType()==="m.key.verification.start"||r.getType()==="m.key.verification.request"){var a=n.transaction_id;t.includes(a)&&r.flagCancelled()}e.emit(ae.ToDeviceEvent,r)})}function bf(i){return delete i.room_id,new ct(i)}class _f{constructor(){c(this,"accountData",new Map),c(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return T(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return T(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return T(function*(){return Promise.resolve()})()}destroy(){return T(function*(){})()}}const lt=[];for(let i=0;i<256;++i)lt.push((i+256).toString(16).slice(1));function wf(i,e=0){return(lt[i[e+0]]+lt[i[e+1]]+lt[i[e+2]]+lt[i[e+3]]+"-"+lt[i[e+4]]+lt[i[e+5]]+"-"+lt[i[e+6]]+lt[i[e+7]]+"-"+lt[i[e+8]]+lt[i[e+9]]+"-"+lt[i[e+10]]+lt[i[e+11]]+lt[i[e+12]]+lt[i[e+13]]+lt[i[e+14]]+lt[i[e+15]]).toLowerCase()}let Es;const Rf=new Uint8Array(16);function Tf(){if(!Es){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Es=crypto.getRandomValues.bind(crypto)}return Es(Rf)}const If=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Od={randomUUID:If};function Cf(i,e,t){if(Od.randomUUID&&!i)return Od.randomUUID();i=i||{};const r=i.random??i.rng?.()??Tf();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,wf(r)}var kt={},bs={},_s={exports:{}},Md;function qo(){if(Md)return _s.exports;Md=1;var i=_s.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(i).forEach(function(e){var t=i[e];t.forEach(function(r){r.reg||(r.reg=/(.*)/),r.format||(r.format="%s")})}),_s.exports}var Pd;function Of(){return Pd||(Pd=1,function(i){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,l,d,u){if(u&&!d)l[u]=e(o[1]);else for(var h=0;h<d.length;h+=1)o[h+1]!=null&&(l[d[h]]=e(o[h+1]))},r=function(o,l,d){var u=o.name&&o.names;o.push&&!l[o.push]?l[o.push]=[]:u&&!l[o.name]&&(l[o.name]={});var h=o.push?{}:u?l[o.name]:l;t(d.match(o.reg),h,o.names,o.name),o.push&&l[o.push].push(h)},n=qo(),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);i.parse=function(o){var l={},d=[],u=l;return o.split(/(\r\n|\r|\n)/).filter(a).forEach(function(h){var v=h[0],m=h.slice(2);v==="m"&&(d.push({rtp:[],fmtp:[]}),u=d[d.length-1]);for(var f=0;f<(n[v]||[]).length;f+=1){var g=n[v][f];if(g.reg.test(m))return r(g,u,m)}}),l.media=d,l};var s=function(o,l){var d=l.split(/=(.+)/,2);return d.length===2?o[d[0]]=e(d[1]):d.length===1&&l.length>1&&(o[d[0]]=void 0),o};i.parseParams=function(o){return o.split(/;\s?/).reduce(s,{})},i.parseFmtpConfig=i.parseParams,i.parsePayloads=function(o){return o.toString().split(" ").map(Number)},i.parseRemoteCandidates=function(o){for(var l=[],d=o.split(" ").map(e),u=0;u<d.length;u+=3)l.push({component:d[u],ip:d[u+1],port:d[u+2]});return l},i.parseImageAttributes=function(o){return o.split(" ").map(function(l){return l.substring(1,l.length-1).split(",").reduce(s,{})})},i.parseSimulcastStreamList=function(o){return o.split(";").map(function(l){return l.split(",").map(function(d){var u,h=!1;return d[0]!=="~"?u=e(d):(u=e(d.substring(1,d.length)),h=!0),{scid:u,paused:h}})})}}(bs)),bs}var ws,kd;function Mf(){if(kd)return ws;kd=1;var i=qo(),e=/%[sdv%]/g,t=function(s){var o=1,l=arguments,d=l.length;return s.replace(e,function(u){if(o>=d)return u;var h=l[o];switch(o+=1,u){case"%%":return"%";case"%s":return String(h);case"%d":return Number(h);case"%v":return""}})},r=function(s,o,l){var d=o.format instanceof Function?o.format(o.push?l:l[o.name]):o.format,u=[s+"="+d];if(o.names)for(var h=0;h<o.names.length;h+=1){var v=o.names[h];o.name?u.push(l[o.name][v]):u.push(l[o.names[h]])}else u.push(l[o.name]);return t.apply(null,u)},n=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];return ws=function(s,o){o=o||{},s.version==null&&(s.version=0),s.name==null&&(s.name=" "),s.media.forEach(function(h){h.payloads==null&&(h.payloads="")});var l=o.outerOrder||n,d=o.innerOrder||a,u=[];return l.forEach(function(h){i[h].forEach(function(v){v.name in s&&s[v.name]!=null?u.push(r(h,v,s)):v.push in s&&s[v.push]!=null&&s[v.push].forEach(function(m){u.push(r(h,v,m))})})}),s.media.forEach(function(h){u.push(r("m",i.m[0],h)),d.forEach(function(v){i[v].forEach(function(m){m.name in h&&h[m.name]!=null?u.push(r(v,m,h)):m.push in h&&h[m.push]!=null&&h[m.push].forEach(function(f){u.push(r(v,m,f))})})})}),u.join(`\r
`)+`\r
`},ws}var Ad;function Pf(){if(Ad)return kt;Ad=1;var i=Of(),e=Mf(),t=qo();return kt.grammar=t,kt.write=e,kt.parse=i.parse,kt.parseParams=i.parseParams,kt.parseFmtpConfig=i.parseFmtpConfig,kt.parsePayloads=i.parsePayloads,kt.parseRemoteCandidates=i.parseRemoteCandidates,kt.parseImageAttributes=i.parseImageAttributes,kt.parseSimulcastStreamList=i.parseSimulcastStreamList,kt}var zs=Pf();function Ko(i,e){if(typeof i.toBase64=="function")return i.toBase64(e);var t=btoa(i.reduce((r,n)=>r+String.fromCharCode(n),""));return e.omitPadding&&(t=t.replace(/={1,2}$/,"")),e.alphabet==="base64url"&&(t=t.replace(/\+/g,"-").replace(/\//g,"_")),t}function yi(i){return Ko(i,{alphabet:"base64",omitPadding:!1})}function Vo(i){return Ko(i,{alphabet:"base64",omitPadding:!0})}function qi(i){return Ko(i,{alphabet:"base64url",omitPadding:!0})}function kf(i,e){return typeof Uint8Array.fromBase64=="function"?Uint8Array.fromBase64(i,e):Uint8Array.from(atob(i),t=>t.charCodeAt(0))}function Gr(i){return kf(i.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}var Af="abcdefghijklmnopqrstuvwxyz",Df="ABCDEFGHIJKLMNOPQRSTUVWXYZ",Lf="0123456789";function Uf(i){var e=new Uint8Array(i);return globalThis.crypto.getRandomValues(e),qi(e)}function _r(i){return Nf(i,Df+Af+Lf)}function Nf(i,e){if(e.length<2||e.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(i<1||i>32768)throw new Error("Requested random string length must be between 1 and 32768");for(var t=256-256%e.length,r=new Uint8Array(Math.floor(i*1.3)),n=r.length,a=[];a.length<i;){n===r.length&&(globalThis.crypto.getRandomValues(r),n=0);var s=r[n++];s<t&&a.push(e[s%e.length])}return a.join("")}var hr="org.matrix.msc3077.sdp_stream_metadata",Ue=function(i){return i.Usermedia="m.usermedia",i.Screenshare="m.screenshare",i}({}),Si=null,Ys=0,Ff=()=>(Si===null&&(Si=new AudioContext),Ys++,Si),xf=()=>{if(Ys--,Ys===0){var i;(i=Si)===null||i===void 0||i.close(),Si=null}},jf=200,Xs=-60,Bf=8,Lt=function(i){return i.NewStream="new_stream",i.MuteStateChanged="mute_state_changed",i.LocalVolumeChanged="local_volume_changed",i.VolumeChanged="volume_changed",i.ConnectedChanged="connected_changed",i.Speaking="speaking",i.Disposed="disposed",i}({});class nr extends xe{constructor(e){super(),c(this,"stream",void 0),c(this,"sdpMetadataStreamId",void 0),c(this,"userId",void 0),c(this,"deviceId",void 0),c(this,"purpose",void 0),c(this,"speakingVolumeSamples",void 0),c(this,"client",void 0),c(this,"call",void 0),c(this,"roomId",void 0),c(this,"audioMuted",void 0),c(this,"videoMuted",void 0),c(this,"localVolume",1),c(this,"measuringVolumeActivity",!1),c(this,"audioContext",void 0),c(this,"analyser",void 0),c(this,"frequencyBinCount",void 0),c(this,"speakingThreshold",Xs),c(this,"speaking",!1),c(this,"volumeLooperTimeout",void 0),c(this,"_disposed",!1),c(this,"_connected",!1),c(this,"onAddTrack",()=>{this.emit(Lt.NewStream,this.stream)}),c(this,"onCallState",t=>{t===me.Connected?this.connected=!0:t===me.Connecting&&(this.connected=!1)}),c(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var r of this.frequencyBinCount)r>t&&(t=r);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(Lt.VolumeChanged,t);var n=!1;for(var a of this.speakingVolumeSamples)if(a>this.speakingThreshold){n=!0;break}this.speaking!==n&&(this.speaking=n,this.emit(Lt.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,jf)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(Bf).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(we.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(Lt.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(Lt.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=Ff()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t?.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(Lt.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(Lt.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return E.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===Ue.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new nr({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(we.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,xf()),this._disposed=!0,this.emit(Lt.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(Lt.LocalVolumeChanged,e)}}var Wf=3e3,Qs=function(i){return i.Incoming="Call.incoming",i}({});class qf{constructor(e){c(this,"calls",void 0),c(this,"callEventBuffer",void 0),c(this,"nextSeqByCall",new Map),c(this,"toDeviceEventBuffers",new Map),c(this,"client",void 0),c(this,"candidateEventsByCall",void 0),c(this,"eventBufferPromiseChain",void 0),c(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),c(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),c(this,"onToDeviceEvent",t=>{var r=t.getContent();if(!r.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(r.call_id)||this.nextSeqByCall.set(r.call_id,0),r.seq===void 0){this.callEventBuffer.push(t);return}var n=this.nextSeqByCall.get(r.call_id)||0;if(r.seq!==n){this.toDeviceEventBuffers.has(r.call_id)||this.toDeviceEventBuffers.set(r.call_id,[]);var a=this.toDeviceEventBuffers.get(r.call_id),s=a.findIndex(u=>u.getContent().seq>r.seq);s===-1?a.push(t):a.splice(s,0,t)}else{var o=r.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(o,r.seq+1);for(var l=this.toDeviceEventBuffers.get(o),d=l&&l.shift();d&&d.getContent().seq===this.nextSeqByCall.get(o);)this.callEventBuffer.push(d),this.nextSeqByCall.set(o,d.getContent().seq+1),d=l.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(ae.Sync,this.onSync),this.client.on(ie.Timeline,this.onRoomTimeline),this.client.on(ae.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(ae.Sync,this.onSync),this.client.removeListener(ie.Timeline,this.onRoomTimeline),this.client.removeListener(ae.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return T(function*(){yield Promise.all(e.map(u=>t.client.decryptEventIfNeeded(u)));var r=e.filter(u=>{var h=u.getType();return h.startsWith("m.call.")||h.startsWith("org.matrix.call.")}),n=new Set;for(var a of r){var s=a.getType();(s===x.CallAnswer||s===x.CallHangup)&&n.add(a.getContent().call_id)}for(var o of r){var l=o.getType(),d=o.getContent().call_id;if(!(l===x.CallInvite&&n.has(d)))try{yield t.handleCallEvent(o)}catch(u){E.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",u)}}})()}handleCallEvent(e){var t=this;return T(function*(){var r;t.client.emit(ae.ReceivedVoipEvent,e);var n=e.getContent(),a=e.getRoomId()||((r=t.client.groupCallEventHandler.getGroupCallById(n.conf_id))===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.roomId),s=n.conf_id,o=e.getType(),l=e.getSender(),d=n.call_id?t.calls.get(n.call_id):void 0,u,h;if(s){if(h=t.client.groupCallEventHandler.getGroupCallById(s),!h){E.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(s,", type=").concat(o,")"));return}if(u=n.device_id,!u){E.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(l,")")),h.emit(Le.Error,new jc(l));return}if(n.dest_session_id!==t.client.getSessionId()){E.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var v=l===t.client.credentials.userId&&(u===void 0||u===t.client.getDeviceId());if(a){if(o===x.CallInvite){var m,f,g;if(v||e.getLocalAge()>n.lifetime-Wf||d&&d.state===me.Ended||(d&&E.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(n.call_id,")")),n.invitee&&n.invitee!==t.client.getUserId()))return;var w=((m=t.client.getTurnServersExpiry())!==null&&m!==void 0?m:0)-Date.now();if(E.info("CallEventHandler handleCallEvent() current turn creds expire in "+w+" ms"),d=(f=Tn(t.client,a,{forceTURN:t.client.forceTURN,opponentDeviceId:u,groupCallId:s,opponentSessionId:n.sender_session_id}))!==null&&f!==void 0?f:void 0,!d){E.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(n.call_id,")"));return}d.callId=n.call_id;var S=(g=h)===null||g===void 0?void 0:g.getGroupCallStats();S&&d.initStats(S);try{yield d.initWithInvite(e)}catch(P){if(P instanceof tr)if(P.code===bi.UnknownDevice){var R;(R=h)===null||R===void 0||R.emit(Le.Error,P)}else E.error(P)}if(t.calls.set(d.callId,d),t.candidateEventsByCall.get(d.callId))for(var C of t.candidateEventsByCall.get(d.callId))d.onRemoteIceCandidatesReceived(C);var b;for(var _ of t.calls.values()){var p,I=[me.WaitLocalMedia,me.CreateOffer,me.InviteSent].includes(_.state);if(d.roomId===_.roomId&&_.direction===fr.Outbound&&((p=d.getOpponentMember())===null||p===void 0?void 0:p.userId)===_.invitee&&I){b=_;break}}b?b.callId>d.callId?(E.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(d.callId,", outgoingId=").concat(b.callId,")")),b.replacedBy(d)):(E.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(d.callId,", outgoingId=").concat(b.callId,")")),d.hangup(_e.Replaced,!0)):t.client.emit(Qs.Incoming,d);return}else if(o===x.CallCandidates){if(v)return;d?d.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(n.call_id)||t.candidateEventsByCall.set(n.call_id,[]),t.candidateEventsByCall.get(n.call_id).push(e));return}else if([x.CallHangup,x.CallReject].includes(o)){if(d)d.state!==me.Ended&&(o===x.CallHangup?d.onHangupReceived(n):d.onRejectReceived(n),d.state===me.Ended&&t.calls.delete(n.call_id));else{var y;d=(y=Tn(t.client,a,{opponentDeviceId:u,opponentSessionId:n.sender_session_id}))!==null&&y!==void 0?y:void 0,d&&(d.callId=n.call_id,d.initWithHangup(e),t.calls.set(n.call_id,d))}return}if(!d||!d.hasPeerConnection){E.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(o,")"));return}if(e.getContent().party_id!==d.ourPartyId)switch(o){case x.CallAnswer:v?d.state===me.Ringing&&d.onAnsweredElsewhere(n):d.onAnswerReceived(e);break;case x.CallSelectAnswer:d.onSelectAnswerReceived(e);break;case x.CallNegotiate:d.onNegotiateReceived(e);break;case x.CallAssertedIdentity:case x.CallAssertedIdentityPrefix:d.onAssertedIdentityReceived(e);break;case x.CallSDPStreamMetadataChanged:case x.CallSDPStreamMetadataChangedPrefix:d.onSDPStreamMetadataChangedReceived(e);break}}})()}}var Zs=function(i){return i.Incoming="GroupCall.incoming",i.Outgoing="GroupCall.outgoing",i.Ended="GroupCall.ended",i.Participants="GroupCall.participants",i}({});class Kf{constructor(e){this.client=e,c(this,"groupCalls",new Map),c(this,"roomDeferreds",new Map),c(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),c(this,"onRoomStateChanged",(t,r)=>{var n=t.getType();if(n===x.GroupCallPrefix){var a=t.getStateKey(),s=t.getContent(),o=this.groupCalls.get(r.roomId);!o&&!s["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):o&&o.groupCallId===a?s["m.terminated"]||t.isRedacted()?o.terminate(!1):s["m.type"]!==o.type&&E.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(r.roomId,")")):o&&o.groupCallId!==a&&E.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(r.roomId,")"))}})}start(){var e=this;return T(function*(){e.client.getSyncState()!==ke.Syncing&&(E.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(n=>{var a=()=>{if(e.client.getSyncState()===ke.Syncing)return e.client.off(ae.Sync,a),n()};e.client.on(ae.Sync,a)}));var t=e.client.getRooms();for(var r of t)e.createGroupCallForRoom(r);e.client.on(ae.Room,e.onRoomsChanged),e.client.on(Re.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(ae.Room,this.onRoomsChanged),this.client.removeListener(Re.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var r;t={prom:new Promise(n=>{r=n})},t.resolve=r,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(x.GroupCallPrefix),r=t.sort((s,o)=>o.getTs()-s.getTs());for(var n of r){var a=n.getContent();if(!(a["m.terminated"]||n.isRedacted())){E.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(n.getStateKey(),", ts=").concat(n.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(n);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),r=e.getContent(),n=this.client.getRoom(t);if(!n){E.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var a=e.getStateKey(),s=r["m.type"];if(!Object.values(Ki).includes(s)){E.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(s,", roomId=").concat(t,")"));return}var o=r["m.intent"];if(!Object.values(Go).includes(o)){E.warn("Received invalid group call intent (type=".concat(s,", roomId=").concat(t,")"));return}var l=!!r["io.element.ptt"],d;if(r!=null&&r.dataChannelsEnabled&&r!==null&&r!==void 0&&r.dataChannelOptions){var{ordered:u,maxPacketLifeTime:h,maxRetransmits:v,protocol:m}=r.dataChannelOptions;d={ordered:u,maxPacketLifeTime:h,maxRetransmits:v,protocol:m}}var f=new Xa(this.client,n,s,l,o,a,r?.dataChannelsEnabled||this.client.isVoipWithNoMediaAllowed,d,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,r["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,f),this.client.emit(Zs.Incoming,f),f}}class Vf{constructor(){c(this,"bandwidth",{}),c(this,"bitrate",{}),c(this,"packetLoss",{}),c(this,"transport",[])}}class Gf{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}class $f{static buildReport(e,t,r,n){var a=e?.get(t.localCandidateId),s=e?.get(t.remoteCandidateId);if(s&&a){var o=s.ip!==void 0?s.ip:s.address,l=s.port,d="".concat(o,":").concat(l),u=a.ip!==void 0?a.ip:a.address,h=a.port,v="".concat(u,":").concat(h),m=s.protocol;r.some(f=>f.ip===d&&f.type===m&&f.localIp===v)||r.push({ip:d,type:m,localIp:v,isFocus:n,localCandidateType:a.candidateType,remoteCandidateType:s.candidateType,networkType:a.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return r}}class Hf{constructor(){c(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var r;return this.ssrcToMid[t].forEach((n,a)=>{if(n.find(s=>s==e)){r=a;return}}),r}parse(e,t){var r=zs.parse(e),n=new Map;r.media.forEach(a=>{if(a.mid&&a.type==="video"||a.type==="audio"){var s,o=[];(s=a.ssrcs)===null||s===void 0||s.forEach(l=>{l.attribute==="cname"&&o.push("".concat(l.id))}),n.set("".concat(a.mid),o)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class Jf{constructor(e){this.pc=e}getLocalTracks(e){var t=r=>r!==null&&r.kind===e;return this.pc.getTransceivers().filter(r=>r.currentDirection==="sendonly"||r.currentDirection==="sendrecv").filter(r=>r.sender!==null).map(r=>r.sender).map(r=>r.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if(t?.sender.track!==null&&t.sender.track.id===e)return t.sender.track;if(t?.receiver.track!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(n=>n.mid===e);return r==null||(t=r.sender)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getRemoteTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(n=>n.mid===e);return r==null||(t=r.receiver)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class zf{constructor(e,t,r){this.trackId=e,this.type=t,this.kind=r,c(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),c(this,"bitrate",{download:0,upload:0}),c(this,"resolution",{width:-1,height:-1}),c(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),c(this,"framerate",0),c(this,"jitter",0),c(this,"codec",""),c(this,"isAlive",!0),c(this,"isMuted",!1),c(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class Yf{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,c(this,"track2stats",new Map)}findTrack2Stats(e,t){var r;if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var n=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!n)return;r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(r){var a=this.track2stats.get(r);if(!a){var s=this.mediaTrackHandler.getTackById(r);if(s!==void 0){var o=s.kind==="audio"?s.kind:"video";a=new zf(r,t,o),this.track2stats.set(r,a)}else return}return a}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class Fr{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class Rt{static buildFramerateResolution(e,t){var r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){var a=e.getFramerate();if(!a){if(r){var s=t.timestamp-r.timestamp;if(s>0&&t.framesSent){var o=t.framesSent-r.framesSent;a=o/s*1e3}}if(!a)return}a=n?Math.round(a/n):0,e.setFramerate(a)}static buildCodec(e,t,r){var n=e?.get(r.codecId);if(n){var a=n.mimeType.split("/")[1];a&&t.setCodec(a)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:Rt.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){var n=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",a=t[n];(!a||a<0)&&(a=0);var s=Fr.getNonNegativeValue(r[n]),o=Math.max(0,a-s),l=Fr.getNonNegativeValue(t.packetsLost),d=Fr.getNonNegativeValue(r.packetsLost),u=Math.max(0,l-d);e.setLoss({packetsTotal:o+u,packetsLost:u,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,r,n){var a=Fr.getNonNegativeValue(e),s=Fr.getNonNegativeValue(t),o=Math.max(0,a-s),l=r-n,d=0;return l>0&&(d=Math.round(o*8/l)),d}static setTrackStatsState(e,t){var r;if(t===void 0){e.alive=!1;return}var n=e.getType()==="remote"?t.receiver.track:t==null||(r=t.sender)===null||r===void 0?void 0:r.track;if(n==null){e.alive=!1;return}if(n.readyState==="ended"){e.alive=!1;return}e.muted=n.muted,e.enabled=n.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(s=>s.getType()==="remote"),a=n.filter(s=>s.kind==="audio");return n.forEach(s=>{var o=s.kind==="video"?t:r;if(o.count++,s.alive&&s.muted&&o.muted++,o.maxJitter<s.getJitter()&&(o.maxJitter=s.getJitter()),o.maxPacketLoss<s.getLoss().packetsLost&&(o.maxPacketLoss=s.getLoss().packetsLost),a.length>0){var l,d;o.concealedAudio+=(l=s.getAudioConcealment())===null||l===void 0?void 0:l.concealedAudio,o.totalAudio+=(d=s.getAudioConcealment())===null||d===void 0?void 0:d.totalAudioDuration}}),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var r=t?.jitter;if(r!==void 0){var n=Fr.getNonNegativeValue(r);e.setJitter(Math.round(n*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var r=1e3*t?.totalSamplesDuration/t?.totalSamplesReceived,n=r*t?.concealedSamples,a=1e3*t?.totalSamplesDuration;e.setAudioConcealment(n,a)}}}class Ei{static build(e){var t={},r={download:0,upload:0},n={download:0,upload:0},a=0,s=0,o={local:new Map,remote:new Map},l={local:new Map,remote:new Map},d={local:new Map,remote:new Map},u=new Map,h=new Map,v=0,m=0,f=0,g=0,w=0,S=0;for(var[R,C]of e){var b=C.getLoss(),_=b.isDownloadStream?"download":"upload";if(r[_]+=b.packetsTotal,n[_]+=b.packetsLost,a+=C.getBitrate().download,s+=C.getBitrate().upload,C.kind==="audio"){var p=C.getAudioConcealment();w+=p.concealedAudio,S+=p.totalAudioDuration,v+=C.getBitrate().download,m+=C.getBitrate().upload}else f+=C.getBitrate().download,g+=C.getBitrate().upload;o[C.getType()].set(R,C.getResolution()),l[C.getType()].set(R,C.getFramerate()),d[C.getType()].set(R,C.getCodec()),C.getType()==="remote"&&(u.set(R,C.getJitter()),C.kind==="audio"&&h.set(R,C.getAudioConcealment())),C.resetBitrate()}return t.bitrate={upload:s,download:a},t.bitrate.audio={upload:m,download:v},t.bitrate.video={upload:g,download:f},t.packetLoss={total:Ei.calculatePacketLoss(n.download+n.upload,r.download+r.upload),download:Ei.calculatePacketLoss(n.download,r.download),upload:Ei.calculatePacketLoss(n.upload,r.upload)},t.audioConcealment=h,t.totalAudioConcealment={concealedAudio:w,totalAudioDuration:S},t.framerate=l,t.resolution=o,t.codec=d,t.jitter=u,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Er{static buildCallFeedReport(e,t,r){var n=r.getTransceivers(),a=[],s=[];return n.forEach(o=>{var l,d=(l=o.sender)!==null&&l!==void 0&&l.track?Er.buildTrackStats(o.sender.track,"sender"):null,u=Er.buildTrackStats(o.receiver.track,"receiver");a.push({mid:o.mid==null?"null":o.mid,direction:o.direction,currentDirection:o.currentDirection==null?"null":o.currentDirection,sender:d,receiver:u})}),{callId:e,opponentMemberId:t,transceiver:a,callFeeds:s}}static buildTrackStats(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",a=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,s=(r=e.getConstraints())===null||r===void 0?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:a??"unknown",constrainDeviceId:s??"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return t.forEach(n=>{var a=n.stream.getAudioTracks(),s=n.stream.getVideoTracks(),o=a.length>0?Er.buildTrackStats(n.stream.getAudioTracks()[0],n.purpose):null,l=s.length>0?Er.buildTrackStats(n.stream.getVideoTracks()[0],n.purpose):null,d={stream:n.stream.id,type:n.isLocal()?"local":"remote",audio:o,video:l,purpose:n.purpose,prefix:r,isVideoMuted:n.isVideoMuted(),isAudioMuted:n.isAudioMuted()};e.callFeeds.push(d)}),e}}function Dd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ta(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Dd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Dd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class Xf{constructor(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=a,c(this,"isActive",!0),c(this,"previousStatsReport",void 0),c(this,"currentStatsReport",void 0),c(this,"connectionStats",new Vf),c(this,"trackStats",void 0),r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new Yf(new Hf,new Jf(r))}processStats(e,t){var r=this;return T(function*(){var n={isFirstCollection:r.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(r.isActive){var a=r.pc.getStats();if(typeof a?.then=="function")return a.then(s=>{var o,l;r.currentStatsReport=typeof s?.result=="function"?s.result():s;try{r.processStatsReport(e,t)}catch(u){return r.handleError(u),n}r.previousStatsReport=r.currentStatsReport,n.receivedMedia=r.connectionStats.bitrate.download,n.receivedAudioMedia=((o=r.connectionStats.bitrate.audio)===null||o===void 0?void 0:o.download)||0,n.receivedVideoMedia=((l=r.connectionStats.bitrate.video)===null||l===void 0?void 0:l.download)||0;var d=Rt.buildTrackSummary(Array.from(r.trackStats.getTrack2stats().values()));return ta(ta({},n),{},{audioTrackSummary:d.audioTrackSummary,videoTrackSummary:d.videoTrackSummary})}).catch(s=>(r.handleError(s),n));r.isActive=!1}return Promise.resolve(n)})()}processStatsReport(e,t){var r,n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,(r=this.currentStatsReport)===null||r===void 0||r.forEach(a=>{var s=this.previousStatsReport?this.previousStatsReport.get(a.id):null;if(a.type==="candidate-pair"&&a.nominated&&a.state==="succeeded")this.connectionStats.bandwidth=Gf.buildBandwidthReport(a),this.connectionStats.transport=$f.buildReport(this.currentStatsReport,a,this.connectionStats.transport,this.isFocus);else if(a.type==="inbound-rtp"||a.type==="outbound-rtp"){var o=this.trackStats.findTrack2Stats(a,a.type==="inbound-rtp"?"remote":"local");if(!o)return;if(s&&Rt.buildPacketsLost(o,a,s),a.type==="inbound-rtp"){Rt.buildFramerateResolution(o,a),s&&Rt.buildBitrateReceived(o,a,s);var l=this.trackStats.findTransceiverByTrackId(o.trackId);Rt.setTrackStatsState(o,l),Rt.buildJitter(o,a),Rt.buildAudioConcealment(o,a)}else s&&(n.set(o.trackId,Fr.getNonNegativeValue(a.bytesSent)),Rt.buildBitrateSend(o,a,s));Rt.buildCodec(this.currentStatsReport,o,a)}else if(a.type==="track"&&a.kind==="video"&&!a.remoteSource){var d=this.trackStats.findLocalVideoTrackStats(a);if(!d)return;Rt.buildFramerateResolution(d,a),Rt.calculateSimulcastFramerate(d,a,s,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(Er.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,E.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=Ei.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(ta(ta({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var Yt=function(i){return i.CONNECTION_STATS="StatsReport.connection_stats",i.CALL_FEED_REPORT="StatsReport.call_feed_report",i.BYTE_SENT_STATS="StatsReport.byte_sent_stats",i.SUMMARY_STATS="StatsReport.summary_stats",i}({});class Qf extends xe{emitByteSendReport(e){this.emit(Yt.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(Yt.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(Yt.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(Yt.SUMMARY_STATS,e)}}class xc{constructor(e){this.emitter=e}build(e){var t=e.filter(u=>!u.isFirstCollection),r=t.length,n=e.length;if(r!==0){var a={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},s=0,o=0;t.forEach(u=>{this.countTrackListReceivedMedia(a,u),this.countConcealedAudio(a,u),s=this.buildMaxJitter(s,u),o=this.buildMaxPacketLoss(o,u)});var l=5,d={percentageReceivedMedia:Number((a.receivedMedia/r).toFixed(l)),percentageReceivedVideoMedia:Number((a.receivedVideo/r).toFixed(l)),percentageReceivedAudioMedia:Number((a.receivedAudio/r).toFixed(l)),maxJitter:s,maxPacketLoss:o,percentageConcealedAudio:Number(a.totalAudio>0?(a.concealedAudio/a.totalAudio).toFixed(l):0),peerConnections:n};this.emitter.emitSummaryStatsReport(d)}}static extendSummaryReport(e,t){var r=[],n=[];for(var a of t){n.push(a);for(var s of a[1])r.push(s)}e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,r.length-1)==0?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){var r=!1,n=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,r=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class Zf{constructor(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=r,c(this,"timer",void 0),c(this,"gatherers",new Map),c(this,"reports",new Qf),c(this,"summaryStatsReportGatherer",new xc(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new Xf(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;(r=this.getStatsReportGatherer(e))===null||r===void 0||r.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{E.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}function Ld(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ra(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ld(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Ld(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Go=function(i){return i.Ring="m.ring",i.Prompt="m.prompt",i.Room="m.room",i}({}),Ki=function(i){return i.Video="m.video",i.Voice="m.voice",i}({}),ep=function(i){return i.CallEnded="call_ended",i}({}),Le=function(i){return i.GroupCallStateChanged="group_call_state_changed",i.ActiveSpeakerChanged="active_speaker_changed",i.CallsChanged="calls_changed",i.UserMediaFeedsChanged="user_media_feeds_changed",i.ScreenshareFeedsChanged="screenshare_feeds_changed",i.LocalScreenshareStateChanged="local_screenshare_state_changed",i.LocalMuteStateChanged="local_mute_state_changed",i.ParticipantsChanged="participants_changed",i.Error="group_call_error",i}({}),pn=function(i){return i.ConnectionStats="GroupCall.connection_stats",i.ByteSentStats="GroupCall.byte_sent_stats",i.SummaryStats="GroupCall.summary_stats",i.CallFeedStats="GroupCall.call_feed_stats",i}({}),bi=function(i){return i.NoUserMedia="no_user_media",i.UnknownDevice="unknown_device",i.PlaceCallFailed="place_call_failed",i}({});class eo extends Error{constructor(e,t,r){r?(super(t+": "+r),c(this,"code",void 0)):(super(t),c(this,"code",void 0)),this.code=e}}class jc extends eo{constructor(e){super(bi.UnknownDevice,"No device found for "+e),this.userId=e}}var qe=function(i){return i.LocalCallFeedUninitialized="local_call_feed_uninitialized",i.InitializingLocalCallFeed="initializing_local_call_feed",i.LocalCallFeedInitialized="local_call_feed_initialized",i.Entered="entered",i.Ended="ended",i}({}),Ud=1e3*60*60;function na(i){var e;return((e=i.getOpponentMember())===null||e===void 0?void 0:e.userId)||i.invitee||null}class Xa extends xe{constructor(e,t,r,n,a,s,o,l,d){var u,h,v=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,m=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=a,this.dataChannelsEnabled=o,this.dataChannelOptions=l,this.useLivekit=v,c(this,"activeSpeakerInterval",1e3),c(this,"retryCallInterval",5e3),c(this,"participantTimeout",1e3*15),c(this,"pttMaxTransmitTime",1e3*20),c(this,"activeSpeaker",void 0),c(this,"localCallFeed",void 0),c(this,"localScreenshareFeed",void 0),c(this,"localDesktopCapturerSourceId",void 0),c(this,"userMediaFeeds",[]),c(this,"screenshareFeeds",[]),c(this,"groupCallId",void 0),c(this,"allowCallWithoutVideoAndAudio",void 0),c(this,"calls",new Map),c(this,"callHandlers",new Map),c(this,"activeSpeakerLoopInterval",void 0),c(this,"retryCallLoopInterval",void 0),c(this,"retryCallCounts",new Map),c(this,"reEmitter",void 0),c(this,"transmitTimer",null),c(this,"participantsExpirationTimer",null),c(this,"resendMemberStateTimer",null),c(this,"initWithAudioMuted",!1),c(this,"initWithVideoMuted",!1),c(this,"initCallFeedPromise",void 0),c(this,"_livekitServiceURL",void 0),c(this,"stats",void 0),c(this,"statsCollectIntervalTime",0),c(this,"onConnectionStats",f=>{this.emit(pn.ConnectionStats,{report:f})}),c(this,"onByteSentStats",f=>{this.emit(pn.ByteSentStats,{report:f})}),c(this,"onSummaryStats",f=>{xc.extendSummaryReport(f,this.participants),this.emit(pn.SummaryStats,{report:f})}),c(this,"onCallFeedReport",f=>{this.localCallFeed&&(f=Er.expandCallFeedReport(f,[this.localCallFeed],"from-local-feed"));var g=[];this.forEachCall(w=>{w.callId===f.callId&&w.getFeeds().forEach(S=>g.push(S))}),f=Er.expandCallFeedReport(f,g,"from-call-feed"),this.emit(pn.CallFeedStats,{report:f})}),c(this,"_state",qe.LocalCallFeedUninitialized),c(this,"_participants",new Map),c(this,"_creationTs",null),c(this,"_enteredViaAnotherSession",!1),c(this,"onIncomingCall",f=>{var g,w;if(f.roomId===this.room.roomId){if(f.state!==me.Ringing){E.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!f.groupCallId||f.groupCallId!==this.groupCallId){E.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),f.reject();return}var S=(g=f.getOpponentMember())===null||g===void 0?void 0:g.userId;if(S===void 0){E.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){E.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var R=(w=this.calls.get(S))!==null&&w!==void 0?w:new Map,C=R.get(f.getOpponentDeviceId());if(C?.callId!==f.callId){E.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(S,", callId=").concat(f.callId,")")),C&&C.hangup(_e.Replaced,!1),R.set(f.getOpponentDeviceId(),f),this.calls.set(S,R),this.initCall(f);var b=this.getLocalFeeds().map(p=>p.clone());if(!this.callExpected(f))for(var _ of b)Qe(_.stream.getAudioTracks(),!1),Qe(_.stream.getVideoTracks(),!1);f.answerWithCallFeeds(b),this.emit(Le.CallsChanged,this.calls)}}}),c(this,"onRetryCallLoop",()=>{var f=!1;for(var[{userId:g},w]of this.participants){var S=this.calls.get(g),R=this.retryCallCounts.get(g);for(var[C,b]of w){var _,p,I=S?.get(C),y=(_=(p=R)===null||p===void 0?void 0:p.get(C))!==null&&_!==void 0?_:0;I?.getOpponentSessionId()!==b.sessionId&&this.wantsOutgoingCall(g,C)&&y<3&&(R===void 0&&(R=new Map,this.retryCallCounts.set(g,R)),R.set(C,y+1),f=!0)}}f&&this.placeOutgoingCalls()}),c(this,"onCallFeedsChanged",f=>{var g=na(f),w=f.getOpponentDeviceId();if(!g)throw new Error("Cannot change call feeds without user id");var S=this.getUserMediaFeed(g,w),R=f.remoteUsermediaFeed,C=R!==S,b=this.calls.get(g),_=b?.get(w);if(_?.callId===f.callId){C&&(!S&&R?this.addUserMediaFeed(R):S&&R?this.replaceUserMediaFeed(S,R):S&&!R&&this.removeUserMediaFeed(S));var p=this.getScreenshareFeed(g,w),I=f.remoteScreensharingFeed,y=I!==p;y&&(!p&&I?this.addScreenshareFeed(I):p&&I?this.replaceScreenshareFeed(p,I):p&&!I&&this.removeScreenshareFeed(p))}}),c(this,"onCallStateChanged",(f,g,w)=>{var S;if(g!==me.Ended){var R=this.localCallFeed.isAudioMuted();f.localUsermediaStream&&f.isMicrophoneMuted()!==R&&f.setMicrophoneMuted(R);var C=this.localCallFeed.isVideoMuted();f.localUsermediaStream&&f.isLocalVideoMuted()!==C&&f.setLocalVideoMuted(C);var b=(S=f.getOpponentMember())===null||S===void 0?void 0:S.userId;if(g===me.Connected&&b){var _=this.retryCallCounts.get(b);_?.delete(f.getOpponentDeviceId()),_?.size===0&&this.retryCallCounts.delete(b)}}}),c(this,"onCallHangup",f=>{var g,w;if(f.hangupReason!==_e.Replaced){var S=(g=(w=f.getOpponentMember())===null||w===void 0?void 0:w.userId)!==null&&g!==void 0?g:this.room.getMember(f.invitee).userId,R=this.calls.get(S);R?.get(f.getOpponentDeviceId())===f&&(this.disposeCall(f,f.hangupReason),R.delete(f.getOpponentDeviceId()),R.size===0&&this.calls.delete(S),this.emit(Le.CallsChanged,this.calls))}}),c(this,"onCallReplaced",(f,g)=>{var w=f.getOpponentMember().userId,S=this.calls.get(w);S===void 0&&(S=new Map,this.calls.set(w,S)),f.hangup(_e.Replaced,!1),this.initCall(g),S.set(f.getOpponentDeviceId(),g),this.emit(Le.CallsChanged,this.calls)}),c(this,"onActiveSpeakerLoop",()=>{var f=void 0,g=void 0;for(var w of this.userMediaFeeds)if(!(w.isLocal()&&this.userMediaFeeds.length>1)){var S=w.speakingVolumeSamples.reduce((C,b)=>C+Math.max(b,Xs)),R=S/w.speakingVolumeSamples.length;(!f||R>f)&&(f=R,g=w)}g&&this.activeSpeaker!==g&&f&&f>Xs&&(this.activeSpeaker=g,this.emit(Le.ActiveSpeakerChanged,this.activeSpeaker))}),c(this,"onRoomState",()=>this.updateParticipants()),c(this,"onParticipantsChanged",()=>{this.forEachCall(f=>{var g=this.callExpected(f);for(var w of f.getLocalFeeds())Qe(w.stream.getAudioTracks(),!w.isAudioMuted()&&g),Qe(w.stream.getVideoTracks(),!w.isVideoMuted()&&g)}),this.state===qe.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),c(this,"onStateChanged",(f,g)=>{(f===qe.Entered||g===qe.Entered||f===qe.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(w=>E.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),w)))}),c(this,"onLocalFeedsChanged",()=>{this.state===qe.Entered&&this.updateMemberState().catch(f=>E.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),f))}),this.reEmitter=new hc(this),this.groupCallId=s??xr(),this._livekitServiceURL=m,this.creationTs=(u=(h=t.currentState.getStateEvents(x.GroupCallPrefix,this.groupCallId))===null||h===void 0?void 0:h.getTs())!==null&&u!==void 0?u:null,this.updateParticipants(),t.on(Re.Update,this.onRoomState),this.on(Le.ParticipantsChanged,this.onParticipantsChanged),this.on(Le.GroupCallStateChanged,this.onStateChanged),this.on(Le.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!d}create(){var e=this;return T(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(Zs.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return T(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,x.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(Le.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,r=(a,s)=>a.sessionId===s.sessionId&&a.screensharing===s.screensharing,n=(a,s)=>xl(a,s,r);xl(e,t,n)||(this._participants=e,this.emit(Le.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var r of t.values())e(r)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,r=na(e),n=r===null?null:this.room.getMember(r),a=e.getOpponentDeviceId();return n!==null&&a!==void 0&&((t=this.participants.get(n))===null||t===void 0?void 0:t.get(a))!==void 0}initLocalCallFeed(){var e=this;return T(function*(){if(e.useLivekit){E.info("Livekit group call: not starting local call feed.");return}if(e.state!==qe.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=qe.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return T(function*(){E.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===Ki.Video)}catch(n){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=qe.LocalCallFeedUninitialized,n}if(e._state!==qe.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var r=new nr({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:Ue.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});Qe(t.getAudioTracks(),!r.isAudioMuted()),Qe(t.getVideoTracks(),!r.isVideoMuted()),e.localCallFeed=r,e.addUserMediaFeed(r),e.state=qe.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return T(function*(){if(t.localCallFeed){var r=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var n=t.localCallFeed.isAudioMuted(),a=t.localCallFeed.isVideoMuted();E.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(r.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(n,", vidShouldBeMuted=").concat(a,")")),Qe(e.getAudioTracks(),!n),Qe(e.getVideoTracks(),!a),t.client.getMediaHandler().stopUserMediaStream(r)}})()}enter(){var e=this;return T(function*(){if(e.state===qe.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==qe.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));E.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=qe.Entered,e.client.on(Qs.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===qe.Entered&&(this.forEachCall(t=>t.hangup(_e.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(Qs.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=qe.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return T(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(Re.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(Zs.Ended,t),t.state=qe.Ended,r){var n=t.room.currentState.getStateEvents(x.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,x.GroupCallPrefix,ra(ra({},n.getContent()),{},{"m.terminated":ep.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return T(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var r=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(s=>{var o;return(o=s.localUsermediaFeed)===null||o===void 0?void 0:o.setAudioVideoMuted(e,null)});var n=function(){var s=T(function*(){var o=[];t.forEachCall(l=>o.push(l.sendMetadataUpdate())),yield Promise.all(o).catch(l=>E.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),l))});return function(){return s.apply(this,arguments)}}();if(r&&(yield n()),t.localCallFeed){E.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var a=yield t.checkAudioPermissionIfNecessary(e);if(!a)return!1;t.localCallFeed.setAudioVideoMuted(e,null),Qe(t.localCallFeed.stream.getAudioTracks(),!e)}else E.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(s=>Qe(s.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(s))),t.emit(Le.LocalMuteStateChanged,e,t.isLocalVideoMuted()),r||(yield n()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return T(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if(r?.getTracks().length===0)return E.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return E.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return T(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){E.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(r),t.localCallFeed.setAudioVideoMuted(null,e),Qe(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return E.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else E.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var n=[];return t.forEachCall(a=>n.push(a.setLocalVideoMuted(e))),yield Promise.all(n),t.forEachCall(a=>Qe(a.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(a))),t.emit(Le.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(e===r.isScreensharing())return e;if(e)try{E.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var a=yield r.client.getMediaHandler().getScreensharingStream(n),s=function*(d){var u=()=>{r.setScreensharingEnabled(!1),d.removeEventListener("ended",u)};d.addEventListener("ended",u)};for(var o of a.getTracks())yield*s(o);return E.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),r.localDesktopCapturerSourceId=n.desktopCapturerSourceId,r.localScreenshareFeed=new nr({client:r.client,roomId:r.room.roomId,userId:r.client.getUserId(),deviceId:r.client.getDeviceId(),stream:a,purpose:Ue.Screenshare,audioMuted:!1,videoMuted:!1}),r.addScreenshareFeed(r.localScreenshareFeed),r.emit(Le.LocalScreenshareStateChanged,!0,r.localScreenshareFeed,r.localDesktopCapturerSourceId),r.forEachCall(l=>l.pushLocalFeed(r.localScreenshareFeed.clone())),!0}catch(l){if(n.throwOnFail)throw l;return E.error("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() enabling screensharing error"),l),r.emit(Le.Error,new eo(bi.NoUserMedia,"Failed to get screen-sharing stream: ",l)),!1}else return r.forEachCall(l=>{l.localScreensharingFeed&&l.removeLocalFeed(l.localScreensharingFeed)}),r.client.getMediaHandler().stopScreensharingStream(r.localScreenshareFeed.stream),r.removeScreenshareFeed(r.localScreenshareFeed),r.localScreenshareFeed=void 0,r.localDesktopCapturerSourceId=void 0,r.emit(Le.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){var e=this,t=!1,r=function(o){var l,d=(l=e.calls.get(o))!==null&&l!==void 0?l:new Map,u=function(f){var g=d.get(f);if(g?.getOpponentSessionId()!==v.sessionId&&e.wantsOutgoingCall(o,f)){t=!0,g!==void 0&&(E.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(o,", deviceId=").concat(f,", callId=").concat(g.callId,")")),g.hangup(_e.NewSession,!1));var w=Tn(e.client,e.room.roomId,{invitee:o,opponentDeviceId:f,opponentSessionId:v.sessionId,groupCallId:e.groupCallId});w===null?(E.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(o,", device=").concat(f,")")),d.delete(f)):(e.initCall(w),d.set(f,w),E.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(o,", deviceId=").concat(f,", sessionId=").concat(v.sessionId,")")),w.placeCallWithCallFeeds(e.getLocalFeeds().map(S=>S.clone()),v.screensharing).then(()=>{e.dataChannelsEnabled&&w.createDataChannel("datachannel",e.dataChannelOptions)}).catch(S=>{E.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(o,")"),S),S instanceof tr&&S.code===bi.UnknownDevice?e.emit(Le.Error,S):e.emit(Le.Error,new eo(bi.PlaceCallFailed,"Failed to place call to ".concat(o))),w.hangup(_e.SignallingFailed,!1),d.get(f)===w&&d.delete(f)}))}};for(var[h,v]of a)u(h);d.size>0?e.calls.set(o,d):e.calls.delete(o)};for(var[{userId:n},a]of this.participants)r(n);t&&this.emit(Le.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(x.GroupCallMemberPrefix):this.room.currentState.getStateEvents(x.GroupCallMemberPrefix,e)}initCall(e){var t=na(e);if(!t)throw new Error("Cannot init call without user id");var r=()=>this.onCallFeedsChanged(e),n=(l,d)=>this.onCallStateChanged(e,l,d),a=this.onCallHangup,s=l=>this.onCallReplaced(e,l),o=this.callHandlers.get(t);o===void 0&&(o=new Map,this.callHandlers.set(t,o)),o.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:a,onCallReplaced:s}),e.on(we.FeedsChanged,r),e.on(we.State,n),e.on(we.Hangup,a),e.on(we.Replaced,s),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(we)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){var r=na(e),n=e.getOpponentDeviceId();if(!r)throw new Error("Cannot dispose call without user id");var a=this.callHandlers.get(r),{onCallFeedsChanged:s,onCallStateChanged:o,onCallHangup:l,onCallReplaced:d}=a.get(n);if(e.removeListener(we.FeedsChanged,s),e.removeListener(we.State,o),e.removeListener(we.Hangup,l),e.removeListener(we.Replaced,d),a.delete(r),a.size===0&&this.callHandlers.delete(r),e.hangupReason!==_e.Replaced){var u=this.getUserMediaFeed(r,n);u&&this.removeUserMediaFeed(u);var h=this.getScreenshareFeed(r,n);h&&this.removeScreenshareFeed(h)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(r=>r.userId===e&&r.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(Le.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var r=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(Le.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(Le.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(Le.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(r=>r.userId===e&&r.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(Le.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var r=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(Le.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(Le.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e){E.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===qe.Ended){this.participants=new Map;return}var t=new Map,r=Date.now(),n=this.state===qe.Entered||this.enteredViaAnotherSession,a=1/0;for(var s of this.getMemberStateEvents()){var o=this.room.getMember(s.getStateKey()),l=s.getContent(),d=Array.isArray(l["m.calls"])?l["m.calls"]:[],u=d.find(w=>w["m.call_id"]===this.groupCallId),h=Array.isArray(u?.["m.devices"])?u["m.devices"]:[],v=h.filter(w=>typeof w.device_id=="string"&&typeof w.session_id=="string"&&typeof w.expires_ts=="number"&&w.expires_ts>r&&Array.isArray(w.feeds));if(!n&&o?.userId===this.client.getUserId()&&(v=v.filter(w=>w.device_id!==this.client.getDeviceId())),v.length>0&&o?.membership===Ee.Join){var m=new Map;t.set(o,m);for(var f of v)m.set(f.device_id,{sessionId:f.session_id,screensharing:f.feeds.some(w=>w.purpose===Ue.Screenshare)}),f.expires_ts<a&&(a=f.expires_ts)}}if(n){var g=t.get(e);g===void 0&&(g=new Map,t.set(e,g)),g.has(this.client.getDeviceId())||g.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(w=>w.purpose===Ue.Screenshare)})}this.participants=t,a<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),a-r))}updateDevices(e){var t=arguments,r=this;return T(function*(){var n,a=t.length>1&&t[1]!==void 0?t[1]:!1,s=Date.now(),o=r.client.getUserId(),l=r.getMemberStateEvents(o),d=(n=l?.getContent())!==null&&n!==void 0?n:{},u=Array.isArray(d["m.calls"])?d["m.calls"]:[],h=null,v=[];for(var m of u)m["m.call_id"]===r.groupCallId?h=m:v.push(m);h===null&&(h={});var f=Array.isArray(h["m.devices"])?h["m.devices"]:[],g=f.filter(C=>typeof C.device_id=="string"&&typeof C.session_id=="string"&&typeof C.expires_ts=="number"&&C.expires_ts>s&&Array.isArray(C.feeds)),w=e(g);if(w!==null){var S=[...v];w.length>0&&S.push(ra(ra({},h),{},{"m.call_id":r.groupCallId,"m.devices":w}));var R={"m.calls":S};yield r.client.sendStateEvent(r.room.roomId,x.GroupCallMemberPrefix,R,o,{keepAlive:a})}})()}addDeviceToMemberState(){var e=this;return T(function*(){yield e.updateDevices(t=>[...t.filter(r=>r.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+Ud,feeds:e.getLocalFeeds().map(r=>({purpose:r.purpose}))}])})()}updateMemberState(){var e=this;return T(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===qe.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(T(function*(){E.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){E.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),Ud*3/4)):yield e.updateDevices(t=>t.filter(r=>r.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return T(function*(){var{devices:t}=yield e.client.getDevices(),r=new Map(t.map(n=>[n.device_id,n]));yield e.updateDevices(n=>{var a=n.filter(s=>{var o=r.get(s.device_id);return o?.last_seen_ts!==void 0&&!(s.device_id===e.client.getDeviceId()&&e.state!==qe.Entered&&!e.enteredViaAnotherSession)});return a.length===n.length?null:a})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new Zf(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(Yt.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(Yt.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(Yt.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(Yt.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function Nd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ia(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Nd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Nd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var me=function(i){return i.Fledgling="fledgling",i.InviteSent="invite_sent",i.WaitLocalMedia="wait_local_media",i.CreateOffer="create_offer",i.CreateAnswer="create_answer",i.Connecting="connecting",i.Connected="connected",i.Ringing="ringing",i.Ended="ended",i}({}),Fd=function(i){return i.Voice="voice",i.Video="video",i}({}),fr=function(i){return i.Inbound="inbound",i.Outbound="outbound",i}({}),$e=function(i){return i.Local="local",i.Remote="remote",i}({}),we=function(i){return i.Hangup="hangup",i.State="state",i.Error="error",i.Replaced="replaced",i.LocalHoldUnhold="local_hold_unhold",i.RemoteHoldUnhold="remote_hold_unhold",i.HoldUnhold="hold_unhold",i.FeedsChanged="feeds_changed",i.AssertedIdentityChanged="asserted_identity_changed",i.LengthChanged="length_changed",i.DataChannel="datachannel",i.SendVoipEvent="send_voip_event",i.PeerConnectionCreated="peer_connection_created",i}({}),_e=function(i){return i.UserHangup="user_hangup",i.LocalOfferFailed="local_offer_failed",i.NoUserMedia="no_user_media",i.UnknownDevices="unknown_devices",i.SendInvite="send_invite",i.CreateAnswer="create_answer",i.CreateOffer="create_offer",i.SendAnswer="send_answer",i.SetRemoteDescription="set_remote_description",i.SetLocalDescription="set_local_description",i.AnsweredElsewhere="answered_elsewhere",i.IceFailed="ice_failed",i.InviteTimeout="invite_timeout",i.Replaced="replaced",i.SignallingFailed="signalling_timeout",i.UserBusy="user_busy",i.Transferred="transferred",i.NewSession="new_session",i}({}),tp="1",rp="stun:turn.matrix.org",Rs=60*1e3,np=1e3,ip=30*1e3,ap=2*1e3;class tr extends Error{constructor(e,t,r){super(t+": "+r),c(this,"code",void 0),this.code=e}}function xr(){return Date.now().toString()+_r(16)}function xd(i){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:i?12e3:void 0}];return e}function At(i,e){return i+":"+e}class sp extends xe{constructor(e){var t,r;if(super(),t=this,c(this,"roomId",void 0),c(this,"callId",void 0),c(this,"invitee",void 0),c(this,"hangupParty",void 0),c(this,"hangupReason",void 0),c(this,"direction",void 0),c(this,"ourPartyId",void 0),c(this,"peerConn",void 0),c(this,"toDeviceSeq",0),c(this,"isPtt",!1),c(this,"_state",me.Fledgling),c(this,"client",void 0),c(this,"forceTURN",void 0),c(this,"turnServers",void 0),c(this,"candidateSendQueue",[]),c(this,"candidateSendTries",0),c(this,"candidatesEnded",!1),c(this,"feeds",[]),c(this,"transceivers",new Map),c(this,"inviteOrAnswerSent",!1),c(this,"waitForLocalAVStream",!1),c(this,"successor",void 0),c(this,"opponentMember",void 0),c(this,"opponentVersion",void 0),c(this,"opponentPartyId",void 0),c(this,"opponentCaps",void 0),c(this,"iceDisconnectedTimeout",void 0),c(this,"iceReconnectionTimeOut",void 0),c(this,"inviteTimeout",void 0),c(this,"removeTrackListeners",new Map),c(this,"remoteOnHold",!1),c(this,"callStatsAtEnd",void 0),c(this,"makingOffer",!1),c(this,"ignoreOffer",!1),c(this,"isSettingRemoteAnswerPending",!1),c(this,"responsePromiseChain",void 0),c(this,"remoteCandidateBuffer",new Map),c(this,"remoteAssertedIdentity",void 0),c(this,"remoteSDPStreamMetadata",void 0),c(this,"callLengthInterval",void 0),c(this,"callStartTime",void 0),c(this,"opponentDeviceId",void 0),c(this,"hasOpponentDeviceInfo",void 0),c(this,"opponentSessionId",void 0),c(this,"groupCallId",void 0),c(this,"stopVideoTrackTimer",void 0),c(this,"isOnlyDataChannelAllowed",void 0),c(this,"stats",void 0),c(this,"gotLocalIceCandidate",a=>{if(a.candidate){if(this.candidatesEnded&&E.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),E.debug("Call ".concat(this.callId," got local ICE ").concat(a.candidate.sdpMid," ").concat(a.candidate.candidate)),this.callHasEnded())return;a.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(a.candidate)}}),c(this,"onIceGatheringStateChange",a=>{var s;E.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((s=this.peerConn)===null||s===void 0?void 0:s.iceGatheringState)==="complete"&&(this.queueCandidate(null),E.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),c(this,"getLocalOfferFailed",a=>{E.error("Call ".concat(this.callId," getLocalOfferFailed() running"),a),this.emit(we.Error,new tr(_e.LocalOfferFailed,"Failed to get local offer!",a),this),this.terminate($e.Local,_e.LocalOfferFailed,!1)}),c(this,"getUserMediaFailed",a=>{if(this.successor){this.successor.getUserMediaFailed(a);return}E.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),a),this.emit(we.Error,new tr(_e.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",a),this),this.terminate($e.Local,_e.NoUserMedia,!1)}),c(this,"placeCallFailed",a=>{if(this.successor){this.successor.placeCallFailed(a);return}E.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),a),this.emit(we.Error,new tr(_e.IceFailed,"Couldn't start call! Invalid ICE server configuration.",a),this),this.terminate($e.Local,_e.IceFailed,!1)}),c(this,"onIceConnectionStateChanged",()=>{var a,s,o,l,d,u;if(!this.callHasEnded()){if(E.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.iceConnectionState,", conn=").concat((s=this.peerConn)===null||s===void 0?void 0:s.connectionState,")")),["connected","completed"].includes((o=(l=this.peerConn)===null||l===void 0?void 0:l.iceConnectionState)!==null&&o!==void 0?o:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=me.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(we.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},np));else if(((d=this.peerConn)===null||d===void 0?void 0:d.iceConnectionState)=="failed"){var h;if(this.candidatesEnded=!1,(h=this.peerConn)!==null&&h!==void 0&&h.restartIce){var v;this.candidatesEnded=!1,E.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState,")")),this.peerConn.restartIce()}else E.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(_e.IceFailed,!1)}else((u=this.peerConn)===null||u===void 0?void 0:u.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var f,g,w;E.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((f=this.peerConn)===null||f===void 0?void 0:f.iceConnectionState,", conn=").concat((g=this.peerConn)===null||g===void 0?void 0:g.connectionState,")")),(w=this.peerConn)!==null&&w!==void 0&&w.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},ap),this.iceDisconnectedTimeout=setTimeout(()=>{E.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(_e.IceFailed,!1)},ip),this.state=me.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var m of this.getRemoteFeeds())m.setAudioVideoMuted(!0,!0)}}),c(this,"onSignallingStateChanged",()=>{var a;E.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.signalingState,")"))}),c(this,"onTrack",a=>{if(a.streams.length===0){E.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(a.track.kind,")"));return}var s=a.streams[0];if(this.pushRemoteFeed(s),!this.removeTrackListeners.has(s)){var o=()=>{s.getTracks().length===0&&(E.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(s.id,")")),this.deleteFeedByStream(s),s.removeEventListener("removetrack",o),this.removeTrackListeners.delete(s))};s.addEventListener("removetrack",o),this.removeTrackListeners.set(s,o)}}),c(this,"onDataChannel",a=>{this.emit(we.DataChannel,a.channel,this)}),c(this,"onNegotiationNeeded",T(function*(){if(E.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==me.CreateOffer&&t.opponentVersion===0){E.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),c(this,"onHangupReceived",a=>{E.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(a)||this.state===me.Ringing?this.terminate($e.Remote,a.reason||_e.UserHangup,!0):E.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(a.party_id,": our partner is ").concat(this.opponentPartyId))}),c(this,"onRejectReceived",a=>{E.debug("Call ".concat(this.callId," onRejectReceived() running"));var s=[me.InviteSent,me.Ringing].includes(this.state)||this.state===me.Fledgling&&this.direction===fr.Inbound;s?this.terminate($e.Remote,a.reason||_e.UserHangup,!0):E.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),c(this,"onAnsweredElsewhere",a=>{E.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate($e.Remote,_e.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(r=e.forceTURN)!==null&&r!==void 0?r:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[rp]});for(var n of this.turnServers)zu(n,["urls"]);this.callId=xr(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return T(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return T(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var r=this.peerConn.createDataChannel(e,t);return this.emit(we.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(we.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?Fd.Video:Fd.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ue.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ue.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(At(Ue.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(At(Ue.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ue.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ue.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ue.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ue.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return T(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var r=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);throw r?(e.hasOpponentDeviceInfo=!1,new jc(r)):new Error("Couldn't find opponent user ID to init crypto")}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,a=this.remoteSDPStreamMetadata[e.id].video_muted;if(!r){E.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){E.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new nr({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:a})),this.emit(we.FeedsChanged,this.feeds,this),E.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))}pushRemoteFeedWithoutMetadata(e){var t,r=this.getOpponentMember().userId,n=Ue.Usermedia,a=(t=this.feeds.find(s=>!s.isLocal()))===null||t===void 0?void 0:t.stream;if(a&&e.id!==a.id){E.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){E.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new nr({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(we.FeedsChanged,this.feeds,this),E.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=this.client.getUserId();if(Qe(e.getAudioTracks(),!0),Qe(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){E.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new nr({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){var t=this,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(s=>e.stream.id===s.stream.id)){E.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),r){var n=function(){E.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(a.id,", kind=").concat(a.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(a.enabled,")"));var o=At(e.purpose,a.kind);if(t.transceivers.has(o)){var l=t.transceivers.get(o);l.sender.replaceTrack(a),l.direction=l.direction==="inactive"?"sendonly":"sendrecv"}else{var d=t.peerConn.addTrack(a,e.stream),u=t.peerConn.getTransceivers().find(h=>h.sender===d);u?t.transceivers.set(o,u):E.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var a of e.stream.getTracks())n()}E.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(we.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=At(e.purpose,"audio"),r=At(e.purpose,"video");for(var n of[t,r])if(this.transceivers.has(n)){var a=this.transceivers.get(n);a.sender&&this.peerConn.removeTrack(a.sender)}e.purpose===Ue.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(we.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){E.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(we.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return T(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return T(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),r=[];return t.forEach(n=>{r.push(n)}),r}})()}initWithInvite(e){var t=this;return T(function*(){var r,n=e.getContent();t.direction=fr.Inbound;var a=yield t.client.checkTurnServers();a||E.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var s=n[hr];s?t.updateRemoteSDPStreamMetadata(s):E.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(we.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(n.offer),E.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(n.offer.type)),yield t.addBufferedIceCandidates()}catch(u){E.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),u),t.terminate($e.Local,_e.SetRemoteDescription,!1);return}var o=(r=t.feeds.find(u=>!u.isLocal()))===null||r===void 0?void 0:r.stream;if(!t.isOnlyDataChannelAllowed&&(!o||o.getTracks().length===0)){E.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate($e.Local,_e.SetRemoteDescription,!1);return}if(t.state=me.Ringing,e.getLocalAge()){var l=setTimeout(()=>{if(t.state==me.Ringing){var u;E.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=$e.Remote,t.state=me.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(u=t.stats)===null||u===void 0||u.removeStatsReportGatherer(t.callId),t.emit(we.Hangup,t)}},n.lifetime-e.getLocalAge()),d=u=>{u!==me.Ringing&&(clearTimeout(l),t.off(we.State,d))};t.on(we.State,d)}})()}initWithHangup(e){this.state=me.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(E.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):!Qu(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(E.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t):e??t}answer(e,t){var r=this;return T(function*(){if(!r.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!r.localUsermediaStream&&!r.waitForLocalAVStream){var n=r.state,a=r.shouldAnswerWithMediaType(e,r.hasRemoteUserMediaAudioTrack,"audio"),s=r.shouldAnswerWithMediaType(t,r.hasRemoteUserMediaVideoTrack,"video");r.state=me.WaitLocalMedia,r.waitForLocalAVStream=!0;try{var o,l=yield r.client.getMediaHandler().getUserMediaStream(a,s);r.waitForLocalAVStream=!1;var d=new nr({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(o=r.client.getDeviceId())!==null&&o!==void 0?o:void 0,stream:l,purpose:Ue.Usermedia,audioMuted:!1,videoMuted:!1}),u=[d];r.localScreensharingFeed&&u.push(r.localScreensharingFeed),r.answerWithCallFeeds(u)}catch(h){if(s)E.warn("Call ".concat(r.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),r.state=n,r.waitForLocalAVStream=!1,yield r.answer(a,!1);else{r.getUserMediaFailed(h);return}}}else r.waitForLocalAVStream&&(r.state=me.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){E.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===me.WaitLocalMedia?(E.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[me.CreateOffer,me.InviteSent].includes(this.state)&&(e.direction===fr.Outbound?e.queueGotCallFeedsForAnswer([]):(E.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(we.Replaced,e,this),this.hangup(_e.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(E.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate($e.Local,e,!t),![me.Fledgling,me.WaitLocalMedia].includes(this.state))){var r={};(this.opponentVersion&&this.opponentVersion!==0||e!==_e.UserHangup)&&(r.reason=e),this.sendVoipEvent(x.CallHangup,r)}}reject(){if(this.state!==me.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){E.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(_e.UserHangup,!0);return}E.debug("Rejecting call: "+this.callId),this.terminate($e.Local,_e.UserHangup,!0),this.sendVoipEvent(x.CallReject,{})}upgradeCall(e,t){var r=this;return T(function*(){if(!(!e&&!t)&&r.opponentSupportsSDPStreamMetadata())try{E.debug("Call ".concat(r.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var n=e||r.hasLocalUserMediaAudioTrack,a=t||r.hasLocalUserMediaVideoTrack,s=yield r.client.getMediaHandler().getUserMediaStream(n,a,!1);yield r.updateLocalUsermediaStream(s,e,t)}catch(o){E.error("Call ".concat(r.callId," upgradeCall() failed to upgrade the call"),o),r.emit(we.Error,new tr(_e.NoUserMedia,"Failed to get camera access: ",o),r)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var r=this;return T(function*(){if(e&&r.isScreensharing())return E.warn("Call ".concat(r.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!r.isScreensharing())return E.warn("Call ".concat(r.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!r.opponentSupportsSDPStreamMetadata())return r.setScreensharingEnabledWithoutMetadataSupport(e,t);if(E.debug("Call ".concat(r.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var n=yield r.client.getMediaHandler().getScreensharingStream(t);return n?(r.pushNewLocalFeed(n,Ue.Screenshare),!0):!1}catch(l){return E.error("Call ".concat(r.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),l),!1}else{var a=r.transceivers.get(At(Ue.Screenshare,"audio")),s=r.transceivers.get(At(Ue.Screenshare,"video"));for(var o of[a,s])o&&o.sender&&r.peerConn.removeTrack(o.sender);return r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var r=this;return T(function*(){if(E.debug("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var n,a=yield r.client.getMediaHandler().getScreensharingStream(t);if(!a)return!1;var s=a.getTracks().find(v=>v.kind==="video"),o=(n=r.transceivers.get(At(Ue.Usermedia,"video")))===null||n===void 0?void 0:n.sender;return o?.replaceTrack(s??null),r.pushNewLocalFeed(a,Ue.Screenshare,!1),!0}catch(v){return E.error("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),v),!1}else{var l,d,u=(l=r.localUsermediaStream)===null||l===void 0?void 0:l.getTracks().find(v=>v.kind==="video"),h=(d=r.transceivers.get(At(Ue.Usermedia,"video")))===null||d===void 0?void 0:d.sender;return h?.replaceTrack(u??null),r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,a=t.length>2&&t[2]!==void 0?t[2]:!1,s=r.localUsermediaFeed,o=n||!s.isAudioMuted()&&!r.remoteOnHold,l=a||!s.isVideoMuted()&&!r.remoteOnHold;E.log("Call ".concat(r.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(o,", video=").concat(l,")")),Qe(e.getAudioTracks(),o),Qe(e.getVideoTracks(),l);for(var d of r.localUsermediaStream.getTracks())r.localUsermediaStream.removeTrack(d),d.stop();for(var u of e.getTracks())r.localUsermediaStream.addTrack(u);var h=function*(){var f=At(Ue.Usermedia,v.kind),g=r.transceivers.get(f),w=g?.sender,S=!1;if(w)try{E.info("Call ".concat(r.callId," updateLocalUsermediaStream() replacing track (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")")),yield w.replaceTrack(v),g.direction=g.direction==="inactive"?"sendonly":"sendrecv",S=!0}catch(b){E.warn("Call ".concat(r.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),b)}if(!S){E.info("Call ".concat(r.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")"));var R=r.peerConn.addTrack(v,r.localUsermediaStream),C=r.peerConn.getTransceivers().find(b=>b.sender===R);C?r.transceivers.set(f,C):E.warn("Call ".concat(r.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var v of e.getTracks())yield*h()})()}setLocalVideoMuted(e){var t=this;return T(function*(){var r;if(E.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var n;return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var a=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(a)}return(r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var s of t.localUsermediaStream.getVideoTracks())s.stop(),t.localUsermediaStream.removeTrack(s)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return T(function*(){var r;return E.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(we.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==me.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var r=["inactive","recvonly"].includes(t.currentDirection);r||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var r;if(((r=t.track)===null||r===void 0?void 0:r.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;E.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),Qe(this.localUsermediaStream.getAudioTracks(),!e),Qe(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return T(function*(){yield e.sendVoipEvent(x.CallSDPStreamMetadataChangedPrefix,{[hr]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var r of e)this.pushLocalFeed(r);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=me.CreateOffer,E.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return T(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[hr]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var r=e.discardDuplicateCandidates();E.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(r," candidates that will be sent in answer"));try{yield e.sendVoipEvent(x.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(s){e.state=me.Ringing,s instanceof je&&s.event&&e.client.cancelPendingEvent(s.event);var n=_e.SendAnswer,a="Failed to send answer";throw s.name=="UnknownDeviceError"&&(n=_e.UnknownDevices,a="Unknown devices present in the room"),e.emit(we.Error,new tr(n,a,s),e),s}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var r=zs.parse(e.sdp);r.media.forEach(n=>{var a=new Map,s=new Map;for(var o of n.rtp)a.set(o.payload,o.codec),s.set(o.codec,o.payload);for(var l of t)if(l.mediaType===n.type){if(!s.has(l.codec)){E.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(l.codec," as it's not present."));continue}var d=[];l.enableDtx!==void 0&&d.push("usedtx=".concat(l.enableDtx?"1":"0")),l.maxAverageBitrate!==void 0&&d.push("maxaveragebitrate=".concat(l.maxAverageBitrate));var u=!1;for(var h of n.fmtp)a.get(h.payload)===l.codec&&(u=!0,h.config+=";"+d.join(";"));u||n.fmtp.push({payload:s.get(l.codec),config:d.join(";")})}}),e.sdp=zs.write(r)}createOffer(){var e=this;return T(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,xd(e.isPtt)),t})()}createAnswer(){var e=this;return T(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,xd(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return T(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var r of e)t.pushLocalFeed(r);t.state=me.CreateAnswer;var n;try{t.getRidOfRTXCodecs(),n=yield t.createAnswer()}catch(a){E.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),a),t.terminate($e.Local,_e.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(n),t.callHasEnded()||(t.state=me.Connecting,yield new Promise(a=>{setTimeout(a,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(a){E.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),a),t.terminate($e.Local,_e.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return T(function*(){if(!t.callHasEnded()){var r=e.getContent(),n=r.candidates;if(!n){E.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var a=r.version===0?null:r.party_id||null;if(t.opponentPartyId===void 0){if(a){E.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(n.length," candidates until we pick an opponent"));var s=t.remoteCandidateBuffer.get(a)||[];s.push(...n),t.remoteCandidateBuffer.set(a,s)}return}if(!t.partyIdMatches(r)){E.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(r.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(n)}})()}onAnswerReceived(e){var t=this;return T(function*(){var r=e.getContent();if(E.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(r.party_id,")")),t.callHasEnded()){E.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){E.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(r.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=me.Connecting;var n=r[hr];n?t.updateRemoteSDPStreamMetadata(n):E.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(r.answer),t.isSettingRemoteAnswerPending=!1,E.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(r.answer.type))}catch(a){t.isSettingRemoteAnswerPending=!1,E.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),a),t.terminate($e.Local,_e.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(x.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(a){E.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),a)}})()}onSelectAnswerReceived(e){var t=this;return T(function*(){if(t.direction!==fr.Inbound){E.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var r=e.getContent().selected_party_id;if(r==null){E.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}r!==t.ourPartyId&&(E.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(r,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate($e.Remote,_e.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return T(function*(){var r=e.getContent(),n=r.description;if(!n||!n.sdp||!n.type){E.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var a=t.direction===fr.Inbound,s=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),o=n.type==="offer"&&!s;if(t.ignoreOffer=!a&&o,t.ignoreOffer){E.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var l=t.isLocalOnHold(),d=r[hr];d?t.updateRemoteSDPStreamMetadata(d):E.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=n.type=="answer",yield t.peerConn.setRemoteDescription(n),t.isSettingRemoteAnswerPending=!1,E.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(n.type)),n.type==="offer"){var u,h;try{t.getRidOfRTXCodecs(),h=yield t.createAnswer()}catch(m){E.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),m),t.terminate($e.Local,_e.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(h),E.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(x.CallNegotiate,{lifetime:Rs,description:(u=t.peerConn.localDescription)===null||u===void 0?void 0:u.toJSON(),[hr]:t.getLocalSDPStreamMetadata(!0)})}}catch(m){t.isSettingRemoteAnswerPending=!1,E.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),m)}var v=t.isLocalOnHold();l!==v&&(t.emit(we.LocalHoldUnhold,v,t),t.emit(we.HoldUnhold,v))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=Zu(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var r,n=t.stream.id,a=this.remoteSDPStreamMetadata[n];t.setAudioVideoMuted(a?.audio_muted,a?.video_muted),t.purpose=(r=this.remoteSDPStreamMetadata[n])===null||r===void 0?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),r=t[hr];this.updateRemoteSDPStreamMetadata(r)}onAssertedIdentityReceived(e){var t=this;return T(function*(){var r=e.getContent();r.asserted_identity&&(t.remoteAssertedIdentity={id:r.asserted_identity.id,displayName:r.asserted_identity.display_name},t.emit(we.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===me.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return T(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return T(function*(){if(E.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){E.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(u){E.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),u),e.terminate($e.Local,_e.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(u){E.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),u),e.terminate($e.Local,_e.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(u=>{setTimeout(u,200)})),!e.callHasEnded()){var r=e.state===me.CreateOffer?x.CallInvite:x.CallNegotiate,n={lifetime:Rs};if(r===x.CallInvite&&e.invitee&&(n.invitee=e.invitee),e.state===me.CreateOffer){var a;n.offer=(a=e.peerConn.localDescription)===null||a===void 0?void 0:a.toJSON()}else{var s;n.description=(s=e.peerConn.localDescription)===null||s===void 0?void 0:s.toJSON()}n.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},n[hr]=e.getLocalSDPStreamMetadata(!0);var o=e.discardDuplicateCandidates();E.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(o," candidates that will be sent in offer"));try{yield e.sendVoipEvent(r,n)}catch(u){E.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),u),u instanceof je&&u.event&&e.client.cancelPendingEvent(u.event);var l=_e.SignallingFailed,d="Signalling failed";e.state===me.CreateOffer&&(l=_e.SendInvite,d="Failed to send invite"),u.name=="UnknownDeviceError"&&(l=_e.UnknownDevices,d="Unknown devices present in the room"),e.emit(we.Error,new tr(l,d,u),e),e.terminate($e.Local,l,!1);return}e.sendCandidateQueue(),e.state===me.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=me.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===me.InviteSent&&e.hangup(_e.InviteTimeout,!1)},Rs))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(At(Ue.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,r=RTCRtpSender.getCapabilities("video").codecs,n=[];for(var a of[...t,...r])if(a.mimeType!=="video/rtx"){n.push(a);try{e.setCodecPreferences(n)}catch(s){E.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",a,s),n.pop()}}}}}sendVoipEvent(e,t){var r=this;return T(function*(){var n=ia(ia({},t),{},{version:tp,call_id:r.callId,party_id:r.ourPartyId,conf_id:r.groupCallId});if(r.opponentDeviceId){var a,s=r.toDeviceSeq++,o=ia(ia({},n),{},{device_id:r.client.deviceId,sender_session_id:r.client.getSessionId(),dest_session_id:r.opponentSessionId,seq:s,[xi]:Cf()});r.emit(we.SendVoipEvent,{type:"toDevice",eventType:e,userId:r.invitee||((a=r.getOpponentMember())===null||a===void 0?void 0:a.userId),opponentDeviceId:r.opponentDeviceId,content:o},r);var l=r.invitee||r.getOpponentMember().userId;if(r.client.getUseE2eForGroupCall()){if(!r.hasOpponentDeviceInfo){E.warn("Call ".concat(r.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}throw new Error("Unimplemented")}else yield r.client.sendToDevice(e,new Map([[l,new Map([[r.opponentDeviceId,o]])]]))}else{var d;r.emit(we.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:r.roomId,content:n,userId:r.invitee||((d=r.getOpponentMember())===null||d===void 0?void 0:d.userId)},r),yield r.client.sendEvent(r.roomId,e,n)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===me.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===fr.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],r=0;r<this.candidateSendQueue.length;r++){var n=this.candidateSendQueue[r];n.candidate===""?t.push(n):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return T(function*(){var r=yield t.client.getProfileInfo(e),n=xr(),a={replacement_id:xr(),target_user:{id:e,display_name:r.displayname,avatar_url:r.avatar_url},create_call:n};yield t.sendVoipEvent(x.CallReplaces,a),yield t.terminate($e.Local,_e.Transferred,!0)})()}transferToCall(e){var t=this;return T(function*(){var r,n,a=(r=e.getOpponentMember())===null||r===void 0?void 0:r.userId,s=a?yield t.client.getProfileInfo(a):void 0,o=(n=t.getOpponentMember())===null||n===void 0?void 0:n.userId,l=o?yield t.client.getProfileInfo(o):void 0,d=xr(),u={replacement_id:xr(),target_user:{id:o,display_name:l?.displayname,avatar_url:l?.avatar_url},await_call:d};yield e.sendVoipEvent(x.CallReplaces,u);var h={replacement_id:xr(),target_user:{id:a,display_name:s?.displayname,avatar_url:s?.avatar_url},create_call:d};yield t.sendVoipEvent(x.CallReplaces,h),yield t.terminate($e.Local,_e.Transferred,!0),yield e.terminate($e.Local,_e.Transferred,!0)})()}terminate(e,t,r){var n=this;return T(function*(){var a;if(!n.callHasEnded()){n.hangupParty=e,n.hangupReason=t,n.state=me.Ended,n.inviteTimeout&&(clearTimeout(n.inviteTimeout),n.inviteTimeout=void 0),n.iceDisconnectedTimeout!==void 0&&(clearTimeout(n.iceDisconnectedTimeout),n.iceDisconnectedTimeout=void 0),n.callLengthInterval&&(clearInterval(n.callLengthInterval),n.callLengthInterval=void 0),n.stopVideoTrackTimer!==void 0&&(clearTimeout(n.stopVideoTrackTimer),n.stopVideoTrackTimer=void 0);for(var[s,o]of n.removeTrackListeners)s.removeEventListener("removetrack",o);n.removeTrackListeners.clear(),n.callStatsAtEnd=yield n.collectCallStats(),n.stopAllMedia(),n.deleteAllFeeds(),n.peerConn&&n.peerConn.signalingState!=="closed"&&n.peerConn.close(),(a=n.stats)===null||a===void 0||a.removeStatsReportGatherer(n.callId),r&&n.emit(we.Hangup,n),n.client.callEventHandler.calls.delete(n.callId)}})()}stopAllMedia(){E.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===Ue.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Ue.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){E.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(yo.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return T(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var r={candidates:t.map(o=>o.toJSON())};e.candidatesEnded&&r.candidates.push({candidate:""}),E.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(x.CallCandidates,r),e.candidateSendTries=0,e.sendCandidateQueue()}catch(o){if(o instanceof je&&o.event&&e.client.cancelPendingEvent(o.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){E.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),o);var n=_e.SignallingFailed,a="Signalling failed";e.emit(we.Error,new tr(n,a,o),e),e.hangup(n,!1);return}var s=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,E.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(s,"ms"),o),setTimeout(()=>{e.sendCandidateQueue()},s)}}})()}placeCall(e,t){var r=this;return T(function*(){if(!e)throw new Error("You CANNOT start a call without audio");r.state=me.WaitLocalMedia;var n;try{var a,s=yield r.client.getMediaHandler().getUserMediaStream(e,t);Qe(s.getAudioTracks(),!0),Qe(s.getVideoTracks(),!0),n=new nr({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(a=r.client.getDeviceId())!==null&&a!==void 0?a:void 0,stream:s,purpose:Ue.Usermedia,audioMuted:!1,videoMuted:!1})}catch(o){r.getUserMediaFailed(o);return}try{yield r.placeCallWithCallFeeds([n])}catch(o){r.placeCallFailed(o);return}})()}placeCallWithCallFeeds(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;r.checkForErrorListener(),r.direction=fr.Outbound,yield r.initOpponentCrypto(),r.client.callEventHandler.calls.set(r.callId,r);var a=yield r.client.checkTurnServers();a||E.warn("Call ".concat(r.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),r.peerConn=r.createPeerConnection(),r.emit(we.PeerConnectionCreated,r.peerConn,r),r.gotCallFeedsForInvite(e,n)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var r=this.getOpponentMember(),n=r?r.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,r=e.getContent();if(E.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(r.party_id,")")),this.opponentVersion=r.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=r.party_id||null,this.opponentCaps=r.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var n;(n=this.stats)===null||n===void 0||n.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return T(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(E.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return T(function*(){for(var r of e){(r.sdpMid===null||r.sdpMid===void 0)&&(r.sdpMLineIndex===null||r.sdpMLineIndex===void 0)?E.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):E.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(r.sdpMid,", candidate=").concat(r.candidate,")"));try{yield t.peerConn.addIceCandidate(r)}catch(n){t.ignoreOffer?E.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),n):E.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),n)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}}function Qe(i,e){for(var t of i)t.enabled=e}function to(){if(typeof window>"u"||typeof document>"u")return!1;try{var i,e,t,r=!!((i=(e=(t=window.RTCPeerConnection)!==null&&t!==void 0?t:window.RTCSessionDescription)!==null&&e!==void 0?e:window.RTCIceCandidate)!==null&&i!==void 0?i:navigator.mediaDevices);if(!r)return E.error("WebRTC is not supported in this browser / environment"),!1}catch(n){return E.error("Exception thrown when trying to access WebRTC",n),!1}return!0}function Tn(i,e,t){if(!to())return null;var r=t?t.forceTURN:!1,n={client:i,roomId:e,invitee:t?.invitee,turnServers:i.getTurnServers(),forceTURN:i.forceTURN||r,opponentDeviceId:t?.opponentDeviceId,opponentSessionId:t?.opponentSessionId,groupCallId:t?.groupCallId},a=new sp(n);return i.reEmitter.reEmit(a,Object.values(we)),a}var lr=function(i){return i.DontNotify="dont_notify",i.Notify="notify",i.Coalesce="coalesce",i}({}),Qa=function(i){return i.Highlight="highlight",i.Sound="sound",i}({}),Bc=function(i){return i.ExactEquals="==",i.LessThan="<",i.GreaterThan=">",i.GreaterThanOrEqual=">=",i.LessThanOrEqual="<=",i}({}),Wc="2";function qc(i){return i==="==2"||i==="2"}var Je=function(i){return i.EventMatch="event_match",i.EventPropertyIs="event_property_is",i.EventPropertyContains="event_property_contains",i.ContainsDisplayName="contains_display_name",i.RoomMemberCount="room_member_count",i.SenderNotificationPermission="sender_notification_permission",i.CallStarted="call_started",i.CallStartedPrefix="org.matrix.msc3914.call_started",i}({}),it=function(i){return i.Override="override",i.ContentSpecific="content",i.RoomSpecific="room",i.SenderSpecific="sender",i.Underride="underride",i}({}),rt=function(i){return i.Master=".m.rule.master",i.IsUserMention=".m.rule.is_user_mention",i.IsRoomMention=".m.rule.is_room_mention",i.ContainsDisplayName=".m.rule.contains_display_name",i.ContainsUserName=".m.rule.contains_user_name",i.AtRoomNotification=".m.rule.roomnotif",i.DM=".m.rule.room_one_to_one",i.EncryptedDM=".m.rule.encrypted_room_one_to_one",i.Message=".m.rule.message",i.EncryptedMessage=".m.rule.encrypted",i.InviteToSelf=".m.rule.invite_for_me",i.MemberEvent=".m.rule.member_event",i.IncomingCall=".m.rule.call",i.SuppressNotices=".m.rule.suppress_notices",i.Tombstone=".m.rule.tombstone",i.PollStart=".m.rule.poll_start",i.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",i.PollEnd=".m.rule.poll_end",i.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",i.PollStartOneToOne=".m.rule.poll_start_one_to_one",i.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",i.PollEndOneToOne=".m.rule.poll_end_one_to_one",i.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",i}({});function jd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Bd(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?jd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):jd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Wd=[it.Override,it.ContentSpecific,it.RoomSpecific,it.SenderSpecific,it.Underride],op={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:Je.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:Je.SenderNotificationPermission,key:"room"}],actions:[lr.Notify,{set_tweak:Qa.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:Je.EventMatch,key:"type",pattern:"m.reaction"}],actions:[lr.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:Je.EventMatch,key:"type",pattern:x.RoomServerAcl},{kind:Je.EventMatch,key:"state_key",pattern:""}],actions:[]}},$o=Symbol("UserDefinedRules"),lp=[rt.Master,$o,rt.SuppressNotices,rt.InviteToSelf,rt.MemberEvent,rt.IsUserMention,rt.ContainsDisplayName,rt.IsRoomMention,rt.AtRoomNotification,rt.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],dp={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:Je.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:Je.CallStarted}],actions:[lr.Notify,{set_tweak:Qa.Sound,value:"default"}]}},up=[$o,rt.IncomingCall,".org.matrix.msc3914.rule.room.call",rt.EncryptedDM,rt.DM,rt.Message,rt.EncryptedMessage];function qd(i,e,t,r){var n=e.filter(m=>m.default),a=e.filter(m=>!m.default);function s(m){m===$o?l.push(...a):m in t?(E.warn("Adding default global ".concat(i," push rule ").concat(m)),l.push(t[m])):E.warn("Missing default global ".concat(i," push rule ").concat(m))}var o=0,l=[];for(var d of n){var u=r.indexOf(d.rule_id);if(u===-1){l.push(d);continue}for(;u>o;){var h=r[o];s(h),o+=1}l.push(d),o+=1}for(var v of r.slice(o))s(v);return l}class Ut{constructor(e){this.client=e,c(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var r of e)r===lr.Notify?t.notify=!0:typeof r=="object"&&(r.value===void 0&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e){var t=JSON.parse(JSON.stringify(e));return t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.underride||(t.global.underride=[]),t.global.override=qd(it.Override,t.global.override,op,lp),t.global.underride=qd(it.Underride,t.global.underride,dp,up),t}static getPushRuleGlobRegex(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"i",[n,a]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],s="".concat(t,"-").concat(r,"-").concat(e);return Ut.cachedGlobToRegex[s]||(Ut.cachedGlobToRegex[s]=new RegExp(n+"("+Xu(e)+")"+a,r)),Ut.cachedGlobToRegex[s]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var n of r)if(n.conditions)for(var a of n.conditions)a.kind===Je.EventMatch&&(t.delete(a.key),this.parsedKeys.set(a.key,Ut.partsForDottedKey(a.key)));t.forEach(s=>this.parsedKeys.delete(s))}matchingRuleFromKindSet(e,t){for(var r of Wd){var n=t[r];if(n){for(var a of n)if(a.enabled){var s=this.templateRuleToRaw(r,a);if(s&&this.ruleMatchesEvent(s,e))return Bd(Bd({},a),{},{kind:r})}}}return null}templateRuleToRaw(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case it.Underride:case it.Override:r.conditions=t.conditions;break;case it.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:Je.EventMatch,key:"room_id",value:t.rule_id});break;case it.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:Je.EventMatch,key:"user_id",value:t.rule_id});break;case it.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:Je.EventMatch,key:"content.body",pattern:t.pattern});break}return r}eventFulfillsCondition(e,t){switch(e.kind){case Je.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case Je.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case Je.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case Je.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case Je.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case Je.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case Je.CallStarted:case Je.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var r=e.key;if(!r)return!1;var n=this.client.getRoom(t.getRoomId());return n!=null&&n.currentState?n.currentState.mayTriggerNotifOfType(r,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var n=r.currentState.getJoinedMemberCount(),a=e.is.match(/^([=<>]*)(\d*)$/);if(!a)return!1;var s=a[1],o=parseInt(a[2]);if(isNaN(o))return!1;switch(s){case"":case"==":return n==o;case"<":return n<o;case">":return n>o;case"<=":return n<=o;case">=":return n>=o;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r,n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||typeof n.body!="string")return!1;var a=this.client.getRoom(t.getRoomId()),s=a==null||(r=a.currentState)===null||r===void 0?void 0:r.getMember(this.client.credentials.userId);if(!s)return!1;var o=s.name,l=new RegExp("(^|\\W)"+Yu(o)+"(\\W|$)","i");return n.body.search(l)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var r=this.valueForDottedKey(e.key,t);if(typeof r!="string")return!1;if(e.value)return e.value===r;if(typeof e.pattern!="string")return!1;var n=Ut.getPushRuleGlobRegex(e.pattern,e.key==="content.body");return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var r=this.valueForDottedKey(e.key,t);return Array.isArray(r)?r.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||En(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],r="",n=!1;for(var a of e){if(n){a==="\\"||a==="."?r+=a:r+="\\"+a,n=!1;continue}a=="."?(t.push(r),r=""):a=="\\"?n=!0:r+=a}return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){var r=this.parsedKeys.get(e);r===void 0&&(r=Ut.partsForDottedKey(e),this.parsedKeys.set(e,r));var n,a=r[0],s=0;for(a==="content"?(n=t.getContent(),++s):a==="type"?(n=t.getType(),++s):n=t.event;s<r.length;++s){if(Qu(n))return;var o=r[s];n=n[o]}return n}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};var n=Ut.actionListToActionsObject(r.actions);return n.tweaks.highlight===void 0&&(n.tweaks.highlight=r.kind==it.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===rt.ContainsUserName||e.rule_id===rt.ContainsDisplayName||e.rule_id===rt.AtRoomNotification)?!1:!((r=e.conditions)!==null&&r!==void 0&&r.some(n=>!this.eventFulfillsCondition(n,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,r=this.getPushRuleAndKindById(e);return(t=r?.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var r;if(((r=this.client.pushRules)===null||r===void 0?void 0:r[t])!==void 0){for(var n of Wd)if(this.client.pushRules[t][n]!==void 0){for(var a of this.client.pushRules[t][n])if(a.rule_id===e)return{rule:a,kind:n}}}}return null}}c(Ut,"cachedGlobToRegex",{});var In=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],Kc=In[0],Vc=In[In.length-1],St=function(i){return i.SUCCESS="SUCCESS",i.IGNORE="IGNORE",i.PROMPT="PROMPT",i.FAIL_PROMPT="FAIL_PROMPT",i.FAIL_ERROR="FAIL_ERROR",i}({}),Tt=function(i){return i.Invalid="Invalid homeserver discovery response",i.GenericFailure="Failed to get autodiscovery configuration from server",i.InvalidHsBaseUrl="Invalid base_url for m.homeserver",i.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",i.InvalidIsBaseUrl="Invalid base_url for m.identity_server",i.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",i.InvalidIs="Invalid identity server discovery response",i.MissingWellknown="No .well-known JSON file found",i.InvalidJson="Invalid JSON",i.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",i}({});class ye{static fromDiscoveryConfig(e){var t=this;return T(function*(){var r,n={"m.homeserver":{state:ye.FAIL_ERROR,error:ye.ERROR_INVALID,base_url:null},"m.identity_server":{state:ye.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return E.error("No m.homeserver key in config"),n["m.homeserver"].state=ye.FAIL_PROMPT,n["m.homeserver"].error=ye.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"].base_url)return E.error("No m.homeserver base_url in config"),n["m.homeserver"].state=ye.FAIL_PROMPT,n["m.homeserver"].error=ye.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var a=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!a)return E.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=ye.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var s=yield t.fetchWellKnownObject("".concat(a,"/_matrix/client/versions"));if(!s||!Array.isArray((r=s.raw)===null||r===void 0?void 0:r.versions))return E.error("Invalid /versions response"),n["m.homeserver"].error=ye.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=a,Promise.resolve(n);var o=new Set(s.raw.versions),l=!1;for(var d of In)if(o.has(d)){l=!0;break}if(!l)return E.error("Homeserver does not meet version requirements"),n["m.homeserver"].error=ye.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,n["m.homeserver"].base_url=a,Promise.resolve(n);n["m.homeserver"]={state:ye.SUCCESS,error:null,base_url:a};var u="";if(e["m.identity_server"]){var h={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:ye.FAIL_PROMPT,error:ye.ERROR_INVALID_IS,base_url:null}};if(u=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!u)return E.error("Invalid base_url for m.identity_server"),h["m.identity_server"].error=ye.ERROR_INVALID_IS_BASE_URL,Promise.resolve(h);var v=yield t.fetchWellKnownObject("".concat(u,"/_matrix/identity/v2"));if(!(v!=null&&v.raw)||v.action!==St.SUCCESS)return E.error("Invalid /v2 response"),h["m.identity_server"].error=ye.ERROR_INVALID_IDENTITY_SERVER,h["m.identity_server"].base_url=u,Promise.resolve(h)}return u&&u.toString().length>0&&(n["m.identity_server"]={state:ye.SUCCESS,error:null,base_url:u}),Object.keys(e).forEach(m=>{if(m==="m.homeserver"||m==="m.identity_server"){var f=["error","state","base_url"];for(var g of Object.keys(e[m]))f.includes(g)||(n[m][g]=e[m][g])}else n[m]=e[m]}),Promise.resolve(n)})()}static findClientConfig(e){var t=this;return T(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var r={"m.homeserver":{state:ye.FAIL_ERROR,error:ye.ERROR_INVALID,base_url:null},"m.identity_server":{state:ye.PROMPT,error:null,base_url:null}},n=e.includes("://")?e:"https://".concat(e),a=yield t.fetchWellKnownObject("".concat(n,"/.well-known/matrix/client"));return!a||a.action!==St.SUCCESS?(E.error("No response or error when parsing .well-known"),a.reason&&E.error(a.reason),a.action===St.IGNORE?r["m.homeserver"]={state:ye.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=ye.FAIL_PROMPT,r["m.homeserver"].error=ye.ERROR_INVALID),Promise.resolve(r)):ye.fromDiscoveryConfig(a.raw)})()}static getRawClientConfig(e){var t=this;return T(function*(){var r;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return n?(r=n.raw)!==null&&r!==void 0?r:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,r;try{r=new URL(e)}catch(o){E.error("Could not parse url",o)}if(!((t=r)!==null&&t!==void 0&&t.hostname)||r.protocol!=="http:"&&r.protocol!=="https:")return!1;var n=r.port?":".concat(r.port):"",a=r.pathname?r.pathname:"",s="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(a);return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(o){return E.error(o),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){ye.fetchFn=e}static fetchWellKnownObject(e){return T(function*(){var t;try{if(t=yield ye.fetch(e,{method:q.Get,signal:Bi(5e3)}),t.status===404)return{raw:{},action:St.IGNORE,reason:ye.ERROR_MISSING_WELLKNOWN};if(t.status!==200)return{raw:{},action:St.FAIL_PROMPT,reason:"General failure"}}catch(s){var r=s,n="";return typeof r=="object"&&(n=r?.message),{error:r,raw:{},action:St.FAIL_PROMPT,reason:n||"General failure"}}try{return{raw:yield t.json(),action:St.SUCCESS}}catch(s){var a=s;return{error:a,raw:{},action:St.FAIL_PROMPT,reason:a?.name==="SyntaxError"?ye.ERROR_INVALID_JSON:ye.ERROR_INVALID}}})()}}c(ye,"ERROR_INVALID",Tt.Invalid);c(ye,"ERROR_GENERIC_FAILURE",Tt.GenericFailure);c(ye,"ERROR_INVALID_HS_BASE_URL",Tt.InvalidHsBaseUrl);c(ye,"ERROR_INVALID_HOMESERVER",Tt.InvalidHomeserver);c(ye,"ERROR_INVALID_IS_BASE_URL",Tt.InvalidIsBaseUrl);c(ye,"ERROR_INVALID_IDENTITY_SERVER",Tt.InvalidIdentityServer);c(ye,"ERROR_INVALID_IS",Tt.InvalidIs);c(ye,"ERROR_MISSING_WELLKNOWN",Tt.MissingWellknown);c(ye,"ERROR_INVALID_JSON",Tt.InvalidJson);c(ye,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",Tt.UnsupportedHomeserverSpecVersion);c(ye,"ALL_ERRORS",Object.keys(Tt));c(ye,"FAIL_ERROR",St.FAIL_ERROR);c(ye,"FAIL_PROMPT",St.FAIL_PROMPT);c(ye,"PROMPT",St.PROMPT);c(ye,"SUCCESS",St.SUCCESS);c(ye,"fetchFn",void 0);var Da=function(i){return i.IS="SERVICE_TYPE_IS",i.IM="SERVICE_TYPE_IM",i}({});class cp{constructor(e){this.ourEvent=e,c(this,"timeline",void 0),c(this,"ourEventIndex",0),c(this,"paginateTokens",{[be.Backward]:null,[be.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?be.Backward:be.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?be.Backward:be.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class Vi{static fromJson(e,t){var r=e.context||{},n=(r.events_before||[]).map(t),a=(r.events_after||[]).map(t),s=new cp(t(e.result)),o=s.ourEvent.threadRootId;return n=n.filter(l=>l.threadRootId===o),a=a.filter(l=>l.threadRootId===o),s.setPaginateToken(r.start,!0),s.addEvents(n,!0),s.addEvents(a,!1),s.setPaginateToken(r.end,!1),new Vi(e.rank,s)}constructor(e,t){this.rank=e,this.context=t}}var Gc=function(i){return i.Public="public",i.Private="private",i}({}),Za=function(i){return i.PrivateChat="private_chat",i.TrustedPrivateChat="trusted_private_chat",i.PublicChat="public_chat",i}({}),Ho=function(i){return i.Public="public",i.Invite="invite",i.Private="private",i.Knock="knock",i.Restricted="restricted",i}({}),$c=function(i){return i.RoomMembership="m.room_membership",i}({}),Ai=function(i){return i.CanJoin="can_join",i.Forbidden="forbidden",i}({}),es=function(i){return i.Invited="invited",i.Joined="joined",i.Shared="shared",i.WorldReadable="world_readable",i}({});function Kd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Vd(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Kd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Kd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function hp(i,e){var t=!!e.preventReEmit,r=e.decrypt!==!1;function n(a){var s=i.getRoom(a.room_id),o;s&&a.state_key===void 0&&(o=s.findEventById(a.event_id)),!o||o.status?o=new ct(a):(o.setUnsigned(Vd(Vd({},o.getUnsigned()),a.unsigned)),t=!0);var l=o.getServerAggregatedRelation(Ke.Replace);if(l!=null&&l.content){var d=n(l);o.makeReplaced(d)}var u=s?.findThreadForEvent(o);return u&&o.setThread(u),o.isEncrypted()&&(t||i.reEmitter.reEmit(o,[Pe.Decrypted]),r&&i.decryptEventIfNeeded(o)),t||(i.reEmitter.reEmit(o,[Pe.Replaced,Pe.VisibilityChange]),s?.reEmitter.reEmit(o,[Pe.BeforeRedaction])),o}return n}function Gd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function vr(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Gd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Gd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class $d{constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return T(function*(){yield e.client.sendStateEvent(e.roomId,zt.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return T(function*(){yield t.client.sendStateEvent(t.roomId,zt.name,vr(vr({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return T(function*(){yield t.client.sendStateEvent(t.roomId,zt.name,vr(vr({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return T(function*(){var t=yield e.getFileEvent(),r=t.getOriginalContent().file,n=e.client.mxcUrlToHttp(r.url);if(!n)throw new Error("No HTTP URL available for ".concat(r.url));return{info:r,httpUrl:n}})()}getFileEvent(){var e=this;return T(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var r=t.getUnfilteredTimelineSet().findEventById(e.id);!r&&t.getLiveTimeline().getState(Z.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),r=t.getUnfilteredTimelineSet().findEventById(e.id);if(!r)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(r),r})()}createNewVersion(e,t,r,n){var a=this;return T(function*(){var s=yield a.directory.createFile(e,t,r,vr(vr({},n??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:Ke.Replace,event_id:a.id}}));return yield a.client.sendStateEvent(a.roomId,zt.name,{active:!0,name:e,version:a.version+1},s.event_id),yield a.client.sendStateEvent(a.roomId,zt.name,vr(vr({},a.indexEvent.getContent()),{},{active:!1}),a.id),s})()}getVersionHistory(){var e=this;return T(function*(){var t=[];t.push(e);var r=e.client.getRoom(e.roomId);if(!r)throw new Error("Invalid or unknown room");var n=[...r.getLiveTimeline().getEvents()].reverse(),a,s=yield e.getFileEvent();do if(a=n.find(l=>l.replacingEventId()===s.getId()),a){var o=e.directory.getFile(a.getId());if(o)t.push(o),s=a;else break}while(a);return t})()}}function Hd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function kr(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Hd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Hd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var vp={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[x.RoomPowerLevels]:100,[x.RoomHistoryVisibility]:100,[x.RoomTombstone]:100,[x.RoomEncryption]:100,[x.RoomName]:50,[x.RoomMessage]:50,[x.RoomMessageEncrypted]:50,[x.Sticker]:50},users:{}},dn=function(i){return i.Viewer="viewer",i.Editor="editor",i.Owner="owner",i}({});class Jd{constructor(e,t){if(this.client=e,this.roomId=t,c(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(x.SpaceParent);return e!=null&&e.length?e.every(t=>{var r;return!((r=t.getContent())!==null&&r!==void 0&&r.via)}):!0}setName(e){var t=this;return T(function*(){yield t.client.sendStateEvent(t.roomId,x.RoomName,{name:e},"")})()}invite(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!0,a=[r.retryInvite(e)];n&&a.push(...r.getDirectories().map(s=>s.invite(e,n))),yield Promise.all(a)})()}retryInvite(e){var t=this;return cv(T(function*(){yield t.client.invite(t.roomId,e).catch(r=>{throw r?.errcode==="M_FORBIDDEN"?new Ju.AbortError(r):r})}))}setPermissions(e,t){var r=this;return T(function*(){var n,a=r.room.currentState.getStateEvents(x.RoomPowerLevels,"");if(Array.isArray(a))throw new Error("Unexpected return type for power levels");var s=a?.getContent()||{},o=s.users_default||0,l=s.events_default||50,d=((n=s.events)===null||n===void 0?void 0:n[x.RoomPowerLevels])||100,u=s.users||{};switch(t){case dn.Viewer:u[e]=o;break;case dn.Editor:u[e]=l;break;case dn.Owner:u[e]=d;break;default:throw new Error("Invalid role: "+t)}s.users=u,yield r.client.sendStateEvent(r.roomId,x.RoomPowerLevels,s,"")})()}getPermissions(e){var t,r,n=this.room.currentState.getStateEvents(x.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");var a=n?.getContent()||{},s=a.users_default||0,o=a.events_default||50,l=((t=a.events)===null||t===void 0?void 0:t[x.RoomPowerLevels])||100,d=((r=a.users)===null||r===void 0?void 0:r[e])||s;return d>=l?dn.Owner:d>=o?dn.Editor:dn.Viewer}createDirectory(e){var t=this;return T(function*(){var r=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,x.SpaceChild,{via:[t.client.getDomain()]},r.roomId),yield t.client.sendStateEvent(r.roomId,x.SpaceParent,{via:[t.client.getDomain()]},t.roomId),r})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(x.SpaceChild);for(var r of t)try{var n=r.getStateKey();if(n){var a=this.client.unstableGetFileTreeSpace(n);a&&e.push(a)}}catch(s){E.warn("Unable to create tree space instance for listing. Are we joined?",s)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return T(function*(){var t=e.getDirectories();for(var r of t)yield r.delete();var n=[Ee.Invite,Ee.Knock,Ee.Join],a=e.room.currentState.getStateEvents(x.RoomMember);for(var s of a){var o=s.getStateKey()!==e.client.getUserId();if(o&&n.includes(s.getContent().membership)){var l=s.getStateKey();if(!l)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,l,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(r=>({roomId:r.getStateKey(),order:r.getContent().order})).filter(r=>r.roomId);return t.sort((r,n)=>{if(r.order&&!n.order)return-1;if(!r.order&&n.order)return 1;if(!r.order&&!n.order){var a,s,o,l,d=this.client.getRoom(r.roomId),u=this.client.getRoom(n.roomId);if(!d||!u)return ha(r.roomId,n.roomId);var h=(a=(s=d.currentState.getStateEvents(x.RoomCreate,""))===null||s===void 0?void 0:s.getTs())!==null&&a!==void 0?a:0,v=(o=(l=u.currentState.getStateEvents(x.RoomCreate,""))===null||l===void 0?void 0:l.getTs())!==null&&o!==void 0?o:0;return h===v?ha(r.roomId,n.roomId):h-v}else return ha(r.order,n.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(x.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var r=t.getStateKey();if(!r)throw new Error("No state key found for parent");var n=this.client.getRoom(r);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(x.SpaceChild),r=this.getOrderedChildren(t);return r.findIndex(n=>n.roomId===this.roomId)}setOrder(e){var t=this;return T(function*(){var r;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var n=t.getParentRoom(),a=n.currentState.getStateEvents(x.SpaceChild),s=t.getOrderedChildren(a);e=Math.max(Math.min(e,s.length-1),0);var o=t.getOrder(),l=o<e;l&&e===s.length-1?e--:!l&&e===0&&e++;var d=s[l?e:e-1],u=s[l?e+1:e],h=Rr[0],v=!1;if(!d)u!=null&&u.order&&(h=Nl(u.order));else if(e===s.length-1)u!=null&&u.order&&(h=Wn(u.order));else{var m=d?.order,f=u?.order;m&&f?m===f?h=Wn(m):h=hv(m,f):m?h=Wn(m):f?h=Nl(f):v=!0}if(v){for(var g,w=0;w<=e;w++){var S=s[w];if(w===0&&(g=S.order),S.order)g=S.order;else{var R;g=g?Wn(g):Rr[0];var C=n.currentState.getStateEvents(x.SpaceChild,S.roomId),b=(R=C?.getContent())!==null&&R!==void 0?R:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,x.SpaceChild,kr(kr({},b),{},{order:g}),S.roomId)}}g&&(h=Wn(g))}var _=n.currentState.getStateEvents(x.SpaceChild,t.roomId),p=(r=_?.getContent())!==null&&r!==void 0?r:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,x.SpaceChild,kr(kr({},p),{},{order:h}),t.roomId)})()}createFile(e,t,r,n){var a=this;return T(function*(){var{content_uri:s}=yield a.client.uploadContent(t,{includeFilename:!1});r.url=s;var o={msgtype:Bt.File,body:e,url:s,file:r};n=n??{},n["m.new_content"]&&(n["m.new_content"]=o);var l=yield a.client.sendMessage(a.roomId,kr(kr(kr({},n),o),{},{[So.name]:{}}));return yield a.client.sendStateEvent(a.roomId,zt.name,{active:!0,name:e},l.event_id),l})()}getFile(e){var t=this.room.currentState.getStateEvents(zt.name,e);return t?new $d(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(zt.name))!==null&&e!==void 0?e:[];return t.map(r=>new $d(this.client,r,this))}}var Jo=function(i){return i.Recent="recent",i.Rank="rank",i}({}),gr=function(i){return i.LocalStreamsChanged="local_streams_changed",i}({});class fp extends xe{constructor(e){super(),this.client=e,c(this,"audioInput",void 0),c(this,"audioSettings",void 0),c(this,"videoInput",void 0),c(this,"localUserMediaStream",void 0),c(this,"userMediaStreams",[]),c(this,"screensharingStreams",[]),c(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return T(function*(){E.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return T(function*(){E.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return T(function*(){E.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var r=this;return T(function*(){E.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),r.audioInput=e,r.videoInput=t,yield r.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return T(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var r of e.client.callEventHandler.calls.values())t.set(r.callId,{audio:r.hasLocalUserMediaAudioTrack,video:r.hasLocalUserMediaVideoTrack});for(var n of e.userMediaStreams){E.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(n.id,")"));for(var a of n.getTracks())a.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var s of e.client.callEventHandler.calls.values())if(!(s.callHasEnded()||!t.has(s.callId))){var{audio:o,video:l}=t.get(s.callId);E.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(s.callId,")"));var d=yield e.getUserMediaStream(o,l);s.callHasEnded()||(yield s.updateLocalUsermediaStream(d))}for(var u of e.client.groupCallEventHandler.groupCalls.values())if(u.localCallFeed){E.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(u.groupCallId,")"));var h=yield e.getUserMediaStream(!0,u.type===Ki.Video);u.state!==qe.Ended&&(yield u.updateLocalUsermediaStream(h))}e.emit(gr.LocalStreamsChanged)}})()}hasAudioDevice(){return T(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return E.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return T(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return E.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var r=arguments,n=this;return T(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:!0;return n.getMediaStreamPromise?n.getMediaStreamPromise=n.getMediaStreamPromise.then(()=>n.getUserMediaStreamInternal(e,t,a)):n.getMediaStreamPromise=n.getUserMediaStreamInternal(e,t,a),n.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,r){var n=this;return T(function*(){var a=e&&(yield n.hasAudioDevice()),s=t&&(yield n.hasVideoDevice()),o,l=!0;if(n.localUserMediaStream){var d,u;a!==n.localUserMediaStream.getAudioTracks().length>0&&(l=!1),s!==n.localUserMediaStream.getVideoTracks().length>0&&(l=!1),a&&((d=n.localUserMediaStream.getAudioTracks()[0])===null||d===void 0||(d=d.getSettings())===null||d===void 0?void 0:d.deviceId)!==n.audioInput&&(l=!1),s&&((u=n.localUserMediaStream.getVideoTracks()[0])===null||u===void 0||(u=u.getSettings())===null||u===void 0?void 0:u.deviceId)!==n.videoInput&&(l=!1)}else l=!1;if(l){var f;if(o=n.localUserMediaStream.clone(),E.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((f=n.localUserMediaStream)===null||f===void 0?void 0:f.id," newStreamId=").concat(o.id," shouldRequestAudio=").concat(a," shouldRequestVideo=").concat(s,")")),!a)for(var g of o.getAudioTracks())o.removeTrack(g);if(!s)for(var w of o.getVideoTracks())o.removeTrack(w)}else{var h=n.getUserMediaContraints(a,s);o=yield navigator.mediaDevices.getUserMedia(h),E.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(o.id,", shouldRequestAudio=").concat(a,", shouldRequestVideo=").concat(s,", constraints=").concat(JSON.stringify(h),")"));for(var v of o.getTracks()){var m=v.getSettings();v.kind==="audio"?n.audioInput=m.deviceId:v.kind==="video"&&(n.videoInput=m.deviceId)}r&&(n.localUserMediaStream=o)}return r&&n.userMediaStreams.push(o),n.emit(gr.LocalStreamsChanged),o})()}stopUserMediaStream(e){E.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.userMediaStreams.indexOf(e);if(r!==-1&&(E.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(r,1)),this.emit(gr.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var n of e.getTracks()){var a;if((a=this.localUserMediaStream)!==null&&a!==void 0&&a.getTrackById(n.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return T(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:{},n=e.length>1&&e[1]!==void 0?e[1]:!0,a;if(t.screensharingStreams.length===0){var s=t.getScreenshareContraints(r);r.desktopCapturerSourceId?(E.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(r),")")),a=yield navigator.mediaDevices.getUserMedia(s)):(E.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(r),")")),a=yield navigator.mediaDevices.getDisplayMedia(s))}else{var o=t.screensharingStreams[t.screensharingStreams.length-1];E.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(o.id,")")),a=o.clone()}return n&&t.screensharingStreams.push(a),t.emit(gr.LocalStreamsChanged),a})()}stopScreensharingStream(e){E.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.screensharingStreams.indexOf(e);r!==-1&&(E.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(r,1)),this.emit(gr.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){E.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var r of this.screensharingStreams)for(var n of r.getTracks())n.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(gr.LocalStreamsChanged)}getUserMediaContraints(e,t){var r=!!navigator.webkitGetUserMedia;return{audio:e?{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0}:!1,video:t?{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:r??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:r??!1,video:!0}}}var zd=function(i){return i.RequestFinished="FINISHED",i.Complete="COMPLETE",i}({}),Gi=function(i){return i.PreProcess="ExtState.PreProcess",i.PostProcess="ExtState.PostProcess",i}({}),La=function(i){return i.RoomData="SlidingSync.RoomData",i.Lifecycle="SlidingSync.Lifecycle",i}({}),pp=3;class mp{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return Gi.PreProcess}onRequest(e){var t=this;return T(function*(){return e&&(E.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return T(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class gp{constructor(e,t){this.client=e,this.cryptoCallbacks=t,c(this,"nextBatch",null)}name(){return"to_device"}when(){return Gi.PreProcess}onRequest(e){var t=this;return T(function*(){return{since:t.nextBatch!==null?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return T(function*(){var r=e.events||[];r.length>0&&t.cryptoCallbacks&&(r=yield t.cryptoCallbacks.preprocessToDeviceMessages(r)),Fc(r,t.client),t.nextBatch=e.next_batch})()}}class yp{constructor(e){this.client=e}name(){return"account_data"}when(){return Gi.PostProcess}onRequest(e){return T(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return T(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var r in e.rooms){var n=gn(t.client,r,e.rooms[r]),a=t.client.getRoom(r);if(!a){E.warn("got account data for room but room doesn't exist on client:",r);continue}a.addAccountData(n),n.forEach(s=>{t.client.emit(ae.Event,s)})}})()}processGlobalAccountData(e){var t=gn(this.client,void 0,e),r=t.reduce((n,a)=>(n[a.getType()]=this.client.store.getAccountData(a.getType()),n),{});this.client.store.storeAccountDataEvents(t),t.forEach(n=>{if(n.getType()===x.PushRules){var a=n.getContent();this.client.setPushRules(a)}var s=r[n.getType()];return this.client.emit(ae.AccountData,n,s),n})}}class Sp{constructor(e){this.client=e}name(){return"typing"}when(){return Gi.PostProcess}onRequest(e){return T(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return T(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)Jc(t.client,r,[e.rooms[r]])})()}}class Ep{constructor(e){this.client=e}name(){return"receipts"}when(){return Gi.PostProcess}onRequest(e){return T(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return T(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)Jc(t.client,r,[e.rooms[r]])})()}}class Hc{constructor(e,t,r,n){this.slidingSync=e,this.client=t,c(this,"opts",void 0),c(this,"syncOpts",void 0),c(this,"syncState",null),c(this,"syncStateData",void 0),c(this,"lastPos",null),c(this,"failCount",0),c(this,"notifEvents",[]),this.opts=Lc(r),this.syncOpts=Uc(n),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[ie.Timeline,ie.TimelineReset]),this.slidingSync.on(La.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(La.RoomData,this.onRoomData.bind(this));var a=[new gp(this.client,this.syncOpts.cryptoCallbacks),new yp(this.client),new Sp(this.client),new Ep(this.client)];this.syncOpts.cryptoCallbacks&&a.push(new mp(this.syncOpts.cryptoCallbacks)),a.forEach(s=>{this.slidingSync.registerExtension(s)})}onRoomData(e,t){var r=this;return T(function*(){var n=r.client.store.getRoom(e);if(!n){if(!t.initial){E.debug("initial flag not set but no stored room exists for room ",e,t);return}n=Nc(r.client,e,r.opts)}yield r.processRoomData(r.client,n,t)})()}onLifecycle(e,t,r){switch(r&&E.debug("onLifecycle",e,r),e){case zd.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(ke.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(ke.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case zd.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>pp?ke.Error:ke.Reconnecting,{error:new je(r)}),this.shouldAbortSync(new je(r)))return}else this.failCount=0,E.log("SlidingSyncState.RequestFinished with ".concat(Object.keys(t?.rooms||[]).length," rooms"));break}}syncLeftRooms(){return T(function*(){return[]})()}peek(e){return T(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,r=new Wi(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[ie.Name,ie.Redaction,ie.RedactionCancelled,ie.Receipt,ie.Tags,ie.LocalEchoUpdated,ie.AccountData,ie.MyMembership,ie.Timeline,ie.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[Re.Events,Re.Members,Re.NewMember,Re.Update]),e.currentState.on(Re.NewMember,(t,r,n)=>{var a;n.user=(a=this.client.getUser(n.userId))!==null&&a!==void 0?a:void 0,this.client.reEmitter.reEmit(n,[mt.Name,mt.Typing,mt.PowerLevel,mt.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(E.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(ke.Error,{error:e}),!0):!1}processRoomData(e,t,r){var n=this;return T(function*(){r=bp(e,t.roomId,r);var a=gn(n.client,t.roomId,r.required_state),s=gn(n.client,t.roomId,r.timeline,!1),o=[];if(r.limited||r.initial){var l=new Set;t.getLiveTimeline().getEvents().forEach(R=>{l.add(R.getId())});for(var d=[],u=[],h=!1,v=s.length-1;v>=0;v--){var m=s[v];if(l.has(m.getId())){h=!0;continue}h?d.push(m):u.unshift(m)}s=u,d.length>0&&t.addEventsToTimeline(d,!0,!1,t.getLiveTimeline(),r.prev_batch)}var f=t.hasEncryptionStateEvent();if(r.notification_count!=null&&t.setUnreadNotificationCount(Me.Total,r.notification_count),r.highlight_count!=null&&(!f||f&&t.getUnreadNotificationCount(Me.Highlight)<=0)&&t.setUnreadNotificationCount(Me.Highlight,r.highlight_count),r.bump_stamp&&t.setBumpStamp(r.bump_stamp),Number.isInteger(r.invited_count)&&t.currentState.setInvitedMemberCount(r.invited_count),Number.isInteger(r.joined_count)&&t.currentState.setJoinedMemberCount(r.joined_count),r.invite_state){var g=gn(n.client,t.roomId,r.invite_state);yield n.injectRoomEvents(t,g),r.initial&&(t.recalculate(),n.client.store.storeRoom(t),n.client.emit(ae.Room,t)),g.forEach(R=>{n.client.emit(ae.Event,R)});return}if(r.limited){var w;t.getLiveTimeline().setPaginationToken((w=r.prev_batch)!==null&&w!==void 0?w:null,Z.BACKWARDS)}yield n.injectRoomEvents(t,a,s,r.num_live),t.addEphemeralEvents(o),t.updateMyMembership(Ee.Join),t.setMSC4186SummaryData(r.heroes,r.joined_count,r.invited_count),t.recalculate(),r.initial&&(e.store.storeRoom(t),e.emit(ae.Room,t)),n.addNotifications(s);var S=function(){var R=T(function*(C){e.emit(ae.Event,C),C.isState()&&C.getType()==x.RoomEncryption&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(t,C))});return function(b){return R.apply(this,arguments)}}();yield fn(a,S),yield fn(s,S),o.forEach(function(R){e.emit(ae.Event,R)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var r=arguments,n=this;return T(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:[],s=r.length>3&&r[3]!==void 0?r[3]:0,o=e.getLiveTimeline(),l=o.getEvents().length==0;if(l){for(var d of t)n.client.getPushActionsForEvent(d);o.initialiseState(t)}l||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var u=[];s>0&&(u=a.slice(-1*s),a=a.slice(0,-1*u.length)),yield e.addLiveEvents(a,{fromCache:!0,addToState:!1}),u.length>0&&(yield e.addLiveEvents(u,{fromCache:!1,addToState:!1})),e.recalculate(),n.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Ee.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),a;n?a=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):a=t.getProfileInfo(r.userId),a.then(function(s){var o=r.events.member;o.getContent().membership===Ee.Invite&&(o.getContent().avatar_url=s.avatar_url,o.getContent().displayname=s.displayname,r.setMembershipEvent(o,e.currentState))},function(s){})}})}}retryImmediately(){return!0}sync(){var e=this;return T(function*(){for(E.debug("Sliding sync init loop");!e.client.isGuest();)try{E.debug("Getting push rules...");var t=yield e.client.getPushRules();E.debug("Got push rules"),e.client.pushRules=t;break}catch(r){if(E.error("Getting push rules failed",r),e.shouldAbortSync(r))return}yield e.slidingSync.start()})()}stop(){E.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ae.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var r=this.client.getPushActionsForEvent(t);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}}function bp(i,e,t){if(!t.name)return t;for(var r of t.required_state)if(r.type===x.RoomName&&r.state_key==="")return r.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:x.RoomName,content:{name:t.name},sender:i.getUserId(),origin_server_ts:new Date().getTime()}),t}function gn(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,n=i.getEventMapper({decrypt:r});return t.map(function(a){return a.room_id=e,n(a)})}function Jc(i,e,t){var r=gn(i,e,t),n=i.getRoom(e);if(!n){E.warn("got ephemeral events for room but room doesn't exist on client:",e);return}n.addEphemeralEvents(r),r.forEach(a=>{i.emit(ae.Event,a)})}var ts=new Ye("m.beacon_info","org.matrix.msc3672.beacon_info"),Ua=new Ye("m.beacon","org.matrix.msc3672.beacon");class Yr{static RETRY_BACKOFF_RATELIMIT(e,t,r){return Uo(r,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===x.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Yr.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Yr.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,c(this,"queues",{}),c(this,"activeQueues",[]),c(this,"procFn",null),c(this,"processQueue",r=>{var n=this.peekNextEvent(r);if(!n){this.disableQueue(r);return}this.queues[r].length,Promise.resolve().then(()=>this.procFn(n.event)).then(a=>{this.removeNextEvent(r),n.event.getId(),n.resolvers.resolve(a),this.processQueue(r)},a=>{n.attempts+=1;var s=this.retryAlgorithm(n.event,n.attempts,a);n.attempts,n.event.getId(),s===-1?(E.info("Queue '%s' giving up on event %s",r,n.event.getId()),this.clearQueue(r,a)):setTimeout(this.processQueue,s,r)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(r){return r.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var r=!1;return Ea(this.queues[t],n=>n.event.getId()===e.getId()?(r=!0,!0):!1),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var r=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:r,attempts:0}),e.getId(),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),E.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){E.info("clearing queue '%s'",e);for(var r;r=this.removeNextEvent(e);)r.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}var Yd=20;class _p{constructor(e){var t=this;this.client=e,c(this,"sending",!1),c(this,"running",!0),c(this,"retryTimeout",null),c(this,"retryAttempts",0),c(this,"sendQueue",T(function*(){if(t.retryTimeout!==null&&clearTimeout(t.retryTimeout),t.retryTimeout=null,!(t.sending||!t.running)){E.debug("Attempting to send queued to-device messages"),t.sending=!0;var r;try{for(;t.running&&(r=yield t.client.store.getOldestToDeviceBatch(),r!==null);)yield t.sendBatch(r),yield t.client.store.removeToDeviceBatch(r.id),t.retryAttempts=0;if(!t.running)return;E.debug("All queued to-device messages sent")}catch(a){++t.retryAttempts;var n=Yr.RETRY_BACKOFF_RATELIMIT(null,t.retryAttempts,a);if(n===-1){Math.floor(a.httpStatus/100)===4?(E.error("Fatal error when sending to-device message - dropping to-device batch!",a),yield t.client.store.removeToDeviceBatch(r.id)):E.info("Automatic retry limit reached for to-device messages.");return}E.info("Failed to send batch of to-device messages. Will retry in ".concat(n,"ms"),a),t.retryTimeout=setTimeout(t.sendQueue,n)}finally{t.sending=!1}}})),c(this,"onResumedSync",(r,n)=>{r===ke.Syncing&&n!==ke.Syncing&&(E.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(ae.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ae.Sync,this.onResumedSync)}queueBatch(e){var t=this;return T(function*(){for(var r=[],n=0;n<e.batch.length;n+=Yd){var a={eventType:e.eventType,batch:e.batch.slice(n,n+Yd),txnId:t.client.makeTxnId()};r.push(a);var s=a.batch.map(o=>"".concat(o.userId,"/").concat(o.deviceId," (msgid ").concat(o.payload[xi],")"));E.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(a.txnId),s)}yield t.client.store.saveToDeviceBatches(r),t.sendQueue()})()}sendBatch(e){var t=this;return T(function*(){var r=new or(()=>new Map);for(var n of e.batch)r.getOrCreate(n.userId).set(n.deviceId,n.payload);E.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,r,e.txnId)})()}}var Ts=new Et.UnstableValue("m.policies","org.matrix.msc3847.policies"),aa=new Et.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),Xd=function(i){return i.Ban="m.ban",i}({}),yn=function(i){return i.User="m.policy.user",i.Room="m.policy.room",i.Server="m.policy.server",i}({}),Qd={[yn.User]:x.PolicyRuleUser,[yn.Room]:x.PolicyRuleRoom,[yn.Server]:x.PolicyRuleServer};class wp{constructor(e){this.client=e}addRule(e,t,r){var n=this;return T(function*(){var a=yield n.getOrCreateTargetRoom(),s=yield n.client.sendStateEvent(a.roomId,Qd[e],{entity:t,reason:r,recommendation:Xd.Ban});return s.event_id})()}removeRule(e){var t=this;return T(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return T(function*(){yield t.client.joinRoom(e);var r=(yield t.getOrCreateSourceRooms()).map(n=>n.roomId);return r.includes(e)?!1:(r.push(e),yield t.withIgnoreInvitesPolicies(n=>{n.sources=r}),!0)})()}getRuleForInvite(e){var t=this;return T(function*(){var{sender:r,roomId:n}=e,a=yield t.getOrCreateSourceRooms(),s=r.split(":")[1],o=n.split(":")[1];for(var l of a){var d=l.getUnfilteredTimelineSet().getLiveTimeline().getState(Z.FORWARDS);for(var{scope:u,entities:h}of[{scope:yn.Room,entities:[n]},{scope:yn.User,entities:[r]},{scope:yn.Server,entities:[s,o]}]){var v=d.getStateEvents(Qd[u]);for(var m of v){var f=m.getContent();if(f?.recommendation==Xd.Ban){var g=f?.entity;if(g){var w=void 0;try{w=new RegExp(Xu(g))}catch{continue}for(var S of h)if(S&&w.test(S))return m}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return T(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.target;if(typeof r!="string"&&(r=null),r){var n=e.client.getRoom(r);if(n)return n;r=null}return r=(yield e.client.createRoom({name:"Individual Policy Room",preset:Za.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(a=>{a.target=r}),e.client.getRoom(r)})()}getOrCreateSourceRooms(){var e=this;return T(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.sources,n=!1;Array.isArray(r)||(n=!0,r=[]);var a=r.filter(o=>typeof o=="string").map(o=>e.client.getRoom(o)).filter(o=>!!o);if(a.length!=r.length&&(n=!0),a.length==0){var s=yield e.getOrCreateTargetRoom();n=!0,a=[s]}return n&&(yield e.withIgnoreInvitesPolicies(o=>{o.sources=r})),a})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return T(function*(){var{policies:r,ignoreInvitesPolicies:n}=t.getPoliciesAndIgnoreInvitesPolicies();e(n),r[aa.name]=n,yield t.client.setAccountData(Ts.name,r)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[Ts.name,Ts.altName]){var r;if(t){var n=(r=this.client.getAccountData(t))===null||r===void 0?void 0:r.getContent();if(n){e=n;break}}}var a={},s=!1;for(var o of[aa.name,aa.altName])if(o){var l=e[o];if(l&&typeof l=="object"){a=l,s=!0;break}}return s||(e[aa.name]=a),{policies:e,ignoreInvitesPolicies:a}}}var Is="matrix-js-sdk";function Rp(i){if(i.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let d=0;d<e.length;d++)e[d]=255;for(let d=0;d<i.length;d++){const u=i.charAt(d),h=u.charCodeAt(0);if(e[h]!==255)throw new TypeError(u+" is ambiguous");e[h]=d}const t=i.length,r=i.charAt(0),n=Math.log(t)/Math.log(256),a=Math.log(256)/Math.log(t);function s(d){if(d instanceof Uint8Array||(ArrayBuffer.isView(d)?d=new Uint8Array(d.buffer,d.byteOffset,d.byteLength):Array.isArray(d)&&(d=Uint8Array.from(d))),!(d instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(d.length===0)return"";let u=0,h=0,v=0;const m=d.length;for(;v!==m&&d[v]===0;)v++,u++;const f=(m-v)*a+1>>>0,g=new Uint8Array(f);for(;v!==m;){let R=d[v],C=0;for(let b=f-1;(R!==0||C<h)&&b!==-1;b--,C++)R+=256*g[b]>>>0,g[b]=R%t>>>0,R=R/t>>>0;if(R!==0)throw new Error("Non-zero carry");h=C,v++}let w=f-h;for(;w!==f&&g[w]===0;)w++;let S=r.repeat(u);for(;w<f;++w)S+=i.charAt(g[w]);return S}function o(d){if(typeof d!="string")throw new TypeError("Expected String");if(d.length===0)return new Uint8Array;let u=0,h=0,v=0;for(;d[u]===r;)h++,u++;const m=(d.length-u)*n+1>>>0,f=new Uint8Array(m);for(;u<d.length;){const R=d.charCodeAt(u);if(R>255)return;let C=e[R];if(C===255)return;let b=0;for(let _=m-1;(C!==0||b<v)&&_!==-1;_--,b++)C+=t*f[_]>>>0,f[_]=C%256>>>0,C=C/256>>>0;if(C!==0)throw new Error("Non-zero carry");v=b,u++}let g=m-v;for(;g!==m&&f[g]===0;)g++;const w=new Uint8Array(h+(m-g));let S=h;for(;g!==m;)w[S++]=f[g++];return w}function l(d){const u=o(d);if(u)return u;throw new Error("Non-base"+t+" character")}return{encode:s,decodeUnsafe:o,decode:l}}var Tp="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const Vm=Rp(Tp);var ot=function(i){return i.UserTrustStatusChanged="userTrustStatusChanged",i.KeyBackupStatus="crypto.keyBackupStatus",i.KeyBackupFailed="crypto.keyBackupFailed",i.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",i.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",i.VerificationRequestReceived="crypto.verificationRequestReceived",i.WillUpdateDevices="crypto.willUpdateDevices",i.DevicesUpdated="crypto.devicesUpdated",i.KeysChanged="crossSigning.keysChanged",i.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",i.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",i.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",i.RehydrationStarted="dehydration.RehydrationStarted",i.RehydrationProgress="dehydration.RehydrationProgress",i.RehydrationCompleted="dehydration.RehydrationCompleted",i.RehydrationError="dehydration.RehydrationError",i.DehydrationKeyCached="dehydration.DehydrationKeyCached",i.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",i}({}),Zd=function(i){return i.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",i.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",i.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",i.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",i.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",i.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",i.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",i.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",i.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",i.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",i.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",i.UNKNOWN_ERROR="UNKNOWN_ERROR",i.MEGOLM_BAD_ROOM="MEGOLM_BAD_ROOM",i.MEGOLM_MISSING_FIELDS="MEGOLM_MISSING_FIELDS",i.OLM_DECRYPT_GROUP_MESSAGE_ERROR="OLM_DECRYPT_GROUP_MESSAGE_ERROR",i.OLM_BAD_ENCRYPTED_MESSAGE="OLM_BAD_ENCRYPTED_MESSAGE",i.OLM_BAD_RECIPIENT="OLM_BAD_RECIPIENT",i.OLM_BAD_RECIPIENT_KEY="OLM_BAD_RECIPIENT_KEY",i.OLM_BAD_ROOM="OLM_BAD_ROOM",i.OLM_BAD_SENDER_CHECK_FAILED="OLM_BAD_SENDER_CHECK_FAILED",i.OLM_BAD_SENDER="OLM_BAD_SENDER",i.OLM_FORWARDED_MESSAGE="OLM_FORWARDED_MESSAGE",i.OLM_MISSING_CIPHERTEXT="OLM_MISSING_CIPHERTEXT",i.OLM_NOT_INCLUDED_IN_RECIPIENTS="OLM_NOT_INCLUDED_IN_RECIPIENTS",i.UNKNOWN_ENCRYPTION_ALGORITHM="UNKNOWN_ENCRYPTION_ALGORITHM",i}({}),Ip=function(i){return i[i.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",i[i.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",i}({});class Gm{constructor(e){this.errorOnVerifiedUserProblems=e,c(this,"kind",Ip.AllDevicesIsolationMode)}}class $m{constructor(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r,c(this,"needsUserApproval",void 0),this.needsUserApproval=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class Hm{constructor(e){var t,r,n,a,s;c(this,"signedByOwner",void 0),c(this,"crossSigningVerified",void 0),c(this,"tofu",void 0),c(this,"localVerified",void 0),c(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(r=e.crossSigningVerified)!==null&&r!==void 0?r:!1,this.tofu=(n=e.tofu)!==null&&n!==void 0?n:!1,this.localVerified=(a=e.localVerified)!==null&&a!==void 0?a:!1,this.trustCrossSignedDevices=(s=e.trustCrossSignedDevices)!==null&&s!==void 0?s:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var Jm=function(i){return i.Fetch="fetch",i.LoadKeys="load_keys",i}({}),zm=function(i){return i.Master="master",i.SelfSigning="self_signing",i.UserSigning="user_signing",i}({}),Ym=function(i){return i[i.NONE=0]="NONE",i[i.GREY=1]="GREY",i[i.RED=2]="RED",i}({}),Xm=function(i){return i[i.UNKNOWN=0]="UNKNOWN",i[i.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",i[i.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",i[i.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",i[i.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",i[i.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",i[i.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",i[i.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",i}({}),Cp=new Uint8Array(8);function zc(i,e){return ro.apply(this,arguments)}function ro(){return ro=T(function*(i,e){var t=yield globalThis.crypto.subtle.importKey("raw",i,{name:"HKDF"},!1,["deriveBits"]),r=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:Cp,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),n=r.slice(0,32),a=r.slice(32),s=globalThis.crypto.subtle.importKey("raw",n,{name:"AES-CTR"},!1,["encrypt","decrypt"]),o=globalThis.crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([s,o])}),ro.apply(this,arguments)}function Yc(i,e,t,r){return no.apply(this,arguments)}function no(){return no=T(function*(i,e,t,r){var n;r?n=Gr(r):(n=new Uint8Array(16),globalThis.crypto.getRandomValues(n),n[8]&=127);var[a,s]=yield zc(e,t),o=new TextEncoder().encode(i),l=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:n,length:64},a,o),d=yield globalThis.crypto.subtle.sign({name:"HMAC"},s,l);return{iv:yi(n),ciphertext:yi(new Uint8Array(l)),mac:yi(new Uint8Array(d))}}),no.apply(this,arguments)}function Op(i,e,t){return io.apply(this,arguments)}function io(){return io=T(function*(i,e,t){var[r,n]=yield zc(e,t),a=Gr(i.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},n,Gr(i.mac),a)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var s=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:Gr(i.iv),length:64},r,a);return new TextDecoder().decode(new Uint8Array(s))}),io.apply(this,arguments)}var jr="m.secret_storage.v1.aes-hmac-sha2";class Xc{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return T(function*(){var t,r=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return r&&(t=r.key)!==null&&t!==void 0?t:null})()}setDefaultKeyId(e){return new Promise((t,r)=>{var n=s=>{if(s.getType()==="m.secret_storage.default_key"){var o=s.getContent(),l=e===null?Object.keys(o).length===0:o.key===e;l&&(this.accountDataAdapter.removeListener(ae.AccountData,n),t())}};this.accountDataAdapter.on(ae.AccountData,n);var a=e===null?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",a).catch(s=>{this.accountDataAdapter.removeListener(ae.AccountData,n),r(s)})})}addKey(e,t,r){var n=this;return T(function*(){if(e!==jr)throw new Error("Unknown key algorithm ".concat(e));var a={algorithm:e};t.name&&(a.name=t.name),t.passphrase&&(a.passphrase=t.passphrase);var{iv:s,mac:o}=yield so(t.key);if(a.iv=s,a.mac=o,!r)do r=_r(32);while(yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(r)));return yield n.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(r),a),{keyId:r,keyInfo:a}})()}getKey(e){var t=this;return T(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var r=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return r?[e,r]:null})()}hasKey(e){var t=this;return T(function*(){var r=yield t.getKey(e);return!!r})()}checkKey(e,t){return T(function*(){if(t.algorithm===jr)if(t.mac){var{mac:r}=yield so(e,t.iv);return ao(t.mac)===ao(r)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,r){var n=this;return T(function*(){if(t===null){yield n.accountDataAdapter.setAccountData(e,{});return}var a={};if(!r){var s=yield n.getDefaultKeyId();if(!s)throw new Error("No keys specified and no default key present");r=[s]}if(r.length===0)throw new Error("Zero keys given to encrypt with!");for(var o of r){var l=yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(o));if(!l)throw new Error("Unknown key: "+o);if(l.algorithm===jr){var d={[o]:l},[,u]=yield n.getSecretStorageKey(d,e);a[o]=yield u.encrypt(t)}else E.warn("unknown algorithm for secret storage key "+o+": "+l.algorithm)}yield n.accountDataAdapter.setAccountData(e,{encrypted:a})})()}get(e){var t=this;return T(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(r){if(!r.encrypted)throw new Error("Content is not encrypted!");var n={};for(var a of Object.keys(r.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a)),o=r.encrypted[a];s?.algorithm===jr&&o.iv&&o.ciphertext&&o.mac&&(n[a]=s)}if(Object.keys(n).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[l,d]=yield t.getSecretStorageKey(n,e),u=r.encrypted[l];return d.decrypt(u)}})()}isStored(e){var t=this;return T(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(r!=null&&r.encrypted))return null;var n={};for(var a of Object.keys(r.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a));if(s){var o=r.encrypted[a];s.algorithm===jr&&o.iv&&o.ciphertext&&o.mac&&(n[a]=s)}}return Object.keys(n).length?n:null})()}getSecretStorageKey(e,t){var r=this;return T(function*(){if(!r.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var n=yield r.callbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[a,s]=n;if(!e[a])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[a].algorithm===jr){var o={encrypt:function(d){return Yc(d,s,t)},decrypt:function(d){return Op(d,s,t)}};return[a,o]}else throw new Error("Unknown key type: "+e[a].algorithm)})()}}function ao(i){for(var e=i.length;e>=1&&i.charCodeAt(e-1)==61;)e--;return e<i.length?i.substring(0,e):i}var Mp="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function so(i,e){return Yc(Mp,i,"",e)}const Qc=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:jr,ServerSideSecretStorageImpl:Xc,calculateKeyCheck:so,trimTrailingEquals:ao},Symbol.toStringTag,{value:"Module"}));var zo=i=>i.type==="livekit"&&"focus_selection"in i,Yo=1e3*60*60*4,Pp=(i,e)=>{var t,r="Malformed session membership event: ";return typeof i.device_id!="string"&&e.push(r+"device_id must be string"),typeof i.call_id!="string"&&e.push(r+"call_id must be string"),typeof i.application!="string"&&e.push(r+"application must be a string"),typeof((t=i.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(r+"focus_active.type must be a string"),Array.isArray(i.foci_preferred)||e.push(r+"foci_preferred must be an array"),i.created_ts&&typeof i.created_ts!="number"&&e.push(r+"created_ts must be number"),i.scope&&typeof i.scope!="string"&&e.push(r+"scope must be string"),e.length===0};class eu{static equal(e,t){return En(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,c(this,"membershipData",void 0);var r=[];if(Pp(t,r))this.membershipData=t;else throw Error("unknown CallMembership data. Does not match MSC4143 call.member (".concat(r.join(" & "),") events this could be a legacy membership event: (").concat(t,")"))}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return this.createdTs().toString()}createdTs(){var e;return(e=this.membershipData.created_ts)!==null&&e!==void 0?e:this.parentEvent.getTs()}getAbsoluteExpiry(){var e;return this.createdTs()+((e=this.membershipData.expires)!==null&&e!==void 0?e:Yo)}getMsUntilExpiry(){return this.getAbsoluteExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getPreferredFoci(){return this.membershipData.foci_preferred}getFocusSelection(){var e=this.membershipData.focus_active;if(zo(e))return e.focus_selection}}var wr=function(i){return i.Cancel="cancel",i.Restart="restart",i.Send="send",i}({}),rs=function(i){return i.TooNew="TOO_NEW",i}({});class ns extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}c(ns,"TOO_NEW",rs.TooNew);class Zc extends Error{constructor(e,t){super(e),this.value=t}}class eh extends Error{constructor(){super("MatrixClient has been stopped")}}class ar extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}}var pr=function(i){return i.Disconnected="Disconnected",i.Connecting="Connecting",i.ConnectingFailed="ConnectingFailed",i.Connected="Connected",i.Reconnecting="Reconnecting",i.Disconnecting="Disconnecting",i.Stuck="Stuck",i.Unknown="Unknown",i}({}),fa=(i,e,t)=>i.sender===e&&i.deviceId===t;class kp{constructor(e,t){this.membershipLoopHandler=e,c(this,"logger",void 0),c(this,"running",!1),c(this,"wakeup",r=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),c(this,"_actions",[]),this.logger=(t??E).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return T(function*(){if(e.running){e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");return}e.running=!0,e._actions=[{ts:Date.now(),type:Se.SendDelayedEvent}];try{for(var t=function*(){e._actions.sort((d,u)=>d.ts-u.ts);var n=e._actions[0],a=void 0,s=new Promise(d=>{e.wakeup=u=>{a=u,d()}});n.ts>Date.now()&&(yield Promise.race([s,zr(n.ts-Date.now())]));var o={};if(!a){e.logger.debug("Current MembershipManager processing: ".concat(n.type,`
Queue:`),e._actions,`
Date.now: "`.concat(Date.now()));try{o=yield e.membershipLoopHandler(n.type)}catch(d){throw Error("The MembershipManager shut down because of the end condition: ".concat(d))}}e._actions.splice(0,1);var l=a??o;"replace"in l?e._actions=l.replace:"insert"in l&&e._actions.push(...l.insert)};e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Se.SendDelayedEvent}]})}initiateLeave(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:Se.SendScheduledDelayedLeaveEvent}]})}}var tu=function(i){return i.StatusChanged="StatusChanged",i}({}),Se=function(i){return i.SendDelayedEvent="SendDelayedEvent",i.SendJoinEvent="SendJoinEvent",i.RestartDelayedEvent="RestartDelayedEvent",i.UpdateExpiry="UpdateExpiry",i.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",i.SendLeaveEvent="SendLeaveEvent",i}({});class Na extends xe{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,r){if(this.scheduler.running){this.logger.error("MembershipManager is already running. Ignoring join request.");return}this.fociPreferred=e,this.focusActive=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=Na.defaultState,this.scheduler.startWithJoin().catch(n=>{this.logger.error("MembershipManager stopped because: ",n),r?.(n)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(tu.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var n;(n=this.leavePromiseResolvers)===null||n===void 0||n.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var t;return(t=this.leavePromiseResolvers)===null||t===void 0?void 0:t.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){var t=this;return T(function*(){var r=t.client.getUserId(),n=t.client.getDeviceId();if(r&&n&&t.isJoined()&&!e.some(s=>fa(s,r,n))){var a=[Se.SendDelayedEvent,Se.SendJoinEvent];t.logger.warn("Missing own membership: force re-join"),t.state.hasMemberStateEvent=!1,t.scheduler.actions.find(s=>a.includes(s.type))?t.logger.error("NewMembershipManger tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",t.scheduler.actions):t.scheduler.initiateJoin()}return Promise.resolve()})()}getActiveFocus(){if(this.focusActive)if(zo(this.focusActive)){if(this.focusActive.focus_selection==="oldest_membership"){var e=this.getOldestMembership();return e?.getPreferredFoci()[0]}}else this.logger.warn("Unknown own ActiveFocus type. This makes it impossible to connect to an SFU.");else{var t=this.getOldestMembership();return t?.getPreferredFoci()[0]}}constructor(e,t,r,n,a){super(),this.joinConfig=e,this.room=t,this.client=r,this.getOldestMembership=n,c(this,"activated",!1),c(this,"logger",void 0),c(this,"leavePromiseResolvers",void 0),c(this,"oldStatus",void 0),c(this,"scheduler",void 0),c(this,"state",void 0),c(this,"deviceId",void 0),c(this,"stateKey",void 0),c(this,"fociPreferred",void 0),c(this,"focusActive",void 0),c(this,"delayedLeaveEventDelayMsOverride",void 0),this.logger=(a??E).getChild("[NewMembershipManager]");var[s,o]=[this.client.getUserId(),this.client.getDeviceId()];if(s===null)throw Error("Missing userId in client");if(o===null)throw Error("Missing deviceId in client");this.deviceId=o,this.stateKey=this.makeMembershipStateKey(s,o),this.state=Na.defaultState,this.scheduler=new kp(l=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(tu.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(l)),this.logger)}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1}}get networkErrorRetryMs(){var e,t,r,n;return(e=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.networkErrorRetryMs)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.callMemberEventRetryDelayMinimum)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t,r,n;return(e=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.membershipEventExpiryMs)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.membershipExpiryTimeout)!==null&&e!==void 0?e:Yo}get membershipEventExpiryHeadroomMs(){var e,t,r,n;return(e=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.membershipEventExpiryHeadroomMs)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.membershipExpiryTimeoutHeadroom)!==null&&e!==void 0?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+this.membershipEventExpiryMs*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,r,n,a;return(e=(t=(r=this.delayedLeaveEventDelayMsOverride)!==null&&r!==void 0?r:(n=this.joinConfig)===null||n===void 0?void 0:n.delayedLeaveEventDelayMs)!==null&&t!==void 0?t:(a=this.joinConfig)===null||a===void 0?void 0:a.membershipServerSideExpiryTimeout)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t,r,n;return(e=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.delayedLeaveEventRestartMs)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.membershipKeepAlivePeriod)!==null&&e!==void 0?e:5e3}get maximumRateLimitRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumRateLimitRetryCount)!==null&&e!==void 0?e:10}get maximumNetworkErrorRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumNetworkErrorRetryCount)!==null&&e!==void 0?e:10}membershipLoopHandler(e){var t=this;return T(function*(){switch(e){case Se.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case Se.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):It(Se.SendDelayedEvent);case Se.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):It(Se.SendLeaveEvent):{replace:[]};case Se.SendJoinEvent:return t.sendJoinEvent();case Se.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case Se.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return T(function*(){return yield e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.delayedLeaveEventDelayMs},x.GroupCallMemberPrefix,{},e.stateKey).then(t=>(e.resetRateLimitCounter(Se.SendDelayedEvent),e.state.delayId=t.delay_id,e.state.hasMemberStateEvent?It(Se.RestartDelayedEvent,e.delayedLeaveEventRestartMs):It(Se.SendJoinEvent))).catch(t=>{var r=Se.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return It(r);var n=e.actionUpdateFromErrors(t,r,"sendDelayedStateEvent");if(n)return n;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}else return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),It(Se.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return T(function*(){return yield t.client._unstable_updateDelayedEvent(e,wr.Cancel).then(()=>(t.state.delayId=void 0,t.resetRateLimitCounter(Se.SendDelayedEvent),Cs(Se.SendDelayedEvent))).catch(r=>{var n=Se.SendDelayedEvent,a=t.actionUpdateFromErrors(r,n,"updateDelayedEvent");if(a)return a;if(t.isNotFoundError(r))return t.state.delayId=void 0,Cs(n);if(t.isUnsupportedDelayedEndpoint(r))return Cs(Se.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}restartDelayedEvent(e){var t=this;return T(function*(){return yield t.client._unstable_updateDelayedEvent(e,wr.Restart).then(()=>(t.resetRateLimitCounter(Se.RestartDelayedEvent),It(Se.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(r=>{var n=Se.RestartDelayedEvent;if(t.isNotFoundError(r))return t.state.delayId=void 0,It(Se.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(r))return{};var a=t.actionUpdateFromErrors(r,n,"updateDelayedEvent");if(a)return a;throw Error("Could not restart delayed event, even though delayed events are supported. "+r)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return T(function*(){return yield t.client._unstable_updateDelayedEvent(e,wr.Send).then(()=>(t.state.hasMemberStateEvent=!1,t.resetRateLimitCounter(Se.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(r=>{var n=Se.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(r))return{};if(t.isNotFoundError(r))return t.state.delayId=void 0,It(n);var a=t.actionUpdateFromErrors(r,n,"updateDelayedEvent");return a||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",r),It(n))})})()}sendJoinEvent(){var e=this;return T(function*(){return yield e.client.sendStateEvent(e.room.roomId,x.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs),e.stateKey).then(()=>(e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(Se.SendJoinEvent),{insert:[{ts:Date.now(),type:Se.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:Se.UpdateExpiry}]})).catch(t=>{var r=e.actionUpdateFromErrors(t,Se.SendJoinEvent,"sendStateEvent");if(r)return r;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return T(function*(){var t=e.state.expireUpdateIterations+1;return yield e.client.sendStateEvent(e.room.roomId,x.GroupCallMemberPrefix,e.makeMyMembership(e.membershipEventExpiryMs*t),e.stateKey).then(()=>(e.resetRateLimitCounter(Se.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:Se.UpdateExpiry}]})).catch(r=>{var n=e.actionUpdateFromErrors(r,Se.UpdateExpiry,"sendStateEvent");if(n)return n;throw r})})()}sendFallbackLeaveEvent(){var e=this;return T(function*(){return yield e.client.sendStateEvent(e.room.roomId,x.GroupCallMemberPrefix,{},e.stateKey).then(()=>(e.resetRateLimitCounter(Se.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var r=e.actionUpdateFromErrors(t,Se.SendLeaveEvent,"sendStateEvent");if(r)return r;throw t})})()}makeMembershipStateKey(e,t){var r="".concat(e,"_").concat(t);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?r:"_".concat(r)}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:this.deviceId,expires:e,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.fociPreferred)!==null&&t!==void 0?t:[]}}isNotFoundError(e){return e instanceof je&&e.errcode==="M_NOT_FOUND"}manageMaxDelayExceededSituation(e){if(e instanceof je&&e.errcode==="M_UNKNOWN"&&e.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var t=e.data["org.matrix.msc4140.max_delay"];return typeof t=="number"&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,r){var n=this.actionUpdateFromRateLimitError(e,r,t);if(n)return n;var a=this.actionUpdateFromNetworkErrorRetry(e,t);if(a)return a}actionUpdateFromRateLimitError(e,t,r){var n;if((e instanceof dr||e instanceof je)&&e.isRateLimitError()){var a=(n=this.state.rateLimitRetries.get(r))!==null&&n!==void 0?n:0;if(a<this.maximumRateLimitRetryCount){var s,o=5e3;try{var l;s=(l=e.getRetryAfterMs())!==null&&l!==void 0?l:o,this.logger.info("Rate limited by server, retrying in ".concat(s,"ms"))}catch(d){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(o),d),s=o}return this.state.rateLimitRetries.set(r,a+1),It(r,s)}throw Error("Exceeded maximum retries for "+r+" attempts (client."+t+"): "+e)}}actionUpdateFromNetworkErrorRetry(e,t){var r,n=(r=this.state.networkErrorRetries.get(t))!==null&&r!==void 0?r:0,a=this.networkErrorRetryMs/1e3+"s",s="("+n+"/"+this.maximumNetworkErrorRetryCount+")";if(e instanceof Error&&e.name==="AbortError")this.logger.warn("Network local timeout error while sending event, retrying in "+a+" "+s,e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+a+" "+s,e);else if(e instanceof Tr)this.logger.warn("Network connection error while sending event, retrying in "+a+" "+s,e);else if((e instanceof dr||e instanceof je)&&typeof e.httpStatus=="number"&&e.httpStatus>=500&&e.httpStatus<600)this.logger.warn("Server error while sending event, retrying in "+a+" "+s,e);else return;if(n<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,n+1),It(t,this.networkErrorRetryMs);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof ar}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(e.length===1){var{type:t}=e[0];switch(t){case Se.SendDelayedEvent:case Se.SendJoinEvent:return pr.Connecting;case Se.UpdateExpiry:return pr.Connected;case Se.SendScheduledDelayedLeaveEvent:case Se.SendLeaveEvent:return pr.Disconnecting}}else if(e.length===2){var r=e.map(a=>a.type);if((r.includes(Se.RestartDelayedEvent)||r.includes(Se.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&r.includes(Se.UpdateExpiry))return pr.Connected}else if(e.length===3){var n=e.map(a=>a.type);if(n.filter(a=>a===Se.RestartDelayedEvent).length===2&&n.includes(Se.UpdateExpiry))return pr.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),pr.Unknown):pr.Disconnected}}function It(i,e){return{insert:[{ts:Date.now()+(e??0),type:i}]}}function Cs(i,e){return{replace:[{ts:Date.now()+0,type:i}]}}var br=function(i){return i.ReceivedKeys="received_keys",i.NotSupportedError="not_supported_error",i}({});class th extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}}class Ap extends xe{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,r,n,a,s){super(),this.userId=e,this.deviceId=t,this.roomId=r,this.client=n,this.statistics=a,c(this,"logger",E),c(this,"onToDeviceEvent",o=>{if(o.getType()===x.CallEncryptionKeysPrefix){var l=this.getValidEventContent(o);l&&o.getSender()&&this.receiveCallKeyEvent(o.getSender(),l)}}),this.setParentLogger(s??E)}start(){this.client.on(ae.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(ae.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,r){var n=this;return T(function*(){var a={keys:{index:t,key:e},room_id:n.roomId,member:{claimed_device_id:n.deviceId},session:{call_id:"",application:"m.call",scope:"m.room"}},s=r.filter(o=>o.sender==null||o.deviceId==null?(n.logger.warn("Malformed call member: ".concat(o.sender,"|").concat(o.deviceId)),!1):!(o.sender==n.userId&&o.deviceId==n.deviceId)).map(o=>({userId:o.sender,deviceId:o.deviceId}));s.length>0?(yield n.client.encryptAndSendToDevice(x.CallEncryptionKeysPrefix,s,a).catch(o=>{var l=o.message;if(l.includes("unknown variant")&&l.includes("send_to_device")||l.includes("not supported"))throw new th("The widget driver does not support to-device encryption")}),n.statistics.counters.roomEventEncryptionKeysSent+=1):n.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var r=Date.now(),n=r-(typeof t.sent_ts=="number"?t.sent_ts:r);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=n,this.emit(br.ReceivedKeys,e,t.member.claimed_device_id,t.keys.key,t.keys.index,r)}getValidEventContent(e){var t=e.getContent(),r=t.room_id;if(!r){this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId");return}if(r!==this.roomId){this.logger.warn("Malformed Event: Mismatch roomId");return}if(!t.keys||!t.keys.key||typeof t.keys.index!="number"){this.logger.warn("Malformed Event: Missing keys field");return}if(!t.member||!t.member.claimed_device_id){this.logger.warn("Malformed Event: Missing claimed_device_id");return}return t}}var Xo=function(i){return i.EnabledTransportsChanged="enabled_transports_changed",i}({});class rh extends xe{constructor(e,t,r){var n;super(),n=this,this.toDeviceTransport=e,this.roomKeyTransport=t,c(this,"logger",void 0),c(this,"_enabled",{toDevice:!0,room:!1}),this.logger=(r??E).getChild("[RoomAndToDeviceTransport]"),this.toDeviceTransport.setParentLogger(this.logger),this.roomKeyTransport.setParentLogger(this.logger),this.roomKeyTransport.on(br.ReceivedKeys,function(){n._enabled.room||(n.logger.debug("Received room key, enabling room key transport, disabling toDevice transport"),n.setEnabled({toDevice:!1,room:!0}));for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];n.emit(br.ReceivedKeys,...s)}),this.toDeviceTransport.on(br.ReceivedKeys,function(){if(n._enabled.toDevice){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];n.emit(br.ReceivedKeys,...s)}else n.logger.debug("To Device transport is disabled, ignoring received keys")})}setEnabled(e){(this.enabled.toDevice!==e.toDevice||this.enabled.room!==e.room)&&(this._enabled=e,this.emit(Xo.EnabledTransportsChanged,e))}get enabled(){return this._enabled}start(){this.roomKeyTransport.start(),this.toDeviceTransport.start()}stop(){this.roomKeyTransport.stop(),this.toDeviceTransport.stop()}sendKey(e,t,r){var n=this;return T(function*(){if(n.logger.debug("Sending key with index ".concat(t," to call members (count=").concat(r.length,") via:")+(n._enabled.room?"room transport":"")+(n._enabled.room&&n._enabled.toDevice?"and":"")+(n._enabled.toDevice?"to device transport":"")),n._enabled.room&&(yield n.roomKeyTransport.sendKey(e,t,r)),n._enabled.toDevice)try{yield n.toDeviceTransport.sendKey(e,t,r)}catch(a){a instanceof th&&!n._enabled.room&&(n.logger.warn("To device is not supported enabling room key transport, disabling toDevice transport"),n.setEnabled({toDevice:!1,room:!0}),yield n.sendKey(e,t,r))}})()}}class Dp{get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}constructor(e,t,r,n,a,s,o){var l=this;this.userId=e,this.deviceId=t,this.getMemberships=r,this.transport=n,this.statistics=a,this.onEncryptionKeysChanged=s,c(this,"manageMediaKeys",!1),c(this,"keysEventUpdateTimeout",void 0),c(this,"makeNewKeyTimeout",void 0),c(this,"setNewKeyTimeouts",new Set),c(this,"encryptionKeys",new Map),c(this,"lastEncryptionKeyUpdateRequest",void 0),c(this,"lastMembershipFingerprints",void 0),c(this,"latestGeneratedKeyIndex",-1),c(this,"joinConfig",void 0),c(this,"logger",void 0),c(this,"joined",!1),c(this,"sendEncryptionKeysEvent",function(){var d=T(function*(u){if(l.keysEventUpdateTimeout!==void 0&&(clearTimeout(l.keysEventUpdateTimeout),l.keysEventUpdateTimeout=void 0),l.lastEncryptionKeyUpdateRequest=Date.now(),!!l.joined){var h=l.getKeysForParticipant(l.userId,l.deviceId);if(!h){l.logger.warn("Tried to send encryption keys event but no keys found!");return}if(typeof u!="number"&&l.latestGeneratedKeyIndex===-1){l.logger.warn("Tried to send encryption keys event but no current key index found!");return}var v=u??l.latestGeneratedKeyIndex;l.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(v," (method parameter: ").concat(u,")"));var m=h[v];try{l.statistics.counters.roomEventEncryptionKeysSent+=1,yield l.transport.sendKey(Vo(m),v,l.getMemberships()),l.logger.debug("sendEncryptionKeysEvent participantId=".concat(l.userId,":").concat(l.deviceId," numKeys=").concat(h.length," currentKeyIndex=").concat(l.latestGeneratedKeyIndex," keyIndexToSend=").concat(v),l.encryptionKeys)}catch(g){if(l.keysEventUpdateTimeout===void 0){var f=Ja(g,5e3);l.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(f),g),l.keysEventUpdateTimeout=setTimeout(()=>void l.sendEncryptionKeysEvent(),f)}else l.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(u){return d.apply(this,arguments)}}()),c(this,"onTransportChanged",()=>{this.requestSendCurrentKey()}),c(this,"onNewKeyReceived",(d,u,h,v,m)=>{this.logger.debug("Received key over key transport ".concat(d,":").concat(u," at index ").concat(v)),this.setEncryptionKey(d,u,v,h,m)}),c(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var d=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(d)}}),this.logger=(o??E).getChild("[EncryptionManager]")}getEncryptionKeys(){return this.encryptionKeys}join(e){var t,r,n;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.manageMediaKeys)!==null&&t!==void 0?t:this.manageMediaKeys,this.transport.on(br.ReceivedKeys,this.onNewKeyReceived),this.transport instanceof rh&&this.transport.on(Xo.EnabledTransportsChanged,this.onTransportChanged),this.transport.start(),(n=this.joinConfig)!==null&&n!==void 0&&n.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){this.encryptionKeys.set(pa(this.userId,this.deviceId),[]),this.transport.off(br.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(var e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(d=>!fa(d,this.userId,this.deviceId)).map(Os)),r=new Set(this.getMemberships().filter(d=>!fa(d,this.userId,this.deviceId)).map(Os)),n=Array.from(t).some(d=>!r.has(d)),a=Array.from(r).some(d=>!t.has(d)),s=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),n)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(a)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(s){var o=this.lastMembershipFingerprints,l=Array.from(s).some(d=>!o.has(d))||Array.from(o).some(d=>!s.has(d));l&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=Uf(16),r=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+r),this.setEncryptionKey(this.userId,this.deviceId,r,t,Date.now(),e),r}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(()=>void this.sendEncryptionKeysEvent(),this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e,t){var r;return(r=this.encryptionKeys.get(pa(e,t)))===null||r===void 0?void 0:r.map(n=>n.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!fa(e,this.userId,this.deviceId)).map(e=>"".concat(Os(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return this.latestGeneratedKeyIndex===-1?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,r,n,a){var s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1;this.logger.debug("Setting encryption key for ".concat(e,":").concat(t," at index ").concat(r));var o=Gr(n),l=pa(e,t);this.encryptionKeys.has(l)||this.encryptionKeys.set(l,[]);var d=this.encryptionKeys.get(l),u=d[r];if(u){if(u.timestamp>a){this.logger.info("Ignoring new key at index ".concat(r," for ").concat(l," as it is older than existing known key"));return}if(Lp(u.key,o)){u.timestamp=a;return}}if(e===this.userId&&t===this.deviceId&&(this.latestGeneratedKeyIndex=r),d[r]={key:o,timestamp:a},s){var h=setTimeout(()=>{this.setNewKeyTimeouts.delete(h),this.logger.info("Delayed-emitting key changed event for ".concat(l," index ").concat(r)),this.onEncryptionKeysChanged(o,r,l)},this.useKeyDelay);this.setNewKeyTimeouts.add(h)}else this.onEncryptionKeysChanged(o,r,l)}}var pa=(i,e)=>"".concat(i,":").concat(e);function Lp(i,e){return i===e?!0:!!i&&!!e&&i.length===e.length&&i.every((t,r)=>t===e[r])}var Os=i=>pa(i.sender,i.deviceId);class Up{get networkErrorRetryMs(){var e,t,r,n;return(e=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.networkErrorRetryMs)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.callMemberEventRetryDelayMinimum)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t,r,n;return(e=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.membershipEventExpiryMs)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.membershipExpiryTimeout)!==null&&e!==void 0?e:Yo}get delayedLeaveEventDelayMs(){var e,t,r,n,a;return(e=(t=(r=this.delayedLeaveEventDelayMsOverride)!==null&&r!==void 0?r:(n=this.joinConfig)===null||n===void 0?void 0:n.delayedLeaveEventDelayMs)!==null&&t!==void 0?t:(a=this.joinConfig)===null||a===void 0?void 0:a.membershipServerSideExpiryTimeout)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t,r,n;return(e=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.delayedLeaveEventRestartMs)!==null&&t!==void 0?t:(n=this.joinConfig)===null||n===void 0?void 0:n.membershipKeepAlivePeriod)!==null&&e!==void 0?e:5e3}constructor(e,t,r,n){var a=this;this.joinConfig=e,this.room=t,this.client=r,this.getOldestMembership=n,c(this,"relativeExpiry",void 0),c(this,"memberEventTimeout",void 0),c(this,"ownFociPreferred",void 0),c(this,"ownFocusActive",void 0),c(this,"updateCallMembershipRunning",!1),c(this,"needCallMembershipUpdate",!1),c(this,"delayedLeaveEventDelayMsOverride",void 0),c(this,"disconnectDelayId",void 0),c(this,"triggerCallMembershipEventUpdate",T(function*(){if(a.updateCallMembershipRunning){a.needCallMembershipUpdate=!0;return}a.updateCallMembershipRunning=!0;try{do a.needCallMembershipUpdate=!1,yield a.updateCallMembershipEvent();while(a.needCallMembershipUpdate)}finally{a.updateCallMembershipRunning=!1}})),c(this,"delayDisconnection",T(function*(){try{var s=a.disconnectDelayId;yield un(()=>a.client._unstable_updateDelayedEvent(s,wr.Restart)),a.scheduleDelayDisconnection()}catch(o){E.error("Failed to delay our disconnection event:",o)}}))}off(e,t){return E.error("off is not implemented on LegacyMembershipManager"),this}on(e,t){return E.error("on is not implemented on LegacyMembershipManager"),this}isJoined(){return this.relativeExpiry!==void 0}isActivated(){return this.isJoined()}get status(){return pr.Unknown}join(e,t){this.ownFocusActive=t,this.ownFociPreferred=e,this.relativeExpiry=this.membershipEventExpiryMs,this.triggerCallMembershipEventUpdate()}leave(){var e=arguments,t=this;return T(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:void 0;if(t.relativeExpiry=void 0,t.ownFocusActive=void 0,t.memberEventTimeout&&(clearTimeout(t.memberEventTimeout),t.memberEventTimeout=void 0),r){var n=yield Promise.race([t.triggerCallMembershipEventUpdate(),zr(r,"timeout")]);return n!=="timeout"}else return yield t.triggerCallMembershipEventUpdate(),!0})()}onRTCSessionMemberUpdate(e){var t=this;return T(function*(){var r=n=>n.sender===t.client.getUserId()&&n.deviceId===t.client.getDeviceId();if(t.isJoined()&&!e.some(r))return E.warn("Missing own membership: force re-join"),t.triggerCallMembershipEventUpdate()})()}getActiveFocus(){if(this.ownFocusActive)if(zo(this.ownFocusActive)){if(this.ownFocusActive.focus_selection==="oldest_membership"){var e=this.getOldestMembership();return e?.getPreferredFoci()[0]}}else E.warn("Unknown own ActiveFocus type. This makes it impossible to connect to an SFU.");else{var t=this.getOldestMembership();return t?.getPreferredFoci()[0]}}makeNewMembership(e){return this.isJoined()?this.makeMyMembership(e):{}}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:e,expires:this.relativeExpiry,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.ownFociPreferred)!==null&&t!==void 0?t:[]}}updateCallMembershipEvent(){var e=this;return T(function*(){e.memberEventTimeout&&(clearTimeout(e.memberEventTimeout),e.memberEventTimeout=void 0);var t=e.room.getLiveTimeline().getState(Z.FORWARDS);if(!t)throw new Error("Couldn't get room state for room "+e.room.roomId);var r=e.client.getUserId(),n=e.client.getDeviceId();if(!r||!n)throw new Error("User ID or device ID was null!");var a={};a=e.makeNewMembership(n);try{if(e.isJoined()){var s=e.makeMembershipStateKey(r,n),o=function(){var v=T(function*(){try{var m=yield un(()=>e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.delayedLeaveEventDelayMs},x.GroupCallMemberPrefix,{},s));e.disconnectDelayId=m.delay_id}catch(g){if(g instanceof je&&g.errcode==="M_UNKNOWN"&&g.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var f=g.data["org.matrix.msc4140.max_delay"];if(typeof f=="number"&&e.delayedLeaveEventDelayMs>f)return e.delayedLeaveEventDelayMsOverride=f,o()}E.error("Failed to prepare delayed disconnection event:",g)}});return function(){return v.apply(this,arguments)}}();if(yield o(),yield un(()=>e.client.sendStateEvent(e.room.roomId,x.GroupCallMemberPrefix,a,s)),e.disconnectDelayId!==void 0)try{var l=e.disconnectDelayId;yield un(()=>e.client._unstable_updateDelayedEvent(l,wr.Restart))}catch(v){v instanceof je&&v.errcode==="M_NOT_FOUND"&&(E.warn("Failed to update delayed disconnection event, prepare it again:",v),e.disconnectDelayId=void 0,yield o())}e.disconnectDelayId!==void 0&&e.scheduleDelayDisconnection()}else{var d=!1;if(e.disconnectDelayId!==void 0){try{var u=e.disconnectDelayId;yield un(()=>e.client._unstable_updateDelayedEvent(u,wr.Send)),d=!0}catch(v){E.error("Failed to send our delayed disconnection event:",v)}e.disconnectDelayId=void 0}d||(yield un(()=>e.client.sendStateEvent(e.room.roomId,x.GroupCallMemberPrefix,{},e.makeMembershipStateKey(r,n))))}E.info("Sent updated call member event.")}catch(v){var h=e.networkErrorRetryMs;E.warn("Failed to send call member event (retrying in ".concat(h,"): ").concat(v)),yield zr(h),yield e.triggerCallMembershipEventUpdate()}})()}scheduleDelayDisconnection(){this.memberEventTimeout=setTimeout(()=>void this.delayDisconnection(),this.delayedLeaveEventRestartMs)}makeMembershipStateKey(e,t){var r="".concat(e,"_").concat(t);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?r:"_".concat(r)}}function un(i){return oo.apply(this,arguments)}function oo(){return oo=T(function*(i){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;;)try{return yield i()}catch(a){if(e>0&&a instanceof dr&&a.isRateLimitError()){e--;var t=void 0,r=5e3;try{var n;t=(n=a.getRetryAfterMs())!==null&&n!==void 0?n:r,E.info("Rate limited by server, retrying in ".concat(t,"ms"))}catch(s){E.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(r),s),t=r}yield zr(t)}else throw a}}),oo.apply(this,arguments)}class ru extends xe{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,r,n){super(),this.room=e,this.client=t,this.statistics=r,c(this,"logger",E),this.setParentLogger(n??E)}start(){this.room.on(ie.Timeline,e=>void this.consumeCallEncryptionEvent(e))}stop(){this.room.off(ie.Timeline,e=>void this.consumeCallEncryptionEvent(e))}consumeCallEncryptionEvent(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield r.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){n?r.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(r.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>void r.consumeCallEncryptionEvent(e,!0),1e3));return}else n&&r.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==x.CallEncryptionKeysPrefix)return Promise.resolve();if(!r.room)return r.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();r.onEncryptionEvent(e)})()}sendKey(e,t,r){var n=this;return T(function*(){var a={keys:[{index:t,key:e}],device_id:n.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield n.client.sendEvent(n.room.roomId,x.CallEncryptionKeysPrefix,a)}catch(o){n.logger.error("Failed to send call encryption keys",o);var s=o;throw s.event&&n.client.cancelPendingEvent(s.event),o}})()}onEncryptionEvent(e){var t=e.getSender(),r=e.getContent(),n=r.device_id,a=r.call_id;if(!t){this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(a));return}if(a!==""){this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(n,", callId=").concat(a));return}if(!Array.isArray(r.keys)){this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(a));return}if(t===this.client.getUserId()&&n===this.client.getDeviceId()){this.logger.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var s=Date.now()-(typeof r.sent_ts=="number"?r.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=s;for(var o of r.keys){if(!o){this.logger.info("Ignoring false-y key in keys event");continue}var l=o.key,d=o.index;!l||d===void 0||d===null||a===void 0||a===null||typeof n!="string"||typeof a!="string"||typeof l!="string"||typeof d!="number"?this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(n,", encryptionKeyIndex=").concat(d," callId=").concat(a)):(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(n," encryptionKeyIndex=").concat(d," age=").concat(s,"ms")),this.emit(br.ReceivedKeys,t,n,l,d,e.getTs()))}}}var Ar=function(i){return i.MembershipsChanged="memberships_changed",i.JoinStateChanged="join_state_changed",i.EncryptionKeyChanged="encryption_key_changed",i.MembershipManagerError="membership_manager_error",i}({});class Sn extends xe{get callId(){return this._callId}static callMembershipsForRoom(e){var t=E.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),r=e.getLiveTimeline().getState(Z.FORWARDS);if(!r)throw t.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var n=r.getStateEvents(x.GroupCallMemberPrefix),a=[];for(var s of n){var o=s.getContent(),l=Object.keys(o).length;if(l!==0){var d=[];if(l>1&&"focus_active"in o?d.push(o):l===1&&"memberships"in o&&t.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),d.length!==0)for(var u of d)try{var h,v=new eu(s,u);if(v.callId!==""||v.scope!=="m.room"){t.info("Ignoring user-scoped call");continue}if(v.isExpired()){t.info("Ignoring expired device membership ".concat(v.sender,"/").concat(v.deviceId));continue}if(!e.hasMembershipState((h=v.sender)!==null&&h!==void 0?h:"",Ee.Join)){t.info("Ignoring membership of user ".concat(v.sender," who is not in the room."));continue}a.push(v)}catch(m){t.warn("Couldn't construct call membership: ",m)}}}return a.sort((m,f)=>m.createdTs()-f.createdTs()),a.length>1&&t.debug("Call memberships in room ".concat(e.roomId,", in order: "),a.map(m=>[m.createdTs(),m.sender])),a}static roomSessionForRoom(e,t){var r=Sn.callMembershipsForRoom(t);return new Sn(e,t,r)}get room(){return this.roomSubset}constructor(e,t,r){var n;super(),this.client=e,this.roomSubset=t,this.memberships=r,c(this,"membershipManager",void 0),c(this,"encryptionManager",void 0),c(this,"_callId",void 0),c(this,"logger",void 0),c(this,"expiryTimeout",void 0),c(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),c(this,"reEmitter",new Fn(this)),c(this,"onRoomMemberUpdate",()=>{this.recalculateSessionMembers()}),c(this,"onRTCSessionMemberUpdate",()=>{this.recalculateSessionMembers()}),c(this,"recalculateSessionMembers",()=>{var s,o,l,d=this.memberships;this.memberships=Sn.callMembershipsForRoom(this.room),this._callId=(s=this._callId)!==null&&s!==void 0?s:(o=this.memberships[0])===null||o===void 0?void 0:o.callId;var u=d.length!=this.memberships.length||d.some((v,m)=>!eu.equal(v,this.memberships[m]));if(u){var h;this.logger.info("Memberships for call in room ".concat(this.roomSubset.roomId," have changed: emitting (").concat(this.memberships.length," members)")),uv(this.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{this.emit(Ar.MembershipsChanged,d,this.memberships)}),(h=this.membershipManager)===null||h===void 0||h.onRTCSessionMemberUpdate(this.memberships)}(l=this.encryptionManager)===null||l===void 0||l.onMembershipsUpdate(d),this.setExpiryTimer()}),this.logger=E.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this._callId=(n=r[0])===null||n===void 0?void 0:n.callId;var a=this.roomSubset.getLiveTimeline().getState(Z.FORWARDS);a?.on(Re.Members,this.onRoomMemberUpdate),this.setExpiryTimer()}isJoined(){var e,t;return(e=(t=this.membershipManager)===null||t===void 0?void 0:t.isJoined())!==null&&e!==void 0?e:!1}stop(){var e=this;return T(function*(){var t;yield(t=e.membershipManager)===null||t===void 0?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0);var r=e.roomSubset.getLiveTimeline().getState(Z.FORWARDS);r?.off(Re.Members,e.onRoomMemberUpdate)})()}joinRoomSession(e,t,r){if(this.isJoined()){this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));return}else{var n;(n=r?.useNewMembershipManager)!==null&&n!==void 0&&n?this.membershipManager=new Na(r,this.roomSubset,this.client,()=>this.getOldestMembership(),this.logger):this.membershipManager=new Up(r,this.roomSubset,this.client,()=>this.getOldestMembership());var a;if(r!=null&&r.useExperimentalToDeviceTransport){this.logger.info("Using to-device with room fallback transport for encryption keys");var[s,o]=[this.client.getUserId(),this.client.getDeviceId()],[l,d,u]=[this.roomSubset,this.client,this.statistics],h=new ru(l,d,u),v=new Ap(s,o,l.roomId,d,u);a=new rh(v,h,this.logger),this.reEmitter.reEmit(a,[Xo.EnabledTransportsChanged])}else a=new ru(this.roomSubset,this.client,this.statistics);this.encryptionManager=new Dp(this.client.getUserId(),this.client.getDeviceId(),()=>this.memberships,a,this.statistics,(m,f,g)=>{this.emit(Ar.EncryptionKeyChanged,m,f,g)},this.logger)}this.membershipManager.join(e,t,m=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",m),this.emit(Ar.MembershipManagerError,m),this.emit(Ar.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(r),this.emit(Ar.JoinStateChanged,!0)}leaveRoomSession(){var e=arguments,t=this;return T(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var n=t.membershipManager.leave(r);return t.emit(Ar.JoinStateChanged,!1),yield n})()}getActiveFocus(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.getActiveFocus()}getOldestMembership(){return this.memberships[0]}getFocusInUse(){var e=this.getOldestMembership();if(e?.getFocusSelection()==="oldest_membership")return e.getPreferredFoci()[0]}reemitEncryptionKeys(){var e;(e=this.encryptionManager)===null||e===void 0||e.getEncryptionKeys().forEach((t,r)=>{t.forEach((n,a)=>{this.emit(Ar.EncryptionKeyChanged,n.key,a,r)})})}getEncryptionKeys(){var e,t,r=(e=(t=this.encryptionManager)===null||t===void 0?void 0:t.getEncryptionKeys())!==null&&e!==void 0?e:new Map;return Array.from(r.entries()).map(n=>{var[a,s]=n;return[a,s.map(o=>o.key)]}).values()}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var r=t.getMsUntilExpiry();r!==void 0&&(e===void 0||r<e)&&(e=r)}e!=null&&(this.expiryTimeout=setTimeout(this.onRTCSessionMemberUpdate,e))}}var nu=function(i){return i.SessionStarted="session_started",i.SessionEnded="session_ended",i}({});class Np extends xe{constructor(e){super(),this.client=e,c(this,"roomSessions",new Map),c(this,"logger",void 0),c(this,"onRoom",t=>{this.refreshRoom(t)}),c(this,"onRoomState",(t,r)=>{var n=this.client.getRoom(t.getRoomId());if(!n){this.logger.error("Got room state event for unknown room ".concat(t.getRoomId(),"!"));return}t.getType()==x.GroupCallMemberPrefix&&this.refreshRoom(n)}),this.logger=E.getChild("[MatrixRTCSessionManager]")}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,r=Sn.roomSessionForRoom(this.client,e);r.memberships.length>0&&this.roomSessions.set(e.roomId,r)}this.client.on(ae.Room,this.onRoom),this.client.on(Re.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(ae.Room,this.onRoom),this.client.off(Re.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,Sn.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),r=this.getRoomSession(e),n=r.memberships.length>0&&!t;r.onRTCSessionMemberUpdate();var a=r.memberships.length>0;n&&!a?(this.logger.trace("Session ended for ".concat(e.roomId," (").concat(r.memberships.length," members)")),this.emit(nu.SessionEnded,e.roomId,this.roomSessions.get(e.roomId))):!n&&a&&(this.logger.trace("Session started for ".concat(e.roomId," (").concat(r.memberships.length," members)")),this.emit(nu.SessionStarted,e.roomId,this.roomSessions.get(e.roomId)))}}function Ms(i){return e=>{var t,r;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==i||((r=e.content)===null||r===void 0||(r=r["m.relates_to"])===null||r===void 0?void 0:r.rel_type)===De.name}}function nh(i){return lo.apply(this,arguments)}function lo(){return lo=T(function*(i){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(i),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}),lo.apply(this,arguments)}class pi extends Error{}pi.prototype.name="InvalidTokenError";function Fp(i){return decodeURIComponent(atob(i).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function xp(i){let e=i.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return Fp(e)}catch{return atob(e)}}function ih(i,e){if(typeof i!="string")throw new pi("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,r=i.split(".")[t];if(typeof r!="string")throw new pi(`Invalid token specified: missing part #${t+1}`);let n;try{n=xp(r)}catch(a){throw new pi(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(n)}catch(a){throw new pi(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}var jp={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},$t,Ht,Di=(i=>(i[i.NONE=0]="NONE",i[i.ERROR=1]="ERROR",i[i.WARN=2]="WARN",i[i.INFO=3]="INFO",i[i.DEBUG=4]="DEBUG",i))(Di||{});(i=>{function e(){$t=3,Ht=jp}i.reset=e;function t(n){if(!(0<=n&&n<=4))throw new Error("Invalid log level");$t=n}i.setLevel=t;function r(n){Ht=n}i.setLogger=r})(Di||(Di={}));var ze=class Kt{constructor(e){this._name=e}debug(...e){$t>=4&&Ht.debug(Kt._format(this._name,this._method),...e)}info(...e){$t>=3&&Ht.info(Kt._format(this._name,this._method),...e)}warn(...e){$t>=2&&Ht.warn(Kt._format(this._name,this._method),...e)}error(...e){$t>=1&&Ht.error(Kt._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const r=new Kt(`${e}.${t}`);return r.debug("begin"),r}static _format(e,t){const r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(e,...t){$t>=4&&Ht.debug(Kt._format(e),...t)}static info(e,...t){$t>=3&&Ht.info(Kt._format(e),...t)}static warn(e,...t){$t>=2&&Ht.warn(Kt._format(e),...t)}static error(e,...t){$t>=1&&Ht.error(Kt._format(e),...t)}};Di.reset();var Fa=class{static decode(i){try{return ih(i)}catch(e){throw ze.error("JwtUtils.decode",e),e}}static async generateSignedJwt(i,e,t){const r=xt.encodeBase64Url(new TextEncoder().encode(JSON.stringify(i))),n=xt.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),a=`${r}.${n}`,s=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new TextEncoder().encode(a)),o=xt.encodeBase64Url(new Uint8Array(s));return`${a}.${o}`}},Bp="10000000-1000-4000-8000-100000000000",uo=i=>btoa([...new Uint8Array(i)].map(e=>String.fromCharCode(e)).join("")),ah=class Vt{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return Bp.replace(/[018]/g,t=>(+t^Vt._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return Vt.generateUUIDv4()+Vt.generateUUIDv4()+Vt.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const r=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",r);return uo(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw ze.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const n=new TextEncoder().encode([e,t].join(":"));return uo(n)}static async hash(e,t){const r=new TextEncoder().encode(t),n=await crypto.subtle.digest(e,r);return new Uint8Array(n)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const r=await Vt.hash("SHA-256",JSON.stringify(t));return Vt.encodeBase64Url(r)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:r,keyPair:n,nonce:a}){let s,o;const l={jti:window.crypto.randomUUID(),htm:r??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(s=await Vt.hash("SHA-256",t),o=Vt.encodeBase64Url(s),l.ath=o),a&&(l.nonce=a);try{const d=await crypto.subtle.exportKey("jwk",n.publicKey),u={alg:"ES256",typ:"dpop+jwt",jwk:{crv:d.crv,kty:d.kty,x:d.x,y:d.y}};return await Fa.generateSignedJwt(u,l,n.privateKey)}catch(d){throw d instanceof TypeError?new Error(`Error exporting dpop public key: ${d.message}`):d}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await Vt.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}};ah.encodeBase64Url=i=>uo(i).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var xt=ah,Wp=class{constructor(i){this._name=i,this._callbacks=[],this._logger=new ze(`Event('${this._name}')`)}addHandler(i){return this._callbacks.push(i),()=>this.removeHandler(i)}removeHandler(i){const e=this._callbacks.lastIndexOf(i);e>=0&&this._callbacks.splice(e,1)}async raise(...i){this._logger.debug("raise:",...i);for(const e of this._callbacks)await e(...i)}},xa=class ma extends Wp{constructor(){super(...arguments),this._logger=new ze(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-ma.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=ma.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const r=ma.getEpochTime()+e;if(this.expiration===r&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=r;const n=Math.min(e,5);this._timerHandle=setInterval(this._callback,n*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},iu=class{static readParams(i,e="query"){if(!i)throw new TypeError("Invalid URL");const r=new URL(i,"http://127.0.0.1")[e==="fragment"?"hash":"search"];return new URLSearchParams(r.slice(1))}},Cn=";",On=class extends Error{constructor(i,e){var t,r,n;if(super(i.error_description||i.error||""),this.form=e,this.name="ErrorResponse",!i.error)throw ze.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=i.error,this.error_description=(t=i.error_description)!=null?t:null,this.error_uri=(r=i.error_uri)!=null?r:null,this.state=i.userState,this.session_state=(n=i.session_state)!=null?n:null,this.url_state=i.url_state}},qp=class extends Error{constructor(i){super(i),this.name="ErrorTimeout"}},Kp=class{constructor(){this._logger=new ze("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(i){return this._logger.create(`getItem('${i}')`),this._data[i]}setItem(i,e){this._logger.create(`setItem('${i}')`),this._data[i]=e}removeItem(i){this._logger.create(`removeItem('${i}')`),delete this._data[i]}get length(){return Object.getOwnPropertyNames(this._data).length}key(i){return Object.getOwnPropertyNames(this._data)[i]}},co=class extends Error{constructor(i,e){super(e),this.name="ErrorDPoPNonce",this.nonce=i}},Qo=class{constructor(i=[],e=null,t={}){this._jwtHandler=e,this._extraHeaders=t,this._logger=new ze("JsonService"),this._contentTypes=[],this._contentTypes.push(...i,"application/json"),e&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(i,e={}){const{timeoutInSeconds:t,...r}=e;if(!t)return await fetch(i,r);const n=new AbortController,a=setTimeout(()=>n.abort(),t*1e3);try{return await fetch(i,{...e,signal:n.signal})}catch(s){throw s instanceof DOMException&&s.name==="AbortError"?new qp("Network timed out"):s}finally{clearTimeout(a)}}async getJson(i,{token:e,credentials:t,timeoutInSeconds:r}={}){const n=this._logger.create("getJson"),a={Accept:this._contentTypes.join(", ")};e&&(n.debug("token passed, setting Authorization header"),a.Authorization="Bearer "+e),this._appendExtraHeaders(a);let s;try{n.debug("url:",i),s=await this.fetchWithTimeout(i,{method:"GET",headers:a,timeoutInSeconds:r,credentials:t})}catch(d){throw n.error("Network Error"),d}n.debug("HTTP response received, status",s.status);const o=s.headers.get("Content-Type");if(o&&!this._contentTypes.find(d=>o.startsWith(d))&&n.throw(new Error(`Invalid response Content-Type: ${o??"undefined"}, from URL: ${i}`)),s.ok&&this._jwtHandler&&o?.startsWith("application/jwt"))return await this._jwtHandler(await s.text());let l;try{l=await s.json()}catch(d){throw n.error("Error parsing JSON response",d),s.ok?d:new Error(`${s.statusText} (${s.status})`)}if(!s.ok)throw n.error("Error from server:",l),l.error?new On(l):new Error(`${s.statusText} (${s.status}): ${JSON.stringify(l)}`);return l}async postForm(i,{body:e,basicAuth:t,timeoutInSeconds:r,initCredentials:n,extraHeaders:a}){const s=this._logger.create("postForm"),o={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...a};t!==void 0&&(o.Authorization="Basic "+t),this._appendExtraHeaders(o);let l;try{s.debug("url:",i),l=await this.fetchWithTimeout(i,{method:"POST",headers:o,body:e,timeoutInSeconds:r,credentials:n})}catch(v){throw s.error("Network error"),v}s.debug("HTTP response received, status",l.status);const d=l.headers.get("Content-Type");if(d&&!this._contentTypes.find(v=>d.startsWith(v)))throw new Error(`Invalid response Content-Type: ${d??"undefined"}, from URL: ${i}`);const u=await l.text();let h={};if(u)try{h=JSON.parse(u)}catch(v){throw s.error("Error parsing JSON response",v),l.ok?v:new Error(`${l.statusText} (${l.status})`)}if(!l.ok){if(s.error("Error from server:",h),l.headers.has("dpop-nonce")){const v=l.headers.get("dpop-nonce");throw new co(v,`${JSON.stringify(h)}`)}throw h.error?new On(h,e):new Error(`${l.statusText} (${l.status}): ${JSON.stringify(h)}`)}return h}_appendExtraHeaders(i){const e=this._logger.create("appendExtraHeaders"),t=Object.keys(this._extraHeaders),r=["accept","content-type"],n=["authorization"];t.length!==0&&t.forEach(a=>{if(r.includes(a.toLocaleLowerCase())){e.warn("Protected header could not be set",a,r);return}if(n.includes(a.toLocaleLowerCase())&&Object.keys(i).includes(a)){e.warn("Header could not be overridden",a,n);return}const s=typeof this._extraHeaders[a]=="function"?this._extraHeaders[a]():this._extraHeaders[a];s&&s!==""&&(i[a]=s)})}},sh=class{constructor(i){this._settings=i,this._logger=new ze("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new Qo(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const i=this._logger.create("getMetadata");if(this._metadata)return i.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw i.throw(new Error("No authority or metadataUrl configured on settings")),null;i.debug("getting metadata from",this._metadataUrl);const e=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return i.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},e,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(i=!0){return this._getMetadataProperty("token_endpoint",i)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(i=!0){return this._getMetadataProperty("revocation_endpoint",i)}getKeysEndpoint(i=!0){return this._getMetadataProperty("jwks_uri",i)}async _getMetadataProperty(i,e=!1){const t=this._logger.create(`_getMetadataProperty('${i}')`),r=await this.getMetadata();if(t.debug("resolved"),r[i]===void 0){if(e===!0){t.warn("Metadata does not contain optional property");return}t.throw(new Error("Metadata does not contain property "+i))}return r[i]}async getSigningKeys(){const i=this._logger.create("getSigningKeys");if(this._signingKeys)return i.debug("returning signingKeys from cache"),this._signingKeys;const e=await this.getKeysEndpoint(!1);i.debug("got jwks_uri",e);const t=await this._jsonService.getJson(e,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(i.debug("got key set",t),!Array.isArray(t.keys))throw i.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=t.keys,this._signingKeys}},is=class{constructor({prefix:i="oidc.",store:e=localStorage}={}){this._logger=new ze("WebStorageStateStore"),this._store=e,this._prefix=i}async set(i,e){this._logger.create(`set('${i}')`),i=this._prefix+i,await this._store.setItem(i,e)}async get(i){return this._logger.create(`get('${i}')`),i=this._prefix+i,await this._store.getItem(i)}async remove(i){this._logger.create(`remove('${i}')`),i=this._prefix+i;const e=await this._store.getItem(i);return await this._store.removeItem(i),e}async getAllKeys(){this._logger.create("getAllKeys");const i=await this._store.length,e=[];for(let t=0;t<i;t++){const r=await this._store.key(t);r&&r.indexOf(this._prefix)===0&&e.push(r.substr(this._prefix.length))}return e}},Vp="code",Gp="openid",$p="client_secret_post",Hp=60*15,ho=class{constructor({authority:i,metadataUrl:e,metadata:t,signingKeys:r,metadataSeed:n,client_id:a,client_secret:s,response_type:o=Vp,scope:l=Gp,redirect_uri:d,post_logout_redirect_uri:u,client_authentication:h=$p,prompt:v,display:m,max_age:f,ui_locales:g,acr_values:w,resource:S,response_mode:R,filterProtocolClaims:C=!0,loadUserInfo:b=!1,requestTimeoutInSeconds:_,staleStateAgeInSeconds:p=Hp,mergeClaimsStrategy:I={array:"replace"},disablePKCE:y=!1,stateStore:P,revokeTokenAdditionalContentTypes:L,fetchRequestCredentials:V,refreshTokenAllowedScope:te,extraQueryParams:ve={},extraTokenParams:Oe={},extraHeaders:H={},dpop:ee,omitScopeWhenRequesting:se=!1}){var de;if(this.authority=i,e?this.metadataUrl=e:(this.metadataUrl=i,i&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=t,this.metadataSeed=n,this.signingKeys=r,this.client_id=a,this.client_secret=s,this.response_type=o,this.scope=l,this.redirect_uri=d,this.post_logout_redirect_uri=u,this.client_authentication=h,this.prompt=v,this.display=m,this.max_age=f,this.ui_locales=g,this.acr_values=w,this.resource=S,this.response_mode=R,this.filterProtocolClaims=C??!0,this.loadUserInfo=!!b,this.staleStateAgeInSeconds=p,this.mergeClaimsStrategy=I,this.omitScopeWhenRequesting=se,this.disablePKCE=!!y,this.revokeTokenAdditionalContentTypes=L,this.fetchRequestCredentials=V||"same-origin",this.requestTimeoutInSeconds=_,P)this.stateStore=P;else{const fe=typeof window<"u"?window.localStorage:new Kp;this.stateStore=new is({store:fe})}if(this.refreshTokenAllowedScope=te,this.extraQueryParams=ve,this.extraTokenParams=Oe,this.extraHeaders=H,this.dpop=ee,this.dpop&&!((de=this.dpop)!=null&&de.store))throw new Error("A DPoPStore is required when dpop is enabled")}},Jp=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new ze("UserInfoService"),this._getClaimsFromJwt=async t=>{const r=this._logger.create("_getClaimsFromJwt");try{const n=Fa.decode(t);return r.debug("JWT decoding successful"),n}catch(n){throw r.error("Error parsing JWT response"),n}},this._jsonService=new Qo(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(i){const e=this._logger.create("getClaims");i||this._logger.throw(new Error("No token passed"));const t=await this._metadataService.getUserInfoEndpoint();e.debug("got userinfo url",t);const r=await this._jsonService.getJson(t,{token:i,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("got claims",r),r}},oh=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new ze("TokenClient"),this._jsonService=new Qo(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:i="authorization_code",redirect_uri:e=this._settings.redirect_uri,client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,extraHeaders:n,...a}){const s=this._logger.create("exchangeCode");t||s.throw(new Error("A client_id is required")),e||s.throw(new Error("A redirect_uri is required")),a.code||s.throw(new Error("A code is required"));const o=new URLSearchParams({grant_type:i,redirect_uri:e});for(const[h,v]of Object.entries(a))v!=null&&o.set(h,v);let l;switch(this._settings.client_authentication){case"client_secret_basic":if(r==null)throw s.throw(new Error("A client_secret is required")),null;l=xt.generateBasicAuth(t,r);break;case"client_secret_post":o.append("client_id",t),r&&o.append("client_secret",r);break}const d=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const u=await this._jsonService.postForm(d,{body:o,basicAuth:l,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return s.debug("got response"),u}async exchangeCredentials({grant_type:i="password",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,scope:r=this._settings.scope,...n}){const a=this._logger.create("exchangeCredentials");e||a.throw(new Error("A client_id is required"));const s=new URLSearchParams({grant_type:i});this._settings.omitScopeWhenRequesting||s.set("scope",r);for(const[u,h]of Object.entries(n))h!=null&&s.set(u,h);let o;switch(this._settings.client_authentication){case"client_secret_basic":if(t==null)throw a.throw(new Error("A client_secret is required")),null;o=xt.generateBasicAuth(e,t);break;case"client_secret_post":s.append("client_id",e),t&&s.append("client_secret",t);break}const l=await this._metadataService.getTokenEndpoint(!1);a.debug("got token endpoint");const d=await this._jsonService.postForm(l,{body:s,basicAuth:o,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),d}async exchangeRefreshToken({grant_type:i="refresh_token",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,timeoutInSeconds:r,extraHeaders:n,...a}){const s=this._logger.create("exchangeRefreshToken");e||s.throw(new Error("A client_id is required")),a.refresh_token||s.throw(new Error("A refresh_token is required"));const o=new URLSearchParams({grant_type:i});for(const[h,v]of Object.entries(a))Array.isArray(v)?v.forEach(m=>o.append(h,m)):v!=null&&o.set(h,v);let l;switch(this._settings.client_authentication){case"client_secret_basic":if(t==null)throw s.throw(new Error("A client_secret is required")),null;l=xt.generateBasicAuth(e,t);break;case"client_secret_post":o.append("client_id",e),t&&o.append("client_secret",t);break}const d=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const u=await this._jsonService.postForm(d,{body:o,basicAuth:l,timeoutInSeconds:r,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return s.debug("got response"),u}async revoke(i){var e;const t=this._logger.create("revoke");i.token||t.throw(new Error("A token is required"));const r=await this._metadataService.getRevocationEndpoint(!1);t.debug(`got revocation endpoint, revoking ${(e=i.token_type_hint)!=null?e:"default token type"}`);const n=new URLSearchParams;for(const[a,s]of Object.entries(i))s!=null&&n.set(a,s);n.set("client_id",this._settings.client_id),this._settings.client_secret&&n.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(r,{body:n,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),t.debug("got response")}},zp=class{constructor(i,e,t){this._settings=i,this._metadataService=e,this._claimsService=t,this._logger=new ze("ResponseValidator"),this._userInfoService=new Jp(this._settings,this._metadataService),this._tokenClient=new oh(this._settings,this._metadataService)}async validateSigninResponse(i,e,t){const r=this._logger.create("validateSigninResponse");this._processSigninState(i,e),r.debug("state processed"),await this._processCode(i,e,t),r.debug("code processed"),i.isOpenId&&this._validateIdTokenAttributes(i),r.debug("tokens validated"),await this._processClaims(i,e?.skipUserInfo,i.isOpenId),r.debug("claims processed")}async validateCredentialsResponse(i,e){const t=this._logger.create("validateCredentialsResponse"),r=i.isOpenId&&!!i.id_token;r&&this._validateIdTokenAttributes(i),t.debug("tokens validated"),await this._processClaims(i,e,r),t.debug("claims processed")}async validateRefreshResponse(i,e){var t,r;const n=this._logger.create("validateRefreshResponse");i.userState=e.data,(t=i.session_state)!=null||(i.session_state=e.session_state),(r=i.scope)!=null||(i.scope=e.scope),i.isOpenId&&i.id_token&&(this._validateIdTokenAttributes(i,e.id_token),n.debug("ID Token validated")),i.id_token||(i.id_token=e.id_token,i.profile=e.profile);const a=i.isOpenId&&!!i.id_token;await this._processClaims(i,!1,a),n.debug("claims processed")}validateSignoutResponse(i,e){const t=this._logger.create("validateSignoutResponse");if(e.id!==i.state&&t.throw(new Error("State does not match")),t.debug("state validated"),i.userState=e.data,i.error)throw t.warn("Response was error",i.error),new On(i)}_processSigninState(i,e){var t;const r=this._logger.create("_processSigninState");if(e.id!==i.state&&r.throw(new Error("State does not match")),e.client_id||r.throw(new Error("No client_id on state")),e.authority||r.throw(new Error("No authority on state")),this._settings.authority!==e.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==e.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),i.userState=e.data,i.url_state=e.url_state,(t=i.scope)!=null||(i.scope=e.scope),i.error)throw r.warn("Response was error",i.error),new On(i);e.code_verifier&&!i.code&&r.throw(new Error("Expected code in response"))}async _processClaims(i,e=!1,t=!0){const r=this._logger.create("_processClaims");if(i.profile=this._claimsService.filterProtocolClaims(i.profile),e||!this._settings.loadUserInfo||!i.access_token){r.debug("not loading user info");return}r.debug("loading user info");const n=await this._userInfoService.getClaims(i.access_token);r.debug("user info claims received from user info endpoint"),t&&n.sub!==i.profile.sub&&r.throw(new Error("subject from UserInfo response does not match subject in ID Token")),i.profile=this._claimsService.mergeClaims(i.profile,this._claimsService.filterProtocolClaims(n)),r.debug("user info claims received, updated profile:",i.profile)}async _processCode(i,e,t){const r=this._logger.create("_processCode");if(i.code){r.debug("Validating code");const n=await this._tokenClient.exchangeCode({client_id:e.client_id,client_secret:e.client_secret,code:i.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier,extraHeaders:t,...e.extraTokenParams});Object.assign(i,n)}else r.debug("No code to process")}_validateIdTokenAttributes(i,e){var t;const r=this._logger.create("_validateIdTokenAttributes");r.debug("decoding ID Token JWT");const n=Fa.decode((t=i.id_token)!=null?t:"");if(n.sub||r.throw(new Error("ID Token is missing a subject claim")),e){const a=Fa.decode(e);n.sub!==a.sub&&r.throw(new Error("sub in id_token does not match current sub")),n.auth_time&&n.auth_time!==a.auth_time&&r.throw(new Error("auth_time in id_token does not match original auth_time")),n.azp&&n.azp!==a.azp&&r.throw(new Error("azp in id_token does not match original azp")),!n.azp&&a.azp&&r.throw(new Error("azp not in id_token, but present in original id_token"))}i.profile=n}},ja=class vo{constructor(e){this.id=e.id||xt.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=xa.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new ze("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return ze.createStatic("State","fromStorageString"),Promise.resolve(new vo(JSON.parse(e)))}static async clearStaleState(e,t){const r=ze.createStatic("State","clearStaleState"),n=xa.getEpochTime()-t,a=await e.getAllKeys();r.debug("got keys",a);for(let s=0;s<a.length;s++){const o=a[s],l=await e.get(o);let d=!1;if(l)try{const u=await vo.fromStorageString(l);r.debug("got item from key:",o,u.created),u.created<=n&&(d=!0)}catch(u){r.error("Error parsing state for key:",o,u),d=!0}else r.debug("no item in storage for key:",o),d=!0;d&&(r.debug("removed item for key:",o),e.remove(o))}}},Zo=class fo extends ja{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?xt.generateCodeVerifier():e.code_verifier||void 0,r=t?await xt.generateCodeChallenge(t):void 0;return new fo({...e,code_verifier:t,code_challenge:r})}toStorageString(){return new ze("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){ze.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return fo.create(t)}},lh=class dh{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:r,redirect_uri:n,response_type:a,scope:s,state_data:o,response_mode:l,request_type:d,client_secret:u,nonce:h,url_state:v,resource:m,skipUserInfo:f,extraQueryParams:g,extraTokenParams:w,disablePKCE:S,dpopJkt:R,omitScopeWhenRequesting:C,...b}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!r)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!n)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!a)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const _=await Zo.create({data:o,request_type:d,url_state:v,code_verifier:!S,client_id:r,authority:t,redirect_uri:n,response_mode:l,client_secret:u,scope:s,extraTokenParams:w,skipUserInfo:f}),p=new URL(e);p.searchParams.append("client_id",r),p.searchParams.append("redirect_uri",n),p.searchParams.append("response_type",a),C||p.searchParams.append("scope",s),h&&p.searchParams.append("nonce",h),R&&p.searchParams.append("dpop_jkt",R);let I=_.id;v&&(I=`${I}${Cn}${v}`),p.searchParams.append("state",I),_.code_challenge&&(p.searchParams.append("code_challenge",_.code_challenge),p.searchParams.append("code_challenge_method","S256")),m&&(Array.isArray(m)?m:[m]).forEach(P=>p.searchParams.append("resource",P));for(const[y,P]of Object.entries({response_mode:l,...b,...g}))P!=null&&p.searchParams.append(y,P.toString());return new dh({url:p.href,state:_})}};lh._logger=new ze("SigninRequest");var Yp=lh,Xp="openid",ga=class{constructor(i){if(this.access_token="",this.token_type="",this.profile={},this.state=i.get("state"),this.session_state=i.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(Cn);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(Cn))}this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri"),this.code=i.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-xa.getEpochTime()}set expires_in(i){typeof i=="string"&&(i=Number(i)),i!==void 0&&i>=0&&(this.expires_at=Math.floor(i)+xa.getEpochTime())}get isOpenId(){var i;return((i=this.scope)==null?void 0:i.split(" ").includes(Xp))||!!this.id_token}},Qp=class{constructor({url:i,state_data:e,id_token_hint:t,post_logout_redirect_uri:r,extraQueryParams:n,request_type:a,client_id:s,url_state:o}){if(this._logger=new ze("SignoutRequest"),!i)throw this._logger.error("ctor: No url passed"),new Error("url");const l=new URL(i);if(t&&l.searchParams.append("id_token_hint",t),s&&l.searchParams.append("client_id",s),r&&(l.searchParams.append("post_logout_redirect_uri",r),e||o)){this.state=new ja({data:e,request_type:a,url_state:o});let d=this.state.id;o&&(d=`${d}${Cn}${o}`),l.searchParams.append("state",d)}for(const[d,u]of Object.entries({...n}))u!=null&&l.searchParams.append(d,u.toString());this.url=l.href}},Zp=class{constructor(i){if(this.state=i.get("state"),this.state){const e=decodeURIComponent(this.state).split(Cn);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(Cn))}this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri")}},em=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],tm=["sub","iss","aud","exp","iat"],rm=class{constructor(i){this._settings=i,this._logger=new ze("ClaimsService")}filterProtocolClaims(i){const e={...i};if(this._settings.filterProtocolClaims){let t;Array.isArray(this._settings.filterProtocolClaims)?t=this._settings.filterProtocolClaims:t=em;for(const r of t)tm.includes(r)||delete e[r]}return e}mergeClaims(i,e){const t={...i};for(const[r,n]of Object.entries(e))if(t[r]!==n)if(Array.isArray(t[r])||Array.isArray(n))if(this._settings.mergeClaimsStrategy.array=="replace")t[r]=n;else{const a=Array.isArray(t[r])?t[r]:[t[r]];for(const s of Array.isArray(n)?n:[n])a.includes(s)||a.push(s);t[r]=a}else typeof t[r]=="object"&&typeof n=="object"?t[r]=this.mergeClaims(t[r],n):t[r]=n;return t}},nm=class{constructor(i,e){this.keys=i,this.nonce=e}},el=class{constructor(i,e){this._logger=new ze("OidcClient"),this.settings=i instanceof ho?i:new ho(i),this.metadataService=e??new sh(this.settings),this._claimsService=new rm(this.settings),this._validator=new zp(this.settings,this.metadataService,this._claimsService),this._tokenClient=new oh(this.settings,this.metadataService)}async createSigninRequest({state:i,request:e,request_uri:t,request_type:r,id_token_hint:n,login_hint:a,skipUserInfo:s,nonce:o,url_state:l,response_type:d=this.settings.response_type,scope:u=this.settings.scope,redirect_uri:h=this.settings.redirect_uri,prompt:v=this.settings.prompt,display:m=this.settings.display,max_age:f=this.settings.max_age,ui_locales:g=this.settings.ui_locales,acr_values:w=this.settings.acr_values,resource:S=this.settings.resource,response_mode:R=this.settings.response_mode,extraQueryParams:C=this.settings.extraQueryParams,extraTokenParams:b=this.settings.extraTokenParams,dpopJkt:_,omitScopeWhenRequesting:p=this.settings.omitScopeWhenRequesting}){const I=this._logger.create("createSigninRequest");if(d!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const y=await this.metadataService.getAuthorizationEndpoint();I.debug("Received authorization endpoint",y);const P=await Yp.create({url:y,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:h,response_type:d,scope:u,state_data:i,url_state:l,prompt:v,display:m,max_age:f,ui_locales:g,id_token_hint:n,login_hint:a,acr_values:w,dpopJkt:_,resource:S,request:e,request_uri:t,extraQueryParams:C,extraTokenParams:b,request_type:r,response_mode:R,client_secret:this.settings.client_secret,skipUserInfo:s,nonce:o,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:p});await this.clearStaleState();const L=P.state;return await this.settings.stateStore.set(L.id,L.toStorageString()),P}async readSigninResponseState(i,e=!1){const t=this._logger.create("readSigninResponseState"),r=new ga(iu.readParams(i,this.settings.response_mode));if(!r.state)throw t.throw(new Error("No state in response")),null;const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await Zo.fromStorageString(n),response:r}}async processSigninResponse(i,e,t=!0){const r=this._logger.create("processSigninResponse"),{state:n,response:a}=await this.readSigninResponseState(i,t);if(r.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const s=await this.getDpopProof(this.settings.dpop.store);e={...e,DPoP:s}}try{await this._validator.validateSigninResponse(a,n,e)}catch(s){if(s instanceof co&&this.settings.dpop){const o=await this.getDpopProof(this.settings.dpop.store,s.nonce);e.DPoP=o,await this._validator.validateSigninResponse(a,n,e)}else throw s}return a}async getDpopProof(i,e){let t,r;return(await i.getAllKeys()).includes(this.settings.client_id)?(r=await i.get(this.settings.client_id),r.nonce!==e&&e&&(r.nonce=e,await i.set(this.settings.client_id,r))):(t=await xt.generateDPoPKeys(),r=new nm(t,e),await i.set(this.settings.client_id,r)),await xt.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:r.keys,nonce:r.nonce})}async processResourceOwnerPasswordCredentials({username:i,password:e,skipUserInfo:t=!1,extraTokenParams:r={}}){const n=await this._tokenClient.exchangeCredentials({username:i,password:e,...r}),a=new ga(new URLSearchParams);return Object.assign(a,n),await this._validator.validateCredentialsResponse(a,t),a}async useRefreshToken({state:i,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,extraTokenParams:a}){var s;const o=this._logger.create("useRefreshToken");let l;if(this.settings.refreshTokenAllowedScope===void 0)l=i.scope;else{const h=this.settings.refreshTokenAllowedScope.split(" ");l=(((s=i.scope)==null?void 0:s.split(" "))||[]).filter(m=>h.includes(m)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const h=await this.getDpopProof(this.settings.dpop.store);n={...n,DPoP:h}}let d;try{d=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:l,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...a})}catch(h){if(h instanceof co&&this.settings.dpop)n.DPoP=await this.getDpopProof(this.settings.dpop.store,h.nonce),d=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:l,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...a});else throw h}const u=new ga(new URLSearchParams);return Object.assign(u,d),o.debug("validating response",u),await this._validator.validateRefreshResponse(u,{...i,scope:l}),u}async createSignoutRequest({state:i,id_token_hint:e,client_id:t,request_type:r,url_state:n,post_logout_redirect_uri:a=this.settings.post_logout_redirect_uri,extraQueryParams:s=this.settings.extraQueryParams}={}){const o=this._logger.create("createSignoutRequest"),l=await this.metadataService.getEndSessionEndpoint();if(!l)throw o.throw(new Error("No end session endpoint")),null;o.debug("Received end session endpoint",l),!t&&a&&!e&&(t=this.settings.client_id);const d=new Qp({url:l,id_token_hint:e,client_id:t,post_logout_redirect_uri:a,state_data:i,extraQueryParams:s,request_type:r,url_state:n});await this.clearStaleState();const u=d.state;return u&&(o.debug("Signout request has state to persist"),await this.settings.stateStore.set(u.id,u.toStorageString())),d}async readSignoutResponseState(i,e=!1){const t=this._logger.create("readSignoutResponseState"),r=new Zp(iu.readParams(i,this.settings.response_mode));if(!r.state){if(t.debug("No state in response"),r.error)throw t.warn("Response was error:",r.error),new On(r);return{state:void 0,response:r}}const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await ja.fromStorageString(n),response:r}}async processSignoutResponse(i){const e=this._logger.create("processSignoutResponse"),{state:t,response:r}=await this.readSignoutResponseState(i,!0);return t?(e.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(r,t)):e.debug("No state from storage; skipping response validation"),r}clearStaleState(){return this._logger.create("clearStaleState"),ja.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(i,e){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:i,token_type_hint:e})}},ut=function(i){return i.NotSupported="OIDC authentication not supported",i.Misconfigured="OIDC is misconfigured",i.General="Something went wrong with OIDC discovery",i.OpSupport="Configured OIDC OP does not support required functions",i.DynamicRegistrationNotSupported="Dynamic registration not supported",i.DynamicRegistrationFailed="Dynamic registration failed",i.DynamicRegistrationInvalid="Dynamic registration invalid response",i.CodeExchangeFailed="Failed to exchange code for token",i.InvalidBearerTokenResponse="Invalid bearer token response",i.InvalidIdToken="Invalid ID token",i.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",i}({}),tl=i=>!!i&&typeof i=="object"&&!Array.isArray(i),sr=(i,e)=>!i[e]||!_i(i,e)?(E.error("Missing or invalid property: ".concat(e)),!1):!0,_i=(i,e)=>i[e]&&typeof i[e]!="string"?(E.error("Invalid property: ".concat(e)),!1):!0,au=(i,e)=>i[e]&&(!Array.isArray(i[e])||!i[e].every(t=>typeof t=="string"))?(E.error("Invalid property: ".concat(e)),!1):!0,Ps=(i,e,t)=>{var r=i[e];return!r||!Array.isArray(r)||!r.includes(t)?(E.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},rl=i=>{if(!tl(i))throw E.error("Issuer configuration not found or malformed"),new Error(ut.OpSupport);var e=[sr(i,"issuer"),sr(i,"authorization_endpoint"),sr(i,"token_endpoint"),sr(i,"revocation_endpoint"),_i(i,"registration_endpoint"),_i(i,"account_management_uri"),_i(i,"device_authorization_endpoint"),au(i,"account_management_actions_supported"),Ps(i,"response_types_supported","code"),Ps(i,"grant_types_supported","authorization_code"),Ps(i,"code_challenge_methods_supported","S256"),au(i,"prompt_values_supported")].some(t=>!t);if(!e)return i;throw E.error("Issuer configuration not valid"),new Error(ut.OpSupport)},nl=i=>{try{return ih(i)}catch(e){throw E.error("Could not decode id_token",e),e}},il=(i,e,t,r)=>{try{if(!i)throw new Error("No ID token");var n=nl(i);if(n.iss!==e)throw new Error("Invalid issuer");var a=typeof n.aud=="string"?[n.aud]:n.aud;if(!a.includes(t))throw new Error("Invalid audience");if(r!==void 0&&n.nonce!==r)throw new Error("Invalid nonce");if(!n.exp||Date.now()>n.exp*1e3)throw new Error("Invalid expiry")}catch(s){throw E.error("Invalid ID token",s),new Error(ut.InvalidIdToken)}};function al(i){if(!tl(i))throw E.error("Stored user state not found"),new Error(ut.MissingOrInvalidStoredState);var e=[sr(i,"homeserverUrl"),sr(i,"nonce"),_i(i,"identityServerUrl")].some(t=>!t);if(e)throw new Error(ut.MissingOrInvalidStoredState)}var im=i=>tl(i)&&sr(i,"token_type")&&i.token_type.toLowerCase()==="bearer"&&sr(i,"access_token")&&sr(i,"refresh_token")&&(!("expires_in"in i)||typeof i.expires_in=="number");function sl(i){if(!im(i))throw new Error(ut.InvalidBearerTokenResponse)}function su(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ba(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?su(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):su(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var $i=i=>{var e=i??_r(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},am=function(){var i=T(function*(e){if(!globalThis.crypto.subtle)return E.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield nh(e);return qi(t)});return function(t){return i.apply(this,arguments)}}(),uh=i=>{var{redirectUri:e}=i;return{scope:$i(),redirectUri:e,state:_r(8),nonce:_r(8),codeVerifier:_r(64)}},ch=function(){var i=T(function*(e,t,r){var{scope:n,redirectUri:a,state:s,nonce:o,codeVerifier:l}=r,d=new URL(e);return d.searchParams.append("response_mode","query"),d.searchParams.append("response_type","code"),d.searchParams.append("redirect_uri",a),d.searchParams.append("client_id",t),d.searchParams.append("state",s),d.searchParams.append("scope",n),d.searchParams.append("nonce",o),d.searchParams.append("code_challenge_method","S256"),d.searchParams.append("code_challenge",yield am(l)),d.toString()});return function(t,r,n){return i.apply(this,arguments)}}(),hh=function(){var i=T(function*(e){var{metadata:t,redirectUri:r,clientId:n,homeserverUrl:a,identityServerUrl:s,nonce:o,prompt:l,urlState:d}=e,u=$i(),h=new el(Ba(Ba({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:u,stateStore:new is({prefix:"mx_oidc_",store:window.sessionStorage})})),v={homeserverUrl:a,nonce:o,identityServerUrl:s},m=yield h.createSigninRequest({state:v,nonce:o,prompt:l,url_state:d});return m.url});return function(t){return i.apply(this,arguments)}}(),sm=i=>({id_token:i.id_token,scope:i.scope,expires_at:i.expires_at,refresh_token:i.refresh_token,access_token:i.access_token,token_type:"Bearer"}),vh=function(){var i=T(function*(e,t){var r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),Di.setLogger(E);try{var n=new ga(r.searchParams),a=new is({prefix:"mx_oidc_",store:window.sessionStorage}),s=yield a.get(n.state);if(!s)throw new Error(ut.MissingOrInvalidStoredState);var o=yield Zo.fromStorageString(s),l=new el(Ba(Ba({},o),{},{stateStore:a})),d=yield l.processSigninResponse(r.href),u=d.userState;al(u),sl(d),il(d.id_token,l.settings.authority,l.settings.client_id,u.nonce);var h=sm(d);return{oidcClientSettings:{clientId:l.settings.client_id,issuer:l.settings.authority},tokenResponse:h,homeserverUrl:u.homeserverUrl,identityServerUrl:u.identityServerUrl,idTokenClaims:d.profile}}catch(m){E.error("Oidc login failed",m);var v=m.message;throw Object.values(ut).includes(v)?m:new Error(ut.CodeExchangeFailed)}});return function(t,r){return i.apply(this,arguments)}}();function ou(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function lu(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ou(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ou(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var as=function(){var i=T(function*(e){var t=new URL(".well-known/openid-configuration",e),r=yield fetch(t,{method:q.Get,signal:Bi(5e3)}),n=yield r.json();return ss(n)});return function(t){return i.apply(this,arguments)}}(),ss=function(){var i=T(function*(e){var t=rl(e),r=new ho({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),n=new sh(r);return lu(lu({},t),{},{signingKeys:yield n.getSigningKeys()})});return function(t){return i.apply(this,arguments)}}(),fh="urn:ietf:params:oauth:grant-type:device_code",ks=(i,e)=>{if(!e)return!1;var t=new URL(e);return!(t.protocol!==i.protocol||t.hostname!==i.hostname&&!t.hostname.endsWith(".".concat(i.hostname)))},ph=function(){var i=T(function*(e,t){if(!e.registration_endpoint)throw new Error(ut.DynamicRegistrationNotSupported);var r=["authorization_code","refresh_token"];if(r.some(u=>!e.grant_types_supported.includes(u)))throw new Error(ut.DynamicRegistrationNotSupported);var n=new URL(t.clientUri),a={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:ks(n,t.logoUri)?t.logoUri:void 0,policy_uri:ks(n,t.policyUri)?t.policyUri:void 0,tos_uri:ks(n,t.tosUri)?t.tosUri:void 0},s={Accept:"application/json","Content-Type":"application/json"};try{var o=yield fetch(e.registration_endpoint,{method:q.Post,headers:s,body:JSON.stringify(a)});if(o.status>=400)throw new Error(ut.DynamicRegistrationFailed);var l=yield o.json(),d=l.client_id;if(!d||typeof d!="string")throw new Error(ut.DynamicRegistrationInvalid);return d}catch(u){throw Object.values(ut).includes(u.message)?u:(E.error("Dynamic registration request failed",u),new Error(ut.DynamicRegistrationFailed))}});return function(t,r){return i.apply(this,arguments)}}();class mh{constructor(e,t,r,n,a){this.idTokenClaims=a,c(this,"oidcClientReady",void 0),c(this,"oidcClient",void 0),c(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,n,r)}initialiseOidcClient(e,t,r,n){var a=this;return T(function*(){try{var s,o=yield as(e),l=$i(r);a.oidcClient=new el({metadata:o,signingKeys:(s=o.signingKeys)!==null&&s!==void 0?s:void 0,client_id:t,scope:l,redirect_uri:n,authority:o.issuer,stateStore:new is({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(d){throw E.error("Failed to initialise OIDC client.",d),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return T(function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var r=yield t.inflightRefreshRequest;return r}catch(n){throw n instanceof On?new za(n):n}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return T(function*(){})()}getNewTokens(e){var t=this;return T(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var r={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},n=Date.now(),a=yield t.oidcClient.useRefreshToken({state:r,timeoutInSeconds:300}),s={accessToken:a.access_token,refreshToken:a.refresh_token,expiry:a.expires_in?new Date(n+a.expires_in*1e3):void 0};return yield t.persistTokens(s),s})()}}var om=["server","limit","since"];function du(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function et(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?du(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):du(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var lm=3e3,uu=10*60*1e3,gh=new Ye("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),Xr=function(i){return i.Chronological="chronological",i.Detached="detached",i}({}),yh=new Li("m.get_login_token","org.matrix.msc3882.get_login_token"),ol="uk.half-shot.msc2666",ll="uk.half-shot.msc2666.mutual_rooms",dl="uk.half-shot.msc2666.query_mutual_rooms",Ft="org.matrix.msc4140",ul="uk.tcpip.msc4133",Wt="$",ae=function(i){return i.Sync="sync",i.Event="event",i.ToDeviceEvent="toDeviceEvent",i.AccountData="accountData",i.Room="Room",i.DeleteRoom="deleteRoom",i.SyncUnexpectedError="sync.unexpectedError",i.ClientWellKnown="WellKnown.client",i.ReceivedVoipEvent="received_voip_event",i.UndecryptableToDeviceEvent="toDeviceEvent.undecryptable",i.TurnServers="turnServers",i.TurnServersError="turnServers.error",i}({}),dm=new Ye("action","org.matrix.msc3824.action");class Hi extends xe{constructor(e){var t,r,n,a;super(),n=this,c(this,"logger",void 0),c(this,"reEmitter",new Fn(this)),c(this,"olmVersion",null),c(this,"usingExternalCrypto",!1),c(this,"_store",void 0),c(this,"deviceId",void 0),c(this,"credentials",void 0),c(this,"legacyPickleKey",void 0),c(this,"scheduler",void 0),c(this,"clientRunning",!1),c(this,"timelineSupport",!1),c(this,"urlPreviewCache",{}),c(this,"identityServer",void 0),c(this,"http",void 0),c(this,"cryptoBackend",void 0),c(this,"cryptoCallbacks",void 0),c(this,"callEventHandler",void 0),c(this,"groupCallEventHandler",void 0),c(this,"supportsCallTransfer",!1),c(this,"forceTURN",!1),c(this,"iceCandidatePoolSize",0),c(this,"idBaseUrl",void 0),c(this,"baseUrl",void 0),c(this,"isVoipWithNoMediaAllowed",void 0),c(this,"useLivekitForGroupCalls",void 0),c(this,"canSupportVoip",!1),c(this,"peekSync",null),c(this,"isGuestAccount",!1),c(this,"ongoingScrollbacks",{}),c(this,"notifTimelineSet",null),c(this,"legacyCryptoStore",void 0),c(this,"verificationMethods",void 0),c(this,"fallbackICEServerAllowed",!1),c(this,"syncApi",void 0),c(this,"roomNameGenerator",void 0),c(this,"pushRules",void 0),c(this,"syncLeftRoomsPromise",void 0),c(this,"syncedLeftRooms",!1),c(this,"clientOpts",void 0),c(this,"clientWellKnownIntervalID",void 0),c(this,"canResetTimelineCallback",void 0),c(this,"canSupport",new Map),c(this,"pushProcessor",new Ut(this)),c(this,"serverVersionsPromise",void 0),c(this,"clientWellKnown",void 0),c(this,"clientWellKnownPromise",void 0),c(this,"turnServers",[]),c(this,"turnServersExpiry",0),c(this,"checkTurnServersIntervalID",void 0),c(this,"txnCtr",0),c(this,"mediaHandler",new fp(this)),c(this,"sessionId",void 0),c(this,"eventsBeingEncrypted",new Set),c(this,"useE2eForGroupCall",!0),c(this,"toDeviceMessageQueue",void 0),c(this,"livekitServiceURL",void 0),c(this,"_secretStorage",void 0),c(this,"ignoredInvites",void 0),c(this,"matrixRTC",void 0),c(this,"serverCapabilitiesService",void 0),c(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(to()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(ae.Sync,this.startCallEventHandler))}),c(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(ae.Sync,this.startMatrixRTC))}),c(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var o,l=((o=this.getRooms())!==null&&o!==void 0?o:[]).filter(h=>h.getUnreadNotificationCount(Me.Total)>0);for(var d of l){var u=this.getSafeUserId();d.fixupNotifications(u)}this.off(ae.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:E,e.baseUrl=ps(e.baseUrl),e.idBaseUrl=ps(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(r=e.usingExternalCrypto)!==null&&r!==void 0?r:!1,this.store=e.store||new _f,this.deviceId=e.deviceId||null,this.sessionId=_r(10);var s=e.userId||null;this.credentials={userId:s},this.http=new Fo(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:Xe.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var o=T(function*(l){var d=n.getRoom(l.getRoomId());l.status!==pe.SENDING&&n.updatePendingEventStatus(d,l,pe.SENDING);var u=yield n.sendEventHttpRequest(l);return d&&d.updatePendingEvent(l,pe.SENT,u.event_id),u});return function(l){return o.apply(this,arguments)}}()),to()&&(this.callEventHandler=new qf(this),this.groupCallEventHandler=new Kf(this),this.canSupportVoip=!0,this.on(ae.Sync,this.startCallEventHandler)),this.matrixRTC=new Np(this),this.serverCapabilitiesService=new jo(this.http),this.on(ae.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new _p(this),this.on(Pe.Decrypted,o=>{cl(this,o)}),this.ignoredInvites=new wp(this),this._secretStorage=new Xc(this,(a=e.cryptoCallbacks)!==null&&a!==void 0?a:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>Xt.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return T(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(ae.Sync,t.startMatrixRTC);var r=t.getUserId();r&&t.store.storeUser(new Xt(r)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},uu),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:n,list:a,fwdPagination:s}=yield t.doesServerSupportThread();Ne.setServerSideSupport(n),Ne.setServerSideListSupport(a),Ne.setServerSideFwdPaginationSupport(s)}catch(o){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",o)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new Hc(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new Sr(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(o=>t.logger.info("Sync startup aborted with an error:",o)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1}}stopClient(){var e,t,r,n,a;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(ae.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(r=this.peekSync)===null||r===void 0||r.stopPeeking(),(n=this.callEventHandler)===null||n===void 0||n.stop(),(a=this.groupCallEventHandler)===null||a===void 0||a.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var r=[];r.push(this.store.deleteAllData()),this.legacyCryptoStore&&r.push(this.legacyCryptoStore.deleteAllData());var n=function(){var a=T(function*(){var s;try{if(s=globalThis.indexedDB,!s)return}catch{return}var o=function*(v){var m=new Promise((f,g)=>{e.logger.info("Removing IndexedDB instance ".concat(v));var w=s.deleteDatabase(v);w.onsuccess=S=>{e.logger.info("Removed IndexedDB instance ".concat(v)),f(0)},w.onerror=S=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(v,":"),S),f(0)},w.onblocked=S=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(v))}});yield m};for(var l of["".concat((d=t.cryptoDatabasePrefix)!==null&&d!==void 0?d:Is,"::matrix-sdk-crypto"),"".concat((u=t.cryptoDatabasePrefix)!==null&&u!==void 0?u:Is,"::matrix-sdk-crypto-meta")]){var d,u;yield*o(l)}});return function(){return a.apply(this,arguments)}}();return r.push(n()),Promise.all(r).then()}getUserId(){var e,t;return(e=(t=this.credentials)===null||t===void 0?void 0:t.userId)!==null&&e!==void 0?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return(e=this.credentials)!==null&&e!==void 0&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return(e=(t=this.credentials)===null||t===void 0||(t=t.userId)===null||t===void 0?void 0:t.split(":")[0].substring(1))!==null&&e!==void 0?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return Tn(this,e)}createGroupCall(e,t,r,n,a,s){var o=this;return T(function*(){if(o.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var l=o.getRoom(e);if(!l)throw new Error("Cannot find room ".concat(e));return new Xa(o,l,t,r,n,void 0,a||o.isVoipWithNoMediaAllowed,s,o.isVoipWithNoMediaAllowed,o.useLivekitForGroupCalls,o.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===ke.Prepared||e===ke.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return T(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return T(function*(){var r,n,a=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var s=t.getUserId();if(s===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var o=t.getDeviceId();if(o===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var l=yield Jh(()=>import("./index-CbSAnjSN.js"),__vite__mapDeps([0,1,2])),d=yield l.initRustCrypto({logger:t.logger,http:t.http,userId:s,deviceId:o,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:a.useIndexedDB===!1?null:(r=a.cryptoDatabasePrefix)!==null&&r!==void 0?r:Is,storeKey:a.storageKey,storePassphrase:a.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:(n=t.legacyPickleKey)!==null&&n!==void 0?n:"DEFAULT_KEY",legacyMigrationProgressListener:(u,h)=>{t.emit(ot.LegacyCryptoStoreMigrationProgress,u,h)}});d.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=d,t.on(mt.Membership,d.onRoomMembership.bind(d)),t.on(ae.Event,u=>{d.onLiveEventFromSync(u)}),t.reEmitter.reEmit(d,[ot.VerificationRequestReceived,ot.UserTrustStatusChanged,ot.KeyBackupStatus,ot.KeyBackupSessionsRemaining,ot.KeyBackupFailed,ot.KeyBackupDecryptionKeyCached,ot.KeysChanged,ot.DevicesUpdated,ot.WillUpdateDevices,ot.DehydratedDeviceCreated,ot.DehydratedDeviceUploaded,ot.RehydrationStarted,ot.RehydrationProgress,ot.RehydrationCompleted,ot.RehydrationError,ot.DehydrationKeyCached,ot.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return t?t.hasEncryptionStateEvent():!1}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,r){var n;t!==void 0?n=Q("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?n=Q("/room_keys/keys/$roomId",{$roomId:e}):n="/room_keys/keys";var a=r===void 0?void 0:{version:r};return{path:n,queryData:a}}deleteKeysFromBackup(e,t,r){var n=this;return T(function*(){var a=n.makeKeyBackupPath(e,t,r);yield n.http.authedRequest(q.Delete,a.path,a.queryData,void 0,{prefix:Xe.V3})})()}getMediaConfig(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=e?"/media/config":"/config";return this.http.authedRequest(q.Get,t,void 0,void 0,{prefix:e?Xe.V1:Vr.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),r=new Set;for(var n of t){var a,s=(a=n.findPredecessor(e))===null||a===void 0?void 0:a.roomId;s&&r.add(s)}return t.filter(o=>{var l=o.currentState.getStateEvents(x.RoomTombstone,"");return!(l&&r.has(o.roomId))})}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var r=this;return T(function*(){if(!r.clientRunning)return E.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield ka(5,()=>r.setAccountDataRaw(e,t));var n=r.store.getAccountData(e);if(n&&En(n.event.content,t))return{};var a=Promise.withResolvers();function s(l){l.getType()===e&&a.resolve()}r.addListener(ae.AccountData,s);try{var o=yield ka(5,()=>r.setAccountDataRaw(e,t));return yield a.promise,o}finally{r.removeListener(ae.AccountData,s)}})()}setAccountDataRaw(e,t){var r=Q("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(q.Put,r,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return T(function*(){if(t.isInitialSyncComplete()){var r=t.store.getAccountData(e);return r?r.getContent():null}var n=Q("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(q.Get,n)}catch(s){var a;if(((a=s.data)===null||a===void 0?void 0:a.errcode)==="M_NOT_FOUND")return null;throw s}})()}deleteAccountData(e){var t=this;return T(function*(){var r=t.canSupport.get(nt.AccountDataDeletion);if(r===tt.Unsupported){yield t.setAccountData(e,{});return}var n=Q("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),a=r===tt.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(q.Delete,n,void 0,void 0,a)})()}getIgnoredUsers(){var e=this.getAccountData(x.IgnoredUserList);return e!=null&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(r=>{t.ignored_users[r]={}}),this.setAccountData(x.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};n.syncRoom===void 0&&(n.syncRoom=!0);var a=r.getRoom(e);if(a!=null&&a.hasMembershipState(r.credentials.userId,Ee.Join))return a;var s=Promise.resolve();if(n.inviteSignUrl){var o=new URL(n.inviteSignUrl);o.searchParams.set("mxid",r.credentials.userId),s=r.http.requestOtherUrl(q.Post,o)}var l={};n.viaServers&&(l.server_name=n.viaServers,l.via=n.viaServers);var d={},u=yield s;u&&(d.third_party_signed=u);var h=Q("/join/$roomid",{$roomid:e}),v=yield r.http.authedRequest(q.Post,h,l,d),m=v.room_id,f=r.getRoom(m);if(f!=null&&f.hasMembershipState(r.credentials.userId,Ee.Join))return f;var g=new Sr(r,r.clientOpts,r.buildSyncApiOptions()),w=g.createRoom(m);return n.syncRoom,w})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this.getRoom(e);if(r!=null&&r.hasMembershipState(this.credentials.userId,Ee.Knock))return Promise.resolve({room_id:r.roomId});var n=Q("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),a={};t.viaServers&&(a.server_name=t.viaServers,a.via=t.viaServers);var s={};return t.reason&&(s.reason=t.reason),this.http.authedRequest(q.Post,n,a,s)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,pe.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![pe.QUEUED,pe.NOT_SENT,pe.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===pe.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===pe.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,pe.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,x.RoomName,{name:t})}setRoomTopic(e,t,r){var n=Rc(t,r);return this.sendStateEvent(e,x.RoomTopic,n)}getRoomTags(e){var t=Q("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(q.Get,t)}setRoomTag(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=Q("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(q.Put,n,void 0,r)}deleteRoomTag(e,t){var r=Q("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(q.Delete,r)}setRoomAccountData(e,t,r){var n=Q("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(q.Put,n,void 0,r)}setPowerLevel(e,t,r){var n=this;return T(function*(){var a,s;if(n.clientRunning&&n.isInitialSyncComplete()){var o;s=(o=n.getRoom(e))===null||o===void 0||(o=o.currentState)===null||o===void 0||(o=o.getStateEvents(x.RoomPowerLevels,""))===null||o===void 0?void 0:o.getContent()}if(!s)try{s=yield n.getStateEvent(e,x.RoomPowerLevels,"")}catch(u){if(u instanceof je&&u.errcode==="M_NOT_FOUND")s={};else throw u}s=Ui(s),(a=s)!==null&&a!==void 0&&a.users||(s.users={});var l=Array.isArray(t)?t:[t];for(var d of l)r==null?delete s.users[d]:s.users[d]=r;return n.sendStateEvent(e,x.RoomPowerLevels,s,"")})()}unstable_createLiveBeacon(e,t){var r=this;return T(function*(){return r.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var r=this;return T(function*(){return r.sendStateEvent(e,ts.name,t,r.getUserId())})()}sendEvent(e,t,r,n,a){var s,o,l,d;return!(t!=null&&t.startsWith(Wt))&&t!==null?(d=n,l=r,o=t,s=null):(d=a,l=n,o=r,s=t),this.addThreadRelationIfNeeded(l,s,e),this.sendCompleteEvent(e,s,{type:o,content:l},d)}addThreadRelationIfNeeded(e,t,r){var n;if(t&&!((n=e["m.relates_to"])!==null&&n!==void 0&&n.rel_type)){var a,s,o=!!((a=e["m.relates_to"])!==null&&a!==void 0&&a["m.in_reply_to"]);e["m.relates_to"]=et(et({},e["m.relates_to"]),{},{rel_type:De.name,event_id:t,is_falling_back:!o});var l=(s=this.getRoom(r))===null||s===void 0?void 0:s.getThread(t);if(l&&!o){var d,u;e["m.relates_to"]["m.in_reply_to"]={event_id:(d=(u=l.lastReply(h=>h.isRelation(De.name)&&!h.status))===null||u===void 0?void 0:u.getId())!==null&&d!==void 0?d:t}}}}sendCompleteEvent(e,t,r,n,a){var s,o;typeof n=="string"?o=n:(s=n,o=a),o||(o=this.makeTxnId());var l=new ct(Object.assign(r,{event_id:"~"+e+":"+o,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:new Date().getTime()})),d=this.getRoom(e),u=t?d?.getThread(t):void 0;u&&l.setThread(u),s||(this.reEmitter.reEmit(l,[Pe.Replaced,Pe.VisibilityChange]),d?.reEmitter.reEmit(l,[Pe.BeforeRedaction]));var h=l.getAssociatedId();if(h!=null&&h.startsWith("~")){var v=d?.getPendingEvents().find(f=>f.getId()===h);v?.once(Pe.LocalEventIdReplaced,()=>{l.updateAssociatedId(v.getId())})}var m=l.getType();return this.logger.debug("sendEvent of type ".concat(m," in ").concat(e," with txnId ").concat(o).concat(s?" (delayed event)":"")),l.setTxnId(o),l.setStatus(pe.SENDING),s?this.encryptAndSendEvent(d,l,s):(d?.addPendingEvent(l,o),l.status===pe.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(d,l))}encryptAndSendEvent(e,t,r){var n=this;return T(function*(){if(r)return n.sendEventHttpRequest(t,r);try{var a;n.eventsBeingEncrypted.add(t.getId());try{yield n.encryptEventIfNeeded(t,e??void 0)}finally{a=!n.eventsBeingEncrypted.delete(t.getId())}if(a)return{};t.status===pe.ENCRYPTING&&n.updatePendingEventStatus(e,t,pe.SENDING);var s=null;return n.scheduler&&(s=n.scheduler.queueEvent(t),s&&n.scheduler.getQueueForEvent(t).length>1&&n.updatePendingEventStatus(e,t,pe.QUEUED)),s||(s=n.sendEventHttpRequest(t),e&&(s=s.then(o=>(e.updatePendingEvent(t,pe.SENT,o.event_id),o)))),yield s}catch(o){n.logger.error("Error sending event",o);try{t.error=o,n.updatePendingEventStatus(e,t,pe.NOT_SENT)}catch(l){n.logger.error("Exception in error handler!",l)}throw o instanceof je&&(o.event=t),o}})()}encryptEventIfNeeded(e,t){var r=this;return T(function*(){if(t&&(yield r.shouldEncryptEventForRoom(e,t))&&!(!r.cryptoBackend&&r.usingExternalCrypto)){if(!r.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");r.updatePendingEventStatus(t,e,pe.ENCRYPTING),yield r.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var r=this;return T(function*(){var n;return e.isEncrypted()||e.getType()===x.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(n=r.cryptoBackend)===null||n===void 0?void 0:n.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var r;return t===x.Reaction?t:(r=this.getRoom(e))!==null&&r!==void 0&&r.hasEncryptionStateEvent()?x.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e,t){var r=e.getTxnId();r||(r=this.makeTxnId(),e.setTxnId(r));var n={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:r},a;if(e.isState()){var s="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(s="/rooms/$roomId/state/$eventType/$stateKey"),a=Q(s,n)}else if(e.isRedaction()&&e.event.redacts){var o="/rooms/$roomId/redact/$redactsEventId/$txnId";a=Q(o,et({$redactsEventId:e.event.redacts},n))}else a=Q("/rooms/$roomId/send/$eventType/$txnId",n);var l=e.getWireContent();return t?this.http.authedRequest(q.Put,a,cu(t),l):this.http.authedRequest(q.Put,a,void 0,l).then(d=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(d.event_id)),d))}redactEvent(e,t,r,n,a){var s,o,l;(s=r)!==null&&s!==void 0&&s.startsWith(Wt)||(a=n,n=r,r=t,t=null);var d=(o=a)===null||o===void 0?void 0:o.reason,u={reason:d};if(((l=a)===null||l===void 0?void 0:l.with_rel_types)!==void 0){if(this.canSupport.get(nt.RelationBasedRedactions)===tt.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(n," threadId ").concat(t));var h=this.canSupport.get(nt.RelationBasedRedactions)===tt.Stable?Ia.stable:Ia.unstable;u[h]=a.with_rel_types}return this.sendCompleteEvent(e,t,{type:x.RoomRedaction,content:u,redacts:r},n)}sendMessage(e,t,r,n){typeof t!="string"&&t!==null&&(n=r,r=t,t=null);var a=x.RoomMessage,s=r;return this.sendEvent(e,t,a,s,n)}sendTextMessage(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(n=r,r=t,t=null);var s=Sc(r);return this.sendMessage(e,t,s,n)}sendNotice(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(n=r,r=t,t=null);var s=Ec(r);return this.sendMessage(e,t,s,n)}sendEmoteMessage(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(n=r,r=t,t=null);var s=bc(r);return this.sendMessage(e,t,s,n)}sendImageMessage(e,t,r,n){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(s=n||"Image",n=r,r=t,t=null);var o={msgtype:Bt.Image,url:r,info:n,body:s};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,r,n){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(s=n||"Sticker",n=r,r=t,t=null);var o={url:r,info:n,body:s};return this.sendEvent(e,t,x.Sticker,o)}sendHtmlMessage(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(n=r,r=t,t=null);var s=mc(r,n);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(n=r,r=t,t=null);var s=gc(r,n);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Wt))&&t!==null&&(n=r,r=t,t=null);var s=yc(r,n);return this.sendMessage(e,t,s)}_unstable_sendDelayedEvent(e,t,r,n,a,s){var o=this;return T(function*(){if(!(yield o.doesServerSupportUnstableFeature(Ft)))throw new ar("Server does not support the delayed events API","sendDelayedEvent");return o.addThreadRelationIfNeeded(a,r,e),o.sendCompleteEvent(e,r,{type:n,content:a},t,s)})()}_unstable_sendDelayedStateEvent(e,t,r,n){var a=arguments,s=this;return T(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:"",l=a.length>5&&a[5]!==void 0?a[5]:{};if(!(yield s.doesServerSupportUnstableFeature(Ft)))throw new ar("Server does not support the delayed events API","sendDelayedStateEvent");var d={$roomId:e,$eventType:r,$stateKey:o},u=Q("/rooms/$roomId/state/$eventType",d);return o!==void 0&&(u=Q(u+"/$stateKey",d)),s.http.authedRequest(q.Put,u,cu(t),n,l)})()}_unstable_getDelayedEvents(e){var t=this;return T(function*(){if(!(yield t.doesServerSupportUnstableFeature(Ft)))throw new ar("Server does not support the delayed events API","getDelayedEvents");var r=e?{from:e}:void 0;return yield t.http.authedRequest(q.Get,"/delayed_events",r,void 0,{prefix:"".concat(Xe.Unstable,"/").concat(Ft)})})()}_unstable_updateDelayedEvent(e,t){var r=arguments,n=this;return T(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:{};if(!(yield n.doesServerSupportUnstableFeature(Ft)))throw new ar("Server does not support the delayed events API","updateDelayedEvent");var s=Q("/delayed_events/$delayId",{$delayId:e}),o={action:t};return yield n.http.authedRequest(q.Post,s,void 0,o,et(et({},a),{},{prefix:"".concat(Xe.Unstable,"/").concat(Ft)}))})()}sendReceipt(e,t,r){var n=arguments,a=this;return T(function*(){var s=n.length>3&&n[3]!==void 0?n[3]:!1;if(a.isGuest())return Promise.resolve({});var o=Q("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),l=!s&&a.supportsThreads(),d=l?et(et({},r),{},{thread_id:Qr(e)}):r,u=a.http.authedRequest(q.Post,o,void 0,d||{}),h=a.getRoom(e.getRoomId());return h&&a.credentials.userId&&h.addLocalEchoReceipt(a.credentials.userId,e,t,s),u})()}sendReadReceipt(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:ht.Read,a=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var s=e.getId(),o=r.getRoom(e.getRoomId());if(o!=null&&o.hasPendingEvent(s))throw new Error("Cannot set read receipt to a pending event (".concat(s,")"));return r.sendReceipt(e,n,{},a)}})()}setRoomReadMarkers(e,t,r,n){var a=this;return T(function*(){var s=a.getRoom(e);if(s!=null&&s.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var o;if(r){if(o=r.getId(),s!=null&&s.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));s?.addLocalEchoReceipt(a.credentials.userId,r,ht.Read)}var l;if(n){if(l=n.getId(),s!=null&&s.hasPendingEvent(l))throw new Error("Cannot set read receipt to a pending event (".concat(l,")"));s?.addLocalEchoReceipt(a.credentials.userId,n,ht.ReadPrivate)}return yield a.setRoomReadMarkersHttpRequest(e,t,o,l)})()}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var r=new URL(e);r.hash="",e=r.toString();var n=t+"_"+e;if(n in this.urlPreviewCache)return this.urlPreviewCache[n];var a=this.http.authedRequest(q.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:Vr.V3,priority:"low"});return this.urlPreviewCache[n]=a,a}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});var n=Q("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),a={typing:t};return t&&(a.timeout=r||2e4),this.http.authedRequest(q.Put,n,void 0,a)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getRoom(e);if(!n)return[];var a=this.findPredecessorRooms(n,t,r),s=this.findSuccessorRooms(n,t,r);return[...a,n,...s]}findPredecessorRooms(e,t,r){for(var n,a=[],s=new Set([e.roomId]),o=(n=e.findPredecessor(r))===null||n===void 0?void 0:n.roomId;o!==null;){var l;if(o){if(s.has(o))break;s.add(o)}var d=this.getRoom(o);if(d===null)break;if(t){var u=d.currentState.getStateEvents(x.RoomTombstone,"");if(!u||u.getContent().replacement_room!==e.roomId)break}a.splice(0,0,d),e=d,o=(l=e.findPredecessor(r))===null||l===void 0?void 0:l.roomId}return a}findSuccessorRooms(e,t,r){for(var n=[],a=e.currentState.getStateEvents(x.RoomTombstone,"");a;){var s=this.getRoom(a.getContent().replacement_room);if(!s||s.roomId===e.roomId)break;if(t){var o,l=(o=s.findPredecessor(r))===null||o===void 0?void 0:o.roomId;if(!l||l!==e.roomId)break}n.push(s);var d=new Set(n.map(u=>u.roomId));if(d.size<n.length)return n.slice(0,n.length-1);e=s,a=e.currentState.getStateEvents(x.RoomTombstone,"")}return n}invite(e,t,r){return this.membershipChange(e,t,Ee.Invite,r)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,r){var n=this;return T(function*(){var a,s=Q("/rooms/$roomId/invite",{$roomId:e}),o=n.getIdentityServerUrl(!0);if(!o)return Promise.reject(new je({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var l={id_server:o,medium:t,address:r};if((a=n.identityServer)!==null&&a!==void 0&&a.getAccessToken){var d=yield n.identityServer.getAccessToken();d&&(l.id_access_token=d)}return n.http.authedRequest(q.Post,s,void 0,l)})()}leave(e){return this.membershipChange(e,void 0,Ee.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=this.getRoomUpgradeHistory(e),n=r;if(!t){n=[];for(var a of r)if(n.push(a),a.roomId===e)break}var s={},o=[],l=u=>this.leave(u).then(()=>{delete s[u]}).catch(h=>{s[u]=h});for(var d of n)o.push(l(d.roomId));return Promise.all(o).then(()=>s)}ban(e,t,r){return this.membershipChange(e,t,Ee.Ban,r)}forget(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!0,a=Q("/rooms/$room_id/forget",{$room_id:e}),s=yield r.http.authedRequest(q.Post,a);return n&&(r.store.removeRoom(e),r.emit(ae.DeleteRoom,e)),s})()}unban(e,t){var r=Q("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(q.Post,r,void 0,n)}kick(e,t,r){var n=Q("/rooms/$roomId/kick",{$roomId:e}),a={user_id:t,reason:r};return this.http.authedRequest(q.Post,n,void 0,a)}membershipChange(e,t,r,n){var a=Q("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(q.Post,a,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushDetails()}setProfileInfo(e,t){var r=Q("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(q.Put,r,void 0,t)}setDisplayName(e){var t=this;return T(function*(){var r=yield t.setProfileInfo("displayname",{displayname:e}),n=t.getUser(t.getUserId());return n&&(n.displayName=e,n.emit(yt.DisplayName,n.events.presence,n)),r})()}setAvatarUrl(e){var t=this;return T(function*(){var r=yield t.setProfileInfo("avatar_url",{avatar_url:e}),n=t.getUser(t.getUserId());return n&&(n.avatarUrl=e,n.emit(yt.AvatarUrl,n.events.presence,n)),r})()}mxcUrlToHttp(e,t,r,n,a,s,o){return Fi(this.baseUrl,e,t,r,n,a,s,o)}setSyncPresence(e){var t=this;return T(function*(){var r;(r=t.syncApi)===null||r===void 0||r.setPresence(e)})()}setPresence(e){var t=this;return T(function*(){var r=Q("/presence/$userId/status",{$userId:t.credentials.userId}),n=["offline","online","unavailable"];if(n.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(q.Put,r,void 0,e)})()}getPresence(e){var t=Q("/presence/$userId/status",{$userId:e});return this.http.authedRequest(q.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,r=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){var a=Date.now()-n.errorTs;r=Math.max(lm-a,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t=t-s;var o=new Promise((l,d)=>{zr(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,be.Backward)).then(u=>{var h,v,m=u.chunk.map(this.getEventMapper());if(u.state){var f=u.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(f)}var[g,w,S]=e.partitionThreadedEvents(m);this.processAggregatedTimelineEvents(e,g),e.addEventsToTimeline(g,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,w,!0),S.forEach(R=>e.relations.aggregateChildEvent(R)),e.oldState.paginationToken=(h=u.end)!==null&&h!==void 0?h:null,u.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,m,(v=u.end)!==null&&v!==void 0?v:null,!0),delete this.ongoingScrollbacks[e.roomId],l(e)}).catch(u=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},d(u)})});return n={promise:o},this.ongoingScrollbacks[e.roomId]=n,o}getEventMapper(e){return hp(this,e||{})}getEventTimeline(e,t){var r=this;return T(function*(){var n,a,s,o;if(!r.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&r.supportsThreads())return r.getThreadTimeline(e,t);var l=Q("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),d=void 0;(n=r.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(d={filter:JSON.stringify(pt.LAZY_LOADING_MESSAGES_FILTER)});var u=yield r.http.authedRequest(q.Get,l,d);if(!u.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var h=r.getEventMapper(),v=h(u.event);if(v.isRelation(De.name)){r.logger.warn("Tried loading a regular timeline at the position of a thread event");return}var m=[...u.events_after.reverse().map(h),v,...u.events_before.map(h)],f=e.getTimelineForEvent(m[0].getId());f?f.getState(Z.BACKWARDS).setUnknownStateEvents(u.state.map(h)):(f=e.addTimeline(),f.initialiseState(u.state.map(h)),f.getState(Z.FORWARDS).paginationToken=u.end);var[g,w,S]=e.room.partitionThreadedEvents(m);return e.addEventsToTimeline(g,!0,!1,f,u.start),r.processThreadEvents(e.room,w,!0),r.processAggregatedTimelineEvents(e.room,g),S.forEach(R=>e.relations.aggregateChildEvent(R)),(a=(s=e.getTimelineForEvent(t))!==null&&s!==void 0?s:(o=e.room.findThreadForEvent(v))===null||o===void 0?void 0:o.liveTimeline)!==null&&a!==void 0?a:f})()}getThreadTimeline(e,t){var r=this;return T(function*(){var n;if(!r.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var a=Q("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),s={limit:"0"};(n=r.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(s.filter=JSON.stringify(pt.LAZY_LOADING_MESSAGES_FILTER));var o=yield r.http.authedRequest(q.Get,a,s),l=r.getEventMapper(),d=l(o.event);if(e.canContain(d)){var u=r.canSupport.get(nt.RelationsRecursion)!==tt.Unsupported;if(Ne.hasServerSideSupport)if(Ne.hasServerSideFwdPaginationSupport){var h,v,m;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var f=e.thread,g=yield r.fetchRelations(e.room.roomId,f.id,null,null,{dir:be.Backward,from:o.start,recurse:u||void 0}),w=yield r.fetchRelations(e.room.roomId,f.id,null,null,{dir:be.Forward,from:o.end,recurse:u||void 0}),S=[...w.chunk.reverse().filter(Ms(f.id)).map(l),d,...g.chunk.filter(Ms(f.id)).map(l)];for(var R of S){var C;yield(C=e.thread)===null||C===void 0?void 0:C.processEvent(R)}var b=e.getTimelineForEvent(d.getId());if(b?b.getState(Z.BACKWARDS).setUnknownStateEvents(o.state.map(l)):(b=e.addTimeline(),b.initialiseState(o.state.map(l))),e.addEventsToTimeline(S,!0,!1,b,w.next_batch),!g.next_batch){var _=yield r.fetchRoomEvent(e.room.roomId,f.id);e.addEventsToTimeline([l(_)],!0,!1,b,null)}return b.setPaginationToken((h=g.next_batch)!==null&&h!==void 0?h:null,be.Backward),b.setPaginationToken((v=w.next_batch)!==null&&v!==void 0?v:null,be.Forward),r.processAggregatedTimelineEvents(e.room,S),(m=e.getTimelineForEvent(t))!==null&&m!==void 0?m:b}else{for(var p,I=e.thread,y=yield r.fetchRelations(e.room.roomId,I.id,De.name,null,{dir:be.Backward,from:o.start,recurse:u||void 0}),P=[],L=o.end;L;){var V,te=yield r.fetchRelations(e.room.roomId,I.id,De.name,null,{dir:be.Forward,from:L,recurse:u||void 0});L=(V=te.next_batch)!==null&&V!==void 0?V:null,P.push(...te.chunk)}var ve=[...P.reverse().map(l),d,...y.chunk.map(l)];for(var Oe of ve){var H;yield(H=e.thread)===null||H===void 0?void 0:H.processEvent(Oe)}var ee=e.getLiveTimeline();if(ee.getState(Z.BACKWARDS).setUnknownStateEvents(o.state.map(l)),e.addEventsToTimeline(ve,!0,!1,ee,null),!y.next_batch){var se=yield r.fetchRoomEvent(e.room.roomId,I.id);e.addEventsToTimeline([l(se)],!0,!1,ee,null)}return ee.setPaginationToken((p=y.next_batch)!==null&&p!==void 0?p:null,be.Backward),ee.setPaginationToken(null,be.Forward),r.processAggregatedTimelineEvents(e.room,ve),ee}}})()}getLatestTimeline(e){var t=this;return T(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var r;if(e.threadListType!==null){var n,a=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,be.Backward,e.threadListType,e.getFilter());r=(n=a.chunk)===null||n===void 0?void 0:n[0]}else if(e.thread&&Ne.hasServerSideSupport){var s,o=t.canSupport.get(nt.RelationsRecursion)!==tt.Unsupported,l=yield t.fetchRelations(e.room.roomId,e.thread.id,De.name,null,{dir:be.Backward,limit:1,recurse:o||void 0});r=(s=l.chunk)===null||s===void 0?void 0:s[0]}else{var d,u,h=Q("/rooms/$roomId/messages",{$roomId:e.room.roomId}),v={dir:"b"};(d=t.clientOpts)!==null&&d!==void 0&&d.lazyLoadMembers&&(v.filter=JSON.stringify(pt.LAZY_LOADING_MESSAGES_FILTER));var m=yield t.http.authedRequest(q.Get,h,v);r=(u=m.chunk)===null||u===void 0?void 0:u[0]}if(!r)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,r.event_id)})()}createMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,o=Q("/rooms/$roomId/messages",{$roomId:e}),l={limit:n.toString(),dir:a};t&&(l.from=t);var d=null;if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(d=Object.assign({},pt.LAZY_LOADING_MESSAGES_FILTER)),s){var u;d=d||{},Object.assign(d,(u=s.getRoomTimelineFilterComponent())===null||u===void 0?void 0:u.toJSON())}return d&&(l.filter=JSON.stringify(d)),this.http.authedRequest(q.Get,o,l)}createThreadListMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:be.Backward,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Pt.All,o=arguments.length>5?arguments[5]:void 0,l=Q("/rooms/$roomId/threads",{$roomId:e}),d={limit:n.toString(),dir:a,include:hl(s)};t&&(d.from=t);var u={};if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(u=et({},pt.LAZY_LOADING_MESSAGES_FILTER)),o){var h;u=et(et({},u),(h=o.getRoomTimelineFilterComponent())===null||h===void 0?void 0:h.toJSON())}Object.keys(u).length&&(d.filter=JSON.stringify(u));var v={prefix:Ne.hasServerSideListSupport===dt.Stable?Xe.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(q.Get,l,d,void 0,v).then(m=>{var f;return et(et({},m),{},{chunk:(f=m.chunk)===null||f===void 0?void 0:f.reverse(),start:m.prev_batch,end:m.next_batch})})}paginateEventTimeline(e,t){var r=this,n=e.getTimelineSet()===this.notifTimelineSet,a=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,o=e.getTimelineSet().thread;t=t||{};var l=t.backwards||!1;if(n&&!l)throw new Error("paginateNotifTimeline can only paginate backwards");var d=l?Z.BACKWARDS:Z.FORWARDS,u=e.getPaginationToken(d),h=e.paginationRequests[d];if(h)return h;var v,m,f;if(n){var g;v="/notifications",m={limit:((g=t.limit)!==null&&g!==void 0?g:30).toString(),only:"highlight"},u&&u!=="end"&&(m.from=u),f=this.http.authedRequest(q.Get,v,m).then(function(){var b=T(function*(_){var p=_.next_token,I=[];_.notifications=_.notifications.filter(Nt);for(var y=0;y<_.notifications.length;y++){var P=_.notifications[y],L=r.getEventMapper()(P.event);r.getPushDetailsForEvent(L,!0),L.event.room_id=P.room_id,I[y]=L}var V=e.getTimelineSet();return V.addEventsToTimeline(I,l,!1,e,p),r.processAggregatedTimelineEvents(V.room,I),l&&!_.next_token&&e.setPaginationToken(null,d),!!_.next_token});return function(_){return b.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=f}else if(s!==null){if(!a)throw new Error("Unknown room "+e.getRoomId());if(!Ne.hasServerSideFwdPaginationSupport&&d===be.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");f=this.createThreadListMessagesRequest(e.getRoomId(),u,t.limit,d,s,e.getFilter()).then(b=>{if(b.state){var _=e.getState(d),p=b.state.filter(Nt).map(this.getEventMapper());_.setUnknownStateEvents(p)}var I=b.end,y=b.chunk.filter(Nt).map(this.getEventMapper()),P=e.getTimelineSet();return P.addEventsToTimeline(y,l,!1,e,I),this.processAggregatedTimelineEvents(a,y),this.processThreadRoots(a,y,l),l&&b.end==b.start&&e.setPaginationToken(null,d),b.end!==b.start}).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=f}else if(o){var w,S,R=this.getRoom((w=e.getRoomId())!==null&&w!==void 0?w:void 0);if(!R)throw new Error("Unknown room "+e.getRoomId());var C=this.canSupport.get(nt.RelationsRecursion)!==tt.Unsupported;f=this.fetchRelations((S=e.getRoomId())!==null&&S!==void 0?S:"",o.id,null,null,{dir:d,limit:t.limit,from:u??void 0,recurse:C||void 0}).then(function(){var b=T(function*(_){var p=r.getEventMapper(),I=_.chunk.filter(Nt).filter(Ms(o.id)).map(p);for(var y of I.slice().reverse()){yield o?.processEvent(y);var P=y.getSender();(!l||o?.getEventReadUpTo(P)===null)&&R.addLocalEchoReceipt(P,y,ht.Read)}var L=_.next_batch,V=e.getTimelineSet();if(V.addEventsToTimeline(I,l,!1,e,L??null),!L&&l){var te,ve,Oe=(te=o.rootEvent)!==null&&te!==void 0?te:p(yield r.fetchRoomEvent((ve=e.getRoomId())!==null&&ve!==void 0?ve:"",o.id));V.addEventsToTimeline([Oe],!0,!1,e,null)}return r.processAggregatedTimelineEvents(V.room,I),l&&!L&&e.setPaginationToken(null,d),!!L});return function(_){return b.apply(this,arguments)}}()).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=f}else{if(!a)throw new Error("Unknown room "+e.getRoomId());f=this.createMessagesRequest(e.getRoomId(),u,t.limit,d,e.getFilter()).then(b=>{if(b.state){var _=e.getState(d),p=b.state.filter(Nt).map(this.getEventMapper());_.setUnknownStateEvents(p)}var I=b.end,y=b.chunk.filter(Nt).map(this.getEventMapper()),P=e.getTimelineSet(),[L,,V]=a.partitionThreadedEvents(y);P.addEventsToTimeline(L,l,!1,e,I),this.processAggregatedTimelineEvents(a,L),this.processThreadRoots(a,L.filter(ve=>ve.getServerAggregatedRelation(De.name)),!1),V.forEach(ve=>a.relations.aggregateChildEvent(ve));var te=b.end===void 0||b.end===b.start;return l&&te&&e.setPaginationToken(null,d),!te}).finally(()=>{e.paginationRequests[d]=null}),e.paginationRequests[d]=f}return f}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new Sr(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,r)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var r=this.sendStateEvent(e,x.RoomGuestAccess,{guest_access:t.allowJoin?Ai.CanJoin:Ai.Forbidden},""),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,x.RoomHistoryVisibility,{history_visibility:es.WorldReadable},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,a){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:a})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,a){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:a})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,a){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:a})}requestTokenFromEndpoint(e,t){var r=this;return T(function*(){var n=Object.assign({},t);return r.http.request(q.Post,e,void 0,n)})()}getRoomPushRule(e,t){if(this.pushRules){var r;return(r=this.pushRules[e])===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.find(n=>n.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){var n,a=!1,s=this.getRoomPushRule(e,t);if(s!=null&&s.actions.includes(lr.DontNotify)&&(a=!0),!r)a&&(n=this.deletePushRule(e,it.RoomSpecific,s.rule_id));else if(!s)n=this.addPushRule(e,it.RoomSpecific,t,{actions:[lr.DontNotify]});else if(!a){var o=Promise.withResolvers();this.deletePushRule(e,it.RoomSpecific,s.rule_id).then(()=>{this.addPushRule(e,it.RoomSpecific,t,{actions:[lr.DontNotify]}).then(()=>{o.resolve()}).catch(l=>{o.reject(l)})}).catch(l=>{o.reject(l)}),n=o.promise}if(n)return new Promise((l,d)=>{n.then(()=>{this.getPushRules().then(u=>{this.pushRules=u,l()}).catch(u=>{d(u)})}).catch(u=>{this.getPushRules().then(h=>{this.pushRules=h,d(u)}).catch(h=>{d(u)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:Jo.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(n=>this.processRoomEventsSearch(r,n))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(n=>this.processRoomEventsSearch(e,n)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,n,a=t.search_categories.room_events;e.count=a.count,e.next_batch=a.next_batch;var s=new Set(a.highlights);e.highlights.forEach(m=>{s.add(m)}),e.highlights=Array.from(s);for(var o=this.getEventMapper(),l=(r=(n=a.results)===null||n===void 0?void 0:n.length)!==null&&r!==void 0?r:0,d=0;d<l;d++){var u=Vi.fromJson(a.results[d],o),h=this.getRoom(u.context.getEvent().getRoomId());if(h)for(var v of u.context.getTimeline())v.setMetadata(h.currentState,!1);e.results.push(u)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new Sr(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=Q("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(q.Post,t,void 0,e).then(r=>{var n=pt.fromJson(this.credentials.userId,r.filter_id,e);return this.store.storeFilter(n),n})}getFilter(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var a=Q("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(q.Get,a).then(s=>{var o=pt.fromJson(e,t,s);return this.store.storeFilter(o),o})}getOrCreateFilter(e,t){var r=this;return T(function*(){var n=r.store.getFilterIdByName(e),a;if(n){try{var s=yield r.getFilter(r.credentials.userId,n,!0);if(s){var o=s.getDefinition(),l=t.getDefinition();En(o,l)&&(a=n)}}catch(u){if(u.errcode!=="M_UNKNOWN"&&u.errcode!=="M_NOT_FOUND")throw u}a||r.store.setFilterIdByName(e,void 0)}if(a)return a;var d=yield r.createFilter(t.getDefinition());return r.store.setFilterIdByName(e,d.filterId),d.filterId})()}getOpenIdToken(){var e=Q("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(q.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(q.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return T(function*(){if(e.canSupportVoip){var t=!1,r=e.turnServersExpiry-Date.now();if(r>uu)e.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var n=yield e.turnServer();if(n.uris){e.logger.debug("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs");var a={urls:n.uris,username:n.username,credential:n.password};e.turnServers=[a],e.turnServersExpiry=Date.now()+n.ttl*1e3,t=!0,e.emit(ae.TurnServers,e.turnServers)}}catch(s){e.logger.error("Failed to get TURN URIs",s),s.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(ae.TurnServersError,s,!0)):e.emit(ae.TurnServersError,s,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=Q("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(q.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=Q("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(q.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=Q("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(q.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return T(function*(){var t;e.clientWellKnownPromise=ye.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(ae.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(r=>{var[n,a]=r;return e.includes(typeof a)}).reduce((r,n)=>{var[a,s]=n;return r[a]=s,r},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return T(function*(){var r=yield t.doesServerSupportUnstableFeature(ol),n=yield t.doesServerSupportUnstableFeature(ll),a=yield t.doesServerSupportUnstableFeature(dl);if(!r&&!n&&!a)throw Error("Server does not support the Mutual Rooms API");var s,o;a?(s="/uk.half-shot.msc2666/user/mutual_rooms",o={user_id:e}):(s=Q("/uk.half-shot.msc2666/user/".concat(n?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),o={});var l=[],d=null;do{var u={};d!=null&&a&&(u.batch_token=d);var h=yield t.http.authedRequest(q.Get,s,et(et({},o),u),void 0,{prefix:Xe.Unstable});l.push(...h.joined),h.next_batch_token!==void 0?d=h.next_batch_token:d=null}while(d!=null);return l})()}getVersions(){var e=this;return T(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(q.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(r=>{throw e.serverVersionsPromise=void 0,r});var t=yield e.serverVersionsPromise;return e.canSupport=yield yf(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return T(function*(){var{versions:r}=yield t.getVersions();return r&&r.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return T(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features;return n&&!!n[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return T(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features,a=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced.".concat(a)]})()}doesServerSupportThread(){var e=this;return T(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:dt.Stable,list:dt.Stable,fwdPagination:dt.Stable};try{var[t,r,n,a,s,o]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:wi(r,t),list:wi(a,n),fwdPagination:wi(o,s)}}catch{return{threads:dt.None,list:dt.None,fwdPagination:dt.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,r,n){var a=arguments,s=this;return T(function*(){var o,l,d=a.length>4&&a[4]!==void 0?a[4]:{dir:be.Backward},u=n?s.getEncryptedIfNeededEventType(e,n):null,[h,v]=yield Promise.all([s.fetchRoomEvent(e,t),s.fetchRelations(e,t,r,u,d)]),m=s.getEventMapper(),f=h?m(h):void 0,g=v.chunk.map(m);if(u===x.RoomMessageEncrypted){var w=f?g.concat(f):g;yield Promise.all(w.map(S=>s.decryptEventIfNeeded(S))),n!==null&&(g=g.filter(S=>S.getType()===n))}return f&&r===Ke.Replace&&(g=g.filter(S=>S.getSender()===f.getSender())),{originalEvent:f??null,events:g,nextBatch:(o=v.next_batch)!==null&&o!==void 0?o:null,prevBatch:(l=v.prev_batch)!==null&&l!==void 0?l:null}})()}generateClientSecret(){return _r(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case Da.IS:return this.http.getUrl("/terms",void 0,Gt.V2,t);case Da.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return r&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=ps(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(q.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,r,n,a,s,o){r&&(n.session=r);var l={auth:n,refresh_token:!0};return e!=null&&(l.username=e),t!=null&&(l.password=t),s!=null&&(l.guest_access_token=s),o!=null&&(l.inhibit_login=o),this.registerRequest(l)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var r={};return t&&(r.kind=t),this.http.request(q.Post,"/register",r,e)}refreshToken(e){var t=r=>this.http.authedRequest(q.Post,"/refresh",void 0,{refresh_token:e},{prefix:r,inhibitLogoutEmit:!0});return t(Xe.V3).catch(r=>{if(r.errcode==="M_UNRECOGNIZED")return t(Xe.V1);throw r})}loginFlows(){return this.http.request(q.Get,"/login")}login(e,t){return this.loginRequest(et(et({},t),{},{type:e})).then(r=>(r.access_token&&r.user_id&&(this.http.opts.accessToken=r.access_token,this.credentials={userId:r.user_id}),r))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,a="/login/"+t+"/redirect";r&&(a+="/"+r);var s={redirectUrl:e,[dm.unstable]:n};return this.http.getUrl(a,s).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return T(function*(){return yield t.http.authedRequest(q.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return T(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:!1;return r&&(t.stopClient(),t.http.abort()),t.http.authedRequest(q.Post,"/logout")})()}deactivateAccount(e,t){var r={};return e&&(r.auth=e),t!==void 0&&(r.erase=t),this.http.authedRequest(q.Post,"/account/deactivate",void 0,r)}requestLoginToken(e){var t=this;return T(function*(){var r={auth:e};return t.http.authedRequest(q.Post,"/login/get_token",void 0,r,{prefix:Xe.V1})})()}getFallbackAuthUrl(e,t){var r=Q("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}createRoom(e){var t=this;return T(function*(){var r,n=(e.invite_3pid||[]).filter(o=>!o.id_access_token);if(n.length>0&&(r=t.identityServer)!==null&&r!==void 0&&r.getAccessToken){var a=yield t.identityServer.getAccessToken();if(a)for(var s of n)s.id_access_token=a}return t.http.authedRequest(q.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:be.Backward},s=a;Ne.hasServerSideFwdPaginationSupport===dt.Experimental&&(s=Dl("dir","org.matrix.msc3715.dir",s)),this.canSupport.get(nt.RelationsRecursion)===tt.Unstable&&(s=Dl("recurse","org.matrix.msc3981.recurse",s));var o=xs(s),l="/rooms/$roomId/relations/$eventId";r!==null?(l+="/$relationType",n!==null&&(l+="/$eventType")):n!==null&&(this.logger.warn("eventType: ".concat(n,` ignored when fetching
            relations as relationType is null`)),n=null);var d=Q(l+"?"+o,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return this.http.authedRequest(q.Get,d,void 0,void 0,{prefix:Xe.V1})}roomState(e){var t=Q("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(q.Get,t)}fetchRoomEvent(e,t){var r=Q("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(q.Get,r)}members(e,t,r,n){var a={};t&&(a.membership=t),r&&(a.not_membership=r),n&&(a.at=n);var s=xs(a),o=Q("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(q.Get,o)}upgradeRoom(e,t){var r=Q("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(q.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){var n={$roomId:e,$eventType:t,$stateKey:r},a=Q("/rooms/$roomId/state/$eventType",n);return r!==void 0&&(a=Q(a+"/$stateKey",n)),this.http.authedRequest(q.Get,a)}sendStateEvent(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"",a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{},s={$roomId:e,$eventType:t,$stateKey:n},o=Q("/rooms/$roomId/state/$eventType",s);return n!==void 0&&(o=Q(o+"/$stateKey",s)),this.http.authedRequest(q.Put,o,void 0,r,a)}roomInitialSync(e,t){var r,n=Q("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(q.Get,n,{limit:(r=t?.toString())!==null&&r!==void 0?r:"30"})}setRoomReadMarkersHttpRequest(e,t,r,n){var a=this;return T(function*(){var s=Q("/rooms/$roomId/read_markers",{$roomId:e}),o={[ht.FullyRead]:t,[ht.Read]:r};return((yield a.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield a.isVersionSupported("v1.4")))&&(o[ht.ReadPrivate]=n),a.http.authedRequest(q.Post,s,void 0,o)})()}getJoinedRooms(){var e=Q("/joined_rooms",{});return this.http.authedRequest(q.Get,e)}getJoinedRoomMembers(e){var t=Q("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(q.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:r,since:n}=e,a=Dv(e,om);if(Object.keys(a).length===0){var s={server:t,limit:r,since:n};return this.http.authedRequest(q.Get,"/publicRooms",s)}else{var o={server:t},l=et({limit:r,since:n},a);return this.http.authedRequest(q.Post,"/publicRooms",o,l)}}createAlias(e,t){var r=Q("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(q.Put,r,void 0,n)}deleteAlias(e){var t=Q("/directory/room/$alias",{$alias:e});return this.http.authedRequest(q.Delete,t)}getLocalAliases(e){var t=Q("/rooms/$roomId/aliases",{$roomId:e}),r=Xe.V3;return this.http.authedRequest(q.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){var t=Q("/directory/room/$alias",{$alias:e});return this.http.authedRequest(q.Get,t)}getRoomDirectoryVisibility(e){var t=Q("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(q.Get,t)}setRoomDirectoryVisibility(e,t){var r=Q("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(q.Put,r,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:r}=e,n={search_term:t};return r!==void 0&&(n.limit=r),this.http.authedRequest(q.Post,"/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var r=t?Q("/profile/$userId/$info",{$userId:e,$info:t}):Q("/profile/$userId",{$userId:e});return this.http.authedRequest(q.Get,r)}doesServerSupportExtendedProfiles(){var e=this;return T(function*(){return e.doesServerSupportUnstableFeature(ul)})()}getExtendedProfileRequestPrefix(){var e=this;return T(function*(){return(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?Xe.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return T(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(q.Get,Q("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var r=this;return T(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=yield r.http.authedRequest(q.Get,Q("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield r.getExtendedProfileRequestPrefix()});return n[t]})()}setExtendedProfileProperty(e,t){var r=this;return T(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=r.getUserId();yield r.http.authedRequest(q.Put,Q("/profile/$userId/$key",{$userId:n,$key:e}),void 0,{[e]:t},{prefix:yield r.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return T(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(q.Delete,Q("/profile/$userId/$key",{$userId:r,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return T(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();return t.http.authedRequest(q.Patch,Q("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return T(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(q.Put,Q("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(q.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return T(function*(){var r="/account/3pid/add";return t.http.authedRequest(q.Post,r,void 0,e)})()}bindThreePid(e){var t=this;return T(function*(){var r="/account/3pid/bind";return t.http.authedRequest(q.Post,r,void 0,e)})()}unbindThreePid(e,t){var r=this;return T(function*(){var n="/account/3pid/unbind",a={medium:e,address:t,id_server:r.getIdentityServerUrl(!0)};return r.http.authedRequest(q.Post,n,void 0,a)})()}deleteThreePid(e,t){var r="/account/3pid/delete";return this.http.authedRequest(q.Post,r,void 0,{medium:e,address:t})}setPassword(e,t,r){var n="/account/password",a={auth:e,new_password:t,logout_devices:r};return this.http.authedRequest(q.Post,n,void 0,a)}getDevices(){return this.http.authedRequest(q.Get,"/devices")}getDevice(e){var t=Q("/devices/$device_id",{$device_id:e});return this.http.authedRequest(q.Get,t)}setDeviceDetails(e,t){var r=Q("/devices/$device_id",{$device_id:e});return this.http.authedRequest(q.Put,r,void 0,t)}deleteDevice(e,t){var r=Q("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(q.Delete,r,void 0,n)}deleteMultipleDevices(e,t){var r={devices:e};t&&(r.auth=t);var n="/delete_devices";return this.http.authedRequest(q.Post,n,void 0,r)}getPushers(){var e=this;return T(function*(){var t=yield e.http.authedRequest(q.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(r=>(r.hasOwnProperty(Ca.name)||(r[Ca.name]=!0),r))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(q.Post,t,void 0,e)}removePusher(e,t){var r="/pushers/set",n={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(q.Post,r,void 0,n)}setLocalNotificationSettings(e,t){var r="".concat(_o.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(q.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Ut.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,n){var a=Q("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(q.Put,a,void 0,n)}deletePushRule(e,t,r){var n=Q("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(q.Delete,n)}setPushRuleEnabled(e,t,r,n){var a=Q("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(q.Put,a,void 0,{enabled:n})}setPushRuleActions(e,t,r,n){var a=Q("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(q.Put,a,void 0,{actions:n})}search(e,t){var{body:r,next_batch:n}=e,a={};return n&&(a.next_batch=n),this.http.authedRequest(q.Post,"/search",a,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(q.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(q.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r={device_keys:{}};return t!==void 0&&(r.token=t),e.forEach(n=>{r.device_keys[n]=[]}),this.http.authedRequest(q.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,n={};t===void 0&&(t="signed_curve25519");for(var[a,s]of e){var o=n[a]||{};_a(n,a,o),_a(o,s,t)}var l={one_time_keys:n};r&&(l.timeout=r);var d="/keys/claim";return this.http.authedRequest(q.Post,d,void 0,l)}getKeyChanges(e,t){var r={from:e,to:t};return this.http.authedRequest(q.Get,"/keys/changes",r)}uploadDeviceSigningKeys(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(q.Post,"/keys/device_signing/upload",void 0,r,{prefix:Xe.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,Gt.V2,this.idBaseUrl);return this.http.requestOtherUrl(q.Post,t,e)}requestEmailToken(e,t,r,n,a){var s={client_secret:t,email:e,send_attempt:r?.toString()};return n&&(s.next_link=n),this.http.idServerRequest(q.Post,"/validate/email/requestToken",s,Gt.V2,a)}requestMsisdnToken(e,t,r,n,a,s){var o={client_secret:r,country:e,phone_number:t,send_attempt:n?.toString()};return a&&(o.next_link=a),this.http.idServerRequest(q.Post,"/validate/msisdn/requestToken",o,Gt.V2,s)}submitMsisdnToken(e,t,r,n){var a={sid:e,client_secret:t,token:r};return this.http.idServerRequest(q.Post,"/validate/msisdn/submitToken",a,Gt.V2,n??void 0)}submitMsisdnTokenOtherUrl(e,t,r,n){var a={sid:t,client_secret:r,token:n};return this.http.requestOtherUrl(q.Post,e,a)}getIdentityHashDetails(e){return this.http.idServerRequest(q.Get,"/hash_details",void 0,Gt.V2,e)}identityHashedLookup(e,t){var r=this;return T(function*(){var n={},a=yield r.getIdentityHashDetails(t);if(!a||!a.lookup_pepper||!a.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=a.lookup_pepper;var s={};if(a.algorithms.includes("sha256"))n.addresses=yield Promise.all(e.map(function(){var v=T(function*(m){var f=m[0].toLowerCase(),g=m[1].toLowerCase(),w=yield nh("".concat(f," ").concat(g," ").concat(n.pepper)),S=qi(w);return s[S]=m[0],S});return function(m){return v.apply(this,arguments)}}())),n.algorithm="sha256";else if(a.algorithms.includes("none"))n.addresses=e.map(v=>{var m=v[0].toLowerCase(),f=v[1].toLowerCase(),g="".concat(m," ").concat(f);return s[g]=v[0],g}),n.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var o=yield r.http.idServerRequest(q.Post,"/lookup",n,Gt.V2,t);if(!(o!=null&&o.mappings))return[];var l=[];for(var d of Object.keys(o.mappings)){var u=o.mappings[d],h=s[d];if(!h)throw new Error("Identity server returned more results than expected");l.push({address:h,mxid:u})}return l})()}lookupThreePid(e,t,r){var n=this;return T(function*(){var a=yield n.identityHashedLookup([[t,e]],r),s=a.find(l=>l.address===t);if(!s)return{};var o={address:t,medium:e,mxid:s.mxid};return o})()}bulkLookupThreePids(e,t){var r=this;return T(function*(){var n=yield r.identityHashedLookup(e.map(l=>[l[1],l[0]]),t),a=[],s=function*(d){var u=e.find(h=>h[1]===d.address);if(!u)throw new Error("Identity sever returned unexpected results");a.push([u[0],d.address,d.mxid])};for(var o of n)yield*s(o);return{threepids:a}})()}getIdentityAccount(e){return this.http.idServerRequest(q.Get,"/account",void 0,Gt.V2,e)}sendToDevice(e,t,r){var n=Q("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),a={messages:Br(t)},s=new Map;for(var[o,l]of t)s.set(o,Array.from(l.keys()));return this.logger.debug("PUT ".concat(n),s),this.http.authedRequest(q.Put,n,void 0,a)}encryptAndSendToDevice(e,t,r){var n=this;return T(function*(){if(!n.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var a=yield n.cryptoBackend.encryptToDeviceMessages(e,t,r);yield n.queueToDevice(a)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(q.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var r=Q("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(q.Get,r,t)}getThirdpartyUser(e,t){var r=Q("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(q.Get,r,t)}getTerms(e,t){var r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(q.Get,r)}agreeToTerms(e,t,r,n){var a=this.termsUrlForService(e,t),s={Authorization:"Bearer "+r};return this.http.requestOtherUrl(q.Post,a,{user_accepts:n},{headers:s})}reportEvent(e,t,r,n){var a=Q("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(q.Post,a,void 0,{score:r,reason:n})}reportRoom(e,t){var r=Q("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(q.Post,r,void 0,{reason:t})}getRoomHierarchy(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0,s=Q("/rooms/$roomId/hierarchy",{$roomId:e}),o={suggested_only:String(n),max_depth:r?.toString(),from:a,limit:t?.toString()};return this.http.authedRequest(q.Get,s,o,void 0,{prefix:Xe.V1}).catch(l=>{if(l.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(q.Get,s,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw l})}unstableCreateFileTree(e){var t=this;return T(function*(){var{room_id:r}=yield t.createRoom({name:e,preset:Za.PrivateChat,power_level_content_override:et(et({},vp),{},{users:{[t.getUserId()]:100}}),creation_content:{[Ci]:Kr.Space},initial_state:[{type:wa.name,state_key:Ta.name,content:{[Ra.name]:!0}},{type:x.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new Jd(t,r)})()}unstableGetFileTreeSpace(e){var t,r,n=this.getRoom(e);if(n?.getMyMembership()!==Ee.Join)return null;var a=n.currentState.getStateEvents(x.RoomCreate,""),s=n.currentState.getStateEvents(wa.name,Ta.name);if(!a)throw new Error("Expected single room create event");return!(s!=null&&(t=s.getContent())!==null&&t!==void 0&&t[Ra.name])||((r=a.getContent())===null||r===void 0?void 0:r[Ci])!==Kr.Space?null:new Jd(this,e)}slidingSync(e,t,r){var n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);var a=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(q.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:a,abortSignal:r})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(nt.IntentionalMentions)!==tt.Unsupported}getRoomSummary(e,t){var r=this;return T(function*(){var n={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var a=Q("/summary/$roomid",{$roomid:e});return yield r.http.authedRequest(q.Get,a,{via:t},void 0,n)}catch(o){if(o instanceof je&&o.errcode==="M_UNRECOGNIZED"){var s=Q("/rooms/$roomid/summary",{$roomid:e});return yield r.http.authedRequest(q.Get,s,{via:t},void 0,n)}else throw o}})()}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return T(function*(){return e.http.authedRequest(q.Get,"/account/whoami")})()}timestampToEvent(e,t,r){var n=this;return T(function*(){var a=Q("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:r};try{return yield n.http.authedRequest(q.Get,a,s,void 0,{prefix:Xe.V1})}catch(o){if(o.errcode==="M_UNRECOGNIZED"&&(o.httpStatus===400||o.httpStatus===404||o.httpStatus===405))return yield n.http.authedRequest(q.Get,a,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw o}})()}getAuthIssuer(){var e=this;return T(function*(){return e.http.request(q.Get,"/auth_issuer",void 0,void 0,{prefix:Xe.Unstable+"/org.matrix.msc2965"})})()}getAuthMetadata(){var e=this;return T(function*(){var t;try{t=yield e.http.request(q.Get,"/auth_metadata",void 0,void 0,{prefix:Xe.Unstable+"/org.matrix.msc2965"})}catch(n){if(n instanceof je&&n.errcode==="M_UNRECOGNIZED"){var{issuer:r}=yield e.getAuthIssuer();return as(r)}throw n}return ss(t)})()}}c(Hi,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function cu(i){return Object.fromEntries(Object.entries(i).map(e=>{var[t,r]=e;return["".concat(Ft,".").concat(t),r]}))}function cl(i,e){var t,r=i.getUserId(),n=e.getId(),a=i.getRoom(e.getRoomId());if(!(!a||!r||!n)){if(!a.findEventById(n)){E.info("Decrypted event ".concat(e.getId()," is not in room ").concat(a.roomId,": ignoring"));return}var s=!!e.threadRootId&&!e.isThreadRoot,o;if(s){var l=a.getThread(e.threadRootId);o=l?l.hasUserReadEvent(r,n):!0}else o=a.hasUserReadEvent(r,n);if(!o){var d=i.getPushActionsForEvent(e,!0),u=!!(d!=null&&(t=d.tweaks)!==null&&t!==void 0&&t.highlight);if(u){var h=a.getUnreadCountForEventContext(Me.Highlight,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,Me.Highlight,h):a.setUnreadNotificationCount(Me.Highlight,h)}var v=!!(d!=null&&d.notify);if(v){var m=a.getUnreadCountForEventContext(Me.Total,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,Me.Total,m):a.setUnreadNotificationCount(Me.Total,m)}}}}function Qr(i){return Mn(i)?Dn:i.threadRootId}function Mn(i){if(!i.threadRootId||i.isThreadRoot)return!0;if(!i.isRelation())return E.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(i.getId())),!0;if(i.isRelation(De.name))return!1;var e=i.relationEventId===i.threadRootId;return e}function hu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function vu(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):hu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var vt=function(i){return i.New="Thread.new",i.Update="Thread.update",i.NewReply="Thread.newReply",i.ViewThread="Thread.viewThread",i.Delete="Thread.delete",i}({}),dt=function(i){return i[i.None=0]="None",i[i.Experimental=1]="Experimental",i[i.Stable=2]="Stable",i}({});function wi(i,e){return i?dt.Stable:e?dt.Experimental:dt.None}class Ne extends Oc{constructor(e,t,r){var n,a;if(super(),n=this,this.id=e,this.rootEvent=t,c(this,"timelineSet",void 0),c(this,"_currentUserParticipated",!1),c(this,"reEmitter",void 0),c(this,"lastEvent",void 0),c(this,"replyCount",0),c(this,"lastPendingEvent",void 0),c(this,"pendingReplyCount",0),c(this,"room",void 0),c(this,"client",void 0),c(this,"pendingEventOrdering",void 0),c(this,"processRootEventPromise",void 0),c(this,"initialEventsFetched",!Ne.hasServerSideSupport),c(this,"initalEventFetchProm",void 0),c(this,"replayEvents",[]),c(this,"onTimelineReset",T(function*(){yield n.processRootEventPromise,n.processRootEventPromise=void 0})),c(this,"onBeforeRedaction",(s,o)=>{s!=null&&s.isRelation(De.name)&&this.room.eventShouldLiveIn(s).threadId===this.id&&s.getId()!==this.id&&!o.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(vt.Update,this))}),c(this,"onRedaction",function(){var s=T(function*(o,l,d){if(d===n.id)if(n.replyCount<=0){for(var u of n.timeline)n.clearEventMetadata(u);n.lastEvent=n.rootEvent,n._currentUserParticipated=!1,n.emit(vt.Delete,n)}else{var h;((h=n.lastEvent)===null||h===void 0?void 0:h.getId())===o.getAssociatedId()&&(yield n.processRootEventPromise,n.processRootEventPromise=void 0),yield n.updateThreadMetadata()}});return function(o,l,d){return s.apply(this,arguments)}}()),c(this,"onTimelineEvent",(s,o,l)=>{if(!l){var d=s.getSender();d&&o&&this.shouldSendLocalEchoReceipt(d,s)&&o.addLocalEchoReceipt(d,s,ht.Read),s.getId()!==this.id&&s.isRelation(De.name)&&this.replyCount++}this.onEcho(s,l??!1)}),c(this,"onLocalEcho",s=>{this.onEcho(s,!1)}),c(this,"onEcho",function(){var s=T(function*(o,l){o.threadRootId===n.id&&n.lastEvent!==o&&(yield n.updateThreadMetadata(),o.isRelation(De.name)&&(l||(n.lastEvent=void 0,n.emit(vt.NewReply,n,o))))});return function(o,l){return s.apply(this,arguments)}}()),this.setMaxListeners(1e3),!(r!=null&&r.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=r.room,this.client=r.client,this.pendingEventOrdering=(a=r.pendingEventOrdering)!==null&&a!==void 0?a:Xr.Chronological,this.timelineSet=new Wr(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new Fn(this),this.reEmitter.reEmit(this.timelineSet,[ie.Timeline,ie.TimelineReset]),this.room.on(Pe.BeforeRedaction,this.onBeforeRedaction),this.room.on(ie.Redaction,this.onRedaction),this.room.on(ie.LocalEchoUpdated,this.onLocalEcho),this.room.on(ie.TimelineReset,this.onTimelineReset),this.timelineSet.on(ie.Timeline,this.onTimelineEvent),this.processReceipts(r.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return T(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),r=e.client.getEventMapper();e.rootEvent=r(t)}catch(n){E.error("Failed to fetch thread root to construct thread with",n)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){Ne.hasServerSideSupport=e,e!==dt.Stable&&($r.setPreferUnstable(!0),Hr.setPreferUnstable(!0),De.setPreferUnstable(!0))}static setServerSideListSupport(e){Ne.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){Ne.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var r,n=(r=this.client.canSupport.get(nt.RelationsRecursion))!==null&&r!==void 0?r:tt.Unsupported;if(n===tt.Unsupported){var a,s=(a=this.getReadReceiptForUserId(e))===null||a===void 0?void 0:a.eventId;if(s){var o=this.findEventById(s);if(o&&o.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(Z.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(r=>this.addEvent(r,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var n=this.lastReply(),a=!n||e.localTimestamp>=n.localTimestamp;if(!Ne.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(Ke.Annotation)||e.isRelation(Ke.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&a?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(De.name)&&!t&&a&&(this.lastEvent=void 0),r&&(this.emit(vt.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var r,n;if(this.initialEventsFetched){var s,o=(s=this.client.canSupport.get(nt.RelationsRecursion))!==null&&s!==void 0?s:tt.Unsupported;o===tt.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var a;(a=this.replayEvents)===null||a===void 0||a.push(e)}(r=this.timelineSet.relations)===null||r===void 0||r.aggregateParentEvent(e),(n=this.timelineSet.relations)===null||n===void 0||n.aggregateChildEvent(e,this.timelineSet)}processEvent(e){var t=this;return T(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:r,userId:n,receipt:a,synthetic:s}of e)this.addReceiptToStructure(t,r,n,a,s)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e?.getServerAggregatedRelation(De.name)}processRootEvent(){var e=this;return T(function*(){var t=e.getRootEventBundledRelationship();if(Ne.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var r=e.client.getEventMapper();e.lastEvent=r(vu(vu({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===Xr.Detached?this.room.getPendingEvents():this.events,t=e.filter(r=>{var n;return r.threadRootId===this.id&&r.isRelation(De.name)&&r.status!==null&&r.getId()!==((n=this.lastEvent)===null||n===void 0?void 0:n.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var r=this;return T(function*(){var n=r.liveTimeline;r.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var a=r.liveTimeline,s,o;if(e){var l=yield r.client.createMessagesRequest(r.roomId,e,1,be.Forward);s=l.end}if(t){var d=yield r.client.createMessagesRequest(r.roomId,t,1,be.Backward);o=d.start}t&&n.getPaginationToken(be.Forward)===t&&n.setPaginationToken(o??null,be.Forward),e&&a.getPaginationToken(be.Backward)===e&&a.setPaginationToken(s??null,be.Backward)})()}updateThreadFromRootEvent(){var e=this;return T(function*(){Ne.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return T(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,be.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(ie.TimelineReset,e.room,e.timelineSet,!0)}catch(r){E.error("Failed to load start of newly created thread: ",r),e.initialEventsFetched=!1}e.emit(vt.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return T(function*(){var r,n=(r=t.client.canSupport.get(nt.RelationsRecursion))!==null&&r!==void 0?r:tt.Unsupported;if(n===tt.Unsupported){for(var a=e.length,s=new Array(a),o=0;o<a;o++)s[o]=e[o];return Promise.all(s.filter(um).map(function(){var l=T(function*(d){try{var u=yield t.client.relations(t.roomId,d.getId(),Ke.Replace,d.getType(),{limit:1});if(u.events.length){var h=u.events[0];d.makeReplaced(h),t.insertEventIntoTimeline(h)}}catch(v){E.error("Failed to load edits for encrypted thread event",v)}});return function(d){return l.apply(this,arguments)}}()))}})()}setEventMetadata(e){e&&(Z.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[De.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:n=>n.isRelation(De.name),t=this.timeline.length-1;t>=0;t--){var r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof ct}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){var a=n.getTs()<this.room.getOldestThreadedReceiptTs(),s=n.getId();if(a&&s)return s}var o=super.getEventReadUpTo(e,t);if(n){var l=this.room.getLastUnthreadedReceiptFor(e);if(!l)return o;for(var d=((u=this.timeline)===null||u===void 0?void 0:u.length)-1;d>=0;--d){var u,h,v=this.timeline[d];if(v.getId()===o)return o;if(v.getTs()<l.ts)return(h=v.getId())!==null&&h!==void 0?h:o}}return o}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,a,s,o,l,d=((r=(n=this.lastReply())===null||n===void 0?void 0:n.getTs())!==null&&r!==void 0?r:0)<this.room.getOldestThreadedReceiptTs(),u=(a=(s=this.room.getLastUnthreadedReceiptFor(e))===null||s===void 0?void 0:s.ts)!==null&&a!==void 0?a:0,h=((o=this===null||this===void 0||(l=this.lastReply())===null||l===void 0?void 0:l.getTs())!==null&&o!==void 0?o:0)<u;if(d||h)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}c(Ne,"hasServerSideSupport",dt.None);c(Ne,"hasServerSideListSupport",dt.None);c(Ne,"hasServerSideFwdPaginationSupport",dt.None);function um(i){return i.isEncrypted()&&(i.isRelation(De.name)||i.isThreadRoot)}var $r=new Ka("related_by_senders","io.element.relation_senders"),Hr=new Ka("related_by_rel_types","io.element.relation_types"),De=new Ka("m.thread","io.element.thread"),Pt=function(i){return i[i.My=0]="My",i[i.All=1]="All",i}({});function hl(i){switch(i){case Pt.My:return"participated";default:return"all"}}class fu extends Error{constructor(e,t,r){super(t),this.code=e,c(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=cm(this,r)}}function cm(i,e){var t=i.name+"[msg: "+i.message;return e&&(t+=", "+Object.keys(e).map(r=>r+": "+e[r]).join(", ")),t+="]",t}var pu=Object.freeze({visible:!0}),Pe=function(i){return i.Decrypted="Event.decrypted",i.BeforeRedaction="Event.beforeRedaction",i.VisibilityChange="Event.visibilityChange",i.LocalEventIdReplaced="Event.localEventIdReplaced",i.Status="Event.status",i.Replaced="Event.replaced",i.RelationsCreated="Event.relationsCreated",i.SentinelUpdated="Event.sentinelUpdated",i}({});class ct extends xe{setMetadata(e,t){var r,n,a=this.isState()&&this.getType()===x.RoomMember&&this.getSender()===this.getStateKey(),s=!1;if(a||!((r=this.sender)!==null&&r!==void 0&&(r=r.events)!==null&&r!==void 0&&r.member)){var o=e.getSentinelMember(this.getSender());o!==this.sender&&(s=!0),this.sender=o}if(a||!((n=this.target)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member)&&this.getType()===x.RoomMember){var l=e.getSentinelMember(this.getStateKey());l!==this.target&&(s=!0),this.target=l}this.isState()&&t&&(this.forwardLooking=!1),s&&this.emit(Pe.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,c(this,"pushDetails",{}),c(this,"_replacingEvent",null),c(this,"_localRedactionEvent",null),c(this,"_isCancelled",!1),c(this,"clearEvent",void 0),c(this,"visibility",pu),c(this,"_hasCachedExtEv",!1),c(this,"_cachedExtEv",void 0),c(this,"_decryptionFailureReason",null),c(this,"senderCurve25519Key",null),c(this,"claimedEd25519Key",null),c(this,"forwardingCurve25519KeyChain",[]),c(this,"untrusted",null),c(this,"decryptionPromise",null),c(this,"retryDecryption",!1),c(this,"txnId",void 0),c(this,"thread",void 0),c(this,"threadId",void 0),c(this,"localTimestamp",void 0),c(this,"sender",null),c(this,"target",null),c(this,"status",null),c(this,"error",null),c(this,"forwardLooking",!0),c(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach(n=>{typeof t[n]=="string"&&(t[n]=fs(t[n]))}),["membership","avatar_url","displayname"].forEach(n=>{var a;typeof((a=t.content)===null||a===void 0?void 0:a[n])=="string"&&(t.content[n]=fs(t.content[n]))}),["rel_type"].forEach(n=>{var a;typeof((a=t.content)===null||a===void 0||(a=a["m.relates_to"])===null||a===void 0?void 0:a[n])=="string"&&(t.content["m.relates_to"][n]=fs(t.content["m.relates_to"][n]))}),this.txnId=t.txn_id;var r=this.getAge();this.localTimestamp=r!==void 0?Date.now()-r:(e=this.getTs())!==null&&e!==void 0?e:Date.now(),this.reEmitter=new Fn(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=Et.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===x.RoomMessageEncrypted)for(var[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var r=this.getContent()[xi];return"msgid=".concat(r," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){var e;if(this._localRedactionEvent)return{};if(this.clearEvent){var t;return(t=this.clearEvent.content)!==null&&t!==void 0?t:{}}return(e=this.event.content)!==null&&e!==void 0?e:{}}getContent(){if(this._localRedactionEvent)return{};if(this._replacingEvent){var e;return(e=this._replacingEvent.getContent()["m.new_content"])!==null&&e!==void 0?e:{}}else return this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if(t?.rel_type===De.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var r=this.getUnsigned();if(typeof r[Oi.name]=="string")return r[Oi.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(De.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return wo.findIn(e)}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.decryptionFailureReason===Zd.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(!r.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var a=r.clearEvent&&!r.isDecryptionFailure(),s=n.forceRedecryptIfUntrusted&&r.isKeySourceUntrusted();if(a&&!s)throw new Error("Attempt to decrypt event which has already been decrypted");return r.decryptionPromise?(E.log("Event ".concat(r.getId()," already being decrypted; queueing a retry")),r.retryDecryption=!0,r.decryptionPromise):(r.decryptionPromise=r.decryptionLoop(e,n),r.decryptionPromise)})()}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){r.retryDecryption=!1;var a=void 0;try{var s=yield e.decryptEvent(r);n.isRetry===!0&&E.info("Decrypted event on retry (".concat(r.getDetails(),")")),r.setClearData(s),r._decryptionFailureReason=null}catch(l){var o=l instanceof fu?l.detailedString:String(l);if(a=l,r.retryDecryption){E.log("Error decrypting event (".concat(r.getDetails(),"), but retrying: ").concat(o));continue}E.warn("Error decrypting event (".concat(r.getDetails(),"): ").concat(o)),r.setClearDataForDecryptionFailure(String(l)),r._decryptionFailureReason=l instanceof fu?l.code:Zd.UNKNOWN_ERROR}r.decryptionPromise=null,r.retryDecryption=!1,r.setPushDetails(),n.emit!==!1&&r.emit(Pe.Decrypted,r,a);return}})()}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(r=e.claimedEd25519Key)!==null&&r!==void 0?r:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:x.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===x.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(Pe.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r,n=(t=e?.visible)!==null&&t!==void 0?t:!0,a=(r=e?.reason)!==null&&r!==void 0?r:null,s=!1;(this.visibility.visible!==n||!this.visibility.visible&&this.visibility.reason!==a)&&(s=!0),s&&(n?this.visibility=pu:this.visibility=Object.freeze({visible:!1,reason:a}),this.emit(Pe.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(Pe.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var r in this.event)this.event.hasOwnProperty(r)&&!hm.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=void 0);var n=this.getType()in mu?mu[this.getType()]:{},a=this.getContent();for(var s in a)a.hasOwnProperty(s)&&!n[s]&&delete a[s];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var r of t.events){var n;((n=r.getRelation())===null||n===void 0?void 0:n.event_id)===this.getId()&&r.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(Z.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===x.RoomRedaction}asVisibilityChange(){if(!yr.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var r=this.getWireContent(),n=!!r.visible,a=r.reason;return a&&typeof a!="string"?null:{visible:n,reason:a,eventId:t}}isVisibilityEvent(){return yr.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var r,n;return(r=(n=this.clearEvent)===null||n===void 0?void 0:n.unsigned.redacted_because)!==null&&r!==void 0?r:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,r=this.getUnsigned(),n=this.getId();this.event=e,r.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=r.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(Pe.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-((t=this.getAge())!==null&&t!==void 0?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(Pe.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(Pe.LocalEventIdReplaced,this)}isRelation(e){var t,r=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(r!=null&&r.rel_type)&&[Ke.Replace,Ke.Thread].includes(r.rel_type)?!1:!!(r!=null&&r.rel_type&&r.event_id&&(!e||r.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(Pe.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(Ke.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(Ke.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var r;return(r=this._replacingEvent.getDate())!==null&&r!==void 0?r:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new ct(JSON.parse(JSON.stringify(this.event)));for(var[t,r]of Object.entries(this))t!=="event"&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=js(this.event),r=js(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[vt.Update]),this.thread=e,this.setThreadId(e?.id),e&&this.reEmitter.reEmit(e,[vt.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}var hm=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),mu={[x.RoomMember]:{membership:1},[x.RoomJoinRules]:{join_rule:1},[x.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},wt=function(i){return i[i.NotStarted=0]="NotStarted",i[i.InProgress=1]="InProgress",i[i.Finished=2]="Finished",i}(wt||{}),Re=function(i){return i.Events="RoomState.events",i.Members="RoomState.members",i.NewMember="RoomState.newMember",i.Update="RoomState.update",i.BeaconLiveness="RoomState.BeaconLiveness",i.Marker="RoomState.Marker",i}({});class Pn extends xe{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:wt.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,c(this,"reEmitter",new Fn(this)),c(this,"sentinels",{}),c(this,"displayNameToUserIds",new Map),c(this,"userIdsToDisplayNames",{}),c(this,"tokenToInvite",{}),c(this,"joinedMemberCount",null),c(this,"summaryJoinedMemberCount",null),c(this,"invitedMemberCount",null),c(this,"summaryInvitedMemberCount",null),c(this,"modified",-1),c(this,"members",{}),c(this,"events",new Map),c(this,"paginationToken",null),c(this,"beacons",new Map),c(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ee.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Ee.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new wn(this.roomId,e);var r=this.members[e];r!=null&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var r=this.events.get(e).get(t);return r||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new Pn(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=wt.NotStarted,Array.from(this.events.values()).forEach(r=>{e.setStateEvents(Array.from(r.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==wt.Finished&&this.getMembers().forEach(r=>{if(r.isOutOfBand()){var n;(n=e.getMember(r.userId))===null||n===void 0||n.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(r=>!this.events.has(r.getType())||!this.events.get(r.getType()).has(r.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(r=>{if(!(r.getRoomId()!==this.roomId||!r.isState())){ts.matches(r.getType())&&this.setBeacon(r);var n=this.getStateEventMatching(r);if(this.setStateEvent(r),r.getType()===x.RoomMember){var a;this.updateDisplayNameCache(r.getStateKey(),(a=r.getContent().displayname)!==null&&a!==void 0?a:""),this.updateThirdPartyTokenCache(r)}this.emit(Re.Events,r,this,n)}}),this.onBeaconLivenessChange(),e.forEach(r=>{if(!(r.getRoomId()!==this.roomId||!r.isState()))if(r.getType()===x.RoomMember){var n=r.getStateKey();(r.getContent().membership===Ee.Leave||r.getContent().membership===Ee.Ban)&&(r.getContent().avatar_url=r.getContent().avatar_url||r.getPrevContent().avatar_url,r.getContent().displayname=r.getContent().displayname||r.getPrevContent().displayname);var a=this.getOrCreateMember(n,r);a.setMembershipEvent(r,this),this.updateMember(a),this.emit(Re.Members,r,this,a)}else if(r.getType()===x.RoomPowerLevels){if(r.getStateKey()!=="")return;var s=Object.values(this.members);s.forEach(o=>{var l=o.getLastModifiedTime();o.setPowerLevelEvent(r),l!==o.getLastModifiedTime()&&this.emit(Re.Members,r,this,o)}),this.sentinels={}}else Eo.matches(r.getType())&&this.emit(Re.Marker,r,t)}),this.emit(Re.Update,this)}processBeaconEvents(e,t){var r=this;return T(function*(){if(!(!e.length||!r.beacons.size)){var n=[...r.beacons.values()].reduce((d,u)=>(d[u.beaconInfoId]=u,d),{}),a=(d,u)=>{if(Ua.matches(u.getType())){var h=n[d];h&&h.addLocations([u])}},s=function*(u){var h,v=(h=u.getRelation())===null||h===void 0?void 0:h.event_id;if(!v||!n[v])return{v:void 0};if(!Ua.matches(u.getType())&&!u.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(u),a(v,u)}catch{u.isDecryptionFailure()&&u.once(Pe.Decrypted,T(function*(){a(v,u)}))}},o;for(var l of e)if(o=yield*s(l),o)return o.v}})()}getOrCreateMember(e,t){var r=this.members[e];return r||(r=new wn(this.roomId,e),this.members[e]=r,this.emit(Re.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=Pi(e);if(this.beacons.has(t)){var r=this.beacons.get(t);if(e.isRedacted()){var n;r.beaconInfoId===((n=e.getRedactionEvent())===null||n===void 0?void 0:n.redacts)&&(r.destroy(),this.beacons.delete(t));return}return r.update(e)}if(!e.isRedacted()){var a=new Mo(e);this.reEmitter.reEmit(a,[Fe.New,Fe.Update,Fe.Destroy,Fe.LivenessChange]),this.emit(Fe.New,e,a),a.on(Fe.LivenessChange,this.onBeaconLivenessChange.bind(this)),a.on(Fe.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(a.identifier,a)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(Re.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return(t=(r=this.events.get(e.getType()))===null||r===void 0?void 0:r.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(x.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===wt.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===wt.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===wt.NotStarted&&(this.oobMemberFlags.status=wt.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===wt.InProgress&&(this.oobMemberFlags.status=wt.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var r=this.members[t];r.isOutOfBand()&&(++e,delete this.members[t])}),E.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=wt.NotStarted}setOutOfBandMembers(e){E.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===wt.InProgress&&(E.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=wt.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(Re.Update,this))}setOutOfBandMember(e){if(e.getType()===x.RoomMember){var t=e.getStateKey(),r=this.getMember(t);if(!(r&&!r.isOutOfBand())){var n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(Re.Members,e,this,n)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(qr(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var r=this.getMember(t);if(!r||r.membership===Ee.Leave||e.status||e.isRedacted())return!1;var n=this.maySendEvent(x.RoomRedaction,t);return n?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",r.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var r=this.getStateEvents(x.RoomPowerLevels,""),n={};r&&(n=r.getContent());var a=50;return Ll(n[e])&&(a=n[e]),t>=a}maySendMessage(e){return this.maySendEventOfType(x.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){var n=this.getStateEvents(x.RoomPowerLevels,""),a,s={},o=0,l=0,d=0;if(n){a=n.getContent(),s=a.events||{},Number.isSafeInteger(a.state_default)?o=a.state_default:o=50;var u=a.users&&a.users[t];Number.isSafeInteger(u)?d=u:Number.isSafeInteger(a.users_default)&&(d=a.users_default),Number.isSafeInteger(a.events_default)&&(l=a.events_default)}var h=r?o:l;return Number.isSafeInteger(s[e])&&(h=s[e]),d>=h}mayTriggerNotifOfType(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents(x.RoomPowerLevels,""),a=50;return n&&n.getContent()&&n.getContent().notifications&&Ll(n.getContent().notifications[e])&&(a=n.getContent().notifications[e]),r.powerLevel>=a}getJoinRule(){var e,t=this.getStateEvents(x.RoomJoinRules,""),r=(e=t?.getContent())!==null&&e!==void 0?e:{};return r.join_rule||Ho.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(x.RoomHistoryVisibility,""),r=(e=t?.getContent())!==null&&e!==void 0?e:{};return r.history_visibility||es.Shared}getGuestAccess(){var e,t=this.getStateEvents(x.RoomGuestAccess,""),r=(e=t?.getContent())!==null&&e!==void 0?e:{};return r.guest_access||Ai.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(x.RoomPredecessor,"");if(t){var r=t.getContent(),n=r.predecessor_room_id,a=r.last_known_event_id;typeof a!="string"&&(a=void 0);var s=r.via_servers;if(Array.isArray(s)||(s=void 0),typeof n=="string")return{roomId:n,eventId:a,viaServers:s}}}var o=this.getStateEvents(x.RoomCreate,"");if(o){var l=o.getContent().predecessor;if(l){var d=l.room_id;if(typeof d=="string"){var u=l.event_id;return(typeof u!="string"||u==="")&&(u=void 0),{roomId:d,eventId:u}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var r=this.getStateEvents(x.RoomThirdPartyInvite,t);r&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){var n=qr(r),a=this.displayNameToUserIds.get(n);if(a){var s=a.filter(u=>u!==e);this.displayNameToUserIds.set(n,s)}}this.userIdsToDisplayNames[e]=t;var o=t&&qr(t);if(o){var l,d=(l=this.displayNameToUserIds.get(o))!==null&&l!==void 0?l:[];d.push(e),this.displayNameToUserIds.set(o,d)}}}function gu(i){var e=typeof i=="string"&&!!i&&i!=="undefined"&&i!=="null";return e||typeof i=="number"}class os{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};c(this,"rooms",{}),c(this,"users",{}),c(this,"syncToken",null),c(this,"filters",new or(()=>new Map)),c(this,"accountData",new Map),c(this,"localStorage",void 0),c(this,"oobMembers",new Map),c(this,"pendingEvents",{}),c(this,"clientOptions",void 0),c(this,"pendingToDeviceBatches",[]),c(this,"nextToDeviceBatchId",0),c(this,"createUser",void 0),c(this,"onRoomMember",(t,r,n)=>{var a;if(n.membership!==Ee.Invite){var s=this.users[n.userId]||((a=this.createUser)===null||a===void 0?void 0:a.call(this,n.userId));n.name&&(s.setDisplayName(n.name),n.events.member&&s.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&s.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[s.userId]=s}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(Re.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(Re.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return((r=this.filters.get(e))===null||r===void 0?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var r=this.localStorage.getItem(t);if(gu(r))return r}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{gu(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var r=!Object.keys(t.getContent()).length;r?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new or(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return T(function*(){var r;return(r=t.pendingEvents[e])!==null&&r!==void 0?r:[]})()}setPendingEvents(e,t){var r=this;return T(function*(){r.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return T(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return T(function*(){})()}}var As={},Dr={},cn={},yu;function vl(){if(yu)return cn;yu=1,Object.defineProperty(cn,"__esModule",{value:!0}),cn.WidgetApiDirection=void 0,cn.invertedDirection=e;var i=function(t){return t.ToWidget="toWidget",t.FromWidget="fromWidget",t}({});cn.WidgetApiDirection=i;function e(t){if(t===i.ToWidget)return i.FromWidget;if(t===i.FromWidget)return i.ToWidget;throw new Error("Invalid direction")}return cn}var Zt={},Su;function fl(){if(Su)return Zt;Su=1,Object.defineProperty(Zt,"__esModule",{value:!0}),Zt.UnstableApiVersion=Zt.MatrixApiVersion=Zt.CurrentApiVersions=void 0;var i=function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r}({});Zt.MatrixApiVersion=i;var e=function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",r.MSC2871="org.matrix.msc2871",r.MSC2873="org.matrix.msc2873",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r}({});Zt.UnstableApiVersion=e;var t=[i.Prerelease1,i.Prerelease2,e.MSC2762,e.MSC2762_UPDATE_STATE,e.MSC2871,e.MSC2873,e.MSC2931,e.MSC2974,e.MSC2876,e.MSC3819,e.MSC3846,e.MSC3869,e.MSC3973,e.MSC4039];return Zt.CurrentApiVersions=t,Zt}var ei={},Eu;function pl(){if(Eu)return ei;Eu=1,Object.defineProperty(ei,"__esModule",{value:!0}),ei.PostmessageTransport=void 0;var i=Va(),e=ls(),t=["message"];function r(p){"@babel/helpers - typeof";return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},r(p)}function n(p,I){if(p==null)return{};var y=a(p,I),P,L;if(Object.getOwnPropertySymbols){var V=Object.getOwnPropertySymbols(p);for(L=0;L<V.length;L++)P=V[L],!(I.indexOf(P)>=0)&&Object.prototype.propertyIsEnumerable.call(p,P)&&(y[P]=p[P])}return y}function a(p,I){if(p==null)return{};var y={},P=Object.keys(p),L,V;for(V=0;V<P.length;V++)L=P[V],!(I.indexOf(L)>=0)&&(y[L]=p[L]);return y}function s(p,I){var y=Object.keys(p);if(Object.getOwnPropertySymbols){var P=Object.getOwnPropertySymbols(p);I&&(P=P.filter(function(L){return Object.getOwnPropertyDescriptor(p,L).enumerable})),y.push.apply(y,P)}return y}function o(p){for(var I=1;I<arguments.length;I++){var y=arguments[I]!=null?arguments[I]:{};I%2?s(Object(y),!0).forEach(function(P){R(p,P,y[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(y)):s(Object(y)).forEach(function(P){Object.defineProperty(p,P,Object.getOwnPropertyDescriptor(y,P))})}return p}function l(p,I){if(!(p instanceof I))throw new TypeError("Cannot call a class as a function")}function d(p,I){for(var y=0;y<I.length;y++){var P=I[y];P.enumerable=P.enumerable||!1,P.configurable=!0,"value"in P&&(P.writable=!0),Object.defineProperty(p,C(P.key),P)}}function u(p,I,y){return I&&d(p.prototype,I),Object.defineProperty(p,"prototype",{writable:!1}),p}function h(p,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(I&&I.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),I&&v(p,I)}function v(p,I){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(P,L){return P.__proto__=L,P},v(p,I)}function m(p){var I=w();return function(){var P=S(p),L;if(I){var V=S(this).constructor;L=Reflect.construct(P,arguments,V)}else L=P.apply(this,arguments);return f(this,L)}}function f(p,I){if(I&&(r(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return g(p)}function g(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function w(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function S(p){return S=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(y){return y.__proto__||Object.getPrototypeOf(y)},S(p)}function R(p,I,y){return I=C(I),I in p?Object.defineProperty(p,I,{value:y,enumerable:!0,configurable:!0,writable:!0}):p[I]=y,p}function C(p){var I=b(p,"string");return r(I)==="symbol"?I:String(I)}function b(p,I){if(r(p)!=="object"||p===null)return p;var y=p[Symbol.toPrimitive];if(y!==void 0){var P=y.call(p,I);if(r(P)!=="object")return P;throw new TypeError("@@toPrimitive must return a primitive value.")}return(I==="string"?String:Number)(p)}var _=function(p){h(y,p);var I=m(y);function y(P,L,V,te){var ve;return l(this,y),ve=I.call(this),ve.sendDirection=P,ve.initialWidgetId=L,ve.transportWindow=V,ve.inboundWindow=te,R(g(ve),"strictOriginCheck",!1),R(g(ve),"targetOrigin","*"),R(g(ve),"timeoutSeconds",10),R(g(ve),"_ready",!1),R(g(ve),"_widgetId",null),R(g(ve),"outboundRequests",new Map),R(g(ve),"stopController",new AbortController),ve._widgetId=L,ve}return u(y,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var L="widgetapi-".concat(Date.now()),V=0,te=L;this.outboundRequests.has(te);)te="".concat(L,"-").concat(V++);return this.outboundRequests.set(te,null),te}},{key:"sendInternal",value:function(L){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),L),this.transportWindow.postMessage(L,this.targetOrigin)}},{key:"reply",value:function(L,V){return this.sendInternal(o(o({},L),{},{response:V}))}},{key:"send",value:function(L,V){return this.sendComplete(L,V).then(function(te){return te.response})}},{key:"sendComplete",value:function(L,V){var te=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var ve={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:L,data:V};return L===e.WidgetApiToWidgetAction.UpdateVisibility&&(ve.visible=V.visible),new Promise(function(Oe,H){var ee=function($){Te(),Oe($)},se=function($){Te(),H($)},de=setTimeout(function(){return se(new Error("Request timed out"))},(te.timeoutSeconds||1)*1e3),fe=function(){return se(new Error("Transport stopped"))};te.stopController.signal.addEventListener("abort",fe);var Te=function(){te.outboundRequests.delete(ve.requestId),clearTimeout(de),te.stopController.signal.removeEventListener("abort",fe)};te.outboundRequests.set(ve.requestId,{request:ve,resolve:ee,reject:se}),te.sendInternal(ve)})}},{key:"start",value:function(){var L=this;this.inboundWindow.addEventListener("message",function(V){L.handleMessage(V)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(L){if(!this.stopController.signal.aborted&&L.data&&!(this.strictOriginCheck&&L.origin!==window.origin)){var V=L.data;if(!(!V.action||!V.requestId||!V.widgetId))if(V.response){if(V.api!==this.sendDirection)return;this.handleResponse(V)}else{var te=V;if(te.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(te)}}}},{key:"handleRequest",value:function(L){if(this.widgetId){if(this.widgetId!==L.widgetId)return}else this._widgetId=L.widgetId;this.emit("message",new CustomEvent("message",{detail:L}))}},{key:"handleResponse",value:function(L){if(L.widgetId===this.widgetId){var V=this.outboundRequests.get(L.requestId);if(V)if((0,e.isErrorResponse)(L.response)){var te=L.response.error,ve=te.message,Oe=n(te,t);V.reject(new e.WidgetApiResponseError(ve,Oe))}else V.resolve(L)}}}]),y}(i.EventEmitter);return ei.PostmessageTransport=_,ei}var Lr={},bu;function ml(){if(bu)return Lr;bu=1,Object.defineProperty(Lr,"__esModule",{value:!0}),Lr.WidgetApiToWidgetAction=Lr.WidgetApiFromWidgetAction=void 0;var i=function(t){return t.SupportedApiVersions="supported_api_versions",t.Capabilities="capabilities",t.NotifyCapabilities="notify_capabilities",t.ThemeChange="theme_change",t.LanguageChange="language_change",t.TakeScreenshot="screenshot",t.UpdateVisibility="visibility",t.OpenIDCredentials="openid_credentials",t.WidgetConfig="widget_config",t.CloseModalWidget="close_modal",t.ButtonClicked="button_clicked",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.UpdateState="update_state",t.UpdateTurnServers="update_turn_servers",t}({});Lr.WidgetApiToWidgetAction=i;var e=function(t){return t.SupportedApiVersions="supported_api_versions",t.ContentLoaded="content_loaded",t.SendSticker="m.sticker",t.UpdateAlwaysOnScreen="set_always_on_screen",t.GetOpenIDCredentials="get_openid",t.CloseModalWidget="close_modal",t.OpenModalWidget="open_modal",t.SetModalButtonEnabled="set_button_enabled",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.WatchTurnServers="watch_turn_servers",t.UnwatchTurnServers="unwatch_turn_servers",t.BeeperReadRoomAccountData="com.beeper.read_room_account_data",t.MSC2876ReadEvents="org.matrix.msc2876.read_events",t.MSC2931Navigate="org.matrix.msc2931.navigate",t.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",t.MSC3869ReadRelations="org.matrix.msc3869.read_relations",t.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",t.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",t.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",t.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",t.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",t}({});return Lr.WidgetApiFromWidgetAction=e,Lr}var ti={},_u;function gl(){if(_u)return ti;_u=1,Object.defineProperty(ti,"__esModule",{value:!0}),ti.OpenIDRequestState=void 0;var i=function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e}({});return ti.OpenIDRequestState=i,ti}var ri={},wu;function Sh(){if(wu)return ri;wu=1,Object.defineProperty(ri,"__esModule",{value:!0}),ri.MatrixWidgetType=void 0;var i=function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e}({});return ri.MatrixWidgetType=i,ri}var ni={},Ru;function Eh(){if(Ru)return ni;Ru=1,Object.defineProperty(ni,"__esModule",{value:!0}),ni.BuiltInModalButtonID=void 0;var i=function(e){return e.Close="m.close",e}({});return ni.BuiltInModalButtonID=i,ni}var er={},Tu;function yl(){if(Tu)return er;Tu=1,Object.defineProperty(er,"__esModule",{value:!0}),er.WidgetEventCapability=er.EventKind=er.EventDirection=void 0;function i(v){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},i(v)}function e(v,m){var f=typeof Symbol<"u"&&v[Symbol.iterator]||v["@@iterator"];if(!f){if(Array.isArray(v)||(f=t(v))||m){f&&(v=f);var g=0,w=function(){};return{s:w,n:function(){return g>=v.length?{done:!0}:{done:!1,value:v[g++]}},e:function(_){throw _},f:w}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var S=!0,R=!1,C;return{s:function(){f=f.call(v)},n:function(){var _=f.next();return S=_.done,_},e:function(_){R=!0,C=_},f:function(){try{!S&&f.return!=null&&f.return()}finally{if(R)throw C}}}}function t(v,m){if(v){if(typeof v=="string")return r(v,m);var f=Object.prototype.toString.call(v).slice(8,-1);if(f==="Object"&&v.constructor&&(f=v.constructor.name),f==="Map"||f==="Set")return Array.from(v);if(f==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f))return r(v,m)}}function r(v,m){(m==null||m>v.length)&&(m=v.length);for(var f=0,g=new Array(m);f<m;f++)g[f]=v[f];return g}function n(v,m){if(!(v instanceof m))throw new TypeError("Cannot call a class as a function")}function a(v,m){for(var f=0;f<m.length;f++){var g=m[f];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(v,o(g.key),g)}}function s(v,m,f){return m&&a(v.prototype,m),f&&a(v,f),Object.defineProperty(v,"prototype",{writable:!1}),v}function o(v){var m=l(v,"string");return i(m)==="symbol"?m:String(m)}function l(v,m){if(i(v)!=="object"||v===null)return v;var f=v[Symbol.toPrimitive];if(f!==void 0){var g=f.call(v,m);if(i(g)!=="object")return g;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}var d=function(v){return v.Event="event",v.State="state_event",v.ToDevice="to_device",v.RoomAccount="room_account",v}({});er.EventKind=d;var u=function(v){return v.Send="send",v.Receive="receive",v}({});er.EventDirection=u;var h=function(){function v(m,f,g,w,S){n(this,v),this.direction=m,this.eventType=f,this.kind=g,this.keyStr=w,this.raw=S}return s(v,[{key:"matchesAsStateEvent",value:function(f,g,w){return this.kind!==d.State||this.direction!==f||this.eventType!==g?!1:this.keyStr===null||this.keyStr===w}},{key:"matchesAsToDeviceEvent",value:function(f,g){return!(this.kind!==d.ToDevice||this.direction!==f||this.eventType!==g)}},{key:"matchesAsRoomEvent",value:function(f,g){var w=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==d.Event||this.direction!==f||this.eventType!==g)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===w)return!0}else return!0;return!1}},{key:"matchesAsRoomAccountData",value:function(f,g){return!(this.kind!==d.RoomAccount||this.direction!==f||this.eventType!==g)}}],[{key:"forStateEvent",value:function(f,g,w){g=g.replace(/#/g,"\\#"),w=w!=null?"#".concat(w):"";var S="org.matrix.msc2762.".concat(f,".state_event:").concat(g).concat(w);return v.findEventCapabilities([S])[0]}},{key:"forToDeviceEvent",value:function(f,g){var w="org.matrix.msc3819.".concat(f,".to_device:").concat(g);return v.findEventCapabilities([w])[0]}},{key:"forRoomEvent",value:function(f,g){var w="org.matrix.msc2762.".concat(f,".event:").concat(g);return v.findEventCapabilities([w])[0]}},{key:"forRoomMessageEvent",value:function(f,g){g=g??"";var w="org.matrix.msc2762.".concat(f,".event:m.room.message#").concat(g);return v.findEventCapabilities([w])[0]}},{key:"forRoomAccountData",value:function(f,g){var w="com.beeper.capabilities.".concat(f,".room_account_data:").concat(g);return v.findEventCapabilities([w])[0]}},{key:"findEventCapabilities",value:function(f){var g=[],w=e(f),S;try{for(w.s();!(S=w.n()).done;){var R=S.value,C=null,b=void 0,_=null;if(R.startsWith("org.matrix.msc2762.send.event:")?(C=u.Send,_=d.Event,b=R.substring(30)):R.startsWith("org.matrix.msc2762.send.state_event:")?(C=u.Send,_=d.State,b=R.substring(36)):R.startsWith("org.matrix.msc3819.send.to_device:")?(C=u.Send,_=d.ToDevice,b=R.substring(34)):R.startsWith("org.matrix.msc2762.receive.event:")?(C=u.Receive,_=d.Event,b=R.substring(33)):R.startsWith("org.matrix.msc2762.receive.state_event:")?(C=u.Receive,_=d.State,b=R.substring(39)):R.startsWith("org.matrix.msc3819.receive.to_device:")?(C=u.Receive,_=d.ToDevice,b=R.substring(37)):R.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(C=u.Receive,_=d.RoomAccount,b=R.substring(50)),!(C===null||_===null||b===void 0)){var p=b.startsWith("m.room.message#")||_===d.State,I=null;if(b.includes("#")&&p){var y=b.split("#"),P=y.findIndex(function(L){return!L.endsWith("\\")});b=y.slice(0,P+1).map(function(L){return L.endsWith("\\")?L.substring(0,L.length-1):L}).join("#"),I=y.slice(P+1).join("#")}g.push(new v(C,b,_,I,R))}}}catch(L){w.e(L)}finally{w.f()}return g}}]),v}();return er.WidgetEventCapability=h,er}var ii={},Iu;function Sl(){if(Iu)return ii;Iu=1,Object.defineProperty(ii,"__esModule",{value:!0}),ii.Symbols=void 0;var i=function(e){return e.AnyRoom="*",e}({});return ii.Symbols=i,ii}var Cu;function vm(){if(Cu)return Dr;Cu=1;function i($){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(X){return typeof X}:function(X){return X&&typeof Symbol=="function"&&X.constructor===Symbol&&X!==Symbol.prototype?"symbol":typeof X},i($)}Object.defineProperty(Dr,"__esModule",{value:!0}),Dr.WidgetApiResponseError=Dr.WidgetApi=void 0;var e=Va(),t=vl(),r=fl(),n=pl(),a=ml(),s=gl(),o=Sh(),l=Eh(),d=yl(),u=Sl();function h(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */h=function(){return $};var $={},X=Object.prototype,F=X.hasOwnProperty,D=Object.defineProperty||function(ne,z,W){ne[z]=W.value},A=typeof Symbol=="function"?Symbol:{},k=A.iterator||"@@iterator",M=A.asyncIterator||"@@asyncIterator",N=A.toStringTag||"@@toStringTag";function O(ne,z,W){return Object.defineProperty(ne,z,{value:W,enumerable:!0,configurable:!0,writable:!0}),ne[z]}try{O({},"")}catch{O=function(W,K,G){return W[K]=G}}function j(ne,z,W,K){var G=z&&z.prototype instanceof J?z:J,Y=Object.create(G.prototype),ce=new jn(K||[]);return D(Y,"_invoke",{value:oe(ne,W,ce)}),Y}function U(ne,z,W){try{return{type:"normal",arg:ne.call(z,W)}}catch(K){return{type:"throw",arg:K}}}$.wrap=j;var B={};function J(){}function ue(){}function re(){}var Ae={};O(Ae,k,function(){return this});var ge=Object.getPrototypeOf,le=ge&&ge(ge(Ir([])));le&&le!==X&&F.call(le,k)&&(Ae=le);var Be=re.prototype=J.prototype=Object.create(Ae);function at(ne){["next","throw","return"].forEach(function(z){O(ne,z,function(W){return this._invoke(z,W)})})}function st(ne,z){function W(G,Y,ce,he){var Ie=U(ne[G],ne,Y);if(Ie.type!=="throw"){var Ve=Ie.arg,Ge=Ve.value;return Ge&&i(Ge)=="object"&&F.call(Ge,"__await")?z.resolve(Ge.__await).then(function(ft){W("next",ft,ce,he)},function(ft){W("throw",ft,ce,he)}):z.resolve(Ge).then(function(ft){Ve.value=ft,ce(Ve)},function(ft){return W("throw",ft,ce,he)})}he(Ie.arg)}var K;D(this,"_invoke",{value:function(Y,ce){function he(){return new z(function(Ie,Ve){W(Y,ce,Ie,Ve)})}return K=K?K.then(he,he):he()}})}function oe(ne,z,W){var K="suspendedStart";return function(G,Y){if(K==="executing")throw new Error("Generator is already running");if(K==="completed"){if(G==="throw")throw Y;return rn()}for(W.method=G,W.arg=Y;;){var ce=W.delegate;if(ce){var he=He(ce,W);if(he){if(he===B)continue;return he}}if(W.method==="next")W.sent=W._sent=W.arg;else if(W.method==="throw"){if(K==="suspendedStart")throw K="completed",W.arg;W.dispatchException(W.arg)}else W.method==="return"&&W.abrupt("return",W.arg);K="executing";var Ie=U(ne,z,W);if(Ie.type==="normal"){if(K=W.done?"completed":"suspendedYield",Ie.arg===B)continue;return{value:Ie.arg,done:W.done}}Ie.type==="throw"&&(K="completed",W.method="throw",W.arg=Ie.arg)}}}function He(ne,z){var W=z.method,K=ne.iterator[W];if(K===void 0)return z.delegate=null,W==="throw"&&ne.iterator.return&&(z.method="return",z.arg=void 0,He(ne,z),z.method==="throw")||W!=="return"&&(z.method="throw",z.arg=new TypeError("The iterator does not provide a '"+W+"' method")),B;var G=U(K,ne.iterator,z.arg);if(G.type==="throw")return z.method="throw",z.arg=G.arg,z.delegate=null,B;var Y=G.arg;return Y?Y.done?(z[ne.resultName]=Y.value,z.next=ne.nextLoc,z.method!=="return"&&(z.method="next",z.arg=void 0),z.delegate=null,B):Y:(z.method="throw",z.arg=new TypeError("iterator result is not an object"),z.delegate=null,B)}function xn(ne){var z={tryLoc:ne[0]};1 in ne&&(z.catchLoc=ne[1]),2 in ne&&(z.finallyLoc=ne[2],z.afterLoc=ne[3]),this.tryEntries.push(z)}function tn(ne){var z=ne.completion||{};z.type="normal",delete z.arg,ne.completion=z}function jn(ne){this.tryEntries=[{tryLoc:"root"}],ne.forEach(xn,this),this.reset(!0)}function Ir(ne){if(ne){var z=ne[k];if(z)return z.call(ne);if(typeof ne.next=="function")return ne;if(!isNaN(ne.length)){var W=-1,K=function G(){for(;++W<ne.length;)if(F.call(ne,W))return G.value=ne[W],G.done=!1,G;return G.value=void 0,G.done=!0,G};return K.next=K}}return{next:rn}}function rn(){return{value:void 0,done:!0}}return ue.prototype=re,D(Be,"constructor",{value:re,configurable:!0}),D(re,"constructor",{value:ue,configurable:!0}),ue.displayName=O(re,N,"GeneratorFunction"),$.isGeneratorFunction=function(ne){var z=typeof ne=="function"&&ne.constructor;return!!z&&(z===ue||(z.displayName||z.name)==="GeneratorFunction")},$.mark=function(ne){return Object.setPrototypeOf?Object.setPrototypeOf(ne,re):(ne.__proto__=re,O(ne,N,"GeneratorFunction")),ne.prototype=Object.create(Be),ne},$.awrap=function(ne){return{__await:ne}},at(st.prototype),O(st.prototype,M,function(){return this}),$.AsyncIterator=st,$.async=function(ne,z,W,K,G){G===void 0&&(G=Promise);var Y=new st(j(ne,z,W,K),G);return $.isGeneratorFunction(z)?Y:Y.next().then(function(ce){return ce.done?ce.value:Y.next()})},at(Be),O(Be,N,"Generator"),O(Be,k,function(){return this}),O(Be,"toString",function(){return"[object Generator]"}),$.keys=function(ne){var z=Object(ne),W=[];for(var K in z)W.push(K);return W.reverse(),function G(){for(;W.length;){var Y=W.pop();if(Y in z)return G.value=Y,G.done=!1,G}return G.done=!0,G}},$.values=Ir,jn.prototype={constructor:jn,reset:function(z){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(tn),!z)for(var W in this)W.charAt(0)==="t"&&F.call(this,W)&&!isNaN(+W.slice(1))&&(this[W]=void 0)},stop:function(){this.done=!0;var z=this.tryEntries[0].completion;if(z.type==="throw")throw z.arg;return this.rval},dispatchException:function(z){if(this.done)throw z;var W=this;function K(Ve,Ge){return ce.type="throw",ce.arg=z,W.next=Ve,Ge&&(W.method="next",W.arg=void 0),!!Ge}for(var G=this.tryEntries.length-1;G>=0;--G){var Y=this.tryEntries[G],ce=Y.completion;if(Y.tryLoc==="root")return K("end");if(Y.tryLoc<=this.prev){var he=F.call(Y,"catchLoc"),Ie=F.call(Y,"finallyLoc");if(he&&Ie){if(this.prev<Y.catchLoc)return K(Y.catchLoc,!0);if(this.prev<Y.finallyLoc)return K(Y.finallyLoc)}else if(he){if(this.prev<Y.catchLoc)return K(Y.catchLoc,!0)}else{if(!Ie)throw new Error("try statement without catch or finally");if(this.prev<Y.finallyLoc)return K(Y.finallyLoc)}}}},abrupt:function(z,W){for(var K=this.tryEntries.length-1;K>=0;--K){var G=this.tryEntries[K];if(G.tryLoc<=this.prev&&F.call(G,"finallyLoc")&&this.prev<G.finallyLoc){var Y=G;break}}Y&&(z==="break"||z==="continue")&&Y.tryLoc<=W&&W<=Y.finallyLoc&&(Y=null);var ce=Y?Y.completion:{};return ce.type=z,ce.arg=W,Y?(this.method="next",this.next=Y.finallyLoc,B):this.complete(ce)},complete:function(z,W){if(z.type==="throw")throw z.arg;return z.type==="break"||z.type==="continue"?this.next=z.arg:z.type==="return"?(this.rval=this.arg=z.arg,this.method="return",this.next="end"):z.type==="normal"&&W&&(this.next=W),B},finish:function(z){for(var W=this.tryEntries.length-1;W>=0;--W){var K=this.tryEntries[W];if(K.finallyLoc===z)return this.complete(K.completion,K.afterLoc),tn(K),B}},catch:function(z){for(var W=this.tryEntries.length-1;W>=0;--W){var K=this.tryEntries[W];if(K.tryLoc===z){var G=K.completion;if(G.type==="throw"){var Y=G.arg;tn(K)}return Y}}throw new Error("illegal catch attempt")},delegateYield:function(z,W,K){return this.delegate={iterator:Ir(z),resultName:W,nextLoc:K},this.method==="next"&&(this.arg=void 0),B}},$}function v($,X,F,D,A,k,M){try{var N=$[k](M),O=N.value}catch(j){F(j);return}N.done?X(O):Promise.resolve(O).then(D,A)}function m($){return function(){var X=this,F=arguments;return new Promise(function(D,A){var k=$.apply(X,F);function M(O){v(k,D,A,M,N,"next",O)}function N(O){v(k,D,A,M,N,"throw",O)}M(void 0)})}}function f($,X){var F=Object.keys($);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols($);X&&(D=D.filter(function(A){return Object.getOwnPropertyDescriptor($,A).enumerable})),F.push.apply(F,D)}return F}function g($){for(var X=1;X<arguments.length;X++){var F=arguments[X]!=null?arguments[X]:{};X%2?f(Object(F),!0).forEach(function(D){w($,D,F[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties($,Object.getOwnPropertyDescriptors(F)):f(Object(F)).forEach(function(D){Object.defineProperty($,D,Object.getOwnPropertyDescriptor(F,D))})}return $}function w($,X,F){return X=C(X),X in $?Object.defineProperty($,X,{value:F,enumerable:!0,configurable:!0,writable:!0}):$[X]=F,$}function S($,X){for(var F=0;F<X.length;F++){var D=X[F];D.enumerable=D.enumerable||!1,D.configurable=!0,"value"in D&&(D.writable=!0),Object.defineProperty($,C(D.key),D)}}function R($,X,F){return X&&S($.prototype,X),Object.defineProperty($,"prototype",{writable:!1}),$}function C($){var X=b($,"string");return i(X)==="symbol"?X:String(X)}function b($,X){if(i($)!=="object"||$===null)return $;var F=$[Symbol.toPrimitive];if(F!==void 0){var D=F.call($,X);if(i(D)!=="object")return D;throw new TypeError("@@toPrimitive must return a primitive value.")}return(X==="string"?String:Number)($)}function _($,X){if(!($ instanceof X))throw new TypeError("Cannot call a class as a function")}function p($,X){if(typeof X!="function"&&X!==null)throw new TypeError("Super expression must either be null or a function");$.prototype=Object.create(X&&X.prototype,{constructor:{value:$,writable:!0,configurable:!0}}),Object.defineProperty($,"prototype",{writable:!1}),X&&Oe($,X)}function I($){var X=te();return function(){var D=H($),A;if(X){var k=H(this).constructor;A=Reflect.construct(D,arguments,k)}else A=D.apply(this,arguments);return y(this,A)}}function y($,X){if(X&&(i(X)==="object"||typeof X=="function"))return X;if(X!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return P($)}function P($){if($===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return $}function L($){var X=typeof Map=="function"?new Map:void 0;return L=function(D){if(D===null||!ve(D))return D;if(typeof D!="function")throw new TypeError("Super expression must either be null or a function");if(typeof X<"u"){if(X.has(D))return X.get(D);X.set(D,A)}function A(){return V(D,arguments,H(this).constructor)}return A.prototype=Object.create(D.prototype,{constructor:{value:A,enumerable:!1,writable:!0,configurable:!0}}),Oe(A,D)},L($)}function V($,X,F){return te()?V=Reflect.construct.bind():V=function(A,k,M){var N=[null];N.push.apply(N,k);var O=Function.bind.apply(A,N),j=new O;return M&&Oe(j,M.prototype),j},V.apply(null,arguments)}function te(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ve($){return Function.toString.call($).indexOf("[native code]")!==-1}function Oe($,X){return Oe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(D,A){return D.__proto__=A,D},Oe($,X)}function H($){return H=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(F){return F.__proto__||Object.getPrototypeOf(F)},H($)}function ee($){return new fe($,0)}function se($){return function(){return new de($.apply(this,arguments))}}function de($){var X,F;function D(k,M){try{var N=$[k](M),O=N.value,j=O instanceof fe;Promise.resolve(j?O.v:O).then(function(U){if(j){var B=k==="return"?"return":"next";if(!O.k||U.done)return D(B,U);U=$[B](U).value}A(N.done?"return":"normal",U)},function(U){D("throw",U)})}catch(U){A("throw",U)}}function A(k,M){switch(k){case"return":X.resolve({value:M,done:!0});break;case"throw":X.reject(M);break;default:X.resolve({value:M,done:!1})}(X=X.next)?D(X.key,X.arg):F=null}this._invoke=function(k,M){return new Promise(function(N,O){var j={key:k,arg:M,resolve:N,reject:O,next:null};F?F=F.next=j:(X=F=j,D(k,M))})},typeof $.return!="function"&&(this.return=void 0)}de.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},de.prototype.next=function($){return this._invoke("next",$)},de.prototype.throw=function($){return this._invoke("throw",$)},de.prototype.return=function($){return this._invoke("return",$)};function fe($,X){this.v=$,this.k=X}var Te=function($){p(F,$);var X=I(F);function F(D,A){var k;return _(this,F),k=X.call(this,D),k.data=A,k}return R(F)}(L(Error));Dr.WidgetApiResponseError=Te,Te.prototype.name=Te.name;var Ze=function($){p(F,$);var X=I(F);function F(){var D,A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,k=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(_(this,F),D=X.call(this),D.clientOrigin=k,w(P(D),"transport",void 0),w(P(D),"capabilitiesFinished",!1),w(P(D),"supportsMSC2974Renegotiate",!1),w(P(D),"requestedCapabilities",[]),w(P(D),"approvedCapabilities",void 0),w(P(D),"cachedClientVersions",void 0),w(P(D),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return D.transport=new n.PostmessageTransport(t.WidgetApiDirection.FromWidget,A,window.parent,window),D.transport.targetOrigin=k,D.transport.on("message",D.handleMessage.bind(P(D))),D}return R(F,[{key:"hasCapability",value:function(A){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(A):this.requestedCapabilities.includes(A)}},{key:"requestCapability",value:function(A){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(A)}},{key:"requestCapabilities",value:function(A){var k=this;A.forEach(function(M){return k.requestCapability(M)})}},{key:"requestCapabilityForRoomTimeline",value:function(A){this.requestCapability("org.matrix.msc2762.timeline:".concat(A))}},{key:"requestCapabilityToSendState",value:function(A,k){this.requestCapability(d.WidgetEventCapability.forStateEvent(d.EventDirection.Send,A,k).raw)}},{key:"requestCapabilityToReceiveState",value:function(A,k){this.requestCapability(d.WidgetEventCapability.forStateEvent(d.EventDirection.Receive,A,k).raw)}},{key:"requestCapabilityToSendToDevice",value:function(A){this.requestCapability(d.WidgetEventCapability.forToDeviceEvent(d.EventDirection.Send,A).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(A){this.requestCapability(d.WidgetEventCapability.forToDeviceEvent(d.EventDirection.Receive,A).raw)}},{key:"requestCapabilityToSendEvent",value:function(A){this.requestCapability(d.WidgetEventCapability.forRoomEvent(d.EventDirection.Send,A).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(A){this.requestCapability(d.WidgetEventCapability.forRoomEvent(d.EventDirection.Receive,A).raw)}},{key:"requestCapabilityToSendMessage",value:function(A){this.requestCapability(d.WidgetEventCapability.forRoomMessageEvent(d.EventDirection.Send,A).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(A){this.requestCapability(d.WidgetEventCapability.forRoomMessageEvent(d.EventDirection.Receive,A).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(A){this.requestCapability(d.WidgetEventCapability.forRoomAccountData(d.EventDirection.Receive,A).raw)}},{key:"requestOpenIDConnectToken",value:function(){var A=this;return new Promise(function(k,M){A.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(N){var O=N.response;if(O.state===s.OpenIDRequestState.Allowed)k(O);else if(O.state===s.OpenIDRequestState.Blocked)M(new Error("User declined to verify their identity"));else if(O.state===s.OpenIDRequestState.PendingUserConfirmation){var j=function U(B){B.preventDefault();var J=B.detail;J.data.original_request_id===N.requestId&&(J.data.state===s.OpenIDRequestState.Allowed?(k(J.data),A.transport.reply(J,{})):J.data.state===s.OpenIDRequestState.Blocked?(M(new Error("User declined to verify their identity")),A.transport.reply(J,{})):(M(new Error("Invalid state on reply: "+O.state)),A.transport.reply(J,{error:{message:"Invalid state"}})),A.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),U))};A.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),j)}else M(new Error("Invalid state: "+O.state))}).catch(M)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(A){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,A).then()}},{key:"setAlwaysOnScreen",value:function(A){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:A}).then(function(k){return k.success})}},{key:"openModalWidget",value:function(A,k){var M=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],N=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},O=arguments.length>4&&arguments[4]!==void 0?arguments[4]:o.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:O,url:A,name:k,buttons:M,data:N}).then()}},{key:"closeModalWidget",value:function(){var A=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,A).then()}},{key:"sendRoomEvent",value:function(A,k,M,N,O){return this.sendEvent(A,void 0,k,M,N,O)}},{key:"sendStateEvent",value:function(A,k,M,N,O,j){return this.sendEvent(A,k,M,N,O,j)}},{key:"sendEvent",value:function(A,k,M,N,O,j){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,g(g(g(g({type:A,content:M},k!==void 0&&{state_key:k}),N!==void 0&&{room_id:N}),O!==void 0&&{delay:O}),j!==void 0&&{parent_delay_id:j}))}},{key:"updateDelayedEvent",value:function(A,k){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:A,action:k})}},{key:"sendToDevice",value:function(A,k,M){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:A,encrypted:k,messages:M})}},{key:"readRoomAccountData",value:function(A,k){var M={type:A};return k&&(k.includes(u.Symbols.AnyRoom)?M.room_ids=u.Symbols.AnyRoom:M.room_ids=k),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,M).then(function(N){return N.events})}},{key:"readRoomEvents",value:function(A,k,M,N,O){var j={type:A,msgtype:M};return k!==void 0&&(j.limit=k),N&&(N.includes(u.Symbols.AnyRoom)?j.room_ids=u.Symbols.AnyRoom:j.room_ids=N),O&&(j.since=O),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,j).then(function(U){return U.events})}},{key:"readEventRelations",value:function(){var D=m(h().mark(function k(M,N,O,j,U,B,J,ue){var re,Ae;return h().wrap(function(le){for(;;)switch(le.prev=le.next){case 0:return le.next=2,this.getClientVersions();case 2:if(re=le.sent,re.includes(r.UnstableApiVersion.MSC3869)){le.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return Ae={event_id:M,rel_type:O,event_type:j,room_id:N,to:J,from:B,limit:U,direction:ue},le.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,Ae));case 7:case"end":return le.stop()}},k,this)}));function A(k,M,N,O,j,U,B,J){return D.apply(this,arguments)}return A}()},{key:"readStateEvents",value:function(A,k,M,N){var O={type:A,state_key:M===void 0?!0:M};return k!==void 0&&(O.limit=k),N&&(N.includes(u.Symbols.AnyRoom)?O.room_ids=u.Symbols.AnyRoom:O.room_ids=N),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,O).then(function(j){return j.events})}},{key:"setModalButtonEnabled",value:function(A,k){if(A===l.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:A,enabled:k}).then()}},{key:"navigateTo",value:function(A){if(!A||!A.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:A}).then()}},{key:"getTurnServers",value:function(){var A=this;return se(h().mark(function k(){var M,N;return h().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(N=function(){var U=m(h().mark(function B(J){return h().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:return J.preventDefault(),M(J.detail.data),re.next=4,A.transport.reply(J.detail,{});case 4:case"end":return re.stop()}},B)}));return function(J){return U.apply(this,arguments)}}(),A.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),N),A.turnServerWatchers!==0){j.next=12;break}return j.prev=3,j.next=6,ee(A.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:j.next=12;break;case 8:throw j.prev=8,j.t0=j.catch(3),A.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),N),j.t0;case 12:A.turnServerWatchers++,j.prev=13;case 14:return j.next=17,ee(new Promise(function(U){return M=U}));case 17:return j.next=19,j.sent;case 19:j.next=14;break;case 21:if(j.prev=21,A.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),N),A.turnServerWatchers--,A.turnServerWatchers!==0){j.next=27;break}return j.next=27,ee(A.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return j.finish(21);case 28:case"end":return j.stop()}},k,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:function(){var D=m(h().mark(function k(M,N){var O,j;return h().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:return B.next=2,this.getClientVersions();case 2:if(O=B.sent,O.includes(r.UnstableApiVersion.MSC3973)){B.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return j={search_term:M,limit:N},B.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,j));case 7:case"end":return B.stop()}},k,this)}));function A(k,M){return D.apply(this,arguments)}return A}()},{key:"getMediaConfig",value:function(){var D=m(h().mark(function k(){var M,N;return h().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:return j.next=2,this.getClientVersions();case 2:if(M=j.sent,M.includes(r.UnstableApiVersion.MSC4039)){j.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return N={},j.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,N));case 7:case"end":return j.stop()}},k,this)}));function A(){return D.apply(this,arguments)}return A}()},{key:"uploadFile",value:function(){var D=m(h().mark(function k(M){var N,O;return h().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:return U.next=2,this.getClientVersions();case 2:if(N=U.sent,N.includes(r.UnstableApiVersion.MSC4039)){U.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return O={file:M},U.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,O));case 7:case"end":return U.stop()}},k,this)}));function A(k){return D.apply(this,arguments)}return A}()},{key:"downloadFile",value:function(){var D=m(h().mark(function k(M){var N,O;return h().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:return U.next=2,this.getClientVersions();case 2:if(N=U.sent,N.includes(r.UnstableApiVersion.MSC4039)){U.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return O={content_uri:M},U.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,O));case 7:case"end":return U.stop()}},k,this)}));function A(k){return D.apply(this,arguments)}return A}()},{key:"start",value:function(){var A=this;this.transport.start(),this.getClientVersions().then(function(k){k.includes(r.UnstableApiVersion.MSC2974)&&(A.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(A){var k=new CustomEvent("action:".concat(A.detail.action),{detail:A.detail,cancelable:!0});if(this.emit("action:".concat(A.detail.action),k),!k.defaultPrevented)switch(A.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(A.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(A.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(A.detail,{});case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(A.detail,{});default:return this.transport.reply(A.detail,{error:{message:"Unknown or unsupported action: "+A.detail.action}})}}},{key:"replyVersions",value:function(A){this.transport.reply(A,{supported_versions:r.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var A=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(k){return A.cachedClientVersions=k.supported_versions,k.supported_versions}).catch(function(k){return console.warn("non-fatal error getting supported client versions: ",k),[]})}},{key:"handleCapabilities",value:function(A){var k=this;return this.capabilitiesFinished?this.transport.reply(A,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(M){return M.includes(r.UnstableApiVersion.MSC2871)?k.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),function(N){k.approvedCapabilities=N.detail.data.approved,k.emit("ready")}):k.emit("ready"),k.capabilitiesFinished=!0,k.transport.reply(A,{capabilities:k.requestedCapabilities})})}}]),F}(e.EventEmitter);return Dr.WidgetApi=Ze,Dr}var ai={},Ct={},Ou;function bh(){if(Ou)return Ct;Ou=1,Object.defineProperty(Ct,"__esModule",{value:!0}),Ct.VideoConferenceCapabilities=Ct.StickerpickerCapabilities=Ct.MatrixCapabilities=void 0,Ct.getTimelineRoomIDFromCapability=a,Ct.isTimelineCapability=r,Ct.isTimelineCapabilityFor=n;var i=function(s){return s.Screenshots="m.capability.screenshot",s.StickerSending="m.sticker",s.AlwaysOnScreen="m.always_on_screen",s.RequiresClient="io.element.requires_client",s.MSC2931Navigate="org.matrix.msc2931.navigate",s.MSC3846TurnServers="town.robin.msc3846.turn_servers",s.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",s.MSC4039UploadFile="org.matrix.msc4039.upload_file",s.MSC4039DownloadFile="org.matrix.msc4039.download_file",s.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",s.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",s}({});Ct.MatrixCapabilities=i;var e=[i.StickerSending];Ct.StickerpickerCapabilities=e;var t=[i.AlwaysOnScreen];Ct.VideoConferenceCapabilities=t;function r(s){return s?.startsWith("org.matrix.msc2762.timeline:")}function n(s,o){return s==="org.matrix.msc2762.timeline:".concat(o)}function a(s){return s.substring(s.indexOf(":")+1)}return Ct}var si={},Mu;function _h(){if(Mu)return si;Mu=1,Object.defineProperty(si,"__esModule",{value:!0}),si.SimpleObservable=void 0;function i(h){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},i(h)}function e(h,v){var m=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(!m){if(Array.isArray(h)||(m=t(h))||v){m&&(h=m);var f=0,g=function(){};return{s:g,n:function(){return f>=h.length?{done:!0}:{done:!1,value:h[f++]}},e:function(b){throw b},f:g}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var w=!0,S=!1,R;return{s:function(){m=m.call(h)},n:function(){var b=m.next();return w=b.done,b},e:function(b){S=!0,R=b},f:function(){try{!w&&m.return!=null&&m.return()}finally{if(S)throw R}}}}function t(h,v){if(h){if(typeof h=="string")return r(h,v);var m=Object.prototype.toString.call(h).slice(8,-1);if(m==="Object"&&h.constructor&&(m=h.constructor.name),m==="Map"||m==="Set")return Array.from(h);if(m==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(m))return r(h,v)}}function r(h,v){(v==null||v>h.length)&&(v=h.length);for(var m=0,f=new Array(v);m<v;m++)f[m]=h[m];return f}function n(h,v){if(!(h instanceof v))throw new TypeError("Cannot call a class as a function")}function a(h,v){for(var m=0;m<v.length;m++){var f=v[m];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(h,l(f.key),f)}}function s(h,v,m){return v&&a(h.prototype,v),Object.defineProperty(h,"prototype",{writable:!1}),h}function o(h,v,m){return v=l(v),v in h?Object.defineProperty(h,v,{value:m,enumerable:!0,configurable:!0,writable:!0}):h[v]=m,h}function l(h){var v=d(h,"string");return i(v)==="symbol"?v:String(v)}function d(h,v){if(i(h)!=="object"||h===null)return h;var m=h[Symbol.toPrimitive];if(m!==void 0){var f=m.call(h,v);if(i(f)!=="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return(v==="string"?String:Number)(h)}var u=function(){function h(v){n(this,h),o(this,"listeners",[]),v&&this.listeners.push(v)}return s(h,[{key:"onUpdate",value:function(m){this.listeners.push(m)}},{key:"update",value:function(m){var f=e(this.listeners),g;try{for(f.s();!(g=f.n()).done;){var w=g.value;w(m)}}catch(S){f.e(S)}finally{f.f()}}},{key:"close",value:function(){this.listeners=[]}}]),h}();return si.SimpleObservable=u,si}var oi={},Pu;function wh(){if(Pu)return oi;Pu=1,Object.defineProperty(oi,"__esModule",{value:!0}),oi.UpdateDelayedEventAction=void 0;var i=function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e}({});return oi.UpdateDelayedEventAction=i,oi}var ku;function fm(){if(ku)return ai;ku=1,Object.defineProperty(ai,"__esModule",{value:!0}),ai.ClientWidgetApi=void 0;var i=Va(),e=pl(),t=vl(),r=ml(),n=bh(),a=fl(),s=yl(),o=gl(),l=_h(),d=Sl(),u=wh();function h(F){"@babel/helpers - typeof";return h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(D){return typeof D}:function(D){return D&&typeof Symbol=="function"&&D.constructor===Symbol&&D!==Symbol.prototype?"symbol":typeof D},h(F)}function v(F,D){var A=Object.keys(F);if(Object.getOwnPropertySymbols){var k=Object.getOwnPropertySymbols(F);D&&(k=k.filter(function(M){return Object.getOwnPropertyDescriptor(F,M).enumerable})),A.push.apply(A,k)}return A}function m(F){for(var D=1;D<arguments.length;D++){var A=arguments[D]!=null?arguments[D]:{};D%2?v(Object(A),!0).forEach(function(k){de(F,k,A[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(F,Object.getOwnPropertyDescriptors(A)):v(Object(A)).forEach(function(k){Object.defineProperty(F,k,Object.getOwnPropertyDescriptor(A,k))})}return F}function f(F,D){var A=typeof Symbol<"u"&&F[Symbol.iterator]||F["@@iterator"];if(!A){if(Array.isArray(F)||(A=S(F))||D){A&&(F=A);var k=0,M=function(){};return{s:M,n:function(){return k>=F.length?{done:!0}:{done:!1,value:F[k++]}},e:function(B){throw B},f:M}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var N=!0,O=!1,j;return{s:function(){A=A.call(F)},n:function(){var B=A.next();return N=B.done,B},e:function(B){O=!0,j=B},f:function(){try{!N&&A.return!=null&&A.return()}finally{if(O)throw j}}}}function g(F){return C(F)||R(F)||S(F)||w()}function w(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function S(F,D){if(F){if(typeof F=="string")return b(F,D);var A=Object.prototype.toString.call(F).slice(8,-1);if(A==="Object"&&F.constructor&&(A=F.constructor.name),A==="Map"||A==="Set")return Array.from(F);if(A==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(A))return b(F,D)}}function R(F){if(typeof Symbol<"u"&&F[Symbol.iterator]!=null||F["@@iterator"]!=null)return Array.from(F)}function C(F){if(Array.isArray(F))return b(F)}function b(F,D){(D==null||D>F.length)&&(D=F.length);for(var A=0,k=new Array(D);A<D;A++)k[A]=F[A];return k}function _(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_=function(){return F};var F={},D=Object.prototype,A=D.hasOwnProperty,k=Object.defineProperty||function(W,K,G){W[K]=G.value},M=typeof Symbol=="function"?Symbol:{},N=M.iterator||"@@iterator",O=M.asyncIterator||"@@asyncIterator",j=M.toStringTag||"@@toStringTag";function U(W,K,G){return Object.defineProperty(W,K,{value:G,enumerable:!0,configurable:!0,writable:!0}),W[K]}try{U({},"")}catch{U=function(G,Y,ce){return G[Y]=ce}}function B(W,K,G,Y){var ce=K&&K.prototype instanceof re?K:re,he=Object.create(ce.prototype),Ie=new rn(Y||[]);return k(he,"_invoke",{value:xn(W,G,Ie)}),he}function J(W,K,G){try{return{type:"normal",arg:W.call(K,G)}}catch(Y){return{type:"throw",arg:Y}}}F.wrap=B;var ue={};function re(){}function Ae(){}function ge(){}var le={};U(le,N,function(){return this});var Be=Object.getPrototypeOf,at=Be&&Be(Be(ne([])));at&&at!==D&&A.call(at,N)&&(le=at);var st=ge.prototype=re.prototype=Object.create(le);function oe(W){["next","throw","return"].forEach(function(K){U(W,K,function(G){return this._invoke(K,G)})})}function He(W,K){function G(ce,he,Ie,Ve){var Ge=J(W[ce],W,he);if(Ge.type!=="throw"){var ft=Ge.arg,cr=ft.value;return cr&&h(cr)=="object"&&A.call(cr,"__await")?K.resolve(cr.__await).then(function(Cr){G("next",Cr,Ie,Ve)},function(Cr){G("throw",Cr,Ie,Ve)}):K.resolve(cr).then(function(Cr){ft.value=Cr,Ie(ft)},function(Cr){return G("throw",Cr,Ie,Ve)})}Ve(Ge.arg)}var Y;k(this,"_invoke",{value:function(he,Ie){function Ve(){return new K(function(Ge,ft){G(he,Ie,Ge,ft)})}return Y=Y?Y.then(Ve,Ve):Ve()}})}function xn(W,K,G){var Y="suspendedStart";return function(ce,he){if(Y==="executing")throw new Error("Generator is already running");if(Y==="completed"){if(ce==="throw")throw he;return z()}for(G.method=ce,G.arg=he;;){var Ie=G.delegate;if(Ie){var Ve=tn(Ie,G);if(Ve){if(Ve===ue)continue;return Ve}}if(G.method==="next")G.sent=G._sent=G.arg;else if(G.method==="throw"){if(Y==="suspendedStart")throw Y="completed",G.arg;G.dispatchException(G.arg)}else G.method==="return"&&G.abrupt("return",G.arg);Y="executing";var Ge=J(W,K,G);if(Ge.type==="normal"){if(Y=G.done?"completed":"suspendedYield",Ge.arg===ue)continue;return{value:Ge.arg,done:G.done}}Ge.type==="throw"&&(Y="completed",G.method="throw",G.arg=Ge.arg)}}}function tn(W,K){var G=K.method,Y=W.iterator[G];if(Y===void 0)return K.delegate=null,G==="throw"&&W.iterator.return&&(K.method="return",K.arg=void 0,tn(W,K),K.method==="throw")||G!=="return"&&(K.method="throw",K.arg=new TypeError("The iterator does not provide a '"+G+"' method")),ue;var ce=J(Y,W.iterator,K.arg);if(ce.type==="throw")return K.method="throw",K.arg=ce.arg,K.delegate=null,ue;var he=ce.arg;return he?he.done?(K[W.resultName]=he.value,K.next=W.nextLoc,K.method!=="return"&&(K.method="next",K.arg=void 0),K.delegate=null,ue):he:(K.method="throw",K.arg=new TypeError("iterator result is not an object"),K.delegate=null,ue)}function jn(W){var K={tryLoc:W[0]};1 in W&&(K.catchLoc=W[1]),2 in W&&(K.finallyLoc=W[2],K.afterLoc=W[3]),this.tryEntries.push(K)}function Ir(W){var K=W.completion||{};K.type="normal",delete K.arg,W.completion=K}function rn(W){this.tryEntries=[{tryLoc:"root"}],W.forEach(jn,this),this.reset(!0)}function ne(W){if(W){var K=W[N];if(K)return K.call(W);if(typeof W.next=="function")return W;if(!isNaN(W.length)){var G=-1,Y=function ce(){for(;++G<W.length;)if(A.call(W,G))return ce.value=W[G],ce.done=!1,ce;return ce.value=void 0,ce.done=!0,ce};return Y.next=Y}}return{next:z}}function z(){return{value:void 0,done:!0}}return Ae.prototype=ge,k(st,"constructor",{value:ge,configurable:!0}),k(ge,"constructor",{value:Ae,configurable:!0}),Ae.displayName=U(ge,j,"GeneratorFunction"),F.isGeneratorFunction=function(W){var K=typeof W=="function"&&W.constructor;return!!K&&(K===Ae||(K.displayName||K.name)==="GeneratorFunction")},F.mark=function(W){return Object.setPrototypeOf?Object.setPrototypeOf(W,ge):(W.__proto__=ge,U(W,j,"GeneratorFunction")),W.prototype=Object.create(st),W},F.awrap=function(W){return{__await:W}},oe(He.prototype),U(He.prototype,O,function(){return this}),F.AsyncIterator=He,F.async=function(W,K,G,Y,ce){ce===void 0&&(ce=Promise);var he=new He(B(W,K,G,Y),ce);return F.isGeneratorFunction(K)?he:he.next().then(function(Ie){return Ie.done?Ie.value:he.next()})},oe(st),U(st,j,"Generator"),U(st,N,function(){return this}),U(st,"toString",function(){return"[object Generator]"}),F.keys=function(W){var K=Object(W),G=[];for(var Y in K)G.push(Y);return G.reverse(),function ce(){for(;G.length;){var he=G.pop();if(he in K)return ce.value=he,ce.done=!1,ce}return ce.done=!0,ce}},F.values=ne,rn.prototype={constructor:rn,reset:function(K){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(Ir),!K)for(var G in this)G.charAt(0)==="t"&&A.call(this,G)&&!isNaN(+G.slice(1))&&(this[G]=void 0)},stop:function(){this.done=!0;var K=this.tryEntries[0].completion;if(K.type==="throw")throw K.arg;return this.rval},dispatchException:function(K){if(this.done)throw K;var G=this;function Y(ft,cr){return Ie.type="throw",Ie.arg=K,G.next=ft,cr&&(G.method="next",G.arg=void 0),!!cr}for(var ce=this.tryEntries.length-1;ce>=0;--ce){var he=this.tryEntries[ce],Ie=he.completion;if(he.tryLoc==="root")return Y("end");if(he.tryLoc<=this.prev){var Ve=A.call(he,"catchLoc"),Ge=A.call(he,"finallyLoc");if(Ve&&Ge){if(this.prev<he.catchLoc)return Y(he.catchLoc,!0);if(this.prev<he.finallyLoc)return Y(he.finallyLoc)}else if(Ve){if(this.prev<he.catchLoc)return Y(he.catchLoc,!0)}else{if(!Ge)throw new Error("try statement without catch or finally");if(this.prev<he.finallyLoc)return Y(he.finallyLoc)}}}},abrupt:function(K,G){for(var Y=this.tryEntries.length-1;Y>=0;--Y){var ce=this.tryEntries[Y];if(ce.tryLoc<=this.prev&&A.call(ce,"finallyLoc")&&this.prev<ce.finallyLoc){var he=ce;break}}he&&(K==="break"||K==="continue")&&he.tryLoc<=G&&G<=he.finallyLoc&&(he=null);var Ie=he?he.completion:{};return Ie.type=K,Ie.arg=G,he?(this.method="next",this.next=he.finallyLoc,ue):this.complete(Ie)},complete:function(K,G){if(K.type==="throw")throw K.arg;return K.type==="break"||K.type==="continue"?this.next=K.arg:K.type==="return"?(this.rval=this.arg=K.arg,this.method="return",this.next="end"):K.type==="normal"&&G&&(this.next=G),ue},finish:function(K){for(var G=this.tryEntries.length-1;G>=0;--G){var Y=this.tryEntries[G];if(Y.finallyLoc===K)return this.complete(Y.completion,Y.afterLoc),Ir(Y),ue}},catch:function(K){for(var G=this.tryEntries.length-1;G>=0;--G){var Y=this.tryEntries[G];if(Y.tryLoc===K){var ce=Y.completion;if(ce.type==="throw"){var he=ce.arg;Ir(Y)}return he}}throw new Error("illegal catch attempt")},delegateYield:function(K,G,Y){return this.delegate={iterator:ne(K),resultName:G,nextLoc:Y},this.method==="next"&&(this.arg=void 0),ue}},F}function p(F,D,A,k,M,N,O){try{var j=F[N](O),U=j.value}catch(B){A(B);return}j.done?D(U):Promise.resolve(U).then(k,M)}function I(F){return function(){var D=this,A=arguments;return new Promise(function(k,M){var N=F.apply(D,A);function O(U){p(N,k,M,O,j,"next",U)}function j(U){p(N,k,M,O,j,"throw",U)}O(void 0)})}}function y(F,D){if(!(F instanceof D))throw new TypeError("Cannot call a class as a function")}function P(F,D){for(var A=0;A<D.length;A++){var k=D[A];k.enumerable=k.enumerable||!1,k.configurable=!0,"value"in k&&(k.writable=!0),Object.defineProperty(F,fe(k.key),k)}}function L(F,D,A){return D&&P(F.prototype,D),Object.defineProperty(F,"prototype",{writable:!1}),F}function V(F,D){if(typeof D!="function"&&D!==null)throw new TypeError("Super expression must either be null or a function");F.prototype=Object.create(D&&D.prototype,{constructor:{value:F,writable:!0,configurable:!0}}),Object.defineProperty(F,"prototype",{writable:!1}),D&&te(F,D)}function te(F,D){return te=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(k,M){return k.__proto__=M,k},te(F,D)}function ve(F){var D=ee();return function(){var k=se(F),M;if(D){var N=se(this).constructor;M=Reflect.construct(k,arguments,N)}else M=k.apply(this,arguments);return Oe(this,M)}}function Oe(F,D){if(D&&(h(D)==="object"||typeof D=="function"))return D;if(D!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return H(F)}function H(F){if(F===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return F}function ee(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function se(F){return se=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(A){return A.__proto__||Object.getPrototypeOf(A)},se(F)}function de(F,D,A){return D=fe(D),D in F?Object.defineProperty(F,D,{value:A,enumerable:!0,configurable:!0,writable:!0}):F[D]=A,F}function fe(F){var D=Te(F,"string");return h(D)==="symbol"?D:String(D)}function Te(F,D){if(h(F)!=="object"||F===null)return F;var A=F[Symbol.toPrimitive];if(A!==void 0){var k=A.call(F,D);if(h(k)!=="object")return k;throw new TypeError("@@toPrimitive must return a primitive value.")}return(D==="string"?String:Number)(F)}function Ze(F){var D,A,k,M=2;for(typeof Symbol<"u"&&(A=Symbol.asyncIterator,k=Symbol.iterator);M--;){if(A&&(D=F[A])!=null)return D.call(F);if(k&&(D=F[k])!=null)return new $(D.call(F));A="@@asyncIterator",k="@@iterator"}throw new TypeError("Object is not async iterable")}function $(F){function D(A){if(Object(A)!==A)return Promise.reject(new TypeError(A+" is not an object."));var k=A.done;return Promise.resolve(A.value).then(function(M){return{value:M,done:k}})}return $=function(k){this.s=k,this.n=k.next},$.prototype={s:null,n:null,next:function(){return D(this.n.apply(this.s,arguments))},return:function(k){var M=this.s.return;return M===void 0?Promise.resolve({value:k,done:!0}):D(M.apply(this.s,arguments))},throw:function(k){var M=this.s.return;return M===void 0?Promise.reject(k):D(M.apply(this.s,arguments))}},new $(F)}var X=function(F){V(A,F);var D=ve(A);function A(k,M,N){var O;if(y(this,A),O=D.call(this),O.widget=k,O.iframe=M,O.driver=N,de(H(O),"transport",void 0),de(H(O),"cachedWidgetVersions",null),de(H(O),"contentLoadedActionSent",!1),de(H(O),"allowedCapabilities",new Set),de(H(O),"allowedEvents",[]),de(H(O),"isStopped",!1),de(H(O),"turnServers",null),de(H(O),"contentLoadedWaitTimer",void 0),de(H(O),"pushRoomStateTasks",new Set),de(H(O),"pushRoomStateResult",new Map),de(H(O),"flushRoomStateTask",null),de(H(O),"viewedRoomId",null),!(M!=null&&M.contentWindow))throw new Error("No iframe supplied");if(!k)throw new Error("Invalid widget");if(!N)throw new Error("Invalid driver");return O.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,k.id,M.contentWindow,window),O.transport.targetOrigin=k.origin,O.transport.on("message",O.handleMessage.bind(H(O))),M.addEventListener("load",O.onIframeLoad.bind(H(O))),O.transport.start(),O}return L(A,[{key:"hasCapability",value:function(M){return this.allowedCapabilities.has(M)}},{key:"canUseRoomTimeline",value:function(M){return this.hasCapability("org.matrix.msc2762.timeline:".concat(d.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(M))}},{key:"canSendRoomEvent",value:function(M){var N=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(O){return O.matchesAsRoomEvent(s.EventDirection.Send,M,N)})}},{key:"canSendStateEvent",value:function(M,N){return this.allowedEvents.some(function(O){return O.matchesAsStateEvent(s.EventDirection.Send,M,N)})}},{key:"canSendToDeviceEvent",value:function(M){return this.allowedEvents.some(function(N){return N.matchesAsToDeviceEvent(s.EventDirection.Send,M)})}},{key:"canReceiveRoomEvent",value:function(M){var N=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(O){return O.matchesAsRoomEvent(s.EventDirection.Receive,M,N)})}},{key:"canReceiveStateEvent",value:function(M,N){return this.allowedEvents.some(function(O){return O.matchesAsStateEvent(s.EventDirection.Receive,M,N)})}},{key:"canReceiveToDeviceEvent",value:function(M){return this.allowedEvents.some(function(N){return N.matchesAsToDeviceEvent(s.EventDirection.Receive,M)})}},{key:"canReceiveRoomAccountData",value:function(M){return this.allowedEvents.some(function(N){return N.matchesAsRoomAccountData(s.EventDirection.Receive,M)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:function(){var k=I(_().mark(function N(){var O;return _().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){U.next=2;break}return U.abrupt("return",Promise.resolve(this.cachedWidgetVersions));case 2:return U.prev=2,U.next=5,this.transport.send(r.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return O=U.sent,this.cachedWidgetVersions=O.supported_versions,U.abrupt("return",O.supported_versions);case 10:return U.prev=10,U.t0=U.catch(2),console.warn("non-fatal error getting supported widget versions: ",U.t0),U.abrupt("return",[]);case 14:case"end":return U.stop()}},N,this,[[2,10]])}));function M(){return k.apply(this,arguments)}return M}()},{key:"beginCapabilities",value:function(){var M=this;this.emit("preparing");var N;this.transport.send(r.WidgetApiToWidgetAction.Capabilities,{}).then(function(O){return N=O.capabilities,M.driver.validateCapabilities(new Set(O.capabilities))}).then(function(O){M.allowCapabilities(g(O),N),M.emit("ready")}).catch(function(O){M.emit("error:preparing",O)})}},{key:"allowCapabilities",value:function(M,N){var O,j=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),M);var U=f(M),B;try{for(U.s();!(B=U.n()).done;){var J=B.value;this.allowedCapabilities.add(J)}}catch(oe){U.e(oe)}finally{U.f()}var ue=s.WidgetEventCapability.findEventCapabilities(M);(O=this.allowedEvents).push.apply(O,g(ue)),this.transport.send(r.WidgetApiToWidgetAction.NotifyCapabilities,{requested:N,approved:Array.from(this.allowedCapabilities)}).catch(function(oe){console.warn("non-fatal error notifying widget of approved capabilities:",oe)}).then(function(){j.emit("capabilitiesNotified")});var re=f(M),Ae;try{for(re.s();!(Ae=re.n()).done;){var ge=Ae.value;if((0,n.isTimelineCapability)(ge)){var le=(0,n.getTimelineRoomIDFromCapability)(ge);if(le===d.Symbols.AnyRoom){var Be=f(this.driver.getKnownRooms()),at;try{for(Be.s();!(at=Be.n()).done;){var st=at.value;this.pushRoomState(st)}}catch(oe){Be.e(oe)}finally{Be.f()}}else this.pushRoomState(le)}}}catch(oe){re.e(oe)}finally{re.f()}ue.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(M){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(M){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(M,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(M,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(M){this.transport.reply(M,{supported_versions:a.CurrentApiVersions})}},{key:"supportsUpdateState",value:function(){var k=I(_().mark(function N(){return _().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:return j.next=2,this.getWidgetVersions();case 2:return j.abrupt("return",j.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return j.stop()}},N,this)}));function M(){return k.apply(this,arguments)}return M}()},{key:"handleCapabilitiesRenegotiate",value:function(M){var N,O=this;this.transport.reply(M,{});var j=((N=M.data)===null||N===void 0?void 0:N.capabilities)||[],U=new Set(j.filter(function(B){return!O.hasCapability(B)}));U.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(U).then(function(B){return O.allowCapabilities(g(B),g(U))})}},{key:"handleNavigate",value:function(M){var N,O,j=this;if(!this.hasCapability(n.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(M,{error:{message:"Missing capability"}});if(!((N=M.data)!==null&&N!==void 0&&N.uri)||!((O=M.data)!==null&&O!==void 0&&O.uri.toString().startsWith("https://matrix.to/#")))return this.transport.reply(M,{error:{message:"Invalid matrix.to URI"}});var U=function(J){console.error("[ClientWidgetApi] Failed to handle navigation: ",J),j.handleDriverError(J,M,"Error handling navigation")};try{this.driver.navigate(M.data.uri.toString()).catch(function(B){return U(B)}).then(function(){return j.transport.reply(M,{})})}catch(B){return U(B)}}},{key:"handleOIDC",value:function(M){var N=this,O=1,j=function(ue,re){return re=re||{},O>1?N.transport.send(r.WidgetApiToWidgetAction.OpenIDCredentials,m({state:ue,original_request_id:M.requestId},re)):N.transport.reply(M,m({state:ue},re))},U=function(ue){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",ue),O>1?j(o.OpenIDRequestState.Blocked):N.transport.reply(M,{error:{message:ue}})},B=new l.SimpleObservable(function(J){if(J.state===o.OpenIDRequestState.PendingUserConfirmation&&O>1)return B.close(),U("client provided out-of-phase response to OIDC flow");if(J.state===o.OpenIDRequestState.PendingUserConfirmation){j(J.state),O++;return}return J.state===o.OpenIDRequestState.Allowed&&!J.token?U("client provided invalid OIDC token for an allowed request"):(J.state===o.OpenIDRequestState.Blocked&&(J.token=void 0),B.close(),j(J.state,J.token))});this.driver.askOpenID(B)}},{key:"handleReadRoomAccountData",value:function(M){var N=this,O=Promise.resolve([]);return O=this.driver.readRoomAccountData(M.data.type),this.canReceiveRoomAccountData(M.data.type)?O.then(function(j){N.transport.reply(M,{events:j})}):this.transport.reply(M,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(){var k=I(_().mark(function N(O){var j=this,U,B,J,ue,re,Ae,ge,le,Be,at;return _().wrap(function(oe){for(;;)switch(oe.prev=oe.next){case 0:if(O.data.type){oe.next=2;break}return oe.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(O.data.limit!==void 0&&(!O.data.limit||O.data.limit<0))){oe.next=4;break}return oe.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - limit out of range"}}));case 4:if(O.data.room_ids!==void 0){oe.next=8;break}U=this.viewedRoomId===null?[]:[this.viewedRoomId],oe.next=30;break;case 8:if(O.data.room_ids!==d.Symbols.AnyRoom){oe.next=12;break}U=this.driver.getKnownRooms().filter(function(He){return j.canUseRoomTimeline(He)}),oe.next=30;break;case 12:U=O.data.room_ids,B=f(U),oe.prev=14,B.s();case 16:if((J=B.n()).done){oe.next=22;break}if(ue=J.value,this.canUseRoomTimeline(ue)){oe.next=20;break}return oe.abrupt("return",this.transport.reply(O,{error:{message:"Unable to access room timeline: ".concat(ue)}}));case 20:oe.next=16;break;case 22:oe.next=27;break;case 24:oe.prev=24,oe.t0=oe.catch(14),B.e(oe.t0);case 27:return oe.prev=27,B.f(),oe.finish(27);case 30:if(re=O.data.limit||0,Ae=O.data.since,ge=void 0,le=void 0,O.data.state_key===void 0){oe.next=40;break}if(ge=O.data.state_key===!0?void 0:O.data.state_key.toString(),this.canReceiveStateEvent(O.data.type,(Be=ge)!==null&&Be!==void 0?Be:null)){oe.next=38;break}return oe.abrupt("return",this.transport.reply(O,{error:{message:"Cannot read state events of this type"}}));case 38:oe.next=43;break;case 40:if(le=O.data.msgtype,this.canReceiveRoomEvent(O.data.type,le)){oe.next=43;break}return oe.abrupt("return",this.transport.reply(O,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(O.data.room_ids===void 0&&U.length===0)){oe.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),oe.next=47,O.data.state_key===void 0?this.driver.readRoomEvents(O.data.type,le,re,null,Ae):this.driver.readStateEvents(O.data.type,ge,re,null);case 47:at=oe.sent,oe.next=68;break;case 50:return oe.next=52,this.supportsUpdateState();case 52:if(!oe.sent){oe.next=58;break}return oe.next=55,Promise.all(U.map(function(He){return j.driver.readRoomTimeline(He,O.data.type,le,ge,re,Ae)}));case 55:at=oe.sent.flat(1),oe.next=68;break;case 58:if(O.data.state_key!==void 0){oe.next=64;break}return oe.next=61,Promise.all(U.map(function(He){return j.driver.readRoomTimeline(He,O.data.type,le,ge,re,Ae)}));case 61:oe.t1=oe.sent,oe.next=67;break;case 64:return oe.next=66,Promise.all(U.map(function(He){return j.driver.readRoomState(He,O.data.type,ge)}));case 66:oe.t1=oe.sent;case 67:at=oe.t1.flat(1);case 68:this.transport.reply(O,{events:at});case 69:case"end":return oe.stop()}},N,this,[[14,24,27,30]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleSendEvent",value:function(M){var N=this;if(!M.data.type)return this.transport.reply(M,{error:{message:"Invalid request - missing event type"}});if(M.data.room_id&&!this.canUseRoomTimeline(M.data.room_id))return this.transport.reply(M,{error:{message:"Unable to access room timeline: ".concat(M.data.room_id)}});var O=M.data.delay!==void 0||M.data.parent_delay_id!==void 0;if(O&&!this.hasCapability(n.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(M,{error:{message:"Missing capability"}});var j;if(M.data.state_key!==void 0){if(!this.canSendStateEvent(M.data.type,M.data.state_key))return this.transport.reply(M,{error:{message:"Cannot send state events of this type"}});if(!O)j=this.driver.sendEvent(M.data.type,M.data.content||{},M.data.state_key,M.data.room_id);else{var U,B;j=this.driver.sendDelayedEvent((U=M.data.delay)!==null&&U!==void 0?U:null,(B=M.data.parent_delay_id)!==null&&B!==void 0?B:null,M.data.type,M.data.content||{},M.data.state_key,M.data.room_id)}}else{var J=M.data.content||{},ue=J.msgtype;if(!this.canSendRoomEvent(M.data.type,ue))return this.transport.reply(M,{error:{message:"Cannot send room events of this type"}});if(!O)j=this.driver.sendEvent(M.data.type,J,null,M.data.room_id);else{var re,Ae;j=this.driver.sendDelayedEvent((re=M.data.delay)!==null&&re!==void 0?re:null,(Ae=M.data.parent_delay_id)!==null&&Ae!==void 0?Ae:null,M.data.type,J,null,M.data.room_id)}}j.then(function(ge){return N.transport.reply(M,m({room_id:ge.roomId},"eventId"in ge?{event_id:ge.eventId}:{delay_id:ge.delayId}))}).catch(function(ge){console.error("error sending event: ",ge),N.handleDriverError(ge,M,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(M){var N=this;if(!M.data.delay_id)return this.transport.reply(M,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(n.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(M,{error:{message:"Missing capability"}});switch(M.data.action){case u.UpdateDelayedEventAction.Cancel:case u.UpdateDelayedEventAction.Restart:case u.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(M.data.delay_id,M.data.action).then(function(){return N.transport.reply(M,{})}).catch(function(O){console.error("error updating delayed event: ",O),N.handleDriverError(O,M,"Error updating delayed event")});break;default:return this.transport.reply(M,{error:{message:"Invalid request - unsupported action"}})}}},{key:"handleSendToDevice",value:function(){var k=I(_().mark(function N(O){return _().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:if(O.data.type){U.next=5;break}return U.next=3,this.transport.reply(O,{error:{message:"Invalid request - missing event type"}});case 3:U.next=31;break;case 5:if(O.data.messages){U.next=10;break}return U.next=8,this.transport.reply(O,{error:{message:"Invalid request - missing event contents"}});case 8:U.next=31;break;case 10:if(typeof O.data.encrypted=="boolean"){U.next=15;break}return U.next=13,this.transport.reply(O,{error:{message:"Invalid request - missing encryption flag"}});case 13:U.next=31;break;case 15:if(this.canSendToDeviceEvent(O.data.type)){U.next=20;break}return U.next=18,this.transport.reply(O,{error:{message:"Cannot send to-device events of this type"}});case 18:U.next=31;break;case 20:return U.prev=20,U.next=23,this.driver.sendToDevice(O.data.type,O.data.encrypted,O.data.messages);case 23:return U.next=25,this.transport.reply(O,{});case 25:U.next=31;break;case 27:U.prev=27,U.t0=U.catch(20),console.error("error sending to-device event",U.t0),this.handleDriverError(U.t0,O,"Error sending event");case 31:case"end":return U.stop()}},N,this,[[20,27]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"pollTurnServers",value:function(){var k=I(_().mark(function N(O,j){var U,B,J,ue,re,Ae;return _().wrap(function(le){for(;;)switch(le.prev=le.next){case 0:return le.prev=0,le.next=3,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,j);case 3:U=!1,B=!1,le.prev=5,ue=Ze(O);case 7:return le.next=9,ue.next();case 9:if(!(U=!(re=le.sent).done)){le.next=16;break}return Ae=re.value,le.next=13,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,Ae);case 13:U=!1,le.next=7;break;case 16:le.next=22;break;case 18:le.prev=18,le.t0=le.catch(5),B=!0,J=le.t0;case 22:if(le.prev=22,le.prev=23,!(U&&ue.return!=null)){le.next=27;break}return le.next=27,ue.return();case 27:if(le.prev=27,!B){le.next=30;break}throw J;case 30:return le.finish(27);case 31:return le.finish(22);case 32:le.next=37;break;case 34:le.prev=34,le.t1=le.catch(0),console.error("error polling for TURN servers",le.t1);case 37:case"end":return le.stop()}},N,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function M(N,O){return k.apply(this,arguments)}return M}()},{key:"handleWatchTurnServers",value:function(){var k=I(_().mark(function N(O){var j,U,B,J;return _().wrap(function(re){for(;;)switch(re.prev=re.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){re.next=5;break}return re.next=3,this.transport.reply(O,{error:{message:"Missing capability"}});case 3:re.next=30;break;case 5:if(!this.turnServers){re.next=10;break}return re.next=8,this.transport.reply(O,{});case 8:re.next=30;break;case 10:return re.prev=10,j=this.driver.getTurnServers(),re.next=14,j.next();case 14:if(U=re.sent,B=U.done,J=U.value,!B){re.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return re.next=21,this.transport.reply(O,{});case 21:this.pollTurnServers(j,J),this.turnServers=j,re.next=30;break;case 25:return re.prev=25,re.t0=re.catch(10),console.error("error getting first TURN server results",re.t0),re.next=30,this.transport.reply(O,{error:{message:"TURN servers not available"}});case 30:case"end":return re.stop()}},N,this,[[10,25]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleUnwatchTurnServers",value:function(){var k=I(_().mark(function N(O){return _().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){U.next=5;break}return U.next=3,this.transport.reply(O,{error:{message:"Missing capability"}});case 3:U.next=15;break;case 5:if(this.turnServers){U.next=10;break}return U.next=8,this.transport.reply(O,{});case 8:U.next=15;break;case 10:return U.next=12,this.turnServers.return(void 0);case 12:return this.turnServers=null,U.next=15,this.transport.reply(O,{});case 15:case"end":return U.stop()}},N,this)}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleReadRelations",value:function(){var k=I(_().mark(function N(O){var j=this,U,B;return _().wrap(function(ue){for(;;)switch(ue.prev=ue.next){case 0:if(O.data.event_id){ue.next=2;break}return ue.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(O.data.limit!==void 0&&O.data.limit<0)){ue.next=4;break}return ue.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(O.data.room_id!==void 0&&!this.canUseRoomTimeline(O.data.room_id))){ue.next=6;break}return ue.abrupt("return",this.transport.reply(O,{error:{message:"Unable to access room timeline: ".concat(O.data.room_id)}}));case 6:return ue.prev=6,ue.next=9,this.driver.readEventRelations(O.data.event_id,O.data.room_id,O.data.rel_type,O.data.event_type,O.data.from,O.data.to,O.data.limit,O.data.direction);case 9:return U=ue.sent,B=U.chunk.filter(function(re){return re.state_key!==void 0?j.canReceiveStateEvent(re.type,re.state_key):j.canReceiveRoomEvent(re.type,re.content.msgtype)}),ue.abrupt("return",this.transport.reply(O,{chunk:B,prev_batch:U.prevBatch,next_batch:U.nextBatch}));case 14:ue.prev=14,ue.t0=ue.catch(6),console.error("error getting the relations",ue.t0),this.handleDriverError(ue.t0,O,"Unexpected error while reading relations");case 18:case"end":return ue.stop()}},N,this,[[6,14]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleUserDirectorySearch",value:function(){var k=I(_().mark(function N(O){var j;return _().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3973UserDirectorySearch)){B.next=2;break}return B.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:if(typeof O.data.search_term=="string"){B.next=4;break}return B.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(O.data.limit!==void 0&&O.data.limit<0)){B.next=6;break}return B.abrupt("return",this.transport.reply(O,{error:{message:"Invalid request - limit out of range"}}));case 6:return B.prev=6,B.next=9,this.driver.searchUserDirectory(O.data.search_term,O.data.limit);case 9:return j=B.sent,B.abrupt("return",this.transport.reply(O,{limited:j.limited,results:j.results.map(function(J){return{user_id:J.userId,display_name:J.displayName,avatar_url:J.avatarUrl}})}));case 13:B.prev=13,B.t0=B.catch(6),console.error("error searching in the user directory",B.t0),this.handleDriverError(B.t0,O,"Unexpected error while searching in the user directory");case 17:case"end":return B.stop()}},N,this,[[6,13]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleGetMediaConfig",value:function(){var k=I(_().mark(function N(O){var j;return _().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){B.next=2;break}return B.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:return B.prev=2,B.next=5,this.driver.getMediaConfig();case 5:return j=B.sent,B.abrupt("return",this.transport.reply(O,j));case 9:B.prev=9,B.t0=B.catch(2),console.error("error while getting the media configuration",B.t0),this.handleDriverError(B.t0,O,"Unexpected error while getting the media configuration");case 13:case"end":return B.stop()}},N,this,[[2,9]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleUploadFile",value:function(){var k=I(_().mark(function N(O){var j;return _().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){B.next=2;break}return B.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:return B.prev=2,B.next=5,this.driver.uploadFile(O.data.file);case 5:return j=B.sent,B.abrupt("return",this.transport.reply(O,{content_uri:j.contentUri}));case 9:B.prev=9,B.t0=B.catch(2),console.error("error while uploading a file",B.t0),this.handleDriverError(B.t0,O,"Unexpected error while uploading a file");case 13:case"end":return B.stop()}},N,this,[[2,9]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleDownloadFile",value:function(){var k=I(_().mark(function N(O){var j;return _().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039DownloadFile)){B.next=2;break}return B.abrupt("return",this.transport.reply(O,{error:{message:"Missing capability"}}));case 2:return B.prev=2,B.next=5,this.driver.downloadFile(O.data.content_uri);case 5:return j=B.sent,B.abrupt("return",this.transport.reply(O,{file:j.file}));case 9:B.prev=9,B.t0=B.catch(2),console.error("error while downloading a file",B.t0),this.handleDriverError(B.t0,O,"Unexpected error while downloading a file");case 13:case"end":return B.stop()}},N,this,[[2,9]])}));function M(N){return k.apply(this,arguments)}return M}()},{key:"handleDriverError",value:function(M,N,O){var j=this.driver.processError(M);this.transport.reply(N,{error:m({message:O},j)})}},{key:"handleMessage",value:function(M){if(!this.isStopped){var N=new CustomEvent("action:".concat(M.detail.action),{detail:M.detail,cancelable:!0});if(this.emit("action:".concat(M.detail.action),N),!N.defaultPrevented)switch(M.detail.action){case r.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(M.detail);case r.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(M.detail);case r.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(M.detail);case r.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(M.detail);case r.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(M.detail);case r.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(M.detail);case r.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(M.detail);case r.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(M.detail);case r.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(M.detail);case r.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(M.detail);case r.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(M.detail);case r.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(M.detail);case r.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(M.detail);case r.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(M.detail);case r.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(M.detail);case r.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(M.detail);case r.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(M.detail);default:return this.transport.reply(M.detail,{error:{message:"Unknown or unsupported action: "+M.detail.action}})}}}},{key:"updateTheme",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.ThemeChange,M)}},{key:"updateLanguage",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.LanguageChange,{lang:M})}},{key:"takeScreenshot",value:function(){return this.transport.send(r.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.UpdateVisibility,{visible:M})}},{key:"sendWidgetConfig",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.WidgetConfig,M).then()}},{key:"notifyModalWidgetButtonClicked",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.ButtonClicked,{id:M}).then()}},{key:"notifyModalWidgetClose",value:function(M){return this.transport.send(r.WidgetApiToWidgetAction.CloseModalWidget,M).then()}},{key:"feedEvent",value:function(){var k=I(_().mark(function N(O,j){var U;return _().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:if(j!==void 0&&this.setViewedRoomId(j),!(O.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(O.room_id))){J.next=3;break}return J.abrupt("return");case 3:if(!(O.state_key!==void 0&&O.state_key!==null)){J.next=8;break}if(this.canReceiveStateEvent(O.type,O.state_key)){J.next=6;break}return J.abrupt("return");case 6:J.next=10;break;case 8:if(this.canReceiveRoomEvent(O.type,(U=O.content)===null||U===void 0?void 0:U.msgtype)){J.next=10;break}return J.abrupt("return");case 10:return J.next=12,this.transport.send(r.WidgetApiToWidgetAction.SendEvent,O);case 12:case"end":return J.stop()}},N,this)}));function M(N,O){return k.apply(this,arguments)}return M}()},{key:"feedToDevice",value:function(){var k=I(_().mark(function N(O,j){return _().wrap(function(B){for(;;)switch(B.prev=B.next){case 0:if(!this.canReceiveToDeviceEvent(O.type)){B.next=3;break}return B.next=3,this.transport.send(r.WidgetApiToWidgetAction.SendToDevice,m(m({},O),{},{encrypted:j}));case 3:case"end":return B.stop()}},N,this)}));function M(N,O){return k.apply(this,arguments)}return M}()},{key:"setViewedRoomId",value:function(M){this.viewedRoomId=M,M!==null&&!this.canUseRoomTimeline(M)&&this.pushRoomState(M)}},{key:"flushRoomState",value:function(){var k=I(_().mark(function N(){var O,j,U,B,J,ue,re;return _().wrap(function(ge){for(;;)switch(ge.prev=ge.next){case 0:ge.prev=0;case 1:return ge.next=3,Promise.all(g(this.pushRoomStateTasks));case 3:if(this.pushRoomStateTasks.size>0){ge.next=1;break}case 4:O=[],j=f(this.pushRoomStateResult.values());try{for(j.s();!(U=j.n()).done;){B=U.value,J=f(B.values());try{for(J.s();!(ue=J.n()).done;)re=ue.value,O.push.apply(O,g(re.values()))}catch(le){J.e(le)}finally{J.f()}}}catch(le){j.e(le)}finally{j.f()}return ge.next=9,this.getWidgetVersions();case 9:if(!ge.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){ge.next=12;break}return ge.next=12,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:O});case 12:return ge.prev=12,this.flushRoomStateTask=null,ge.finish(12);case 15:case"end":return ge.stop()}},N,this,[[0,,12,15]])}));function M(){return k.apply(this,arguments)}return M}()},{key:"pushRoomState",value:function(M){var N=this,O=f(this.allowedEvents),j;try{var U=function(){var J=j.value;if(J.kind===s.EventKind.State&&J.direction===s.EventDirection.Receive){var ue,re,Ae=N.driver.readRoomState(M,J.eventType,(ue=J.keyStr)!==null&&ue!==void 0?ue:void 0),ge=Ae.then(function(le){var Be=f(le),at;try{for(Be.s();!(at=Be.n()).done;){var st=at.value,oe=N.pushRoomStateResult.get(M);oe===void 0&&(oe=new Map,N.pushRoomStateResult.set(M,oe));var He=oe.get(J.eventType);He===void 0&&(He=new Map,oe.set(J.eventType,He)),He.has(st.state_key)||He.set(st.state_key,st)}}catch(xn){Be.e(xn)}finally{Be.f()}},function(le){return console.error("Failed to read room state for ".concat(M," (").concat(J.eventType,", ").concat(J.keyStr,")"),le)}).then(function(){N.pushRoomStateTasks.delete(ge)});N.pushRoomStateTasks.add(ge),(re=N.flushRoomStateTask)!==null&&re!==void 0||(N.flushRoomStateTask=N.flushRoomState()),N.flushRoomStateTask.catch(function(le){return console.error("Failed to push room state",le)})}};for(O.s();!(j=O.n()).done;)U()}catch(B){O.e(B)}finally{O.f()}}},{key:"feedStateUpdate",value:function(){var k=I(_().mark(function N(O){var j,U;return _().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:if(O.state_key!==void 0){J.next=2;break}throw new Error("Not a state event");case 2:if(!((O.room_id===this.viewedRoomId||this.canUseRoomTimeline(O.room_id))&&this.canReceiveStateEvent(O.type,O.state_key))){J.next=21;break}if(this.pushRoomStateTasks.size!==0){J.next=11;break}return J.next=6,this.getWidgetVersions();case 6:if(!J.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){J.next=9;break}return J.next=9,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:[O]});case 9:J.next=21;break;case 11:j=this.pushRoomStateResult.get(O.room_id),j===void 0&&(j=new Map,this.pushRoomStateResult.set(O.room_id,j)),U=j.get(O.type),U===void 0&&(U=new Map,j.set(O.type,U)),U.has(O.type)||U.set(O.state_key,O);case 16:return J.next=18,Promise.all(g(this.pushRoomStateTasks));case 18:if(this.pushRoomStateTasks.size>0){J.next=16;break}case 19:return J.next=21,this.flushRoomStateTask;case 21:case"end":return J.stop()}},N,this)}));function M(N){return k.apply(this,arguments)}return M}()}]),A}(i.EventEmitter);return ai.ClientWidgetApi=X,ai}var sa={},Au;function pm(){if(Au)return sa;Au=1,Object.defineProperty(sa,"__esModule",{value:!0}),sa.isErrorResponse=e;function i(t){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},i(t)}function e(t){var r=t.error;return i(r)==="object"&&r!==null&&"message"in r&&typeof r.message=="string"}return sa}var li={},Du;function mm(){if(Du)return li;Du=1,Object.defineProperty(li,"__esModule",{value:!0}),li.WidgetKind=void 0;var i=function(e){return e.Room="room",e.Account="account",e.Modal="modal",e}({});return li.WidgetKind=i,li}var di={},Lu;function gm(){if(Lu)return di;Lu=1,Object.defineProperty(di,"__esModule",{value:!0}),di.ModalButtonKind=void 0;var i=function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e}({});return di.ModalButtonKind=i,di}var oa={},Uu;function Rh(){if(Uu)return oa;Uu=1,Object.defineProperty(oa,"__esModule",{value:!0}),oa.isValidUrl=i;function i(e){if(!e)return!1;try{var t=new URL(e);return!(t.protocol!=="http"&&t.protocol!=="https")}catch(r){if(r instanceof TypeError)return!1;throw r}}return oa}var la={},Nu;function Th(){if(Nu)return la;Nu=1,Object.defineProperty(la,"__esModule",{value:!0}),la.assertPresent=i;function i(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}return la}var ui={},Fu;function Ih(){if(Fu)return ui;Fu=1,Object.defineProperty(ui,"__esModule",{value:!0}),ui.Widget=void 0;var i=Th(),e=ls();function t(d){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(u){return typeof u}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u},t(d)}function r(d,u){if(!(d instanceof u))throw new TypeError("Cannot call a class as a function")}function n(d,u){for(var h=0;h<u.length;h++){var v=u[h];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(d,s(v.key),v)}}function a(d,u,h){return u&&n(d.prototype,u),Object.defineProperty(d,"prototype",{writable:!1}),d}function s(d){var u=o(d,"string");return t(u)==="symbol"?u:String(u)}function o(d,u){if(t(d)!=="object"||d===null)return d;var h=d[Symbol.toPrimitive];if(h!==void 0){var v=h.call(d,u);if(t(v)!=="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(d)}var l=function(){function d(u){if(r(this,d),this.definition=u,!this.definition)throw new Error("Definition is required");(0,i.assertPresent)(u,"id"),(0,i.assertPresent)(u,"creatorUserId"),(0,i.assertPresent)(u,"type"),(0,i.assertPresent)(u,"url")}return a(d,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(h){return(0,e.runTemplate)(this.templateUrl,this.definition,h)}}]),d}();return ui.Widget=l,ui}var ci={},xu;function ym(){if(xu)return ci;xu=1,Object.defineProperty(ci,"__esModule",{value:!0}),ci.WidgetParser=void 0;var i=Ih(),e=Rh();function t(v){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},t(v)}function r(v,m){var f=typeof Symbol<"u"&&v[Symbol.iterator]||v["@@iterator"];if(!f){if(Array.isArray(v)||(f=n(v))||m){f&&(v=f);var g=0,w=function(){};return{s:w,n:function(){return g>=v.length?{done:!0}:{done:!1,value:v[g++]}},e:function(_){throw _},f:w}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var S=!0,R=!1,C;return{s:function(){f=f.call(v)},n:function(){var _=f.next();return S=_.done,_},e:function(_){R=!0,C=_},f:function(){try{!S&&f.return!=null&&f.return()}finally{if(R)throw C}}}}function n(v,m){if(v){if(typeof v=="string")return a(v,m);var f=Object.prototype.toString.call(v).slice(8,-1);if(f==="Object"&&v.constructor&&(f=v.constructor.name),f==="Map"||f==="Set")return Array.from(v);if(f==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f))return a(v,m)}}function a(v,m){(m==null||m>v.length)&&(m=v.length);for(var f=0,g=new Array(m);f<m;f++)g[f]=v[f];return g}function s(v,m){if(!(v instanceof m))throw new TypeError("Cannot call a class as a function")}function o(v,m){for(var f=0;f<m.length;f++){var g=m[f];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(v,d(g.key),g)}}function l(v,m,f){return f&&o(v,f),Object.defineProperty(v,"prototype",{writable:!1}),v}function d(v){var m=u(v,"string");return t(m)==="symbol"?m:String(m)}function u(v,m){if(t(v)!=="object"||v===null)return v;var f=v[Symbol.toPrimitive];if(f!==void 0){var g=f.call(v,m);if(t(g)!=="object")return g;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}var h=function(){function v(){s(this,v)}return l(v,null,[{key:"parseAccountData",value:function(f){if(!f)return[];for(var g=[],w=0,S=Object.keys(f);w<S.length;w++){var R=S[w],C=f[R];if(C&&!(C.type!=="m.widget"&&C.type!=="im.vector.modular.widgets")&&C.sender){var b=C.state_key||C.id;if(b===R){var _={content:C.content,sender:C.sender,type:"m.widget",state_key:R,event_id:"$example",room_id:"!example",origin_server_ts:1},p=v.parseRoomWidget(_);p&&g.push(p)}}}return g}},{key:"parseWidgetsFromRoomState",value:function(f){if(!f)return[];var g=[],w=r(f),S;try{for(w.s();!(S=w.n()).done;){var R=S.value,C=v.parseRoomWidget(R);C&&g.push(C)}}catch(b){w.e(b)}finally{w.f()}return g}},{key:"parseRoomWidget",value:function(f){if(!f||f.type!=="m.widget"&&f.type!=="im.vector.modular.widgets")return null;var g=f.content||{},w={id:f.state_key,creatorUserId:g.creatorUserId||f.sender,name:g.name,type:g.type,url:g.url,waitForIframeLoad:g.waitForIframeLoad,data:g.data};return v.processEstimatedWidget(w)}},{key:"processEstimatedWidget",value:function(f){return!f.id||!f.creatorUserId||!f.type||!(0,e.isValidUrl)(f.url)?null:new i.Widget(f)}}]),v}();return ci.WidgetParser=h,ci}var hi={},ju;function Sm(){if(ju)return hi;ju=1,Object.defineProperty(hi,"__esModule",{value:!0}),hi.runTemplate=i,hi.toString=e;function i(t,r,n){for(var a=Object.assign({},r.data,{matrix_room_id:n.widgetRoomId||"",matrix_user_id:n.currentUserId,matrix_display_name:n.userDisplayName||n.currentUserId,matrix_avatar_url:n.userHttpAvatarUrl||"",matrix_widget_id:r.id,"org.matrix.msc2873.client_id":n.clientId||"","org.matrix.msc2873.client_theme":n.clientTheme||"","org.matrix.msc2873.client_language":n.clientLanguage||"","org.matrix.msc3819.matrix_device_id":n.deviceId||"","org.matrix.msc4039.matrix_base_url":n.baseUrl||""}),s=t,o=0,l=Object.keys(a);o<l.length;o++){var d=l[o],u="$".concat(d).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),h=new RegExp(u,"g");s=s.replace(h,encodeURIComponent(e(a[d])))}return s}function e(t){return t==null?"".concat(t):String(t)}return hi}var vi={},Bu;function Em(){if(Bu)return vi;Bu=1,Object.defineProperty(vi,"__esModule",{value:!0}),vi.WidgetDriver=void 0;var i=ls();function e(l){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(d){return typeof d}:function(d){return d&&typeof Symbol=="function"&&d.constructor===Symbol&&d!==Symbol.prototype?"symbol":typeof d},e(l)}function t(l,d){if(!(l instanceof d))throw new TypeError("Cannot call a class as a function")}function r(l,d){for(var u=0;u<d.length;u++){var h=d[u];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(l,a(h.key),h)}}function n(l,d,u){return d&&r(l.prototype,d),Object.defineProperty(l,"prototype",{writable:!1}),l}function a(l){var d=s(l,"string");return e(d)==="symbol"?d:String(d)}function s(l,d){if(e(l)!=="object"||l===null)return l;var u=l[Symbol.toPrimitive];if(u!==void 0){var h=u.call(l,d);if(e(h)!=="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}var o=function(){function l(){t(this,l)}return n(l,[{key:"validateCapabilities",value:function(u){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(u,h){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedEvent",value:function(u,h,v,m){return Promise.reject(new Error("Failed to override function"))}},{key:"updateDelayedEvent",value:function(u,h){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(u,h,v){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(u){return Promise.resolve([])}},{key:"readRoomEvents",value:function(u,h,v){return Promise.resolve([])}},{key:"readStateEvents",value:function(u,h,v){return Promise.resolve([])}},{key:"readRoomTimeline",value:function(u,h,v,m,f,g){return m===void 0?this.readRoomEvents(h,v,f,[u],g):this.readStateEvents(h,m,f,[u])}},{key:"readRoomState",value:function(u,h,v){return this.readStateEvents(h,v,Number.MAX_SAFE_INTEGER,[u])}},{key:"readEventRelations",value:function(u,h,v,m,f,g,w,S){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(u){u.update({state:i.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(u){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(u,h){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(u){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(u){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(u){}}]),l}();return vi.WidgetDriver=o,vi}var Wu;function ls(){return Wu||(Wu=1,function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=vm();Object.keys(e).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===e[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return e[y]}})});var t=fm();Object.keys(t).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===t[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return t[y]}})});var r=Sl();Object.keys(r).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===r[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return r[y]}})});var n=pl();Object.keys(n).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===n[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return n[y]}})});var a=Sh();Object.keys(a).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===a[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return a[y]}})});var s=pm();Object.keys(s).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===s[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return s[y]}})});var o=ml();Object.keys(o).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===o[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return o[y]}})});var l=vl();Object.keys(l).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===l[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return l[y]}})});var d=fl();Object.keys(d).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===d[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return d[y]}})});var u=bh();Object.keys(u).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===u[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return u[y]}})});var h=gl();Object.keys(h).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===h[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return h[y]}})});var v=mm();Object.keys(v).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===v[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return v[y]}})});var m=gm();Object.keys(m).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===m[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return m[y]}})});var f=Eh();Object.keys(f).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===f[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return f[y]}})});var g=wh();Object.keys(g).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===g[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return g[y]}})});var w=yl();Object.keys(w).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===w[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return w[y]}})});var S=Rh();Object.keys(S).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===S[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return S[y]}})});var R=Th();Object.keys(R).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===R[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return R[y]}})});var C=Ih();Object.keys(C).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===C[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return C[y]}})});var b=ym();Object.keys(b).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===b[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return b[y]}})});var _=Sm();Object.keys(_).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===_[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return _[y]}})});var p=_h();Object.keys(p).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===p[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return p[y]}})});var I=Em();Object.keys(I).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===I[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return I[y]}})})}(As)),As}var Mt=ls();function qu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function da(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?qu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):qu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function bm(i){var e,t,r,n=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,r=Symbol.iterator);n--;){if(t&&(e=i[t])!=null)return e.call(i);if(r&&(e=i[r])!=null)return new ya(e.call(i));t="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function ya(i){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var r=t.done;return Promise.resolve(t.value).then(function(n){return{value:n,done:r}})}return ya=function(r){this.s=r,this.n=r.next},ya.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(r){var n=this.s.return;return n===void 0?Promise.resolve({value:r,done:!0}):e(n.apply(this.s,arguments))},throw:function(r){var n=this.s.return;return n===void 0?Promise.reject(r):e(n.apply(this.s,arguments))}},new ya(i)}var Ri=function(i){return i.PendingEventsChanged="PendingEvent.pendingEventsChanged",i}({});class El extends Hi{constructor(e,t,r,n,a){var s,o,l,d,u,h,v,m,f,g,w,S,R,C;super(n),s=this,this.widgetApi=e,this.capabilities=t,this.roomId=r,c(this,"room",void 0),c(this,"widgetApiReady",void 0),c(this,"roomStateSynced",void 0),c(this,"lifecycle",void 0),c(this,"syncState",null),c(this,"pendingSendingEventsTxId",[]),c(this,"eventEmitter",new xe),c(this,"updateTxId",function(){var p=T(function*(I){if(I.getSender()===s.getUserId()&&s.pendingSendingEventsTxId.some(V=>I.getType()===V.type)){for(var y,P=(y=s.pendingSendingEventsTxId.find(V=>V.id===I.getId()))===null||y===void 0?void 0:y.txId;!P&&s.pendingSendingEventsTxId.length>0;){var L;yield new Promise(V=>s.eventEmitter.once(Ri.PendingEventsChanged,()=>V())),P=(L=s.pendingSendingEventsTxId.find(V=>V.id===I.getId()))===null||L===void 0?void 0:L.txId}P&&(I.setTxnId(P),I.setUnsigned(da(da({},I.getUnsigned()),{},{transaction_id:P}))),s.pendingSendingEventsTxId=s.pendingSendingEventsTxId.filter(V=>V.id!==I.getId()),s.pendingSendingEventsTxId.length===0&&s.eventEmitter.emit(Ri.PendingEventsChanged)}});return function(I){return p.apply(this,arguments)}}()),c(this,"onEvent",function(){var p=T(function*(I){if(I.preventDefault(),I.detail.data.room_id===s.roomId){var y=new ct(I.detail.data);yield s.updateTxId(y),s.syncApi instanceof Sr?(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,void 0,[],[y]):yield s.syncApi.injectRoomEvents(s.room,[],void 0,[y]):(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,[],[y]):E.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),s.emit(ae.Event,y),s.setSyncState(ke.Syncing),E.info("Received event ".concat(y.getId()," ").concat(y.getType()))}else{var{event_id:P,room_id:L}=I.detail.data;E.info("Received event ".concat(P," for a different room ").concat(L,"; discarding"))}yield s.ack(I)});return function(I){return p.apply(this,arguments)}}()),c(this,"onToDevice",function(){var p=T(function*(I){I.preventDefault();var y=new ct({type:I.detail.data.type,sender:I.detail.data.sender,content:I.detail.data.content});I.detail.data.encrypted&&y.makeEncrypted(x.RoomMessageEncrypted,{},"",""),s.emit(ae.ToDeviceEvent,y),s.setSyncState(ke.Syncing),yield s.ack(I)});return function(I){return p.apply(this,arguments)}}()),c(this,"onStateUpdate",function(){var p=T(function*(I){I.preventDefault(),(yield s.supportUpdateState())||E.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'");for(var y of I.detail.data.state)if(y.room_id===s.roomId){var P=new ct(y);s.syncApi instanceof Sr?yield s.syncApi.injectRoomEvents(s.room,void 0,[P]):yield s.syncApi.injectRoomEvents(s.room,[P]),E.info("Updated state entry ".concat(P.getType()," ").concat(P.getStateKey()," to ").concat(P.getId()))}else{var{event_id:L,room_id:V}=I.detail.data;E.info("Received state entry ".concat(L," for a different room ").concat(V,"; discarding"))}yield s.ack(I)});return function(I){return p.apply(this,arguments)}}());var b=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=function(){var p=T(function*(I,y){try{return yield b(I,y)}catch(P){Ku(P)}});return function(I,y){return p.apply(this,arguments)}}();var _=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=function(){var p=T(function*(I,y){try{return yield _(I,y)}catch(P){Ku(P)}});return function(I,y){return p.apply(this,arguments)}}(),this.widgetApiReady=new Promise(p=>this.widgetApi.once("ready",p)),this.roomStateSynced=(o=t.receiveState)!==null&&o!==void 0&&o.length?new Promise(p=>this.widgetApi.once("action:".concat(Mt.WidgetApiToWidgetAction.UpdateState),p)):Promise.resolve(),((l=t.sendEvent)!==null&&l!==void 0&&l.length||(d=t.receiveEvent)!==null&&d!==void 0&&d.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(u=t.sendState)!==null&&u!==void 0&&u.length||(h=t.receiveState)!==null&&h!==void 0&&h.length)&&e.requestCapabilityForRoomTimeline(r),(v=t.sendEvent)===null||v===void 0||v.forEach(p=>e.requestCapabilityToSendEvent(p)),(m=t.receiveEvent)===null||m===void 0||m.forEach(p=>e.requestCapabilityToReceiveEvent(p)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(p=>e.requestCapabilityToSendMessage(p)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(p=>e.requestCapabilityToReceiveMessage(p)),(f=t.sendState)===null||f===void 0||f.forEach(p=>{var{eventType:I,stateKey:y}=p;return e.requestCapabilityToSendState(I,y)}),(g=t.receiveState)===null||g===void 0||g.forEach(p=>{var{eventType:I,stateKey:y}=p;return e.requestCapabilityToReceiveState(I,y)}),(w=t.sendToDevice)===null||w===void 0||w.forEach(p=>e.requestCapabilityToSendToDevice(p)),(S=t.receiveToDevice)===null||S===void 0||S.forEach(p=>e.requestCapabilityToReceiveToDevice(p)),t.sendDelayedEvents&&((R=t.sendEvent)!==null&&R!==void 0&&R.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||(C=t.sendState)!==null&&C!==void 0&&C.length)&&e.requestCapability(Mt.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(Mt.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(Mt.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(Mt.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(Mt.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(Mt.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),a&&e.sendContentLoaded()}supportUpdateState(){var e=this;return T(function*(){return(yield e.widgetApi.getClientVersions()).includes(Mt.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return T(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var n=t.getUserId();if(n&&t.store.storeUser(new Xt(n)),r.slidingSync?t.syncApi=new Hc(r.slidingSync,t,r,t.buildSyncApiOptions()):t.syncApi=new Sr(t,r,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())yield t.roomStateSynced;else{var a,s;yield Promise.all((a=(s=t.capabilities.receiveState)===null||s===void 0?void 0:s.map(function(){var o=T(function*(l){var{eventType:d,stateKey:u}=l,h=yield t.widgetApi.readStateEvents(d,void 0,u,[t.roomId]),v=h.map(m=>new ct(m));t.syncApi instanceof Sr?yield t.syncApi.injectRoomEvents(t.room,void 0,v):yield t.syncApi.injectRoomEvents(t.room,v),v.forEach(m=>{t.emit(ae.Event,m),E.info("Backfilled event ".concat(m.getId()," ").concat(m.getType()," ").concat(m.getStateKey()))})});return function(l){return o.apply(this,arguments)}}()))!==null&&a!==void 0?a:[])}r.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*r.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(ke.Syncing),E.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(Mt.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(Mt.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(Mt.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return T(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,r){var n=this;return T(function*(){var a=t.event.redacts?da(da({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(r){var s=yield n.widgetApi.sendRoomEvent(t.getType(),a,e.roomId,"delay"in r?r.delay:void 0,"parent_delay_id"in r?r.parent_delay_id:void 0).catch(qt);return n.validateSendDelayedEventResponse(s)}var o=t.getTxnId();o&&n.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:o});var l;try{l=yield n.widgetApi.sendRoomEvent(t.getType(),a,e.roomId).catch(qt)}catch(d){throw n.updatePendingEventStatus(e,t,pe.NOT_SENT),d}return e.updatePendingEvent(t,pe.SENT,l.event_id),n.pendingSendingEventsTxId.forEach(d=>{d.txId===o&&(d.id=l.event_id)}),n.eventEmitter.emit(Ri.PendingEventsChanged),{event_id:l.event_id}})()}sendStateEvent(e,t,r){var n=arguments,a=this;return T(function*(){var s=n.length>3&&n[3]!==void 0?n[3]:"",o=yield a.widgetApi.sendStateEvent(t,s,r,e).catch(qt);if(o.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:o.event_id}})()}_unstable_sendDelayedStateEvent(e,t,r,n){var a=arguments,s=this;return T(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:"";if(!(yield s.doesServerSupportUnstableFeature(Ft)))throw new ar("Server does not support the delayed events API","sendDelayedStateEvent");var l=yield s.widgetApi.sendStateEvent(r,o,n,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(qt);return s.validateSendDelayedEventResponse(l)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var r=this;return T(function*(){if(!(yield r.doesServerSupportUnstableFeature(Ft)))throw new ar("Server does not support the delayed events API","updateDelayedEvent");return yield r.widgetApi.updateDelayedEvent(e,t).catch(qt),{}})()}encryptAndSendToDevice(e,t,r){var n=this;return T(function*(){var a=new or(()=>new Map);for(var{userId:s,deviceId:o}of t)a.getOrCreate(s).set(o,r);yield n.widgetApi.sendToDevice(e,!0,Br(a)).catch(qt)})()}sendToDevice(e,t){var r=this;return T(function*(){return yield r.widgetApi.sendToDevice(e,!1,Br(t)).catch(qt),{}})()}getOpenIdToken(){var e=this;return T(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(qt);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return T(function*(){var{eventType:r,batch:n}=e,a=new or(()=>new Map);for(var{userId:s,deviceId:o,payload:l}of n)a.getOrCreate(s).set(o,l);yield t.widgetApi.sendToDevice(r,!1,Br(a)).catch(qt)})()}sendToDeviceViaWidgetApi(e,t,r){var n=this;return T(function*(){yield n.widgetApi.sendToDevice(e,t,Br(r)).catch(qt)})()}checkTurnServers(){var e=this;return T(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(ae.Sync,e,t)}ack(e){var t=this;return T(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return T(function*(){var t=e.widgetApi.getTurnServers(),r=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",r);try{var n=!1,a=!1,s;try{for(var o=bm(t),l;n=!(l=yield o.next()).done;n=!1){var d=l.value;e.turnServers=[{urls:d.uris,username:d.username,credential:d.password}],e.emit(ae.TurnServers,e.turnServers),E.log("Received TURN server: ".concat(d.uris))}}catch(u){a=!0,s=u}finally{try{n&&o.return!=null&&(yield o.return())}finally{if(a)throw s}}}catch(u){E.warn("Error watching TURN servers",u)}finally{e.lifecycle.signal.removeEventListener("abort",r)}})()}}function Ku(i){throw i instanceof Mt.WidgetApiResponseError&&i.data.matrix_api_error?je.fromWidgetApiErrorData(i.data.matrix_api_error):i}function qt(i){throw i instanceof Error&&i.message==="Request timed out"?new Tr("widget api timeout"):i}class _m{constructor(){c(this,"unthreadedReadReceipts",new Map),c(this,"threadedReadReceipts",new or(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e?.forEach(t=>{t.type!==x.Receipt||!t.content||Object.keys(t.content).forEach(r=>{Object.entries(t.content[r]).forEach(n=>{var[a,s]=n;if(go(a))for(var o of Object.keys(s)){var l=t.content[r][a][o],d={data:t.content[r][a][o],type:a,eventId:r};l.thread_id?this.setThreaded(l.thread_id,o,d):this.setUnthreaded(o,d)}})})})}buildAccumulatedReceiptEvent(e){var t={type:x.Receipt,room_id:e,content:{}},r=new or(()=>new or(()=>new Map));for(var[n,a]of this.allUnthreaded())r.getOrCreate(a.eventId).getOrCreate(a.type).set(n,a.data);for(var[s,o]of this.allThreaded())r.getOrCreate(o.eventId).getOrCreate(o.type).set(s,o.data);return t.content=Br(r),r.size>0?t:null}}var Jt=function(i){return i.Invite="invite",i.Leave="leave",i.Join="join",i.Knock="knock",i}({});function wm(i){return"_localTs"in i&&i._localTs!==void 0}class bl{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,c(this,"accountData",{}),c(this,"inviteRooms",{}),c(this,"knockRooms",{}),c(this,"joinRooms",{}),c(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(r=>{this.accumulateRoom(r,Jt.Invite,e.rooms.invite[r],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(r=>{this.accumulateRoom(r,Jt.Join,e.rooms.join[r],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(r=>{this.accumulateRoom(r,Jt.Leave,e.rooms.leave[r],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(r=>{this.accumulateRoom(r,Jt.Knock,e.rooms.knock[r],t)}))}accumulateRoom(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case Jt.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case Jt.Knock:this.accumulateKnockState(e,r);break;case Jt.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case Jt.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:E.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var r=this.inviteRooms[e];t.invite_state.events.forEach(n=>{for(var a=!1,s=0;s<r.invite_state.events.length;s++){var o=r.invite_state.events[s];o.type===n.type&&o.state_key==n.state_key&&(r.invite_state.events[s]=n,a=!0)}a||r.invite_state.events.push(n)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var r=this.knockRooms[e];t.knock_state.events.forEach(n=>{for(var a=!1,s=0;s<r.knock_state.events.length;s++){var o=r.knock_state.events[s];o.type===n.type&&o.state_key==n.state_key&&(r.knock_state.events[s]=n,a=!0)}a||r.knock_state.events.push(n)})}}accumulateJoinState(e,t){var r,n,a,s,o,l,d=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new _m});var u=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(_=>{u._accountData[_.type]=_}),t.unread_notifications&&(u._unreadNotifications=t.unread_notifications),u._unreadThreadNotifications=(r=(n=t[Mi.stable])!==null&&n!==void 0?n:t[Mi.unstable])!==null&&r!==void 0?r:void 0,t.summary){var h,v,m,f="m.heroes",g="m.invited_member_count",w="m.joined_member_count",S=u._summary,R=t.summary;S[f]=(h=R[f])!==null&&h!==void 0?h:S[f],S[w]=(v=R[w])!==null&&v!==void 0?v:S[w],S[g]=(m=R[g])!==null&&m!==void 0?m:S[g]}if(u._receipts.consumeEphemeralEvents((a=t.ephemeral)===null||a===void 0?void 0:a.events),t.timeline&&t.timeline.limited&&(u._timeline=[]),(s=t.state)===null||s===void 0||(s=s.events)===null||s===void 0||s.forEach(_=>{ua(u._currentState,_)}),(o=t["org.matrix.msc4222.state_after"])===null||o===void 0||(o=o.events)===null||o===void 0||o.forEach(_=>{ua(u._currentState,_)}),(l=t.timeline)===null||l===void 0||(l=l.events)===null||l===void 0||l.forEach((_,p)=>{var I;t["org.matrix.msc4222.state_after"]||ua(u._currentState,_);var y;if(d)y=_;else{var P;y=Object.assign({},_),y.unsigned!==void 0&&(y.unsigned=Object.assign({},y.unsigned));var L=(P=_.unsigned)===null||P===void 0?void 0:P.age;L!==void 0&&(y._localTs=Date.now()-L)}u._timeline.push({event:y,token:p===0&&(I=t.timeline.prev_batch)!==null&&I!==void 0?I:null})}),u._timeline.length>this.opts.maxTimelineEntries){for(var C=u._timeline.length-this.opts.maxTimelineEntries,b=C;b<u._timeline.length;b++)if(u._timeline[b].token){u._timeline=u._timeline.slice(b,u._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(n=>{t.invite[n]=this.inviteRooms[n]}),Object.keys(this.knockRooms).forEach(n=>{t.knock[n]=this.knockRooms[n]}),Object.keys(this.joinRooms).forEach(n=>{var a=this.joinRooms[n],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:a._unreadNotifications,unread_thread_notifications:a._unreadThreadNotifications,summary:a._summary};Object.keys(a._accountData).forEach(v=>{s.account_data.events.push(a._accountData[v])});var o=a._receipts.buildAccumulatedReceiptEvent(n);o&&s.ephemeral.events.push(o),a._timeline.forEach(v=>{if(!s.timeline.prev_batch){if(!v.token)return;s.timeline.prev_batch=v.token}var m;!e&&wm(v.event)?(m=Object.assign({},v.event),m.unsigned!==void 0&&(m.unsigned=Object.assign({},m.unsigned)),delete m._localTs,m.unsigned=m.unsigned||{},m.unsigned.age=Date.now()-v.event._localTs):m=v.event,s.timeline.events.push(m)});for(var l=Object.create(null),d=s.timeline.events.length-1;d>=0;d--){var u=s.timeline.events[d];if(!(u.state_key===null||u.state_key===void 0)){var h=Ui(u);h.unsigned&&(h.unsigned.prev_content&&(h.content=h.unsigned.prev_content),h.unsigned.prev_sender&&(h.sender=h.unsigned.prev_sender)),ua(l,h)}}Object.keys(a._currentState).forEach(v=>{Object.keys(a._currentState[v]).forEach(m=>{var f=a._currentState[v][m];s["org.matrix.msc4222.state_after"].events.push(f),l[v]&&l[v][m]&&(f=l[v][m]),s.state.events.push(f)})}),t.join[n]=s});var r=[];return Object.keys(this.accountData).forEach(n=>{r.push(this.accountData[n])}),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function ua(i,e){e.state_key===null||e.state_key===void 0||!e.type||(i[e.type]||(i[e.type]=Object.create(null)),i[e.type][e.state_key]=e)}var _l=function(i){return i[i.Blocked=-1]="Blocked",i[i.Unverified=0]="Unverified",i[i.Verified=1]="Verified",i}({});class Ch{constructor(e){c(this,"deviceId",void 0),c(this,"userId",void 0),c(this,"algorithms",void 0),c(this,"keys",void 0),c(this,"verified",void 0),c(this,"signatures",void 0),c(this,"displayName",void 0),c(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||_l.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}var Vu=function(){},Rm=10;class Oh{constructor(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,c(this,"windowLimit",void 0),c(this,"start",void 0),c(this,"end",void 0),c(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3,(r=t.room)===null||r===void 0||r.on(ie.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,r=n=>{if(!n)throw new Error("No timeline given to initFields");var a,s=n.getEvents();if(!e)a=s.length;else if(a=s.findIndex(d=>d.getId()===e),a<0)throw new Error("getEventTimeline result didn't include requested event");var o=Math.min(s.length,a+Math.ceil(t/2)),l=Math.max(0,o-t);this.start=new Wa(n,l-n.getBaseIndex()),this.end=new Wa(n,o-n.getBaseIndex()),this.eventCount=o-l};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==Z.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==Z.FORWARDS){var r;return(r=this.end)!==null&&r!==void 0?r:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var r=this.getTimelineIndex(e);if(!r)return!1;var n=e==Z.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,Vu("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");var a=this.eventCount-this.windowLimit;return a>0&&this.unpaginate(a,e!=Z.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==Z.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return!!r||!!n}paginate(e,t){var r=arguments,n=this;return T(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:!0,s=r.length>3&&r[3]!==void 0?r[3]:Rm,o=n.getTimelineIndex(e);if(!o)return!1;if(o.pendingPaginate)return o.pendingPaginate;if(n.extend(e,t))return!0;if(!a||s===0)return!1;var l=o.timeline.getPaginationToken(e);if(!l)return!1;var d=n.client.paginateEventTimeline(o.timeline,{backwards:e==Z.BACKWARDS,limit:t}).finally(function(){o.pendingPaginate=void 0}).then(u=>u?n.paginate(e,t,!0,s-1):n.paginate(e,t,!1,0));return o.pendingPaginate=d,d})()}unpaginate(e,t){var r=t?this.start:this.end;if(!r)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,Vu("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var r,n,a=t.getEvents(),s=0,o=a.length;t===this.start.timeline&&(s=this.start.index+t.getBaseIndex()),t===((r=this.end)===null||r===void 0?void 0:r.timeline)&&(o=this.end.index+t.getBaseIndex());for(var l=s;l<o;l++)e.push(a[l]);if(t===((n=this.end)===null||n===void 0?void 0:n.timeline))break;t=t.getNeighbouringTimeline(Z.FORWARDS)}return e}}class Wa{constructor(e,t){this.timeline=e,this.index=t,c(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?Z.BACKWARDS:Z.FORWARDS);return r?(this.timeline=r,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}}var fi="m.login.email.identity",Gu="m.login.msisdn",qa=function(i){return i.Password="m.login.password",i.Recaptcha="m.login.recaptcha",i.Terms="m.login.terms",i.Email="m.login.email.identity",i.Msisdn="m.login.msisdn",i.Sso="m.login.sso",i.SsoUnstable="org.matrix.login.sso",i.Dummy="m.login.dummy",i.RegistrationToken="m.login.registration_token",i.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",i}({});class wl extends Error{constructor(e,t,r){super(e),this.required_stages=t,this.flows=r,c(this,"name","NoAuthFlowFoundError")}}class Mh{constructor(e){var t=this;c(this,"matrixClient",void 0),c(this,"inputs",void 0),c(this,"clientSecret",void 0),c(this,"requestCallback",void 0),c(this,"busyChangedCallback",void 0),c(this,"stateUpdatedCallback",void 0),c(this,"requestEmailTokenCallback",void 0),c(this,"supportedStages",void 0),c(this,"data",void 0),c(this,"emailSid",void 0),c(this,"requestingEmailToken",!1),c(this,"attemptAuthDeferred",null),c(this,"chosenFlow",null),c(this,"currentStage",null),c(this,"emailAttempt",1),c(this,"submitPromise",null),c(this,"requestEmailToken",T(function*(){if(t.requestingEmailToken)E.warn("Could not request email token: Already requesting");else{E.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var r=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=r.sid,E.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return T(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var r=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var n;(n=e.busyChangedCallback)===null||n===void 0||n.call(e,!0);var a=e.data.session?{session:e.data.session}:null;e.doRequest(a).finally(()=>{var s;(s=e.busyChangedCallback)===null||s===void 0||s.call(e,!1)})}return r})()}poll(){var e=this;return T(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==fi&&e.emailSid){var r={sid:e.emailSid,client_secret:e.clientSecret},n=e.matrixClient.getIdentityServerUrl();n&&(r.id_server=new URL(n).host),t={type:fi,threepid_creds:r}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,r=this;return T(function*(){var n,a=t.length>1&&t[1]!==void 0?t[1]:!1;if(!r.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!a){var s;(s=r.busyChangedCallback)===null||s===void 0||s.call(r,!0)}for(;r.submitPromise;)try{yield r.submitPromise}catch{}var o;(n=r.data)!==null&&n!==void 0&&n.session?o=Object.assign({session:r.data.session},e):o=e;try{r.submitPromise=r.doRequest(o,a),yield r.submitPromise}finally{if(r.submitPromise=null,!a){var l;(l=r.busyChangedCallback)===null||l===void 0||l.call(r,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,r=this;return T(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;try{var a=yield r.requestCallback(e,n);r.attemptAuthDeferred.resolve(a),r.attemptAuthDeferred=null}catch(f){var s,o,l,d,u=f instanceof je?f:null,h=(s=u==null||(o=u.data)===null||o===void 0?void 0:o.flows)!==null&&s!==void 0?s:null,v=((l=r.data)===null||l===void 0?void 0:l.flows)||!!h;if(!u||u.httpStatus!==401||!u.data||!v)if(n)E.log("Background poll request failed doing UI auth: ignoring",f);else{var m;(m=r.attemptAuthDeferred)===null||m===void 0||m.reject(f)}u&&!u.data&&(u.data={}),u&&!u.data.flows&&!u.data.completed&&!u.data.session&&(u.data.flows=r.data.flows,u.data.completed=r.data.completed,u.data.session=r.data.session),u&&(r.data=u.data);try{r.startNextAuthStage()}catch(g){r.attemptAuthDeferred.reject(g),r.attemptAuthDeferred=null;return}if(!r.emailSid&&(d=r.chosenFlow)!==null&&d!==void 0&&d.stages.includes(qa.Email))try{yield r.requestEmailToken()}catch(g){r.attemptAuthDeferred.reject(g),r.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,r=this.chooseStage();if(!r)throw new Error("No incomplete flows from the server");if(this.currentStage=r,r===qa.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var n,a;this.stateUpdatedCallback(r,{errcode:((n=this.data)===null||n===void 0?void 0:n.errcode)||"",error:((a=this.data)===null||a===void 0?void 0:a.error)||""});return}this.stateUpdatedCallback(r,r===fi?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),E.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return E.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(r=>!this.supportedStages.has(r)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],r=!!this.inputs.emailAddress||!!this.emailSid,n=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((u,h)=>this.scoreFlow(u)-this.scoreFlow(h));for(var a of t){var s=!1,o=!1;for(var l of a.stages)l===fi?s=!0:l==Gu&&(o=!0);if(s==r&&o==n)return a}var d=[];throw r&&d.push(fi),n&&d.push(Gu),new wl("No appropriate authentication flow found",d,t)}firstUncompletedStage(e){var t,r=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(n=>!r.includes(n))}}function Ph(i,e){return new Promise((t,r)=>{var n=!0,a=i.open(e);a.onupgradeneeded=()=>{n=!1},a.onblocked=()=>r(a.error),a.onsuccess=()=>{var s=a.result;s.close(),n||i.deleteDatabase(e),t(n)},a.onerror=()=>r(a.error)})}var kh=[i=>{i.createObjectStore("users",{keyPath:["userId"]}),i.createObjectStore("accountData",{keyPath:["type"]}),i.createObjectStore("sync",{keyPath:["clobber"]})},i=>{var e=i.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},i=>{i.createObjectStore("client_options",{keyPath:["clobber"]})},i=>{i.createObjectStore("to_device_queue",{autoIncrement:!0})}],Tm=kh.length;function ca(i,e,t){var r=i.openCursor(e);return new Promise((n,a)=>{var s=[];r.onerror=()=>{var o;a(new Error("Query failed: "+((o=r.error)===null||o===void 0?void 0:o.name)))},r.onsuccess=()=>{var o=r.result;if(!o){n(s);return}s.push(t(o)),o.continue()}})}function Ur(i){return new Promise((e,t)=>{i.oncomplete=function(r){e(r)},i.onerror=function(){t(i.error)}})}function Ah(i){return new Promise((e,t)=>{i.onsuccess=function(r){e(r)},i.onerror=function(){t(i.error)}})}function Im(i){return new Promise((e,t)=>{i.onsuccess=()=>e(i),i.onerror=r=>t(r)})}function Ds(i){return Ah(i).then(e=>i.result)}class $u{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),Ph(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,c(this,"dbName",void 0),c(this,"syncAccumulator",void 0),c(this,"db",void 0),c(this,"disconnected",!0),c(this,"_isNewlyCreated",!1),c(this,"syncToDatabasePromise",void 0),c(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new bl}connect(e){var t=this;if(!this.disconnected)return E.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,E.log("LocalIndexedDBStoreBackend.connect: connecting...");var r=this.indexedDB.open(this.dbName,Tm);return r.onupgradeneeded=n=>{var a=r.result,s=n.oldVersion;E.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(s)),s<1&&(this._isNewlyCreated=!0),kh.forEach((o,l)=>{s<=l&&o(a)})},r.onblocked=()=>{E.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},E.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),Ah(r).then(T(function*(){E.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=r.result,t.db.onversionchange=()=>{var n;(n=t.db)===null||n===void 0||n.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e?.()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,r]=e;E.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,r)=>{var n=this.db.transaction(["oob_membership_events"],"readonly"),a=n.objectStore("oob_membership_events"),s=a.index("room"),o=IDBKeyRange.only(e),l=s.openCursor(o),d=[],u=!1;l.onsuccess=()=>{var h=l.result;if(!h)return!d.length&&!u?t(null):t(d);var v=h.value;v.oob_written?u=!0:d.push(v),h.continue()},l.onerror=h=>{r(h)}}).then(t=>(E.log("LL: got ".concat(t?.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var r=this;return T(function*(){E.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var n=r.db.transaction(["oob_membership_events"],"readwrite"),a=n.objectStore("oob_membership_events");t.forEach(o=>{a.put(o)});var s={room_id:e,oob_written:!0,state_key:0};a.put(s),yield Ur(n),E.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return T(function*(){var r=t.db.transaction(["oob_membership_events"],"readonly"),n=r.objectStore("oob_membership_events"),a=n.index("room"),s=IDBKeyRange.only(e),o=Ds(a.openKeyCursor(s,"next")).then(f=>(f?.primaryKey)[1]),l=Ds(a.openKeyCursor(s,"prev")).then(f=>(f?.primaryKey)[1]),[d,u]=yield Promise.all([o,l]),h=t.db.transaction(["oob_membership_events"],"readwrite"),v=h.objectStore("oob_membership_events"),m=IDBKeyRange.bound([e,d],[e,u]);E.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,d],[e,u]),yield Im(v.delete(m))})()}clearDatabase(){return new Promise(e=>{var t;E.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{E.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{var n;E.warn("unable to delete js-sdk store indexeddb: ".concat((n=r.error)===null||n===void 0?void 0:n.name)),e()},r.onsuccess=()=>{E.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(Ui(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return T(function*(){return t.syncToDatabasePromise?(E.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return T(function*(){try{var r=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(r.accountData),t.persistSyncData(r.nextBatch,r.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return E.log("Persisting sync data up to",e),nn(()=>{var r=this.db.transaction(["sync"],"readwrite"),n=r.objectStore("sync");return n.put({clobber:"-",nextBatch:e,roomsData:t}),Ur(r).then(()=>{E.log("Persisted sync data up to",e)})})}persistAccountData(e){return nn(()=>{var t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(var n of e)r.put(n);return Ur(t).then()})}persistUserPresenceEvents(e){return nn(()=>{var t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(var n of e)r.put({userId:n[0],event:n[1]});return Ur(t).then()})}getUserPresenceEvents(){return nn(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return ca(t,void 0,r=>[r.value.userId,r.value.event])})}loadAccountData(){return E.log("LocalIndexedDBStoreBackend: loading account data..."),nn(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return ca(t,void 0,r=>r.value).then(r=>(E.log("LocalIndexedDBStoreBackend: loaded account data"),r))})}loadSyncData(){return E.log("LocalIndexedDBStoreBackend: loading sync data..."),nn(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return ca(t,void 0,r=>r.value).then(r=>(E.log("LocalIndexedDBStoreBackend: loaded sync data"),r.length>1&&E.warn("loadSyncData: More than 1 sync row found."),r.length>0?r[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return ca(t,void 0,r=>{var n;return(n=r.value)===null||n===void 0?void 0:n.options}).then(r=>r[0])})}storeClientOptions(e){var t=this;return T(function*(){var r=t.db.transaction(["client_options"],"readwrite"),n=r.objectStore("client_options");n.put({clobber:"-",options:e}),yield Ur(r)})()}saveToDeviceBatches(e){var t=this;return T(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");for(var a of e)n.add(a);yield Ur(r)})()}getOldestToDeviceBatch(){var e=this;return T(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),r=t.objectStore("to_device_queue"),n=yield Ds(r.openCursor());if(!n)return null;var a=n.value;return{id:n.key,txnId:a.txnId,eventType:a.eventType,batch:a.batch}})()}removeToDeviceBatch(e){var t=this;return T(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");n.delete(e),yield Ur(r)})()}destroy(){var e=this;return T(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}}class Cm{constructor(e,t){this.workerFactory=e,this.dbName=t,c(this,"worker",void 0),c(this,"nextSeq",0),c(this,"inFlight",{}),c(this,"startPromise",void 0),c(this,"onWorkerMessage",r=>{var n=r.data;if(n.command=="closed"){var a;(a=this.onClose)===null||a===void 0||a.call(this)}else if(n.command=="cmd_success"||n.command=="cmd_fail"){if(n.seq===void 0){E.error("Got reply from worker with no seq");return}var s=this.inFlight[n.seq];if(s===void 0){E.error("Got reply for unknown seq "+n.seq);return}if(delete this.inFlight[n.seq],n.command=="cmd_success")s.resolve(n.result);else{var o=new Error(n.error.message);o.name=n.error.name,s.reject(o)}}else E.warn("Unrecognised message from worker: ",n)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return T(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return T(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return T(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{E.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var r,n=this.nextSeq++,a=Promise.withResolvers();return this.inFlight[n]=a,(r=this.worker)===null||r===void 0||r.postMessage({command:e,seq:n,args:t}),a.promise})}destroy(){var e=this;return T(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}}var Om=1e3*60*5;class Dh extends os{static exists(e,t){return $u.exists(e,t)}constructor(e){if(super(e),c(this,"backend",void 0),c(this,"startedUp",!1),c(this,"syncTs",0),c(this,"userModifiedMap",{}),c(this,"emitter",new xe),c(this,"onClose",()=>{this.emitter.emit("closed")}),c(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),c(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),c(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),c(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{E.log("Deleted indexeddb data.")},t=>{throw E.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),c(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var r of this.getUsers())this.userModifiedMap[r.userId]!==r.getLastModifiedTime()&&r.events.presence&&(t.push([r.userId,r.events.presence.event]),this.userModifiedMap[r.userId]=r.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),c(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),c(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),c(this,"setOutOfBandMembers",this.degradable((t,r)=>(super.setOutOfBandMembers(t,r),this.backend.setOutOfBandMembers(t,r)),"setOutOfBandMembers")),c(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),c(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),c(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new Cm(e.workerFactory,e.dbName):this.backend=new $u(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(E.log("IndexedDBStore.startup: already started"),Promise.resolve()):(E.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(E.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{E.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[r,n]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var a=this.createUser(r);n&&a.setPresenceEvent(new ct(n)),this.userModifiedMap[a.userId]=a.getLastModifiedTime(),this.storeUser(a)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>Om}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var r=this,n=t?super[t]:null;return T(function*(){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];try{return yield e.call(r,...s)}catch(l){E.error("IndexedDBStore failure, degrading to MemoryStore",l),r.emitter.emit("degraded",l);try{E.log("IndexedDBStore trying to delete degraded data"),yield r.backend.clearDatabase(),E.log("IndexedDBStore delete after degrading succeeded")}catch(d){E.warn("IndexedDBStore delete after degrading failed",d)}if(n)return n.call(r,...s)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,r=this;return T(function*(){if(!r.localStorage)return t().call(r,e);var n=r.localStorage.getItem(Ls(e));if(n)try{return JSON.parse(n)}catch(a){E.error("Could not parse persisted pending events",a)}return[]})()}setPendingEvents(e,t){var r=()=>super.setPendingEvents,n=this;return T(function*(){if(!n.localStorage)return r().call(n,e,t);t.length>0?n.localStorage.setItem(Ls(e),JSON.stringify(t)):n.localStorage.removeItem(Ls(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function Ls(i){return"mx_pending_events_".concat(i)}var jt="crypto.",Hu=jt+"migration",Us=jt+"account",Mm=jt+"cross_signing_keys",Sa=jt+"inboundgroupsessions/",Pm=jt+"inboundgroupsessions.withheld/",km=jt+"rooms/",Ns=jt+"sessionsneedingbackup";function hn(i){return jt+"sessions/"+i}function Fs(i,e){return Sa+i+"/"+e}function Am(i,e){return Pm+i+"/"+e}function Dm(i){return km+i}class Ji extends Ni{static exists(e){for(var t=e.length,r=0;r<t;r++){var n;if((n=e.key(r))!==null&&n!==void 0&&n.startsWith(jt))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return T(function*(){return Ji.exists(e.store)})()}getMigrationState(){var e=this;return T(function*(){var t;return(t=Ot(e.store,Hu))!==null&&t!==void 0?t:bn.NOT_STARTED})()}setMigrationState(e){var t=this;return T(function*(){Nr(t.store,Hu,e)})()}countEndToEndSessions(e,t){for(var r=0,n=0;n<this.store.length;++n){var a=this.store.key(n);if(a!=null&&a.startsWith(hn(""))){var s=Ot(this.store,a);r+=Object.keys(s??{}).length}}t(r)}_getEndToEndSessions(e){var t=Ot(this.store,hn(e)),r={};for(var[n,a]of Object.entries(t||{}))typeof a=="string"?r[n]={session:a}:r[n]=a;return r}getEndToEndSession(e,t,r,n){var a,s=this._getEndToEndSessions(e);n((a=s[t])!==null&&a!==void 0?a:{})}getEndToEndSessions(e,t,r){var n;r((n=this._getEndToEndSessions(e))!==null&&n!==void 0?n:{})}storeEndToEndSession(e,t,r,n){var a=this._getEndToEndSessions(e)||{};a[t]=r,Nr(this.store,hn(e),a)}getEndToEndSessionsBatch(){var e=this;return T(function*(){for(var t=[],r=0;r<e.store.length;++r){var n;if((n=e.store.key(r))!==null&&n!==void 0&&n.startsWith(hn(""))){var a=e.store.key(r).split("/")[1];for(var s of Object.values(e._getEndToEndSessions(a)))if(t.push(s),t.length>=_n)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return T(function*(){for(var{deviceKey:r,sessionId:n}of e){var a=t._getEndToEndSessions(r)||{};delete a[n],Object.keys(a).length===0?t.store.removeItem(hn(r)):Nr(t.store,hn(r),a)}})()}getEndToEndInboundGroupSession(e,t,r,n){n(Ot(this.store,Fs(e,t)),Ot(this.store,Am(e,t)))}storeEndToEndInboundGroupSession(e,t,r,n){Nr(this.store,Fs(e,t),r)}countEndToEndInboundGroupSessions(){var e=this;return T(function*(){for(var t=0,r=0;r<e.store.length;++r){var n=e.store.key(r);n!=null&&n.startsWith(Sa)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return T(function*(){for(var t=Ot(e.store,Ns)||{},r=[],n=0;n<e.store.length;++n){var a=e.store.key(n);if(a!=null&&a.startsWith(Sa)){var s=a.slice(Sa.length);if(r.push({senderKey:s.slice(0,43),sessionId:s.slice(44),sessionData:Ot(e.store,a),needsBackup:s in t}),r.length>=_n)return r}}return r.length===0?null:r})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return T(function*(){for(var{senderKey:r,sessionId:n}of e){var a=Fs(r,n);t.store.removeItem(a)}})()}getEndToEndRooms(e,t){for(var r={},n=Dm(""),a=0;a<this.store.length;++a){var s=this.store.key(a);if(s!=null&&s.startsWith(n)){var o=s.slice(n.length);r[o]=Ot(this.store,s)}}t(r)}markSessionsNeedingBackup(e){var t=Ot(this.store,Ns)||{};for(var r of e)t[r.senderKey+"/"+r.sessionId]=!0;return Nr(this.store,Ns,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(Us),Promise.resolve()}getAccount(e,t){var r=Ot(this.store,Us);t(r)}storeAccount(e,t){Nr(this.store,Us,t)}getCrossSigningKeys(e,t){var r=Ot(this.store,Mm);t(r)}getSecretStorePrivateKey(e,t,r){var n=Ot(this.store,jt+"ssss_cache.".concat(r));t(n)}storeSecretStorePrivateKey(e,t,r){Nr(this.store,jt+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function Ot(i,e){try{return JSON.parse(i.getItem(e))}catch(t){E.log("Error: Failed to get key %s: %s",e,t.message),E.log(t.stack)}return null}function Nr(i,e,t){i.setItem(e,JSON.stringify(t))}class Lm{constructor(e){this.db=e,c(this,"nextTxnId",0),e.onversionchange=()=>{E.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return T(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return T(function*(){return e})()}deleteAllData(){return T(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return T(function*(){var t=bn.NOT_STARTED;return yield e.doTxn("readonly",[Ce.STORE_ACCOUNT],r=>{var n=r.objectStore(Ce.STORE_ACCOUNT),a=n.get(Ks);a.onsuccess=()=>{var s;t=(s=a.result)!==null&&s!==void 0?s:bn.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return T(function*(){yield t.doTxn("readwrite",[Ce.STORE_ACCOUNT],r=>{var n=r.objectStore(Ce.STORE_ACCOUNT);n.put(e,Ks)})})()}getAccount(e,t){var r=e.objectStore("account"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(a){gt(e,a)}}}storeAccount(e,t){var r=e.objectStore("account");r.put(t,"-")}getCrossSigningKeys(e,t){var r=e.objectStore("account"),n=r.get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(a){gt(e,a)}}}getSecretStorePrivateKey(e,t,r){var n=e.objectStore("account"),a=n.get("ssss_cache:".concat(r));a.onsuccess=function(){try{t(a.result||null)}catch(s){gt(e,s)}}}storeSecretStorePrivateKey(e,t,r){var n=e.objectStore("account");n.put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.count();n.onsuccess=function(){try{t(n.result)}catch(a){gt(e,a)}}}getEndToEndSessions(e,t,r){var n=t.objectStore("sessions"),a=n.index("deviceKey"),s=a.openCursor(e),o={};s.onsuccess=function(){var l=s.result;if(l)o[l.value.sessionId]={session:l.value.session,lastReceivedMessageTs:l.value.lastReceivedMessageTs},l.continue();else try{r(o)}catch(d){gt(t,d)}}}getEndToEndSession(e,t,r,n){var a=r.objectStore("sessions"),s=a.get([e,t]);s.onsuccess=function(){try{s.result?n({session:s.result.session,lastReceivedMessageTs:s.result.lastReceivedMessageTs}):n(null)}catch(o){gt(r,o)}}}storeEndToEndSession(e,t,r,n){var a=n.objectStore("sessions");a.put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return T(function*(){var t=[];return yield e.doTxn("readonly",[Ce.STORE_SESSIONS],r=>{var n=r.objectStore(Ce.STORE_SESSIONS),a=n.openCursor();a.onsuccess=function(){try{var s=a.result;s&&(t.push(s.value),t.length<_n&&s.continue())}catch(o){gt(r,o)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return T(function*(){yield t.doTxn("readwrite",[Ce.STORE_SESSIONS],function(){var r=T(function*(n){try{var a=n.objectStore(Ce.STORE_SESSIONS),s=function*(){var u=a.delete([o,l]);yield new Promise(h=>{u.onsuccess=h})};for(var{deviceKey:o,sessionId:l}of e)yield*s()}catch(d){gt(n,d)}});return function(n){return r.apply(this,arguments)}}())})()}getEndToEndInboundGroupSession(e,t,r,n){var a=!1,s=!1,o=r.objectStore("inbound_group_sessions"),l=o.get([e,t]);l.onsuccess=function(){try{l.result?a=l.result.session:a=null,s!==!1&&n(a,s)}catch(h){gt(r,h)}};var d=r.objectStore("inbound_group_sessions_withheld"),u=d.get([e,t]);u.onsuccess=function(){try{u.result?s=u.result.session:s=null,a!==!1&&n(a,s)}catch(h){gt(r,h)}}}storeEndToEndInboundGroupSession(e,t,r,n){var a=n.objectStore("inbound_group_sessions");a.put({senderCurve25519Key:e,sessionId:t,session:r})}countEndToEndInboundGroupSessions(){var e=this;return T(function*(){var t=0;return yield e.doTxn("readonly",[Ce.STORE_INBOUND_GROUP_SESSIONS],r=>{var n=r.objectStore(Ce.STORE_INBOUND_GROUP_SESSIONS),a=n.count();a.onsuccess=()=>{t=a.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return T(function*(){var t=[];return yield e.doTxn("readonly",[Ce.STORE_INBOUND_GROUP_SESSIONS,Ce.STORE_BACKUP],r=>{var n=r.objectStore(Ce.STORE_INBOUND_GROUP_SESSIONS),a=r.objectStore(Ce.STORE_BACKUP),s=n.openCursor();s.onsuccess=function(){try{var o=s.result;if(o){var l=a.get(o.key);l.onsuccess=()=>{t.push({senderKey:o.value.senderCurve25519Key,sessionId:o.value.sessionId,sessionData:o.value.session,needsBackup:l.result!==void 0}),t.length<_n&&o.continue()}}}catch(d){gt(r,d)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return T(function*(){yield t.doTxn("readwrite",[Ce.STORE_INBOUND_GROUP_SESSIONS],function(){var r=T(function*(n){try{var a=n.objectStore(Ce.STORE_INBOUND_GROUP_SESSIONS),s=function*(){var u=a.delete([o,l]);yield new Promise(h=>{u.onsuccess=h})};for(var{senderKey:o,sessionId:l}of e)yield*s()}catch(d){gt(n,d)}});return function(n){return r.apply(this,arguments)}}())})()}getEndToEndDeviceData(e,t){var r=e.objectStore("device_data"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(a){gt(e,a)}}}getEndToEndRooms(e,t){var r={},n=e.objectStore("rooms"),a=n.openCursor();a.onsuccess=function(){var s=a.result;if(s)r[s.key]=s.value,s.continue();else try{t(r)}catch(o){gt(e,o)}}}markSessionsNeedingBackup(e,t){var r=this;return T(function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(a=>new Promise((s,o)=>{var l=n.put({senderCurve25519Key:a.senderKey,sessionId:a.sessionId});l.onsuccess=s,l.onerror=o})))})()}doTxn(e,t,r){var n=this.db.transaction(t,e),a=Fm(n),s=r(n);return a.then(()=>s)}}var Lh=[i=>{Nm(i)},i=>{i.createObjectStore("account")},i=>{var e=i.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},i=>{i.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("device_data")},i=>{i.createObjectStore("rooms")},i=>{i.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{var e=i.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),i.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},i=>{i.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},i=>{i.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],Uh=Lh.length;function Um(i,e){E.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(Uh)),Lh.forEach((t,r)=>{e<=r&&t(i)})}function Nm(i){var e=i.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function gt(i,e){i._mx_abortexception=e;try{i.abort()}catch{}}function Fm(i){return new Promise((e,t)=>{i.oncomplete=()=>{i._mx_abortexception!==void 0&&t(i._mx_abortexception),e(null)},i.onerror=r=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(E.log("Error performing indexeddb txn",r),t(i.error))},i.onabort=r=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(E.log("Error performing indexeddb txn",r),t(i.error))}})}class Ce{static exists(e,t){return Ph(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((r,n)=>{var a=!0,s=e.open(t);s.onupgradeneeded=()=>{a=!1},s.onblocked=()=>n(s.error),s.onsuccess=()=>{var o=s.result;if(!a)o.close(),e.deleteDatabase(t),r(!1);else{var l=o.transaction([Ce.STORE_ACCOUNT],"readonly"),d=l.objectStore(Ce.STORE_ACCOUNT),u=d.get(Ks);u.onsuccess=()=>{var h,v=(h=u.result)!==null&&h!==void 0?h:bn.NOT_STARTED;r(v===bn.NOT_STARTED)},u.onerror=()=>{n(u.error)},o.close()}},s.onerror=()=>n(s.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,c(this,"backendPromise",void 0),c(this,"backend",void 0)}containsData(){var e=this;return T(function*(){return Ce.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}E.log("connecting to indexeddb ".concat(this.dbName));var r=this.indexedDB.open(this.dbName,Uh);r.onupgradeneeded=n=>{var a=r.result,s=n.oldVersion;Um(a,s)},r.onblocked=()=>{E.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{E.log("Error connecting to indexeddb",n),t(r.error)},r.onsuccess=()=>{var n=r.result;E.log("connected to indexeddb ".concat(this.dbName)),e(new Lm(n))}}).then(e=>e.doTxn("readonly",[Ce.STORE_INBOUND_GROUP_SESSIONS,Ce.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw E.warn("Crypto DB is too new for us to use!",e),new ns(rs.TooNew);E.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new Ji(globalThis.localStorage)}catch(t){return E.warn("Unable to open localStorage: falling back to in-memory store: ".concat(t)),new Ni}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}E.log("Removing indexeddb instance: ".concat(this.dbName));var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{E.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{E.log("Error deleting data from indexeddb",n),t(r.error)},r.onsuccess=()=>{E.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{E.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}}c(Ce,"STORE_ACCOUNT","account");c(Ce,"STORE_SESSIONS","sessions");c(Ce,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");c(Ce,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");c(Ce,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");c(Ce,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");c(Ce,"STORE_DEVICE_DATA","device_data");c(Ce,"STORE_ROOMS","rooms");c(Ce,"STORE_BACKUP","sessions_needing_backup");var Nh=function(i){return i.Email="email",i.Phone="msisdn",i}({}),Fh=new Ye("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),xh=function(i){return i.Gitlab="gitlab",i.Github="github",i.Apple="apple",i.Google="google",i.Facebook="facebook",i.Twitter="twitter",i}({}),jh=function(i){return i.LOGIN="login",i.REGISTER="register",i}({}),Bh="us.cloke.msc4175.tz";class Wh{constructor(e){c(this,"relations",void 0),this.relations=e.filter(t=>!!t)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(r=>r.on(e,t))}off(e,t){this.relations.forEach(r=>r.off(e,t))}}var qh=function(i){return i.Global="Global",i.SetItemError="setItem",i.GetItemError="getItem",i.RemoveItemError="removeItem",i.ClearError="clear",i.QuotaExceededError="QuotaExceededError",i}({});class xm extends xe{}var Kh=new xm,Vh=()=>new Ni;function Rl(i){Vh=i}function Gh(i){var e,t,r;return i.store=(e=i.store)!==null&&e!==void 0?e:new os({localStorage:globalThis.localStorage}),i.scheduler=(t=i.scheduler)!==null&&t!==void 0?t:new Yr,i.cryptoStore=(r=i.cryptoStore)!==null&&r!==void 0?r:Vh(),i}function $h(i){return new Hi(Gh(i))}function Hh(i,e,t,r){var n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new El(i,e,t,Gh(r),n)}const jm=Object.freeze(Object.defineProperty({__proto__:null,AuthType:qa,AutoDiscovery:ye,AutoDiscoveryAction:St,AutoDiscoveryError:Tt,Beacon:Mo,BeaconEvent:Fe,CallEvent:we,CallFeedEvent:Lt,Category:Jt,ClientEvent:ae,ClientPrefix:Xe,ClientStoppedError:eh,ConditionKind:Je,ConditionOperator:Bc,ConnectionError:Tr,ContentHelpers:Ic,DELEGATED_OIDC_COMPATIBILITY:Fh,DEVICE_CODE_SCOPE:fh,DMMemberCountCondition:Wc,Device:Ch,DeviceVerification:_l,Direction:be,DuplicateStrategy:mn,EVENT_VISIBILITY_CHANGE_TYPE:yr,EventEmitterEvents:yo,EventStatus:pe,EventTimeline:Z,EventTimelineSet:Wr,EventType:x,FILTER_RELATED_BY_REL_TYPES:Hr,FILTER_RELATED_BY_SENDERS:$r,FeatureSupport:dt,Filter:pt,GET_LOGIN_TOKEN_CAPABILITY:yh,GroupCall:Xa,GroupCallEvent:Le,GroupCallIntent:Go,GroupCallState:qe,GroupCallStatsReportEvent:pn,GroupCallType:Ki,GuestAccess:Ai,HTTPError:dr,HistoryVisibility:es,HttpApiEvent:Pa,IdentityPrefix:Gt,IdentityProviderBrand:xh,IndexedDBCryptoStore:Ce,IndexedDBStore:Dh,InteractiveAuth:Mh,InvalidCryptoStoreError:ns,InvalidCryptoStoreState:rs,JoinRule:Ho,KNOWN_SAFE_ROOM_VERSION:Bo,KeySignatureUploadError:Zc,KnownMembership:Ee,LOCAL_NOTIFICATION_SETTINGS_PREFIX:_o,LocalStorageCryptoStore:Ji,LocalStorageErrors:qh,LocationAssetType:Jr,MAIN_ROOM_TIMELINE:Dn,MAXIMUM_MATRIX_VERSION:Vc,MINIMUM_MATRIX_VERSION:Kc,MSC3912_RELATION_BASED_REDACTIONS_PROP:Ia,M_ASSET:kn,M_BEACON:Ua,M_BEACON_INFO:ts,M_HTML:fc,M_LOCATION:An,M_MESSAGE:vc,M_POLL_END:ki,M_POLL_KIND_DISCLOSED:Mc,M_POLL_KIND_UNDISCLOSED:Pc,M_POLL_RESPONSE:Rn,M_POLL_START:kc,M_TEXT:$a,M_TIMESTAMP:ur,M_TOPIC:Ha,MatrixClient:Hi,MatrixError:je,MatrixEvent:ct,MatrixEventEvent:Pe,MatrixHttpApi:Fo,MatrixScheduler:Yr,MediaHandlerEvent:gr,MediaPrefix:Vr,MemoryCryptoStore:Ni,MemoryStore:os,Method:q,MsgType:Bt,NoAuthFlowFoundError:wl,NotificationCountType:Me,OidcError:ut,OidcTokenRefresher:mh,PUSHER_DEVICE_ID:rc,PUSHER_ENABLED:Ca,PendingEventOrdering:Xr,Poll:Po,PollEvent:rr,Preset:Za,ProfileKeyMSC4175Timezone:Bh,PushRuleActionName:lr,PushRuleKind:it,REFERENCE_RELATION:Oo,ReceiptType:ht,RelatedRelations:Wh,RelationType:Ke,Relations:Ga,RelationsEvent:gi,RestrictedAllowType:$c,Room:Wi,RoomCreateTypeField:Ci,RoomEvent:ie,RoomMember:wn,RoomMemberEvent:mt,RoomNameType:Dt,RoomState:Pn,RoomStateEvent:Re,RoomSummary:Co,RoomType:Kr,RoomVersionStability:xo,RoomWidgetClient:El,RoomWidgetClientEvent:Ri,RuleId:rt,SERVICE_TYPES:Da,SSOAction:jh,SUPPORTED_MATRIX_VERSIONS:In,SearchOrderBy:Jo,SearchResult:Vi,SecretStorage:Qc,ServerCapabilities:jo,SetPresence:Wo,SlidingSyncEvent:La,StatsReport:Yt,SyncAccumulator:bl,SyncState:ke,THREAD_RELATION_TYPE:De,Thread:Ne,ThreadEvent:vt,ThreadFilterType:Pt,ThreepidMedium:Nh,TimelineIndex:Wa,TimelineWindow:Oh,ToDeviceMessageId:xi,TokenRefreshError:Do,TokenRefreshLogoutError:za,TweakName:Qa,TypedEventEmitter:xe,UNSIGNED_MEMBERSHIP_FIELD:wo,UNSIGNED_THREAD_ID_FIELD:Oi,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:bo,UNSTABLE_MSC2666_MUTUAL_ROOMS:ll,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:dl,UNSTABLE_MSC2666_SHARED_ROOMS:ol,UNSTABLE_MSC2716_MARKER:Eo,UNSTABLE_MSC3088_ENABLED:Ra,UNSTABLE_MSC3088_PURPOSE:wa,UNSTABLE_MSC3089_BRANCH:zt,UNSTABLE_MSC3089_LEAF:So,UNSTABLE_MSC3089_TREE_SUBTYPE:Ta,UNSTABLE_MSC3852_LAST_SEEN_UA:gh,UNSTABLE_MSC4133_EXTENDED_PROFILES:ul,UNSTABLE_MSC4140_DELAYED_EVENTS:Ft,UnsupportedDelayedEventsEndpointError:ar,UpdateDelayedEventAction:wr,User:Xt,UserEvent:yt,Visibility:Gc,anySignal:Lo,calculateRetryBackoff:Uo,completeAuthorizationCodeGrant:vh,createClient:$h,createNewMatrixCall:Tn,createRoomWidgetClient:Hh,decodeBase64:Gr,decodeIdToken:nl,determineFeatureSupport:wi,discoverAndValidateOIDCIssuerWellKnown:as,encodeBase64:yi,encodeUnpaddedBase64:Vo,encodeUnpaddedBase64Url:qi,fixNotificationCountOnDecryption:cl,generateAuthorizationParams:uh,generateAuthorizationUrl:ch,generateOidcAuthorizationUrl:hh,generateScope:$i,getBeaconInfoIdentifier:Pi,getHttpUriForMxc:Fi,inMainTimelineForReceipt:Mn,isDmMemberCountCondition:qc,isEventTypeSame:pc,isPollEvent:ko,isTimestampInDuration:Ma,localStorageErrorsEventsEmitter:Kh,parseErrorResponse:Ya,registerOidcClient:ph,retryNetworkOperation:ka,safeGetRetryAfterMs:Ja,setCryptoStoreFactory:Rl,threadFilterTypeToFilter:hl,threadIdForReceipt:Qr,timeoutSignal:Bi,validateAuthMetadata:rl,validateAuthMetadataAndKeys:ss,validateBearerTokenResponse:sl,validateIdToken:il,validateStoredUserState:al},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var po;try{po=globalThis.indexedDB}catch{}po&&Rl(()=>new Ce(po,"matrix-js-sdk:crypto"));globalThis.matrixcs=jm;const Qm=Object.freeze(Object.defineProperty({__proto__:null,AuthType:qa,AutoDiscovery:ye,AutoDiscoveryAction:St,AutoDiscoveryError:Tt,Beacon:Mo,BeaconEvent:Fe,CallEvent:we,CallFeedEvent:Lt,Category:Jt,ClientEvent:ae,ClientPrefix:Xe,ClientStoppedError:eh,ConditionKind:Je,ConditionOperator:Bc,ConnectionError:Tr,ContentHelpers:Ic,DELEGATED_OIDC_COMPATIBILITY:Fh,DEVICE_CODE_SCOPE:fh,DMMemberCountCondition:Wc,Device:Ch,DeviceVerification:_l,Direction:be,DuplicateStrategy:mn,EVENT_VISIBILITY_CHANGE_TYPE:yr,EventEmitterEvents:yo,EventStatus:pe,EventTimeline:Z,EventTimelineSet:Wr,EventType:x,FILTER_RELATED_BY_REL_TYPES:Hr,FILTER_RELATED_BY_SENDERS:$r,FeatureSupport:dt,Filter:pt,GET_LOGIN_TOKEN_CAPABILITY:yh,GroupCall:Xa,GroupCallEvent:Le,GroupCallIntent:Go,GroupCallState:qe,GroupCallStatsReportEvent:pn,GroupCallType:Ki,GuestAccess:Ai,HTTPError:dr,HistoryVisibility:es,HttpApiEvent:Pa,IdentityPrefix:Gt,IdentityProviderBrand:xh,IndexedDBCryptoStore:Ce,IndexedDBStore:Dh,InteractiveAuth:Mh,InvalidCryptoStoreError:ns,InvalidCryptoStoreState:rs,JoinRule:Ho,KNOWN_SAFE_ROOM_VERSION:Bo,KeySignatureUploadError:Zc,KnownMembership:Ee,LOCAL_NOTIFICATION_SETTINGS_PREFIX:_o,LocalStorageCryptoStore:Ji,LocalStorageErrors:qh,LocationAssetType:Jr,MAIN_ROOM_TIMELINE:Dn,MAXIMUM_MATRIX_VERSION:Vc,MINIMUM_MATRIX_VERSION:Kc,MSC3912_RELATION_BASED_REDACTIONS_PROP:Ia,M_ASSET:kn,M_BEACON:Ua,M_BEACON_INFO:ts,M_HTML:fc,M_LOCATION:An,M_MESSAGE:vc,M_POLL_END:ki,M_POLL_KIND_DISCLOSED:Mc,M_POLL_KIND_UNDISCLOSED:Pc,M_POLL_RESPONSE:Rn,M_POLL_START:kc,M_TEXT:$a,M_TIMESTAMP:ur,M_TOPIC:Ha,MatrixClient:Hi,MatrixError:je,MatrixEvent:ct,MatrixEventEvent:Pe,MatrixHttpApi:Fo,MatrixScheduler:Yr,MediaHandlerEvent:gr,MediaPrefix:Vr,MemoryCryptoStore:Ni,MemoryStore:os,Method:q,MsgType:Bt,NoAuthFlowFoundError:wl,NotificationCountType:Me,OidcError:ut,OidcTokenRefresher:mh,PUSHER_DEVICE_ID:rc,PUSHER_ENABLED:Ca,PendingEventOrdering:Xr,Poll:Po,PollEvent:rr,Preset:Za,ProfileKeyMSC4175Timezone:Bh,PushRuleActionName:lr,PushRuleKind:it,REFERENCE_RELATION:Oo,ReceiptType:ht,RelatedRelations:Wh,RelationType:Ke,Relations:Ga,RelationsEvent:gi,RestrictedAllowType:$c,Room:Wi,RoomCreateTypeField:Ci,RoomEvent:ie,RoomMember:wn,RoomMemberEvent:mt,RoomNameType:Dt,RoomState:Pn,RoomStateEvent:Re,RoomSummary:Co,RoomType:Kr,RoomVersionStability:xo,RoomWidgetClient:El,RoomWidgetClientEvent:Ri,RuleId:rt,SERVICE_TYPES:Da,SSOAction:jh,SUPPORTED_MATRIX_VERSIONS:In,SearchOrderBy:Jo,SearchResult:Vi,SecretStorage:Qc,ServerCapabilities:jo,SetPresence:Wo,SlidingSyncEvent:La,StatsReport:Yt,SyncAccumulator:bl,SyncState:ke,THREAD_RELATION_TYPE:De,Thread:Ne,ThreadEvent:vt,ThreadFilterType:Pt,ThreepidMedium:Nh,TimelineIndex:Wa,TimelineWindow:Oh,ToDeviceMessageId:xi,TokenRefreshError:Do,TokenRefreshLogoutError:za,TweakName:Qa,TypedEventEmitter:xe,UNSIGNED_MEMBERSHIP_FIELD:wo,UNSIGNED_THREAD_ID_FIELD:Oi,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:bo,UNSTABLE_MSC2666_MUTUAL_ROOMS:ll,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:dl,UNSTABLE_MSC2666_SHARED_ROOMS:ol,UNSTABLE_MSC2716_MARKER:Eo,UNSTABLE_MSC3088_ENABLED:Ra,UNSTABLE_MSC3088_PURPOSE:wa,UNSTABLE_MSC3089_BRANCH:zt,UNSTABLE_MSC3089_LEAF:So,UNSTABLE_MSC3089_TREE_SUBTYPE:Ta,UNSTABLE_MSC3852_LAST_SEEN_UA:gh,UNSTABLE_MSC4133_EXTENDED_PROFILES:ul,UNSTABLE_MSC4140_DELAYED_EVENTS:Ft,UnsupportedDelayedEventsEndpointError:ar,UpdateDelayedEventAction:wr,User:Xt,UserEvent:yt,Visibility:Gc,anySignal:Lo,calculateRetryBackoff:Uo,completeAuthorizationCodeGrant:vh,createClient:$h,createNewMatrixCall:Tn,createRoomWidgetClient:Hh,decodeBase64:Gr,decodeIdToken:nl,determineFeatureSupport:wi,discoverAndValidateOIDCIssuerWellKnown:as,encodeBase64:yi,encodeUnpaddedBase64:Vo,encodeUnpaddedBase64Url:qi,fixNotificationCountOnDecryption:cl,generateAuthorizationParams:uh,generateAuthorizationUrl:ch,generateOidcAuthorizationUrl:hh,generateScope:$i,getBeaconInfoIdentifier:Pi,getHttpUriForMxc:Fi,inMainTimelineForReceipt:Mn,isDmMemberCountCondition:qc,isEventTypeSame:pc,isPollEvent:ko,isTimestampInDuration:Ma,localStorageErrorsEventsEmitter:Kh,parseErrorResponse:Ya,registerOidcClient:ph,retryNetworkOperation:ka,safeGetRetryAfterMs:Ja,setCryptoStoreFactory:Rl,threadFilterTypeToFilter:hl,threadIdForReceipt:Qr,timeoutSignal:Bi,validateAuthMetadata:rl,validateAuthMetadataAndKeys:ss,validateBearerTokenResponse:sl,validateIdToken:il,validateStoredUserState:al},Symbol.toStringTag,{value:"Module"}));export{Gm as A,Xm as B,ot as C,Ip as D,x as E,Ce as F,bn as G,es as H,Jm as I,Op as J,Ee as K,Km as L,q as M,Qm as N,jr as S,xe as T,$m as U,T as _,c as a,Vm as b,$h as c,qm as d,Gr as e,Q as f,xi as g,Uo as h,_l as i,Ch as j,Fn as k,E as l,Bt as m,je as n,Xe as o,eh as p,yi as q,Hm as r,zr as s,zm as t,_r as u,Pe as v,or as w,fu as x,Zd as y,Ym as z};
