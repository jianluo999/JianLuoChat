import{_ as C,c as m,a as o,t as i,b as I,w as _,v as L,d as f,F as S,r as D,e as E,u as V,f as R,g as u,h as w,i as T,o as g,n as U}from"./index-Cl5nGqgc.js";import{c as F}from"./browser-index-CPs8hK5u.js";const N={name:"MatrixRealLogin",emits:["login-success"],setup(a,{emit:s}){const{t:c}=V(),r=R(),x=T(),l=u(""),e=u("matrix.org"),v=u(""),h=u(!1),d=u(""),b=["matrix.org","kde.org","mozilla.org","t2bot.io","tchncs.de"],k=w(()=>l.value&&e.value?`@${l.value}:${e.value}`:"@username:homeserver.com"),y=w(()=>l.value.trim()&&e.value.trim()&&v.value.trim());return{username:l,homeserver:e,password:v,isLoading:h,error:d,popularServers:b,fullMatrixId:k,canLogin:y,handleLogin:async()=>{if(!(!y.value||h.value)){h.value=!0,d.value="";try{const t=`https://${e.value}`,p=F({baseUrl:t,userId:k.value}),n=await p.login("m.login.password",{user:l.value,password:v.value,initial_device_display_name:"JianLuoChat Matrix Client"});localStorage.setItem("matrix_access_token",n.access_token),localStorage.setItem("matrix_login_info",JSON.stringify({userId:n.user_id,accessToken:n.access_token,deviceId:n.device_id,homeserver:e.value})),await r.setClient(p),await r.setLoginInfo({userId:n.user_id,accessToken:n.access_token,deviceId:n.device_id,homeserver:e.value}),s("login-success",{userId:n.user_id,homeserver:e.value}),console.log("登录成功，立即跳转到聊天页面..."),x.push("/chat"),console.log("在后台启动Matrix客户端..."),p.startClient().then(()=>{console.log("Matrix客户端已在后台启动完成")}).catch(M=>{console.error("后台启动Matrix客户端失败:",M)})}catch(t){console.error("Matrix login failed:",t),t.errcode==="M_FORBIDDEN"?d.value=c("matrix.realLogin.errors.invalidCredentials"):t.errcode==="M_USER_DEACTIVATED"?d.value=c("matrix.realLogin.errors.userDeactivated"):t.name==="ConnectionError"?d.value=c("matrix.realLogin.errors.connectionFailed",{server:e.value}):d.value=c("matrix.realLogin.errors.loginFailed",{message:t.message})}finally{h.value=!1}}}}}},B={class:"matrix-real-login"},K={class:"login-container"},A={class:"login-header"},P={class:"login-form"},z={class:"form-group"},J={class:"matrix-id-input"},O=["placeholder"],j=["placeholder"],q={class:"matrix-id-preview"},G={class:"form-group"},H=["placeholder"],Q={class:"homeserver-suggestions"},W={class:"server-chips"},X=["onClick"],Y={class:"form-actions"},Z=["disabled"],$={key:0,class:"loading-spinner"},ee={key:0,class:"error-message"},oe={class:"login-help"},re={href:"https://app.element.io/#/register",target:"_blank"},se={href:"https://matrix.org/docs/guides/introduction",target:"_blank"};function ae(a,s,c,r,x,l){return g(),m("div",B,[o("div",K,[o("div",A,[o("h2",null,i(a.$t("matrix.realLogin.title")),1),o("p",null,i(a.$t("matrix.realLogin.subtitle")),1)]),o("div",P,[o("div",z,[o("label",null,i(a.$t("matrix.realLogin.matrixId")),1),o("div",J,[s[7]||(s[7]=o("span",{class:"id-prefix"},"@",-1)),_(o("input",{"onUpdate:modelValue":s[0]||(s[0]=e=>r.username=e),type:"text",placeholder:a.$t("matrix.realLogin.usernamePlaceholder"),class:"form-input",onKeyup:s[1]||(s[1]=f((...e)=>r.handleLogin&&r.handleLogin(...e),["enter"]))},null,40,O),[[L,r.username]]),s[8]||(s[8]=o("span",{class:"id-colon"},":",-1)),_(o("input",{"onUpdate:modelValue":s[2]||(s[2]=e=>r.homeserver=e),type:"text",placeholder:a.$t("matrix.realLogin.homeserverPlaceholder"),class:"form-input homeserver-input",onKeyup:s[3]||(s[3]=f((...e)=>r.handleLogin&&r.handleLogin(...e),["enter"]))},null,40,j),[[L,r.homeserver]])]),o("div",q,i(r.fullMatrixId),1)]),o("div",G,[o("label",null,i(a.$t("matrix.realLogin.password")),1),_(o("input",{"onUpdate:modelValue":s[4]||(s[4]=e=>r.password=e),type:"password",placeholder:a.$t("matrix.realLogin.passwordPlaceholder"),class:"form-input",onKeyup:s[5]||(s[5]=f((...e)=>r.handleLogin&&r.handleLogin(...e),["enter"]))},null,40,H),[[L,r.password]])]),o("div",Q,[o("p",null,i(a.$t("matrix.realLogin.popularServers")),1),o("div",W,[(g(!0),m(S,null,D(r.popularServers,e=>(g(),m("button",{key:e,onClick:v=>r.homeserver=e,class:U(["server-chip",{active:r.homeserver===e}])},i(e),11,X))),128))])]),o("div",Y,[o("button",{onClick:s[6]||(s[6]=(...e)=>r.handleLogin&&r.handleLogin(...e)),class:"login-btn",disabled:!r.canLogin||r.isLoading},[r.isLoading?(g(),m("span",$)):I("",!0),E(" "+i(r.isLoading?a.$t("matrix.realLogin.connecting"):a.$t("matrix.realLogin.login")),1)],8,Z)]),r.error?(g(),m("div",ee,i(r.error),1)):I("",!0),o("div",oe,[o("p",null,i(a.$t("matrix.realLogin.noAccount")),1),o("ul",null,[o("li",null,[o("a",re,i(a.$t("matrix.realLogin.registerElement")),1)]),o("li",null,[o("a",se,i(a.$t("matrix.realLogin.learnMore")),1)])])])])])])}const le=C(N,[["render",ae],["__scopeId","data-v-7f222489"]]);export{le as default};
