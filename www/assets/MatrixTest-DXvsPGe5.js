const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/browser-index-CPs8hK5u.js","assets/index-Cl5nGqgc.js","assets/index-Dfi89B19.css"])))=>i.map(i=>d[i]);
import{T as P,g as k,h as L,C as J,j as K,y as F,c as a,a as t,b,n as j,B as r,t as g,F as H,r as W,w as q,v as G,d as Y,e as E,o as c,_ as Q}from"./index-Cl5nGqgc.js";const X=P("matrix-simple",()=>{const m=k(null),v=k(!1),u=k(null),y=k([]),h=k(null),C=L(()=>!!m.value),I=L(()=>y.value.find(e=>e.roomId===h.value)),w=async()=>{if(m.value)try{m.value.stopClient(),m.value=null}catch(e){console.warn("æ¸…ç†å®¢æˆ·ç«¯æ—¶å‡ºé”™:",e)}u.value=null,y.value=[],h.value=null},M=async(e,o,s)=>{if(v.value)return console.log("âš ï¸ å®¢æˆ·ç«¯æ­£åœ¨åˆå§‹åŒ–ä¸­"),!1;try{v.value=!0,u.value=null,console.log(`ğŸš€ åˆ›å»ºMatrixå®¢æˆ·ç«¯: ${e} @ ${s}`),await w();const{createClient:d,MemoryStore:_,IndexedDBStore:U}=await J(async()=>{const{createClient:n,MemoryStore:x,IndexedDBStore:N}=await import("./browser-index-CPs8hK5u.js").then(V=>V.N);return{createClient:n,MemoryStore:x,IndexedDBStore:N}},__vite__mapDeps([0,1,2])),z=`jianluochat-device-${e.split(":")[0].substring(1)}`;let R=localStorage.getItem(z);if(!R){const n=Date.now(),x=Math.random().toString(36).substring(2,10);R=`JIANLUOCHAT_${n}_${x}`,localStorage.setItem(z,R),console.log("ğŸ†” ç”Ÿæˆè®¾å¤‡ID:",R)}const $={useAuthorizationHeader:!0};try{window.indexedDB&&localStorage?($.store=new U({indexedDB:window.indexedDB,dbName:`jianluochat-${e.split(":")[0].substring(1)}`,localStorage}),console.log("ğŸ“¦ ä½¿ç”¨IndexedDBå­˜å‚¨")):($.store=new _({localStorage}),console.log("ğŸ“¦ ä½¿ç”¨Memoryå­˜å‚¨"))}catch(n){console.warn("å­˜å‚¨è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤:",n),$.store=new _({localStorage})}const f=d({baseUrl:`https://${s}`,accessToken:o,userId:e,deviceId:R,timelineSupport:!0,...$});console.log("ğŸ“¦ åˆå§‹åŒ–å­˜å‚¨...");try{await f.store.startup(),console.log("âœ… å­˜å‚¨åˆå§‹åŒ–æˆåŠŸ")}catch(n){console.warn("å­˜å‚¨åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨:",n.message),f.store=new _({localStorage}),await f.store.startup()}return f.on("sync",(n,x,N)=>{console.log(`ğŸ”„ åŒæ­¥çŠ¶æ€: ${x} -> ${n}`),n==="PREPARED"||n==="SYNCING"?(console.log("âœ… åŒæ­¥å°±ç»ªï¼ŒåŠ è½½æˆ¿é—´..."),setTimeout(()=>S(),1e3)):n==="ERROR"&&(console.error("âŒ åŒæ­¥é”™è¯¯:",N),u.value="åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥")}),f.on("Room.timeline",(n,x)=>{n.getType()==="m.room.message"&&(console.log("ğŸ’¬ æ–°æ¶ˆæ¯:",n.getContent().body),S())}),f.on("error",n=>{console.error("âŒ å®¢æˆ·ç«¯é”™è¯¯:",n),n.message&&(n.value=`å®¢æˆ·ç«¯é”™è¯¯: ${n.message}`)}),m.value=f,console.log("âœ… Matrixå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ"),console.log("ğŸš€ å¯åŠ¨å®¢æˆ·ç«¯..."),await f.startClient({initialSyncLimit:10,lazyLoadMembers:!0}),console.log("âœ… å®¢æˆ·ç«¯å¯åŠ¨æˆåŠŸ"),!0}catch(d){return console.error("âŒ åˆ›å»ºå®¢æˆ·ç«¯å¤±è´¥:",d),d.value=`åˆ›å»ºå®¢æˆ·ç«¯å¤±è´¥: ${d.message}`,!1}finally{v.value=!1}},S=()=>{if(!m.value){console.warn("âš ï¸ å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æˆ¿é—´");return}try{const e=m.value.getRooms();if(console.log(`ğŸ“Š è·å–åˆ° ${e.length} ä¸ªæˆ¿é—´`),e.length===0){console.log("ğŸ“­ æš‚æ— æˆ¿é—´æ•°æ®"),y.value=[];return}y.value=e.map(o=>{try{return{roomId:o.roomId,name:o.name||o.roomId||"æœªå‘½åæˆ¿é—´",topic:D(o),memberCount:B(o),unreadCount:A(o),lastMessage:T(o)}}catch(s){return console.warn("âš ï¸ å¤„ç†æˆ¿é—´æ•°æ®å¤±è´¥:",o.roomId,s),{roomId:o.roomId,name:o.roomId||"æœªå‘½åæˆ¿é—´",topic:"",memberCount:0,unreadCount:0,lastMessage:null}}}).filter(o=>o!==null),console.log(`âœ… æˆ¿é—´åˆ—è¡¨æ›´æ–°å®Œæˆï¼Œå…± ${y.value.length} ä¸ªæˆ¿é—´`)}catch(e){console.error("âŒ åŠ è½½æˆ¿é—´å¤±è´¥:",e),e.value=`åŠ è½½æˆ¿é—´å¤±è´¥: ${e}`}},D=e=>{try{return e.currentState?.getStateEvents("m.room.topic","")?.getContent()?.topic||""}catch{return""}},B=e=>{try{return e.getJoinedMemberCount()||0}catch{return 0}},A=e=>{try{return e.getUnreadNotificationCount()||0}catch{return 0}},T=e=>{try{const s=e.getLiveTimeline().getEvents();for(let d=s.length-1;d>=0;d--){const _=s[d];if(_.getType()==="m.room.message")return{body:_.getContent().body||"",sender:_.getSender(),timestamp:_.getTs()}}return null}catch(o){return console.warn("è·å–æœ€åæ¶ˆæ¯å¤±è´¥:",o),null}};return{matrixClient:m,isInitializing:v,error:u,rooms:y,currentRoomId:h,isConnected:C,currentRoom:I,createClient:M,cleanup:w,loadRooms:S,sendMessage:async(e,o)=>{if(!m.value)throw new Error("å®¢æˆ·ç«¯æœªåˆå§‹åŒ–");try{const s={body:o,msgtype:"m.text"};await m.value.sendEvent(e,"m.room.message",s),console.log("âœ… æ¶ˆæ¯å‘é€æˆåŠŸ")}catch(s){throw console.error("âŒ å‘é€æ¶ˆæ¯å¤±è´¥:",s),s}},selectRoom:e=>{h.value=e,console.log("ğŸ“ é€‰æ‹©æˆ¿é—´:",e)},retryInitialization:async()=>{console.log("ğŸ”„ å¼€å§‹é‡è¯•åˆå§‹åŒ–...");const e=localStorage.getItem("matrix-login-info"),o=localStorage.getItem("matrix_access_token");if(console.log("ğŸ“‹ å­˜å‚¨çŠ¶æ€æ£€æŸ¥:",{hasLoginInfo:!!e,hasAccessToken:!!o}),o&&!e)return console.warn("âš ï¸ æ£€æµ‹åˆ°å­˜å‚¨çŠ¶æ€ä¸ä¸€è‡´ï¼Œå»ºè®®æ¸…ç†åé‡æ–°ç™»å½•"),u.value="å­˜å‚¨çŠ¶æ€ä¸ä¸€è‡´ï¼Œè¯·æ¸…ç†åé‡æ–°ç™»å½•",!1;if(!e)return u.value="æ²¡æœ‰æ‰¾åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•",!1;try{const s=JSON.parse(e);return console.log("ğŸ“‹ å°è¯•ä½¿ç”¨ç™»å½•ä¿¡æ¯:",{userId:s.userId,homeserver:s.homeserver,hasAccessToken:!!s.accessToken}),await M(s.userId,s.accessToken,s.homeserver)}catch(s){return console.error("é‡è¯•åˆå§‹åŒ–å¤±è´¥:",s),s.value=`é‡è¯•å¤±è´¥: ${s.message}`,!1}},clearAllStorage:()=>{console.log("ğŸ§¹ æ¸…ç†æ‰€æœ‰Matrixç›¸å…³å­˜å‚¨æ•°æ®...");const e=[];for(let o=0;o<localStorage.length;o++){const s=localStorage.key(o);s&&(s.includes("matrix")||s.includes("jianluochat")||s.includes("Matrix")||s.startsWith("mx_"))&&e.push(s)}if(e.forEach(o=>{localStorage.removeItem(o),console.log(`ğŸ—‘ï¸ å·²æ¸…ç†: ${o}`)}),window.indexedDB)try{["jianluochat-sync","jianluochat-crypto","matrix-js-sdk:crypto"].forEach(s=>{const d=window.indexedDB.deleteDatabase(s);d.onsuccess=()=>console.log(`ğŸ—‘ï¸ å·²æ¸…ç†æ•°æ®åº“: ${s}`),d.onerror=()=>console.log(`âš ï¸ æ¸…ç†æ•°æ®åº“å¤±è´¥: ${s}`)})}catch(o){console.warn("æ¸…ç†IndexedDBæ—¶å‡ºé”™:",o)}console.log("âœ… å­˜å‚¨æ¸…ç†å®Œæˆ")}}}),Z={class:"matrix-test-page"},ee={class:"status-section"},oe={class:"status-indicator"},te={key:0,class:"status-loading"},se={key:1,class:"status-connected"},ne={key:2,class:"status-error"},le={key:3,class:"status-disconnected"},re={key:0,class:"error-message"},ae={class:"error-actions"},ce=["disabled"],ie={key:0,class:"rooms-section"},ue={class:"rooms-header"},de={key:0,class:"no-rooms"},ge={key:1,class:"rooms-list"},me=["onClick"],ve={class:"room-info"},ye={key:0,class:"room-topic"},he={class:"room-meta"},pe={class:"member-count"},_e={key:0,class:"unread-count"},fe={key:1,class:"last-message"},we={key:1,class:"current-room-section"},Ce={class:"message-input"},Ie=["disabled"],Se={class:"debug-section"},xe={class:"debug-info"},be=K({__name:"MatrixTest",setup(m){const v=X(),u=k(""),{isConnected:y,isInitializing:h,error:C,rooms:I,currentRoomId:w,currentRoom:M}=v,S=async()=>{console.log("ğŸ”„ é‡è¯•è¿æ¥..."),await v.retryInitialization()},D=()=>{confirm("âš ï¸ è¿™å°†æ¸…ç†æ‰€æœ‰Matrixç›¸å…³æ•°æ®å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ")&&(console.log("ğŸ§¹ ç”¨æˆ·ç¡®è®¤æ¸…ç†å­˜å‚¨..."),v.clearAllStorage(),setTimeout(()=>{console.log("ğŸ”„ è·³è½¬åˆ°ç™»å½•é¡µé¢..."),window.location.href="/login"},1e3))},B=()=>{console.log("ğŸ”„ åˆ·æ–°æˆ¿é—´åˆ—è¡¨..."),v.loadRooms()},A=p=>{console.log("ğŸ“ é€‰æ‹©æˆ¿é—´:",p),v.selectRoom(p)},T=async()=>{if(!(!u.value.trim()||!w.value))try{await v.sendMessage(w.value,u.value.trim()),u.value="",console.log("âœ… æ¶ˆæ¯å‘é€æˆåŠŸ")}catch(p){console.error("âŒ å‘é€æ¶ˆæ¯å¤±è´¥:",p),alert("å‘é€æ¶ˆæ¯å¤±è´¥: "+p)}};return F(async()=>{console.log("ğŸš€ Matrixæµ‹è¯•é¡µé¢åŠ è½½"),localStorage.getItem("matrix-login-info")?(console.log("ğŸ“‹ å‘ç°ç™»å½•ä¿¡æ¯ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥..."),await S()):console.log("âš ï¸ æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•")}),(p,l)=>(c(),a("div",Z,[l[8]||(l[8]=t("div",{class:"header"},[t("h1",null,"ğŸ§ª Matrixå®¢æˆ·ç«¯æµ‹è¯•"),t("p",null,"åŸºäºElement Webæœ€ä½³å®è·µçš„ç®€åŒ–å®ç°")],-1)),t("div",ee,[t("div",{class:j(["status-card",{connected:r(y),error:!!r(C)}])},[l[1]||(l[1]=t("h3",null,"è¿æ¥çŠ¶æ€",-1)),t("div",oe,[r(h)?(c(),a("span",te,"ğŸ”„ åˆå§‹åŒ–ä¸­...")):r(y)?(c(),a("span",se,"âœ… å·²è¿æ¥")):r(C)?(c(),a("span",ne,"âŒ è¿æ¥å¤±è´¥")):(c(),a("span",le,"âšª æœªè¿æ¥"))]),r(C)?(c(),a("div",re,[t("p",null,g(r(C)),1),t("div",ae,[t("button",{onClick:S,disabled:r(h),class:"retry-btn"}," ğŸ”„ é‡è¯•è¿æ¥ ",8,ce),t("button",{onClick:D,class:"clear-btn"}," ğŸ§¹ æ¸…ç†å­˜å‚¨å¹¶é‡æ–°ç™»å½• ")])])):b("",!0)],2)]),r(y)?(c(),a("div",ie,[t("div",ue,[t("h3",null,"æˆ¿é—´åˆ—è¡¨ ("+g(r(I).length)+")",1),t("button",{onClick:B,class:"load-btn"},"ğŸ”„ åˆ·æ–°æˆ¿é—´")]),r(I).length===0?(c(),a("div",de,l[2]||(l[2]=[t("p",null,"ğŸ“­ æš‚æ— æˆ¿é—´æ•°æ®",-1),t("p",{class:"hint"},"å¯èƒ½éœ€è¦ç­‰å¾…åŒæ­¥å®Œæˆï¼Œæˆ–è€…ç‚¹å‡»åˆ·æ–°æŒ‰é’®",-1)]))):(c(),a("div",ge,[(c(!0),a(H,null,W(r(I),i=>(c(),a("div",{key:i.roomId,class:j(["room-item",{active:i.roomId===r(w)}]),onClick:O=>A(i.roomId)},[t("div",ve,[t("h4",null,g(i.name),1),i.topic?(c(),a("p",ye,g(i.topic),1)):b("",!0),t("div",he,[t("span",pe,"ğŸ‘¥ "+g(i.memberCount),1),i.unreadCount>0?(c(),a("span",_e," ğŸ”” "+g(i.unreadCount),1)):b("",!0)]),i.lastMessage?(c(),a("div",fe,[t("small",null,g(i.lastMessage.body),1)])):b("",!0)])],10,me))),128))]))])):b("",!0),r(M)?(c(),a("div",we,[t("h3",null,"å½“å‰æˆ¿é—´: "+g(r(M).name),1),t("div",Ce,[q(t("input",{"onUpdate:modelValue":l[0]||(l[0]=i=>u.value=i),onKeyup:Y(T,["enter"]),placeholder:"è¾“å…¥æ¶ˆæ¯...",class:"message-field"},null,544),[[G,u.value]]),t("button",{onClick:T,disabled:!u.value.trim(),class:"send-btn"}," ğŸ“¤ å‘é€ ",8,Ie)])])):b("",!0),t("div",Se,[l[7]||(l[7]=t("h3",null,"è°ƒè¯•ä¿¡æ¯",-1)),t("div",xe,[t("p",null,[l[3]||(l[3]=t("strong",null,"å®¢æˆ·ç«¯çŠ¶æ€:",-1)),E(" "+g(r(y)?"å·²è¿æ¥":"æœªè¿æ¥"),1)]),t("p",null,[l[4]||(l[4]=t("strong",null,"æˆ¿é—´æ•°é‡:",-1)),E(" "+g(r(I).length),1)]),t("p",null,[l[5]||(l[5]=t("strong",null,"å½“å‰æˆ¿é—´:",-1)),E(" "+g(r(w)||"æ— "),1)]),t("p",null,[l[6]||(l[6]=t("strong",null,"åˆå§‹åŒ–ä¸­:",-1)),E(" "+g(r(h)?"æ˜¯":"å¦"),1)])])])]))}}),Me=Q(be,[["__scopeId","data-v-4d106c27"]]);export{Me as default};
