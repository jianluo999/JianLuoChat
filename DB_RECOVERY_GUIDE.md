# JianluoChat 数据库恢复指南

## 概述

本指南详细介绍了 JianluoChat 系统的数据库恢复功能，包括数据库备份、健康检查、坏块检测和数据恢复等核心功能。

## 功能特性

### 1. 数据库备份功能
- **自动备份**: 系统支持创建完整的数据库备份
- **备份格式**: JSON 格式，包含用户、房间、消息等所有数据
- **备份存储**: 备份文件存储在配置的上传目录中
- **备份元数据**: 自动记录备份创建时间和状态

### 2. 坏块检测和修复
- **坏块扫描**: 自动检测数据库文件中的坏块
- **智能修复**: 跳过坏块并记录日志
- **块大小**: 8KB 块大小进行扫描
- **修复策略**: 优先保证数据完整性

### 3. 健康检查
- **连接状态**: 检查数据库连接是否正常
- **表完整性**: 验证必要表是否存在
- **数据一致性**: 检查外键约束和数据完整性
- **坏块统计**: 统计和报告坏块数量

### 4. 数据恢复
- **完整恢复**: 从备份文件恢复整个数据库
- **增量恢复**: 支持选择特定备份文件
- **安全警告**: 恢复前的多重确认机制
- **状态监控**: 实时监控恢复过程

## API 接口

### 基础路径
```
/api/database/*
```

### 可用接口

#### 1. 创建数据库备份
```
POST /api/database/backup
```
**响应**:
```json
{
  "success": true,
  "message": "Database backup created successfully",
  "backupFileName": "jianluochat_backup_20250825_143022.backup",
  "timestamp": 1693000222000
}
```

#### 2. 从备份恢复数据库
```
POST /api/database/restore
{
  "backupFileName": "jianluochat_backup_20250825_143022.backup"
}
```

#### 3. 检查数据库健康状态
```
GET /api/database/health
```
**响应**:
```json
{
  "success": true,
  "healthStatus": {
    "timestamp": "2025-08-25T14:30:22",
    "status": "healthy",
    "issues": [],
    "badBlocks": []
  },
  "timestamp": 1693000222000
}
```

#### 4. 检测和修复坏块
```
POST /api/database/repair-bad-blocks
```

#### 5. 获取备份文件列表
```
GET /api/database/backups
```

#### 6. 删除备份文件
```
DELETE /api/database/backups/{backupFileName}
```

#### 7. 获取数据库状态概览
```
GET /api/database/status
```

#### 8. 执行完整恢复流程
```
POST /api/database/full-recovery
{
  "backupFileName": "jianluochat_backup_20250825_143022.backup"
}
```

## 配置说明

### 后端配置

在 `application.yml` 中配置数据库恢复相关参数：

```yaml
# 文件上传路径（备份文件存储位置）
file:
  upload:
    path: ./uploads/

# 数据库配置
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/jianluochat
    username: jianluochat
    password: jianluochat123
    driver-class-name: org.postgresql.Driver
```

### 坏块检测配置

在 `DatabaseRecoveryService` 中配置：

```java
// 块大小配置
private static final int BLOCK_SIZE = 8192; // 8KB 块大小
private static final int MAX_BAD_BLOCKS = 100; // 最大坏块数量
```

## 使用场景

### 1. 日常维护
- 定期执行健康检查
- 定期创建数据库备份
- 监控坏块数量和状态

### 2. 数据库损坏恢复
- 检测到数据库异常时
- 执行坏块检测和修复
- 从最近备份恢复数据

### 3. 灾难恢复
- 系统崩溃后的数据恢复
- 硬盘损坏后的数据重建
- 数据库迁移前的备份

## 操作流程

### 1. 健康检查流程
1. 点击"健康检查"标签页
2. 点击"检查健康状态"按钮
3. 查看健康状态报告
4. 如有问题，执行相应修复操作

### 2. 备份管理流程
1. 点击"备份管理"标签页
2. 点击"创建备份"按钮
3. 等待备份完成
4. 在列表中查看备份文件
5. 如需删除，点击删除按钮

### 3. 坏块修复流程
1. 点击"坏块修复"标签页
2. 点击"检测并修复坏块"按钮
3. 查看修复结果
4. 如有坏块，记录相关信息

### 4. 数据恢复流程
1. 点击"数据恢复"标签页
2. 选择要恢复的备份文件
3. 阅读警告信息
4. 点击"执行完整恢复"按钮
5. 等待恢复完成

## 注意事项

### 1. 备份策略
- 建议每天创建一次完整备份
- 重要操作前建议手动创建备份
- 备份文件保留时间根据存储空间决定

### 2. 恢复操作
- 恢复操作会清空当前数据库
- 恢复前请确保已备份当前数据
- 恢复过程中系统将暂时不可用

### 3. 坏块处理
- 坏块检测可能影响系统性能
- 建议在低峰期执行坏块扫描
- 发现坏块时应及时处理

### 4. 权限控制
- 数据库恢复功能需要管理员权限
- 前端界面需要权限验证
- API 接口需要身份验证

## 故障排除

### 常见问题

#### 1. 备份创建失败
**可能原因**:
- 存储空间不足
- 文件权限问题
- 数据库连接异常

**解决方法**:
- 检查存储空间
- 验证文件写入权限
- 检查数据库连接状态

#### 2. 恢复操作失败
**可能原因**:
- 备份文件损坏
- 数据库版本不兼容
- 存储空间不足

**解决方法**:
- 验证备份文件完整性
- 检查数据库版本
- 确保有足够的存储空间

#### 3. 健康检查异常
**可能原因**:
- 数据库连接失败
- 表结构异常
- 外键约束问题

**解决方法**:
- 检查数据库连接配置
- 验证表结构完整性
- 检查外键约束

### 日志查看

系统会记录详细的数据库恢复操作日志，日志位置在 `logs/jianluochat.log`。

## 最佳实践

### 1. 定期维护
- 每周执行一次健康检查
- 每天创建一次数据库备份
- 每月执行一次坏块扫描

### 2. 监控告警
- 设置数据库健康状态监控
- 配置备份失败告警
- 监控存储空间使用情况

### 3. 数据安全
- 定期测试备份恢复流程
- 多地点备份重要数据
- 定期更新恢复策略

## 技术实现

### 后端实现
- 使用 Spring Boot 提供 REST API
- 使用 CompletableFuture 实现异步操作
- 使用 Jackson 进行数据序列化
- 使用 JDBC 进行数据库操作

### 前端实现
- 使用 Vue.js 构建用户界面
- 使用 Axios 进行 API 调用
- 使用组件化设计
- 使用状态管理

### 数据库支持
- PostgreSQL 数据库
- JSON 格式备份
- 块级坏块检测
- 事务性操作

## 版本历史

### v1.0.0 (2025-08-25)
- 初始版本发布
- 基础备份和恢复功能
- 健康检查和坏块检测
- 完整的前端界面

## 联系支持

如需技术支持，请联系：
- 邮箱: support@jianluochat.com
- 电话: +86-123-456-7890
- 文档更新时间: 2025-08-25